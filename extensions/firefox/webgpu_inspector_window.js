!function(e){const t={CaptureBufferData:'webgpu_inspect_capture_buffer_data',CaptureBuffers:'webgpu_inspect_capture_buffers',DeleteObjects:'webgpu_inspect_delete_objects',ValidationError:'webgpu_inspect_validation_error',MemoryLeakWarning:'webgpu_inspect_memory_leak_warning',DeltaTime:'webgpu_inspect_delta_time',CaptureFrameResults:'webgpu_inspect_capture_frame_results',CaptureFrameCommands:'webgpu_inspect_capture_frame_commands',ObjectSetLabel:'webgpu_inspect_object_set_label',AddObject:'webgpu_inspect_add_object',ResolveAsyncObject:'webgpu_inspect_resolve_async_object',DeleteObject:'webgpu_inspect_delete_object',CaptureTextureFrames:'webgpu_inspect_capture_texture_frames',CaptureTextureData:'webgpu_inspect_capture_texture_data',CaptureBufferData:'webgpu_inspect_capture_buffer_data',WriteBuffer:'wrebgpu_inspect_write_buffer',Recording:'webgpu_record_recording',RecordingCommand:'webgpu_record_command',RecordingDataCount:'webgpu_record_data_count',RecordingData:'webgpu_record_data'};t.values=new Set(Object.values(t));const n='webgpu_inspect_request_texture',s='webgpu_inspect_compile_shader',i='webgpu_inspect_revert_shader',r='webgpu_inspector_capture',o='webgpu_initialize_inspector',a='webgpu_initialize_recorder';class l{constructor(e){this._lastSlotId=0,this.slots=new Map,e&&(this.name=e)}static get enabled(){return 0==l._disableSignals}static get disabled(){return l._disableSignals>0}static disable(){return l._disableSignals++}static enable(e){return e?(l._disableSignals=0,0):l._disableSignals>0?l._disableSignals--:0}static disconnect(e,t,n){for(const s in e){const i=e[s];i.constructor===l&&i.disconnect(t,n)}}static getSignals(e,t){t=t||[];for(const n in e){const s=e[n];s.constructor===l&&t.push(s)}return t}get hasListeners(){return this.slots.size>0}emit(){if(!l.disabled)for(const e of this.slots){const t=e[1][0],n=e[1][1]||t;if(t)if(t.constructor===l)t.emit.apply(n,arguments);else{let e=t.apply(n,arguments);if(e)return e}}}addListener(e,t){return this.isListening(e,t)?null:(this.slots.set(this._lastSlotId++,[e,t]),this._lastSlotId-1)}isListening(e,t){for(const n of this.slots){const s=n[1];if(e&&!t){if(s[0]===e||s[1]===e)return!0}else if(!e&&t){if(s[1]===t)return!0}else if(s[0]===e&&s[1]===t)return!0}return!1}disconnect(e,t){if(null==e&&null==t)return this.slots.clear(),!0;if(e.constructor===Number){const t=e;return!!this.slots.has(t)&&(this.slots.delete(t),!0)}let n=!1;for(const s of this.slots){const i=s[0],r=s[1];e&&!t?r[0]!==e&&r[1]!==e||(this.slots.delete(i),n=!0):!e&&t?r[1]===t&&(this.slots.delete(i),n=!0):r[0]===e&&r[1]===t&&(this.slots.delete(i),n=!0)}return n}}l._disableSignals=0;class c{constructor(){this._cache=[]}_getStacktrace(e){return e<0?'':this._cache[e]??''}_setStacktrace(e){if(!e)return-1;const t=this._cache.indexOf(e);return-1!==t?t:(this._cache.push(e),this._cache.length-1)}static getStacktrace(e){return c._global._getStacktrace(e)}static setStacktrace(e){return c._global._setStacktrace(e)}}c._global=new c;class h{constructor(e,t,n){this.id=e,this.label=t?.label??'',this._stacktrace=c.setStacktrace(n??''),this._deletionTime=0,this._referenceCount=1,this.dependencies=[]}get name(){return this.label||this.constructor.className}get stacktrace(){return c.getStacktrace(this._stacktrace)}get isDeleted(){return this._deletionTime>0}get idName(){return this.id<0?'CANVAS':this.id}get referenceCount(){return this._referenceCount}addDependency(e){e&&this.dependencies.push(e)}incrementDepenencyReferenceCount(){for(const e of this.dependencies)e._referenceCount++,e.incrementDepenencyReferenceCount()}incrementReferenceCount(){this._referenceCount++}decrementReferenceCount(e){this._referenceCount--,this._referenceCount<=0&&e&&e(this);for(const t of this.dependencies)t.decrementReferenceCount(e)}}class u extends h{constructor(e,t,n){super(e,t,n),this.descriptor=t}}u.className='Adapter';class d extends h{constructor(e,t,n){super(e,t,n),this.descriptor=t}}d.className='BindGroupLayout';class f extends h{constructor(e,t,n){super(e,t,n),this.descriptor=t}get entries(){return this.descriptor?.entries}}f.className='BindGroup';class p extends h{constructor(e,t,n){super(e,t,n),this.descriptor=t}}p.className='Buffer';class m extends h{constructor(e,t,n){super(e,t,n),this.descriptor=t}}m.className='ComputePipeline';class g extends h{constructor(e,t,n){super(e,t,n),this.descriptor=t}}g.className='Device';class v extends h{constructor(e,t,n){super(e,t,n),this.descriptor=t}}v.className='PipelineLayout';class x extends h{constructor(e,t,n){super(e,t,n),this.descriptor=t}get topology(){return this.descriptor?.primitive?.topology??'triangle-list'}}x.className='RenderPipeline';class b extends h{constructor(e,t,n){super(e,t,n),this.descriptor=t}}b.className='Sampler';class y{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class _{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class w extends y{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class k extends y{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}}class O extends y{constructor(e,t,n,s){super(e,n),this.format=t,this.access=s}get isTemplate(){return!0}}var S,T,I,C,$;(e=>{e[e.Uniform=0]='Uniform',e[e.Storage=1]='Storage',e[e.Texture=2]='Texture',e[e.Sampler=3]='Sampler',e[e.StorageTexture=4]='StorageTexture'})(S||(S={}));class A{constructor(e,t,n,s,i,r,o){this.name=e,this.type=t,this.group=n,this.binding=s,this.attributes=i,this.resourceType=r,this.access=o}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class E{constructor(e,t){this.name=e,this.type=t}}class P{constructor(e,t,n,s){this.name=e,this.type=t,this.locationType=n,this.location=s,this.interpolation=null}}class D{constructor(e,t,n,s){this.name=e,this.type=t,this.locationType=n,this.location=s}}class M{constructor(e,t,n,s){this.name=e,this.type=t,this.attributes=n,this.id=s}}class L{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n}}class B{constructor(e,t=null,n){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=n}}class N{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class R{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class F{constructor(){this.id=F._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return''}constEvaluate(e,t){throw new Error('Cannot evaluate node')}constEvaluateString(e){return this.constEvaluate(e).toString()}search(e){}searchBlock(e,t){if(e){t(V.instance);for(const n of e)n instanceof Array?this.searchBlock(n,t):n.search(t);t(z.instance)}}}F._id=0;class V extends F{}V.instance=new V;class z extends F{}z.instance=new z;class U extends F{constructor(){super()}}class W extends U{constructor(e,t,n,s,i,r){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=n,this.body=s,this.startLine=i,this.endLine=r}get astNodeType(){return'function'}search(e){this.searchBlock(this.body,e)}}class Q extends U{constructor(e){super(),this.expression=e}get astNodeType(){return'staticAssert'}search(e){this.expression.search(e)}}class j extends U{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return'while'}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class X extends U{constructor(e){super(),this.body=e}get astNodeType(){return'continuing'}search(e){this.searchBlock(this.body,e)}}class G extends U{constructor(e,t,n,s){super(),this.init=e,this.condition=t,this.increment=n,this.body=s}get astNodeType(){return'for'}search(e){var t,n,s;null===(t=this.init)||void 0===t||t.search(e),null===(n=this.condition)||void 0===n||n.search(e),null===(s=this.increment)||void 0===s||s.search(e),this.searchBlock(this.body,e)}}class q extends U{constructor(e,t,n,s,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=s,this.value=i}get astNodeType(){return'var'}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}class H extends U{constructor(e,t,n){super(),this.attributes=null,this.name=e,this.type=t,this.value=n}get astNodeType(){return'override'}search(e){var t;null===(t=this.value)||void 0===t||t.search(e)}}class Y extends U{constructor(e,t,n,s,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=s,this.value=i}get astNodeType(){return'let'}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}class K extends U{constructor(e,t,n,s,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=s,this.value=i}get astNodeType(){return'const'}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}(e=>{e.increment='++',e.decrement='--'})(T||(T={})),(e=>{e.parse=function(t){const n=t;if('parse'==n)throw new Error('Invalid value for IncrementOperator');return e[n]}})(T||(T={}));class Z extends U{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return'increment'}search(e){this.variable.search(e)}}(e=>{e.assign='=',e.addAssign='+=',e.subtractAssin='-=',e.multiplyAssign='*=',e.divideAssign='/=',e.moduloAssign='%=',e.andAssign='&=',e.orAssign='|=',e.xorAssign='^=',e.shiftLeftAssign='<<=',e.shiftRightAssign='>>='})(I||(I={})),(e=>{e.parse=function(e){const t=e;if('parse'==t)throw new Error('Invalid value for AssignOperator');return t}})(I||(I={}));class J extends U{constructor(e,t,n){super(),this.operator=e,this.variable=t,this.value=n}get astNodeType(){return'assign'}search(e){this.variable.search(e),this.value.search(e)}}class ee extends U{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return'call'}search(e){for(const t of this.args)t.search(e);e(this)}}class te extends U{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return'loop'}}class ne extends U{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return'body'}}class se extends U{constructor(e,t,n,s){super(),this.condition=e,this.body=t,this.elseif=n,this.else=s}get astNodeType(){return'if'}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class ie extends U{constructor(e){super(),this.value=e}get astNodeType(){return'return'}search(e){var t;null===(t=this.value)||void 0===t||t.search(e)}}class re extends U{constructor(e){super(),this.name=e}get astNodeType(){return'enable'}}class oe extends U{constructor(e){super(),this.extensions=e}get astNodeType(){return'requires'}}class ae extends U{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return'diagnostic'}}class le extends U{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return'alias'}}class ce extends U{constructor(){super()}get astNodeType(){return'discard'}}class he extends U{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return'break'}}class ue extends U{constructor(){super(),this.loopId=-1}get astNodeType(){return'continue'}}class de extends U{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return'type'}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(e){let t=e[0];if('f32'===t.name)return t;for(let n=1;n<e.length;++n){const s=de._priority.get(t.name);de._priority.get(e[n].name)<s&&(t=e[n])}return'x32'===t.name?de.i32:t}}de.x32=new de('x32'),de.f32=new de('f32'),de.i32=new de('i32'),de.u32=new de('u32'),de.f16=new de('f16'),de.bool=new de('bool'),de._priority=new Map([['f32',0],['f16',1],['u32',2],['i32',3],['x32',3]]);class fe extends de{constructor(e,t,n,s){super(e),this.members=t,this.startLine=n,this.endLine=s}get astNodeType(){return'struct'}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}}class pe extends de{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return'template'}}pe.vec2f=new pe('vec2',de.f32,null),pe.vec3f=new pe('vec3',de.f32,null),pe.vec4f=new pe('vec4',de.f32,null),pe.vec2i=new pe('vec2',de.i32,null),pe.vec3i=new pe('vec3',de.i32,null),pe.vec4i=new pe('vec4',de.i32,null),pe.vec2u=new pe('vec2',de.u32,null),pe.vec3u=new pe('vec3',de.u32,null),pe.vec4u=new pe('vec4',de.u32,null),pe.vec2h=new pe('vec2',de.f16,null),pe.vec3h=new pe('vec3',de.f16,null),pe.vec4h=new pe('vec4',de.f16,null),pe.vec2b=new pe('vec2',de.bool,null),pe.vec3b=new pe('vec3',de.bool,null),pe.vec4b=new pe('vec4',de.bool,null),pe.mat2x2f=new pe('mat2x2',de.f32,null),pe.mat2x3f=new pe('mat2x3',de.f32,null),pe.mat2x4f=new pe('mat2x4',de.f32,null),pe.mat3x2f=new pe('mat3x2',de.f32,null),pe.mat3x3f=new pe('mat3x3',de.f32,null),pe.mat3x4f=new pe('mat3x4',de.f32,null),pe.mat4x2f=new pe('mat4x2',de.f32,null),pe.mat4x3f=new pe('mat4x3',de.f32,null),pe.mat4x4f=new pe('mat4x4',de.f32,null),pe.mat2x2h=new pe('mat2x2',de.f16,null),pe.mat2x3h=new pe('mat2x3',de.f16,null),pe.mat2x4h=new pe('mat2x4',de.f16,null),pe.mat3x2h=new pe('mat3x2',de.f16,null),pe.mat3x3h=new pe('mat3x3',de.f16,null),pe.mat3x4h=new pe('mat3x4',de.f16,null),pe.mat4x2h=new pe('mat4x2',de.f16,null),pe.mat4x3h=new pe('mat4x3',de.f16,null),pe.mat4x4h=new pe('mat4x4',de.f16,null);class me extends de{constructor(e,t,n,s){super(e),this.storage=t,this.type=n,this.access=s}get astNodeType(){return'pointer'}}class ge extends de{constructor(e,t,n,s){super(e),this.attributes=t,this.format=n,this.count=s}get astNodeType(){return'array'}get isArray(){return!0}}class ve extends de{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return'sampler'}}class xe extends F{constructor(){super(),this.postfix=null}}class be extends xe{constructor(e){super(),this.value=e}get astNodeType(){return'stringExpr'}toString(){return this.value}constEvaluateString(){return this.value}}class ye extends xe{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return'createExpr'}search(e){if(e(this),this.args)for(const t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}}class _e extends xe{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return'callExpr'}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return _e.builtinFunctionNames.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(const t of this.args)t.search(e);e(this)}}_e.builtinFunctionNames=new Set(['all','all','any','select','arrayLength','abs','acos','acosh','asin','asinh','atan','atanh','atan2','ceil','clamp','cos','cosh','countLeadingZeros','countOneBits','countTrailingZeros','cross','degrees','determinant','distance','dot','dot4U8Packed','dot4I8Packed','exp','exp2','extractBits','faceForward','firstLeadingBit','firstTrailingBit','floor','fma','fract','frexp','insertBits','inverseSqrt','ldexp','length','log','log2','max','min','mix','modf','normalize','pow','quantizeToF16','radians','reflect','refract','reverseBits','round','saturate','sign','sin','sinh','smoothStep','sqrt','step','tan','tanh','transpose','trunc','dpdx','dpdxCoarse','dpdxFine','dpdy','dpdyCoarse','dpdyFine','fwidth','fwidthCoarse','fwidthFine','textureDimensions','textureGather','textureGatherCompare','textureLoad','textureNumLayers','textureNumLevels','textureNumSamples','textureSample','textureSampleBias','textureSampleCompare','textureSampleCompareLevel','textureSampleGrad','textureSampleLevel','textureSampleBaseClampToEdge','textureStore','atomicLoad','atomicStore','atomicAdd','atomicSub','atomicMax','atomicMin','atomicAnd','atomicOr','atomicXor','atomicExchange','atomicCompareExchangeWeak','pack4x8snorm','pack4x8unorm','pack4xI8','pack4xU8','pack4x8Clamp','pack4xU8Clamp','pack2x16snorm','pack2x16unorm','pack2x16float','unpack4x8snorm','unpack4x8unorm','unpack4xI8','unpack4xU8','unpack2x16snorm','unpack2x16unorm','unpack2x16float','storageBarrier','textureBarrier','workgroupBarrier','workgroupUniformLoad','subgroupAdd','subgroupExclusiveAdd','subgroupInclusiveAdd','subgroupAll','subgroupAnd','subgroupAny','subgroupBallot','subgroupBroadcast','subgroupBroadcastFirst','subgroupElect','subgroupMax','subgroupMin','subgroupMul','subgroupExclusiveMul','subgroupInclusiveMul','subgroupOr','subgroupShuffle','subgroupShuffleDown','subgroupShuffleUp','subgroupShuffleXor','subgroupXor','quadBroadcast','quadSwapDiagonal','quadSwapX','quadSwapY']);class we extends xe{constructor(e){super(),this.name=e}get astNodeType(){return'varExpr'}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}}class ke extends xe{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return'constExpr'}constEvaluate(e,t){if(this.initializer){const t=e.evalExpression(this.initializer,e.context);return null!==t&&this.postfix?t.getDataValue(e,this.postfix,e.context):t}return null}search(e){this.initializer.search(e)}}class Oe extends xe{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return'literalExpr'}constEvaluate(e,t){return void 0!==t&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof Ve}get isVector(){return this.value instanceof Ue||this.value instanceof We}get scalarValue(){return this.value instanceof Ve?this.value.value:(console.error('Value is not scalar.'),0)}get vectorValue(){return this.value instanceof Ue||this.value instanceof We?this.value.value:(console.error('Value is not a vector or matrix.'),[])}}class Se extends xe{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return'bitcastExpr'}search(e){this.value.search(e)}}class Te extends xe{constructor(e){super(),this.contents=e}get astNodeType(){return'groupExpr'}constEvaluate(e,t){return this.contents[0].constEvaluate(e,t)}search(e){this.searchBlock(this.contents,e)}}class Ie extends xe{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class Ce extends xe{constructor(){super()}}class $e extends Ce{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return'unaryOp'}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}}class Ae extends Ce{constructor(e,t,n){super(),this.operator=e,this.left=t,this.right=n}get astNodeType(){return'binaryOp'}_getPromotedType(e,t){return e.name===t.name?e:'f32'===e.name||'f32'===t.name?de.f32:'u32'===e.name||'u32'===t.name?de.u32:de.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}}class Ee extends F{constructor(){super()}}class Pe extends Ee{constructor(e,t){super(),this.selector=e,this.body=t}get astNodeType(){return'case'}search(e){this.searchBlock(this.body,e)}}class De extends Ee{constructor(e){super(),this.body=e}get astNodeType(){return'default'}search(e){this.searchBlock(this.body,e)}}class Me extends F{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return'argument'}}class Le extends F{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return'elseif'}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Be extends F{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return'member'}}class Ne extends F{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return'attribute'}}class Re{constructor(e){this.typeInfo=e}setDataValue(e,t,n,s){console.error('SetDataValue: Not implemented',t,n)}getDataValue(e,t,n){return console.error('GetDataValue: Not implemented',t),null}toString(){return`<${this.typeInfo.name}>`}}class Fe extends Re{constructor(){super(new y('void',null))}toString(){return'void'}}Fe.void=new Fe;class Ve extends Re{constructor(e,t){super(t),'i32'===this.typeInfo.name||'u32'===this.typeInfo.name?e=Math.floor(e):'bool'===this.typeInfo.name&&(e=e?1:0),this.value=e}setDataValue(e,t,n,s){n?console.error('SetDataValue: Scalar data does not support postfix',n):t instanceof Ve?(t.value,'i32'===this.typeInfo.name||'u32'===this.typeInfo.name||this.typeInfo.name,this.value=t.value):console.error('SetDataValue: Invalid value',t)}getDataValue(e,t,n){return t?(console.error('GetDataValue: Scalar data does not support postfix',t),null):this}toString(){return`${this.value}`}}function ze(e,t,n){const s=t.length;return 2===s?'f32'===n?new Ue(t,e.getTypeInfo('vec2f')):'i32'===n?new Ue(t,e.getTypeInfo('vec2i')):'u32'===n?new Ue(t,e.getTypeInfo('vec2u')):'f16'===n?new Ue(t,e.getTypeInfo('vec2h')):(console.error(`GetDataValue: Unknown format ${n}`),null):3===s?'f32'===n?new Ue(t,e.getTypeInfo('vec3f')):'i32'===n?new Ue(t,e.getTypeInfo('vec3i')):'u32'===n?new Ue(t,e.getTypeInfo('vec3u')):'f16'===n?new Ue(t,e.getTypeInfo('vec3h')):(console.error(`GetDataValue: Unknown format ${n}`),null):4===s?'f32'===n?new Ue(t,e.getTypeInfo('vec4f')):'i32'===n?new Ue(t,e.getTypeInfo('vec4i')):'u32'===n?new Ue(t,e.getTypeInfo('vec4u')):'f16'===n?new Ue(t,e.getTypeInfo('vec4h')):(console.error(`GetDataValue: Unknown format ${n}`),null):(console.error(`GetDataValue: Invalid vector size ${t.length}`),null)}class Ue extends Re{constructor(e,t){super(t),Array.isArray(e)?this.value=e:this.value=Array.from(e)}setDataValue(e,t,n,s){n instanceof be?console.error('TODO: Set vector postfix'):t instanceof Ue?this.value=t.value:console.error('SetDataValue: Invalid value',t)}getDataValue(e,t,n){let s=e.getTypeInfo('f32');if(this.typeInfo instanceof O)s=this.typeInfo.format;else{const t=this.typeInfo.name;'vec2f'===t||'vec3f'===t||'vec4f'===t?s=e.getTypeInfo('f32'):'vec2i'===t||'vec3i'===t||'vec4i'===t?s=e.getTypeInfo('i32'):'vec2u'===t||'vec3u'===t||'vec4u'===t?s=e.getTypeInfo('u32'):'vec2h'===t||'vec3h'===t||'vec4h'===t?s=e.getTypeInfo('f16'):console.error(`GetDataValue: Unknown type ${t}`)}if(t instanceof Ie){const i=t.index;let r=-1;if(i instanceof Oe){if(!(i.value instanceof Ve))return console.error(`GetValueData: Invalid array index ${i.value}`),null;r=i.value.value}else{const t=e.evalExpression(i,n);if(!(t instanceof Ve))return console.error('GetDataValue: Unknown index type',i),null;r=t.value}return r<0||r>=this.value.length?(console.error('GetDataValue: Index out of range',r),null):new Ve(this.value[r],s)}if(t instanceof be){const n=t.value,i=[];for(const e of n)'x'===e||'r'===e?i.push(this.value[0]):'y'===e||'g'===e?i.push(this.value[1]):'z'===e||'b'===e?i.push(this.value[2]):'w'===e||'a'===e?i.push(this.value[3]):console.error(`GetDataValue: Unknown member ${e}`);return 1===i.length?new Ve(i[0],s):ze(e,i,s.name)}return this}toString(){let e=`${this.value[0]}`;for(let t=1;t<this.value.length;++t)e+=`, ${this.value[t]}`;return e}}class We extends Re{constructor(e,t){super(t),this.value=e}setDataValue(e,t,n,s){n instanceof be?console.error('TODO: Set matrix postfix'):t instanceof We?this.value=t.value:console.error('SetDataValue: Invalid value',t)}getDataValue(e,t,n){const s=this.typeInfo.name;let i=e.getTypeInfo('f32');if(this.typeInfo instanceof O)i=this.typeInfo.format;else if(s.endsWith('f'))i=e.getTypeInfo('f32');else if(s.endsWith('i'))i=e.getTypeInfo('i32');else if(s.endsWith('u'))i=e.getTypeInfo('u32');else{if(!s.endsWith('h'))return console.error(`GetDataValue: Unknown type ${s}`),null;i=e.getTypeInfo('f16')}if(t instanceof Ie){const r=t.index;let o,a=-1;if(r instanceof Oe){if(!(r.value instanceof Ve))return console.error(`GetDataValue: Invalid array index ${r.value}`),null;a=r.value.value}else{const t=e.evalExpression(r,n);if(!(t instanceof Ve))return console.error('GetDataValue: Unknown index type',r),null;a=t.value}if(a<0||a>=this.value.length)return console.error('GetDataValue: Index out of range',a),null;if('mat2x2'===s||'mat2x2f'===s||'mat2x2h'===s)o=this.value.slice(2*a,2*a+2);else if('mat2x3'===s||'mat2x3f'===s||'mat2x3h'===s)o=this.value.slice(3*a,3*a+3);else if('mat2x4'===s||'mat2x4f'===s||'mat2x4h'===s)o=this.value.slice(4*a,4*a+4);else if('mat3x2'===s||'mat3x2f'===s||'mat3x2h'===s)o=this.value.slice(2*a,2*a+2);else if('mat3x3'===s||'mat3x3f'===s||'mat3x3h'===s)o=this.value.slice(3*a,3*a+3);else if('mat3x4'===s||'mat3x4f'===s||'mat3x4h'===s)o=this.value.slice(4*a,4*a+4);else if('mat4x2'===s||'mat4x2f'===s||'mat4x2h'===s)o=this.value.slice(2*a,2*a+2);else if('mat4x3'===s||'mat4x3f'===s||'mat4x3h'===s)o=this.value.slice(3*a,3*a+3);else{if('mat4x4'!==s&&'mat4x4f'!==s&&'mat4x4h'!==s)return console.error(`GetDataValue: Unknown type ${s}`),null;o=this.value.slice(4*a,4*a+4)}const l=ze(e,o,i.name);if(t.postfix)return l.getDataValue(e,t.postfix,n)}return this}toString(){let e=`${this.value[0]}`;for(let t=1;t<this.value.length;++t)e+=`, ${this.value[t]}`;return e}}class Qe extends Re{constructor(e,t,n=0,s){super(t),this.textureSize=[0,0,0],this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=n,void 0!==s&&(this.textureSize=s)}setDataValue(e,t,n,s){if(null===t)return void console.log('setDataValue: NULL data.');let i=this.offset,r=this.typeInfo;for(;n;){if(n instanceof Ie)if(r instanceof k){const t=n.index;if(t instanceof Oe){if(!(t.value instanceof Ve))return void console.error(`SetDataValue: Invalid index type ${t.value}`);i+=t.value.value*r.stride}else{const n=e.evalExpression(t,s);if(!(n instanceof Ve))return void console.error('SetDataValue: Unknown index type',t);i+=n.value*r.stride}r=r.format}else console.error(`SetDataValue: Type ${e.getTypeName(r)} is not an array`);else{if(!(n instanceof be))return void console.error('SetDataValue: Unknown postfix type',n);{const s=n.value;if(r instanceof w){let e=!1;for(const t of r.members)if(t.name===s){i+=t.offset,r=t.type,e=!0;break}if(!e)return void console.error(`SetDataValue: Member ${s} not found`)}else if(r instanceof y){const n=e.getTypeName(r);let o=0;if('x'===s||'r'===s)o=0;else if('y'===s||'g'===s)o=1;else if('z'===s||'b'===s)o=2;else{if('w'!==s&&'a'!==s)return void console.error(`SetDataValue: Unknown member ${s}`);o=3}if(!(t instanceof Ve))return void console.error('SetDataValue: Invalid value',t);const a=t.value;return'vec2f'===n?void(new Float32Array(this.buffer,i,2)[o]=a):'vec3f'===n?void(new Float32Array(this.buffer,i,3)[o]=a):'vec4f'===n?void(new Float32Array(this.buffer,i,4)[o]=a):'vec2i'===n?void(new Int32Array(this.buffer,i,2)[o]=a):'vec3i'===n?void(new Int32Array(this.buffer,i,3)[o]=a):'vec4i'===n?void(new Int32Array(this.buffer,i,4)[o]=a):'vec2u'===n?void(new Uint32Array(this.buffer,i,2)[o]=a):'vec3u'===n?void(new Uint32Array(this.buffer,i,3)[o]=a):'vec4u'===n?void(new Uint32Array(this.buffer,i,4)[o]=a):void console.error(`SetDataValue: Type ${n} is not a struct`)}}}n=n.postfix}this.setData(e,t,r,i,s)}setData(e,t,n,s,i){const r=e.getTypeName(n);if('f32'!==r&&'f16'!==r)if('i32'!==r&&'atomic<i32>'!==r&&'x32'!==r)if('u32'!==r&&'atomic<u32>'!==r)if('bool'!==r)if('vec2f'!==r&&'vec2h'!==r)if('vec3f'!==r&&'vec3h'!==r)if('vec4f'!==r&&'vec4h'!==r)if('vec2i'!==r)if('vec3i'!==r)if('vec4i'!==r)if('vec2u'!==r)if('vec3u'!==r)if('vec4u'!==r)if('vec2b'!==r)if('vec3b'!==r)if('vec4b'!==r)if('mat2x2f'!==r&&'mat2x2h'!==r)if('mat2x3f'!==r&&'mat2x3h'!==r)if('mat2x4f'!==r&&'mat2x4h'!==r)if('mat3x2f'!==r&&'mat3x2h'!==r)if('mat3x3f'!==r&&'mat3x3h'!==r)if('mat3x4f'!==r&&'mat3x4h'!==r)if('mat4x2f'!==r&&'mat4x2h'!==r)if('mat4x3f'!==r&&'mat4x3h'!==r)if('mat4x4f'!==r&&'mat4x4h'!==r)if(t instanceof Qe){if(n===t.typeInfo){return void new Uint8Array(this.buffer,s,t.buffer.byteLength).set(new Uint8Array(t.buffer))}console.error('SetDataValue: Type mismatch',r,e.getTypeName(t.typeInfo))}else console.error(`SetData: Unknown type ${r}`);else{const e=new Float32Array(this.buffer,s,16);t instanceof We?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5],e[6]=t.value[6],e[7]=t.value[7],e[8]=t.value[8],e[9]=t.value[9],e[10]=t.value[10],e[11]=t.value[11],e[12]=t.value[12],e[13]=t.value[13],e[14]=t.value[14],e[15]=t.value[15]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15])}else{const e=new Float32Array(this.buffer,s,12);t instanceof We?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5],e[6]=t.value[6],e[7]=t.value[7],e[8]=t.value[8],e[9]=t.value[9],e[10]=t.value[10],e[11]=t.value[11]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11])}else{const e=new Float32Array(this.buffer,s,8);t instanceof We?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5],e[6]=t.value[6],e[7]=t.value[7]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7])}else{const e=new Float32Array(this.buffer,s,12);t instanceof We?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5],e[6]=t.value[6],e[7]=t.value[7],e[8]=t.value[8],e[9]=t.value[9],e[10]=t.value[10],e[11]=t.value[11]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11])}else{const e=new Float32Array(this.buffer,s,9);t instanceof We?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5],e[6]=t.value[6],e[7]=t.value[7],e[8]=t.value[8]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8])}else{const e=new Float32Array(this.buffer,s,6);t instanceof We?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5])}else{const e=new Float32Array(this.buffer,s,8);t instanceof We?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5],e[6]=t.value[6],e[7]=t.value[7]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7])}else{const e=new Float32Array(this.buffer,s,6);t instanceof We?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5])}else{const e=new Float32Array(this.buffer,s,4);t instanceof We?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Uint32Array(this.buffer,s,4);t instanceof Ue?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Uint32Array(this.buffer,s,3);t instanceof Ue?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])}else{const e=new Uint32Array(this.buffer,s,2);t instanceof Ue?(e[0]=t.value[0],e[1]=t.value[1]):(e[0]=t[0],e[1]=t[1])}else{const e=new Uint32Array(this.buffer,s,4);t instanceof Ue?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Uint32Array(this.buffer,s,3);t instanceof Ue?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])}else{const e=new Uint32Array(this.buffer,s,2);t instanceof Ue?(e[0]=t.value[0],e[1]=t.value[1]):(e[0]=t[0],e[1]=t[1])}else{const e=new Int32Array(this.buffer,s,4);t instanceof Ue?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Int32Array(this.buffer,s,3);t instanceof Ue?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])}else{const e=new Int32Array(this.buffer,s,2);t instanceof Ue?(e[0]=t.value[0],e[1]=t.value[1]):(e[0]=t[0],e[1]=t[1])}else{const e=new Float32Array(this.buffer,s,4);t instanceof Ue?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Float32Array(this.buffer,s,3);t instanceof Ue?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])}else{const e=new Float32Array(this.buffer,s,2);t instanceof Ue?(e[0]=t.value[0],e[1]=t.value[1]):(e[0]=t[0],e[1]=t[1])}else t instanceof Ve&&(new Int32Array(this.buffer,s,1)[0]=t.value);else t instanceof Ve&&(new Uint32Array(this.buffer,s,1)[0]=t.value);else t instanceof Ve&&(new Int32Array(this.buffer,s,1)[0]=t.value);else t instanceof Ve&&(new Float32Array(this.buffer,s,1)[0]=t.value)}getDataValue(e,t,n){let s=this.offset,i=this.typeInfo;for(;t;){if(t instanceof Ie){const r=t.index,o=e.evalExpression(r,n);let a=0;if(o instanceof Ve?a=o.value:console.error('GetDataValue: Invalid index type',r),i instanceof k)s+=a*i.stride,i=i.format;else{const t=e.getTypeName(i);'mat4x4'===t||'mat4x4f'===t||'mat4x4h'===t?(s+=16*a,i=e.getTypeInfo('vec4f')):console.error(`getDataValue: Type ${e.getTypeName(i)} is not an array`)}}else{if(!(t instanceof be))return console.error('GetDataValue: Unknown postfix type',t),null;{const n=t.value;if(i instanceof w){let e=!1;for(const t of i.members)if(t.name===n){s+=t.offset,i=t.type,e=!0;break}if(!e)return console.error(`GetDataValue: Member ${n} not found`),null}else if(i instanceof y){const t=e.getTypeName(i);if('vec2f'===t||'vec3f'===t||'vec4f'===t||'vec2i'===t||'vec3i'===t||'vec4i'===t||'vec2u'===t||'vec3u'===t||'vec4u'===t||'vec2b'===t||'vec3b'===t||'vec4b'===t||'vec2h'===t||'vec3h'===t||'vec4h'===t||'vec2'===t||'vec3'===t||'vec4'===t){if(n.length>0&&n.length<5){let r='f32',o='f';const a=[];for(let e=0;e<n.length;++e){const i=n[e].toLocaleLowerCase();let l=0;if('x'===i||'r'===i)l=0;else if('y'===i||'g'===i)l=1;else if('z'===i||'b'===i)l=2;else{if('w'!==i&&'a'!==i)return console.error(`Unknown member ${n}`),null;l=3}if('vec2f'===t)a.push(new Float32Array(this.buffer,s,2)[l]);else if('vec3f'===t){if(s+12>=this.buffer.byteLength)return console.log('Insufficient buffer data'),null;const e=new Float32Array(this.buffer,s,3);a.push(e[l])}else if('vec4f'===t)a.push(new Float32Array(this.buffer,s,4)[l]);else if('vec2i'===t)r='i32',o='i',a.push(new Int32Array(this.buffer,s,2)[l]);else if('vec3i'===t)r='i32',o='i',a.push(new Int32Array(this.buffer,s,3)[l]);else if('vec4i'===t)r='i32',o='i',a.push(new Int32Array(this.buffer,s,4)[l]);else if('vec2u'===t){r='u32',o='u';const e=new Uint32Array(this.buffer,s,2);a.push(e[l])}else'vec3u'===t?(r='u32',o='u',a.push(new Uint32Array(this.buffer,s,3)[l])):'vec4u'===t&&(r='u32',o='u',a.push(new Uint32Array(this.buffer,s,4)[l]))}return 1===a.length?new Ve(a[0],e.getTypeInfo(r)):(2===a.length?i=e.getTypeInfo(`vec2${o}`):3===a.length?i=e.getTypeInfo(`vec3${o}`):4===a.length?i=e.getTypeInfo(`vec4${o}`):console.error(`GetDataValue: Invalid vector length ${a.length}`),new Ue(a,i))}return console.error(`GetDataValue: Unknown member ${n}`),null}return console.error(`GetDataValue: Type ${t} is not a struct`),null}}}t=t.postfix}const r=e.getTypeName(i);return'f32'===r?new Ve(new Float32Array(this.buffer,s,1)[0],i):'i32'===r?new Ve(new Int32Array(this.buffer,s,1)[0],i):'u32'===r?new Ve(new Uint32Array(this.buffer,s,1)[0],i):'vec2f'===r?new Ue(new Float32Array(this.buffer,s,2),i):'vec3f'===r?new Ue(new Float32Array(this.buffer,s,3),i):'vec4f'===r?new Ue(new Float32Array(this.buffer,s,4),i):'vec2i'===r?new Ue(new Int32Array(this.buffer,s,2),i):'vec3i'===r?new Ue(new Int32Array(this.buffer,s,3),i):'vec4i'===r?new Ue(new Int32Array(this.buffer,s,4),i):'vec2u'===r?new Ue(new Uint32Array(this.buffer,s,2),i):'vec3u'===r?new Ue(new Uint32Array(this.buffer,s,3),i):'vec4u'===r?new Ue(new Uint32Array(this.buffer,s,4),i):i instanceof O&&'atomic'===i.name?'u32'===i.format.name?new Ve(new Uint32Array(this.buffer,s,1)[0],i.format):'i32'===i.format.name?new Ve(new Int32Array(this.buffer,s,1)[0],i.format):(console.error(`GetDataValue: Invalid atomic format ${i.format.name}`),null):new Qe(this.buffer,i,s)}toString(){let e='';if(this.typeInfo instanceof k)if('f32'===this.typeInfo.format.name){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if('i32'===this.typeInfo.format.name){const t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if('u32'===this.typeInfo.format.name){const t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if('vec2f'===this.typeInfo.format.name){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let n=1;n<t.length/2;++n)e+=`, [${t[2*n]}, ${t[2*n+1]}]`}else if('vec3f'===this.typeInfo.format.name){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}]`}else if('vec4f'===this.typeInfo.format.name){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}, ${t[n+3]}]`}else e='[...]';else this.typeInfo instanceof w?e+='{...}':e='[...]';return e}}(e=>{e[e.token=0]='token',e[e.keyword=1]='keyword',e[e.reserved=2]='reserved'})($||($={}));class je{constructor(e,t,n){this.name=e,this.type=t,this.rule=n}toString(){return this.name}}class Xe{}C=Xe,Xe.none=new je('',$.reserved,''),Xe.eof=new je('EOF',$.token,''),Xe.reserved={asm:new je('asm',$.reserved,'asm'),bf16:new je('bf16',$.reserved,'bf16'),do:new je('do',$.reserved,'do'),enum:new je('enum',$.reserved,'enum'),f16:new je('f16',$.reserved,'f16'),f64:new je('f64',$.reserved,'f64'),handle:new je('handle',$.reserved,'handle'),i8:new je('i8',$.reserved,'i8'),i16:new je('i16',$.reserved,'i16'),i64:new je('i64',$.reserved,'i64'),mat:new je('mat',$.reserved,'mat'),premerge:new je('premerge',$.reserved,'premerge'),regardless:new je('regardless',$.reserved,'regardless'),typedef:new je('typedef',$.reserved,'typedef'),u8:new je('u8',$.reserved,'u8'),u16:new je('u16',$.reserved,'u16'),u64:new je('u64',$.reserved,'u64'),unless:new je('unless',$.reserved,'unless'),using:new je('using',$.reserved,'using'),vec:new je('vec',$.reserved,'vec'),void:new je('void',$.reserved,'void')},Xe.keywords={array:new je('array',$.keyword,'array'),atomic:new je('atomic',$.keyword,'atomic'),bool:new je('bool',$.keyword,'bool'),f32:new je('f32',$.keyword,'f32'),i32:new je('i32',$.keyword,'i32'),mat2x2:new je('mat2x2',$.keyword,'mat2x2'),mat2x3:new je('mat2x3',$.keyword,'mat2x3'),mat2x4:new je('mat2x4',$.keyword,'mat2x4'),mat3x2:new je('mat3x2',$.keyword,'mat3x2'),mat3x3:new je('mat3x3',$.keyword,'mat3x3'),mat3x4:new je('mat3x4',$.keyword,'mat3x4'),mat4x2:new je('mat4x2',$.keyword,'mat4x2'),mat4x3:new je('mat4x3',$.keyword,'mat4x3'),mat4x4:new je('mat4x4',$.keyword,'mat4x4'),ptr:new je('ptr',$.keyword,'ptr'),sampler:new je('sampler',$.keyword,'sampler'),sampler_comparison:new je('sampler_comparison',$.keyword,'sampler_comparison'),struct:new je('struct',$.keyword,'struct'),texture_1d:new je('texture_1d',$.keyword,'texture_1d'),texture_2d:new je('texture_2d',$.keyword,'texture_2d'),texture_2d_array:new je('texture_2d_array',$.keyword,'texture_2d_array'),texture_3d:new je('texture_3d',$.keyword,'texture_3d'),texture_cube:new je('texture_cube',$.keyword,'texture_cube'),texture_cube_array:new je('texture_cube_array',$.keyword,'texture_cube_array'),texture_multisampled_2d:new je('texture_multisampled_2d',$.keyword,'texture_multisampled_2d'),texture_storage_1d:new je('texture_storage_1d',$.keyword,'texture_storage_1d'),texture_storage_2d:new je('texture_storage_2d',$.keyword,'texture_storage_2d'),texture_storage_2d_array:new je('texture_storage_2d_array',$.keyword,'texture_storage_2d_array'),texture_storage_3d:new je('texture_storage_3d',$.keyword,'texture_storage_3d'),texture_depth_2d:new je('texture_depth_2d',$.keyword,'texture_depth_2d'),texture_depth_2d_array:new je('texture_depth_2d_array',$.keyword,'texture_depth_2d_array'),texture_depth_cube:new je('texture_depth_cube',$.keyword,'texture_depth_cube'),texture_depth_cube_array:new je('texture_depth_cube_array',$.keyword,'texture_depth_cube_array'),texture_depth_multisampled_2d:new je('texture_depth_multisampled_2d',$.keyword,'texture_depth_multisampled_2d'),texture_external:new je('texture_external',$.keyword,'texture_external'),u32:new je('u32',$.keyword,'u32'),vec2:new je('vec2',$.keyword,'vec2'),vec3:new je('vec3',$.keyword,'vec3'),vec4:new je('vec4',$.keyword,'vec4'),bitcast:new je('bitcast',$.keyword,'bitcast'),block:new je('block',$.keyword,'block'),break:new je('break',$.keyword,'break'),case:new je('case',$.keyword,'case'),continue:new je('continue',$.keyword,'continue'),continuing:new je('continuing',$.keyword,'continuing'),default:new je('default',$.keyword,'default'),diagnostic:new je('diagnostic',$.keyword,'diagnostic'),discard:new je('discard',$.keyword,'discard'),else:new je('else',$.keyword,'else'),enable:new je('enable',$.keyword,'enable'),fallthrough:new je('fallthrough',$.keyword,'fallthrough'),false:new je('false',$.keyword,'false'),fn:new je('fn',$.keyword,'fn'),for:new je('for',$.keyword,'for'),function:new je('function',$.keyword,'function'),if:new je('if',$.keyword,'if'),let:new je('let',$.keyword,'let'),const:new je('const',$.keyword,'const'),loop:new je('loop',$.keyword,'loop'),while:new je('while',$.keyword,'while'),private:new je('private',$.keyword,'private'),read:new je('read',$.keyword,'read'),read_write:new je('read_write',$.keyword,'read_write'),return:new je('return',$.keyword,'return'),requires:new je('requires',$.keyword,'requires'),storage:new je('storage',$.keyword,'storage'),switch:new je('switch',$.keyword,'switch'),true:new je('true',$.keyword,'true'),alias:new je('alias',$.keyword,'alias'),type:new je('type',$.keyword,'type'),uniform:new je('uniform',$.keyword,'uniform'),var:new je('var',$.keyword,'var'),override:new je('override',$.keyword,'override'),workgroup:new je('workgroup',$.keyword,'workgroup'),write:new je('write',$.keyword,'write'),r8unorm:new je('r8unorm',$.keyword,'r8unorm'),r8snorm:new je('r8snorm',$.keyword,'r8snorm'),r8uint:new je('r8uint',$.keyword,'r8uint'),r8sint:new je('r8sint',$.keyword,'r8sint'),r16uint:new je('r16uint',$.keyword,'r16uint'),r16sint:new je('r16sint',$.keyword,'r16sint'),r16float:new je('r16float',$.keyword,'r16float'),rg8unorm:new je('rg8unorm',$.keyword,'rg8unorm'),rg8snorm:new je('rg8snorm',$.keyword,'rg8snorm'),rg8uint:new je('rg8uint',$.keyword,'rg8uint'),rg8sint:new je('rg8sint',$.keyword,'rg8sint'),r32uint:new je('r32uint',$.keyword,'r32uint'),r32sint:new je('r32sint',$.keyword,'r32sint'),r32float:new je('r32float',$.keyword,'r32float'),rg16uint:new je('rg16uint',$.keyword,'rg16uint'),rg16sint:new je('rg16sint',$.keyword,'rg16sint'),rg16float:new je('rg16float',$.keyword,'rg16float'),rgba8unorm:new je('rgba8unorm',$.keyword,'rgba8unorm'),rgba8unorm_srgb:new je('rgba8unorm_srgb',$.keyword,'rgba8unorm_srgb'),rgba8snorm:new je('rgba8snorm',$.keyword,'rgba8snorm'),rgba8uint:new je('rgba8uint',$.keyword,'rgba8uint'),rgba8sint:new je('rgba8sint',$.keyword,'rgba8sint'),bgra8unorm:new je('bgra8unorm',$.keyword,'bgra8unorm'),bgra8unorm_srgb:new je('bgra8unorm_srgb',$.keyword,'bgra8unorm_srgb'),rgb10a2unorm:new je('rgb10a2unorm',$.keyword,'rgb10a2unorm'),rg11b10float:new je('rg11b10float',$.keyword,'rg11b10float'),rg32uint:new je('rg32uint',$.keyword,'rg32uint'),rg32sint:new je('rg32sint',$.keyword,'rg32sint'),rg32float:new je('rg32float',$.keyword,'rg32float'),rgba16uint:new je('rgba16uint',$.keyword,'rgba16uint'),rgba16sint:new je('rgba16sint',$.keyword,'rgba16sint'),rgba16float:new je('rgba16float',$.keyword,'rgba16float'),rgba32uint:new je('rgba32uint',$.keyword,'rgba32uint'),rgba32sint:new je('rgba32sint',$.keyword,'rgba32sint'),rgba32float:new je('rgba32float',$.keyword,'rgba32float'),static_assert:new je('static_assert',$.keyword,'static_assert')},Xe.tokens={decimal_float_literal:new je('decimal_float_literal',$.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new je('hex_float_literal',$.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new je('int_literal',$.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new je('uint_literal',$.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new je('ident',$.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new je('and',$.token,'&'),and_and:new je('and_and',$.token,'&&'),arrow:new je('arrow ',$.token,'->'),attr:new je('attr',$.token,'@'),forward_slash:new je('forward_slash',$.token,'/'),bang:new je('bang',$.token,'!'),bracket_left:new je('bracket_left',$.token,'['),bracket_right:new je('bracket_right',$.token,']'),brace_left:new je('brace_left',$.token,'{'),brace_right:new je('brace_right',$.token,'}'),colon:new je('colon',$.token,':'),comma:new je('comma',$.token,','),equal:new je('equal',$.token,'='),equal_equal:new je('equal_equal',$.token,'=='),not_equal:new je('not_equal',$.token,'!='),greater_than:new je('greater_than',$.token,'>'),greater_than_equal:new je('greater_than_equal',$.token,'>='),shift_right:new je('shift_right',$.token,'>>'),less_than:new je('less_than',$.token,'<'),less_than_equal:new je('less_than_equal',$.token,'<='),shift_left:new je('shift_left',$.token,'<<'),modulo:new je('modulo',$.token,'%'),minus:new je('minus',$.token,'-'),minus_minus:new je('minus_minus',$.token,'--'),period:new je('period',$.token,'.'),plus:new je('plus',$.token,'+'),plus_plus:new je('plus_plus',$.token,'++'),or:new je('or',$.token,'|'),or_or:new je('or_or',$.token,'||'),paren_left:new je('paren_left',$.token,'('),paren_right:new je('paren_right',$.token,')'),semicolon:new je('semicolon',$.token,';'),star:new je('star',$.token,'*'),tilde:new je('tilde',$.token,'~'),underscore:new je('underscore',$.token,'_'),xor:new je('xor',$.token,'^'),plus_equal:new je('plus_equal',$.token,'+='),minus_equal:new je('minus_equal',$.token,'-='),times_equal:new je('times_equal',$.token,'*='),division_equal:new je('division_equal',$.token,'/='),modulo_equal:new je('modulo_equal',$.token,'%='),and_equal:new je('and_equal',$.token,'&='),or_equal:new je('or_equal',$.token,'|='),xor_equal:new je('xor_equal',$.token,'^='),shift_right_equal:new je('shift_right_equal',$.token,'>>='),shift_left_equal:new je('shift_left_equal',$.token,'<<=')},Xe.simpleTokens={'@':C.tokens.attr,'{':C.tokens.brace_left,'}':C.tokens.brace_right,':':C.tokens.colon,',':C.tokens.comma,'(':C.tokens.paren_left,')':C.tokens.paren_right,';':C.tokens.semicolon},Xe.literalTokens={'&':C.tokens.and,'&&':C.tokens.and_and,'->':C.tokens.arrow,'/':C.tokens.forward_slash,'!':C.tokens.bang,'[':C.tokens.bracket_left,']':C.tokens.bracket_right,'=':C.tokens.equal,'==':C.tokens.equal_equal,'!=':C.tokens.not_equal,'>':C.tokens.greater_than,'>=':C.tokens.greater_than_equal,'>>':C.tokens.shift_right,'<':C.tokens.less_than,'<=':C.tokens.less_than_equal,'<<':C.tokens.shift_left,'%':C.tokens.modulo,'-':C.tokens.minus,'--':C.tokens.minus_minus,'.':C.tokens.period,'+':C.tokens.plus,'++':C.tokens.plus_plus,'|':C.tokens.or,'||':C.tokens.or_or,'*':C.tokens.star,'~':C.tokens.tilde,_:C.tokens.underscore,'^':C.tokens.xor,'+=':C.tokens.plus_equal,'-=':C.tokens.minus_equal,'*=':C.tokens.times_equal,'/=':C.tokens.division_equal,'%=':C.tokens.modulo_equal,'&=':C.tokens.and_equal,'|=':C.tokens.or_equal,'^=':C.tokens.xor_equal,'>>=':C.tokens.shift_right_equal,'<<=':C.tokens.shift_left_equal},Xe.regexTokens={decimal_float_literal:C.tokens.decimal_float_literal,hex_float_literal:C.tokens.hex_float_literal,int_literal:C.tokens.int_literal,uint_literal:C.tokens.uint_literal,ident:C.tokens.ident},Xe.storage_class=[C.keywords.function,C.keywords.private,C.keywords.workgroup,C.keywords.uniform,C.keywords.storage],Xe.access_mode=[C.keywords.read,C.keywords.write,C.keywords.read_write],Xe.sampler_type=[C.keywords.sampler,C.keywords.sampler_comparison],Xe.sampled_texture_type=[C.keywords.texture_1d,C.keywords.texture_2d,C.keywords.texture_2d_array,C.keywords.texture_3d,C.keywords.texture_cube,C.keywords.texture_cube_array],Xe.multisampled_texture_type=[C.keywords.texture_multisampled_2d],Xe.storage_texture_type=[C.keywords.texture_storage_1d,C.keywords.texture_storage_2d,C.keywords.texture_storage_2d_array,C.keywords.texture_storage_3d],Xe.depth_texture_type=[C.keywords.texture_depth_2d,C.keywords.texture_depth_2d_array,C.keywords.texture_depth_cube,C.keywords.texture_depth_cube_array,C.keywords.texture_depth_multisampled_2d],Xe.texture_external_type=[C.keywords.texture_external],Xe.any_texture_type=[...C.sampled_texture_type,...C.multisampled_texture_type,...C.storage_texture_type,...C.depth_texture_type,...C.texture_external_type],Xe.texel_format=[C.keywords.r8unorm,C.keywords.r8snorm,C.keywords.r8uint,C.keywords.r8sint,C.keywords.r16uint,C.keywords.r16sint,C.keywords.r16float,C.keywords.rg8unorm,C.keywords.rg8snorm,C.keywords.rg8uint,C.keywords.rg8sint,C.keywords.r32uint,C.keywords.r32sint,C.keywords.r32float,C.keywords.rg16uint,C.keywords.rg16sint,C.keywords.rg16float,C.keywords.rgba8unorm,C.keywords.rgba8unorm_srgb,C.keywords.rgba8snorm,C.keywords.rgba8uint,C.keywords.rgba8sint,C.keywords.bgra8unorm,C.keywords.bgra8unorm_srgb,C.keywords.rgb10a2unorm,C.keywords.rg11b10float,C.keywords.rg32uint,C.keywords.rg32sint,C.keywords.rg32float,C.keywords.rgba16uint,C.keywords.rgba16sint,C.keywords.rgba16float,C.keywords.rgba32uint,C.keywords.rgba32sint,C.keywords.rgba32float],Xe.const_literal=[C.tokens.int_literal,C.tokens.uint_literal,C.tokens.decimal_float_literal,C.tokens.hex_float_literal,C.keywords.true,C.keywords.false],Xe.literal_or_ident=[C.tokens.ident,C.tokens.int_literal,C.tokens.uint_literal,C.tokens.decimal_float_literal,C.tokens.hex_float_literal],Xe.element_count_expression=[C.tokens.int_literal,C.tokens.uint_literal,C.tokens.ident],Xe.template_types=[C.keywords.vec2,C.keywords.vec3,C.keywords.vec4,C.keywords.mat2x2,C.keywords.mat2x3,C.keywords.mat2x4,C.keywords.mat3x2,C.keywords.mat3x3,C.keywords.mat3x4,C.keywords.mat4x2,C.keywords.mat4x3,C.keywords.mat4x4,C.keywords.atomic,C.keywords.bitcast,...C.any_texture_type],Xe.attribute_name=[C.tokens.ident,C.keywords.block,C.keywords.diagnostic],Xe.assignment_operators=[C.tokens.equal,C.tokens.plus_equal,C.tokens.minus_equal,C.tokens.times_equal,C.tokens.division_equal,C.tokens.modulo_equal,C.tokens.and_equal,C.tokens.or_equal,C.tokens.xor_equal,C.tokens.shift_right_equal,C.tokens.shift_left_equal],Xe.increment_operators=[C.tokens.plus_plus,C.tokens.minus_minus];class Ge{constructor(e,t,n){this.type=e,this.lexeme=t,this.line=n}toString(){return this.lexeme}isTemplateType(){return-1!=Xe.template_types.indexOf(this.type)}isArrayType(){return this.type==Xe.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class qe{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=null!=e?e:''}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new Ge(Xe.eof,'',this._line)),this._tokens}scanToken(){let e=this._advance();if('\n'==e)return this._line++,!0;if(this._isWhitespace(e))return!0;if('/'==e){if('/'==this._peekAhead()){for(;'\n'!=e;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if('*'==this._peekAhead()){this._advance();let t=1;for(;t>0;){if(this._isAtEnd())return!0;if(e=this._advance(),'\n'==e)this._line++;else if('*'==e){if('/'==this._peekAhead()&&(this._advance(),t--,0==t))return!0}else'/'==e&&'*'==this._peekAhead()&&(this._advance(),t++)}return!0}}const t=Xe.simpleTokens[e];if(t)return this._addToken(t),!0;let n=Xe.none;const s=this._isAlpha(e),i='_'===e;if(this._isAlphaNumeric(e)){let t=this._peekAhead();for(;this._isAlphaNumeric(t);)e+=this._advance(),t=this._peekAhead()}if(s){const t=Xe.keywords[e];if(t)return this._addToken(t),!0}if(s||i)return this._addToken(Xe.tokens.ident),!0;for(;;){let t=this._findType(e);const s=this._peekAhead();if('-'==e&&this._tokens.length>0){if('='==s)return this._current++,e+=s,this._addToken(Xe.tokens.minus_equal),!0;if('-'==s)return this._current++,e+=s,this._addToken(Xe.tokens.minus_minus),!0;const n=this._tokens.length-1;if((-1!=Xe.literal_or_ident.indexOf(this._tokens[n].type)||this._tokens[n].type==Xe.tokens.paren_right)&&'>'!=s)return this._addToken(t),!0}if('>'==e&&('>'==s||'='==s)){let e=!1,n=this._tokens.length-1;for(let t=0;t<5&&n>=0&&-1===Xe.assignment_operators.indexOf(this._tokens[n].type);++t,--n)if(this._tokens[n].type===Xe.tokens.less_than){n>0&&this._tokens[n-1].isArrayOrTemplateType()&&(e=!0);break}if(e)return this._addToken(t),!0}if(t===Xe.none){let s=e,i=0;const r=2;for(let e=0;e<r;++e)if(s+=this._peekAhead(e),t=this._findType(s),t!==Xe.none){i=e;break}if(t===Xe.none)return n!==Xe.none&&(this._current--,this._addToken(n),!0);e=s,this._current+=i+1}if(n=t,this._isAtEnd())break;e+=this._advance()}return n!==Xe.none&&(this._addToken(n),!0)}_findType(e){for(const t in Xe.regexTokens){const n=Xe.regexTokens[t];if(this._match(e,n.rule))return n}const t=Xe.literalTokens[e];return t||Xe.none}_match(e,t){const n=t.exec(e);return n&&0==n.index&&n[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return e>='a'&&e<='z'||e>='A'&&e<='Z'}_isAlphaNumeric(e){return e>='a'&&e<='z'||e>='A'&&e<='Z'||'_'==e||e>='0'&&e<='9'}_isWhitespace(e){return' '==e||'\t'==e||'\r'==e}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?'\0':this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new Ge(e,t,this._line))}}class He{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class Ye{constructor(e,t){this.align=e,this.size=t}}class Ke{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new N,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return'texture_storage_1d'==e.name||'texture_storage_2d'==e.name||'texture_storage_2d_array'==e.name||'texture_storage_3d'==e.name}updateAST(e){for(const t of e)t instanceof W&&this._functions.set(t.name,new He(t));for(const t of e)if(t instanceof fe){const e=this.getTypeInfo(t,null);e instanceof w&&this.structs.push(e)}for(const t of e)if(t instanceof le)this.aliases.push(this._getAliasInfo(t));else if(t instanceof H){const e=t,n=this._getAttributeNum(e.attributes,'id',0),s=null!=e.type?this.getTypeInfo(e.type,e.attributes):null;this.overrides.push(new M(e.name,s,e.attributes,n))}else if(this._isUniformVar(t)){const e=t,n=this._getAttributeNum(e.attributes,'group',0),s=this._getAttributeNum(e.attributes,'binding',0),i=this.getTypeInfo(e.type,e.attributes),r=new A(e.name,i,n,s,e.attributes,S.Uniform,e.access);this.uniforms.push(r)}else if(this._isStorageVar(t)){const e=t,n=this._getAttributeNum(e.attributes,'group',0),s=this._getAttributeNum(e.attributes,'binding',0),i=this.getTypeInfo(e.type,e.attributes),r=this._isStorageTexture(i),o=new A(e.name,i,n,s,e.attributes,r?S.StorageTexture:S.Storage,e.access);this.storage.push(o)}else if(this._isTextureVar(t)){const e=t,n=this._getAttributeNum(e.attributes,'group',0),s=this._getAttributeNum(e.attributes,'binding',0),i=this.getTypeInfo(e.type,e.attributes),r=this._isStorageTexture(i),o=new A(e.name,i,n,s,e.attributes,r?S.StorageTexture:S.Texture,e.access);r?this.storage.push(o):this.textures.push(o)}else if(this._isSamplerVar(t)){const e=t,n=this._getAttributeNum(e.attributes,'group',0),s=this._getAttributeNum(e.attributes,'binding',0),i=this.getTypeInfo(e.type,e.attributes),r=new A(e.name,i,n,s,e.attributes,S.Sampler,e.access);this.samplers.push(r)}else if(t instanceof W){const e=this._getAttribute(t,'vertex'),n=this._getAttribute(t,'fragment'),s=this._getAttribute(t,'compute'),i=e||n||s,r=new B(t.name,null==i?void 0:i.name,t.attributes);r.attributes=t.attributes,r.startLine=t.startLine,r.endLine=t.endLine,this.functions.push(r),this._functions.get(t.name).info=r,i&&(this._functions.get(t.name).inUse=!0,r.inUse=!0,r.resources=this._findResources(t,!!i),r.inputs=this._getInputs(t.args),r.outputs=this._getOutputs(t.returnType),this.entry[i.name].push(r)),r.arguments=t.args.map((e=>new L(e.name,this.getTypeInfo(e.type,e.attributes),e.attributes))),r.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null}else;for(const e of this._functions.values())e.info&&(e.info.inUse=e.inUse,this._addCalls(e.node,e.info.calls));for(const e of this._functions.values())e.node.search((t=>{var n;if('varExpr'===t.astNodeType){const s=t;for(const t of this.overrides)s.name==t.name&&(null===(n=e.info)||void 0===n||n.overrides.push(t))}}));for(const e of this.uniforms)this._markStructsInUse(e.type);for(const e of this.storage)this._markStructsInUse(e.type)}getStructInfo(e){for(const t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(const t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var n;for(const s of e.calls){const e=null===(n=this._functions.get(s.name))||void 0===n?void 0:n.info;e&&t.add(e)}}findResource(e,t){for(const n of this.uniforms)if(n.group==e&&n.binding==t)return n;for(const n of this.storage)if(n.group==e&&n.binding==t)return n;for(const n of this.textures)if(n.group==e&&n.binding==t)return n;for(const n of this.samplers)if(n.group==e&&n.binding==t)return n;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const n=[],s=this,i=[];return e.search((r=>{if(r instanceof V)i.push({});else if(r instanceof z)i.pop();else if(r instanceof q){const e=r;t&&null!==e.type&&this._markStructsFromAST(e.type),i.length>0&&(i[i.length-1][e.name]=e)}else if(r instanceof ye){const e=r;t&&null!==e.type&&this._markStructsFromAST(e.type)}else if(r instanceof Y){const e=r;t&&null!==e.type&&this._markStructsFromAST(e.type),i.length>0&&(i[i.length-1][e.name]=e)}else if(r instanceof we){const e=r;if(i.length>0){if(i[i.length-1][e.name])return}const t=s._findResource(e.name);t&&n.push(t)}else if(r instanceof _e){const i=r,o=s._functions.get(i.name);o&&(t&&(o.inUse=!0),e.calls.add(o.node),null===o.resources&&(o.resources=s._findResources(o.node,t)),n.push(...o.resources))}else if(r instanceof ee){const i=r,o=s._functions.get(i.name);o&&(t&&(o.inUse=!0),e.calls.add(o.node),null===o.resources&&(o.resources=s._findResources(o.node,t)),n.push(...o.resources))}})),[...new Map(n.map((e=>[e.name,e]))).values()]}getBindGroups(){const e=[];function t(t,n){t>=e.length&&(e.length=t+1),void 0===e[t]&&(e[t]=[]),n>=e[t].length&&(e[t].length=n+1)}for(const n of this.uniforms){t(n.group,n.binding);e[n.group][n.binding]=n}for(const n of this.storage){t(n.group,n.binding);e[n.group][n.binding]=n}for(const n of this.textures){t(n.group,n.binding);e[n.group][n.binding]=n}for(const n of this.samplers){t(n.group,n.binding);e[n.group][n.binding]=n}return e}_getOutputs(e,t=void 0){if(void 0===t&&(t=[]),e instanceof fe)this._getStructOutputs(e,t);else{const n=this._getOutputInfo(e);null!==n&&t.push(n)}return t}_getStructOutputs(e,t){for(const n of e.members)if(n.type instanceof fe)this._getStructOutputs(n.type,t);else{const e=this._getAttribute(n,'location')||this._getAttribute(n,'builtin');if(null!==e){const s=this.getTypeInfo(n.type,n.type.attributes),i=this._parseInt(e.value),r=new D(n.name,s,e.name,i);t.push(r)}}}_getOutputInfo(e){const t=this._getAttribute(e,'location')||this._getAttribute(e,'builtin');if(null!==t){const n=this.getTypeInfo(e,e.attributes),s=this._parseInt(t.value);return new D('',n,t.name,s)}return null}_getInputs(e,t=void 0){void 0===t&&(t=[]);for(const n of e)if(n.type instanceof fe)this._getStructInputs(n.type,t);else{const e=this._getInputInfo(n);null!==e&&t.push(e)}return t}_getStructInputs(e,t){for(const n of e.members)if(n.type instanceof fe)this._getStructInputs(n.type,t);else{const e=this._getInputInfo(n);null!==e&&t.push(e)}}_getInputInfo(e){const t=this._getAttribute(e,'location')||this._getAttribute(e,'builtin');if(null!==t){const n=this._getAttribute(e,'interpolation'),s=this.getTypeInfo(e.type,e.attributes),i=this._parseInt(t.value),r=new P(e.name,s,t.name,i);return null!==n&&(r.interpolation=this._parseString(n.value)),r}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new E(e.name,this.getTypeInfo(e.type,null))}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof ge){const n=e,s=n.format?this.getTypeInfo(n.format,n.attributes):null,i=new k(n.name,t);return i.format=s,i.count=n.count,this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof fe){const n=e,s=new w(n.name,t);s.startLine=n.startLine,s.endLine=n.endLine;for(const e of n.members){const t=this.getTypeInfo(e.type,e.attributes);s.members.push(new _(e.name,t,e.attributes))}return this._types.set(e,s),this._updateTypeInfo(s),s}if(e instanceof ve){const n=e,s=n.format instanceof de,i=n.format?s?this.getTypeInfo(n.format,null):new y(n.format,null):null,r=new O(n.name,i,t,n.access);return this._types.set(e,r),this._updateTypeInfo(r),r}if(e instanceof pe){const n=e,s=n.format?this.getTypeInfo(n.format,null):null,i=new O(n.name,s,t,n.access);return this._types.set(e,i),this._updateTypeInfo(i),i}const n=new y(e.name,t);return this._types.set(e,n),this._updateTypeInfo(n),n}_updateTypeInfo(e){var t,n,s;const i=this._getTypeSize(e);if(e.size=null!==(t=null==i?void 0:i.size)&&void 0!==t?t:0,e instanceof k&&e.format){const t=this._getTypeSize(e.format);e.stride=Math.max(null!==(n=null==t?void 0:t.size)&&void 0!==n?n:0,null!==(s=null==t?void 0:t.align)&&void 0!==s?s:0),this._updateTypeInfo(e.format)}e instanceof w&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let n=0,s=0,i=0,r=0;for(let o=0,a=e.members.length;o<a;++o){const a=e.members[o],l=this._getTypeSize(a);if(!l)continue;null!==(t=this._getAlias(a.type.name))&&void 0!==t||a.type;const c=l.align,h=l.size;n=this._roundUp(c,n+s),s=h,i=n,r=Math.max(r,c),a.offset=n,a.size=h,this._updateTypeInfo(a.type)}e.size=this._roundUp(r,i+s),e.align=r}_getTypeSize(e){var t,n;if(null==e)return null;const s=this._getAttributeNum(e.attributes,'size',0),i=this._getAttributeNum(e.attributes,'align',0);if(e instanceof _&&(e=e.type),e instanceof y){const t=this._getAlias(e.name);null!==t&&(e=t)}{const n=Ke._typeInfo[e.name];if(void 0!==n){const r='f16'===(null===(t=e.format)||void 0===t?void 0:t.name)?2:1;return new Ye(Math.max(i,n.align/r),Math.max(s,n.size/r))}}{const t=Ke._typeInfo[e.name.substring(0,e.name.length-1)];if(t){const n='h'===e.name[e.name.length-1]?2:1;return new Ye(Math.max(i,t.align/n),Math.max(s,t.size/n))}}if(e instanceof k){let t=e,r=8,o=8;const a=this._getTypeSize(t.format);null!==a&&(o=a.size,r=a.align);return o=t.count*this._getAttributeNum(null!==(n=null==e?void 0:e.attributes)&&void 0!==n?n:null,'stride',this._roundUp(r,o)),s&&(o=s),new Ye(Math.max(i,r),Math.max(s,o))}if(e instanceof w){let t=0,n=0,r=0,o=0,a=0;for(const n of e.members){const e=this._getTypeSize(n.type);null!==e&&(t=Math.max(e.align,t),r=this._roundUp(e.align,r+o),o=e.size,a=r)}return n=this._roundUp(t,a+o),new Ye(Math.max(i,t),Math.max(s,n))}return null}_isUniformVar(e){return e instanceof q&&'uniform'==e.storage}_isStorageVar(e){return e instanceof q&&'storage'==e.storage}_isTextureVar(e){return e instanceof q&&null!==e.type&&-1!=Ke._textureTypes.indexOf(e.type.name)}_isSamplerVar(e){return e instanceof q&&null!==e.type&&-1!=Ke._samplerTypes.indexOf(e.type.name)}_getAttribute(e,t){const n=e;if(!n||!n.attributes)return null;const s=n.attributes;for(let e of s)if(e.name==t)return e;return null}_getAttributeNum(e,t,n){if(null===e)return n;for(let s of e)if(s.name==t){let e=null!==s&&null!==s.value?s.value:n;return e instanceof Array&&(e=e[0]),'number'==typeof e?e:'string'==typeof e?parseInt(e):n}return n}_roundUp(e,t){return Math.ceil(t/e)*e}}Ke._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},Ke._textureTypes=Xe.any_texture_type.map((e=>e.name)),Ke._samplerTypes=Xe.sampler_type.map((e=>e.name));class Ze{constructor(e,t,n){this.name=e,this.value=t,this.node=n}clone(){return new Ze(this.name,this.value,this.node)}}class Je{constructor(e){this.name=e.name,this.node=e}clone(){return new Je(this.node)}}class et{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName='',e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){var t;return this.variables.has(e)?null!==(t=this.variables.get(e))&&void 0!==t?t:null:this.parent?this.parent.getVariable(e):null}getFunction(e){var t;return this.functions.has(e)?null!==(t=this.functions.get(e))&&void 0!==t?t:null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,n){this.variables.set(e,new Ze(e,t,null!=n?n:null))}setVariable(e,t,n){const s=this.getVariable(e);null!==s?s.value=t:this.createVariable(e,t,n)}getVariableValue(e){var t;const n=this.getVariable(e);return null!==(t=null==n?void 0:n.value)&&void 0!==t?t:null}clone(){return new et(this)}}class tt{evalExpression(e,t){return null}getTypeName(e){return''}getTypeInfo(e){return null}getVariableName(e,t){return''}}class nt{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){const n=this.exec.evalExpression(e.args[0],t);let s=!0;if(n instanceof Ue)return n.value.forEach((e=>{e||(s=!1)})),new Ve(s?1:0,this.getTypeInfo('bool'));throw new Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue){const e=n.value.some((e=>e));return new Ve(e?1:0,this.getTypeInfo('bool'))}throw new Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){const n=this.exec.evalExpression(e.args[2],t);if(!(n instanceof Ve))throw new Error(`Select() expects a bool condition. Line ${e.line}`);return n.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let n=e.args[0];n instanceof $e&&(n=n.right);const s=this.exec.evalExpression(n,t);if(s instanceof Qe&&0===s.typeInfo.size){const e=s.typeInfo,t=s.buffer.byteLength/e.stride;return new Ve(t,this.getTypeInfo('u32'))}return new Ve(s.typeInfo.size,this.getTypeInfo('u32'))}Abs(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.abs(e))),n.typeInfo);const s=n;return new Ve(Math.abs(s.value),s.typeInfo)}Acos(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.acos(e))),n.typeInfo);const s=n;return new Ve(Math.acos(s.value),n.typeInfo)}Acosh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.acosh(e))),n.typeInfo);const s=n;return new Ve(Math.acosh(s.value),n.typeInfo)}Asin(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.asin(e))),n.typeInfo);const s=n;return new Ve(Math.asin(s.value),n.typeInfo)}Asinh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.asinh(e))),n.typeInfo);const s=n;return new Ve(Math.asinh(s.value),n.typeInfo)}Atan(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.atan(e))),n.typeInfo);const s=n;return new Ve(Math.atan(s.value),n.typeInfo)}Atanh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.atanh(e))),n.typeInfo);const s=n;return new Ve(Math.atanh(s.value),n.typeInfo)}Atan2(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ue&&s instanceof Ue)return new Ue(n.value.map(((e,t)=>Math.atan2(e,s.value[t]))),n.typeInfo);const i=n,r=s;return new Ve(Math.atan2(i.value,r.value),n.typeInfo)}Ceil(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.ceil(e))),n.typeInfo);const s=n;return new Ve(Math.ceil(s.value),n.typeInfo)}_clamp(e,t,n){return Math.min(Math.max(e,t),n)}Clamp(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof Ue&&s instanceof Ue&&i instanceof Ue)return new Ue(n.value.map(((e,t)=>this._clamp(e,s.value[t],i.value[t]))),n.typeInfo);const r=n,o=s,a=i;return new Ve(this._clamp(r.value,o.value,a.value),n.typeInfo)}Cos(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.cos(e))),n.typeInfo);const s=n;return new Ve(Math.cos(s.value),n.typeInfo)}Cosh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.cosh(e))),n.typeInfo);const s=n;return new Ve(Math.cos(s.value),n.typeInfo)}CountLeadingZeros(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.clz32(e))),n.typeInfo);const s=n;return new Ve(Math.clz32(s.value),n.typeInfo)}_countOneBits(e){let t=0;for(;0!==e;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>this._countOneBits(e))),n.typeInfo);const s=n;return new Ve(this._countOneBits(s.value),n.typeInfo)}_countTrailingZeros(e){if(0===e)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>this._countTrailingZeros(e))),n.typeInfo);const s=n;return new Ve(this._countTrailingZeros(s.value),n.typeInfo)}Cross(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ue&&s instanceof Ue){if(3!==n.value.length||3!==s.value.length)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;const t=n.value,i=s.value;return new Ue([t[1]*i[2]-i[1]*t[2],t[2]*i[0]-i[2]*t[0],t[0]*i[1]-i[0]*t[1]],n.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){const n=this.exec.evalExpression(e.args[0],t),s=180/Math.PI;if(n instanceof Ue)return new Ue(n.value.map((e=>e*s)),n.typeInfo);return new Ve(n.value*s,n.typeInfo)}Determinant(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof We){const e=n.value,t=this.exec.getTypeName(n.typeInfo),s=t.endsWith('h')?this.getTypeInfo('f16'):this.getTypeInfo('f32');if('mat2x2'===t||'mat2x2f'===t||'mat2x2h'===t)return new Ve(e[0]*e[3]-e[1]*e[2],s);if('mat2x3'===t||'mat2x3f'===t||'mat2x3h'===t)return new Ve(e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]),s);if('mat2x4'===t||'mat2x4f'===t||'mat2x4h'===t)console.error(`TODO: Determinant for ${t}`);else if('mat3x2'===t||'mat3x2f'===t||'mat3x2h'===t)console.error(`TODO: Determinant for ${t}`);else{if('mat3x3'===t||'mat3x3f'===t||'mat3x3h'===t)return new Ve(e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]),s);'mat3x4'===t||'mat3x4f'===t||'mat3x4h'===t||'mat4x2'===t||'mat4x2f'===t||'mat4x2h'===t||'mat4x3'===t||'mat4x3f'===t||'mat4x3h'===t?console.error(`TODO: Determinant for ${t}`):'mat4x4'!==t&&'mat4x4f'!==t&&'mat4x4h'!==t||console.error(`TODO: Determinant for ${t}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ue&&s instanceof Ue){let e=0;for(let t=0;t<n.value.length;++t)e+=(n.value[t]-s.value[t])*(n.value[t]-s.value[t]);return new Ve(Math.sqrt(e),this.getTypeInfo('f32'))}const i=n,r=s;return new Ve(Math.abs(i.value-r.value),n.typeInfo)}_dot(e,t){let n=0;for(let s=0;s<e.length;++s)n+=t[s]*e[s];return n}Dot(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);return n instanceof Ue&&s instanceof Ue?new Ve(this._dot(n.value,s.value),this.getTypeInfo('f32')):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.exp(e))),n.typeInfo);const s=n;return new Ve(Math.exp(s.value),n.typeInfo)}Exp2(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.pow(2,e))),n.typeInfo);const s=n;return new Ve(Math.pow(2,s.value),n.typeInfo)}ExtractBits(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if('u32'!==s.typeInfo.name&&'x32'!==s.typeInfo.name)return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if('u32'!==i.typeInfo.name&&'x32'!==i.typeInfo.name)return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;const r=s.value,o=i.value;if(n instanceof Ue)return new Ue(n.value.map((e=>e>>r&(1<<o)-1)),n.typeInfo);if('i32'!==n.typeInfo.name&&'x32'!==n.typeInfo.name)return console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null;const a=n.value;return new Ve(a>>r&(1<<o)-1,this.getTypeInfo('i32'))}FaceForward(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof Ue&&s instanceof Ue&&i instanceof Ue){const e=this._dot(s.value,i.value);return new Ue(e<0?n.value:n.value.map((e=>-e)),n.typeInfo)}return console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null}_firstLeadingBit(e){return 0===e?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>this._firstLeadingBit(e))),n.typeInfo);const s=n;return new Ve(this._firstLeadingBit(s.value),n.typeInfo)}_firstTrailingBit(e){return 0===e?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>this._firstTrailingBit(e))),n.typeInfo);const s=n;return new Ve(this._firstTrailingBit(s.value),n.typeInfo)}Floor(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.floor(e))),n.typeInfo);const s=n;return new Ve(Math.floor(s.value),n.typeInfo)}Fma(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof Ue&&s instanceof Ue&&i instanceof Ue)return n.value.length!==s.value.length||n.value.length!==i.value.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new Ue(n.value.map(((e,t)=>e*s.value[t]+i.value[t])),n.typeInfo);const r=n,o=s,a=i;return new Ve(r.value*o.value+a.value,r.typeInfo)}Fract(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>e-Math.floor(e))),n.typeInfo);const s=n;return new Ve(s.value-Math.floor(s.value),n.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t),r=this.exec.evalExpression(e.args[3],t);if('u32'!==i.typeInfo.name&&'x32'!==i.typeInfo.name)return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;const o=i.value,a=(1<<r.value)-1<<o,l=~a;if(n instanceof Ue&&s instanceof Ue)return new Ue(n.value.map(((e,t)=>e&l|s.value[t]<<o&a)),n.typeInfo);const c=n.value,h=s.value;return new Ve(c&l|h<<o&a,n.typeInfo)}InverseSqrt(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>1/Math.sqrt(e))),n.typeInfo);const s=n;return new Ve(1/Math.sqrt(s.value),n.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue){let e=0;return n.value.forEach((t=>{e+=t*t})),new Ve(Math.sqrt(e),this.getTypeInfo('f32'))}const s=n;return new Ve(Math.abs(s.value),n.typeInfo)}Log(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.log(e))),n.typeInfo);const s=n;return new Ve(Math.log(s.value),n.typeInfo)}Log2(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.log2(e))),n.typeInfo);const s=n;return new Ve(Math.log2(s.value),n.typeInfo)}Max(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ue&&s instanceof Ue)return new Ue(n.value.map(((e,t)=>Math.max(e,s.value[t]))),n.typeInfo);const i=n,r=s;return new Ve(Math.max(i.value,r.value),n.typeInfo)}Min(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ue&&s instanceof Ue)return new Ue(n.value.map(((e,t)=>Math.min(e,s.value[t]))),n.typeInfo);const i=n,r=s;return new Ve(Math.min(i.value,r.value),n.typeInfo)}Mix(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof Ue&&s instanceof Ue&&i instanceof Ue)return new Ue(n.value.map(((e,t)=>n.value[t]*(1-i.value[t])+s.value[t]*i.value[t])),n.typeInfo);const r=s,o=i;return new Ve(n.value*(1-o.value)+r.value*o.value,n.typeInfo)}Modf(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ue&&s instanceof Ue)return new Ue(n.value.map(((e,t)=>e%s.value[t])),n.typeInfo);const i=s;return new Ve(n.value%i.value,n.typeInfo)}Normalize(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue){const s=this.Length(e,t).value;return new Ue(n.value.map((e=>e/s)),n.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ue&&s instanceof Ue)return new Ue(n.value.map(((e,t)=>Math.pow(e,s.value[t]))),n.typeInfo);const i=n,r=s;return new Ve(Math.pow(i.value,r.value),n.typeInfo)}QuantizeToF16(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>e)),n.typeInfo);return new Ve(n.value,n.typeInfo)}Radians(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>e*Math.PI/180)),n.typeInfo);return new Ve(n.value*Math.PI/180,n.typeInfo)}Reflect(e,t){let n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ue&&s instanceof Ue){const e=this._dot(n.value,s.value);return new Ue(n.value.map(((t,n)=>t-2*e*s.value[n])),n.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof Ue&&s instanceof Ue&&i instanceof Ve){const e=this._dot(s.value,n.value);return new Ue(n.value.map(((t,n)=>{const r=1-i.value*i.value*(1-e*e);if(r<0)return 0;const o=Math.sqrt(r);return i.value*t-(i.value*e+o)*s.value[n]})),n.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.round(e))),n.typeInfo);const s=n;return new Ve(Math.round(s.value),n.typeInfo)}Saturate(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.min(Math.max(e,0),1))),n.typeInfo);const s=n;return new Ve(Math.min(Math.max(s.value,0),1),n.typeInfo)}Sign(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.sign(e))),n.typeInfo);const s=n;return new Ve(Math.sign(s.value),n.typeInfo)}Sin(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.sin(e))),n.typeInfo);const s=n;return new Ve(Math.sin(s.value),n.typeInfo)}Sinh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.sinh(e))),n.typeInfo);const s=n;return new Ve(Math.sinh(s.value),n.typeInfo)}_smoothstep(e,t,n){const s=Math.min(Math.max((n-e)/(t-e),0),1);return s*s*(3-2*s)}SmoothStep(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(i instanceof Ue&&n instanceof Ue&&s instanceof Ue)return new Ue(i.value.map(((e,t)=>this._smoothstep(n.value[t],s.value[t],e))),i.typeInfo);const r=n,o=s,a=i;return new Ve(this._smoothstep(r.value,o.value,a.value),i.typeInfo)}Sqrt(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.sqrt(e))),n.typeInfo);const s=n;return new Ve(Math.sqrt(s.value),n.typeInfo)}Step(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(s instanceof Ue&&n instanceof Ue)return new Ue(s.value.map(((e,t)=>e<n.value[t]?0:1)),s.typeInfo);const i=n;return new Ve(s.value<i.value?0:1,i.typeInfo)}Tan(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.tan(e))),n.typeInfo);const s=n;return new Ve(Math.tan(s.value),n.typeInfo)}Tanh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.tanh(e))),n.typeInfo);const s=n;return new Ve(Math.tanh(s.value),n.typeInfo)}_getTransposeType(e){const t=this.exec.getTypeName(e);return'mat2x2f'===t||'mat2x2h'===t?e:'mat2x3f'===t?this.getTypeInfo('mat3x2f'):'mat2x3h'===t?this.getTypeInfo('mat3x2h'):'mat2x4f'===t?this.getTypeInfo('mat4x2f'):'mat2x4h'===t?this.getTypeInfo('mat4x2h'):'mat3x2f'===t?this.getTypeInfo('mat2x3f'):'mat3x2h'===t?this.getTypeInfo('mat2x3h'):'mat3x3f'===t||'mat3x3h'===t?e:'mat3x4f'===t?this.getTypeInfo('mat4x3f'):'mat3x4h'===t?this.getTypeInfo('mat4x3h'):'mat4x2f'===t?this.getTypeInfo('mat2x4f'):'mat4x2h'===t?this.getTypeInfo('mat2x4h'):'mat4x3f'===t?this.getTypeInfo('mat3x4f'):'mat4x3h'===t?this.getTypeInfo('mat3x4h'):('mat4x4f'===t||'mat4x4h'===t||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){const n=this.exec.evalExpression(e.args[0],t);if(!(n instanceof We))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;const s=this._getTransposeType(n.typeInfo);if('mat2x2'===n.typeInfo.name||'mat2x2f'===n.typeInfo.name||'mat2x2h'===n.typeInfo.name){const e=n.value;return new We([e[0],e[2],e[1],e[3]],s)}if('mat2x3'===n.typeInfo.name||'mat2x3f'===n.typeInfo.name||'mat2x3h'===n.typeInfo.name){const e=n.value;return new We([e[0],e[3],e[6],e[1],e[4],e[7]],s)}if('mat2x4'===n.typeInfo.name||'mat2x4f'===n.typeInfo.name||'mat2x4h'===n.typeInfo.name){const e=n.value;return new We([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13]],s)}if('mat3x2'===n.typeInfo.name||'mat3x2f'===n.typeInfo.name||'mat3x2h'===n.typeInfo.name){const e=n.value;return new We([e[0],e[3],e[1],e[4],e[2],e[5]],s)}if('mat3x3'===n.typeInfo.name||'mat3x3f'===n.typeInfo.name||'mat3x3h'===n.typeInfo.name){const e=n.value;return new We([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]],s)}if('mat3x4'===n.typeInfo.name||'mat3x4f'===n.typeInfo.name||'mat3x4h'===n.typeInfo.name){const e=n.value;return new We([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14]],s)}if('mat4x2'===n.typeInfo.name||'mat4x2f'===n.typeInfo.name||'mat4x2h'===n.typeInfo.name){const e=n.value;return new We([e[0],e[4],e[1],e[5],e[2],e[6]],s)}if('mat4x3'===n.typeInfo.name||'mat4x3f'===n.typeInfo.name||'mat4x3h'===n.typeInfo.name){const e=n.value;return new We([e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]],s)}if('mat4x4'===n.typeInfo.name||'mat4x4f'===n.typeInfo.name||'mat4x4h'===n.typeInfo.name){const e=n.value;return new We([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]],s)}return console.error(`Invalid matrix type ${n.typeInfo.name}`),null}Trunc(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ue)return new Ue(n.value.map((e=>Math.trunc(e))),n.typeInfo);const s=n;return new Ve(Math.trunc(s.value),n.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error('TODO: dpdxFine'),null}Dpdy(e,t){return console.error('TODO: dpdy'),null}DpdyCoarse(e,t){return console.error('TODO: dpdyCoarse'),null}DpdyFine(e,t){return console.error('TODO: dpdyFine'),null}Fwidth(e,t){return console.error('TODO: fwidth'),null}FwidthCoarse(e,t){return console.error('TODO: fwidthCoarse'),null}FwidthFine(e,t){return console.error('TODO: fwidthFine'),null}TextureDimensions(e,t){const n=e.args[0];if((e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0)>0)return console.error(`TODO: Mip levels. Line ${e.line}`),null;if(n instanceof we){const s=n.name,i=t.getVariableValue(s);return i instanceof Qe?new Ue(i.textureSize,this.getTypeInfo('vec2u')):(console.error(`Texture ${s} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error('TODO: textureGather'),null}TextureGatherCompare(e,t){return console.error('TODO: textureGatherCompare'),null}TextureLoad(e,t){const n=e.args[0],s=this.exec.evalExpression(e.args[1],t);if((e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0)>0)return console.error(`TODO: Mip levels. Line ${e.line}`),null;if(!(s instanceof Ue)||2!==s.value.length)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(n instanceof we){const i=n.name,r=t.getVariableValue(i);if(r instanceof Qe){const t=r.textureSize,n=Math.floor(s.value[0]),o=Math.floor(s.value[1]);if(n<0||n>=t[0]||o<0||o>=t[1])return console.error(`Texture ${i} out of bounds. Line ${e.line}`),null;const a=4*(o*t[0]+n),l=new Uint8Array(r.buffer,a,4);return new Ue([l[0]/255,l[1]/255,l[2]/255,l[3]/255],this.getTypeInfo('vec4f'))}return console.error(`Texture ${i} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){return console.error('TODO: textureNumLayers'),null}TextureNumLevels(e,t){return console.error('TODO: textureNumLevels'),null}TextureNumSamples(e,t){return console.error('TODO: textureNumSamples'),null}TextureSample(e,t){return console.error('TODO: textureSample'),null}TextureSampleBias(e,t){return console.error('TODO: textureSampleBias'),null}TextureSampleCompare(e,t){return console.error('TODO: textureSampleCompare'),null}TextureSampleCompareLevel(e,t){return console.error('TODO: textureSampleCompareLevel'),null}TextureSampleGrad(e,t){return console.error('TODO: textureSampleGrad'),null}TextureSampleLevel(e,t){return console.error('TODO: textureSampleLevel'),null}TextureSampleBaseClampToEdge(e,t){return console.error('TODO: textureSampleBaseClampToEdge'),null}TextureStore(e,t){const n=e.args[0],s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t).value;if(4!==i.length)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(s instanceof Ue)||2!==s.value.length)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(n instanceof we){const r=n.name,o=t.getVariableValue(r);if(o instanceof Qe){const t=o.textureSize,n=Math.floor(s.value[0]),a=Math.floor(s.value[1]);if(n<0||n>=t[0]||a<0||a>=t[1])return console.error(`Texture ${r} out of bounds. Line ${e.line}`),null;const l=4*(a*t[0]+n),c=new Uint8Array(o.buffer,l,4);return c[0]=255*i[0],c[1]=255*i[1],c[2]=255*i[2],c[3]=255*i[3],null}return console.error(`Texture ${r} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let n=e.args[0];n instanceof $e&&(n=n.right);const s=this.exec.getVariableName(n,t);return t.getVariable(s).value.getDataValue(this.exec,n.postfix,t)}AtomicStore(e,t){let n=e.args[0];n instanceof $e&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t);return a instanceof Ve&&o instanceof Ve&&(a.value=o.value),i.value instanceof Qe&&i.value.setDataValue(this.exec,a,n.postfix,t),null}AtomicAdd(e,t){let n=e.args[0];n instanceof $e&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t);return a instanceof Ve&&o instanceof Ve&&(a.value+=o.value),i.value instanceof Qe&&i.value.setDataValue(this.exec,a,n.postfix,t),null}AtomicSub(e,t){let n=e.args[0];n instanceof $e&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t);return a instanceof Ve&&o instanceof Ve&&(a.value-=o.value),i.value instanceof Qe&&i.value.setDataValue(this.exec,a,n.postfix,t),null}AtomicMax(e,t){let n=e.args[0];n instanceof $e&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t),l=new Ve(a.value,a.typeInfo);return a instanceof Ve&&o instanceof Ve&&(a.value=Math.max(a.value,o.value)),i.value instanceof Qe&&i.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicMin(e,t){let n=e.args[0];n instanceof $e&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t),l=new Ve(a.value,a.typeInfo);return a instanceof Ve&&o instanceof Ve&&(a.value=Math.min(a.value,o.value)),i.value instanceof Qe&&i.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicAnd(e,t){let n=e.args[0];n instanceof $e&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t),l=new Ve(a.value,a.typeInfo);return a instanceof Ve&&o instanceof Ve&&(a.value=a.value&o.value),i.value instanceof Qe&&i.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicOr(e,t){let n=e.args[0];n instanceof $e&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t),l=new Ve(a.value,a.typeInfo);return a instanceof Ve&&o instanceof Ve&&(a.value=a.value|o.value),i.value instanceof Qe&&i.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicXor(e,t){let n=e.args[0];n instanceof $e&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t),l=new Ve(a.value,a.typeInfo);return a instanceof Ve&&o instanceof Ve&&(a.value=a.value^o.value),i.value instanceof Qe&&i.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicExchange(e,t){let n=e.args[0];n instanceof $e&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t),l=new Ve(a.value,a.typeInfo);return a instanceof Ve&&o instanceof Ve&&(a.value=o.value),i.value instanceof Qe&&i.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicCompareExchangeWeak(e,t){return console.error('TODO: atomicCompareExchangeWeak'),null}Pack4x8snorm(e,t){return console.error('TODO: pack4x8snorm'),null}Pack4x8unorm(e,t){return console.error('TODO: pack4x8unorm'),null}Pack4xI8(e,t){return console.error('TODO: pack4xI8'),null}Pack4xU8(e,t){return console.error('TODO: pack4xU8'),null}Pack4x8Clamp(e,t){return console.error('TODO: pack4x8Clamp'),null}Pack4xU8Clamp(e,t){return console.error('TODO: pack4xU8Clamp'),null}Pack2x16snorm(e,t){return console.error('TODO: pack2x16snorm'),null}Pack2x16unorm(e,t){return console.error('TODO: pack2x16unorm'),null}Pack2x16float(e,t){return console.error('TODO: pack2x16float'),null}Unpack4x8snorm(e,t){return console.error('TODO: unpack4x8snorm'),null}Unpack4x8unorm(e,t){return console.error('TODO: unpack4x8unorm'),null}Unpack4xI8(e,t){return console.error('TODO: unpack4xI8'),null}Unpack4xU8(e,t){return console.error('TODO: unpack4xU8'),null}Unpack2x16snorm(e,t){return console.error('TODO: unpack2x16snorm'),null}Unpack2x16unorm(e,t){return console.error('TODO: unpack2x16unorm'),null}Unpack2x16float(e,t){return console.error('TODO: unpack2x16float'),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error('TODO: subgroupAdd'),null}SubgroupExclusiveAdd(e,t){return console.error('TODO: subgroupExclusiveAdd'),null}SubgroupInclusiveAdd(e,t){return console.error('TODO: subgroupInclusiveAdd'),null}SubgroupAll(e,t){return console.error('TODO: subgroupAll'),null}SubgroupAnd(e,t){return console.error('TODO: subgroupAnd'),null}SubgroupAny(e,t){return console.error('TODO: subgroupAny'),null}SubgroupBallot(e,t){return console.error('TODO: subgroupBallot'),null}SubgroupBroadcast(e,t){return console.error('TODO: subgroupBroadcast'),null}SubgroupBroadcastFirst(e,t){return console.error('TODO: subgroupBroadcastFirst'),null}SubgroupElect(e,t){return console.error('TODO: subgroupElect'),null}SubgroupMax(e,t){return console.error('TODO: subgroupMax'),null}SubgroupMin(e,t){return console.error('TODO: subgroupMin'),null}SubgroupMul(e,t){return console.error('TODO: subgroupMul'),null}SubgroupExclusiveMul(e,t){return console.error('TODO: subgroupExclusiveMul'),null}SubgroupInclusiveMul(e,t){return console.error('TODO: subgroupInclusiveMul'),null}SubgroupOr(e,t){return console.error('TODO: subgroupOr'),null}SubgroupShuffle(e,t){return console.error('TODO: subgroupShuffle'),null}SubgroupShuffleDown(e,t){return console.error('TODO: subgroupShuffleDown'),null}SubgroupShuffleUp(e,t){return console.error('TODO: subgroupShuffleUp'),null}SubgroupShuffleXor(e,t){return console.error('TODO: subgroupShuffleXor'),null}SubgroupXor(e,t){return console.error('TODO: subgroupXor'),null}QuadBroadcast(e,t){return console.error('TODO: quadBroadcast'),null}QuadSwapDiagonal(e,t){return console.error('TODO: quadSwapDiagonal'),null}QuadSwapX(e,t){return console.error('TODO: quadSwapX'),null}QuadSwapY(e,t){return console.error('TODO: quadSwapY'),null}}function st(e){return Array.isArray(e)||(null==e?void 0:e.buffer)instanceof ArrayBuffer}const it=new Float32Array(1),rt=new Uint32Array(it.buffer),ot=new Uint32Array(it.buffer),at=new Int32Array(1),lt=new Float32Array(at.buffer),ct=new Uint32Array(at.buffer),ht=new Uint32Array(1),ut=new Float32Array(ht.buffer),dt=new Int32Array(ht.buffer);function ft(e,t,n){if(t===n)return e;if('f32'===t){if('i32'===n||'x32'===n)return it[0]=e,rt[0];if('u32'===n)return it[0]=e,ot[0]}else if('i32'===t||'x32'===t){if('f32'===n)return at[0]=e,lt[0];if('u32'===n)return at[0]=e,ct[0]}else if('u32'===t){if('f32'===n)return ht[0]=e,ut[0];if('i32'===n||'x32'===n)return ht[0]=e,dt[0]}return console.error(`Unsupported cast from ${t} to ${n}`),e}class pt extends tt{constructor(e,t){var n;super(),this.ast=null!=e?e:[],this.reflection=new Ke,this.reflection.updateAST(this.ast),this.context=null!==(n=null==t?void 0:t.clone())&&void 0!==n?n:new et,this.builtins=new nt(this),this.typeInfo={bool:this.getTypeInfo(de.bool),i32:this.getTypeInfo(de.i32),u32:this.getTypeInfo(de.u32),f32:this.getTypeInfo(de.f32),f16:this.getTypeInfo(de.f16),vec2f:this.getTypeInfo(pe.vec2f),vec2u:this.getTypeInfo(pe.vec2u),vec2i:this.getTypeInfo(pe.vec2i),vec2h:this.getTypeInfo(pe.vec2h),vec3f:this.getTypeInfo(pe.vec3f),vec3u:this.getTypeInfo(pe.vec3u),vec3i:this.getTypeInfo(pe.vec3i),vec3h:this.getTypeInfo(pe.vec3h),vec4f:this.getTypeInfo(pe.vec4f),vec4u:this.getTypeInfo(pe.vec4u),vec4i:this.getTypeInfo(pe.vec4i),vec4h:this.getTypeInfo(pe.vec4h),mat2x2f:this.getTypeInfo(pe.mat2x2f),mat2x3f:this.getTypeInfo(pe.mat2x3f),mat2x4f:this.getTypeInfo(pe.mat2x4f),mat3x2f:this.getTypeInfo(pe.mat3x2f),mat3x3f:this.getTypeInfo(pe.mat3x3f),mat3x4f:this.getTypeInfo(pe.mat3x4f),mat4x2f:this.getTypeInfo(pe.mat4x2f),mat4x3f:this.getTypeInfo(pe.mat4x3f),mat4x4f:this.getTypeInfo(pe.mat4x4f)}}getVariableValue(e){var t,n;const s=null!==(n=null===(t=this.context.getVariable(e))||void 0===t?void 0:t.value)&&void 0!==n?n:null;return null===s?null:s instanceof Ve||s instanceof Ue||s instanceof We?s.value:(console.error(`Unsupported return variable type ${s.typeInfo.name}`),null)}execute(e){(e=null!=e?e:{}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,n,s){const i=this.context.clone();(s=null!=s?s:{}).constants&&this._setOverrides(s.constants,i),this._execStatements(this.ast,i);const r=i.functions.get(e);if(!r)return void console.error(`Function ${e} not found`);if('number'==typeof t)t=[t,1,1];else{if(0===t.length)return void console.error('Invalid dispatch count');1===t.length?t=[t[0],1,1]:2===t.length?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}const o=t[0],a=t[1],l=t[2],c=this.getTypeInfo('vec3u');i.setVariable('@num_workgroups',new Ue(t,c));for(const e in n)for(const t in n[e]){const s=n[e][t];i.variables.forEach((n=>{const i=n.node;if(null==i?void 0:i.attributes){let r=null,o=null;for(const e of i.attributes)'binding'===e.name?r=e.value:'group'===e.name&&(o=e.value);t==r&&e==o&&(void 0!==s.texture&&void 0!==s.size?n.value=new Qe(s.texture,this.getTypeInfo(i.type),0,s.size):void 0!==s.uniform?n.value=new Qe(s.uniform,this.getTypeInfo(i.type)):n.value=new Qe(s,this.getTypeInfo(i.type)))}}))}for(let e=0;e<l;++e)for(let t=0;t<a;++t)for(let n=0;n<o;++n)i.setVariable('@workgroup_id',new Ue([n,t,e],this.getTypeInfo('vec3u'))),this._dispatchWorkgroup(r,[n,t,e],i)}execStatement(e,t){if(e instanceof ie)return this.evalExpression(e.value,t);if(e instanceof he){if(e.condition){const n=this.evalExpression(e.condition,t);if(!(n instanceof Ve))throw new Error('Invalid break-if condition');if(!n.value)return null}return pt._breakObj}if(e instanceof ue)return pt._continueObj;if(e instanceof Y)this._let(e,t);else if(e instanceof q)this._var(e,t);else if(e instanceof K)this._const(e,t);else if(e instanceof W)this._function(e,t);else{if(e instanceof se)return this._if(e,t);if(e instanceof G)return this._for(e,t);if(e instanceof j)return this._while(e,t);if(e instanceof te)return this._loop(e,t);if(e instanceof X){const n=t.clone();return n.currentFunctionName=t.currentFunctionName,this._execStatements(e.body,n)}if(e instanceof J)this._assign(e,t);else if(e instanceof Z)this._increment(e,t);else{if(e instanceof fe)return null;if(e instanceof H){const n=e.name;null===t.getVariable(n)&&console.error(`Override constant ${n} not found. Line ${e.line}`)}else if(e instanceof ee)this._call(e,t);else{if(e instanceof ae)return null;if(e instanceof le)return null;console.error('Invalid statement type.',e,`Line ${e.line}`)}}}return null}evalExpression(e,t){for(;e instanceof Te;)e=e.contents[0];return e instanceof Ae?this._evalBinaryOp(e,t):e instanceof Oe?this._evalLiteral(e,t):e instanceof we?this._evalVariable(e,t):e instanceof _e?this._evalCall(e,t):e instanceof ye?this._evalCreate(e,t):e instanceof ke?this._evalConst(e,t):e instanceof Se?this._evalBitcast(e,t):e instanceof $e?this._evalUnaryOp(e,t):(console.error('Invalid expression type',e,`Line ${e.line}`),null)}getTypeInfo(e){var t;if(e instanceof de){const t=this.reflection.getTypeInfo(e);if(null!==t)return t}const n=null!==(t=this.typeInfo[e])&&void 0!==t?t:null;return null!==n?n:null}getTypeName(e){if(null===e)return console.error('Type is null.'),'unknown';let t=e.name;if(e instanceof O||e instanceof pe)if(null!==e.format){if('vec2'===t||'vec3'===t||'vec4'===t||'mat2x2'===t||'mat2x3'===t||'mat2x4'===t||'mat3x2'===t||'mat3x3'===t||'mat3x4'===t||'mat4x2'===t||'mat4x3'===t||'mat4x4'===t){if('f32'===e.format.name)return t+='f',t;if('i32'===e.format.name)return t+='i',t;if('u32'===e.format.name)return t+='u',t;if('bool'===e.format.name)return t+='b',t;if('f16'===e.format.name)return t+='h',t}t+=`<${e.format.name}>`}else if('vec2'===t||'vec3'===t||'vec4'===t)return t;return t}_setOverrides(e,t){for(const n in e){const s=e[n],i=this.reflection.getOverrideInfo(n);null!==i?'u32'===i.type.name||'i32'===i.type.name||'f32'===i.type.name||'f16'===i.type.name?t.setVariable(n,new Ve(s,i.type)):'bool'===i.type.name?t.setVariable(n,new Ve(s?1:0,i.type)):'vec2'===i.type.name||'vec3'===i.type.name||'vec4'===i.type.name||'vec2f'===i.type.name||'vec3f'===i.type.name||'vec4f'===i.type.name||'vec2i'===i.type.name||'vec3i'===i.type.name||'vec4i'===i.type.name||'vec2u'===i.type.name||'vec3u'===i.type.name||'vec4u'===i.type.name||'vec2h'===i.type.name||'vec3h'===i.type.name||'vec4h'===i.type.name?t.setVariable(n,new Ue(s,i.type)):console.error(`Invalid constant type for ${n}`):console.error(`Override ${n} does not exist in the shader.`)}}_dispatchWorkgroup(e,t,n){const s=[1,1,1];for(const t of e.node.attributes)if('workgroup_size'===t.name){if(t.value.length>0){const e=n.getVariableValue(t.value[0]);s[0]=e instanceof Ve?e.value:parseInt(t.value[0])}if(t.value.length>1){const e=n.getVariableValue(t.value[1]);s[1]=e instanceof Ve?e.value:parseInt(t.value[1])}if(t.value.length>2){const e=n.getVariableValue(t.value[2]);s[2]=e instanceof Ve?e.value:parseInt(t.value[2])}}const i=this.getTypeInfo('vec3u'),r=this.getTypeInfo('u32');n.setVariable('@workgroup_size',new Ue(s,i));const o=s[0],a=s[1],l=s[2];for(let c=0,h=0;c<l;++c)for(let l=0;l<a;++l)for(let a=0;a<o;++a,++h){const o=[a,l,c],u=[a+t[0]*s[0],l+t[1]*s[1],c+t[2]*s[2]];n.setVariable('@local_invocation_id',new Ue(o,i)),n.setVariable('@global_invocation_id',new Ue(u,i)),n.setVariable('@local_invocation_index',new Ve(h,r)),this._dispatchExec(e,n)}}_dispatchExec(e,t){for(const n of e.node.args)for(const e of n.attributes)if('builtin'===e.name){const s=`@${e.value}`,i=t.getVariable(s);void 0!==i&&t.variables.set(n.name,i)}this._execStatements(e.node.body,t)}getVariableName(e,t){return e instanceof we?e.name:(console.error('Unknown variable type',e,'Line',e.line),null)}_execStatements(e,t){for(const n of e){if(n instanceof Array){const e=t.clone(),s=this._execStatements(n,e);if(s)return s;continue}const e=this.execStatement(n,t);if(e)return e}return null}_call(e,t){const n=t.clone();n.currentFunctionName=e.name;const s=t.functions.get(e.name);if(s){for(let t=0;t<s.node.args.length;++t){const i=s.node.args[t],r=this.evalExpression(e.args[t],n);n.setVariable(i.name,r,i)}this._execStatements(s.node.body,n)}else this._callBuiltinFunction(e,n)}_increment(e,t){const n=this.getVariableName(e.variable,t),s=t.getVariable(n);s?'++'===e.operator?s.value instanceof Ve?s.value.value++:console.error(`Variable ${n} is not a scalar. Line ${e.line}`):'--'===e.operator?s.value instanceof Ve?s.value.value--:console.error(`Variable ${n} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${n} not found. Line ${e.line}`)}_assign(e,t){const n=this.getVariableName(e.variable,t),s=t.getVariable(n);if(null===s)return void console.error(`Variable ${n} not found. Line ${e.line}`);const i=this.evalExpression(e.value,t),r=e.operator;if('='===r)if(s.value instanceof Qe)s.value.setDataValue(this,i,e.variable.postfix,t);else if(e.variable.postfix){if(!(s.value instanceof Ue||s.value instanceof We))return void console.error(`Variable ${s.name} is not a vector or matrix. Line ${e.line}`);if(e.variable.postfix instanceof Ie){const n=this.evalExpression(e.variable.postfix.index,t).value;if(s.value instanceof Ue){if(!(i instanceof Ve))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[n]=i.value}else{if(!(s.value instanceof We))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);{const n=this.evalExpression(e.variable.postfix.index,t).value;if(n<0)return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);if(!(i instanceof Ue))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);{const t=this.getTypeName(s.value.typeInfo);if('mat2x2'===t||'mat2x2f'===t||'mat2x2h'===t){if(!(n<2&&2===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[2*n]=i.value[0],s.value.value[2*n+1]=i.value[1]}else if('mat2x3'===t||'mat2x3f'===t||'mat2x3h'===t){if(!(n<2&&3===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[3*n]=i.value[0],s.value.value[3*n+1]=i.value[1],s.value.value[3*n+2]=i.value[2]}else if('mat2x4'===t||'mat2x4f'===t||'mat2x4h'===t){if(!(n<2&&4===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[4*n]=i.value[0],s.value.value[4*n+1]=i.value[1],s.value.value[4*n+2]=i.value[2],s.value.value[4*n+3]=i.value[3]}else if('mat3x2'===t||'mat3x2f'===t||'mat3x2h'===t){if(!(n<3&&2===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[2*n]=i.value[0],s.value.value[2*n+1]=i.value[1]}else if('mat3x3'===t||'mat3x3f'===t||'mat3x3h'===t){if(!(n<3&&3===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[3*n]=i.value[0],s.value.value[3*n+1]=i.value[1],s.value.value[3*n+2]=i.value[2]}else if('mat3x4'===t||'mat3x4f'===t||'mat3x4h'===t){if(!(n<3&&4===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[4*n]=i.value[0],s.value.value[4*n+1]=i.value[1],s.value.value[4*n+2]=i.value[2],s.value.value[4*n+3]=i.value[3]}else if('mat4x2'===t||'mat4x2f'===t||'mat4x2h'===t){if(!(n<4&&2===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[2*n]=i.value[0],s.value.value[2*n+1]=i.value[1]}else if('mat4x3'===t||'mat4x3f'===t||'mat4x3h'===t){if(!(n<4&&3===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[3*n]=i.value[0],s.value.value[3*n+1]=i.value[1],s.value.value[3*n+2]=i.value[2]}else{if('mat4x4'!==t&&'mat4x4f'!==t&&'mat4x4h'!==t)return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);if(!(n<4&&4===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[4*n]=i.value[0],s.value.value[4*n+1]=i.value[1],s.value.value[4*n+2]=i.value[2],s.value.value[4*n+3]=i.value[3]}}}}}else if(e.variable.postfix instanceof be){const t=e.variable.postfix.value;if(!(s.value instanceof Ue))return void console.error(`Invalid assignment to ${t}. Variable ${s.name} is not a vector. Line ${e.line}`);if(i instanceof Ve){if(t.length>1)return void console.error(`Invalid assignment to ${t} for variable ${s.name}. Line ${e.line}`);if('x'===t)s.value.value[0]=i.value;else if('y'===t){if(s.value.value.length<2)return void console.error(`Invalid assignment to ${t} for variable ${s.name}. Line ${e.line}`);s.value.value[1]=i.value}else if('z'===t){if(s.value.value.length<3)return void console.error(`Invalid assignment to ${t} for variable ${s.name}. Line ${e.line}`);s.value.value[2]=i.value}else if('w'===t){if(s.value.value.length<4)return void console.error(`Invalid assignment to ${t} for variable ${s.name}. Line ${e.line}`);s.value.value[3]=i.value}}else{if(!(i instanceof Ue))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);if(t.length!==i.value.length)return void console.error(`Invalid assignment to ${t} for variable ${s.name}. Line ${e.line}`);for(let n=0;n<t.length;++n){const r=t[n];if('x'===r||'r'===r)s.value.value[0]=i.value[n];else if('y'===r||'g'===r){if(i.value.length<2)return void console.error(`Invalid assignment to ${r} for variable ${s.name}. Line ${e.line}`);s.value.value[1]=i.value[n]}else if('z'===r||'b'===r){if(i.value.length<3)return void console.error(`Invalid assignment to ${r} for variable ${s.name}. Line ${e.line}`);s.value.value[2]=i.value[n]}else{if('w'!==r&&'a'!==r)return void console.error(`Invalid assignment to ${r} for variable ${s.name}. Line ${e.line}`);if(i.value.length<4)return void console.error(`Invalid assignment to ${r} for variable ${s.name}. Line ${e.line}`);s.value.value[3]=i.value[n]}}}}}else s.value=i;else{const n=s.value.getDataValue(this,e.variable.postfix,t);if(n instanceof Ue&&i instanceof Ve){const t=n.value,s=i.value;if('+='===r)for(let e=0;e<t.length;++e)t[e]+=s;else if('-='===r)for(let e=0;e<t.length;++e)t[e]-=s;else if('*='===r)for(let e=0;e<t.length;++e)t[e]*=s;else if('/='===r)for(let e=0;e<t.length;++e)t[e]/=s;else if('%='===r)for(let e=0;e<t.length;++e)t[e]%=s;else if('&='===r)for(let e=0;e<t.length;++e)t[e]&=s;else if('|='===r)for(let e=0;e<t.length;++e)t[e]|=s;else if('^='===r)for(let e=0;e<t.length;++e)t[e]^=s;else if('<<='===r)for(let e=0;e<t.length;++e)t[e]<<=s;else if('>>='===r)for(let e=0;e<t.length;++e)t[e]>>=s;else console.error(`Invalid operator ${r}. Line ${e.line}`)}else if(n instanceof Ue&&i instanceof Ue){const t=n.value,s=i.value;if(t.length!==s.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if('+='===r)for(let e=0;e<t.length;++e)t[e]+=s[e];else if('-='===r)for(let e=0;e<t.length;++e)t[e]-=s[e];else if('*='===r)for(let e=0;e<t.length;++e)t[e]*=s[e];else if('/='===r)for(let e=0;e<t.length;++e)t[e]/=s[e];else if('%='===r)for(let e=0;e<t.length;++e)t[e]%=s[e];else if('&='===r)for(let e=0;e<t.length;++e)t[e]&=s[e];else if('|='===r)for(let e=0;e<t.length;++e)t[e]|=s[e];else if('^='===r)for(let e=0;e<t.length;++e)t[e]^=s[e];else if('<<='===r)for(let e=0;e<t.length;++e)t[e]<<=s[e];else if('>>='===r)for(let e=0;e<t.length;++e)t[e]>>=s[e];else console.error(`Invalid operator ${r}. Line ${e.line}`)}else{if(!(n instanceof Ve&&i instanceof Ve))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);'+='===r?n.value+=i.value:'-='===r?n.value-=i.value:'*='===r?n.value*=i.value:'/='===r?n.value/=i.value:'%='===r?n.value%=i.value:'&='===r?n.value&=i.value:'|='===r?n.value|=i.value:'^='===r?n.value^=i.value:'<<='===r?n.value<<=i.value:'>>='===r?n.value>>=i.value:console.error(`Invalid operator ${r}. Line ${e.line}`)}s.value instanceof Qe&&s.value.setDataValue(this,n,e.variable.postfix,t)}}_function(e,t){const n=new Je(e);t.functions.set(e.name,n)}_const(e,t){let n=null;null!=e.value&&(n=this.evalExpression(e.value,t)),t.createVariable(e.name,n,e)}_let(e,t){let n=null;null!=e.value&&(n=this.evalExpression(e.value,t)),t.createVariable(e.name,n,e)}_var(e,t){let n=null;if(null!==e.value)n=this.evalExpression(e.value,t);else{if(null===e.type)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);if('f32'===e.type.name||'i32'===e.type.name||'u32'===e.type.name||'bool'===e.type.name||'f16'===e.type.name||'vec2'===e.type.name||'vec3'===e.type.name||'vec4'===e.type.name||'vec2f'===e.type.name||'vec3f'===e.type.name||'vec4f'===e.type.name||'vec2i'===e.type.name||'vec3i'===e.type.name||'vec4i'===e.type.name||'vec2u'===e.type.name||'vec3u'===e.type.name||'vec4u'===e.type.name||'vec2h'===e.type.name||'vec3h'===e.type.name||'vec4h'===e.type.name||'mat2x2'===e.type.name||'mat2x3'===e.type.name||'mat2x4'===e.type.name||'mat3x2'===e.type.name||'mat3x3'===e.type.name||'mat3x4'===e.type.name||'mat4x2'===e.type.name||'mat4x3'===e.type.name||'mat4x4'===e.type.name||'mat2x2f'===e.type.name||'mat2x3f'===e.type.name||'mat2x4f'===e.type.name||'mat3x2f'===e.type.name||'mat3x3f'===e.type.name||'mat3x4f'===e.type.name||'mat4x2f'===e.type.name||'mat4x3f'===e.type.name||'mat4x4f'===e.type.name||'mat2x2h'===e.type.name||'mat2x3h'===e.type.name||'mat2x4h'===e.type.name||'mat3x2h'===e.type.name||'mat3x3h'===e.type.name||'mat3x4h'===e.type.name||'mat4x2h'===e.type.name||'mat4x3h'===e.type.name||'mat4x4h'===e.type.name){const s=new ye(e.type,[]);n=this._evalCreate(s,t)}if('array'===e.type.name){const s=new ye(e.type,[]);n=this._evalCreate(s,t)}}t.createVariable(e.name,n,e)}_if(e,t){t=t.clone();const n=this.evalExpression(e.condition,t);if(!(n instanceof Ve))return console.error(`Invalid if condition. Line ${e.line}`),null;if(n.value)return this._execStatements(e.body,t);for(const n of e.elseif){const s=this.evalExpression(n.condition,t);if(!(s instanceof Ve))return console.error(`Invalid if condition. Line ${e.line}`),null;if(s.value)return this._execStatements(n.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof Ve?e.value:(console.error('Expected scalar value.',e),0)}_for(e,t){for(t=t.clone(),this.execStatement(e.init,t);this._getScalarValue(this.evalExpression(e.condition,t));){const n=this._execStatements(e.body,t);if(n===pt._breakObj)break;if(null!==n&&n!==pt._continueObj)return n;this.execStatement(e.increment,t)}return null}_loop(e,t){for(t=t.clone();;){const n=this._execStatements(e.body,t);if(n===pt._breakObj)break;if(n===pt._continueObj){if(e.continuing){if(this._execStatements(e.continuing.body,t)===pt._breakObj)break}}else if(null!==n)return n}return null}_while(e,t){for(t=t.clone();this._getScalarValue(this.evalExpression(e.condition,t));){const n=this._execStatements(e.body,t);if(n===pt._breakObj)break;if(n!==pt._continueObj&&null!==n)return n}return null}_evalBitcast(e,t){const n=this.evalExpression(e.value,t),s=e.type;if(n instanceof Ve){const e=ft(n.value,n.typeInfo.name,s.name);return new Ve(e,this.getTypeInfo(s))}if(n instanceof Ue){const t=this.getTypeName(n.typeInfo);let i='';if(t.endsWith('f'))i='f32';else if(t.endsWith('i'))i='i32';else if(t.endsWith('u'))i='u32';else if(t.endsWith('b'))i='bool';else{if(!t.endsWith('h'))return console.error(`Unknown vector type ${t}. Line ${e.line}`),null;i='f16'}const r=this.getTypeName(s);let o='';if(r.endsWith('f'))o='f32';else if(r.endsWith('i'))o='i32';else if(r.endsWith('u'))o='u32';else if(r.endsWith('b'))o='bool';else{if(!r.endsWith('h'))return console.error(`Unknown vector type ${o}. Line ${e.line}`),null;o='f16'}const a=function(e,t,n){if(t===n)return e;const s=new Array(e.length);for(let i=0;i<e.length;i++)s[i]=ft(e[i],t,n);return s}(n.value,i,o);return new Ue(a,this.getTypeInfo(s))}return console.error(`TODO: bitcast for ${n.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){const n=t.getVariableValue(e.name);return e.postfix?n.getDataValue(this,e.postfix,t):n}_evalCreate(e,t){var n;if(null===e.type)return Fe.void;const s=this.getTypeName(e.type);switch(s){case'bool':case'i32':case'u32':case'f32':case'f16':return this._callConstructorValue(e,t);case'vec2':case'vec3':case'vec4':case'vec2f':case'vec3f':case'vec4f':case'vec2h':case'vec3h':case'vec4h':case'vec2i':case'vec3i':case'vec4i':case'vec2u':case'vec3u':case'vec4u':case'vec2b':case'vec3b':case'vec4b':return this._callConstructorVec(e,t);case'mat2x2':case'mat2x2f':case'mat2x2h':case'mat2x3':case'mat2x3f':case'mat2x3h':case'mat2x4':case'mat2x4f':case'mat2x4h':case'mat3x2':case'mat3x2f':case'mat3x2h':case'mat3x3':case'mat3x3f':case'mat3x3h':case'mat3x4':case'mat3x4f':case'mat3x4h':case'mat4x2':case'mat4x2f':case'mat4x2h':case'mat4x3':case'mat4x3f':case'mat4x3h':case'mat4x4':case'mat4x4f':case'mat4x4h':return this._callConstructorMatrix(e,t)}const i=this.getTypeInfo(e.type);if(null===i)return console.error(`Unknown type ${s}. Line ${e.line}`),null;if(0===i.size)return null;const r=new Qe(new ArrayBuffer(i.size),i,0);if(i instanceof w){if(e.args)for(let n=0;n<e.args.length;++n){const s=i.members[n],o=e.args[n],a=this.evalExpression(o,t);r.setData(this,a,s.type,s.offset,t)}}else if(i instanceof k){let s=0;if(e.args)for(let o=0;o<e.args.length;++o){const a=e.args[o],l=this.evalExpression(a,t);null===i.format&&('x32'===(null===(n=l.typeInfo)||void 0===n?void 0:n.name)?i.format=this.getTypeInfo('i32'):i.format=l.typeInfo),r.setData(this,l,i.format,s,t),s+=i.stride}}else console.error(`Unknown type "${s}". Line ${e.line}`);return r}_evalLiteral(e,t){const n=this.getTypeInfo(e.type),s=n.name;if('x32'===s||'u32'===s||'f32'===s||'f16'===s||'i32'===s||'bool'===s){return new Ve(e.scalarValue,n)}return'vec2'===s||'vec3'===s||'vec4'===s||'vec2f'===s||'vec3f'===s||'vec4f'===s||'vec2h'===s||'vec3h'===s||'vec4h'===s||'vec2i'===s||'vec3i'===s||'vec4i'===s||'vec2u'===s||'vec3u'===s||'vec4u'===s?this._callConstructorVec(e,t):'mat2x2'===s||'mat2x3'===s||'mat2x4'===s||'mat3x2'===s||'mat3x3'===s||'mat3x4'===s||'mat4x2'===s||'mat4x3'===s||'mat4x4'===s||'mat2x2f'===s||'mat2x3f'===s||'mat2x4f'===s||'mat3x2f'===s||'mat3x3f'===s||'mat3x4f'===s||'mat4x2f'===s||'mat4x3f'===s||'mat4x4f'===s||'mat2x2h'===s||'mat2x3h'===s||'mat2x4h'===s||'mat3x2h'===s||'mat3x3h'===s||'mat3x4h'===s||'mat4x2h'===s||'mat4x3h'===s||'mat4x4h'===s?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){const n=t.getVariableValue(e.name);return null===n?n:(null==e?void 0:e.postfix)?n.getDataValue(this,e.postfix,t):n}_maxFormatTypeInfo(e){let t=e[0];if('f32'===t.name)return t;for(let n=1;n<e.length;++n){const s=pt._priority.get(t.name);pt._priority.get(e[n].name)<s&&(t=e[n])}return'x32'===t.name?this.getTypeInfo('i32'):t}_evalUnaryOp(e,t){const n=this.evalExpression(e.right,t),s=n instanceof Ve||n instanceof Ue?n.value:null;switch(e.operator){case'+':{if(st(s)){const e=s.map(((e,t)=>+e));return new Ue(e,n.typeInfo)}const e=s,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new Ve(+e,t)}case'-':{if(st(s)){const e=s.map(((e,t)=>-e));return new Ue(e,n.typeInfo)}const e=s,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new Ve(-e,t)}case'!':{if(st(s)){const e=s.map(((e,t)=>e?0:1));return new Ue(e,n.typeInfo)}const e=s,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new Ve(e?0:1,t)}case'~':{if(st(s)){const e=s.map(((e,t)=>~e));return new Ue(e,n.typeInfo)}const e=s,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new Ve(~e,t)}}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){const n=this.evalExpression(e.left,t),s=this.evalExpression(e.right,t),i=n instanceof Ve||n instanceof Ue||n instanceof We?n.value:null,r=s instanceof Ve||s instanceof Ue||s instanceof We?s.value:null;switch(e.operator){case'+':{if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e+s[t]));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t+e));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e+t));return new Ue(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Ve(t+o,a)}case'-':{if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e-s[t]));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t-e));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e-t));return new Ue(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Ve(t-o,a)}case'*':{if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e*s[t]));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t*e));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e*t));return new Ue(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Ve(t*o,a)}case'%':{if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e%s[t]));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t%e));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e%t));return new Ue(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Ve(t%o,a)}case'/':{if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e/s[t]));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t/e));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e/t));return new Ue(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Ve(t/o,a)}case'&':{if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e&s[t]));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t&e));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e&t));return new Ue(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Ve(t&o,a)}case'|':{if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e|s[t]));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t|e));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e|t));return new Ue(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Ve(t|o,a)}case'^':{if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e^s[t]));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t^e));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e^t));return new Ue(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Ve(t^o,a)}case'<<':{if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e<<s[t]));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t<<e));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e<<t));return new Ue(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Ve(t<<o,a)}case'>>':{if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e>>s[t]));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t>>e));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e>>t));return new Ue(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Ve(t>>o,a)}case'>':if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e>s[t]?1:0));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t>e?1:0));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e>t?1:0));return new Ue(t,s.typeInfo)}return new Ve(i>r?1:0,this.getTypeInfo('bool'));case'<':if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e<s[t]?1:0));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t<e?1:0));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e<t?1:0));return new Ue(t,s.typeInfo)}return new Ve(i<r?1:0,this.getTypeInfo('bool'));case'==':if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e===s[t]?1:0));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t==e?1:0));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e==t?1:0));return new Ue(t,s.typeInfo)}return new Ve(i===r?1:0,this.getTypeInfo('bool'));case'!=':if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e!==s[t]?1:0));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t!==e?1:0));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e!==t?1:0));return new Ue(t,s.typeInfo)}return new Ve(i!==r?1:0,this.getTypeInfo('bool'));case'>=':if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e>=s[t]?1:0));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t>=e?1:0));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e>=t?1:0));return new Ue(t,s.typeInfo)}return new Ve(i>=r?1:0,this.getTypeInfo('bool'));case'<=':if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e<=s[t]?1:0));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t<=e?1:0));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e<=t?1:0));return new Ue(t,s.typeInfo)}return new Ve(i<=r?1:0,this.getTypeInfo('bool'));case'&&':if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e&&s[t]?1:0));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t&&e?1:0));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e&&t?1:0));return new Ue(t,s.typeInfo)}return new Ve(i&&r?1:0,this.getTypeInfo('bool'));case'||':if(st(i)&&st(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e||s[t]?1:0));return new Ue(o,n.typeInfo)}if(st(i)){const e=r,t=i.map(((t,n)=>t||e?1:0));return new Ue(t,n.typeInfo)}if(st(r)){const e=i,t=r.map(((t,n)=>e||t?1:0));return new Ue(t,s.typeInfo)}return new Ve(i||r?1:0,this.getTypeInfo('bool'))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(null!==e.cachedReturnValue)return e.cachedReturnValue;const n=t.clone();n.currentFunctionName=e.name;const s=t.functions.get(e.name);if(!s)return this._callBuiltinFunction(e,n);for(let t=0;t<s.node.args.length;++t){const i=s.node.args[t],r=this.evalExpression(e.args[t],n);n.setVariable(i.name,r,i)}return this._execStatements(s.node.body,n)}_callBuiltinFunction(e,t){switch(e.name){case'all':return this.builtins.All(e,t);case'any':return this.builtins.Any(e,t);case'select':return this.builtins.Select(e,t);case'arrayLength':return this.builtins.ArrayLength(e,t);case'abs':return this.builtins.Abs(e,t);case'acos':return this.builtins.Acos(e,t);case'acosh':return this.builtins.Acosh(e,t);case'asin':return this.builtins.Asin(e,t);case'asinh':return this.builtins.Asinh(e,t);case'atan':return this.builtins.Atan(e,t);case'atanh':return this.builtins.Atanh(e,t);case'atan2':return this.builtins.Atan2(e,t);case'ceil':return this.builtins.Ceil(e,t);case'clamp':return this.builtins.Clamp(e,t);case'cos':return this.builtins.Cos(e,t);case'cosh':return this.builtins.Cosh(e,t);case'countLeadingZeros':return this.builtins.CountLeadingZeros(e,t);case'countOneBits':return this.builtins.CountOneBits(e,t);case'countTrailingZeros':return this.builtins.CountTrailingZeros(e,t);case'cross':return this.builtins.Cross(e,t);case'degrees':return this.builtins.Degrees(e,t);case'determinant':return this.builtins.Determinant(e,t);case'distance':return this.builtins.Distance(e,t);case'dot':return this.builtins.Dot(e,t);case'dot4U8Packed':return this.builtins.Dot4U8Packed(e,t);case'dot4I8Packed':return this.builtins.Dot4I8Packed(e,t);case'exp':return this.builtins.Exp(e,t);case'exp2':return this.builtins.Exp2(e,t);case'extractBits':return this.builtins.ExtractBits(e,t);case'faceForward':return this.builtins.FaceForward(e,t);case'firstLeadingBit':return this.builtins.FirstLeadingBit(e,t);case'firstTrailingBit':return this.builtins.FirstTrailingBit(e,t);case'floor':return this.builtins.Floor(e,t);case'fma':return this.builtins.Fma(e,t);case'fract':return this.builtins.Fract(e,t);case'frexp':return this.builtins.Frexp(e,t);case'insertBits':return this.builtins.InsertBits(e,t);case'inverseSqrt':return this.builtins.InverseSqrt(e,t);case'ldexp':return this.builtins.Ldexp(e,t);case'length':return this.builtins.Length(e,t);case'log':return this.builtins.Log(e,t);case'log2':return this.builtins.Log2(e,t);case'max':return this.builtins.Max(e,t);case'min':return this.builtins.Min(e,t);case'mix':return this.builtins.Mix(e,t);case'modf':return this.builtins.Modf(e,t);case'normalize':return this.builtins.Normalize(e,t);case'pow':return this.builtins.Pow(e,t);case'quantizeToF16':return this.builtins.QuantizeToF16(e,t);case'radians':return this.builtins.Radians(e,t);case'reflect':return this.builtins.Reflect(e,t);case'refract':return this.builtins.Refract(e,t);case'reverseBits':return this.builtins.ReverseBits(e,t);case'round':return this.builtins.Round(e,t);case'saturate':return this.builtins.Saturate(e,t);case'sign':return this.builtins.Sign(e,t);case'sin':return this.builtins.Sin(e,t);case'sinh':return this.builtins.Sinh(e,t);case'smoothStep':return this.builtins.SmoothStep(e,t);case'sqrt':return this.builtins.Sqrt(e,t);case'step':return this.builtins.Step(e,t);case'tan':return this.builtins.Tan(e,t);case'tanh':return this.builtins.Tanh(e,t);case'transpose':return this.builtins.Transpose(e,t);case'trunc':return this.builtins.Trunc(e,t);case'dpdx':return this.builtins.Dpdx(e,t);case'dpdxCoarse':return this.builtins.DpdxCoarse(e,t);case'dpdxFine':return this.builtins.DpdxFine(e,t);case'dpdy':return this.builtins.Dpdy(e,t);case'dpdyCoarse':return this.builtins.DpdyCoarse(e,t);case'dpdyFine':return this.builtins.DpdyFine(e,t);case'fwidth':return this.builtins.Fwidth(e,t);case'fwidthCoarse':return this.builtins.FwidthCoarse(e,t);case'fwidthFine':return this.builtins.FwidthFine(e,t);case'textureDimensions':return this.builtins.TextureDimensions(e,t);case'textureGather':return this.builtins.TextureGather(e,t);case'textureGatherCompare':return this.builtins.TextureGatherCompare(e,t);case'textureLoad':return this.builtins.TextureLoad(e,t);case'textureNumLayers':return this.builtins.TextureNumLayers(e,t);case'textureNumLevels':return this.builtins.TextureNumLevels(e,t);case'textureNumSamples':return this.builtins.TextureNumSamples(e,t);case'textureSample':return this.builtins.TextureSample(e,t);case'textureSampleBias':return this.builtins.TextureSampleBias(e,t);case'textureSampleCompare':return this.builtins.TextureSampleCompare(e,t);case'textureSampleCompareLevel':return this.builtins.TextureSampleCompareLevel(e,t);case'textureSampleGrad':return this.builtins.TextureSampleGrad(e,t);case'textureSampleLevel':return this.builtins.TextureSampleLevel(e,t);case'textureSampleBaseClampToEdge':return this.builtins.TextureSampleBaseClampToEdge(e,t);case'textureStore':return this.builtins.TextureStore(e,t);case'atomicLoad':return this.builtins.AtomicLoad(e,t);case'atomicStore':return this.builtins.AtomicStore(e,t);case'atomicAdd':return this.builtins.AtomicAdd(e,t);case'atomicSub':return this.builtins.AtomicSub(e,t);case'atomicMax':return this.builtins.AtomicMax(e,t);case'atomicMin':return this.builtins.AtomicMin(e,t);case'atomicAnd':return this.builtins.AtomicAnd(e,t);case'atomicOr':return this.builtins.AtomicOr(e,t);case'atomicXor':return this.builtins.AtomicXor(e,t);case'atomicExchange':return this.builtins.AtomicExchange(e,t);case'atomicCompareExchangeWeak':return this.builtins.AtomicCompareExchangeWeak(e,t);case'pack4x8snorm':return this.builtins.Pack4x8snorm(e,t);case'pack4x8unorm':return this.builtins.Pack4x8unorm(e,t);case'pack4xI8':return this.builtins.Pack4xI8(e,t);case'pack4xU8':return this.builtins.Pack4xU8(e,t);case'pack4x8Clamp':return this.builtins.Pack4x8Clamp(e,t);case'pack4xU8Clamp':return this.builtins.Pack4xU8Clamp(e,t);case'pack2x16snorm':return this.builtins.Pack2x16snorm(e,t);case'pack2x16unorm':return this.builtins.Pack2x16unorm(e,t);case'pack2x16float':return this.builtins.Pack2x16float(e,t);case'unpack4x8snorm':return this.builtins.Unpack4x8snorm(e,t);case'unpack4x8unorm':return this.builtins.Unpack4x8unorm(e,t);case'unpack4xI8':return this.builtins.Unpack4xI8(e,t);case'unpack4xU8':return this.builtins.Unpack4xU8(e,t);case'unpack2x16snorm':return this.builtins.Unpack2x16snorm(e,t);case'unpack2x16unorm':return this.builtins.Unpack2x16unorm(e,t);case'unpack2x16float':return this.builtins.Unpack2x16float(e,t);case'storageBarrier':return this.builtins.StorageBarrier(e,t);case'textureBarrier':return this.builtins.TextureBarrier(e,t);case'workgroupBarrier':return this.builtins.WorkgroupBarrier(e,t);case'workgroupUniformLoad':return this.builtins.WorkgroupUniformLoad(e,t);case'subgroupAdd':return this.builtins.SubgroupAdd(e,t);case'subgroupExclusiveAdd':return this.builtins.SubgroupExclusiveAdd(e,t);case'subgroupInclusiveAdd':return this.builtins.SubgroupInclusiveAdd(e,t);case'subgroupAll':return this.builtins.SubgroupAll(e,t);case'subgroupAnd':return this.builtins.SubgroupAnd(e,t);case'subgroupAny':return this.builtins.SubgroupAny(e,t);case'subgroupBallot':return this.builtins.SubgroupBallot(e,t);case'subgroupBroadcast':return this.builtins.SubgroupBroadcast(e,t);case'subgroupBroadcastFirst':return this.builtins.SubgroupBroadcastFirst(e,t);case'subgroupElect':return this.builtins.SubgroupElect(e,t);case'subgroupMax':return this.builtins.SubgroupMax(e,t);case'subgroupMin':return this.builtins.SubgroupMin(e,t);case'subgroupMul':return this.builtins.SubgroupMul(e,t);case'subgroupExclusiveMul':return this.builtins.SubgroupExclusiveMul(e,t);case'subgroupInclusiveMul':return this.builtins.SubgroupInclusiveMul(e,t);case'subgroupOr':return this.builtins.SubgroupOr(e,t);case'subgroupShuffle':return this.builtins.SubgroupShuffle(e,t);case'subgroupShuffleDown':return this.builtins.SubgroupShuffleDown(e,t);case'subgroupShuffleUp':return this.builtins.SubgroupShuffleUp(e,t);case'subgroupShuffleXor':return this.builtins.SubgroupShuffleXor(e,t);case'subgroupXor':return this.builtins.SubgroupXor(e,t);case'quadBroadcast':return this.builtins.QuadBroadcast(e,t);case'quadSwapDiagonal':return this.builtins.QuadSwapDiagonal(e,t);case'quadSwapX':return this.builtins.QuadSwapX(e,t);case'quadSwapY':return this.builtins.QuadSwapY(e,t)}const n=t.getFunction(e.name);if(n){const s=t.clone();for(let t=0;t<n.node.args.length;++t){const i=n.node.args[t],r=this.evalExpression(e.args[t],s);s.setVariable(i.name,r,i)}return this._execStatements(n.node.body,s)}return null}_callConstructorValue(e,t){if(!e.args||0===e.args.length)return new Ve(0,this.getTypeInfo(e.type));const n=this.evalExpression(e.args[0],t);return n.typeInfo=this.getTypeInfo(e.type),n}_callConstructorVec(e,t){const n=this.getTypeInfo(e.type),s=this.getTypeName(e.type),i={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4}[s];if(void 0===i)return console.error(`Invalid vec constructor ${s}. Line ${e.line}`),null;const r=s.endsWith('i')||s.endsWith('u'),o=[];if(e instanceof Oe)if(e.isVector){const t=e.vectorValue;for(const e of t)o.push(e)}else o.push(e.scalarValue);else if(e.args)for(const n of e.args){const e=this.evalExpression(n,t);if(e instanceof Ue){const t=e.value;for(let e=0;e<t.length;++e){let n=t[e];r&&(n=Math.floor(n)),o.push(n)}}else if(e instanceof Ve){let t=e.value;r&&(t=Math.floor(t)),o.push(t)}}if(e.type instanceof pe&&null===e.type.format&&(e.type.format=pe.f32),0===o.length){const e=new Array(i).fill(0);return new Ue(e,n)}if(1===o.length)for(;o.length<i;)o.push(o[0]);return o.length<i?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new Ue(o.length>i?o.slice(0,i):o,n)}_callConstructorMatrix(e,t){const n=this.getTypeInfo(e.type),s=this.getTypeName(e.type),i={mat2x2:4,mat2x2f:4,mat2x2h:4,mat2x3:6,mat2x3f:6,mat2x3h:6,mat2x4:8,mat2x4f:8,mat2x4h:8,mat3x2:6,mat3x2f:6,mat3x2h:6,mat3x3:9,mat3x3f:9,mat3x3h:9,mat3x4:12,mat3x4f:12,mat3x4h:12,mat4x2:8,mat4x2f:8,mat4x2h:8,mat4x3:12,mat4x3f:12,mat4x3h:12,mat4x4:16,mat4x4f:16,mat4x4h:16}[s];if(void 0===i)return console.error(`Invalid matrix constructor ${s}. Line ${e.line}`),null;const r=[];if(e instanceof Oe)if(e.isVector){const t=e.vectorValue;for(const e of t)r.push(e)}else r.push(e.scalarValue);else if(e.args)for(const n of e.args){const e=this.evalExpression(n,t);if(e instanceof Ue){const t=e.value;for(let e=0;e<t.length;++e)r.push(t[e])}else e instanceof Ve?r.push(e.value):e instanceof We&&r.push(...e.value)}if(n instanceof O&&null===n.format&&(n.format=this.getTypeInfo('f32')),0===r.length){const e=new Array(i).fill(0);return new We(e,n)}return r.length!==i?(console.error(`Invalid matrix constructor. Line ${e.line}`),null):new We(r,n)}}pt._breakObj=new Re(new y('BREAK',null)),pt._continueObj=new Re(new y('CONTINUE',null)),pt._priority=new Map([['f32',0],['f16',1],['u32',2],['i32',3],['x32',3]]);class mt{constructor(){this._tokens=[],this._current=0,this._currentLine=0,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new R,this._exec=new pt}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const e=this._global_decl_or_directive();if(!e)break;t.push(e)}if(this._deferArrayCountEval.length>0){for(const e of this._deferArrayCountEval){const t=e.arrayType,n=e.countNode;if(n instanceof we){const e=n.name,s=this._context.constants.get(e);if(s)try{const e=s.constEvaluate(this._exec);t.count=e}catch(e){}}}this._deferArrayCountEval.length=0}return t}_initialize(e){if(e)if('string'==typeof e){const t=new qe(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_updateNode(e,t){return e.line=null!=t?t:this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==Xe.eof}_match(e){if(e instanceof je)return!!this._check(e)&&(this._advance(),!0);for(let t=0,n=e.length;t<n;++t){const n=e[t];if(this._check(n))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const n=t.type;return-1!=e.indexOf(n)}return t.type==e}_advance(){var e,t;return this._currentLine=null!==(t=null===(e=this._peek())||void 0===e?void 0:e.line)&&void 0!==t?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(Xe.tokens.semicolon)&&!this._isAtEnd(););if(this._match(Xe.keywords.alias)){const e=this._type_alias();return this._consume(Xe.tokens.semicolon,'Expected \';\''),this._exec.reflection.updateAST([e]),e}if(this._match(Xe.keywords.diagnostic)){const e=this._diagnostic();return this._consume(Xe.tokens.semicolon,'Expected \';\''),this._exec.reflection.updateAST([e]),e}if(this._match(Xe.keywords.requires)){const e=this._requires_directive();return this._consume(Xe.tokens.semicolon,'Expected \';\''),this._exec.reflection.updateAST([e]),e}if(this._match(Xe.keywords.enable)){const e=this._enable_directive();return this._consume(Xe.tokens.semicolon,'Expected \';\''),this._exec.reflection.updateAST([e]),e}const e=this._attribute();if(this._check(Xe.keywords.var)){const t=this._global_variable_decl();return null!=t&&(t.attributes=e),this._consume(Xe.tokens.semicolon,'Expected \';\'.'),this._exec.reflection.updateAST([t]),t}if(this._check(Xe.keywords.override)){const t=this._override_variable_decl();return null!=t&&(t.attributes=e),this._consume(Xe.tokens.semicolon,'Expected \';\'.'),this._exec.reflection.updateAST([t]),t}if(this._check(Xe.keywords.let)){const t=this._global_let_decl();return null!=t&&(t.attributes=e),this._consume(Xe.tokens.semicolon,'Expected \';\'.'),this._exec.reflection.updateAST([t]),t}if(this._check(Xe.keywords.const)){const t=this._global_const_decl();return null!=t&&(t.attributes=e),this._consume(Xe.tokens.semicolon,'Expected \';\'.'),this._exec.reflection.updateAST([t]),t}if(this._check(Xe.keywords.struct)){const t=this._struct_decl();return null!=t&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(Xe.keywords.fn)){const t=this._function_decl();return null!=t&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(Xe.keywords.fn))return null;const e=this._currentLine,t=this._consume(Xe.tokens.ident,'Expected function name.').toString();this._consume(Xe.tokens.paren_left,'Expected \'(\' for function arguments.');const n=[];if(!this._check(Xe.tokens.paren_right))do{if(this._check(Xe.tokens.paren_right))break;const e=this._attribute(),t=this._consume(Xe.tokens.ident,'Expected argument name.').toString();this._consume(Xe.tokens.colon,'Expected \':\' for argument type.');const s=this._attribute(),i=this._type_decl();null!=i&&(i.attributes=s,n.push(this._updateNode(new Me(t,i,e))))}while(this._match(Xe.tokens.comma));this._consume(Xe.tokens.paren_right,'Expected \')\' after function arguments.');let s=null;if(this._match(Xe.tokens.arrow)){const e=this._attribute();s=this._type_decl(),null!=s&&(s.attributes=e)}const i=this._compound_statement(),r=this._currentLine;return this._updateNode(new W(t,n,s,i,e,r),e)}_compound_statement(){const e=[];for(this._consume(Xe.tokens.brace_left,'Expected \'{\' for block.');!this._check(Xe.tokens.brace_right);){const t=this._statement();null!==t&&e.push(t)}return this._consume(Xe.tokens.brace_right,'Expected \'}\' for block.'),e}_statement(){for(;this._match(Xe.tokens.semicolon)&&!this._isAtEnd(););if(this._check(Xe.tokens.attr)&&this._attribute(),this._check(Xe.keywords.if))return this._if_statement();if(this._check(Xe.keywords.switch))return this._switch_statement();if(this._check(Xe.keywords.loop))return this._loop_statement();if(this._check(Xe.keywords.for))return this._for_statement();if(this._check(Xe.keywords.while))return this._while_statement();if(this._check(Xe.keywords.continuing))return this._continuing_statement();if(this._check(Xe.keywords.static_assert))return this._static_assert_statement();if(this._check(Xe.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(Xe.keywords.return))e=this._return_statement();else if(this._check([Xe.keywords.var,Xe.keywords.let,Xe.keywords.const]))e=this._variable_statement();else if(this._match(Xe.keywords.discard))e=this._updateNode(new ce);else if(this._match(Xe.keywords.break)){const t=this._updateNode(new he);if(!(this._currentLoop.length>0))throw this._error(this._peek(),'Break statement must be inside a loop.');{const e=this._currentLoop[this._currentLoop.length-1];t.loopId=e.id}e=t,this._check(Xe.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression(),t.condition instanceof Te&&1===t.condition.contents.length&&(t.condition=t.condition.contents[0]))}else if(this._match(Xe.keywords.continue)){const t=this._updateNode(new ue);if(!(this._currentLoop.length>0))throw this._error(this._peek(),'Continue statement must be inside a loop.');{const e=this._currentLoop[this._currentLoop.length-1];t.loopId=e.id}e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return null!=e&&this._consume(Xe.tokens.semicolon,'Expected \';\' after statement.'),e}_static_assert_statement(){if(!this._match(Xe.keywords.static_assert))return null;const e=this._optional_paren_expression();return this._updateNode(new Q(e))}_while_statement(){if(!this._match(Xe.keywords.while))return null;const e=this._updateNode(new j(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(Xe.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){if(!this._match(Xe.keywords.continuing))return null;const e=this._compound_statement();return this._updateNode(new X(e))}_for_statement(){if(!this._match(Xe.keywords.for))return null;this._consume(Xe.tokens.paren_left,'Expected \'(\'.');const e=this._updateNode(new G(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(Xe.tokens.semicolon)?null:this._for_init(),this._consume(Xe.tokens.semicolon,'Expected \';\'.'),e.condition=this._check(Xe.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(Xe.tokens.semicolon,'Expected \';\'.'),e.increment=this._check(Xe.tokens.paren_right)?null:this._for_increment(),this._consume(Xe.tokens.paren_right,'Expected \')\'.'),this._check(Xe.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(Xe.keywords.var)){const e=this._variable_decl();if(null===e)throw this._error(this._peek(),'Variable declaration expected.');let t=null;return this._match(Xe.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new q(e.name,e.type,e.storage,e.access,t))}if(this._match(Xe.keywords.let)){const e=this._consume(Xe.tokens.ident,'Expected name for let.').toString();let t=null;if(this._match(Xe.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}this._consume(Xe.tokens.equal,'Expected \'=\' for let.');const n=this._short_circuit_or_expression();return this._updateNode(new Y(e,t,null,null,n))}if(this._match(Xe.keywords.const)){const e=this._consume(Xe.tokens.ident,'Expected name for const.').toString();let t=null;if(this._match(Xe.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}this._consume(Xe.tokens.equal,'Expected \'=\' for const.');const n=this._short_circuit_or_expression();return null===t&&n instanceof Oe&&(t=n.type),this._updateNode(new K(e,t,null,null,n))}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(null==t)return null;if(!this._check(Xe.increment_operators))return this._current=e,null;const n=this._consume(Xe.increment_operators,'Expected increment operator');return this._updateNode(new Z(n.type===Xe.tokens.plus_plus?T.increment:T.decrement,t))}_assignment_statement(){let e=null;if(this._check(Xe.tokens.brace_right))return null;let t=this._match(Xe.tokens.underscore);if(t||(e=this._unary_expression()),!t&&null==e)return null;const n=this._consume(Xe.assignment_operators,'Expected assignment operator.'),s=this._short_circuit_or_expression();return this._updateNode(new J(I.parse(n.lexeme),e,s))}_func_call_statement(){if(!this._check(Xe.tokens.ident))return null;const e=this._current,t=this._consume(Xe.tokens.ident,'Expected function name.'),n=this._argument_expression_list();return null===n?(this._current=e,null):this._updateNode(new ee(t.lexeme,n))}_loop_statement(){if(!this._match(Xe.keywords.loop))return null;this._check(Xe.tokens.attr)&&this._attribute(),this._consume(Xe.tokens.brace_left,'Expected \'{\' for loop.');const e=this._updateNode(new te([],null));this._currentLoop.push(e);let t=this._statement();for(;null!==t;){if(Array.isArray(t))for(let n of t)e.body.push(n);else e.body.push(t);if(t instanceof X){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(Xe.tokens.brace_right,'Expected \'}\' for loop.'),e}_switch_statement(){if(!this._match(Xe.keywords.switch))return null;const e=this._optional_paren_expression();this._check(Xe.tokens.attr)&&this._attribute(),this._consume(Xe.tokens.brace_left,'Expected \'{\' for switch.');const t=this._switch_body();if(null==t||0==t.length)throw this._error(this._previous(),'Expected \'case\' or \'default\'.');return this._consume(Xe.tokens.brace_right,'Expected \'}\' for switch.'),this._updateNode(new ne(e,t))}_switch_body(){const e=[];if(this._match(Xe.keywords.case)){const t=this._case_selectors();this._match(Xe.tokens.colon),this._check(Xe.tokens.attr)&&this._attribute(),this._consume(Xe.tokens.brace_left,'Exected \'{\' for switch case.');const n=this._case_body();this._consume(Xe.tokens.brace_right,'Exected \'}\' for switch case.'),e.push(this._updateNode(new Pe(t,n)))}if(this._match(Xe.keywords.default)){this._match(Xe.tokens.colon),this._check(Xe.tokens.attr)&&this._attribute(),this._consume(Xe.tokens.brace_left,'Exected \'{\' for switch default.');const t=this._case_body();this._consume(Xe.tokens.brace_right,'Exected \'}\' for switch default.'),e.push(this._updateNode(new De(t)))}if(this._check([Xe.keywords.default,Xe.keywords.case])){const t=this._switch_body();e.push(t[0])}return e}_case_selectors(){const e=[this._shift_expression()];for(;this._match(Xe.tokens.comma);)e.push(this._shift_expression());return e}_case_body(){if(this._match(Xe.keywords.fallthrough))return this._consume(Xe.tokens.semicolon,'Expected \';\''),[];let e=this._statement();if(null==e)return[];e instanceof Array||(e=[e]);const t=this._case_body();return 0==t.length?e:[...e,t[0]]}_if_statement(){if(!this._match(Xe.keywords.if))return null;const e=this._currentLine,t=this._optional_paren_expression();this._check(Xe.tokens.attr)&&this._attribute();const n=this._compound_statement();let s=[];this._match_elseif()&&(this._check(Xe.tokens.attr)&&this._attribute(),s=this._elseif_statement(s));let i=null;return this._match(Xe.keywords.else)&&(this._check(Xe.tokens.attr)&&this._attribute(),i=this._compound_statement()),this._updateNode(new se(t,n,s,i),e)}_match_elseif(){return this._tokens[this._current].type===Xe.keywords.else&&this._tokens[this._current+1].type===Xe.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),n=this._compound_statement();return e.push(this._updateNode(new Le(t,n))),this._match_elseif()&&(this._check(Xe.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(Xe.keywords.return))return null;const e=this._short_circuit_or_expression();return this._updateNode(new ie(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(Xe.tokens.or_or);)e=this._updateNode(new Ae(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(Xe.tokens.and_and);)e=this._updateNode(new Ae(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(Xe.tokens.or);)e=this._updateNode(new Ae(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(Xe.tokens.xor);)e=this._updateNode(new Ae(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(Xe.tokens.and);)e=this._updateNode(new Ae(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){const e=this._relational_expression();return this._match([Xe.tokens.equal_equal,Xe.tokens.not_equal])?this._updateNode(new Ae(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([Xe.tokens.less_than,Xe.tokens.greater_than,Xe.tokens.less_than_equal,Xe.tokens.greater_than_equal]);)e=this._updateNode(new Ae(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([Xe.tokens.shift_left,Xe.tokens.shift_right]);)e=this._updateNode(new Ae(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([Xe.tokens.plus,Xe.tokens.minus]);)e=this._updateNode(new Ae(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([Xe.tokens.star,Xe.tokens.forward_slash,Xe.tokens.modulo]);)e=this._updateNode(new Ae(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([Xe.tokens.minus,Xe.tokens.bang,Xe.tokens.tilde,Xe.tokens.star,Xe.tokens.and])?this._updateNode(new $e(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(Xe.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(Xe.tokens.bracket_right,'Expected \']\'.');const t=this._updateNode(new Ie(e)),n=this._postfix_expression();return n&&(t.postfix=n),t}if(this._match(Xe.tokens.period)){const e=this._consume(Xe.tokens.ident,'Expected member name.'),t=this._postfix_expression(),n=this._updateNode(new be(e.lexeme));return t&&(n.postfix=t),n}return null}_getStruct(e){if(this._context.aliases.has(e)){return this._context.aliases.get(e).type}if(this._context.structs.has(e)){return this._context.structs.get(e)}return null}_getType(e){const t=this._getStruct(e);if(null!==t)return t;switch(e){case'bool':return de.bool;case'i32':return de.i32;case'u32':return de.u32;case'f32':return de.f32;case'f16':return de.f16;case'vec2f':return pe.vec2f;case'vec3f':return pe.vec3f;case'vec4f':return pe.vec4f;case'vec2i':return pe.vec2i;case'vec3i':return pe.vec3i;case'vec4i':return pe.vec4i;case'vec2u':return pe.vec2u;case'vec3u':return pe.vec3u;case'vec4u':return pe.vec4u;case'vec2h':return pe.vec2h;case'vec3h':return pe.vec3h;case'vec4h':return pe.vec4h;case'mat2x2f':return pe.mat2x2f;case'mat2x3f':return pe.mat2x3f;case'mat2x4f':return pe.mat2x4f;case'mat3x2f':return pe.mat3x2f;case'mat3x3f':return pe.mat3x3f;case'mat3x4f':return pe.mat3x4f;case'mat4x2f':return pe.mat4x2f;case'mat4x3f':return pe.mat4x3f;case'mat4x4f':return pe.mat4x4f;case'mat2x2h':return pe.mat2x2h;case'mat2x3h':return pe.mat2x3h;case'mat2x4h':return pe.mat2x4h;case'mat3x2h':return pe.mat3x2h;case'mat3x3h':return pe.mat3x3h;case'mat3x4h':return pe.mat3x4h;case'mat4x2h':return pe.mat4x2h;case'mat4x3h':return pe.mat4x3h;case'mat4x4h':return pe.mat4x4h}return null}_validateTypeRange(e,t){if('i32'===t.name){if(e<-2147483648||e>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if('u32'===t.name&&(e<0||e>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(Xe.tokens.ident)){const e=this._previous().toString();if(this._check(Xe.tokens.paren_left)){const t=this._argument_expression_list(),n=this._getType(e);return null!==n?this._updateNode(new ye(n,t)):this._updateNode(new _e(e,t))}if(this._context.constants.has(e)){const t=this._context.constants.get(e);return this._updateNode(new ke(e,t.value))}return this._updateNode(new we(e))}if(this._match(Xe.tokens.int_literal)){const e=this._previous().toString();let t=e.endsWith('i')||e.endsWith('i')?de.i32:e.endsWith('u')||e.endsWith('U')?de.u32:de.x32;const n=parseInt(e);return this._validateTypeRange(n,t),this._updateNode(new Oe(new Ve(n,this._exec.getTypeInfo(t)),t))}if(this._match(Xe.tokens.uint_literal)){const e=parseInt(this._previous().toString());return this._validateTypeRange(e,de.u32),this._updateNode(new Oe(new Ve(e,this._exec.getTypeInfo(de.u32)),de.u32))}if(this._match([Xe.tokens.decimal_float_literal,Xe.tokens.hex_float_literal])){let e=this._previous().toString(),t=e.endsWith('h');t&&(e=e.substring(0,e.length-1));const n=parseFloat(e);this._validateTypeRange(n,t?de.f16:de.f32);const s=t?de.f16:de.f32;return this._updateNode(new Oe(new Ve(n,this._exec.getTypeInfo(s)),s))}if(this._match([Xe.keywords.true,Xe.keywords.false])){let e=this._previous().toString()===Xe.keywords.true.rule;return this._updateNode(new Oe(new Ve(e?1:0,this._exec.getTypeInfo(de.bool)),de.bool))}if(this._check(Xe.tokens.paren_left))return this._paren_expression();if(this._match(Xe.keywords.bitcast)){this._consume(Xe.tokens.less_than,'Expected \'<\'.');const e=this._type_decl();this._consume(Xe.tokens.greater_than,'Expected \'>\'.');const t=this._paren_expression();return this._updateNode(new Se(e,t))}const e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new ye(e,t))}_argument_expression_list(){if(!this._match(Xe.tokens.paren_left))return null;const e=[];do{if(this._check(Xe.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(Xe.tokens.comma));return this._consume(Xe.tokens.paren_right,'Expected \')\' for agument list'),e}_optional_paren_expression(){this._match(Xe.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(Xe.tokens.paren_right),this._updateNode(new Te([e]))}_paren_expression(){this._consume(Xe.tokens.paren_left,'Expected \'(\'.');const e=this._short_circuit_or_expression();return this._consume(Xe.tokens.paren_right,'Expected \')\'.'),this._updateNode(new Te([e]))}_struct_decl(){if(!this._match(Xe.keywords.struct))return null;const e=this._currentLine,t=this._consume(Xe.tokens.ident,'Expected name for struct.').toString();this._consume(Xe.tokens.brace_left,'Expected \'{\' for struct body.');const n=[];for(;!this._check(Xe.tokens.brace_right);){const e=this._attribute(),t=this._consume(Xe.tokens.ident,'Expected variable name.').toString();this._consume(Xe.tokens.colon,'Expected \':\' for struct member type.');const s=this._attribute(),i=this._type_decl();null!=i&&(i.attributes=s),this._check(Xe.tokens.brace_right)?this._match(Xe.tokens.comma):this._consume(Xe.tokens.comma,'Expected \',\' for struct member.'),n.push(this._updateNode(new Be(t,i,e)))}this._consume(Xe.tokens.brace_right,'Expected \'}\' after struct body.');const s=this._currentLine,i=this._updateNode(new fe(t,n,e,s),e);return this._context.structs.set(t,i),i}_global_variable_decl(){const e=this._variable_decl();if(!e)return null;if(this._match(Xe.tokens.equal)){const t=this._const_expression(),n=[de.f32];try{const s=t.constEvaluate(this._exec,n);e.value=new Oe(s,n[0]),this._exec.context.setVariable(e.name,s)}catch(n){e.value=t}}else{const t=new ye(e.type,null),n=this._exec.evalExpression(t,this._exec.context);null!==n&&(e.value=new Oe(n,e.type),this._exec.context.setVariable(e.name,n))}if(null!==e.type&&e.value instanceof Oe){if('x32'!==e.value.type.name&&e.type.name!==e.value.type.name)throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else null===e.type&&e.value instanceof Oe&&(e.type='x32'===e.value.type.name?de.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(Xe.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){var e;if(!this._match(Xe.keywords.const))return null;const t=this._consume(Xe.tokens.ident,'Expected variable name');let n=null;if(this._match(Xe.tokens.colon)){const e=this._attribute();n=this._type_decl(),null!=n&&(n.attributes=e)}let s=null;this._consume(Xe.tokens.equal,'const declarations require an assignment');const i=this._short_circuit_or_expression();try{let e=[de.f32];const n=i.constEvaluate(this._exec,e);n instanceof Ve&&this._validateTypeRange(n.value,e[0]),e[0]instanceof pe&&null===e[0].format&&n.typeInfo instanceof O&&null!==n.typeInfo.format&&('f16'===n.typeInfo.format.name?e[0].format=de.f16:'f32'===n.typeInfo.format.name?e[0].format=de.f32:'i32'===n.typeInfo.format.name?e[0].format=de.i32:'u32'===n.typeInfo.format.name?e[0].format=de.u32:'bool'===n.typeInfo.format.name?e[0].format=de.bool:console.error(`TODO: impelement template format type ${n.typeInfo.format.name}`)),s=this._updateNode(new Oe(n,e[0])),this._exec.context.setVariable(t.toString(),n)}catch(e){s=i}if(null!==n&&s instanceof Oe){if('x32'!==s.type.name&&n.name!==s.type.name)throw this._error(this._peek(),`Invalid cast from ${s.type.name} to ${n.name}. Line:${this._currentLine}`);s.type=n,this._validateTypeRange(s.scalarValue,s.type)}else null===n&&s instanceof Oe&&(n=null!==(e=null==s?void 0:s.type)&&void 0!==e?e:de.f32,n===de.x32&&(n=de.i32));const r=this._updateNode(new K(t.toString(),n,'','',s));return this._context.constants.set(r.name,r),r}_global_let_decl(){if(!this._match(Xe.keywords.let))return null;const e=this._consume(Xe.tokens.ident,'Expected variable name');let t=null;if(this._match(Xe.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}let n=null;if(this._match(Xe.tokens.equal)){n=this._const_expression();const e=[de.f32];try{const t=n.constEvaluate(this._exec,e);null!==t&&(n=new Oe(t,e[0]))}catch(e){}}if(null!==t&&n instanceof Oe){if('x32'!==n.type.name&&t.name!==n.type.name)throw this._error(this._peek(),`Invalid cast from ${n.type.name} to ${t.name}. Line:${this._currentLine}`);n.type=t}else null===t&&n instanceof Oe&&(t='x32'===n.type.name?de.i32:n.type);return n instanceof Oe&&n.isScalar&&this._validateTypeRange(n.scalarValue,t),this._updateNode(new Y(e.toString(),t,'','',n))}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(Xe.keywords.var))return null;let e='',t='';this._match(Xe.tokens.less_than)&&(e=this._consume(Xe.storage_class,'Expected storage_class.').toString(),this._match(Xe.tokens.comma)&&(t=this._consume(Xe.access_mode,'Expected access_mode.').toString()),this._consume(Xe.tokens.greater_than,'Expected \'>\'.'));const n=this._consume(Xe.tokens.ident,'Expected variable name');let s=null;if(this._match(Xe.tokens.colon)){const e=this._attribute();s=this._type_decl(),null!=s&&(s.attributes=e)}return this._updateNode(new q(n.toString(),s,e,t,null))}_override_decl(){if(!this._match(Xe.keywords.override))return null;const e=this._consume(Xe.tokens.ident,'Expected variable name');let t=null;if(this._match(Xe.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}return this._updateNode(new H(e.toString(),t,null))}_diagnostic(){this._consume(Xe.tokens.paren_left,'Expected \'(\'');const e=this._consume(Xe.tokens.ident,'Expected severity control name.');this._consume(Xe.tokens.comma,'Expected \',\'');let t=this._consume(Xe.tokens.ident,'Expected diagnostic rule name.').toString();if(this._match(Xe.tokens.period)){t+=`.${this._consume(Xe.tokens.ident,'Expected diagnostic message.').toString()}`}return this._consume(Xe.tokens.paren_right,'Expected \')\''),this._updateNode(new ae(e.toString(),t))}_enable_directive(){const e=this._consume(Xe.tokens.ident,'identity expected.');return this._updateNode(new re(e.toString()))}_requires_directive(){const e=[this._consume(Xe.tokens.ident,'identity expected.').toString()];for(;this._match(Xe.tokens.comma);){const t=this._consume(Xe.tokens.ident,'identity expected.');e.push(t.toString())}return this._updateNode(new oe(e))}_type_alias(){const e=this._consume(Xe.tokens.ident,'identity expected.');this._consume(Xe.tokens.equal,'Expected \'=\' for type alias.');let t=this._type_decl();if(null===t)throw this._error(this._peek(),'Expected Type for Alias.');this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const n=this._updateNode(new le(e.toString(),t));return this._context.aliases.set(n.name,n),n}_type_decl(){if(this._check([Xe.tokens.ident,...Xe.texel_format,Xe.keywords.bool,Xe.keywords.f32,Xe.keywords.i32,Xe.keywords.u32])){const e=this._advance(),t=e.toString();return this._context.structs.has(t)?this._context.structs.get(t):this._context.aliases.has(t)?this._context.aliases.get(t).type:this._updateNode(new de(e.toString()))}let e=this._texture_sampler_types();if(e)return e;if(this._check(Xe.template_types)){let e=this._advance().toString(),t=null,n=null;return this._match(Xe.tokens.less_than)&&(t=this._type_decl(),n=null,this._match(Xe.tokens.comma)&&(n=this._consume(Xe.access_mode,'Expected access_mode for pointer').toString()),this._consume(Xe.tokens.greater_than,'Expected \'>\' for type.')),this._updateNode(new pe(e,t,n))}if(this._match(Xe.keywords.ptr)){let e=this._previous().toString();this._consume(Xe.tokens.less_than,'Expected \'<\' for pointer.');const t=this._consume(Xe.storage_class,'Expected storage_class for pointer');this._consume(Xe.tokens.comma,'Expected \',\' for pointer.');const n=this._type_decl();let s=null;return this._match(Xe.tokens.comma)&&(s=this._consume(Xe.access_mode,'Expected access_mode for pointer').toString()),this._consume(Xe.tokens.greater_than,'Expected \'>\' for pointer.'),this._updateNode(new me(e,t.toString(),n,s))}const t=this._attribute();if(this._match(Xe.keywords.array)){let e=null,n=-1;const s=this._previous();let i=null;if(this._match(Xe.tokens.less_than)){e=this._type_decl(),this._context.aliases.has(e.name)&&(e=this._context.aliases.get(e.name).type);let t='';if(this._match(Xe.tokens.comma)){i=this._shift_expression();try{t=i.constEvaluate(this._exec).toString(),i=null}catch(e){t='1'}}this._consume(Xe.tokens.greater_than,'Expected \'>\' for array.'),n=t?parseInt(t):0}const r=this._updateNode(new ge(s.toString(),t,e,n));return i&&this._deferArrayCountEval.push({arrayType:r,countNode:i}),r}return null}_texture_sampler_types(){if(this._match(Xe.sampler_type))return this._updateNode(new ve(this._previous().toString(),null,null));if(this._match(Xe.depth_texture_type))return this._updateNode(new ve(this._previous().toString(),null,null));if(this._match(Xe.sampled_texture_type)||this._match(Xe.multisampled_texture_type)){const e=this._previous();this._consume(Xe.tokens.less_than,'Expected \'<\' for sampler type.');const t=this._type_decl();return this._consume(Xe.tokens.greater_than,'Expected \'>\' for sampler type.'),this._updateNode(new ve(e.toString(),t,null))}if(this._match(Xe.storage_texture_type)){const e=this._previous();this._consume(Xe.tokens.less_than,'Expected \'<\' for sampler type.');const t=this._consume(Xe.texel_format,'Invalid texel format.').toString();this._consume(Xe.tokens.comma,'Expected \',\' after texel format.');const n=this._consume(Xe.access_mode,'Expected access mode for storage texture type.').toString();return this._consume(Xe.tokens.greater_than,'Expected \'>\' for sampler type.'),this._updateNode(new ve(e.toString(),t,n))}return null}_attribute(){let e=[];for(;this._match(Xe.tokens.attr);){const t=this._consume(Xe.attribute_name,'Expected attribute name'),n=this._updateNode(new Ne(t.toString(),null));if(this._match(Xe.tokens.paren_left)){if(n.value=this._consume(Xe.literal_or_ident,'Expected attribute value').toString(),this._check(Xe.tokens.comma)){this._advance();do{const e=this._consume(Xe.literal_or_ident,'Expected attribute value').toString();n.value instanceof Array||(n.value=[n.value]),n.value.push(e)}while(this._match(Xe.tokens.comma))}this._consume(Xe.tokens.paren_right,'Expected \')\'')}e.push(n)}return 0==e.length?null:e}}class gt extends Ke{constructor(e){super(),e&&this.update(e)}update(e){const t=(new mt).parse(e);this.updateAST(t)}}class vt extends h{constructor(e,t,n){super(e,t,n),this._reflection=null,this.descriptor=t,this.hasVertexEntries=!!t?.code&&-1!=t.code.indexOf('@vertex'),this.hasFragmentEntries=!!t?.code&&-1!=t.code.indexOf('@fragment'),this.hasComputeEntries=!!t?.code&&-1!=t.code.indexOf('@compute'),this.replacementCode=null,this.isDestroyed=!1}get code(){return this.replacementCode??this.descriptor?.code??''}get reflection(){if(null===this._reflection)try{this._reflection=new gt(this.code)}catch(e){this._reflection=null}return this._reflection}}vt.className='ShaderModule';class xt extends h{constructor(e,t,n,s){super(e,n,s),this.descriptor=n,this.texture=t}}xt.className='TextureView';const bt={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},'rgba8unorm-srgb':{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},'bgra8unorm-srgb':{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:'depth32float',channels:1},'depth24plus-stencil8':{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:'depth32float',channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},'depth32float-stencil8':{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:'depth32float',channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},'bc1-rgba-unorm':{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'bc1-rgba-unorm-srgb':{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'bc2-rgba-unorm':{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'bc2-rgba-unorm-srgb':{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'bc3-rgba-unorm':{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'bc3-rgba-unorm-srgb':{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'bc4-r-unorm':{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},'bc4-r-snorm':{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},'bc5-rg-unorm':{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},'bc5-rg-snorm':{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},'bc6h-rgb-ufloat':{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'bc6h-rgb-float':{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'bc7-rgba-unorm':{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'bc7-rgba-unorm-srgb':{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'etc2-rgb8unorm':{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'etc2-rgb8unorm-srgb':{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'etc2-rgb8a1unorm':{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'etc2-rgb8a1unorm-srgb':{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'etc2-rgba8unorm':{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'etc2-rgba8unorm-srgb':{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'eac-r11unorm':{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},'eac-r11snorm':{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},'eac-rg11unorm':{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},'eac-rg11snorm':{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},'astc-4x4-unorm':{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'astc-4x4-unorm-srgb':{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},'astc-5x4-unorm':{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},'astc-5x4-unorm-srgb':{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},'astc-5x5-unorm':{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},'astc-5x5-unorm-srgb':{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},'astc-6x5-unorm':{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},'astc-6x5-unorm-srgb':{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},'astc-6x6-unorm':{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},'astc-6x6-unorm-srgb':{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},'astc-8x5-unorm':{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},'astc-8x5-unorm-srgb':{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},'astc-8x6-unorm':{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},'astc-8x6-unorm-srgb':{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},'astc-8x8-unorm':{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},'astc-8x8-unorm-srgb':{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},'astc-10x5-unorm':{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},'astc-10x5-unorm-srgb':{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},'astc-10x6-unorm':{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},'astc-10x6-unorm-srgb':{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},'astc-10x8-unorm':{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},'astc-10x8-unorm-srgb':{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},'astc-10x10-unorm':{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},'astc-10x10-unorm-srgb':{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},'astc-12x10-unorm':{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},'astc-12x10-unorm-srgb':{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},'astc-12x12-unorm':{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},'astc-12x12-unorm-srgb':{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}};const yt=new Uint32Array(1),_t=new Float32Array(yt.buffer,0,1);function wt(e){const t=112+(e>>6&31)<<23|(63&e)<<17;return yt[0]=t,_t[0]}class kt extends h{constructor(e,t,n){super(e,t,n),this.descriptor=t,this.imageData=null,this.loadedImageDataChunks=[],this.imageDataPending=!1,this.isImageDataLoaded=!1,this.gpuTexture=null,this._layerRanges=null,this.display={exposure:1,channels:0,minRnage:0,maxRange:1,mipLevel:0}}get layerRanges(){if(null===this._layerRanges){if(bt[this.format].isDepthStencil){const e=[],t=this.depthOrArrayLayers,n=this.width,s=this.height;for(let i=0;i<t;++i){let t=null,r=null;for(let e=0;e<s;++e)for(let s=0;s<n;++s){const n=this.getPixel(s,e,i);(null===t||n.r<t)&&(t=n.r),(null===r||n.r>r)&&(r=n.r)}e.push({min:t,max:r})}this._layerRanges=e}}return this._layerRanges}getPixel(e,t,n,s){function i(e,t,n,s){const i=[null,null,null,null];for(let c=0;c<s;++c)switch(n){case'8unorm':i[c]=e[t]/255,t++;break;case'8snorm':i[c]=e[t]/255*2-1,t++;break;case'8uint':i[c]=e[t],t++;break;case'8sint':i[c]=e[t]-127,t++;break;case'16uint':i[c]=e[t]|e[t+1]<<8,t+=2;break;case'16sint':i[c]=(e[t]|e[t+1]<<8)-32768,t+=2;break;case'16float':i[c]=(r=e[t]|e[t+1]<<8,o=void 0,a=void 0,l=void 0,o=(32768&r)>>15,l=1023&r,0==(a=(31744&r)>>10)?(o?-1:1)*Math.pow(2,-14)*(l/Math.pow(2,10)):31==a?l?NaN:1/0*(o?-1:1):(o?-1:1)*Math.pow(2,a-15)*(1+l/Math.pow(2,10))),t+=2;break;case'32uint':case'32sint':i[c]=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24,t+=4;break;case'32float':i[c]=new Float32Array(e.buffer,t,1)[0],t+=4}var r,o,a,l;return i}if(s??=0,s=Math.max(Math.min(s,this.mipLevelCount-1),0),this.imageData){const r=this.bytesPerRow>>s,o=n*r*(this.height>>s)+t*r+e*this.texelByteSize,a=this.imageData;switch(this.format){case'r8unorm':return{r:i(a,o,'8unorm',1)[0]};case'r8snorm':return{r:i(a,o,'8snorm',1)[0]};case'r8uint':return{r:i(a,o,'8uint',1)[0]};case'r8sint':return{r:i(a,o,'8sint',1)[0]};case'rg8unorm':{const e=i(a,o,'8unorm',2);return{r:e[0],g:e[1]}}case'rg8snorm':{const e=i(a,o,'8snorm',2);return{r:e[0],g:e[1]}}case'rg8uint':{const e=i(a,o,'8uint',2);return{r:e[0],g:e[1]}}case'rg8sint':{const e=i(a,o,'8sint',2);return{r:e[0],g:e[1]}}case'rgba8unorm-srgb':case'rgba8unorm':{const e=i(a,o,'8unorm',4);return{r:e[0],g:e[1],b:e[2],a:e[3]}}case'rgba8snorm':{const e=i(a,o,'8snorm',4);return{r:e[0],g:e[1],b:e[2],a:e[3]}}case'rgba8uint':{const e=i(a,o,'8uint',4);return{r:e[0],g:e[1],b:e[2],a:e[3]}}case'rgba8sint':{const e=i(a,o,'8sint',4);return{r:e[0],g:e[1],b:e[2],a:e[3]}}case'bgra8unorm-srgb':case'bgra8unorm':{const e=i(a,o,'8unorm',4);return{r:e[2],g:e[1],b:e[0],a:e[3]}}case'r16uint':return{r:i(a,o,'16uint',1)[0]};case'r16sint':return{r:i(a,o,'16sint',1)[0]};case'r16float':return{r:i(a,o,'16float',1)[0]};case'rg16uint':{const e=i(a,o,'16uint',2);return{r:e[0],g:e[1]}}case'rg16sint':{const e=i(a,o,'16sint',2);return{r:e[0],g:e[1]}}case'rg16float':{const e=i(a,o,'16float',2);return{r:e[0],g:e[1]}}case'rgba16uint':{const e=i(a,o,'16uint',4);return{r:e[0],g:e[1],b:e[2],a:e[3]}}case'rgba16sint':{const e=i(a,o,'16sint',4);return{r:e[0],g:e[1],b:e[2],a:e[3]}}case'rgba16float':{const e=i(a,o,'16float',4);return{r:e[0],g:e[1],b:e[2],a:e[3]}}case'r32uint':return{r:i(a,o,'32uint',1)[0]};case'r32sint':return{r:i(a,o,'32sint',1)[0]};case'depth16unorm':case'depth24plus':case'depth24plus-stencil8':case'depth32float':case'depth32float-stencil8':case'r32float':return{r:i(a,o,'32float',1)[0]};case'rg32uint':{const e=i(a,o,'32uint',2);return{r:e[0],g:e[1]}}case'rg32sint':{const e=i(a,o,'32sint',2);return{r:e[0],g:e[1]}}case'rg32float':{const e=i(a,o,'32float',2);return{r:e[0],g:e[1]}}case'rgba32uint':{const e=i(a,o,'32uint',4);return{r:e[0],g:e[1],b:e[2],a:e[3]}}case'rgba32sint':{const e=i(a,o,'32sint',4);return{r:e[0],g:e[1],b:e[2],a:e[3]}}case'rgba32float':{const e=i(a,o,'32float',4);return{r:e[0],g:e[1],b:e[2],a:e[3]}}case'rg11b10ufloat':{const e=new Uint32Array(a.buffer,o,1)[0],t=(4192256&e)>>11,n=(4290772992&e)>>22;return{r:wt(2047&e),g:wt(t),b:function(e){const t=112+(e>>5&31)<<23|(31&e)<<18;return yt[0]=t,_t[0]}(n),a:1}}}}return null}get format(){return this.descriptor?.format??'<unknown format>'}get dimension(){return this.descriptor?.dimension??'2d'}get width(){const e=this.descriptor?.size;return e instanceof Array&&e.length>0?e[0]??0:e instanceof Object?e.width??0:0}get height(){const e=this.descriptor?.size;return e instanceof Array&&e.length>1?e[1]??1:e instanceof Object?e.height??1:0}get depthOrArrayLayers(){const e=this.descriptor?.size;return e instanceof Array&&e.length>2?e[2]??1:e instanceof Object?e.depthOrArrayLayers??1:0}get mipLevelCount(){return this.descriptor?.mipLevelCount??1}getMipSize(e){const t=this.mipLevelCount;e=Math.max(Math.min(e,t-1),0);return[this.width>>e,this.height>>e,'3d'===this.dimension?this.depthOrArrayLayers>>e:this.depthOrArrayLayers]}get resolutionString(){const e=this.width,t=this.height,n=this.depthOrArrayLayers;return'1d'===this.dimension?n>1?`${e}x${n}`:`${e}`:n>1?`${e}x${t}x${n}`:`${e}x${t}`}get texelByteSize(){const e=this.descriptor?.format,t=bt[e];return t?t.isDepthStencil?4:t.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize+255&-256}get isDepthStencil(){const e=this.descriptor?.format,t=bt[e];return!!t&&t.isDepthStencil}getGpuSize(){const e=this.descriptor?.format,t=bt[e],n=this.width;if(!e||n<=0||!t)return-1;const s=this.height,i=this.depthOrArrayLayers,r=this.dimension;return n/t.blockWidth*('1d'===r?1:s/t.blockHeight)*t.bytesPerBlock*i}}kt.className='Texture';class Ot extends h{constructor(e,t,n,s){super(e,null,s),this.message=n,this.object=t??0}}Ot.className='ValidationError';class St extends h{constructor(e,t,n){super(e,n),this.descriptor=t,this.commands=[]}}St.className='RenderBundle';class Tt{constructor(e){this.port=e,this.frameTime=0,this.errorCount=0,this.allObjects=new Map,this.adapters=new Map,this.devices=new Map,this.samplers=new Map,this.textures=new Map,this.textureViews=new Map,this.buffers=new Map,this.bindGroups=new Map,this.bindGroupLayouts=new Map,this.shaderModules=new Map,this.pipelineLayouts=new Map,this.renderPipelines=new Map,this.computePipelines=new Map,this.renderBundles=new Map,this.pendingRenderPipelines=new Map,this.pendingComputePipelines=new Map,this.validationErrors=new Map,this.capturedObjects=new Map,this.inspectedObject=null,this.onDeleteObject=new l,this.onResolvePendingObject=new l,this.onAddObject=new l,this.onDeltaFrameTime=new l,this.onEndFrame=new l,this.onAdapterInfo=new l,this.onObjectLabelChanged=new l,this.onValidationError=new l,this.totalTextureMemory=0,this.totalBufferMemory=0,this.deltaFrameTime=-1;const n=this;e.addListener((e=>{switch(e.action){case t.DeltaTime:this.deltaFrameTime=e.deltaTime,this.onDeltaFrameTime.emit();break;case t.ValidationError:{const t=e.message,s=e.stacktrace,i=e.id??0;if(n.validationErrors.has(t))return;const r=new Ot(++n.errorCount,i,t,s);n.validationErrors.set(t,r),n.onValidationError.emit(r);break}case t.DeleteObject:n._deleteObject(e.id);break;case t.DeleteObjects:{const t=e.idList;for(const e of t)n._deleteObject(e);break}case t.ResolveAsyncObject:n._resolvePendingObject(e.id);break;case t.ObjectSetLabel:n._setObjectLabel(e.id,e.label);break;case t.AddObject:{const t=!!e.pending,s=e.id,i=e.parent,r=e.stacktrace??'';let o=null;try{o=e.descriptor?JSON.parse(e.descriptor):null}catch(e){break}switch(e.type){case'Adapter':{const e=new u(s,o,r);n._addObject(e,i,t);break}case'Device':{const e=new g(s,o,r);n._addObject(e,i,t);break}case'ShaderModule':{const e=new vt(s,o,r);n._addObject(e,i,t),e.size=o?.code?.length??0;break}case'Buffer':{const e=new p(s,o,r);n._addObject(e,i,t),e.size=o?.size??0,this.totalBufferMemory+=e.size;break}case'Texture':{const e=n.textures.get(s);if(e){let t=e.getGpuSize();return-1!=t&&(this.totalTextureMemory-=t),e.descriptor=o,t=e.getGpuSize(),void(-1!=t&&(this.totalTextureMemory+=t))}const a=new kt(s,o,r),l=a.getGpuSize();-1!=l&&(this.totalTextureMemory+=l),n._addObject(a,i,t);break}case'TextureView':{const e=n.textureViews.get(s);if(e)return void(e.descriptor=o);const a=new xt(s,i,o,r);n._addObject(a,i,t);break}case'Sampler':{const e=new b(s,o,r);n._addObject(e,i,t);break}case'BindGroup':{const e=new f(s,o,r);n._addObject(e,i,t);break}case'BindGroupLayout':{const e=new d(s,o,r);n._addObject(e,i,t);break}case'RenderPipeline':{const e=new x(s,o,r);n._addObject(e,i,t);break}case'ComputePipeline':{const e=new m(s,o,r);n._addObject(e,i,t);break}case'PipelineLayout':{const e=new v(s,o,r);n._addObject(e,i,t);break}case'RenderBundle':{const e=new St(s,o,r);n._addObject(e,i,t);break}}break}}}))}requestTextureData(e,t){e.imageDataPending||(e.imageDataPending=!0,this.port.postMessage({action:n,id:e.id,mipLevel:t??0}))}removeErrorsForObject(e){const t=this.validationErrors;for(const n of t.keys()){const s=t.get(n);s.object===e&&(t.delete(n),this.onDeleteObject.emit(e,s))}}findObjectErrors(e){const t=[];for(const n of this.validationErrors.values())n.object===e&&t.push(n);return t}_deleteOldRecycledObjects(e){const t=performance.now();for(let n=e.length-1;n>=0;--n){const s=e[n];(!s||t-s._deletionTime>200)&&(e=e.splice(n,1))}return e}reset(){this.allObjects=new Map,this.adapters=new Map,this.devices=new Map,this.samplers=new Map,this.textures=new Map,this.textureViews=new Map,this.buffers=new Map,this.bindGroups=new Map,this.bindGroupLayouts=new Map,this.shaderModules=new Map,this.pipelineLayouts=new Map,this.renderPipelines=new Map,this.computePipelines=new Map,this.renderBundles=new Map,this.pendingRenderPipelines=new Map,this.pendingComputePipelines=new Map,this.frameTime=0,this.totalTextureMemory=0,this.totalBufferMemory=0}getObjectDependencies(e){const t=[],n=e.id;if(e instanceof vt)this.renderPipelines.forEach((e=>{const s=e.descriptor;(s?.vertex?.module?.__id==n||s?.fragment?.module?.__id==n)&&t.push(e)})),this.computePipelines.forEach((e=>{const s=e.descriptor;s?.compute?.module?.__id==n&&t.push(e)}));else if(e instanceof p||e instanceof kt){const s=e instanceof kt;this.bindGroups.forEach((e=>{const i=e.descriptor?.entries;if(i)for(const r of i){const i=r.resource;if(s&&i.constructor===String){if(i.__id==n){t.push(e);break}}else if(i?.buffer){const n=i.buffer.__id;n==n&&t.push(e);break}}}))}return t}getObject(e){return null==e?null:this.inspectedObject?.id===e?this.inspectedObject:this.allObjects.get(e)||this.capturedObjects.get(e)}getTextureFromView(e){return e?(e.__texture||e.texture&&(e.__texture=this.getObject(e.texture)),e.__texture):null}clearCapturedObjects(){this.capturedObjects.forEach((e=>{e.decrementReferenceCount()})),this.capturedObjects.clear()}_setObjectLabel(e,t){const n=this.getObject(e);n&&(n.label=t,this.onObjectLabelChanged.emit(e,n,t))}_addObject(e,t,n){const s=e.id;if(this.allObjects.set(s,e),e instanceof u)this.adapters.set(s,e);else if(e instanceof g)this.devices.set(s,e);else if(e instanceof b)this.samplers.set(s,e);else if(e instanceof kt)this.textures.set(s,e);else if(e instanceof xt)this.textureViews.set(s,e),e.addDependency(this.getObject(e.texture.__id)),e.incrementDepenencyReferenceCount();else if(e instanceof p)this.buffers.set(s,e);else if(e instanceof f){this.bindGroups.set(s,e),e.addDependency(this.getObject(e.descriptor.layout.__id));for(const t of e.descriptor.entries)t.resource?.buffer?e.addDependency(this.getObject(t.resource.buffer.__id)):e.addDependency(this.getObject(t.resource.__id));e.incrementDepenencyReferenceCount()}else if(e instanceof d)this.bindGroupLayouts.set(s,e);else if(e instanceof v)this.pipelineLayouts.set(s,e);else if(e instanceof vt)this.shaderModules.set(s,e);else if(e instanceof x)n?this.pendingRenderPipelines.set(s,e):this.renderPipelines.set(s,e),e.addDependency(this.getObject(e.descriptor.layout.__id)),e.addDependency(this.getObject(e.descriptor.vertex?.module?.__id)),e.addDependency(this.getObject(e.descriptor.fragment?.module?.__id)),e.incrementDepenencyReferenceCount();else if(e instanceof m)this.computePipelines.set(s,e),e.addDependency(this.getObject(e.descriptor.compute?.module?.__id)),e.incrementDepenencyReferenceCount();else if(e instanceof St){this.renderBundles.set(s,e),e.commands=e.descriptor?.commands??[],e.descriptor?.commands&&delete e.descriptor.commands;for(const t of e.commands)t.object=e,'setPipeline'===t.method||'setVertexBuffer'===t.method||'setIndexBuffer'===t.method||'drawIndirect'===t.method||'drawIndexedIndirect'===t.method?e.addDependency(this.getObject(t.args[0].__id)):'setBindGroup'===t.method&&e.addDependency(this.getObject(t.args[1].__id));e.incrementDepenencyReferenceCount()}this.onAddObject.emit(e,n)}_resolvePendingObject(e){const t=this.allObjects.get(e);t instanceof x?(this.pendingRenderPipelines.delete(e),this.renderPipelines.set(e,t),this.onResolvePendingObject.emit(e,t)):t instanceof m&&(this.pendingComputePipelines.delete(e),this.computePipelines.set(e,t),this.onResolvePendingObject.emit(e,t))}_deleteObject(e){const t=this.allObjects.get(e);if(!t)return;const n=this;if(t.decrementReferenceCount((e=>{e!==t&&n._deleteObject(e.id)})),!(t.referenceCount>0)){if(t._deletionTime=performance.now(),t instanceof u)this.adapters.delete(e,t);else if(t instanceof g)this.devices.delete(e,t);else if(t instanceof b)this.samplers.delete(e,t);else if(t instanceof kt){this.textures.delete(e,t);const n=t.getGpuSize();-1!=n&&(this.totalTextureMemory-=n)}else if(t instanceof xt)this.textureViews.delete(e,t);else if(t instanceof p){this.buffers.delete(e,t);const n=t.size;this.totalBufferMemory-=n??0}else t instanceof f?this.bindGroups.delete(e,t):t instanceof d?this.bindGroupLayouts.delete(e,t):t instanceof v?this.pipelineLayouts.delete(e,t):t instanceof St?this.renderBundles.delete(e,t):t instanceof vt?(t.isDestroyed=!0,this.shaderModules.delete(e,t)):t instanceof x?(this.pendingRenderPipelines.delete(e,t),this.renderPipelines.delete(e,t)):t instanceof m&&(this.computePipelines.set(e,t),this.pendingComputePipelines.delete(e,t));this.allObjects.delete(e),this.onDeleteObject.emit(e,t)}}}class It{constructor(e,t,n){this.name=e,this.tabId=t??0,this.listeners=[],n&&this.listeners.push(n),this._port=null,this.reset()}reset(){const e=this;this._port=chrome.runtime.connect({name:this.name}),this._port.onDisconnect.addListener((()=>{e.reset()})),this._port.onMessage.addListener((t=>{for(const n of e.listeners)n(t)}))}addListener(e){this.listeners.push(e)}postMessage(e){e.__webgpuInspector=!0,this.tabId&&(e.tabId=this.tabId);try{this._port.postMessage(e)}catch(e){this.reset()}}}class Ct{constructor(e){this.event=e,this.pageX=e.pageX,this.pageY=e.pageY,this.clientX=e.clientX,this.clientY=e.clientY,this.id=e.pointerId,this.type=e.pointerType,this.buttons=e.buttons??-1}getCoalesced(){return this.event.getCoalescedEvents().map((e=>new Ct(e)))}}class $t{constructor(e,t,n){if(this.id=`${this.constructor.name}${$t.id++}`,e&&e.constructor===String&&(e=document.createElement(e)),this._element=e,e&&(this._element.id=this.id,this._element.title=''),t&&t.constructor===Object&&(n=t,t=null),this._parent=null,this.children=[],t)if(t.constructor.isLayout){const e=n&&n.stretch?n.stretch:0;t.add(this,e)}else this.parent=t;n&&this.configure(n),this._element&&(this._element.widget=this)}configure(e){if(e.id&&(this._element.id=e.id),e.class&&(e.class.constructor===String?this.classList.add(e.class):this.classList.add(...e.class)),void 0!==e.text&&(this.text=e.text),void 0!==e.html&&(this.html=e.html),void 0!==e.style&&(this._element.style=e.style),void 0!==e.title&&(this._element.title=e.title),void 0!==e.backgroundColor&&(this._element.style.backgroundColor=e.backgroundColor),void 0!==e.color&&(this._element.style.color=e.color),void 0!==e.type&&(this._element.type=e.type),void 0!==e.children)for(const t of e.children)this.appendChild(t);void 0!==e.disabled&&(this._element.disabled=e.disabled),void 0!==e.tabIndex&&(this._element.tabindex=e.tabindex),void 0!==e.zIndex&&(this._element.style.zIndex=String(e.zIndex)),void 0!==e.draggable&&(this.draggable=e.draggable),void 0!==e.onClick&&this.addEventListener('click',e.onClick),void 0!==e.data&&(this.data=e.data),void 0!==e.tooltip&&(this.tooltip=e.tooltip)}get element(){return this._element}get parent(){return this._parent}set parent(e){if(e)e.appendChild(this);else if(this._parent)return void this._parent.removeChild(this);this.onResize()}get lastChild(){return this.children[this.children.length-1]}insertBefore(e,t){const n=this.children.indexOf(t);-1!==n?(this.children.splice(n,0,e),this._element.insertBefore(e._element,t._element)):this.appendChild(e)}insertAfter(e,t){let n=this.children.indexOf(t);if(-1===n)return void this.appendChild(e);if(n++,n>=this.children.length)return void this.appendChild(e);const s=this.children[n];this.children.splice(n,0,e),this._element.insertBefore(e._element,s._element)}appendChild(e){if(e.parent===this)return;e.parent&&e.parent.removeChild(e),e._parent=this,this.children.push(e),this._element.appendChild(e._element);const t=this.window;t&&e._addedToWindow(t),e.onResize()}remove(){this.element.remove()}removeChild(e){const t=this.children.indexOf(e);-1!=t&&this.children.splice(t,1),e._parent=null,this._element.removeChild(e._element)}removeAllChildren(){for(const e of this.children)e._parent=null;for(this.children.length=0;this._element.firstChild;)this._element.removeChild(this._element.lastChild)}getPagePosition(){let e=0,t=0;for(let n=this._element;null!=n;n=n.offsetParent)e+=n.offsetLeft,t+=n.offsetTop;return[e,t]}static getCssValue(e){return e||(e='0px'),(e=e.endsWith('%')?e.substring(0,e.length-1):e.substring(0,e.length-2)).includes('.')?parseFloat(e):parseInt(e)}static getStyleSize(e,t,n,s){return $t.getCssValue(e[`${t}${n}`])+$t.getCssValue(e[`${t}${s}`])}get width(){return this._element.offsetWidth}get height(){return this._element.offsetHeight}getBoundingClientRect(){return this._element.getBoundingClientRect()}get visible(){let e=this;for(;e;){if('none'==e._element.style.display)return!1;e=e.parent}return!0}onDomChanged(){}domChanged(){this.onDomChanged();for(const e of this.children)e.domChanged()}get left(){return this._element?this._element.offsetLeft:0}get top(){return this._element?this._element.offsetTop:0}setPosition(e,t,n){n=n||'absolute',this._element.style.position=n,this._element.style.left=`${e}px`,this._element.style.top=`${t}px`}resize(e,t){const n=this.getBoundingClientRect(),s=this._element.offsetWidth-n.width,i=this._element.offsetHeight-n.height;this._element.style.width=e-s+'px',this._element.style.height=t-i+'px'}onResize(){for(const e of this.children)e.onResize()}get style(){return this._element.style}set style(e){this._element.style=e}get classList(){return this._element.classList}get text(){return this._element.innerText}set text(e){this._element.innerText=e}get textContent(){return this._element.textContent}set textContent(e){this._element.textContent=e}get html(){return this._element.innerHTML}set html(e){this._element.innerHTML=e}get title(){return this._element.title}set title(e){this._element.title=e}get tooltip(){return this._element.title}set tooltip(e){this._element.title=e}get disabled(){return this._element.disabled}set disabled(e){this._element.disabled=e}get dataset(){return this._element.dataset}get tabIndex(){return this._element.tabindex}set tabIndex(e){this._element.tabIndex=e}get zIndex(){return parseInt(this._element.style.zorder)}set zIndex(e){this._element.style.zorder=String(e)}get draggable(){return this._element.draggable}set draggable(e){this._element.draggable=e,e?(this._dragStartEvent=this.dragStartEvent.bind(this),this._dragEndEvent=this.dragEndEvent.bind(this),this._dragEvent=this.dragEvent.bind(this),this.addEventListener('drag',this._dragEvent),this.addEventListener('dragstart',this._dragStartEvent),this.addEventListener('dragend',this._dragEndEvent)):this._dragEvent&&(this.removeEventListener('drag',this._dragEvent),this.removeEventListener('dragstart',this._dragStartEvent),this.removeEventListener('dragend',this._dragEndEvent))}querySelector(){return this._element.querySelector(...arguments)}addEventListener(){return this._element.addEventListener(...arguments)}removeEventListener(){return this._element.removeEventListener(...arguments)}dispatchEvent(){return this._element.dispatchEvent(...arguments)}repaint(e=!0){if(this.paintEvent&&this.paintEvent(),e)for(const t of this.children)t.repaint(e)}_startResize(){this.startResize&&this.startResize();for(const e of this.children)e._startResize()}_addedToWindow(e){this.onAddedToWindow&&this.onAddedToWindow(e);for(const t of this.children)t._addedToWindow(e)}get window(){return $t.window}enableMouseEvents(){!this._mouseDownEnabled&&this._element&&(this._mouseDownEnabled=!0,this._element.addEventListener('mousedown',this._onMouseDown.bind(this))),!this._mouseMoveEnabled&&this._element&&(this.__mouseMoveEnabled=!0,this._element.addEventListener('mousemove',this._onMouseMove.bind(this))),!this._mouseUpEnabled&&this._element&&(this._mouseUpEnabled=!0,this._element.addEventListener('mouseup',this._onMouseUp.bind(this)))}enableMouseMoveEvent(){!this._mouseMoveEnabled&&this._element&&(this.__mouseMoveEnabled=!0,this._element.addEventListener('mousemove',this._onMouseMove.bind(this)))}enableContextMenuEvent(){this.enableMouseMoveEvent(),!this._contextMenuEnabled&&this._element&&(this._contextMenuEnabled=!0,this._element.addEventListener('contextmenu',this._onContextMenu.bind(this)))}enableClickEvent(){!this._clickEnabled&&this._element&&(this.__clickEnabled=!0,this._element.addEventListener('click',this._onClick.bind(this)))}enableDoubleClickEvent(){!this._doubleClickEnabled&&this._element&&(this._doubleClickEnabled=!0,this._element.addEventListener('dblclick',this._onDoubleClick.bind(this)))}enableMouseWheelEvent(){!this._mouseWheelEnabled&&this._element&&(this._mouseWheelEnabled=!0,this._element.addEventListener('mousewheel',this._onMouseWheel.bind(this)))}enableEnterEvent(){this.enableMouseMoveEvent(),!this._mouseOverEnabled&&this._element&&(this._mouseOverEnabled=!0,this._element.addEventListener('mouseover',this._onMouseOver.bind(this)))}enableLeaveEvent(){this.enableMouseMoveEvent(),!this._mouseOutEnabled&&this._element&&(this._mouseOutEnabled=!0,this._element.addEventListener('mouseout',this._onMouseOut.bind(this)))}enableTouchEvents(){this._touchEventsEnabled||(this._touchEventsEnabled=!0,this._element.addEventListener('touchstart',this._onTouchStart.bind(this)),this._element.addEventListener('touchend',this._onTouchEnd.bind(this)),this._element.addEventListener('touchcancel',this._onTouchCancel.bind(this)),this._element.addEventListener('touchmove',this._onTouchMove.bind(this)),this.style.touchAction='none')}enablePointerEvents(e){this._pointerEventsEnabled||(this._pointerEventsEnabled=!0,this._element.addEventListener('pointerdown',this._onPointerDown.bind(this)),e?(window.addEventListener('pointermove',this._onPointerMove.bind(this)),window.addEventListener('pointerup',this._onPointerUp.bind(this))):(this._element.addEventListener('pointermove',this._onPointerMove.bind(this)),this._element.addEventListener('pointerup',this._onPointerUp.bind(this))),this.style.touchAction='none')}_onPointerDown(e){this.hasFocus=!0;const t=new Ct(e);if($t.currentPointers.some((e=>e.id===t.id)))return;$t.currentPointers.push(t);this.pointerDownEvent(e,$t.currentPointers,t)||(e.stopPropagation(),e.preventDefault())}releasePointers(){$t.currentPointers.length=0}_onPointerMove(e){const t=new Ct(e),n=$t.currentPointers.findIndex((e=>e.id===t.id));-1!==n&&($t.currentPointers[n]=t),this.hasFocus=!0;this.pointerMoveEvent(e,$t.currentPointers,t)||(e.stopPropagation(),e.preventDefault())}_onPointerUp(e){const t=new Ct(e),n=$t.currentPointers.findIndex((e=>e.id===t.id));-1!=n&&$t.currentPointers.splice(n,1),this.hasFocus=!0;this.pointerUpEvent(e,$t.currentPointers,t)||(e.stopPropagation(),e.preventDefault())}pointerDownEvent(){return!0}pointerMoveEvent(){return!0}pointerUpEvent(){return!0}enableKeyPressEvent(){this.enableEnterEvent(),this.enableLeaveEvent(),this.enableMouseMoveEvent(),this._keyPressEnabled||(this._keyPressEnabled=!0,document.addEventListener('keydown',this._onKeyPress.bind(this)))}enableKeyReleaseEvent(){this.enableEnterEvent(),this.enableLeaveEvent(),this.enableMouseMoveEvent(),this._keyReleaseEnabled||(this._keyReleaseEnabled=!0,document.addEventListener('keyup',this._onKeyRelease.bind(this)))}mousePressEvent(){return!1}mouseMoveEvent(e){return!1}mouseReleaseEvent(){return!1}contextMenuEvent(){return!0}clickEvent(){return!0}doubleClickEvent(){return!0}mouseWheelEvent(){return!0}enterEvent(){return!0}leaveEvent(){return!0}keyPressEvent(){return!0}keyReleaseEvent(){return!0}touchStartEvent(){}touchEndEvent(){}touchCancelEvent(){}touchMoveEvent(){}dragStartEvent(){}dragEndEvent(){}dragEvent(){}updatePositionFromEvent(e){this._element&&(this.startMouseEvent?(e.targetX=Math.max(0,Math.min(this.element.clientWidth,this.startMouseX+e.pageX-this.startMouseEvent.pageX)),e.targetY=Math.max(0,Math.min(this.element.clientHeight,this.startMouseY+e.pageY-this.startMouseEvent.pageY))):(e.targetX=e.offsetX,e.targetY=e.offsetY),this.mouseX=e.offsetX,this.mouseY=e.offsetY,this.mousePageX=e.clientX,this.mousePageY=e.clientY,void 0===e.movementX&&(e.movementX=e.clientX-this.lastMouseX,e.movementY=e.clientY-this.lastMouseY),this.lastMouseX=e.clientX,this.lastMouseY=e.clientY)}_onMouseDown(e){this.startMouseEvent=e,this.startMouseX=e.offsetX,this.startMouseY=e.offsetY,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,this._isMouseDown=!0,this.mouseButton=e.button;const t=this.mousePressEvent(e);return t||(e.stopPropagation(),e.preventDefault()),t}_onMouseMove(e){return this.mouseMoveEvent(e)}_onMouseUp(e){if(this.startMouseEvent=null,!this._isMouseDown)return!0;this._isMouseDown=!1;const t=this.mouseReleaseEvent(e);return t||(e.stopPropagation(),e.preventDefault()),t}_onContextMenu(e){return this.contextMenuEvent(e)||(e.stopPropagation(),e.preventDefault()),!1}_onClick(e){this.clickEvent(e)||(e.stopPropagation(),e.preventDefault())}_onDoubleClick(e){this.doubleClickEvent(e)||(e.stopPropagation(),e.preventDefault())}_onMouseWheel(e){'wheel'===e.type?e.wheel=-e.deltaY:e.wheel=null!=e.wheelDeltaY?e.wheelDeltaY:-60*e.detail,e.delta=void 0!==e.wheelDelta?e.wheelDelta/40:e.deltaY?-e.deltaY/3:0;this.mouseWheelEvent(e)||(e.stopPropagation(),e.preventDefault())}_onMouseOver(e){this.hasFocus=!0;this.enterEvent(e)||(e.stopPropagation(),e.preventDefault())}_onMouseOut(e){this.hasFocus=!1;this.leaveEvent(e)||(e.stopPropagation(),e.preventDefault())}_onKeyPress(e){if(!this.hasFocus)return;this.keyPressEvent(e)||(e.stopPropagation(),e.preventDefault())}_onKeyRelease(e){if(!this.hasFocus)return;this.keyReleaseEvent(e)||(e.stopPropagation(),e.preventDefault())}_onTouchStart(e){this.hasFocus=!0;this.touchStartEvent(e)||(e.stopPropagation(),e.preventDefault())}_onTouchEnd(e){this.hasFocus=!0;this.touchEndEvent(e)||(e.stopPropagation(),e.preventDefault())}_onTouchCancel(e){this.hasFocus=!0;this.touchCancelEvent(e)||(e.stopPropagation(),e.preventDefault())}_onTouchMove(e){this.hasFocus=!0;this.touchMoveEvent(e)||(e.stopPropagation(),e.preventDefault())}trigger(e,t){const n=new CustomEvent(e,{bubbles:!0,cancelable:!0,detail:t});return this.dispatchEvent&&this.dispatchEvent(n),n}disableDropEvents(){this._onDragEvent&&(this.removeEventListener('dragenter',this._onDragEvent),this.removeEventListener('drop',this._onDropEvent),this.addEventListener('dragleave',this._onDragEvent),this.addEventListener('dragover',this._onDragEvent),this.addEventListener('drop',this._onDropEvent),this._onDragEvent=null,this._onDropEvent=null)}enableDropEvents(){this._onDragEvent||(this._onDragEvent=this.onDragEvent.bind(this),this._onDropEvent=this.onDropEvent.bind(this),this.addEventListener('dragenter',this._onDragEvent))}onDragEvent(e){const t=this.element;'dragenter'==e.type&&(t.addEventListener('dragleave',this._onDragEvent),t.addEventListener('dragover',this._onDragEvent),t.addEventListener('drop',this._onDropEvent)),'dragenter'==e.type&&this.dragEnterEvent&&this.dragEnterEvent(e),'dragleave'==e.type&&this.dragLeaveEvent&&this.dragLeaveEvent(e),'dragover'==e.type&&this.dragOverEvent&&this.dragOverEvent(e)}onDropEvent(e){this.removeEventListener('dragleave',this._onDragEvent),this.removeEventListener('dragover',this._onDragEvent),this.removeEventListener('drop',this._onDropEvent),this.dropEvent&&this.dropEvent(e)}}$t.window=null,$t.currentPointers=[],$t.disablePaintingOnResize=!1,$t.id=0;class At extends $t{constructor(e,t){super('div',e,t)}}At._idPrefix='DIV';class Et extends At{constructor(e,t,n,s,i){super(s),this.title=e,this.page=t,this.parentWidget=n,this.classList.add('tab-handle','disable-selection'),this.textElement=new At(this,{class:'tab-handle-text',text:e}),this.draggable=!0,this.enableMouseEvents(),this.enableDoubleClickEvent(),this.configure(i),this.enableDropEvents()}dragStartEvent(){Et.DragWidget=this}dragEndEvent(){Et.DragWidget=null}dragOverEvent(e){Et.DragWidget&&e.srcElement.classList.contains('tab-handle')&&this!==Et.DragWidget&&(e.layerX<.5*this.width?(e.preventDefault(),this.style.borderRight='',this.style.borderLeft='4px solid #fff'):(e.preventDefault(),this.style.borderLeft='',this.style.borderRight='4px solid #fff'))}dropEvent(e){this.style.borderLeft='',this.style.borderRight='',e.srcElement.classList.contains('tab-handle')&&(e.layerX<.5*this.width?console.log('Insert Before'):console.log('Insert After'))}dragEnterEvent(){this.style.borderLeft='',this.style.borderRight=''}dragLeaveEvent(){this.style.borderLeft='',this.style.borderRight=''}configure(e){if(e&&(super.configure(e),e.displayCloseButton)){this.closeButton=new At(this,{class:'tab-handle-close-button'}),this.closeButton.title='Close Tab';const e='icon-remove-sign';this.closeButton.element.innerHTML=`<span class="${e}">x</span>`,this.closeButton.addEventListener('click',(()=>{this.parentWidget.closeTabHandle(this)}))}}get isActive(){return this.classList.contains('tab-handle-selected')}set isActive(e){e!=this.isActive&&(e?(this.classList.add('tab-handle-selected'),this.page.style.display='block',this.style.zIndex='10'):(this.classList.remove('tab-handle-selected'),this.page.style.display='none',this.style.zIndex='0'))}mousePressEvent(e){this.parentWidget.setHandleActive(this)}doubleClickEvent(){}maximizePanel(){}}Et._idPrefix='TAB';class Pt extends At{constructor(e,t,n){super(t,n),this.classList.add('tab-page'),this.style.display='none',this.panel=e,e&&(e.parent=this)}}Pt._idPrefix='TABPAGE',Pt.isTabPage=!0;class Dt extends At{constructor(e,t){super(e),this._activeTab=-1,this.displayCloseButton=!1,this._element.classList.add('tab-widget'),this.headerElement=new At(this),this.headerElement.classList.add('tab-header'),this.iconsElement=new At(this.headerElement),this.iconsElement.classList.add('tab-icons'),this.tabListElement=new At(this.headerElement),this.tabListElement.classList.add('tab-handle-list-container'),this.contentElement=new At(this),this.contentElement.classList.add('tab-content'),this.contentElement.style.height=`calc(100% - ${this.headerElement.height}px)`,t&&this.configure(t)}configure(e){if(super.configure(e),void 0!==e.displayCloseButton&&(this.displayCloseButton=e.displayCloseButton),void 0!==e.tabs)for(const t of e.tabs)this.addTab(t.label,t.contents)}clearIcons(){this.iconsElement.children.length=0}addTab(e,t){t._tabLabel=e;const n=new Pt(t,this.contentElement),s=new Et(e,n,this,this.tabListElement,{displayCloseButton:this.displayCloseButton});1==this.tabListElement.children.length&&(this._activeTab=0,s.isActive=!0,n&&n.repaint(!0)),t.domChanged()}closeTabHandle(e){const t=this.tabListElement.children.indexOf(e);if(-1==t)return;const n=this.contentElement.children[t];this.tabListElement.removeChild(e),this.contentElement.removeChild(n),this._activeTab==t&&(this._activeTab=-1),-1==this._activeTab&&this.numTabs>0&&(this.activeTab=0)}get numTabs(){return this.tabListElement.children.length}get activeTab(){return this._activeTab}set activeTab(e){if(e<0||e>this.tabListElement.children.length)return;for(let t=0,n=this.tabListElement.children.length;t<n;++t){this.tabListElement.children[t].isActive=t==e}this._activeTab=e;const t=this.contentElement.children[this._activeTab].children[0];t&&t.repaint(!0)}isPanelVisible(e){for(let t=0,n=this.numTabs;t<n;++t){if(e===this.tabListElement.children[t].page.children[0])return this._activeTab==t}return!1}setActivePanel(e){for(let t=0,n=this.numTabs;t<n;++t){e===this.tabListElement.children[t].page.children[0]&&(this.activeTab=t)}}setHandleActive(e){for(let t=0,n=this.numTabs;t<n;++t){this.tabListElement.children[t]===e&&(this.activeTab=t)}}static findParentTabWidget(e){let t=e._parent;for(;t;){if(t.constructor.isTabPage)return[t._parent._parent,t];t=t._parent}return null}}Dt._idPrefix='TABWIDGET';class Mt{constructor(e){this.device=e,this.blitShaderModule=e.createShaderModule({code:Mt.blitShader}),this.blit3dShaderModule=e.createShaderModule({code:Mt.blit3dShader}),this.multisampleBlitShaderModule=e.createShaderModule({code:Mt.multisampleBlitShader}),this.depthToFloatShaderModule=e.createShaderModule({code:Mt.depthToFloatShader}),this.depthToFloatMultisampleShaderModule=e.createShaderModule({code:Mt.depthToFloatMultisampleShader}),this.blitPipelines={},this.blitDepthPipelines={},this.bindGroupLayouts=new Map,this.pipelineLayouts=new Map,this.depthToFloatPipeline=null,this.depthToFloatMSPipeline=null,this.pointSampler=e.createSampler({magFilter:'nearest',minFilter:'nearest'}),this.displayUniformBuffer=e.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.displayBingGroupLayout=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:'uniform'}}]}),this.displayBindGroup=e.createBindGroup({layout:this.displayBingGroupLayout,entries:[{binding:0,resource:{buffer:this.displayUniformBuffer}}]})}copyDepthTexture(e,t,n){const s=e.width,i=e.height,r=e.depthOrArrayLayers,o=e.usage|GPUTextureUsage.RENDER_TARGET|GPUTextureUsage.COPY_SRC,a=[s,i,r];t=t||'r32float';const l=this.device.createTexture({format:t,size:a,usage:o});for(let s=0;s<r;++s){const i=e.createView({dimension:'2d',aspect:'depth-only',baseArrayLayer:s,arrayLayerCount:1}),r=l.createView({dimension:'2d',baseArrayLayer:s,arrayLayerCount:1});this.convertDepthToFloat(i,e.sampleCount,r,t,n)}return l}copyMultisampledTexture(e){const t=e.width,n=e.height,s=e.format,i=e.usage|GPUTextureUsage.RENDER_TARGET|GPUTextureUsage.COPY_SRC,r=[t,n,1],o=this.device.createTexture({format:s,size:r,usage:i});return this.blitTexture(e.createView(),e.format,e.sampleCount,o.createView(),s),o}blitTexture(e,t,n,s,i,r,o,a){a??=0,o??='2d';const l='unfilterable-float',c=`${l}#${n}#${o}`;if(!this.bindGroupLayouts.has(c)){const e=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,sampler:{type:'non-filtering'}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{viewDimension:o,sampleType:l,multisampled:n>1}}]});this.bindGroupLayouts.set(c,e);const t=this.device.createPipelineLayout({bindGroupLayouts:[e,this.displayBingGroupLayout]});this.pipelineLayouts.set(c,t)}const h=bt[t],u=h?.channels??4,d=this.bindGroupLayouts.get(c),f=this.pipelineLayouts.get(c),p=`${i}#${l}#${n}#${o}`;let m=this.blitPipelines[p];if(!m){const e=n>1?this.multisampleBlitShaderModule:'3d'===o?this.blit3dShaderModule:this.blitShaderModule;m=this.device.createRenderPipeline({layout:f,vertex:{module:e,entryPoint:'vertexMain'},fragment:{module:e,entryPoint:'fragmentMain',targets:[{format:i}]},primitive:{topology:'triangle-list'}}),this.blitPipelines[p]=m}const g=this.device.createBindGroup({layout:d,entries:[{binding:0,resource:this.pointSampler},{binding:1,resource:e}]}),v=this.device.createCommandEncoder(),x={colorAttachments:[{view:s,loadOp:'clear',storeOp:'store'}]};r?this.device.queue.writeBuffer(this.displayUniformBuffer,0,new Float32Array([r.exposure,r.channels,u,r.minRange,r.maxRange,a,0,0])):this.device.queue.writeBuffer(this.displayUniformBuffer,0,new Float32Array([1,0,u,0,1,a,0,0]));const b=v.beginRenderPass(x);b.setPipeline(m),b.setBindGroup(0,g),b.setBindGroup(1,this.displayBindGroup),b.draw(3),b.end(),this.device.queue.submit([v.finish()])}convertDepthToFloat(e,t,n,s,i){if(t>1){if(!this.depthToFloatMSPipeline){this.device.pushErrorScope('validation'),this.depthToFloatBindGroupMSLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:'depth',multisampled:!0}}]});const e=this.device.createPipelineLayout({bindGroupLayouts:[this.depthToFloatBindGroupMSLayout]}),t=this.depthToFloatMultisampleShaderModule;this.depthToFloatMSPipeline=this.device.createRenderPipeline({layout:e,vertex:{module:t,entryPoint:'vertexMain'},fragment:{module:t,entryPoint:'fragmentMain',targets:[{format:s}]},primitive:{topology:'triangle-list'}}),this.device.popErrorScope().then((e=>{e&&console.error(e.message)}))}}else if(!this.depthToFloatPipeline){this.device.pushErrorScope('validation'),this.depthToFloatBindGroupLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:'depth'}}]});const e=this.device.createPipelineLayout({bindGroupLayouts:[this.depthToFloatBindGroupLayout]}),t=this.depthToFloatShaderModule;this.depthToFloatPipeline=this.device.createRenderPipeline({layout:e,vertex:{module:t,entryPoint:'vertexMain'},fragment:{module:t,entryPoint:'fragmentMain',targets:[{format:s}]},primitive:{topology:'triangle-list'}}),this.device.popErrorScope().then((e=>{e&&console.error(e.message)}))}this.device.pushErrorScope('validation');const r=this.device.createBindGroup({layout:t>1?this.depthToFloatBindGroupMSLayout:this.depthToFloatBindGroupLayout,entries:[{binding:0,resource:e}]}),o=!i;i??=this.device.createCommandEncoder();const a=i.beginRenderPass({colorAttachments:[{view:n,loadOp:'clear',storeOp:'store',clearColor:{r:0,g:0,b:0,a:0}}]});a.setPipeline(t>1?this.depthToFloatMSPipeline:this.depthToFloatPipeline),a.setBindGroup(0,r),a.draw(3),a.end(),o&&this.device.queue.submit([i.finish()]),this.device.popErrorScope().then((e=>{e&&console.error(e.message)}))}}Mt.blitShader='\n  var<private> posTex:array<vec4f, 3> = array<vec4f, 3>(\n    vec4f(-1.0, 1.0, 0.0, 0.0),\n    vec4f(3.0, 1.0, 2.0, 0.0),\n    vec4f(-1.0, -3.0, 0.0, 2.0));\n  struct VertexOutput {\n    @builtin(position) position: vec4f,\n    @location(0) uv: vec2f\n  };\n  @vertex\n  fn vertexMain(@builtin(vertex_index) vertexIndex: u32) -> VertexOutput {\n    var output: VertexOutput;\n    output.uv = posTex[vertexIndex].zw;\n    output.position = vec4f(posTex[vertexIndex].xy, 0.0, 1.0);\n    return output;;\n  }\n  @group(0) @binding(0) var texSampler: sampler;\n  @group(0) @binding(1) var texture: texture_2d<f32>;\n  struct Display {\n    exposure: f32,\n    channels: f32,\n    numChannels: f32,\n    minRange: f32,\n    maxRange: f32,\n    _pad1: f32,\n    _pad2: f32,\n    _pad3: f32\n  };\n  @group(1) @binding(0) var<uniform> display: Display; \n  @fragment\n  fn fragmentMain(input: VertexOutput) -> @location(0) vec4f {\n    var color = textureSample(texture, texSampler, input.uv);\n\n    if (display.numChannels == 1.0) {\n      if (display.minRange != display.maxRange) {\n        if (color.r < display.minRange) {\n          color = vec4f(0.0, 0.0, 0.0, 1);\n        } else if (color.r > display.maxRange) {\n          color = vec4f(1.0, 0.0, 0.0, 1);\n        } else {\n          color = vec4f((color.r - display.minRange) / (display.maxRange - display.minRange), 0.0, 0.0, 1);\n        }\n      }\n      color = vec4f(color.r, color.r, color.r, 1.0);\n    } else if (display.numChannels == 2.0) {\n      color = vec4f(color.r, color.g, 0.0, 1.0);\n    }\n\n    if (display.channels == 1.0) { // R\n      var rgb = color.rgb * display.exposure;\n      return vec4f(rgb.r, 0.0, 0.0, 1);\n    } else if (display.channels == 2.0) { // G\n      var rgb = color.rgb * display.exposure;\n      return vec4f(0.0, rgb.g, 0.0, 1);\n    } else if (display.channels == 3.0) { // B\n      var rgb = color.rgb * display.exposure;\n      return vec4f(0.0, 0.0, rgb.b, 1);\n    } else if (display.channels == 4.0) { // A\n      var a = color.a * display.exposure;\n      return vec4f(a, a, a, 1);\n    } else if (display.channels == 5.0) { // Luminance\n      var luminance = dot(color.rgb, vec3f(0.2126, 0.7152, 0.0722));\n      var rgb = vec3f(luminance) * display.exposure;\n      return vec4f(rgb, 1);\n    }\n\n    // RGB\n    var rgb = color.rgb * display.exposure;\n    return vec4f(rgb, 1);\n  }\n',Mt.blit3dShader='\n  var<private> posTex:array<vec4f, 3> = array<vec4f, 3>(\n    vec4f(-1.0, 1.0, 0.0, 0.0),\n    vec4f(3.0, 1.0, 2.0, 0.0),\n    vec4f(-1.0, -3.0, 0.0, 2.0));\n  struct VertexOutput {\n    @builtin(position) position: vec4f,\n    @location(0) uv: vec2f\n  };\n  @vertex\n  fn vertexMain(@builtin(vertex_index) vertexIndex: u32) -> VertexOutput {\n    var output: VertexOutput;\n    output.uv = posTex[vertexIndex].zw;\n    output.position = vec4f(posTex[vertexIndex].xy, 0.0, 1.0);\n    return output;;\n  }\n  @group(0) @binding(0) var texSampler: sampler;\n  @group(0) @binding(1) var texture: texture_3d<f32>;\n  struct Display {\n    exposure: f32,\n    channels: f32,\n    numChannels: f32,\n    minRange: f32,\n    maxRange: f32,\n    layer: f32,\n    _pad2: f32,\n    _pad3: f32\n  };\n  @group(1) @binding(0) var<uniform> display: Display; \n  @fragment\n  fn fragmentMain(input: VertexOutput) -> @location(0) vec4f {\n    var color = textureSampleLevel(texture, texSampler, vec3f(input.uv, display.layer), 0.0);\n\n    if (display.numChannels == 1.0) {\n      if (display.minRange != display.maxRange) {\n        if (color.r < display.minRange) {\n          color = vec4f(0.0, 0.0, 0.0, 1);\n        } else if (color.r > display.maxRange) {\n          color = vec4f(1.0, 0.0, 0.0, 1);\n        } else {\n          color = vec4f((color.r - display.minRange) / (display.maxRange - display.minRange), 0.0, 0.0, 1);\n        }\n      }\n      color = vec4f(color.r, color.r, color.r, 1.0);\n    } else if (display.numChannels == 2.0) {\n      color = vec4f(color.r, color.g, 0.0, 1.0);\n    }\n\n    if (display.channels == 1.0) { // R\n      var rgb = color.rgb * display.exposure;\n      return vec4f(rgb.r, 0.0, 0.0, 1);\n    } else if (display.channels == 2.0) { // G\n      var rgb = color.rgb * display.exposure;\n      return vec4f(0.0, rgb.g, 0.0, 1);\n    } else if (display.channels == 3.0) { // B\n      var rgb = color.rgb * display.exposure;\n      return vec4f(0.0, 0.0, rgb.b, 1);\n    } else if (display.channels == 4.0) { // A\n      var a = color.a * display.exposure;\n      return vec4f(a, a, a, 1);\n    } else if (display.channels == 5.0) { // Luminance\n      var luminance = dot(color.rgb, vec3f(0.2126, 0.7152, 0.0722));\n      var rgb = vec3f(luminance) * display.exposure;\n      return vec4f(rgb, 1);\n    }\n\n    // RGB\n    var rgb = color.rgb * display.exposure;\n    return vec4f(rgb, 1);\n  }\n',Mt.multisampleBlitShader='\n  var<private> posTex:array<vec4f, 3> = array<vec4f, 3>(\n    vec4f(-1.0, 1.0, 0.0, 0.0),\n    vec4f(3.0, 1.0, 2.0, 0.0),\n    vec4f(-1.0, -3.0, 0.0, 2.0));\n  struct VertexOutput {\n    @builtin(position) position: vec4f,\n    @location(0) uv: vec2f\n  };\n  @vertex\n  fn vertexMain(@builtin(vertex_index) vertexIndex: u32) -> VertexOutput {\n    var output: VertexOutput;\n    output.uv = posTex[vertexIndex].zw;\n    output.position = vec4f(posTex[vertexIndex].xy, 0.0, 1.0);\n    return output;;\n  }\n  @group(0) @binding(0) var texSampler: sampler;\n  @group(0) @binding(1) var texture: texture_multisampled_2d<f32>;\n  struct Display {\n    exposure: f32,\n    channels: f32,\n    numChannels: f32,\n    minRange: f32,\n    maxRange: f32,\n    _pad1: f32,\n    _pad2: f32,\n    _pad3: f32\n  };\n  @group(1) @binding(0) var<uniform> display: Display; \n  @fragment\n  fn fragmentMain(input: VertexOutput) -> @location(0) vec4f {\n    var coords = vec2i(input.uv * vec2f(textureDimensions(texture)));\n    var color = textureLoad(texture, coords, 0);\n    if (display.numChannels == 1.0) {\n      if (display.minRange != display.maxRange) {\n        if (color.r < display.minRange) {\n          color = vec4f(0.0, 0.0, 0.0, color.a);\n        } else if (color.r > display.maxRange) {\n          color = vec4f(1.0, 1.0, 1.0, color.a);\n        } else {\n          color = vec4f((color.r - display.minRange) / (display.maxRange - display.minRange), 0.0, 0.0, color.a);\n        }\n      }\n      color = vec4f(color.r, color.r, color.r, 1.0);\n    } else if (display.numChannels == 2.0) {\n      color = vec4f(color.r, color.g, 0.0, 1.0);\n    }\n    if (display.channels == 1.0) { // R\n      var rgb = color.rgb * display.exposure;\n      return vec4f(rgb.r, 0.0, 0.0, color.a);\n    } else if (display.channels == 2.0) { // G\n      var rgb = color.rgb * display.exposure;\n      return vec4f(0.0, rgb.g, 0.0, color.a);\n    } else if (display.channels == 3.0) { // B\n      var rgb = color.rgb * display.exposure;\n      return vec4f(0.0, 0.0, rgb.b, color.a);\n    } else if (display.channels == 4.0) { // A\n      var a = color.a * display.exposure;\n      return vec4f(a, a, a, color.a);\n    } else if (display.channels == 5.0) { // Luminance\n      var luminance = dot(color.rgb, vec3f(0.2126, 0.7152, 0.0722));\n      var rgb = vec3f(luminance) * display.exposure;\n      return vec4f(rgb, color.a);\n    }\n\n    // RGB\n    var rgb = color.rgb * display.exposure;\n    return vec4f(rgb, color.a);\n  }',Mt.depthToFloatShader='\n  var<private> posTex:array<vec4f, 3> = array<vec4f, 3>(\n    vec4f(-1.0, 1.0, 0.0, 0.0),\n    vec4f(3.0, 1.0, 2.0, 0.0),\n    vec4f(-1.0, -3.0, 0.0, 2.0));\n  struct VertexOutput {\n    @builtin(position) position: vec4<f32>,\n    @location(0) uv : vec2<f32>\n  };\n  @vertex\n  fn vertexMain(@builtin(vertex_index) vertexIndex: u32) -> VertexOutput {\n    var output: VertexOutput;\n    output.uv = posTex[vertexIndex].zw;\n    output.position = vec4f(posTex[vertexIndex].xy, 0.0, 1.0);\n    return output;;\n  }\n  \n  @binding(0) @group(0) var depth: texture_depth_2d;\n  @fragment\n  fn fragmentMain(input: VertexOutput) -> @location(0) vec4<f32> {\n    var depthSize = textureDimensions(depth);\n    var coords = vec2<i32>(i32(f32(depthSize.x) * input.uv.x),\n                           i32(f32(depthSize.y) * input.uv.y));\n    var d = textureLoad(depth, coords, 0);\n    return vec4<f32>(d, 0.0, 0.0, 1.0);\n  }',Mt.depthToFloatMultisampleShader='\n  var<private> posTex:array<vec4f, 3> = array<vec4f, 3>(\n    vec4f(-1.0, 1.0, 0.0, 0.0),\n    vec4f(3.0, 1.0, 2.0, 0.0),\n    vec4f(-1.0, -3.0, 0.0, 2.0));\n  struct VertexOutput {\n    @builtin(position) position: vec4<f32>,\n    @location(0) uv : vec2<f32>\n  };\n  @vertex\n  fn vertexMain(@builtin(vertex_index) vertexIndex: u32) -> VertexOutput {\n    var output: VertexOutput;\n    output.uv = posTex[vertexIndex].zw;\n    output.position = vec4f(posTex[vertexIndex].xy, 0.0, 1.0);\n    return output;;\n  }\n  \n  @binding(0) @group(0) var depth: texture_depth_multisampled_2d;\n  @fragment\n  fn fragmentMain(input: VertexOutput) -> @location(0) vec4<f32> {\n    var depthSize = textureDimensions(depth);\n    var coords = vec2<i32>(i32(f32(depthSize.x) * input.uv.x),\n                           i32(f32(depthSize.y) * input.uv.y));\n    var d = textureLoad(depth, coords, 0);\n    return vec4<f32>(d, 0.0, 0.0, 1.0);\n  }';class Lt extends $t{constructor(e){super(document.body,e),this._overlay=null,this._onResizeCB=this.windowResized.bind(this),window.addEventListener('resize',this._onResizeCB),this.onWindowResized=new l,$t.window=this}windowResized(){this._onResize(window.innerWidth,window.innerHeight)}get width(){return window.innerWidth}get height(){return window.innerHeight}get overlay(){return this._overlay}set overlay(e){this._overlay!==e&&(null!==this._overlay&&this._element.removeChild(this._overlay._element),this._overlay=e,this._overlay&&(this._element.appendChild(this._overlay._element),this._overlay.setPosition(0,0,'absolute'),this._overlay.resize(window.innerWidth,window.innerHeight)))}_onResize(e,t){this.onWindowResized.emit(),this.repaint(),this._element&&this._overlay&&this._overlay.resize(e,t),this.onResize()}}Lt.isWindow=!0,Lt._idPrefix='WINDOW';class Bt{constructor(){this.apiCalls=0,this.draw=0,this.drawIndirect=0,this.dispatch=0,this.setVertexBuffer=0,this.setIndexBuffer=0,this.setBindGroup=0,this.uniformBuffers=0,this.storageBuffers=0,this.textures=0,this.samplers=0,this.setPipeline=0,this.vertexShaders=0,this.fragmentShaders=0,this.computeShaders=0,this.computePasses=0,this.renderPasses=0,this.colorAttachments=0,this.depthStencilAttachments=0,this.copyCommands=0,this.writeBuffer=0,this.bufferBytesWritten=0,this.writeTexture=0,this.totalBytesWritten=0,this.totalInstances=0,this.totalVertices=0,this.totalTriangles=0,this.totalLines=0,this.totalPoints=0,Object.defineProperty(this,'_lastPipeline',{enumerable:!1,writable:!0,value:0})}reset(){this.apiCalls=0,this.draw=0,this.drawIndirect=0,this.dispatch=0,this.setVertexBuffer=0,this.setIndexBuffer=0,this.setBindGroup=0,this.uniformBuffers=0,this.storageBuffers=0,this.textures=0,this.samplers=0,this.setPipeline=0,this.vertexShaders=0,this.fragmentShaders=0,this.computeShaders=0,this.computePasses=0,this.renderPasses=0,this.colorAttachments=0,this.depthStencilAttachments=0,this.copyCommands=0,this.writeBuffer=0,this.bufferBytesWritten=0,this.writeTexture=0,this.totalBytesWritten=0,this.totalInstances=0,this.totalVertices=0,this.totalTriangles=0,this.totalLines=0,this.totalPoints=0,this._lastPipeline=0}updateStats(e,t){this.apiCalls++;const n=t.method,s=t.args;if('dispatchWorkgroups'===n||'dispatchWorkgroupsIndirect'===n)this.dispatch++;else if('draw'===n||'drawIndexed'===n||'drawIndirect'===n||'drawIndexedIndirect'===n){this.draw++;let i=0;if('drawIndirect'===n||'drawIndexedIndirect'===n){if(this.drawIndirect++,t.isBufferDataLoaded&&t.bufferData){const e=t.bufferData[0];if(e){i=new Uint32Array(e.buffer)[0]}}}else i=parseInt(s[0]??0)??0,this.totalInstances+=parseInt(s[1]??1);if(this.totalVertices+=i,this._lastPipeline){const t=e.getObject(this._lastPipeline.__id);if(t?.descriptor){const e=t.descriptor.primitive?.topology??'triangle-list';if('triangle-list'===e){const e=i/3;this.totalTriangles+=e}else if('triangle-strip'===e){const e=i-2;this.totalTriangles+=e}else'point-list'===e?this.totalPoints+=i:'line-list'===e?this.totalLines+=i/2:'line-strip'===e&&(this.totalLines+=i-1)}}}else if('setIndexBuffer'===n)this.setIndexBuffer++;else if('setVertexBuffer'===n)this.setVertexBuffer++;else if('setPipeline'===n){this.setPipeline++,this._lastPipeline=s[0];const t=e.getObject(s[0]?.__id);t&&(t.descriptor.vertex&&this.vertexShaders++,t.descriptor.fragment&&this.fragmentShaders++,t.descriptor.compute&&this.computeShaders++)}else if('setBindGroup'===n){this.setBindGroup++;const t=e.getObject(s[1]?.__id);if(t)for(const n of t.descriptor.entries)if(n.resource?.buffer){const t=e.getObject(n.resource.buffer.__id);t&&(t.descriptor.usage&GPUBufferUsage.STORAGE&&this.storageBuffers++,t.descriptor.usage&GPUBufferUsage.UNIFORM&&this.uniformBuffers++)}else if(n.resource?.__id){const t=e.getObject(n.resource.__id);t instanceof xt?this.textures++:t instanceof b&&this.samplers++}}else if('beginComputePass'===n)this.computePasses++;else if('beginRenderPass'===n){this.renderPasses++;const e=s[0];e.colorAttachments&&(this.colorAttachments+=e.colorAttachments.length),e.depthStencilAttachment&&this.depthStencilAttachments++}else if('writeBuffer'===n){this.writeBuffer++;const e=s[2];let t=0;if(s[2].constructor===String){const e=s[2].split(' ');t=parseInt(e[e.length-1])}else void 0!==e.length&&(t=e.length);const n=s.length>3?s[3]:0,i=s.length>4?s[4]:t-n;this.bufferBytesWritten+=i,this.totalBytesWritten+=i}else'writeTexture'===n?this.writeTexture++:'copyBufferToBuffer'!==n&&'copyBufferToTexture'!==n&&'copyTextureToBuffer'!==n&&'copyTextureToTexture'!==n||this.copyCommands++}}class Nt extends $t{constructor(e,t){super('button',e),this.classList.add('button'),this.callback=null,this.onMouseDown=null,this.onMouseUp=null,this._click=this.click.bind(this),this._mouseDown=this.mouseDown.bind(this),this._mouseUp=this.mouseUp.bind(this),this.element.addEventListener('click',this._click),this.element.addEventListener('mousedown',this._mouseDown),this.element.addEventListener('mouseup',this._mouseUp),t&&this.configure(t)}configure(e){super.configure(e),e.callback&&(this.callback=e.callback),e.mouseDown&&(this.onMouseDown=e.mouseDown),e.mouseUp&&(this.onMouseUp=e.mouseUp),e.label&&(this.text=e.label)}click(e){this.callback&&this.callback.call(this,e)}mouseDown(e){this.onMouseDown&&this.onMouseDown.call(this,e)}mouseUp(e){this.onMouseUp&&this.onMouseUp.call(this,e)}}class Rt extends $t{constructor(e,t){super('span',e,t)}}Rt._idPrefix='SPAN';class Ft extends $t{constructor(e,t){super('div',e,t);const n=t.collapsed??!1;this.titleBar=new At(this,{class:'title_bar'}),this.collapseButton=new Rt(this.titleBar,{class:'collapsable_button',text:n?'+':'-',style:'margin-right: 10px;'}),this.label=new Rt(this.titleBar,{class:'object_type',text:t?.label??''}),this.onExpanded=new l,this.onCollapsed=new l,this.body=new At(this,{class:['collapsable_body']}),n&&(this.body.element.className='collapsable_body collapsed');const s=this;this.titleBar.element.onclick=()=>{'-'==s.collapseButton.text?(s.collapseButton.text='+',s.body.element.className='collapsable_body collapsed',s.onCollapsed.emit()):(s.collapseButton.text='-',s.body.element.className='collapsable_body',s.onExpanded.emit())}}expand(){this.collapsed=!1}get collapsed(){return'+'==this.collapseButton.text}set collapsed(e){this.collapsed!=e&&(e?(this.collapseButton.text='+',this.body.element.className='collapsable_body collapsed',this.onCollapsed.emit()):(this.collapseButton.text='-',this.body.element.className='collapsable_body',this.onExpanded.emit()))}}class Vt extends At{constructor(e){const t=e?.title??'Dialog';super({class:e?.windowClass??'dialog',title:t}),e?.width&&(this.style.width=`${e.width}px`);const n=e?.parent??new At({class:'dialog-background'});this.parent=n;const s=new At(this,{class:'dialog-header',title:t});if(!e?.noCloseButton){const e=new Nt(s,{class:'dialog-close-button',text:'x',title:'Close'});e.addEventListener('mouseup',(t=>{t.target===e.element&&(Lt.window.overlay=null)}))}if(this.title=new Rt(s,{class:'dialog-title',text:t}),this.body=new At(this,{class:'dialog-body'}),e?.body&&this.body.appendChild(e.body),e?.parent||(Lt.window.overlay=n),e?.draggable){let e=!1;const t=this.getBoundingClientRect();let n=t?t.left:0,i=t?t.top:0;this.style.position='absolute',this.style.left=`${n}px`,this.style.top=`${i}px`;let r=0,o=0;s.addEventListener('mousedown',(t=>{e=!0,r=t.clientX,o=t.clientY}));const a=this;document.addEventListener('mousemove',(t=>{if(!e)return;const s=t.clientX-r,l=t.clientY-o;n+=s,i+=l,r=t.clientX,o=t.clientY,a.style.left=`${n}px`,a.style.top=`${i}px`})),document.addEventListener('mouseup',(()=>{e=!1}))}}close(){Lt.window.overlay=null}}class zt extends $t{constructor(e,t,n){super('label',t,n),this.classList.add('label'),this.text=e}configure(e){e&&(super.configure(e),e.for&&(this.for=e.for))}get for(){return this._element.htmlFor}set for(e){e?e.constructor===String?this._element.htmlFor=e:this._element.htmlFor=e.id:this._element.htmlFor=''}}class Ut extends $t{constructor(e,t){super('input',e,t),this.onChange=new l,this.onEdit=new l;const n=this;this.element.addEventListener('change',(()=>{let e='checkbox'===n.type?n.checked:n.value;n.onChange.emit(e),n._onChange&&n._onChange(e)})),this.element.addEventListener('input',(()=>{let e='checkbox'===n.type?n.checked:n.value;n.onEdit.emit(e),n._onEdit&&n._onEdit(e)}))}configure(e){e&&(super.configure(e),void 0!==e.type&&(this.type=e.type),void 0!==e.checked&&(this.checked=e.checked),void 0!==e.value&&(this.value=e.value),void 0!==e.label&&(e.label.constructor===String?this.label=new zt(e.label,this.parent,{for:this}):(this.label=e.label,this.label.for=this.id)),void 0!==e.readOnly&&(this.readOnly=e.readOnly),void 0!==e.onChange&&(this._onChange=e.onChange),void 0!==e.onEdit&&(this._onEdit=e.onEdit))}get type(){return this._element.type}set type(e){this._element.type=e}get checked(){return this._element.checked}set checked(e){this._element.checked=e}get indeterminate(){return this._element.indeterminate}set indeterminate(e){this._element.indeterminate=e}get value(){return this._element.value}set value(e){this._element.value=e}get readOnly(){return this._element.readOnly}set readOnly(e){this._element.readOnly=e}focus(){this._element.focus()}blur(){this._element.blur()}select(){this._element.select()}}class Wt extends Ut{constructor(e,t){super(e,t),this.classList.add('text-input'),this.type='text',this.enableKeyPressEvent()}configure(e){e&&(super.configure(e),e.placeholder&&(this.placeholder=e.placeholder))}get placeholder(){return this.element.placeholder}set placeholder(e){this.element.placeholder=e}keyPressEvent(e){return 27===e.keyCode&&e.target.blur(),!0}}class Qt extends Rt{constructor(e,t){super(e,t),this.classList.add('dragger');let n=!1,s=(t=t||{}).value;null==s?s=0:s.constructor===String?(n=isNaN(s),n||(s=parseFloat(s))):s.constructor!==Number&&(s=0);const i=null!=t.precision?t.precision:3;this.value=s,this.precision=i,this.units=t.units??'',this.disabled=!!t.disabled,this.horizontal=!!t.horizontal,this.linear=!!t.linear,this.step=t.step??1,this.min=t.min??null,this.max=t.max??null;const r=new Rt(this,{class:'inputfield'});t.full&&r.classList.add('full'),this.disabled&&r.classList.add('disabled');const o=t.inputClass||'full',a=new Wt(r,{class:['text','number',o],value:n?s:s.toFixed(i)+(t.units?t.units:''),onChange:t.onChange});this.input=a,a.ownerDocument=document,this.disabled&&(a.disabled=!0),t.tabIndex&&(a.tabIndex=t.tabIndex),a.addEventListener('keydown',(e=>{if(38==e.keyCode)p(1,e);else{if(40!=e.keyCode)return;p(-1,e)}return e.stopPropagation(),e.preventDefault(),!0}));const l=new Rt(r,{class:'drag_widget'});this.disabled&&l.classList.add('disabled'),this.dragger=l,l.addEventListener('mousedown',(function(e){if(n)return;c=a.ownerDocument,c.removeEventListener('mousemove',u),c.removeEventListener('mouseup',f),h.disabled||(h.element.requestPointerLock&&h.element.requestPointerLock(),c.addEventListener('mousemove',u),c.addEventListener('mouseup',f),l.data=[e.screenX,e.screenY],h.trigger('startDragging'));e.stopPropagation(),e.preventDefault()})),a.addEventListener('wheel',d,!1),a.addEventListener('mousewheel',d,!1);let c=null;const h=this;function u(e){if(n)return;let t=[e.screenX-l.data[0],l.data[1]-e.screenY];void 0!==e.movementX&&(t=[e.movementX,-e.movementY]),l.data=[e.screenX,e.screenY];return p(t[h.horizontal?0:1],e),e.stopPropagation(),e.preventDefault(),!1}function d(e){if(n)return;if(document.activeElement!==this)return;p((void 0!==e.wheelDelta?e.wheelDelta:e.deltaY?-e.deltaY/3:0)>0?1:-1,e),e.stopPropagation(),e.preventDefault()}function f(e){if(n)return;h.trigger('stopDragging');const t=c||document;return c=null,t.removeEventListener('mousemove',u),t.removeEventListener('mouseup',f),t.exitPointerLock&&t.exitPointerLock(),l.trigger('blur'),e.stopPropagation(),e.preventDefault(),!1}function p(e,t){if(n)return;h.linear||(e=e>0?Math.pow(e,1.2):-1*Math.pow(Math.abs(e),1.2));let s=h.step?h.step:1;t&&t.shiftKey?s*=10:t&&t.ctrlKey&&(s*=.1);let i=parseFloat(a.value)+e*s;null!==h.max&&i>h.max&&(i=h.max),null!==h.min&&i<h.min&&(i=h.min),i=i.toFixed(h.precision),h.units&&(i+=h.units),a.value=i,a.trigger('change')}}setRange(e,t){this.min=e,this.max=t}setValue(e,t){const n=isNaN(e);n||(e=parseFloat(e),null!==this.min&&e<this.min&&(e=this.min),null!==this.max&&e>this.max&&(e=this.max)),this.value!=e&&(this.value=e,n||(this.precision&&(e=e.toFixed(this.precision)),this.units&&(e+=this.units)),this.input.value!=e&&(this.input.value=e,t||this.input.onChange.emit(e)))}getValue(){return this.value}}class jt extends $t{constructor(e,t){super('textArea',e,t),this.element.spellcheck=!1,this.classList.add('text-area'),this.onChange=new l,this.onEdit=new l;const n=this;this.element.addEventListener('change',(()=>{let e=n.value;n.onChange.emit(e),n._onChange&&n._onChange(e)})),this.element.addEventListener('input',(()=>{let e=n.value;n.onEdit.emit(e),n._onEdit&&n._onEdit(e)}))}configure(e){e&&(super.configure(e),e.value&&(this.value=e.value),e.placeholder&&(this.placeholder=e.placeholder),void 0!==e.readOnly&&(this.readOnly=e.readOnly),void 0!==e.onChange&&(this._onChange=e.onChange),void 0!==e.onEdit&&(this._onEdit=e.onEdit))}get value(){return this._element.value}set value(e){this._element.value=e}get placeholder(){return this._element.placeholder}set placeholder(e){this._element.placeholder=e}get readOnly(){return this._element.readOnly}set readOnly(e){this._element.readOnly=e}}function Xt(e,t){function n(e,t){return''===e?t:`${e} | ${t}`}let s='';for(const i in t){e&t[i]&&(s=n(s,i))}return s}class Gt extends $t{constructor(e,t){super('span',e),this.classList.add('select'),this.select=new $t('select',this),this.select.style.width='100%',this.select.style.height='20px',this.select.style.border='none',this.select.style.display='inline-block',this.select.classList.add('select'),this.onChange=new l;const n=this;this.select.element.addEventListener('change',(()=>{n.selectEdit?n.selectEdit.value=n.select.element.value:(n.onChange.emit(n.value,n.index),n._onChange&&n._onChange(n.value,n.index))})),t&&t.editable&&(this.selectEdit=new Wt(this,{value:t.options[0],style:'position: absolute; top: 2px; left: 0px; width: calc(100% - 20px); height: 20px; border: none;'}),this.selectEdit.onChange.addListener((()=>{n.onChange.emit(n.value),n._onChange&&n._onChange(n.value,n.index)}))),t&&this.configure(t),this.style.height='20px',this.style.position='relative',this.style.minWidth='50px'}get disabled(){return super.disabled}set disabled(e){super.disabled=e,this.select.disabled=e,this.selectEdit&&(this.selectEdit.disabled=e)}configure(e){if(e){if(super.configure(e),e.options)for(const t of e.options)this.addOption(t);void 0!==e.label&&(e.label.constructor===String?this.label=new zt(e.label,this.parent,{fixedSize:0,for:this}):(this.label=e.label,this.label.for=this.id,this.label.parent||(this.label.parent=this.parent))),void 0!==e.value&&(this.select.element.value=e.value),void 0!==e.index&&(this.select.element.selectedIndex=e.index,this.selectEdit&&(this.selectEdit.value=this.select.element.value)),void 0!==e.onChange&&(this._onChange=e.onChange)}}get index(){return this.select.element.selectedIndex}set index(e){this.select.element.selectedIndex=e}get value(){return this.selectEdit?this.selectEdit.value:this.select.element.value}set value(e){this.selectEdit?this.selectEdit.value=e:this.select.element.value=e}addOption(e){const t=document.createElement('option');t.innerText=e,this.select.element.add(t)}resize(e,t){this._element&&(this.select.element.style.width=`${e}px`,this.select.element.style.height=`${t}px`,this.onResize(),$t.disablePaintingOnResize||this.paintEvent())}}function qt(e){return e.isArray?`array<${qt(e.format)}>`:e.isTemplate?`${e.name}<${qt(e.format)}>`:e.name}function Ht(e){if(e.isStruct){const t=[];for(const n of e.members){const e=Ht(n.type);t.push(...e)}return t.push(e),t}return void 0!==e.format?Ht(e.format):[]}function Yt(e){if(!e?.members)return'';let t=`struct ${e.name} {\n`;for(const n of e.members)t+=`  ${n.name}: ${qt(n.type)},\n`;return t+='}\n',t}function Kt(e){if(e.isArray)return`array<${Kt(e.format)}>`;if(e.isStruct){const t=Ht(e);let n='';for(const e of t)n+=Yt(e);return n}return e.isTemplate?`${e.name}<${Kt(e.format)}>`:e.name}async function Zt(e){const t=await fetch(e);return new Uint8Array(await t.arrayBuffer())}class Jt{constructor(e){this.database=e,this.frameIndex=0,this.commands=[],this.frameImageList=[],this.onCaptureFrameResults=new l,this.onUpdateCaptureStatus=new l,this._loadedDataChunks=0,this._loadingImages=0,this._loadingBuffers=0,this._captureCount=0,this._pendingCommandBufferData=new Map,this._timestampBuffer=null,this._timestampChunkCount=0}captureTextureFrames(e){this._loadedDataChunks+=e.chunkCount,this._loadingImages+=e.count??0;const t=e.textures;if(t)for(const e of t){const t=this._getObject(e);t&&(t.imageDataPending=!0)}}captureTextureDataChunk(){this._loadedDataChunks--}captureTextureLoaded(){this._loadingImages--}captureFrameResults(e){const t=e.frame,n=e.count,s=e.batches;this.commands.length=n,this.frameIndex=t,this._captureCount=s}captureFrameCommands(e){const t=e.commands,n=e.index,s=e.count,i=e.frame,r=this._pendingCommandBufferData;for(const e in r){const n=r[e],s=t[e];for(const e in n)s[e]=n[e]}this._pendingCommandBufferData.clear();for(let e=0,i=n;e<s;++e,++i)this.commands[i]=t[e];this._captureCount--,0===this._captureCount&&this.onCaptureFrameResults.emit(i,this.commands)}captureBuffers(e){this._loadingBuffers+=e.count??0,this._loadedDataChunks+=e.chunkCount}captureBufferData(e){const t=e.commandId,n=e.entryIndex,s=e.offset,i=e.size,r=e.index,o=e.count,a=e.chunk;this._captureBufferData(t,n,s,i,r,o,a)}getCaptureStatus(){let e='';return(this._loadingImages||this._loadingBuffers||this._loadedDataChunks)&&(e='Loading ',this._loadingImages&&(e+=`Images: ${this._loadingImages} `),this._loadingBuffers&&(e+=`Buffers: ${this._loadingBuffers} `),this._loadedDataChunks&&(e+=`Data Chunks: ${this._loadedDataChunks} `)),e}_getObject(e){return this.database.getObject(e)}_captureBufferData(e,t,n,s,i,r,o){if(-1e3===e){null==this._timestampBuffer&&(this._timestampBuffer=new Uint8Array(s),this._timestampChunkCount=r);const e=this;return void Zt(o).then((t=>{if(e._timestampBuffer.set(t,n),e._timestampChunkCount--,0===e._timestampChunkCount){let t=0,n=0;const s=new Array,i=new BigInt64Array(e._timestampBuffer.buffer),r=Number(i[0])/1e6;for(let r=2,o=0;r<i.length;r+=2){const a=i[r],l=i[r+1],c=Number(l-a)/1e6;for(;o<e.commands.length;o++){const i=e.commands[o];if('beginRenderPass'===i.method||'beginComputePass'===i.method){if(i.duration=c,i.startTime=Number(a)/1e6,i.endTime=Number(l)/1e6,s.push(i),i.header)if('beginRenderPass'===i.method){const e=`Render Pass ${t} Duration: ${i.duration}ms`;i.header.text=e,t++}else{const e=`Compute Pass ${n} Duration: ${i.duration}ms`;i.header.text=e,n++}o++;break}}}s.sort(((e,t)=>e.startTime-t.startTime));for(const e of s)console.log(`${e.startTime-r}: [${e.id}]: ${e.method} -> ${e.duration}ms`);e.onUpdateCaptureStatus.emit()}})).catch((t=>{console.error(t.message),e.onUpdateCaptureStatus.emit()}))}let a=this.commands[e];a||(a=this._pendingCommandBufferData[e]??{},this._pendingCommandBufferData[e]=a);const l=this;Zt(o).then((o=>{const a=l.commands[e]??l._pendingCommandBufferData[e];l._addDataMembersToCommand(a,t,s,r),l._loadedDataChunks--;try{a.bufferData[t].set(o,n),a.loadedDataChunks[t][i]=!0}catch(e){console.log(e),a.loadedDataChunks[t].length=0,a.isBufferDataLoaded[t]=!1}let c=!0;for(let e=0;e<r;++e)if(!a.loadedDataChunks[t][e]){c=!1;break}a.isBufferDataLoaded[t]=c,a.isBufferDataLoaded[t]&&(l._loadingBuffers--,a.loadedDataChunks[t].length=0),l.onUpdateCaptureStatus.emit()})).catch((e=>{console.error(e),l._loadedDataChunks--,a.loadedDataChunks[t][i]=!0;let n=!0;for(let e=0;e<r;++e)if(!a.loadedDataChunks[t][e]){n=!1;break}a.isBufferDataLoaded[t]=n,a.isBufferDataLoaded[t]&&(l._loadingBuffers--,a.loadedDataChunks[t].length=0),l.onUpdateCaptureStatus.emit()}))}_addDataMembersToCommand(e,t,n,s){e.bufferData||(e.bufferData=[]),e.dataPending||(e.dataPending=[]),e.bufferData[t]||(e.bufferData[t]=new Uint8Array(n),e.dataPending[t]=!0),e.loadedDataChunks||(e.loadedDataChunks=[]),e.loadedDataChunks[t]||(e.loadedDataChunks[t]=[]),e.loadedDataChunks[t].length!==s&&(e.loadedDataChunks[t].length=s),e.isBufferDataLoaded||(e.isBufferDataLoaded=[])}}class en extends At{constructor(e,t,n){super(t,n),this.orientation=e,this._mousePressed=!1,this._mouseX=0,this._mouseY=0,this._prevWidget=null,this._nextWidget=null,this._splitIndex=0,this._element.classList.add('splitbar'),this.orientation==en.Horizontal?(this._element.style.height=`${en.size}px`,this._element.style.width='100%',this._element.style.cursor='n-resize'):(this._element.style.width=`${en.size}px`,this._element.style.height='100%',this._element.style.cursor='e-resize'),this.enablePointerEvents()}pointerDownEvent(e){this._mousePressed=!0,this._mouseX=e.clientX,this._mouseY=e.clientY;for(let e=0;e<this.parent.children.length;++e){if(this.parent.children[e]===this){this._splitIndex=e,this._prevWidget=this.parent.children[e-1],this._nextWidget=this.parent.children[e+1];break}}this._prevWidget&&this._prevWidget._startResize(),this._nextWidget&&this._nextWidget._startResize(),this.element.setPointerCapture(e.pointerId)}pointerMoveEvent(e){if(this._mousePressed){if(this.orientation===en.Horizontal){const t=e.clientY-this._mouseY;if(0!=t)if(0===this.parent.mode){const e=t/this.parent.height;this.parent.position+=e}else this.parent.position+=t}else{const t=e.clientX-this._mouseX;if(0!=t)if(0===this.parent.mode){const e=t/this.parent.width;this.parent.position+=e}else this.parent.position+=t}return this._mouseX=e.clientX,this._mouseY=e.clientY,!1}}pointerUpEvent(){this._prevWidget=null,this._nextWidget=null,this._mousePressed=!1,$t.disablePaintingOnResize=!1;for(let e of this.parent.children)e.repaint(!0);return!1}}en.isSplitBar=!0,en.Horizontal=0,en.Vertical=1,en.size=6;class tn extends At{constructor(e,t){super(e),this.classList.add('split','disable-selection'),this._direction=tn.Horizontal,this._position=.5,this.mode=tn.Percentage,t&&this.configure(t),this._direction===tn.Horizontal?this.classList.add('hsplit'):this.classList.add('vsplit')}configure(e){void 0!==e.direction&&(this._direction=e.direction),super.configure(e),void 0!==e.position&&(this.position=e.position,this.position>1&&(this.mode=tn.Pixel))}get direction(){return this._direction}get position(){return this._position}set position(e){this._position=e,this.updatePosition()}updatePosition(){if(this.children.length<3)return;const e=(this.children.length-2)*en.size;let t,n;if(this._position<1){const s=100*this._position;t=`${s}%`,n=`calc(${100-s}% - ${e}px)`}else t=`${this._position}px`,n=`calc(100% - ${this._position}px - ${e}px)`;this._direction==tn.Horizontal?(this.children[0].style.width=t,this.children[0].element.width='0',this.children[2].style.width=n,this.children[2].element.width='0'):(this.children[0].element.height='0',this.children[0].style.height=t,this.children[2].style.height=n,this.children[2].element.height='0'),this.onResize()}appendChild(e){if(this.direction==tn.Horizontal&&(e.style.display='inline-block'),0==this.children.length||e.constructor.isSplitBar)return 0==this.children.length?(e.style.width='100%',e.style.height='100%'):this._direction==tn.Horizontal?e.style.height='100%':e.style.width='100%',void super.appendChild(e);const t=1/(this.children.length+1)*100;new en(this._direction==tn.Horizontal?en.Vertical:en.Horizontal,this),super.appendChild(e);const n=(this.children.length-2)*en.size;for(const e of this.children)e.constructor.isSplitBar||(e===this.children[this.children.length-1]?this._direction==tn.Horizontal?(e.element.width='0',e.style.height='100%',e.style.width=`calc(${100-t}% - ${n}px)`):(e.element.height='0',e.style.width='100%',e.style.height=`calc(${100-t}% - ${n}px)`):this._direction==tn.Horizontal?e.style.width=`${t}%`:e.style.height=`${t}%`),e.onResize();.5!=this._position&&this.updatePosition()}}tn.Horizontal=0,tn.Vertical=1,tn.Percentage=0,tn.Pixel=1;class nn extends $t{constructor(e,t){super('img',e,t)}get src(){return this.element.src}set src(e){this.element.src=e}configure(e){e&&(super.configure(e),void 0!==e.src&&(this.element.src=e.src))}}class sn{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class rn{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class on extends sn{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class an extends sn{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}}class ln extends sn{constructor(e,t,n,s){super(e,n),this.format=t,this.access=s}get isTemplate(){return!0}}var cn,hn,un,dn,fn;(e=>{e[e.Uniform=0]='Uniform',e[e.Storage=1]='Storage',e[e.Texture=2]='Texture',e[e.Sampler=3]='Sampler',e[e.StorageTexture=4]='StorageTexture'})(cn||(cn={}));class pn{constructor(e,t,n,s,i,r,o){this.name=e,this.type=t,this.group=n,this.binding=s,this.attributes=i,this.resourceType=r,this.access=o}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class mn{constructor(e,t){this.name=e,this.type=t}}class gn{constructor(e,t,n,s){this.name=e,this.type=t,this.locationType=n,this.location=s,this.interpolation=null}}class vn{constructor(e,t,n,s){this.name=e,this.type=t,this.locationType=n,this.location=s}}class xn{constructor(e,t,n,s){this.name=e,this.type=t,this.attributes=n,this.id=s}}class bn{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n}}class yn{constructor(e,t=null,n){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=n}}class _n{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class wn{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class kn{constructor(){this.id=kn._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return''}constEvaluate(e,t){throw new Error('Cannot evaluate node')}constEvaluateString(e){return this.constEvaluate(e).toString()}search(e){}searchBlock(e,t){if(e){t(On.instance);for(const n of e)n instanceof Array?this.searchBlock(n,t):n.search(t);t(Sn.instance)}}}kn._id=0;class On extends kn{}On.instance=new On;class Sn extends kn{}Sn.instance=new Sn;class Tn extends kn{constructor(){super()}}class In extends Tn{constructor(e,t,n,s,i,r){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=n,this.body=s,this.startLine=i,this.endLine=r}get astNodeType(){return'function'}search(e){this.searchBlock(this.body,e)}}class Cn extends Tn{constructor(e){super(),this.expression=e}get astNodeType(){return'staticAssert'}search(e){this.expression.search(e)}}class $n extends Tn{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return'while'}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class An extends Tn{constructor(e){super(),this.body=e}get astNodeType(){return'continuing'}search(e){this.searchBlock(this.body,e)}}class En extends Tn{constructor(e,t,n,s){super(),this.init=e,this.condition=t,this.increment=n,this.body=s}get astNodeType(){return'for'}search(e){var t,n,s;null===(t=this.init)||void 0===t||t.search(e),null===(n=this.condition)||void 0===n||n.search(e),null===(s=this.increment)||void 0===s||s.search(e),this.searchBlock(this.body,e)}}class Pn extends Tn{constructor(e,t,n,s,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=s,this.value=i}get astNodeType(){return'var'}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}class Dn extends Tn{constructor(e,t,n){super(),this.attributes=null,this.name=e,this.type=t,this.value=n}get astNodeType(){return'override'}search(e){var t;null===(t=this.value)||void 0===t||t.search(e)}}class Mn extends Tn{constructor(e,t,n,s,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=s,this.value=i}get astNodeType(){return'let'}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}class Ln extends Tn{constructor(e,t,n,s,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=s,this.value=i}get astNodeType(){return'const'}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}(e=>{e.increment='++',e.decrement='--'})(hn||(hn={})),(e=>{e.parse=function(t){const n=t;if('parse'==n)throw new Error('Invalid value for IncrementOperator');return e[n]}})(hn||(hn={}));class Bn extends Tn{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return'increment'}search(e){this.variable.search(e)}}(e=>{e.assign='=',e.addAssign='+=',e.subtractAssin='-=',e.multiplyAssign='*=',e.divideAssign='/=',e.moduloAssign='%=',e.andAssign='&=',e.orAssign='|=',e.xorAssign='^=',e.shiftLeftAssign='<<=',e.shiftRightAssign='>>='})(un||(un={})),(e=>{e.parse=function(e){const t=e;if('parse'==t)throw new Error('Invalid value for AssignOperator');return t}})(un||(un={}));class Nn extends Tn{constructor(e,t,n){super(),this.operator=e,this.variable=t,this.value=n}get astNodeType(){return'assign'}search(e){this.variable.search(e),this.value.search(e)}}class Rn extends Tn{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return'call'}search(e){for(const t of this.args)t.search(e);e(this)}}class Fn extends Tn{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return'loop'}}class Vn extends Tn{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return'body'}}class zn extends Tn{constructor(e,t,n,s){super(),this.condition=e,this.body=t,this.elseif=n,this.else=s}get astNodeType(){return'if'}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class Un extends Tn{constructor(e){super(),this.value=e}get astNodeType(){return'return'}search(e){var t;null===(t=this.value)||void 0===t||t.search(e)}}class Wn extends Tn{constructor(e){super(),this.name=e}get astNodeType(){return'enable'}}class Qn extends Tn{constructor(e){super(),this.extensions=e}get astNodeType(){return'requires'}}class jn extends Tn{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return'diagnostic'}}class Xn extends Tn{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return'alias'}}class Gn extends Tn{constructor(){super()}get astNodeType(){return'discard'}}class qn extends Tn{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return'break'}}class Hn extends Tn{constructor(){super(),this.loopId=-1}get astNodeType(){return'continue'}}class Yn extends Tn{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return'type'}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(e){let t=e[0];if('f32'===t.name)return t;for(let n=1;n<e.length;++n){const s=Yn._priority.get(t.name);Yn._priority.get(e[n].name)<s&&(t=e[n])}return'x32'===t.name?Yn.i32:t}}Yn.x32=new Yn('x32'),Yn.f32=new Yn('f32'),Yn.i32=new Yn('i32'),Yn.u32=new Yn('u32'),Yn.f16=new Yn('f16'),Yn.bool=new Yn('bool'),Yn._priority=new Map([['f32',0],['f16',1],['u32',2],['i32',3],['x32',3]]);class Kn extends Yn{constructor(e,t,n,s){super(e),this.members=t,this.startLine=n,this.endLine=s}get astNodeType(){return'struct'}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}}class Zn extends Yn{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return'template'}}Zn.vec2f=new Zn('vec2',Yn.f32,null),Zn.vec3f=new Zn('vec3',Yn.f32,null),Zn.vec4f=new Zn('vec4',Yn.f32,null),Zn.vec2i=new Zn('vec2',Yn.i32,null),Zn.vec3i=new Zn('vec3',Yn.i32,null),Zn.vec4i=new Zn('vec4',Yn.i32,null),Zn.vec2u=new Zn('vec2',Yn.u32,null),Zn.vec3u=new Zn('vec3',Yn.u32,null),Zn.vec4u=new Zn('vec4',Yn.u32,null),Zn.vec2h=new Zn('vec2',Yn.f16,null),Zn.vec3h=new Zn('vec3',Yn.f16,null),Zn.vec4h=new Zn('vec4',Yn.f16,null),Zn.vec2b=new Zn('vec2',Yn.bool,null),Zn.vec3b=new Zn('vec3',Yn.bool,null),Zn.vec4b=new Zn('vec4',Yn.bool,null),Zn.mat2x2f=new Zn('mat2x2',Yn.f32,null),Zn.mat2x3f=new Zn('mat2x3',Yn.f32,null),Zn.mat2x4f=new Zn('mat2x4',Yn.f32,null),Zn.mat3x2f=new Zn('mat3x2',Yn.f32,null),Zn.mat3x3f=new Zn('mat3x3',Yn.f32,null),Zn.mat3x4f=new Zn('mat3x4',Yn.f32,null),Zn.mat4x2f=new Zn('mat4x2',Yn.f32,null),Zn.mat4x3f=new Zn('mat4x3',Yn.f32,null),Zn.mat4x4f=new Zn('mat4x4',Yn.f32,null),Zn.mat2x2h=new Zn('mat2x2',Yn.f16,null),Zn.mat2x3h=new Zn('mat2x3',Yn.f16,null),Zn.mat2x4h=new Zn('mat2x4',Yn.f16,null),Zn.mat3x2h=new Zn('mat3x2',Yn.f16,null),Zn.mat3x3h=new Zn('mat3x3',Yn.f16,null),Zn.mat3x4h=new Zn('mat3x4',Yn.f16,null),Zn.mat4x2h=new Zn('mat4x2',Yn.f16,null),Zn.mat4x3h=new Zn('mat4x3',Yn.f16,null),Zn.mat4x4h=new Zn('mat4x4',Yn.f16,null);class Jn extends Yn{constructor(e,t,n,s){super(e),this.storage=t,this.type=n,this.access=s}get astNodeType(){return'pointer'}}class es extends Yn{constructor(e,t,n,s){super(e),this.attributes=t,this.format=n,this.count=s}get astNodeType(){return'array'}get isArray(){return!0}}class ts extends Yn{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return'sampler'}}class ns extends kn{constructor(){super(),this.postfix=null}}class ss extends ns{constructor(e){super(),this.value=e}get astNodeType(){return'stringExpr'}toString(){return this.value}constEvaluateString(){return this.value}}class is extends ns{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return'createExpr'}search(e){if(e(this),this.args)for(const t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}}class rs extends ns{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return'callExpr'}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return rs.builtinFunctionNames.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(const t of this.args)t.search(e);e(this)}}rs.builtinFunctionNames=new Set(['all','all','any','select','arrayLength','abs','acos','acosh','asin','asinh','atan','atanh','atan2','ceil','clamp','cos','cosh','countLeadingZeros','countOneBits','countTrailingZeros','cross','degrees','determinant','distance','dot','dot4U8Packed','dot4I8Packed','exp','exp2','extractBits','faceForward','firstLeadingBit','firstTrailingBit','floor','fma','fract','frexp','insertBits','inverseSqrt','ldexp','length','log','log2','max','min','mix','modf','normalize','pow','quantizeToF16','radians','reflect','refract','reverseBits','round','saturate','sign','sin','sinh','smoothStep','sqrt','step','tan','tanh','transpose','trunc','dpdx','dpdxCoarse','dpdxFine','dpdy','dpdyCoarse','dpdyFine','fwidth','fwidthCoarse','fwidthFine','textureDimensions','textureGather','textureGatherCompare','textureLoad','textureNumLayers','textureNumLevels','textureNumSamples','textureSample','textureSampleBias','textureSampleCompare','textureSampleCompareLevel','textureSampleGrad','textureSampleLevel','textureSampleBaseClampToEdge','textureStore','atomicLoad','atomicStore','atomicAdd','atomicSub','atomicMax','atomicMin','atomicAnd','atomicOr','atomicXor','atomicExchange','atomicCompareExchangeWeak','pack4x8snorm','pack4x8unorm','pack4xI8','pack4xU8','pack4x8Clamp','pack4xU8Clamp','pack2x16snorm','pack2x16unorm','pack2x16float','unpack4x8snorm','unpack4x8unorm','unpack4xI8','unpack4xU8','unpack2x16snorm','unpack2x16unorm','unpack2x16float','storageBarrier','textureBarrier','workgroupBarrier','workgroupUniformLoad','subgroupAdd','subgroupExclusiveAdd','subgroupInclusiveAdd','subgroupAll','subgroupAnd','subgroupAny','subgroupBallot','subgroupBroadcast','subgroupBroadcastFirst','subgroupElect','subgroupMax','subgroupMin','subgroupMul','subgroupExclusiveMul','subgroupInclusiveMul','subgroupOr','subgroupShuffle','subgroupShuffleDown','subgroupShuffleUp','subgroupShuffleXor','subgroupXor','quadBroadcast','quadSwapDiagonal','quadSwapX','quadSwapY']);class os extends ns{constructor(e){super(),this.name=e}get astNodeType(){return'varExpr'}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}}class as extends ns{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return'constExpr'}constEvaluate(e,t){if(this.initializer){const t=e.evalExpression(this.initializer,e.context);return null!==t&&this.postfix?t.getDataValue(e,this.postfix,e.context):t}return null}search(e){this.initializer.search(e)}}class ls extends ns{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return'literalExpr'}constEvaluate(e,t){return void 0!==t&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof Os}get isVector(){return this.value instanceof Ts||this.value instanceof Is}get scalarValue(){return this.value instanceof Os?this.value.value:(console.error('Value is not scalar.'),0)}get vectorValue(){return this.value instanceof Ts||this.value instanceof Is?this.value.value:(console.error('Value is not a vector or matrix.'),[])}}class cs extends ns{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return'bitcastExpr'}search(e){this.value.search(e)}}class hs extends ns{constructor(e){super(),this.contents=e}get astNodeType(){return'groupExpr'}constEvaluate(e,t){return this.contents[0].constEvaluate(e,t)}search(e){this.searchBlock(this.contents,e)}}class us extends ns{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class ds extends ns{constructor(){super()}}class fs extends ds{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return'unaryOp'}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}}class ps extends ds{constructor(e,t,n){super(),this.operator=e,this.left=t,this.right=n}get astNodeType(){return'binaryOp'}_getPromotedType(e,t){return e.name===t.name?e:'f32'===e.name||'f32'===t.name?Yn.f32:'u32'===e.name||'u32'===t.name?Yn.u32:Yn.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}}class ms extends kn{constructor(){super()}}class gs extends ms{constructor(e,t){super(),this.selector=e,this.body=t}get astNodeType(){return'case'}search(e){this.searchBlock(this.body,e)}}class vs extends ms{constructor(e){super(),this.body=e}get astNodeType(){return'default'}search(e){this.searchBlock(this.body,e)}}class xs extends kn{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return'argument'}}class bs extends kn{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return'elseif'}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class ys extends kn{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return'member'}}class _s extends kn{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return'attribute'}}class ws{constructor(e){this.typeInfo=e}setDataValue(e,t,n,s){console.error('SetDataValue: Not implemented',t,n)}getDataValue(e,t,n){return console.error('GetDataValue: Not implemented',t),null}toString(){return`<${this.typeInfo.name}>`}}class ks extends ws{constructor(){super(new sn('void',null))}toString(){return'void'}}ks.void=new ks;class Os extends ws{constructor(e,t){super(t),'i32'===this.typeInfo.name||'u32'===this.typeInfo.name?e=Math.floor(e):'bool'===this.typeInfo.name&&(e=e?1:0),this.value=e}setDataValue(e,t,n,s){n?console.error('SetDataValue: Scalar data does not support postfix',n):t instanceof Os?(t.value,'i32'===this.typeInfo.name||'u32'===this.typeInfo.name||this.typeInfo.name,this.value=t.value):console.error('SetDataValue: Invalid value',t)}getDataValue(e,t,n){return t?(console.error('GetDataValue: Scalar data does not support postfix',t),null):this}toString(){return`${this.value}`}}function Ss(e,t,n){const s=t.length;return 2===s?'f32'===n?new Ts(t,e.getTypeInfo('vec2f')):'i32'===n?new Ts(t,e.getTypeInfo('vec2i')):'u32'===n?new Ts(t,e.getTypeInfo('vec2u')):'f16'===n?new Ts(t,e.getTypeInfo('vec2h')):(console.error(`GetDataValue: Unknown format ${n}`),null):3===s?'f32'===n?new Ts(t,e.getTypeInfo('vec3f')):'i32'===n?new Ts(t,e.getTypeInfo('vec3i')):'u32'===n?new Ts(t,e.getTypeInfo('vec3u')):'f16'===n?new Ts(t,e.getTypeInfo('vec3h')):(console.error(`GetDataValue: Unknown format ${n}`),null):4===s?'f32'===n?new Ts(t,e.getTypeInfo('vec4f')):'i32'===n?new Ts(t,e.getTypeInfo('vec4i')):'u32'===n?new Ts(t,e.getTypeInfo('vec4u')):'f16'===n?new Ts(t,e.getTypeInfo('vec4h')):(console.error(`GetDataValue: Unknown format ${n}`),null):(console.error(`GetDataValue: Invalid vector size ${t.length}`),null)}class Ts extends ws{constructor(e,t){super(t),Array.isArray(e)?this.value=e:this.value=Array.from(e)}setDataValue(e,t,n,s){n instanceof ss?console.error('TODO: Set vector postfix'):t instanceof Ts?this.value=t.value:console.error('SetDataValue: Invalid value',t)}getDataValue(e,t,n){let s=e.getTypeInfo('f32');if(this.typeInfo instanceof ln)s=this.typeInfo.format;else{const t=this.typeInfo.name;'vec2f'===t||'vec3f'===t||'vec4f'===t?s=e.getTypeInfo('f32'):'vec2i'===t||'vec3i'===t||'vec4i'===t?s=e.getTypeInfo('i32'):'vec2u'===t||'vec3u'===t||'vec4u'===t?s=e.getTypeInfo('u32'):'vec2h'===t||'vec3h'===t||'vec4h'===t?s=e.getTypeInfo('f16'):console.error(`GetDataValue: Unknown type ${t}`)}if(t instanceof us){const i=t.index;let r=-1;if(i instanceof ls){if(!(i.value instanceof Os))return console.error(`GetValueData: Invalid array index ${i.value}`),null;r=i.value.value}else{const t=e.evalExpression(i,n);if(!(t instanceof Os))return console.error('GetDataValue: Unknown index type',i),null;r=t.value}return r<0||r>=this.value.length?(console.error('GetDataValue: Index out of range',r),null):new Os(this.value[r],s)}if(t instanceof ss){const n=t.value,i=[];for(const e of n)'x'===e||'r'===e?i.push(this.value[0]):'y'===e||'g'===e?i.push(this.value[1]):'z'===e||'b'===e?i.push(this.value[2]):'w'===e||'a'===e?i.push(this.value[3]):console.error(`GetDataValue: Unknown member ${e}`);return 1===i.length?new Os(i[0],s):Ss(e,i,s.name)}return this}toString(){let e=`${this.value[0]}`;for(let t=1;t<this.value.length;++t)e+=`, ${this.value[t]}`;return e}}class Is extends ws{constructor(e,t){super(t),this.value=e}setDataValue(e,t,n,s){n instanceof ss?console.error('TODO: Set matrix postfix'):t instanceof Is?this.value=t.value:console.error('SetDataValue: Invalid value',t)}getDataValue(e,t,n){const s=this.typeInfo.name;let i=e.getTypeInfo('f32');if(this.typeInfo instanceof ln)i=this.typeInfo.format;else if(s.endsWith('f'))i=e.getTypeInfo('f32');else if(s.endsWith('i'))i=e.getTypeInfo('i32');else if(s.endsWith('u'))i=e.getTypeInfo('u32');else{if(!s.endsWith('h'))return console.error(`GetDataValue: Unknown type ${s}`),null;i=e.getTypeInfo('f16')}if(t instanceof us){const r=t.index;let o,a=-1;if(r instanceof ls){if(!(r.value instanceof Os))return console.error(`GetDataValue: Invalid array index ${r.value}`),null;a=r.value.value}else{const t=e.evalExpression(r,n);if(!(t instanceof Os))return console.error('GetDataValue: Unknown index type',r),null;a=t.value}if(a<0||a>=this.value.length)return console.error('GetDataValue: Index out of range',a),null;if('mat2x2'===s||'mat2x2f'===s||'mat2x2h'===s)o=this.value.slice(2*a,2*a+2);else if('mat2x3'===s||'mat2x3f'===s||'mat2x3h'===s)o=this.value.slice(3*a,3*a+3);else if('mat2x4'===s||'mat2x4f'===s||'mat2x4h'===s)o=this.value.slice(4*a,4*a+4);else if('mat3x2'===s||'mat3x2f'===s||'mat3x2h'===s)o=this.value.slice(2*a,2*a+2);else if('mat3x3'===s||'mat3x3f'===s||'mat3x3h'===s)o=this.value.slice(3*a,3*a+3);else if('mat3x4'===s||'mat3x4f'===s||'mat3x4h'===s)o=this.value.slice(4*a,4*a+4);else if('mat4x2'===s||'mat4x2f'===s||'mat4x2h'===s)o=this.value.slice(2*a,2*a+2);else if('mat4x3'===s||'mat4x3f'===s||'mat4x3h'===s)o=this.value.slice(3*a,3*a+3);else{if('mat4x4'!==s&&'mat4x4f'!==s&&'mat4x4h'!==s)return console.error(`GetDataValue: Unknown type ${s}`),null;o=this.value.slice(4*a,4*a+4)}const l=Ss(e,o,i.name);if(t.postfix)return l.getDataValue(e,t.postfix,n)}return this}toString(){let e=`${this.value[0]}`;for(let t=1;t<this.value.length;++t)e+=`, ${this.value[t]}`;return e}}class Cs extends ws{constructor(e,t,n=0,s){super(t),this.textureSize=[0,0,0],this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=n,void 0!==s&&(this.textureSize=s)}setDataValue(e,t,n,s){if(null===t)return void console.log('setDataValue: NULL data.');let i=this.offset,r=this.typeInfo;for(;n;){if(n instanceof us)if(r instanceof an){const t=n.index;if(t instanceof ls){if(!(t.value instanceof Os))return void console.error(`SetDataValue: Invalid index type ${t.value}`);i+=t.value.value*r.stride}else{const n=e.evalExpression(t,s);if(!(n instanceof Os))return void console.error('SetDataValue: Unknown index type',t);i+=n.value*r.stride}r=r.format}else console.error(`SetDataValue: Type ${e.getTypeName(r)} is not an array`);else{if(!(n instanceof ss))return void console.error('SetDataValue: Unknown postfix type',n);{const s=n.value;if(r instanceof on){let e=!1;for(const t of r.members)if(t.name===s){i+=t.offset,r=t.type,e=!0;break}if(!e)return void console.error(`SetDataValue: Member ${s} not found`)}else if(r instanceof sn){const n=e.getTypeName(r);let o=0;if('x'===s||'r'===s)o=0;else if('y'===s||'g'===s)o=1;else if('z'===s||'b'===s)o=2;else{if('w'!==s&&'a'!==s)return void console.error(`SetDataValue: Unknown member ${s}`);o=3}if(!(t instanceof Os))return void console.error('SetDataValue: Invalid value',t);const a=t.value;return'vec2f'===n?void(new Float32Array(this.buffer,i,2)[o]=a):'vec3f'===n?void(new Float32Array(this.buffer,i,3)[o]=a):'vec4f'===n?void(new Float32Array(this.buffer,i,4)[o]=a):'vec2i'===n?void(new Int32Array(this.buffer,i,2)[o]=a):'vec3i'===n?void(new Int32Array(this.buffer,i,3)[o]=a):'vec4i'===n?void(new Int32Array(this.buffer,i,4)[o]=a):'vec2u'===n?void(new Uint32Array(this.buffer,i,2)[o]=a):'vec3u'===n?void(new Uint32Array(this.buffer,i,3)[o]=a):'vec4u'===n?void(new Uint32Array(this.buffer,i,4)[o]=a):void console.error(`SetDataValue: Type ${n} is not a struct`)}}}n=n.postfix}this.setData(e,t,r,i,s)}setData(e,t,n,s,i){const r=e.getTypeName(n);if('f32'!==r&&'f16'!==r)if('i32'!==r&&'atomic<i32>'!==r&&'x32'!==r)if('u32'!==r&&'atomic<u32>'!==r)if('bool'!==r)if('vec2f'!==r&&'vec2h'!==r)if('vec3f'!==r&&'vec3h'!==r)if('vec4f'!==r&&'vec4h'!==r)if('vec2i'!==r)if('vec3i'!==r)if('vec4i'!==r)if('vec2u'!==r)if('vec3u'!==r)if('vec4u'!==r)if('vec2b'!==r)if('vec3b'!==r)if('vec4b'!==r)if('mat2x2f'!==r&&'mat2x2h'!==r)if('mat2x3f'!==r&&'mat2x3h'!==r)if('mat2x4f'!==r&&'mat2x4h'!==r)if('mat3x2f'!==r&&'mat3x2h'!==r)if('mat3x3f'!==r&&'mat3x3h'!==r)if('mat3x4f'!==r&&'mat3x4h'!==r)if('mat4x2f'!==r&&'mat4x2h'!==r)if('mat4x3f'!==r&&'mat4x3h'!==r)if('mat4x4f'!==r&&'mat4x4h'!==r)if(t instanceof Cs){if(n===t.typeInfo){return void new Uint8Array(this.buffer,s,t.buffer.byteLength).set(new Uint8Array(t.buffer))}console.error('SetDataValue: Type mismatch',r,e.getTypeName(t.typeInfo))}else console.error(`SetData: Unknown type ${r}`);else{const e=new Float32Array(this.buffer,s,16);t instanceof Is?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5],e[6]=t.value[6],e[7]=t.value[7],e[8]=t.value[8],e[9]=t.value[9],e[10]=t.value[10],e[11]=t.value[11],e[12]=t.value[12],e[13]=t.value[13],e[14]=t.value[14],e[15]=t.value[15]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15])}else{const e=new Float32Array(this.buffer,s,12);t instanceof Is?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5],e[6]=t.value[6],e[7]=t.value[7],e[8]=t.value[8],e[9]=t.value[9],e[10]=t.value[10],e[11]=t.value[11]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11])}else{const e=new Float32Array(this.buffer,s,8);t instanceof Is?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5],e[6]=t.value[6],e[7]=t.value[7]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7])}else{const e=new Float32Array(this.buffer,s,12);t instanceof Is?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5],e[6]=t.value[6],e[7]=t.value[7],e[8]=t.value[8],e[9]=t.value[9],e[10]=t.value[10],e[11]=t.value[11]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11])}else{const e=new Float32Array(this.buffer,s,9);t instanceof Is?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5],e[6]=t.value[6],e[7]=t.value[7],e[8]=t.value[8]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8])}else{const e=new Float32Array(this.buffer,s,6);t instanceof Is?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5])}else{const e=new Float32Array(this.buffer,s,8);t instanceof Is?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5],e[6]=t.value[6],e[7]=t.value[7]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7])}else{const e=new Float32Array(this.buffer,s,6);t instanceof Is?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3],e[4]=t.value[4],e[5]=t.value[5]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5])}else{const e=new Float32Array(this.buffer,s,4);t instanceof Is?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Uint32Array(this.buffer,s,4);t instanceof Ts?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Uint32Array(this.buffer,s,3);t instanceof Ts?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])}else{const e=new Uint32Array(this.buffer,s,2);t instanceof Ts?(e[0]=t.value[0],e[1]=t.value[1]):(e[0]=t[0],e[1]=t[1])}else{const e=new Uint32Array(this.buffer,s,4);t instanceof Ts?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Uint32Array(this.buffer,s,3);t instanceof Ts?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])}else{const e=new Uint32Array(this.buffer,s,2);t instanceof Ts?(e[0]=t.value[0],e[1]=t.value[1]):(e[0]=t[0],e[1]=t[1])}else{const e=new Int32Array(this.buffer,s,4);t instanceof Ts?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Int32Array(this.buffer,s,3);t instanceof Ts?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])}else{const e=new Int32Array(this.buffer,s,2);t instanceof Ts?(e[0]=t.value[0],e[1]=t.value[1]):(e[0]=t[0],e[1]=t[1])}else{const e=new Float32Array(this.buffer,s,4);t instanceof Ts?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2],e[3]=t.value[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Float32Array(this.buffer,s,3);t instanceof Ts?(e[0]=t.value[0],e[1]=t.value[1],e[2]=t.value[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])}else{const e=new Float32Array(this.buffer,s,2);t instanceof Ts?(e[0]=t.value[0],e[1]=t.value[1]):(e[0]=t[0],e[1]=t[1])}else t instanceof Os&&(new Int32Array(this.buffer,s,1)[0]=t.value);else t instanceof Os&&(new Uint32Array(this.buffer,s,1)[0]=t.value);else t instanceof Os&&(new Int32Array(this.buffer,s,1)[0]=t.value);else t instanceof Os&&(new Float32Array(this.buffer,s,1)[0]=t.value)}getDataValue(e,t,n){let s=this.offset,i=this.typeInfo;for(;t;){if(t instanceof us){const r=t.index,o=e.evalExpression(r,n);let a=0;if(o instanceof Os?a=o.value:console.error('GetDataValue: Invalid index type',r),i instanceof an)s+=a*i.stride,i=i.format;else{const t=e.getTypeName(i);'mat4x4'===t||'mat4x4f'===t||'mat4x4h'===t?(s+=16*a,i=e.getTypeInfo('vec4f')):console.error(`getDataValue: Type ${e.getTypeName(i)} is not an array`)}}else{if(!(t instanceof ss))return console.error('GetDataValue: Unknown postfix type',t),null;{const n=t.value;if(i instanceof on){let e=!1;for(const t of i.members)if(t.name===n){s+=t.offset,i=t.type,e=!0;break}if(!e)return console.error(`GetDataValue: Member ${n} not found`),null}else if(i instanceof sn){const t=e.getTypeName(i);if('vec2f'===t||'vec3f'===t||'vec4f'===t||'vec2i'===t||'vec3i'===t||'vec4i'===t||'vec2u'===t||'vec3u'===t||'vec4u'===t||'vec2b'===t||'vec3b'===t||'vec4b'===t||'vec2h'===t||'vec3h'===t||'vec4h'===t||'vec2'===t||'vec3'===t||'vec4'===t){if(n.length>0&&n.length<5){let r='f32',o='f';const a=[];for(let e=0;e<n.length;++e){const i=n[e].toLocaleLowerCase();let l=0;if('x'===i||'r'===i)l=0;else if('y'===i||'g'===i)l=1;else if('z'===i||'b'===i)l=2;else{if('w'!==i&&'a'!==i)return console.error(`Unknown member ${n}`),null;l=3}if('vec2f'===t)a.push(new Float32Array(this.buffer,s,2)[l]);else if('vec3f'===t){if(s+12>=this.buffer.byteLength)return console.log('Insufficient buffer data'),null;const e=new Float32Array(this.buffer,s,3);a.push(e[l])}else if('vec4f'===t)a.push(new Float32Array(this.buffer,s,4)[l]);else if('vec2i'===t)r='i32',o='i',a.push(new Int32Array(this.buffer,s,2)[l]);else if('vec3i'===t)r='i32',o='i',a.push(new Int32Array(this.buffer,s,3)[l]);else if('vec4i'===t)r='i32',o='i',a.push(new Int32Array(this.buffer,s,4)[l]);else if('vec2u'===t){r='u32',o='u';const e=new Uint32Array(this.buffer,s,2);a.push(e[l])}else'vec3u'===t?(r='u32',o='u',a.push(new Uint32Array(this.buffer,s,3)[l])):'vec4u'===t&&(r='u32',o='u',a.push(new Uint32Array(this.buffer,s,4)[l]))}return 1===a.length?new Os(a[0],e.getTypeInfo(r)):(2===a.length?i=e.getTypeInfo(`vec2${o}`):3===a.length?i=e.getTypeInfo(`vec3${o}`):4===a.length?i=e.getTypeInfo(`vec4${o}`):console.error(`GetDataValue: Invalid vector length ${a.length}`),new Ts(a,i))}return console.error(`GetDataValue: Unknown member ${n}`),null}return console.error(`GetDataValue: Type ${t} is not a struct`),null}}}t=t.postfix}const r=e.getTypeName(i);return'f32'===r?new Os(new Float32Array(this.buffer,s,1)[0],i):'i32'===r?new Os(new Int32Array(this.buffer,s,1)[0],i):'u32'===r?new Os(new Uint32Array(this.buffer,s,1)[0],i):'vec2f'===r?new Ts(new Float32Array(this.buffer,s,2),i):'vec3f'===r?new Ts(new Float32Array(this.buffer,s,3),i):'vec4f'===r?new Ts(new Float32Array(this.buffer,s,4),i):'vec2i'===r?new Ts(new Int32Array(this.buffer,s,2),i):'vec3i'===r?new Ts(new Int32Array(this.buffer,s,3),i):'vec4i'===r?new Ts(new Int32Array(this.buffer,s,4),i):'vec2u'===r?new Ts(new Uint32Array(this.buffer,s,2),i):'vec3u'===r?new Ts(new Uint32Array(this.buffer,s,3),i):'vec4u'===r?new Ts(new Uint32Array(this.buffer,s,4),i):i instanceof ln&&'atomic'===i.name?'u32'===i.format.name?new Os(new Uint32Array(this.buffer,s,1)[0],i.format):'i32'===i.format.name?new Os(new Int32Array(this.buffer,s,1)[0],i.format):(console.error(`GetDataValue: Invalid atomic format ${i.format.name}`),null):new Cs(this.buffer,i,s)}toString(){let e='';if(this.typeInfo instanceof an)if('f32'===this.typeInfo.format.name){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if('i32'===this.typeInfo.format.name){const t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if('u32'===this.typeInfo.format.name){const t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if('vec2f'===this.typeInfo.format.name){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let n=1;n<t.length/2;++n)e+=`, [${t[2*n]}, ${t[2*n+1]}]`}else if('vec3f'===this.typeInfo.format.name){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}]`}else if('vec4f'===this.typeInfo.format.name){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}, ${t[n+3]}]`}else e='[...]';else this.typeInfo instanceof on?e+='{...}':e='[...]';return e}}(e=>{e[e.token=0]='token',e[e.keyword=1]='keyword',e[e.reserved=2]='reserved'})(fn||(fn={}));class $s{constructor(e,t,n){this.name=e,this.type=t,this.rule=n}toString(){return this.name}}class As{}dn=As,As.none=new $s('',fn.reserved,''),As.eof=new $s('EOF',fn.token,''),As.reserved={asm:new $s('asm',fn.reserved,'asm'),bf16:new $s('bf16',fn.reserved,'bf16'),do:new $s('do',fn.reserved,'do'),enum:new $s('enum',fn.reserved,'enum'),f16:new $s('f16',fn.reserved,'f16'),f64:new $s('f64',fn.reserved,'f64'),handle:new $s('handle',fn.reserved,'handle'),i8:new $s('i8',fn.reserved,'i8'),i16:new $s('i16',fn.reserved,'i16'),i64:new $s('i64',fn.reserved,'i64'),mat:new $s('mat',fn.reserved,'mat'),premerge:new $s('premerge',fn.reserved,'premerge'),regardless:new $s('regardless',fn.reserved,'regardless'),typedef:new $s('typedef',fn.reserved,'typedef'),u8:new $s('u8',fn.reserved,'u8'),u16:new $s('u16',fn.reserved,'u16'),u64:new $s('u64',fn.reserved,'u64'),unless:new $s('unless',fn.reserved,'unless'),using:new $s('using',fn.reserved,'using'),vec:new $s('vec',fn.reserved,'vec'),void:new $s('void',fn.reserved,'void')},As.keywords={array:new $s('array',fn.keyword,'array'),atomic:new $s('atomic',fn.keyword,'atomic'),bool:new $s('bool',fn.keyword,'bool'),f32:new $s('f32',fn.keyword,'f32'),i32:new $s('i32',fn.keyword,'i32'),mat2x2:new $s('mat2x2',fn.keyword,'mat2x2'),mat2x3:new $s('mat2x3',fn.keyword,'mat2x3'),mat2x4:new $s('mat2x4',fn.keyword,'mat2x4'),mat3x2:new $s('mat3x2',fn.keyword,'mat3x2'),mat3x3:new $s('mat3x3',fn.keyword,'mat3x3'),mat3x4:new $s('mat3x4',fn.keyword,'mat3x4'),mat4x2:new $s('mat4x2',fn.keyword,'mat4x2'),mat4x3:new $s('mat4x3',fn.keyword,'mat4x3'),mat4x4:new $s('mat4x4',fn.keyword,'mat4x4'),ptr:new $s('ptr',fn.keyword,'ptr'),sampler:new $s('sampler',fn.keyword,'sampler'),sampler_comparison:new $s('sampler_comparison',fn.keyword,'sampler_comparison'),struct:new $s('struct',fn.keyword,'struct'),texture_1d:new $s('texture_1d',fn.keyword,'texture_1d'),texture_2d:new $s('texture_2d',fn.keyword,'texture_2d'),texture_2d_array:new $s('texture_2d_array',fn.keyword,'texture_2d_array'),texture_3d:new $s('texture_3d',fn.keyword,'texture_3d'),texture_cube:new $s('texture_cube',fn.keyword,'texture_cube'),texture_cube_array:new $s('texture_cube_array',fn.keyword,'texture_cube_array'),texture_multisampled_2d:new $s('texture_multisampled_2d',fn.keyword,'texture_multisampled_2d'),texture_storage_1d:new $s('texture_storage_1d',fn.keyword,'texture_storage_1d'),texture_storage_2d:new $s('texture_storage_2d',fn.keyword,'texture_storage_2d'),texture_storage_2d_array:new $s('texture_storage_2d_array',fn.keyword,'texture_storage_2d_array'),texture_storage_3d:new $s('texture_storage_3d',fn.keyword,'texture_storage_3d'),texture_depth_2d:new $s('texture_depth_2d',fn.keyword,'texture_depth_2d'),texture_depth_2d_array:new $s('texture_depth_2d_array',fn.keyword,'texture_depth_2d_array'),texture_depth_cube:new $s('texture_depth_cube',fn.keyword,'texture_depth_cube'),texture_depth_cube_array:new $s('texture_depth_cube_array',fn.keyword,'texture_depth_cube_array'),texture_depth_multisampled_2d:new $s('texture_depth_multisampled_2d',fn.keyword,'texture_depth_multisampled_2d'),texture_external:new $s('texture_external',fn.keyword,'texture_external'),u32:new $s('u32',fn.keyword,'u32'),vec2:new $s('vec2',fn.keyword,'vec2'),vec3:new $s('vec3',fn.keyword,'vec3'),vec4:new $s('vec4',fn.keyword,'vec4'),bitcast:new $s('bitcast',fn.keyword,'bitcast'),block:new $s('block',fn.keyword,'block'),break:new $s('break',fn.keyword,'break'),case:new $s('case',fn.keyword,'case'),continue:new $s('continue',fn.keyword,'continue'),continuing:new $s('continuing',fn.keyword,'continuing'),default:new $s('default',fn.keyword,'default'),diagnostic:new $s('diagnostic',fn.keyword,'diagnostic'),discard:new $s('discard',fn.keyword,'discard'),else:new $s('else',fn.keyword,'else'),enable:new $s('enable',fn.keyword,'enable'),fallthrough:new $s('fallthrough',fn.keyword,'fallthrough'),false:new $s('false',fn.keyword,'false'),fn:new $s('fn',fn.keyword,'fn'),for:new $s('for',fn.keyword,'for'),function:new $s('function',fn.keyword,'function'),if:new $s('if',fn.keyword,'if'),let:new $s('let',fn.keyword,'let'),const:new $s('const',fn.keyword,'const'),loop:new $s('loop',fn.keyword,'loop'),while:new $s('while',fn.keyword,'while'),private:new $s('private',fn.keyword,'private'),read:new $s('read',fn.keyword,'read'),read_write:new $s('read_write',fn.keyword,'read_write'),return:new $s('return',fn.keyword,'return'),requires:new $s('requires',fn.keyword,'requires'),storage:new $s('storage',fn.keyword,'storage'),switch:new $s('switch',fn.keyword,'switch'),true:new $s('true',fn.keyword,'true'),alias:new $s('alias',fn.keyword,'alias'),type:new $s('type',fn.keyword,'type'),uniform:new $s('uniform',fn.keyword,'uniform'),var:new $s('var',fn.keyword,'var'),override:new $s('override',fn.keyword,'override'),workgroup:new $s('workgroup',fn.keyword,'workgroup'),write:new $s('write',fn.keyword,'write'),r8unorm:new $s('r8unorm',fn.keyword,'r8unorm'),r8snorm:new $s('r8snorm',fn.keyword,'r8snorm'),r8uint:new $s('r8uint',fn.keyword,'r8uint'),r8sint:new $s('r8sint',fn.keyword,'r8sint'),r16uint:new $s('r16uint',fn.keyword,'r16uint'),r16sint:new $s('r16sint',fn.keyword,'r16sint'),r16float:new $s('r16float',fn.keyword,'r16float'),rg8unorm:new $s('rg8unorm',fn.keyword,'rg8unorm'),rg8snorm:new $s('rg8snorm',fn.keyword,'rg8snorm'),rg8uint:new $s('rg8uint',fn.keyword,'rg8uint'),rg8sint:new $s('rg8sint',fn.keyword,'rg8sint'),r32uint:new $s('r32uint',fn.keyword,'r32uint'),r32sint:new $s('r32sint',fn.keyword,'r32sint'),r32float:new $s('r32float',fn.keyword,'r32float'),rg16uint:new $s('rg16uint',fn.keyword,'rg16uint'),rg16sint:new $s('rg16sint',fn.keyword,'rg16sint'),rg16float:new $s('rg16float',fn.keyword,'rg16float'),rgba8unorm:new $s('rgba8unorm',fn.keyword,'rgba8unorm'),rgba8unorm_srgb:new $s('rgba8unorm_srgb',fn.keyword,'rgba8unorm_srgb'),rgba8snorm:new $s('rgba8snorm',fn.keyword,'rgba8snorm'),rgba8uint:new $s('rgba8uint',fn.keyword,'rgba8uint'),rgba8sint:new $s('rgba8sint',fn.keyword,'rgba8sint'),bgra8unorm:new $s('bgra8unorm',fn.keyword,'bgra8unorm'),bgra8unorm_srgb:new $s('bgra8unorm_srgb',fn.keyword,'bgra8unorm_srgb'),rgb10a2unorm:new $s('rgb10a2unorm',fn.keyword,'rgb10a2unorm'),rg11b10float:new $s('rg11b10float',fn.keyword,'rg11b10float'),rg32uint:new $s('rg32uint',fn.keyword,'rg32uint'),rg32sint:new $s('rg32sint',fn.keyword,'rg32sint'),rg32float:new $s('rg32float',fn.keyword,'rg32float'),rgba16uint:new $s('rgba16uint',fn.keyword,'rgba16uint'),rgba16sint:new $s('rgba16sint',fn.keyword,'rgba16sint'),rgba16float:new $s('rgba16float',fn.keyword,'rgba16float'),rgba32uint:new $s('rgba32uint',fn.keyword,'rgba32uint'),rgba32sint:new $s('rgba32sint',fn.keyword,'rgba32sint'),rgba32float:new $s('rgba32float',fn.keyword,'rgba32float'),static_assert:new $s('static_assert',fn.keyword,'static_assert')},As.tokens={decimal_float_literal:new $s('decimal_float_literal',fn.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new $s('hex_float_literal',fn.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new $s('int_literal',fn.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new $s('uint_literal',fn.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new $s('ident',fn.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new $s('and',fn.token,'&'),and_and:new $s('and_and',fn.token,'&&'),arrow:new $s('arrow ',fn.token,'->'),attr:new $s('attr',fn.token,'@'),forward_slash:new $s('forward_slash',fn.token,'/'),bang:new $s('bang',fn.token,'!'),bracket_left:new $s('bracket_left',fn.token,'['),bracket_right:new $s('bracket_right',fn.token,']'),brace_left:new $s('brace_left',fn.token,'{'),brace_right:new $s('brace_right',fn.token,'}'),colon:new $s('colon',fn.token,':'),comma:new $s('comma',fn.token,','),equal:new $s('equal',fn.token,'='),equal_equal:new $s('equal_equal',fn.token,'=='),not_equal:new $s('not_equal',fn.token,'!='),greater_than:new $s('greater_than',fn.token,'>'),greater_than_equal:new $s('greater_than_equal',fn.token,'>='),shift_right:new $s('shift_right',fn.token,'>>'),less_than:new $s('less_than',fn.token,'<'),less_than_equal:new $s('less_than_equal',fn.token,'<='),shift_left:new $s('shift_left',fn.token,'<<'),modulo:new $s('modulo',fn.token,'%'),minus:new $s('minus',fn.token,'-'),minus_minus:new $s('minus_minus',fn.token,'--'),period:new $s('period',fn.token,'.'),plus:new $s('plus',fn.token,'+'),plus_plus:new $s('plus_plus',fn.token,'++'),or:new $s('or',fn.token,'|'),or_or:new $s('or_or',fn.token,'||'),paren_left:new $s('paren_left',fn.token,'('),paren_right:new $s('paren_right',fn.token,')'),semicolon:new $s('semicolon',fn.token,';'),star:new $s('star',fn.token,'*'),tilde:new $s('tilde',fn.token,'~'),underscore:new $s('underscore',fn.token,'_'),xor:new $s('xor',fn.token,'^'),plus_equal:new $s('plus_equal',fn.token,'+='),minus_equal:new $s('minus_equal',fn.token,'-='),times_equal:new $s('times_equal',fn.token,'*='),division_equal:new $s('division_equal',fn.token,'/='),modulo_equal:new $s('modulo_equal',fn.token,'%='),and_equal:new $s('and_equal',fn.token,'&='),or_equal:new $s('or_equal',fn.token,'|='),xor_equal:new $s('xor_equal',fn.token,'^='),shift_right_equal:new $s('shift_right_equal',fn.token,'>>='),shift_left_equal:new $s('shift_left_equal',fn.token,'<<=')},As.simpleTokens={'@':dn.tokens.attr,'{':dn.tokens.brace_left,'}':dn.tokens.brace_right,':':dn.tokens.colon,',':dn.tokens.comma,'(':dn.tokens.paren_left,')':dn.tokens.paren_right,';':dn.tokens.semicolon},As.literalTokens={'&':dn.tokens.and,'&&':dn.tokens.and_and,'->':dn.tokens.arrow,'/':dn.tokens.forward_slash,'!':dn.tokens.bang,'[':dn.tokens.bracket_left,']':dn.tokens.bracket_right,'=':dn.tokens.equal,'==':dn.tokens.equal_equal,'!=':dn.tokens.not_equal,'>':dn.tokens.greater_than,'>=':dn.tokens.greater_than_equal,'>>':dn.tokens.shift_right,'<':dn.tokens.less_than,'<=':dn.tokens.less_than_equal,'<<':dn.tokens.shift_left,'%':dn.tokens.modulo,'-':dn.tokens.minus,'--':dn.tokens.minus_minus,'.':dn.tokens.period,'+':dn.tokens.plus,'++':dn.tokens.plus_plus,'|':dn.tokens.or,'||':dn.tokens.or_or,'*':dn.tokens.star,'~':dn.tokens.tilde,_:dn.tokens.underscore,'^':dn.tokens.xor,'+=':dn.tokens.plus_equal,'-=':dn.tokens.minus_equal,'*=':dn.tokens.times_equal,'/=':dn.tokens.division_equal,'%=':dn.tokens.modulo_equal,'&=':dn.tokens.and_equal,'|=':dn.tokens.or_equal,'^=':dn.tokens.xor_equal,'>>=':dn.tokens.shift_right_equal,'<<=':dn.tokens.shift_left_equal},As.regexTokens={decimal_float_literal:dn.tokens.decimal_float_literal,hex_float_literal:dn.tokens.hex_float_literal,int_literal:dn.tokens.int_literal,uint_literal:dn.tokens.uint_literal,ident:dn.tokens.ident},As.storage_class=[dn.keywords.function,dn.keywords.private,dn.keywords.workgroup,dn.keywords.uniform,dn.keywords.storage],As.access_mode=[dn.keywords.read,dn.keywords.write,dn.keywords.read_write],As.sampler_type=[dn.keywords.sampler,dn.keywords.sampler_comparison],As.sampled_texture_type=[dn.keywords.texture_1d,dn.keywords.texture_2d,dn.keywords.texture_2d_array,dn.keywords.texture_3d,dn.keywords.texture_cube,dn.keywords.texture_cube_array],As.multisampled_texture_type=[dn.keywords.texture_multisampled_2d],As.storage_texture_type=[dn.keywords.texture_storage_1d,dn.keywords.texture_storage_2d,dn.keywords.texture_storage_2d_array,dn.keywords.texture_storage_3d],As.depth_texture_type=[dn.keywords.texture_depth_2d,dn.keywords.texture_depth_2d_array,dn.keywords.texture_depth_cube,dn.keywords.texture_depth_cube_array,dn.keywords.texture_depth_multisampled_2d],As.texture_external_type=[dn.keywords.texture_external],As.any_texture_type=[...dn.sampled_texture_type,...dn.multisampled_texture_type,...dn.storage_texture_type,...dn.depth_texture_type,...dn.texture_external_type],As.texel_format=[dn.keywords.r8unorm,dn.keywords.r8snorm,dn.keywords.r8uint,dn.keywords.r8sint,dn.keywords.r16uint,dn.keywords.r16sint,dn.keywords.r16float,dn.keywords.rg8unorm,dn.keywords.rg8snorm,dn.keywords.rg8uint,dn.keywords.rg8sint,dn.keywords.r32uint,dn.keywords.r32sint,dn.keywords.r32float,dn.keywords.rg16uint,dn.keywords.rg16sint,dn.keywords.rg16float,dn.keywords.rgba8unorm,dn.keywords.rgba8unorm_srgb,dn.keywords.rgba8snorm,dn.keywords.rgba8uint,dn.keywords.rgba8sint,dn.keywords.bgra8unorm,dn.keywords.bgra8unorm_srgb,dn.keywords.rgb10a2unorm,dn.keywords.rg11b10float,dn.keywords.rg32uint,dn.keywords.rg32sint,dn.keywords.rg32float,dn.keywords.rgba16uint,dn.keywords.rgba16sint,dn.keywords.rgba16float,dn.keywords.rgba32uint,dn.keywords.rgba32sint,dn.keywords.rgba32float],As.const_literal=[dn.tokens.int_literal,dn.tokens.uint_literal,dn.tokens.decimal_float_literal,dn.tokens.hex_float_literal,dn.keywords.true,dn.keywords.false],As.literal_or_ident=[dn.tokens.ident,dn.tokens.int_literal,dn.tokens.uint_literal,dn.tokens.decimal_float_literal,dn.tokens.hex_float_literal],As.element_count_expression=[dn.tokens.int_literal,dn.tokens.uint_literal,dn.tokens.ident],As.template_types=[dn.keywords.vec2,dn.keywords.vec3,dn.keywords.vec4,dn.keywords.mat2x2,dn.keywords.mat2x3,dn.keywords.mat2x4,dn.keywords.mat3x2,dn.keywords.mat3x3,dn.keywords.mat3x4,dn.keywords.mat4x2,dn.keywords.mat4x3,dn.keywords.mat4x4,dn.keywords.atomic,dn.keywords.bitcast,...dn.any_texture_type],As.attribute_name=[dn.tokens.ident,dn.keywords.block,dn.keywords.diagnostic],As.assignment_operators=[dn.tokens.equal,dn.tokens.plus_equal,dn.tokens.minus_equal,dn.tokens.times_equal,dn.tokens.division_equal,dn.tokens.modulo_equal,dn.tokens.and_equal,dn.tokens.or_equal,dn.tokens.xor_equal,dn.tokens.shift_right_equal,dn.tokens.shift_left_equal],As.increment_operators=[dn.tokens.plus_plus,dn.tokens.minus_minus];class Es{constructor(e,t,n){this.type=e,this.lexeme=t,this.line=n}toString(){return this.lexeme}isTemplateType(){return-1!=As.template_types.indexOf(this.type)}isArrayType(){return this.type==As.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class Ps{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=null!=e?e:''}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new Es(As.eof,'',this._line)),this._tokens}scanToken(){let e=this._advance();if('\n'==e)return this._line++,!0;if(this._isWhitespace(e))return!0;if('/'==e){if('/'==this._peekAhead()){for(;'\n'!=e;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if('*'==this._peekAhead()){this._advance();let t=1;for(;t>0;){if(this._isAtEnd())return!0;if(e=this._advance(),'\n'==e)this._line++;else if('*'==e){if('/'==this._peekAhead()&&(this._advance(),t--,0==t))return!0}else'/'==e&&'*'==this._peekAhead()&&(this._advance(),t++)}return!0}}const t=As.simpleTokens[e];if(t)return this._addToken(t),!0;let n=As.none;const s=this._isAlpha(e),i='_'===e;if(this._isAlphaNumeric(e)){let t=this._peekAhead();for(;this._isAlphaNumeric(t);)e+=this._advance(),t=this._peekAhead()}if(s){const t=As.keywords[e];if(t)return this._addToken(t),!0}if(s||i)return this._addToken(As.tokens.ident),!0;for(;;){let t=this._findType(e);const s=this._peekAhead();if('-'==e&&this._tokens.length>0){if('='==s)return this._current++,e+=s,this._addToken(As.tokens.minus_equal),!0;if('-'==s)return this._current++,e+=s,this._addToken(As.tokens.minus_minus),!0;const n=this._tokens.length-1;if((-1!=As.literal_or_ident.indexOf(this._tokens[n].type)||this._tokens[n].type==As.tokens.paren_right)&&'>'!=s)return this._addToken(t),!0}if('>'==e&&('>'==s||'='==s)){let e=!1,n=this._tokens.length-1;for(let t=0;t<5&&n>=0&&-1===As.assignment_operators.indexOf(this._tokens[n].type);++t,--n)if(this._tokens[n].type===As.tokens.less_than){n>0&&this._tokens[n-1].isArrayOrTemplateType()&&(e=!0);break}if(e)return this._addToken(t),!0}if(t===As.none){let s=e,i=0;const r=2;for(let e=0;e<r;++e)if(s+=this._peekAhead(e),t=this._findType(s),t!==As.none){i=e;break}if(t===As.none)return n!==As.none&&(this._current--,this._addToken(n),!0);e=s,this._current+=i+1}if(n=t,this._isAtEnd())break;e+=this._advance()}return n!==As.none&&(this._addToken(n),!0)}_findType(e){for(const t in As.regexTokens){const n=As.regexTokens[t];if(this._match(e,n.rule))return n}const t=As.literalTokens[e];return t||As.none}_match(e,t){const n=t.exec(e);return n&&0==n.index&&n[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return e>='a'&&e<='z'||e>='A'&&e<='Z'}_isAlphaNumeric(e){return e>='a'&&e<='z'||e>='A'&&e<='Z'||'_'==e||e>='0'&&e<='9'}_isWhitespace(e){return' '==e||'\t'==e||'\r'==e}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?'\0':this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new Es(e,t,this._line))}}class Ds{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class Ms{constructor(e,t){this.align=e,this.size=t}}class Ls{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new _n,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return'texture_storage_1d'==e.name||'texture_storage_2d'==e.name||'texture_storage_2d_array'==e.name||'texture_storage_3d'==e.name}updateAST(e){for(const t of e)t instanceof In&&this._functions.set(t.name,new Ds(t));for(const t of e)if(t instanceof Kn){const e=this.getTypeInfo(t,null);e instanceof on&&this.structs.push(e)}for(const t of e)if(t instanceof Xn)this.aliases.push(this._getAliasInfo(t));else if(t instanceof Dn){const e=t,n=this._getAttributeNum(e.attributes,'id',0),s=null!=e.type?this.getTypeInfo(e.type,e.attributes):null;this.overrides.push(new xn(e.name,s,e.attributes,n))}else if(this._isUniformVar(t)){const e=t,n=this._getAttributeNum(e.attributes,'group',0),s=this._getAttributeNum(e.attributes,'binding',0),i=this.getTypeInfo(e.type,e.attributes),r=new pn(e.name,i,n,s,e.attributes,cn.Uniform,e.access);this.uniforms.push(r)}else if(this._isStorageVar(t)){const e=t,n=this._getAttributeNum(e.attributes,'group',0),s=this._getAttributeNum(e.attributes,'binding',0),i=this.getTypeInfo(e.type,e.attributes),r=this._isStorageTexture(i),o=new pn(e.name,i,n,s,e.attributes,r?cn.StorageTexture:cn.Storage,e.access);this.storage.push(o)}else if(this._isTextureVar(t)){const e=t,n=this._getAttributeNum(e.attributes,'group',0),s=this._getAttributeNum(e.attributes,'binding',0),i=this.getTypeInfo(e.type,e.attributes),r=this._isStorageTexture(i),o=new pn(e.name,i,n,s,e.attributes,r?cn.StorageTexture:cn.Texture,e.access);r?this.storage.push(o):this.textures.push(o)}else if(this._isSamplerVar(t)){const e=t,n=this._getAttributeNum(e.attributes,'group',0),s=this._getAttributeNum(e.attributes,'binding',0),i=this.getTypeInfo(e.type,e.attributes),r=new pn(e.name,i,n,s,e.attributes,cn.Sampler,e.access);this.samplers.push(r)}else if(t instanceof In){const e=this._getAttribute(t,'vertex'),n=this._getAttribute(t,'fragment'),s=this._getAttribute(t,'compute'),i=e||n||s,r=new yn(t.name,null==i?void 0:i.name,t.attributes);r.attributes=t.attributes,r.startLine=t.startLine,r.endLine=t.endLine,this.functions.push(r),this._functions.get(t.name).info=r,i&&(this._functions.get(t.name).inUse=!0,r.inUse=!0,r.resources=this._findResources(t,!!i),r.inputs=this._getInputs(t.args),r.outputs=this._getOutputs(t.returnType),this.entry[i.name].push(r)),r.arguments=t.args.map((e=>new bn(e.name,this.getTypeInfo(e.type,e.attributes),e.attributes))),r.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null}else;for(const e of this._functions.values())e.info&&(e.info.inUse=e.inUse,this._addCalls(e.node,e.info.calls));for(const e of this._functions.values())e.node.search((t=>{var n;if('varExpr'===t.astNodeType){const s=t;for(const t of this.overrides)s.name==t.name&&(null===(n=e.info)||void 0===n||n.overrides.push(t))}}));for(const e of this.uniforms)this._markStructsInUse(e.type);for(const e of this.storage)this._markStructsInUse(e.type)}getStructInfo(e){for(const t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(const t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var n;for(const s of e.calls){const e=null===(n=this._functions.get(s.name))||void 0===n?void 0:n.info;e&&t.add(e)}}findResource(e,t){for(const n of this.uniforms)if(n.group==e&&n.binding==t)return n;for(const n of this.storage)if(n.group==e&&n.binding==t)return n;for(const n of this.textures)if(n.group==e&&n.binding==t)return n;for(const n of this.samplers)if(n.group==e&&n.binding==t)return n;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const n=[],s=this,i=[];return e.search((r=>{if(r instanceof On)i.push({});else if(r instanceof Sn)i.pop();else if(r instanceof Pn){const e=r;t&&null!==e.type&&this._markStructsFromAST(e.type),i.length>0&&(i[i.length-1][e.name]=e)}else if(r instanceof is){const e=r;t&&null!==e.type&&this._markStructsFromAST(e.type)}else if(r instanceof Mn){const e=r;t&&null!==e.type&&this._markStructsFromAST(e.type),i.length>0&&(i[i.length-1][e.name]=e)}else if(r instanceof os){const e=r;if(i.length>0){if(i[i.length-1][e.name])return}const t=s._findResource(e.name);t&&n.push(t)}else if(r instanceof rs){const i=r,o=s._functions.get(i.name);o&&(t&&(o.inUse=!0),e.calls.add(o.node),null===o.resources&&(o.resources=s._findResources(o.node,t)),n.push(...o.resources))}else if(r instanceof Rn){const i=r,o=s._functions.get(i.name);o&&(t&&(o.inUse=!0),e.calls.add(o.node),null===o.resources&&(o.resources=s._findResources(o.node,t)),n.push(...o.resources))}})),[...new Map(n.map((e=>[e.name,e]))).values()]}getBindGroups(){const e=[];function t(t,n){t>=e.length&&(e.length=t+1),void 0===e[t]&&(e[t]=[]),n>=e[t].length&&(e[t].length=n+1)}for(const n of this.uniforms){t(n.group,n.binding);e[n.group][n.binding]=n}for(const n of this.storage){t(n.group,n.binding);e[n.group][n.binding]=n}for(const n of this.textures){t(n.group,n.binding);e[n.group][n.binding]=n}for(const n of this.samplers){t(n.group,n.binding);e[n.group][n.binding]=n}return e}_getOutputs(e,t=void 0){if(void 0===t&&(t=[]),e instanceof Kn)this._getStructOutputs(e,t);else{const n=this._getOutputInfo(e);null!==n&&t.push(n)}return t}_getStructOutputs(e,t){for(const n of e.members)if(n.type instanceof Kn)this._getStructOutputs(n.type,t);else{const e=this._getAttribute(n,'location')||this._getAttribute(n,'builtin');if(null!==e){const s=this.getTypeInfo(n.type,n.type.attributes),i=this._parseInt(e.value),r=new vn(n.name,s,e.name,i);t.push(r)}}}_getOutputInfo(e){const t=this._getAttribute(e,'location')||this._getAttribute(e,'builtin');if(null!==t){const n=this.getTypeInfo(e,e.attributes),s=this._parseInt(t.value);return new vn('',n,t.name,s)}return null}_getInputs(e,t=void 0){void 0===t&&(t=[]);for(const n of e)if(n.type instanceof Kn)this._getStructInputs(n.type,t);else{const e=this._getInputInfo(n);null!==e&&t.push(e)}return t}_getStructInputs(e,t){for(const n of e.members)if(n.type instanceof Kn)this._getStructInputs(n.type,t);else{const e=this._getInputInfo(n);null!==e&&t.push(e)}}_getInputInfo(e){const t=this._getAttribute(e,'location')||this._getAttribute(e,'builtin');if(null!==t){const n=this._getAttribute(e,'interpolation'),s=this.getTypeInfo(e.type,e.attributes),i=this._parseInt(t.value),r=new gn(e.name,s,t.name,i);return null!==n&&(r.interpolation=this._parseString(n.value)),r}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new mn(e.name,this.getTypeInfo(e.type,null))}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof es){const n=e,s=n.format?this.getTypeInfo(n.format,n.attributes):null,i=new an(n.name,t);return i.format=s,i.count=n.count,this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof Kn){const n=e,s=new on(n.name,t);s.startLine=n.startLine,s.endLine=n.endLine;for(const e of n.members){const t=this.getTypeInfo(e.type,e.attributes);s.members.push(new rn(e.name,t,e.attributes))}return this._types.set(e,s),this._updateTypeInfo(s),s}if(e instanceof ts){const n=e,s=n.format instanceof Yn,i=n.format?s?this.getTypeInfo(n.format,null):new sn(n.format,null):null,r=new ln(n.name,i,t,n.access);return this._types.set(e,r),this._updateTypeInfo(r),r}if(e instanceof Zn){const n=e,s=n.format?this.getTypeInfo(n.format,null):null,i=new ln(n.name,s,t,n.access);return this._types.set(e,i),this._updateTypeInfo(i),i}const n=new sn(e.name,t);return this._types.set(e,n),this._updateTypeInfo(n),n}_updateTypeInfo(e){var t,n,s;const i=this._getTypeSize(e);if(e.size=null!==(t=null==i?void 0:i.size)&&void 0!==t?t:0,e instanceof an&&e.format){const t=this._getTypeSize(e.format);e.stride=Math.max(null!==(n=null==t?void 0:t.size)&&void 0!==n?n:0,null!==(s=null==t?void 0:t.align)&&void 0!==s?s:0),this._updateTypeInfo(e.format)}e instanceof on&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let n=0,s=0,i=0,r=0;for(let o=0,a=e.members.length;o<a;++o){const a=e.members[o],l=this._getTypeSize(a);if(!l)continue;null!==(t=this._getAlias(a.type.name))&&void 0!==t||a.type;const c=l.align,h=l.size;n=this._roundUp(c,n+s),s=h,i=n,r=Math.max(r,c),a.offset=n,a.size=h,this._updateTypeInfo(a.type)}e.size=this._roundUp(r,i+s),e.align=r}_getTypeSize(e){var t,n;if(null==e)return null;const s=this._getAttributeNum(e.attributes,'size',0),i=this._getAttributeNum(e.attributes,'align',0);if(e instanceof rn&&(e=e.type),e instanceof sn){const t=this._getAlias(e.name);null!==t&&(e=t)}{const n=Ls._typeInfo[e.name];if(void 0!==n){const r='f16'===(null===(t=e.format)||void 0===t?void 0:t.name)?2:1;return new Ms(Math.max(i,n.align/r),Math.max(s,n.size/r))}}{const t=Ls._typeInfo[e.name.substring(0,e.name.length-1)];if(t){const n='h'===e.name[e.name.length-1]?2:1;return new Ms(Math.max(i,t.align/n),Math.max(s,t.size/n))}}if(e instanceof an){let t=e,r=8,o=8;const a=this._getTypeSize(t.format);null!==a&&(o=a.size,r=a.align);return o=t.count*this._getAttributeNum(null!==(n=null==e?void 0:e.attributes)&&void 0!==n?n:null,'stride',this._roundUp(r,o)),s&&(o=s),new Ms(Math.max(i,r),Math.max(s,o))}if(e instanceof on){let t=0,n=0,r=0,o=0,a=0;for(const n of e.members){const e=this._getTypeSize(n.type);null!==e&&(t=Math.max(e.align,t),r=this._roundUp(e.align,r+o),o=e.size,a=r)}return n=this._roundUp(t,a+o),new Ms(Math.max(i,t),Math.max(s,n))}return null}_isUniformVar(e){return e instanceof Pn&&'uniform'==e.storage}_isStorageVar(e){return e instanceof Pn&&'storage'==e.storage}_isTextureVar(e){return e instanceof Pn&&null!==e.type&&-1!=Ls._textureTypes.indexOf(e.type.name)}_isSamplerVar(e){return e instanceof Pn&&null!==e.type&&-1!=Ls._samplerTypes.indexOf(e.type.name)}_getAttribute(e,t){const n=e;if(!n||!n.attributes)return null;const s=n.attributes;for(let e of s)if(e.name==t)return e;return null}_getAttributeNum(e,t,n){if(null===e)return n;for(let s of e)if(s.name==t){let e=null!==s&&null!==s.value?s.value:n;return e instanceof Array&&(e=e[0]),'number'==typeof e?e:'string'==typeof e?parseInt(e):n}return n}_roundUp(e,t){return Math.ceil(t/e)*e}}Ls._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},Ls._textureTypes=As.any_texture_type.map((e=>e.name)),Ls._samplerTypes=As.sampler_type.map((e=>e.name));class Bs{constructor(e,t,n){this.name=e,this.value=t,this.node=n}clone(){return new Bs(this.name,this.value,this.node)}}class Ns{constructor(e){this.name=e.name,this.node=e}clone(){return new Ns(this.node)}}class Rs{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName='',e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){var t;return this.variables.has(e)?null!==(t=this.variables.get(e))&&void 0!==t?t:null:this.parent?this.parent.getVariable(e):null}getFunction(e){var t;return this.functions.has(e)?null!==(t=this.functions.get(e))&&void 0!==t?t:null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,n){this.variables.set(e,new Bs(e,t,null!=n?n:null))}setVariable(e,t,n){const s=this.getVariable(e);null!==s?s.value=t:this.createVariable(e,t,n)}getVariableValue(e){var t;const n=this.getVariable(e);return null!==(t=null==n?void 0:n.value)&&void 0!==t?t:null}clone(){return new Rs(this)}}class Fs{evalExpression(e,t){return null}getTypeName(e){return''}getTypeInfo(e){return null}getVariableName(e,t){return''}}class Vs{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){const n=this.exec.evalExpression(e.args[0],t);let s=!0;if(n instanceof Ts)return n.value.forEach((e=>{e||(s=!1)})),new Os(s?1:0,this.getTypeInfo('bool'));throw new Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts){const e=n.value.some((e=>e));return new Os(e?1:0,this.getTypeInfo('bool'))}throw new Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){const n=this.exec.evalExpression(e.args[2],t);if(!(n instanceof Os))throw new Error(`Select() expects a bool condition. Line ${e.line}`);return n.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let n=e.args[0];n instanceof fs&&(n=n.right);const s=this.exec.evalExpression(n,t);if(s instanceof Cs&&0===s.typeInfo.size){const e=s.typeInfo,t=s.buffer.byteLength/e.stride;return new Os(t,this.getTypeInfo('u32'))}return new Os(s.typeInfo.size,this.getTypeInfo('u32'))}Abs(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.abs(e))),n.typeInfo);const s=n;return new Os(Math.abs(s.value),s.typeInfo)}Acos(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.acos(e))),n.typeInfo);const s=n;return new Os(Math.acos(s.value),n.typeInfo)}Acosh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.acosh(e))),n.typeInfo);const s=n;return new Os(Math.acosh(s.value),n.typeInfo)}Asin(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.asin(e))),n.typeInfo);const s=n;return new Os(Math.asin(s.value),n.typeInfo)}Asinh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.asinh(e))),n.typeInfo);const s=n;return new Os(Math.asinh(s.value),n.typeInfo)}Atan(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.atan(e))),n.typeInfo);const s=n;return new Os(Math.atan(s.value),n.typeInfo)}Atanh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.atanh(e))),n.typeInfo);const s=n;return new Os(Math.atanh(s.value),n.typeInfo)}Atan2(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ts&&s instanceof Ts)return new Ts(n.value.map(((e,t)=>Math.atan2(e,s.value[t]))),n.typeInfo);const i=n,r=s;return new Os(Math.atan2(i.value,r.value),n.typeInfo)}Ceil(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.ceil(e))),n.typeInfo);const s=n;return new Os(Math.ceil(s.value),n.typeInfo)}_clamp(e,t,n){return Math.min(Math.max(e,t),n)}Clamp(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof Ts&&s instanceof Ts&&i instanceof Ts)return new Ts(n.value.map(((e,t)=>this._clamp(e,s.value[t],i.value[t]))),n.typeInfo);const r=n,o=s,a=i;return new Os(this._clamp(r.value,o.value,a.value),n.typeInfo)}Cos(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.cos(e))),n.typeInfo);const s=n;return new Os(Math.cos(s.value),n.typeInfo)}Cosh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.cosh(e))),n.typeInfo);const s=n;return new Os(Math.cos(s.value),n.typeInfo)}CountLeadingZeros(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.clz32(e))),n.typeInfo);const s=n;return new Os(Math.clz32(s.value),n.typeInfo)}_countOneBits(e){let t=0;for(;0!==e;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>this._countOneBits(e))),n.typeInfo);const s=n;return new Os(this._countOneBits(s.value),n.typeInfo)}_countTrailingZeros(e){if(0===e)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>this._countTrailingZeros(e))),n.typeInfo);const s=n;return new Os(this._countTrailingZeros(s.value),n.typeInfo)}Cross(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ts&&s instanceof Ts){if(3!==n.value.length||3!==s.value.length)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;const t=n.value,i=s.value;return new Ts([t[1]*i[2]-i[1]*t[2],t[2]*i[0]-i[2]*t[0],t[0]*i[1]-i[0]*t[1]],n.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){const n=this.exec.evalExpression(e.args[0],t),s=180/Math.PI;if(n instanceof Ts)return new Ts(n.value.map((e=>e*s)),n.typeInfo);return new Os(n.value*s,n.typeInfo)}Determinant(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Is){const e=n.value,t=this.exec.getTypeName(n.typeInfo),s=t.endsWith('h')?this.getTypeInfo('f16'):this.getTypeInfo('f32');if('mat2x2'===t||'mat2x2f'===t||'mat2x2h'===t)return new Os(e[0]*e[3]-e[1]*e[2],s);if('mat2x3'===t||'mat2x3f'===t||'mat2x3h'===t)return new Os(e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]),s);if('mat2x4'===t||'mat2x4f'===t||'mat2x4h'===t)console.error(`TODO: Determinant for ${t}`);else if('mat3x2'===t||'mat3x2f'===t||'mat3x2h'===t)console.error(`TODO: Determinant for ${t}`);else{if('mat3x3'===t||'mat3x3f'===t||'mat3x3h'===t)return new Os(e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]),s);'mat3x4'===t||'mat3x4f'===t||'mat3x4h'===t||'mat4x2'===t||'mat4x2f'===t||'mat4x2h'===t||'mat4x3'===t||'mat4x3f'===t||'mat4x3h'===t?console.error(`TODO: Determinant for ${t}`):'mat4x4'!==t&&'mat4x4f'!==t&&'mat4x4h'!==t||console.error(`TODO: Determinant for ${t}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ts&&s instanceof Ts){let e=0;for(let t=0;t<n.value.length;++t)e+=(n.value[t]-s.value[t])*(n.value[t]-s.value[t]);return new Os(Math.sqrt(e),this.getTypeInfo('f32'))}const i=n,r=s;return new Os(Math.abs(i.value-r.value),n.typeInfo)}_dot(e,t){let n=0;for(let s=0;s<e.length;++s)n+=t[s]*e[s];return n}Dot(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);return n instanceof Ts&&s instanceof Ts?new Os(this._dot(n.value,s.value),this.getTypeInfo('f32')):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.exp(e))),n.typeInfo);const s=n;return new Os(Math.exp(s.value),n.typeInfo)}Exp2(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.pow(2,e))),n.typeInfo);const s=n;return new Os(Math.pow(2,s.value),n.typeInfo)}ExtractBits(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if('u32'!==s.typeInfo.name&&'x32'!==s.typeInfo.name)return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if('u32'!==i.typeInfo.name&&'x32'!==i.typeInfo.name)return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;const r=s.value,o=i.value;if(n instanceof Ts)return new Ts(n.value.map((e=>e>>r&(1<<o)-1)),n.typeInfo);if('i32'!==n.typeInfo.name&&'x32'!==n.typeInfo.name)return console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null;const a=n.value;return new Os(a>>r&(1<<o)-1,this.getTypeInfo('i32'))}FaceForward(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof Ts&&s instanceof Ts&&i instanceof Ts){const e=this._dot(s.value,i.value);return new Ts(e<0?n.value:n.value.map((e=>-e)),n.typeInfo)}return console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null}_firstLeadingBit(e){return 0===e?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>this._firstLeadingBit(e))),n.typeInfo);const s=n;return new Os(this._firstLeadingBit(s.value),n.typeInfo)}_firstTrailingBit(e){return 0===e?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>this._firstTrailingBit(e))),n.typeInfo);const s=n;return new Os(this._firstTrailingBit(s.value),n.typeInfo)}Floor(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.floor(e))),n.typeInfo);const s=n;return new Os(Math.floor(s.value),n.typeInfo)}Fma(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof Ts&&s instanceof Ts&&i instanceof Ts)return n.value.length!==s.value.length||n.value.length!==i.value.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new Ts(n.value.map(((e,t)=>e*s.value[t]+i.value[t])),n.typeInfo);const r=n,o=s,a=i;return new Os(r.value*o.value+a.value,r.typeInfo)}Fract(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>e-Math.floor(e))),n.typeInfo);const s=n;return new Os(s.value-Math.floor(s.value),n.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t),r=this.exec.evalExpression(e.args[3],t);if('u32'!==i.typeInfo.name&&'x32'!==i.typeInfo.name)return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;const o=i.value,a=(1<<r.value)-1<<o,l=~a;if(n instanceof Ts&&s instanceof Ts)return new Ts(n.value.map(((e,t)=>e&l|s.value[t]<<o&a)),n.typeInfo);const c=n.value,h=s.value;return new Os(c&l|h<<o&a,n.typeInfo)}InverseSqrt(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>1/Math.sqrt(e))),n.typeInfo);const s=n;return new Os(1/Math.sqrt(s.value),n.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts){let e=0;return n.value.forEach((t=>{e+=t*t})),new Os(Math.sqrt(e),this.getTypeInfo('f32'))}const s=n;return new Os(Math.abs(s.value),n.typeInfo)}Log(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.log(e))),n.typeInfo);const s=n;return new Os(Math.log(s.value),n.typeInfo)}Log2(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.log2(e))),n.typeInfo);const s=n;return new Os(Math.log2(s.value),n.typeInfo)}Max(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ts&&s instanceof Ts)return new Ts(n.value.map(((e,t)=>Math.max(e,s.value[t]))),n.typeInfo);const i=n,r=s;return new Os(Math.max(i.value,r.value),n.typeInfo)}Min(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ts&&s instanceof Ts)return new Ts(n.value.map(((e,t)=>Math.min(e,s.value[t]))),n.typeInfo);const i=n,r=s;return new Os(Math.min(i.value,r.value),n.typeInfo)}Mix(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof Ts&&s instanceof Ts&&i instanceof Ts)return new Ts(n.value.map(((e,t)=>n.value[t]*(1-i.value[t])+s.value[t]*i.value[t])),n.typeInfo);const r=s,o=i;return new Os(n.value*(1-o.value)+r.value*o.value,n.typeInfo)}Modf(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ts&&s instanceof Ts)return new Ts(n.value.map(((e,t)=>e%s.value[t])),n.typeInfo);const i=s;return new Os(n.value%i.value,n.typeInfo)}Normalize(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts){const s=this.Length(e,t).value;return new Ts(n.value.map((e=>e/s)),n.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ts&&s instanceof Ts)return new Ts(n.value.map(((e,t)=>Math.pow(e,s.value[t]))),n.typeInfo);const i=n,r=s;return new Os(Math.pow(i.value,r.value),n.typeInfo)}QuantizeToF16(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>e)),n.typeInfo);return new Os(n.value,n.typeInfo)}Radians(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>e*Math.PI/180)),n.typeInfo);return new Os(n.value*Math.PI/180,n.typeInfo)}Reflect(e,t){let n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(n instanceof Ts&&s instanceof Ts){const e=this._dot(n.value,s.value);return new Ts(n.value.map(((t,n)=>t-2*e*s.value[n])),n.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof Ts&&s instanceof Ts&&i instanceof Os){const e=this._dot(s.value,n.value);return new Ts(n.value.map(((t,n)=>{const r=1-i.value*i.value*(1-e*e);if(r<0)return 0;const o=Math.sqrt(r);return i.value*t-(i.value*e+o)*s.value[n]})),n.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.round(e))),n.typeInfo);const s=n;return new Os(Math.round(s.value),n.typeInfo)}Saturate(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.min(Math.max(e,0),1))),n.typeInfo);const s=n;return new Os(Math.min(Math.max(s.value,0),1),n.typeInfo)}Sign(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.sign(e))),n.typeInfo);const s=n;return new Os(Math.sign(s.value),n.typeInfo)}Sin(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.sin(e))),n.typeInfo);const s=n;return new Os(Math.sin(s.value),n.typeInfo)}Sinh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.sinh(e))),n.typeInfo);const s=n;return new Os(Math.sinh(s.value),n.typeInfo)}_smoothstep(e,t,n){const s=Math.min(Math.max((n-e)/(t-e),0),1);return s*s*(3-2*s)}SmoothStep(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(i instanceof Ts&&n instanceof Ts&&s instanceof Ts)return new Ts(i.value.map(((e,t)=>this._smoothstep(n.value[t],s.value[t],e))),i.typeInfo);const r=n,o=s,a=i;return new Os(this._smoothstep(r.value,o.value,a.value),i.typeInfo)}Sqrt(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.sqrt(e))),n.typeInfo);const s=n;return new Os(Math.sqrt(s.value),n.typeInfo)}Step(e,t){const n=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(s instanceof Ts&&n instanceof Ts)return new Ts(s.value.map(((e,t)=>e<n.value[t]?0:1)),s.typeInfo);const i=n;return new Os(s.value<i.value?0:1,i.typeInfo)}Tan(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.tan(e))),n.typeInfo);const s=n;return new Os(Math.tan(s.value),n.typeInfo)}Tanh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.tanh(e))),n.typeInfo);const s=n;return new Os(Math.tanh(s.value),n.typeInfo)}_getTransposeType(e){const t=this.exec.getTypeName(e);return'mat2x2f'===t||'mat2x2h'===t?e:'mat2x3f'===t?this.getTypeInfo('mat3x2f'):'mat2x3h'===t?this.getTypeInfo('mat3x2h'):'mat2x4f'===t?this.getTypeInfo('mat4x2f'):'mat2x4h'===t?this.getTypeInfo('mat4x2h'):'mat3x2f'===t?this.getTypeInfo('mat2x3f'):'mat3x2h'===t?this.getTypeInfo('mat2x3h'):'mat3x3f'===t||'mat3x3h'===t?e:'mat3x4f'===t?this.getTypeInfo('mat4x3f'):'mat3x4h'===t?this.getTypeInfo('mat4x3h'):'mat4x2f'===t?this.getTypeInfo('mat2x4f'):'mat4x2h'===t?this.getTypeInfo('mat2x4h'):'mat4x3f'===t?this.getTypeInfo('mat3x4f'):'mat4x3h'===t?this.getTypeInfo('mat3x4h'):('mat4x4f'===t||'mat4x4h'===t||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){const n=this.exec.evalExpression(e.args[0],t);if(!(n instanceof Is))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;const s=this._getTransposeType(n.typeInfo);if('mat2x2'===n.typeInfo.name||'mat2x2f'===n.typeInfo.name||'mat2x2h'===n.typeInfo.name){const e=n.value;return new Is([e[0],e[2],e[1],e[3]],s)}if('mat2x3'===n.typeInfo.name||'mat2x3f'===n.typeInfo.name||'mat2x3h'===n.typeInfo.name){const e=n.value;return new Is([e[0],e[3],e[6],e[1],e[4],e[7]],s)}if('mat2x4'===n.typeInfo.name||'mat2x4f'===n.typeInfo.name||'mat2x4h'===n.typeInfo.name){const e=n.value;return new Is([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13]],s)}if('mat3x2'===n.typeInfo.name||'mat3x2f'===n.typeInfo.name||'mat3x2h'===n.typeInfo.name){const e=n.value;return new Is([e[0],e[3],e[1],e[4],e[2],e[5]],s)}if('mat3x3'===n.typeInfo.name||'mat3x3f'===n.typeInfo.name||'mat3x3h'===n.typeInfo.name){const e=n.value;return new Is([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]],s)}if('mat3x4'===n.typeInfo.name||'mat3x4f'===n.typeInfo.name||'mat3x4h'===n.typeInfo.name){const e=n.value;return new Is([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14]],s)}if('mat4x2'===n.typeInfo.name||'mat4x2f'===n.typeInfo.name||'mat4x2h'===n.typeInfo.name){const e=n.value;return new Is([e[0],e[4],e[1],e[5],e[2],e[6]],s)}if('mat4x3'===n.typeInfo.name||'mat4x3f'===n.typeInfo.name||'mat4x3h'===n.typeInfo.name){const e=n.value;return new Is([e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]],s)}if('mat4x4'===n.typeInfo.name||'mat4x4f'===n.typeInfo.name||'mat4x4h'===n.typeInfo.name){const e=n.value;return new Is([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]],s)}return console.error(`Invalid matrix type ${n.typeInfo.name}`),null}Trunc(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof Ts)return new Ts(n.value.map((e=>Math.trunc(e))),n.typeInfo);const s=n;return new Os(Math.trunc(s.value),n.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error('TODO: dpdxFine'),null}Dpdy(e,t){return console.error('TODO: dpdy'),null}DpdyCoarse(e,t){return console.error('TODO: dpdyCoarse'),null}DpdyFine(e,t){return console.error('TODO: dpdyFine'),null}Fwidth(e,t){return console.error('TODO: fwidth'),null}FwidthCoarse(e,t){return console.error('TODO: fwidthCoarse'),null}FwidthFine(e,t){return console.error('TODO: fwidthFine'),null}TextureDimensions(e,t){const n=e.args[0];if((e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0)>0)return console.error(`TODO: Mip levels. Line ${e.line}`),null;if(n instanceof os){const s=n.name,i=t.getVariableValue(s);return i instanceof Cs?new Ts(i.textureSize,this.getTypeInfo('vec2u')):(console.error(`Texture ${s} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error('TODO: textureGather'),null}TextureGatherCompare(e,t){return console.error('TODO: textureGatherCompare'),null}TextureLoad(e,t){const n=e.args[0],s=this.exec.evalExpression(e.args[1],t);if((e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0)>0)return console.error(`TODO: Mip levels. Line ${e.line}`),null;if(!(s instanceof Ts)||2!==s.value.length)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(n instanceof os){const i=n.name,r=t.getVariableValue(i);if(r instanceof Cs){const t=r.textureSize,n=Math.floor(s.value[0]),o=Math.floor(s.value[1]);if(n<0||n>=t[0]||o<0||o>=t[1])return console.error(`Texture ${i} out of bounds. Line ${e.line}`),null;const a=4*(o*t[0]+n),l=new Uint8Array(r.buffer,a,4);return new Ts([l[0]/255,l[1]/255,l[2]/255,l[3]/255],this.getTypeInfo('vec4f'))}return console.error(`Texture ${i} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){return console.error('TODO: textureNumLayers'),null}TextureNumLevels(e,t){return console.error('TODO: textureNumLevels'),null}TextureNumSamples(e,t){return console.error('TODO: textureNumSamples'),null}TextureSample(e,t){return console.error('TODO: textureSample'),null}TextureSampleBias(e,t){return console.error('TODO: textureSampleBias'),null}TextureSampleCompare(e,t){return console.error('TODO: textureSampleCompare'),null}TextureSampleCompareLevel(e,t){return console.error('TODO: textureSampleCompareLevel'),null}TextureSampleGrad(e,t){return console.error('TODO: textureSampleGrad'),null}TextureSampleLevel(e,t){return console.error('TODO: textureSampleLevel'),null}TextureSampleBaseClampToEdge(e,t){return console.error('TODO: textureSampleBaseClampToEdge'),null}TextureStore(e,t){const n=e.args[0],s=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t).value;if(4!==i.length)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(s instanceof Ts)||2!==s.value.length)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(n instanceof os){const r=n.name,o=t.getVariableValue(r);if(o instanceof Cs){const t=o.textureSize,n=Math.floor(s.value[0]),a=Math.floor(s.value[1]);if(n<0||n>=t[0]||a<0||a>=t[1])return console.error(`Texture ${r} out of bounds. Line ${e.line}`),null;const l=4*(a*t[0]+n),c=new Uint8Array(o.buffer,l,4);return c[0]=255*i[0],c[1]=255*i[1],c[2]=255*i[2],c[3]=255*i[3],null}return console.error(`Texture ${r} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let n=e.args[0];n instanceof fs&&(n=n.right);const s=this.exec.getVariableName(n,t);return t.getVariable(s).value.getDataValue(this.exec,n.postfix,t)}AtomicStore(e,t){let n=e.args[0];n instanceof fs&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t);return a instanceof Os&&o instanceof Os&&(a.value=o.value),i.value instanceof Cs&&i.value.setDataValue(this.exec,a,n.postfix,t),null}AtomicAdd(e,t){let n=e.args[0];n instanceof fs&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t);return a instanceof Os&&o instanceof Os&&(a.value+=o.value),i.value instanceof Cs&&i.value.setDataValue(this.exec,a,n.postfix,t),null}AtomicSub(e,t){let n=e.args[0];n instanceof fs&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t);return a instanceof Os&&o instanceof Os&&(a.value-=o.value),i.value instanceof Cs&&i.value.setDataValue(this.exec,a,n.postfix,t),null}AtomicMax(e,t){let n=e.args[0];n instanceof fs&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t),l=new Os(a.value,a.typeInfo);return a instanceof Os&&o instanceof Os&&(a.value=Math.max(a.value,o.value)),i.value instanceof Cs&&i.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicMin(e,t){let n=e.args[0];n instanceof fs&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t),l=new Os(a.value,a.typeInfo);return a instanceof Os&&o instanceof Os&&(a.value=Math.min(a.value,o.value)),i.value instanceof Cs&&i.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicAnd(e,t){let n=e.args[0];n instanceof fs&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t),l=new Os(a.value,a.typeInfo);return a instanceof Os&&o instanceof Os&&(a.value=a.value&o.value),i.value instanceof Cs&&i.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicOr(e,t){let n=e.args[0];n instanceof fs&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t),l=new Os(a.value,a.typeInfo);return a instanceof Os&&o instanceof Os&&(a.value=a.value|o.value),i.value instanceof Cs&&i.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicXor(e,t){let n=e.args[0];n instanceof fs&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t),l=new Os(a.value,a.typeInfo);return a instanceof Os&&o instanceof Os&&(a.value=a.value^o.value),i.value instanceof Cs&&i.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicExchange(e,t){let n=e.args[0];n instanceof fs&&(n=n.right);const s=this.exec.getVariableName(n,t),i=t.getVariable(s);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=i.value.getDataValue(this.exec,n.postfix,t),l=new Os(a.value,a.typeInfo);return a instanceof Os&&o instanceof Os&&(a.value=o.value),i.value instanceof Cs&&i.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicCompareExchangeWeak(e,t){return console.error('TODO: atomicCompareExchangeWeak'),null}Pack4x8snorm(e,t){return console.error('TODO: pack4x8snorm'),null}Pack4x8unorm(e,t){return console.error('TODO: pack4x8unorm'),null}Pack4xI8(e,t){return console.error('TODO: pack4xI8'),null}Pack4xU8(e,t){return console.error('TODO: pack4xU8'),null}Pack4x8Clamp(e,t){return console.error('TODO: pack4x8Clamp'),null}Pack4xU8Clamp(e,t){return console.error('TODO: pack4xU8Clamp'),null}Pack2x16snorm(e,t){return console.error('TODO: pack2x16snorm'),null}Pack2x16unorm(e,t){return console.error('TODO: pack2x16unorm'),null}Pack2x16float(e,t){return console.error('TODO: pack2x16float'),null}Unpack4x8snorm(e,t){return console.error('TODO: unpack4x8snorm'),null}Unpack4x8unorm(e,t){return console.error('TODO: unpack4x8unorm'),null}Unpack4xI8(e,t){return console.error('TODO: unpack4xI8'),null}Unpack4xU8(e,t){return console.error('TODO: unpack4xU8'),null}Unpack2x16snorm(e,t){return console.error('TODO: unpack2x16snorm'),null}Unpack2x16unorm(e,t){return console.error('TODO: unpack2x16unorm'),null}Unpack2x16float(e,t){return console.error('TODO: unpack2x16float'),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error('TODO: subgroupAdd'),null}SubgroupExclusiveAdd(e,t){return console.error('TODO: subgroupExclusiveAdd'),null}SubgroupInclusiveAdd(e,t){return console.error('TODO: subgroupInclusiveAdd'),null}SubgroupAll(e,t){return console.error('TODO: subgroupAll'),null}SubgroupAnd(e,t){return console.error('TODO: subgroupAnd'),null}SubgroupAny(e,t){return console.error('TODO: subgroupAny'),null}SubgroupBallot(e,t){return console.error('TODO: subgroupBallot'),null}SubgroupBroadcast(e,t){return console.error('TODO: subgroupBroadcast'),null}SubgroupBroadcastFirst(e,t){return console.error('TODO: subgroupBroadcastFirst'),null}SubgroupElect(e,t){return console.error('TODO: subgroupElect'),null}SubgroupMax(e,t){return console.error('TODO: subgroupMax'),null}SubgroupMin(e,t){return console.error('TODO: subgroupMin'),null}SubgroupMul(e,t){return console.error('TODO: subgroupMul'),null}SubgroupExclusiveMul(e,t){return console.error('TODO: subgroupExclusiveMul'),null}SubgroupInclusiveMul(e,t){return console.error('TODO: subgroupInclusiveMul'),null}SubgroupOr(e,t){return console.error('TODO: subgroupOr'),null}SubgroupShuffle(e,t){return console.error('TODO: subgroupShuffle'),null}SubgroupShuffleDown(e,t){return console.error('TODO: subgroupShuffleDown'),null}SubgroupShuffleUp(e,t){return console.error('TODO: subgroupShuffleUp'),null}SubgroupShuffleXor(e,t){return console.error('TODO: subgroupShuffleXor'),null}SubgroupXor(e,t){return console.error('TODO: subgroupXor'),null}QuadBroadcast(e,t){return console.error('TODO: quadBroadcast'),null}QuadSwapDiagonal(e,t){return console.error('TODO: quadSwapDiagonal'),null}QuadSwapX(e,t){return console.error('TODO: quadSwapX'),null}QuadSwapY(e,t){return console.error('TODO: quadSwapY'),null}}function zs(e){return Array.isArray(e)||(null==e?void 0:e.buffer)instanceof ArrayBuffer}const Us=new Float32Array(1),Ws=new Uint32Array(Us.buffer),Qs=new Uint32Array(Us.buffer),js=new Int32Array(1),Xs=new Float32Array(js.buffer),Gs=new Uint32Array(js.buffer),qs=new Uint32Array(1),Hs=new Float32Array(qs.buffer),Ys=new Int32Array(qs.buffer);function Ks(e,t,n){if(t===n)return e;if('f32'===t){if('i32'===n||'x32'===n)return Us[0]=e,Ws[0];if('u32'===n)return Us[0]=e,Qs[0]}else if('i32'===t||'x32'===t){if('f32'===n)return js[0]=e,Xs[0];if('u32'===n)return js[0]=e,Gs[0]}else if('u32'===t){if('f32'===n)return qs[0]=e,Hs[0];if('i32'===n||'x32'===n)return qs[0]=e,Ys[0]}return console.error(`Unsupported cast from ${t} to ${n}`),e}class Zs extends Fs{constructor(e,t){var n;super(),this.ast=null!=e?e:[],this.reflection=new Ls,this.reflection.updateAST(this.ast),this.context=null!==(n=null==t?void 0:t.clone())&&void 0!==n?n:new Rs,this.builtins=new Vs(this),this.typeInfo={bool:this.getTypeInfo(Yn.bool),i32:this.getTypeInfo(Yn.i32),u32:this.getTypeInfo(Yn.u32),f32:this.getTypeInfo(Yn.f32),f16:this.getTypeInfo(Yn.f16),vec2f:this.getTypeInfo(Zn.vec2f),vec2u:this.getTypeInfo(Zn.vec2u),vec2i:this.getTypeInfo(Zn.vec2i),vec2h:this.getTypeInfo(Zn.vec2h),vec3f:this.getTypeInfo(Zn.vec3f),vec3u:this.getTypeInfo(Zn.vec3u),vec3i:this.getTypeInfo(Zn.vec3i),vec3h:this.getTypeInfo(Zn.vec3h),vec4f:this.getTypeInfo(Zn.vec4f),vec4u:this.getTypeInfo(Zn.vec4u),vec4i:this.getTypeInfo(Zn.vec4i),vec4h:this.getTypeInfo(Zn.vec4h),mat2x2f:this.getTypeInfo(Zn.mat2x2f),mat2x3f:this.getTypeInfo(Zn.mat2x3f),mat2x4f:this.getTypeInfo(Zn.mat2x4f),mat3x2f:this.getTypeInfo(Zn.mat3x2f),mat3x3f:this.getTypeInfo(Zn.mat3x3f),mat3x4f:this.getTypeInfo(Zn.mat3x4f),mat4x2f:this.getTypeInfo(Zn.mat4x2f),mat4x3f:this.getTypeInfo(Zn.mat4x3f),mat4x4f:this.getTypeInfo(Zn.mat4x4f)}}getVariableValue(e){var t,n;const s=null!==(n=null===(t=this.context.getVariable(e))||void 0===t?void 0:t.value)&&void 0!==n?n:null;return null===s?null:s instanceof Os||s instanceof Ts||s instanceof Is?s.value:(console.error(`Unsupported return variable type ${s.typeInfo.name}`),null)}execute(e){(e=null!=e?e:{}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,n,s){const i=this.context.clone();(s=null!=s?s:{}).constants&&this._setOverrides(s.constants,i),this._execStatements(this.ast,i);const r=i.functions.get(e);if(!r)return void console.error(`Function ${e} not found`);if('number'==typeof t)t=[t,1,1];else{if(0===t.length)return void console.error('Invalid dispatch count');1===t.length?t=[t[0],1,1]:2===t.length?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}const o=t[0],a=t[1],l=t[2],c=this.getTypeInfo('vec3u');i.setVariable('@num_workgroups',new Ts(t,c));for(const e in n)for(const t in n[e]){const s=n[e][t];i.variables.forEach((n=>{const i=n.node;if(null==i?void 0:i.attributes){let r=null,o=null;for(const e of i.attributes)'binding'===e.name?r=e.value:'group'===e.name&&(o=e.value);t==r&&e==o&&(void 0!==s.texture&&void 0!==s.size?n.value=new Cs(s.texture,this.getTypeInfo(i.type),0,s.size):void 0!==s.uniform?n.value=new Cs(s.uniform,this.getTypeInfo(i.type)):n.value=new Cs(s,this.getTypeInfo(i.type)))}}))}for(let e=0;e<l;++e)for(let t=0;t<a;++t)for(let n=0;n<o;++n)i.setVariable('@workgroup_id',new Ts([n,t,e],this.getTypeInfo('vec3u'))),this._dispatchWorkgroup(r,[n,t,e],i)}execStatement(e,t){if(e instanceof Un)return this.evalExpression(e.value,t);if(e instanceof qn){if(e.condition){const n=this.evalExpression(e.condition,t);if(!(n instanceof Os))throw new Error('Invalid break-if condition');if(!n.value)return null}return Zs._breakObj}if(e instanceof Hn)return Zs._continueObj;if(e instanceof Mn)this._let(e,t);else if(e instanceof Pn)this._var(e,t);else if(e instanceof Ln)this._const(e,t);else if(e instanceof In)this._function(e,t);else{if(e instanceof zn)return this._if(e,t);if(e instanceof En)return this._for(e,t);if(e instanceof $n)return this._while(e,t);if(e instanceof Fn)return this._loop(e,t);if(e instanceof An){const n=t.clone();return n.currentFunctionName=t.currentFunctionName,this._execStatements(e.body,n)}if(e instanceof Nn)this._assign(e,t);else if(e instanceof Bn)this._increment(e,t);else{if(e instanceof Kn)return null;if(e instanceof Dn){const n=e.name;null===t.getVariable(n)&&console.error(`Override constant ${n} not found. Line ${e.line}`)}else if(e instanceof Rn)this._call(e,t);else{if(e instanceof jn)return null;if(e instanceof Xn)return null;console.error('Invalid statement type.',e,`Line ${e.line}`)}}}return null}evalExpression(e,t){for(;e instanceof hs;)e=e.contents[0];return e instanceof ps?this._evalBinaryOp(e,t):e instanceof ls?this._evalLiteral(e,t):e instanceof os?this._evalVariable(e,t):e instanceof rs?this._evalCall(e,t):e instanceof is?this._evalCreate(e,t):e instanceof as?this._evalConst(e,t):e instanceof cs?this._evalBitcast(e,t):e instanceof fs?this._evalUnaryOp(e,t):(console.error('Invalid expression type',e,`Line ${e.line}`),null)}getTypeInfo(e){var t;if(e instanceof Yn){const t=this.reflection.getTypeInfo(e);if(null!==t)return t}const n=null!==(t=this.typeInfo[e])&&void 0!==t?t:null;return null!==n?n:null}getTypeName(e){if(null===e)return console.error('Type is null.'),'unknown';let t=e.name;if(e instanceof ln||e instanceof Zn)if(null!==e.format){if('vec2'===t||'vec3'===t||'vec4'===t||'mat2x2'===t||'mat2x3'===t||'mat2x4'===t||'mat3x2'===t||'mat3x3'===t||'mat3x4'===t||'mat4x2'===t||'mat4x3'===t||'mat4x4'===t){if('f32'===e.format.name)return t+='f',t;if('i32'===e.format.name)return t+='i',t;if('u32'===e.format.name)return t+='u',t;if('bool'===e.format.name)return t+='b',t;if('f16'===e.format.name)return t+='h',t}t+=`<${e.format.name}>`}else if('vec2'===t||'vec3'===t||'vec4'===t)return t;return t}_setOverrides(e,t){for(const n in e){const s=e[n],i=this.reflection.getOverrideInfo(n);null!==i?'u32'===i.type.name||'i32'===i.type.name||'f32'===i.type.name||'f16'===i.type.name?t.setVariable(n,new Os(s,i.type)):'bool'===i.type.name?t.setVariable(n,new Os(s?1:0,i.type)):'vec2'===i.type.name||'vec3'===i.type.name||'vec4'===i.type.name||'vec2f'===i.type.name||'vec3f'===i.type.name||'vec4f'===i.type.name||'vec2i'===i.type.name||'vec3i'===i.type.name||'vec4i'===i.type.name||'vec2u'===i.type.name||'vec3u'===i.type.name||'vec4u'===i.type.name||'vec2h'===i.type.name||'vec3h'===i.type.name||'vec4h'===i.type.name?t.setVariable(n,new Ts(s,i.type)):console.error(`Invalid constant type for ${n}`):console.error(`Override ${n} does not exist in the shader.`)}}_dispatchWorkgroup(e,t,n){const s=[1,1,1];for(const t of e.node.attributes)if('workgroup_size'===t.name){if(t.value.length>0){const e=n.getVariableValue(t.value[0]);s[0]=e instanceof Os?e.value:parseInt(t.value[0])}if(t.value.length>1){const e=n.getVariableValue(t.value[1]);s[1]=e instanceof Os?e.value:parseInt(t.value[1])}if(t.value.length>2){const e=n.getVariableValue(t.value[2]);s[2]=e instanceof Os?e.value:parseInt(t.value[2])}}const i=this.getTypeInfo('vec3u'),r=this.getTypeInfo('u32');n.setVariable('@workgroup_size',new Ts(s,i));const o=s[0],a=s[1],l=s[2];for(let c=0,h=0;c<l;++c)for(let l=0;l<a;++l)for(let a=0;a<o;++a,++h){const o=[a,l,c],u=[a+t[0]*s[0],l+t[1]*s[1],c+t[2]*s[2]];n.setVariable('@local_invocation_id',new Ts(o,i)),n.setVariable('@global_invocation_id',new Ts(u,i)),n.setVariable('@local_invocation_index',new Os(h,r)),this._dispatchExec(e,n)}}_dispatchExec(e,t){for(const n of e.node.args)for(const e of n.attributes)if('builtin'===e.name){const s=`@${e.value}`,i=t.getVariable(s);void 0!==i&&t.variables.set(n.name,i)}this._execStatements(e.node.body,t)}getVariableName(e,t){return e instanceof os?e.name:(console.error('Unknown variable type',e,'Line',e.line),null)}_execStatements(e,t){for(const n of e){if(n instanceof Array){const e=t.clone(),s=this._execStatements(n,e);if(s)return s;continue}const e=this.execStatement(n,t);if(e)return e}return null}_call(e,t){const n=t.clone();n.currentFunctionName=e.name;const s=t.functions.get(e.name);if(s){for(let t=0;t<s.node.args.length;++t){const i=s.node.args[t],r=this.evalExpression(e.args[t],n);n.setVariable(i.name,r,i)}this._execStatements(s.node.body,n)}else this._callBuiltinFunction(e,n)}_increment(e,t){const n=this.getVariableName(e.variable,t),s=t.getVariable(n);s?'++'===e.operator?s.value instanceof Os?s.value.value++:console.error(`Variable ${n} is not a scalar. Line ${e.line}`):'--'===e.operator?s.value instanceof Os?s.value.value--:console.error(`Variable ${n} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${n} not found. Line ${e.line}`)}_assign(e,t){const n=this.getVariableName(e.variable,t),s=t.getVariable(n);if(null===s)return void console.error(`Variable ${n} not found. Line ${e.line}`);const i=this.evalExpression(e.value,t),r=e.operator;if('='===r)if(s.value instanceof Cs)s.value.setDataValue(this,i,e.variable.postfix,t);else if(e.variable.postfix){if(!(s.value instanceof Ts||s.value instanceof Is))return void console.error(`Variable ${s.name} is not a vector or matrix. Line ${e.line}`);if(e.variable.postfix instanceof us){const n=this.evalExpression(e.variable.postfix.index,t).value;if(s.value instanceof Ts){if(!(i instanceof Os))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[n]=i.value}else{if(!(s.value instanceof Is))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);{const n=this.evalExpression(e.variable.postfix.index,t).value;if(n<0)return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);if(!(i instanceof Ts))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);{const t=this.getTypeName(s.value.typeInfo);if('mat2x2'===t||'mat2x2f'===t||'mat2x2h'===t){if(!(n<2&&2===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[2*n]=i.value[0],s.value.value[2*n+1]=i.value[1]}else if('mat2x3'===t||'mat2x3f'===t||'mat2x3h'===t){if(!(n<2&&3===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[3*n]=i.value[0],s.value.value[3*n+1]=i.value[1],s.value.value[3*n+2]=i.value[2]}else if('mat2x4'===t||'mat2x4f'===t||'mat2x4h'===t){if(!(n<2&&4===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[4*n]=i.value[0],s.value.value[4*n+1]=i.value[1],s.value.value[4*n+2]=i.value[2],s.value.value[4*n+3]=i.value[3]}else if('mat3x2'===t||'mat3x2f'===t||'mat3x2h'===t){if(!(n<3&&2===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[2*n]=i.value[0],s.value.value[2*n+1]=i.value[1]}else if('mat3x3'===t||'mat3x3f'===t||'mat3x3h'===t){if(!(n<3&&3===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[3*n]=i.value[0],s.value.value[3*n+1]=i.value[1],s.value.value[3*n+2]=i.value[2]}else if('mat3x4'===t||'mat3x4f'===t||'mat3x4h'===t){if(!(n<3&&4===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[4*n]=i.value[0],s.value.value[4*n+1]=i.value[1],s.value.value[4*n+2]=i.value[2],s.value.value[4*n+3]=i.value[3]}else if('mat4x2'===t||'mat4x2f'===t||'mat4x2h'===t){if(!(n<4&&2===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[2*n]=i.value[0],s.value.value[2*n+1]=i.value[1]}else if('mat4x3'===t||'mat4x3f'===t||'mat4x3h'===t){if(!(n<4&&3===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[3*n]=i.value[0],s.value.value[3*n+1]=i.value[1],s.value.value[3*n+2]=i.value[2]}else{if('mat4x4'!==t&&'mat4x4f'!==t&&'mat4x4h'!==t)return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);if(!(n<4&&4===i.value.length))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);s.value.value[4*n]=i.value[0],s.value.value[4*n+1]=i.value[1],s.value.value[4*n+2]=i.value[2],s.value.value[4*n+3]=i.value[3]}}}}}else if(e.variable.postfix instanceof ss){const t=e.variable.postfix.value;if(!(s.value instanceof Ts))return void console.error(`Invalid assignment to ${t}. Variable ${s.name} is not a vector. Line ${e.line}`);if(i instanceof Os){if(t.length>1)return void console.error(`Invalid assignment to ${t} for variable ${s.name}. Line ${e.line}`);if('x'===t)s.value.value[0]=i.value;else if('y'===t){if(s.value.value.length<2)return void console.error(`Invalid assignment to ${t} for variable ${s.name}. Line ${e.line}`);s.value.value[1]=i.value}else if('z'===t){if(s.value.value.length<3)return void console.error(`Invalid assignment to ${t} for variable ${s.name}. Line ${e.line}`);s.value.value[2]=i.value}else if('w'===t){if(s.value.value.length<4)return void console.error(`Invalid assignment to ${t} for variable ${s.name}. Line ${e.line}`);s.value.value[3]=i.value}}else{if(!(i instanceof Ts))return void console.error(`Invalid assignment to ${s.name}. Line ${e.line}`);if(t.length!==i.value.length)return void console.error(`Invalid assignment to ${t} for variable ${s.name}. Line ${e.line}`);for(let n=0;n<t.length;++n){const r=t[n];if('x'===r||'r'===r)s.value.value[0]=i.value[n];else if('y'===r||'g'===r){if(i.value.length<2)return void console.error(`Invalid assignment to ${r} for variable ${s.name}. Line ${e.line}`);s.value.value[1]=i.value[n]}else if('z'===r||'b'===r){if(i.value.length<3)return void console.error(`Invalid assignment to ${r} for variable ${s.name}. Line ${e.line}`);s.value.value[2]=i.value[n]}else{if('w'!==r&&'a'!==r)return void console.error(`Invalid assignment to ${r} for variable ${s.name}. Line ${e.line}`);if(i.value.length<4)return void console.error(`Invalid assignment to ${r} for variable ${s.name}. Line ${e.line}`);s.value.value[3]=i.value[n]}}}}}else s.value=i;else{const n=s.value.getDataValue(this,e.variable.postfix,t);if(n instanceof Ts&&i instanceof Os){const t=n.value,s=i.value;if('+='===r)for(let e=0;e<t.length;++e)t[e]+=s;else if('-='===r)for(let e=0;e<t.length;++e)t[e]-=s;else if('*='===r)for(let e=0;e<t.length;++e)t[e]*=s;else if('/='===r)for(let e=0;e<t.length;++e)t[e]/=s;else if('%='===r)for(let e=0;e<t.length;++e)t[e]%=s;else if('&='===r)for(let e=0;e<t.length;++e)t[e]&=s;else if('|='===r)for(let e=0;e<t.length;++e)t[e]|=s;else if('^='===r)for(let e=0;e<t.length;++e)t[e]^=s;else if('<<='===r)for(let e=0;e<t.length;++e)t[e]<<=s;else if('>>='===r)for(let e=0;e<t.length;++e)t[e]>>=s;else console.error(`Invalid operator ${r}. Line ${e.line}`)}else if(n instanceof Ts&&i instanceof Ts){const t=n.value,s=i.value;if(t.length!==s.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if('+='===r)for(let e=0;e<t.length;++e)t[e]+=s[e];else if('-='===r)for(let e=0;e<t.length;++e)t[e]-=s[e];else if('*='===r)for(let e=0;e<t.length;++e)t[e]*=s[e];else if('/='===r)for(let e=0;e<t.length;++e)t[e]/=s[e];else if('%='===r)for(let e=0;e<t.length;++e)t[e]%=s[e];else if('&='===r)for(let e=0;e<t.length;++e)t[e]&=s[e];else if('|='===r)for(let e=0;e<t.length;++e)t[e]|=s[e];else if('^='===r)for(let e=0;e<t.length;++e)t[e]^=s[e];else if('<<='===r)for(let e=0;e<t.length;++e)t[e]<<=s[e];else if('>>='===r)for(let e=0;e<t.length;++e)t[e]>>=s[e];else console.error(`Invalid operator ${r}. Line ${e.line}`)}else{if(!(n instanceof Os&&i instanceof Os))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);'+='===r?n.value+=i.value:'-='===r?n.value-=i.value:'*='===r?n.value*=i.value:'/='===r?n.value/=i.value:'%='===r?n.value%=i.value:'&='===r?n.value&=i.value:'|='===r?n.value|=i.value:'^='===r?n.value^=i.value:'<<='===r?n.value<<=i.value:'>>='===r?n.value>>=i.value:console.error(`Invalid operator ${r}. Line ${e.line}`)}s.value instanceof Cs&&s.value.setDataValue(this,n,e.variable.postfix,t)}}_function(e,t){const n=new Ns(e);t.functions.set(e.name,n)}_const(e,t){let n=null;null!=e.value&&(n=this.evalExpression(e.value,t)),t.createVariable(e.name,n,e)}_let(e,t){let n=null;null!=e.value&&(n=this.evalExpression(e.value,t)),t.createVariable(e.name,n,e)}_var(e,t){let n=null;if(null!==e.value)n=this.evalExpression(e.value,t);else{if(null===e.type)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);if('f32'===e.type.name||'i32'===e.type.name||'u32'===e.type.name||'bool'===e.type.name||'f16'===e.type.name||'vec2'===e.type.name||'vec3'===e.type.name||'vec4'===e.type.name||'vec2f'===e.type.name||'vec3f'===e.type.name||'vec4f'===e.type.name||'vec2i'===e.type.name||'vec3i'===e.type.name||'vec4i'===e.type.name||'vec2u'===e.type.name||'vec3u'===e.type.name||'vec4u'===e.type.name||'vec2h'===e.type.name||'vec3h'===e.type.name||'vec4h'===e.type.name||'mat2x2'===e.type.name||'mat2x3'===e.type.name||'mat2x4'===e.type.name||'mat3x2'===e.type.name||'mat3x3'===e.type.name||'mat3x4'===e.type.name||'mat4x2'===e.type.name||'mat4x3'===e.type.name||'mat4x4'===e.type.name||'mat2x2f'===e.type.name||'mat2x3f'===e.type.name||'mat2x4f'===e.type.name||'mat3x2f'===e.type.name||'mat3x3f'===e.type.name||'mat3x4f'===e.type.name||'mat4x2f'===e.type.name||'mat4x3f'===e.type.name||'mat4x4f'===e.type.name||'mat2x2h'===e.type.name||'mat2x3h'===e.type.name||'mat2x4h'===e.type.name||'mat3x2h'===e.type.name||'mat3x3h'===e.type.name||'mat3x4h'===e.type.name||'mat4x2h'===e.type.name||'mat4x3h'===e.type.name||'mat4x4h'===e.type.name){const s=new is(e.type,[]);n=this._evalCreate(s,t)}if('array'===e.type.name){const s=new is(e.type,[]);n=this._evalCreate(s,t)}}t.createVariable(e.name,n,e)}_if(e,t){t=t.clone();const n=this.evalExpression(e.condition,t);if(!(n instanceof Os))return console.error(`Invalid if condition. Line ${e.line}`),null;if(n.value)return this._execStatements(e.body,t);for(const n of e.elseif){const s=this.evalExpression(n.condition,t);if(!(s instanceof Os))return console.error(`Invalid if condition. Line ${e.line}`),null;if(s.value)return this._execStatements(n.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof Os?e.value:(console.error('Expected scalar value.',e),0)}_for(e,t){for(t=t.clone(),this.execStatement(e.init,t);this._getScalarValue(this.evalExpression(e.condition,t));){const n=this._execStatements(e.body,t);if(n===Zs._breakObj)break;if(null!==n&&n!==Zs._continueObj)return n;this.execStatement(e.increment,t)}return null}_loop(e,t){for(t=t.clone();;){const n=this._execStatements(e.body,t);if(n===Zs._breakObj)break;if(n===Zs._continueObj){if(e.continuing){if(this._execStatements(e.continuing.body,t)===Zs._breakObj)break}}else if(null!==n)return n}return null}_while(e,t){for(t=t.clone();this._getScalarValue(this.evalExpression(e.condition,t));){const n=this._execStatements(e.body,t);if(n===Zs._breakObj)break;if(n!==Zs._continueObj&&null!==n)return n}return null}_evalBitcast(e,t){const n=this.evalExpression(e.value,t),s=e.type;if(n instanceof Os){const e=Ks(n.value,n.typeInfo.name,s.name);return new Os(e,this.getTypeInfo(s))}if(n instanceof Ts){const t=this.getTypeName(n.typeInfo);let i='';if(t.endsWith('f'))i='f32';else if(t.endsWith('i'))i='i32';else if(t.endsWith('u'))i='u32';else if(t.endsWith('b'))i='bool';else{if(!t.endsWith('h'))return console.error(`Unknown vector type ${t}. Line ${e.line}`),null;i='f16'}const r=this.getTypeName(s);let o='';if(r.endsWith('f'))o='f32';else if(r.endsWith('i'))o='i32';else if(r.endsWith('u'))o='u32';else if(r.endsWith('b'))o='bool';else{if(!r.endsWith('h'))return console.error(`Unknown vector type ${o}. Line ${e.line}`),null;o='f16'}const a=function(e,t,n){if(t===n)return e;const s=new Array(e.length);for(let i=0;i<e.length;i++)s[i]=Ks(e[i],t,n);return s}(n.value,i,o);return new Ts(a,this.getTypeInfo(s))}return console.error(`TODO: bitcast for ${n.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){const n=t.getVariableValue(e.name);return e.postfix?n.getDataValue(this,e.postfix,t):n}_evalCreate(e,t){var n;if(null===e.type)return ks.void;const s=this.getTypeName(e.type);switch(s){case'bool':case'i32':case'u32':case'f32':case'f16':return this._callConstructorValue(e,t);case'vec2':case'vec3':case'vec4':case'vec2f':case'vec3f':case'vec4f':case'vec2h':case'vec3h':case'vec4h':case'vec2i':case'vec3i':case'vec4i':case'vec2u':case'vec3u':case'vec4u':case'vec2b':case'vec3b':case'vec4b':return this._callConstructorVec(e,t);case'mat2x2':case'mat2x2f':case'mat2x2h':case'mat2x3':case'mat2x3f':case'mat2x3h':case'mat2x4':case'mat2x4f':case'mat2x4h':case'mat3x2':case'mat3x2f':case'mat3x2h':case'mat3x3':case'mat3x3f':case'mat3x3h':case'mat3x4':case'mat3x4f':case'mat3x4h':case'mat4x2':case'mat4x2f':case'mat4x2h':case'mat4x3':case'mat4x3f':case'mat4x3h':case'mat4x4':case'mat4x4f':case'mat4x4h':return this._callConstructorMatrix(e,t)}const i=this.getTypeInfo(e.type);if(null===i)return console.error(`Unknown type ${s}. Line ${e.line}`),null;if(0===i.size)return null;const r=new Cs(new ArrayBuffer(i.size),i,0);if(i instanceof on){if(e.args)for(let n=0;n<e.args.length;++n){const s=i.members[n],o=e.args[n],a=this.evalExpression(o,t);r.setData(this,a,s.type,s.offset,t)}}else if(i instanceof an){let s=0;if(e.args)for(let o=0;o<e.args.length;++o){const a=e.args[o],l=this.evalExpression(a,t);null===i.format&&('x32'===(null===(n=l.typeInfo)||void 0===n?void 0:n.name)?i.format=this.getTypeInfo('i32'):i.format=l.typeInfo),r.setData(this,l,i.format,s,t),s+=i.stride}}else console.error(`Unknown type "${s}". Line ${e.line}`);return r}_evalLiteral(e,t){const n=this.getTypeInfo(e.type),s=n.name;if('x32'===s||'u32'===s||'f32'===s||'f16'===s||'i32'===s||'bool'===s){return new Os(e.scalarValue,n)}return'vec2'===s||'vec3'===s||'vec4'===s||'vec2f'===s||'vec3f'===s||'vec4f'===s||'vec2h'===s||'vec3h'===s||'vec4h'===s||'vec2i'===s||'vec3i'===s||'vec4i'===s||'vec2u'===s||'vec3u'===s||'vec4u'===s?this._callConstructorVec(e,t):'mat2x2'===s||'mat2x3'===s||'mat2x4'===s||'mat3x2'===s||'mat3x3'===s||'mat3x4'===s||'mat4x2'===s||'mat4x3'===s||'mat4x4'===s||'mat2x2f'===s||'mat2x3f'===s||'mat2x4f'===s||'mat3x2f'===s||'mat3x3f'===s||'mat3x4f'===s||'mat4x2f'===s||'mat4x3f'===s||'mat4x4f'===s||'mat2x2h'===s||'mat2x3h'===s||'mat2x4h'===s||'mat3x2h'===s||'mat3x3h'===s||'mat3x4h'===s||'mat4x2h'===s||'mat4x3h'===s||'mat4x4h'===s?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){const n=t.getVariableValue(e.name);return null===n?n:(null==e?void 0:e.postfix)?n.getDataValue(this,e.postfix,t):n}_maxFormatTypeInfo(e){let t=e[0];if('f32'===t.name)return t;for(let n=1;n<e.length;++n){const s=Zs._priority.get(t.name);Zs._priority.get(e[n].name)<s&&(t=e[n])}return'x32'===t.name?this.getTypeInfo('i32'):t}_evalUnaryOp(e,t){const n=this.evalExpression(e.right,t),s=n instanceof Os||n instanceof Ts?n.value:null;switch(e.operator){case'+':{if(zs(s)){const e=s.map(((e,t)=>+e));return new Ts(e,n.typeInfo)}const e=s,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new Os(+e,t)}case'-':{if(zs(s)){const e=s.map(((e,t)=>-e));return new Ts(e,n.typeInfo)}const e=s,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new Os(-e,t)}case'!':{if(zs(s)){const e=s.map(((e,t)=>e?0:1));return new Ts(e,n.typeInfo)}const e=s,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new Os(e?0:1,t)}case'~':{if(zs(s)){const e=s.map(((e,t)=>~e));return new Ts(e,n.typeInfo)}const e=s,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new Os(~e,t)}}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){const n=this.evalExpression(e.left,t),s=this.evalExpression(e.right,t),i=n instanceof Os||n instanceof Ts||n instanceof Is?n.value:null,r=s instanceof Os||s instanceof Ts||s instanceof Is?s.value:null;switch(e.operator){case'+':{if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e+s[t]));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t+e));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e+t));return new Ts(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Os(t+o,a)}case'-':{if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e-s[t]));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t-e));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e-t));return new Ts(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Os(t-o,a)}case'*':{if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e*s[t]));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t*e));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e*t));return new Ts(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Os(t*o,a)}case'%':{if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e%s[t]));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t%e));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e%t));return new Ts(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Os(t%o,a)}case'/':{if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e/s[t]));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t/e));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e/t));return new Ts(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Os(t/o,a)}case'&':{if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e&s[t]));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t&e));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e&t));return new Ts(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Os(t&o,a)}case'|':{if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e|s[t]));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t|e));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e|t));return new Ts(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Os(t|o,a)}case'^':{if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e^s[t]));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t^e));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e^t));return new Ts(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Os(t^o,a)}case'<<':{if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e<<s[t]));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t<<e));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e<<t));return new Ts(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Os(t<<o,a)}case'>>':{if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e>>s[t]));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t>>e));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e>>t));return new Ts(t,s.typeInfo)}const t=i,o=r,a=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new Os(t>>o,a)}case'>':if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e>s[t]?1:0));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t>e?1:0));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e>t?1:0));return new Ts(t,s.typeInfo)}return new Os(i>r?1:0,this.getTypeInfo('bool'));case'<':if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e<s[t]?1:0));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t<e?1:0));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e<t?1:0));return new Ts(t,s.typeInfo)}return new Os(i<r?1:0,this.getTypeInfo('bool'));case'==':if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e===s[t]?1:0));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t==e?1:0));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e==t?1:0));return new Ts(t,s.typeInfo)}return new Os(i===r?1:0,this.getTypeInfo('bool'));case'!=':if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e!==s[t]?1:0));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t!==e?1:0));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e!==t?1:0));return new Ts(t,s.typeInfo)}return new Os(i!==r?1:0,this.getTypeInfo('bool'));case'>=':if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e>=s[t]?1:0));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t>=e?1:0));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e>=t?1:0));return new Ts(t,s.typeInfo)}return new Os(i>=r?1:0,this.getTypeInfo('bool'));case'<=':if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e<=s[t]?1:0));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t<=e?1:0));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e<=t?1:0));return new Ts(t,s.typeInfo)}return new Os(i<=r?1:0,this.getTypeInfo('bool'));case'&&':if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e&&s[t]?1:0));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t&&e?1:0));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e&&t?1:0));return new Ts(t,s.typeInfo)}return new Os(i&&r?1:0,this.getTypeInfo('bool'));case'||':if(zs(i)&&zs(r)){const t=i,s=r;if(t.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const o=t.map(((e,t)=>e||s[t]?1:0));return new Ts(o,n.typeInfo)}if(zs(i)){const e=r,t=i.map(((t,n)=>t||e?1:0));return new Ts(t,n.typeInfo)}if(zs(r)){const e=i,t=r.map(((t,n)=>e||t?1:0));return new Ts(t,s.typeInfo)}return new Os(i||r?1:0,this.getTypeInfo('bool'))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(null!==e.cachedReturnValue)return e.cachedReturnValue;const n=t.clone();n.currentFunctionName=e.name;const s=t.functions.get(e.name);if(!s)return this._callBuiltinFunction(e,n);for(let t=0;t<s.node.args.length;++t){const i=s.node.args[t],r=this.evalExpression(e.args[t],n);n.setVariable(i.name,r,i)}return this._execStatements(s.node.body,n)}_callBuiltinFunction(e,t){switch(e.name){case'all':return this.builtins.All(e,t);case'any':return this.builtins.Any(e,t);case'select':return this.builtins.Select(e,t);case'arrayLength':return this.builtins.ArrayLength(e,t);case'abs':return this.builtins.Abs(e,t);case'acos':return this.builtins.Acos(e,t);case'acosh':return this.builtins.Acosh(e,t);case'asin':return this.builtins.Asin(e,t);case'asinh':return this.builtins.Asinh(e,t);case'atan':return this.builtins.Atan(e,t);case'atanh':return this.builtins.Atanh(e,t);case'atan2':return this.builtins.Atan2(e,t);case'ceil':return this.builtins.Ceil(e,t);case'clamp':return this.builtins.Clamp(e,t);case'cos':return this.builtins.Cos(e,t);case'cosh':return this.builtins.Cosh(e,t);case'countLeadingZeros':return this.builtins.CountLeadingZeros(e,t);case'countOneBits':return this.builtins.CountOneBits(e,t);case'countTrailingZeros':return this.builtins.CountTrailingZeros(e,t);case'cross':return this.builtins.Cross(e,t);case'degrees':return this.builtins.Degrees(e,t);case'determinant':return this.builtins.Determinant(e,t);case'distance':return this.builtins.Distance(e,t);case'dot':return this.builtins.Dot(e,t);case'dot4U8Packed':return this.builtins.Dot4U8Packed(e,t);case'dot4I8Packed':return this.builtins.Dot4I8Packed(e,t);case'exp':return this.builtins.Exp(e,t);case'exp2':return this.builtins.Exp2(e,t);case'extractBits':return this.builtins.ExtractBits(e,t);case'faceForward':return this.builtins.FaceForward(e,t);case'firstLeadingBit':return this.builtins.FirstLeadingBit(e,t);case'firstTrailingBit':return this.builtins.FirstTrailingBit(e,t);case'floor':return this.builtins.Floor(e,t);case'fma':return this.builtins.Fma(e,t);case'fract':return this.builtins.Fract(e,t);case'frexp':return this.builtins.Frexp(e,t);case'insertBits':return this.builtins.InsertBits(e,t);case'inverseSqrt':return this.builtins.InverseSqrt(e,t);case'ldexp':return this.builtins.Ldexp(e,t);case'length':return this.builtins.Length(e,t);case'log':return this.builtins.Log(e,t);case'log2':return this.builtins.Log2(e,t);case'max':return this.builtins.Max(e,t);case'min':return this.builtins.Min(e,t);case'mix':return this.builtins.Mix(e,t);case'modf':return this.builtins.Modf(e,t);case'normalize':return this.builtins.Normalize(e,t);case'pow':return this.builtins.Pow(e,t);case'quantizeToF16':return this.builtins.QuantizeToF16(e,t);case'radians':return this.builtins.Radians(e,t);case'reflect':return this.builtins.Reflect(e,t);case'refract':return this.builtins.Refract(e,t);case'reverseBits':return this.builtins.ReverseBits(e,t);case'round':return this.builtins.Round(e,t);case'saturate':return this.builtins.Saturate(e,t);case'sign':return this.builtins.Sign(e,t);case'sin':return this.builtins.Sin(e,t);case'sinh':return this.builtins.Sinh(e,t);case'smoothStep':return this.builtins.SmoothStep(e,t);case'sqrt':return this.builtins.Sqrt(e,t);case'step':return this.builtins.Step(e,t);case'tan':return this.builtins.Tan(e,t);case'tanh':return this.builtins.Tanh(e,t);case'transpose':return this.builtins.Transpose(e,t);case'trunc':return this.builtins.Trunc(e,t);case'dpdx':return this.builtins.Dpdx(e,t);case'dpdxCoarse':return this.builtins.DpdxCoarse(e,t);case'dpdxFine':return this.builtins.DpdxFine(e,t);case'dpdy':return this.builtins.Dpdy(e,t);case'dpdyCoarse':return this.builtins.DpdyCoarse(e,t);case'dpdyFine':return this.builtins.DpdyFine(e,t);case'fwidth':return this.builtins.Fwidth(e,t);case'fwidthCoarse':return this.builtins.FwidthCoarse(e,t);case'fwidthFine':return this.builtins.FwidthFine(e,t);case'textureDimensions':return this.builtins.TextureDimensions(e,t);case'textureGather':return this.builtins.TextureGather(e,t);case'textureGatherCompare':return this.builtins.TextureGatherCompare(e,t);case'textureLoad':return this.builtins.TextureLoad(e,t);case'textureNumLayers':return this.builtins.TextureNumLayers(e,t);case'textureNumLevels':return this.builtins.TextureNumLevels(e,t);case'textureNumSamples':return this.builtins.TextureNumSamples(e,t);case'textureSample':return this.builtins.TextureSample(e,t);case'textureSampleBias':return this.builtins.TextureSampleBias(e,t);case'textureSampleCompare':return this.builtins.TextureSampleCompare(e,t);case'textureSampleCompareLevel':return this.builtins.TextureSampleCompareLevel(e,t);case'textureSampleGrad':return this.builtins.TextureSampleGrad(e,t);case'textureSampleLevel':return this.builtins.TextureSampleLevel(e,t);case'textureSampleBaseClampToEdge':return this.builtins.TextureSampleBaseClampToEdge(e,t);case'textureStore':return this.builtins.TextureStore(e,t);case'atomicLoad':return this.builtins.AtomicLoad(e,t);case'atomicStore':return this.builtins.AtomicStore(e,t);case'atomicAdd':return this.builtins.AtomicAdd(e,t);case'atomicSub':return this.builtins.AtomicSub(e,t);case'atomicMax':return this.builtins.AtomicMax(e,t);case'atomicMin':return this.builtins.AtomicMin(e,t);case'atomicAnd':return this.builtins.AtomicAnd(e,t);case'atomicOr':return this.builtins.AtomicOr(e,t);case'atomicXor':return this.builtins.AtomicXor(e,t);case'atomicExchange':return this.builtins.AtomicExchange(e,t);case'atomicCompareExchangeWeak':return this.builtins.AtomicCompareExchangeWeak(e,t);case'pack4x8snorm':return this.builtins.Pack4x8snorm(e,t);case'pack4x8unorm':return this.builtins.Pack4x8unorm(e,t);case'pack4xI8':return this.builtins.Pack4xI8(e,t);case'pack4xU8':return this.builtins.Pack4xU8(e,t);case'pack4x8Clamp':return this.builtins.Pack4x8Clamp(e,t);case'pack4xU8Clamp':return this.builtins.Pack4xU8Clamp(e,t);case'pack2x16snorm':return this.builtins.Pack2x16snorm(e,t);case'pack2x16unorm':return this.builtins.Pack2x16unorm(e,t);case'pack2x16float':return this.builtins.Pack2x16float(e,t);case'unpack4x8snorm':return this.builtins.Unpack4x8snorm(e,t);case'unpack4x8unorm':return this.builtins.Unpack4x8unorm(e,t);case'unpack4xI8':return this.builtins.Unpack4xI8(e,t);case'unpack4xU8':return this.builtins.Unpack4xU8(e,t);case'unpack2x16snorm':return this.builtins.Unpack2x16snorm(e,t);case'unpack2x16unorm':return this.builtins.Unpack2x16unorm(e,t);case'unpack2x16float':return this.builtins.Unpack2x16float(e,t);case'storageBarrier':return this.builtins.StorageBarrier(e,t);case'textureBarrier':return this.builtins.TextureBarrier(e,t);case'workgroupBarrier':return this.builtins.WorkgroupBarrier(e,t);case'workgroupUniformLoad':return this.builtins.WorkgroupUniformLoad(e,t);case'subgroupAdd':return this.builtins.SubgroupAdd(e,t);case'subgroupExclusiveAdd':return this.builtins.SubgroupExclusiveAdd(e,t);case'subgroupInclusiveAdd':return this.builtins.SubgroupInclusiveAdd(e,t);case'subgroupAll':return this.builtins.SubgroupAll(e,t);case'subgroupAnd':return this.builtins.SubgroupAnd(e,t);case'subgroupAny':return this.builtins.SubgroupAny(e,t);case'subgroupBallot':return this.builtins.SubgroupBallot(e,t);case'subgroupBroadcast':return this.builtins.SubgroupBroadcast(e,t);case'subgroupBroadcastFirst':return this.builtins.SubgroupBroadcastFirst(e,t);case'subgroupElect':return this.builtins.SubgroupElect(e,t);case'subgroupMax':return this.builtins.SubgroupMax(e,t);case'subgroupMin':return this.builtins.SubgroupMin(e,t);case'subgroupMul':return this.builtins.SubgroupMul(e,t);case'subgroupExclusiveMul':return this.builtins.SubgroupExclusiveMul(e,t);case'subgroupInclusiveMul':return this.builtins.SubgroupInclusiveMul(e,t);case'subgroupOr':return this.builtins.SubgroupOr(e,t);case'subgroupShuffle':return this.builtins.SubgroupShuffle(e,t);case'subgroupShuffleDown':return this.builtins.SubgroupShuffleDown(e,t);case'subgroupShuffleUp':return this.builtins.SubgroupShuffleUp(e,t);case'subgroupShuffleXor':return this.builtins.SubgroupShuffleXor(e,t);case'subgroupXor':return this.builtins.SubgroupXor(e,t);case'quadBroadcast':return this.builtins.QuadBroadcast(e,t);case'quadSwapDiagonal':return this.builtins.QuadSwapDiagonal(e,t);case'quadSwapX':return this.builtins.QuadSwapX(e,t);case'quadSwapY':return this.builtins.QuadSwapY(e,t)}const n=t.getFunction(e.name);if(n){const s=t.clone();for(let t=0;t<n.node.args.length;++t){const i=n.node.args[t],r=this.evalExpression(e.args[t],s);s.setVariable(i.name,r,i)}return this._execStatements(n.node.body,s)}return null}_callConstructorValue(e,t){if(!e.args||0===e.args.length)return new Os(0,this.getTypeInfo(e.type));const n=this.evalExpression(e.args[0],t);return n.typeInfo=this.getTypeInfo(e.type),n}_callConstructorVec(e,t){const n=this.getTypeInfo(e.type),s=this.getTypeName(e.type),i={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4}[s];if(void 0===i)return console.error(`Invalid vec constructor ${s}. Line ${e.line}`),null;const r=s.endsWith('i')||s.endsWith('u'),o=[];if(e instanceof ls)if(e.isVector){const t=e.vectorValue;for(const e of t)o.push(e)}else o.push(e.scalarValue);else if(e.args)for(const n of e.args){const e=this.evalExpression(n,t);if(e instanceof Ts){const t=e.value;for(let e=0;e<t.length;++e){let n=t[e];r&&(n=Math.floor(n)),o.push(n)}}else if(e instanceof Os){let t=e.value;r&&(t=Math.floor(t)),o.push(t)}}if(e.type instanceof Zn&&null===e.type.format&&(e.type.format=Zn.f32),0===o.length){const e=new Array(i).fill(0);return new Ts(e,n)}if(1===o.length)for(;o.length<i;)o.push(o[0]);return o.length<i?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new Ts(o.length>i?o.slice(0,i):o,n)}_callConstructorMatrix(e,t){const n=this.getTypeInfo(e.type),s=this.getTypeName(e.type),i={mat2x2:4,mat2x2f:4,mat2x2h:4,mat2x3:6,mat2x3f:6,mat2x3h:6,mat2x4:8,mat2x4f:8,mat2x4h:8,mat3x2:6,mat3x2f:6,mat3x2h:6,mat3x3:9,mat3x3f:9,mat3x3h:9,mat3x4:12,mat3x4f:12,mat3x4h:12,mat4x2:8,mat4x2f:8,mat4x2h:8,mat4x3:12,mat4x3f:12,mat4x3h:12,mat4x4:16,mat4x4f:16,mat4x4h:16}[s];if(void 0===i)return console.error(`Invalid matrix constructor ${s}. Line ${e.line}`),null;const r=[];if(e instanceof ls)if(e.isVector){const t=e.vectorValue;for(const e of t)r.push(e)}else r.push(e.scalarValue);else if(e.args)for(const n of e.args){const e=this.evalExpression(n,t);if(e instanceof Ts){const t=e.value;for(let e=0;e<t.length;++e)r.push(t[e])}else e instanceof Os?r.push(e.value):e instanceof Is&&r.push(...e.value)}if(n instanceof ln&&null===n.format&&(n.format=this.getTypeInfo('f32')),0===r.length){const e=new Array(i).fill(0);return new Is(e,n)}return r.length!==i?(console.error(`Invalid matrix constructor. Line ${e.line}`),null):new Is(r,n)}}Zs._breakObj=new ws(new sn('BREAK',null)),Zs._continueObj=new ws(new sn('CONTINUE',null)),Zs._priority=new Map([['f32',0],['f16',1],['u32',2],['i32',3],['x32',3]]);class Js{constructor(){this._tokens=[],this._current=0,this._currentLine=0,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new wn,this._exec=new Zs}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const e=this._global_decl_or_directive();if(!e)break;t.push(e)}if(this._deferArrayCountEval.length>0){for(const e of this._deferArrayCountEval){const t=e.arrayType,n=e.countNode;if(n instanceof os){const e=n.name,s=this._context.constants.get(e);if(s)try{const e=s.constEvaluate(this._exec);t.count=e}catch(e){}}}this._deferArrayCountEval.length=0}return t}_initialize(e){if(e)if('string'==typeof e){const t=new Ps(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_updateNode(e,t){return e.line=null!=t?t:this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==As.eof}_match(e){if(e instanceof $s)return!!this._check(e)&&(this._advance(),!0);for(let t=0,n=e.length;t<n;++t){const n=e[t];if(this._check(n))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const n=t.type;return-1!=e.indexOf(n)}return t.type==e}_advance(){var e,t;return this._currentLine=null!==(t=null===(e=this._peek())||void 0===e?void 0:e.line)&&void 0!==t?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(As.tokens.semicolon)&&!this._isAtEnd(););if(this._match(As.keywords.alias)){const e=this._type_alias();return this._consume(As.tokens.semicolon,'Expected \';\''),this._exec.reflection.updateAST([e]),e}if(this._match(As.keywords.diagnostic)){const e=this._diagnostic();return this._consume(As.tokens.semicolon,'Expected \';\''),this._exec.reflection.updateAST([e]),e}if(this._match(As.keywords.requires)){const e=this._requires_directive();return this._consume(As.tokens.semicolon,'Expected \';\''),this._exec.reflection.updateAST([e]),e}if(this._match(As.keywords.enable)){const e=this._enable_directive();return this._consume(As.tokens.semicolon,'Expected \';\''),this._exec.reflection.updateAST([e]),e}const e=this._attribute();if(this._check(As.keywords.var)){const t=this._global_variable_decl();return null!=t&&(t.attributes=e),this._consume(As.tokens.semicolon,'Expected \';\'.'),this._exec.reflection.updateAST([t]),t}if(this._check(As.keywords.override)){const t=this._override_variable_decl();return null!=t&&(t.attributes=e),this._consume(As.tokens.semicolon,'Expected \';\'.'),this._exec.reflection.updateAST([t]),t}if(this._check(As.keywords.let)){const t=this._global_let_decl();return null!=t&&(t.attributes=e),this._consume(As.tokens.semicolon,'Expected \';\'.'),this._exec.reflection.updateAST([t]),t}if(this._check(As.keywords.const)){const t=this._global_const_decl();return null!=t&&(t.attributes=e),this._consume(As.tokens.semicolon,'Expected \';\'.'),this._exec.reflection.updateAST([t]),t}if(this._check(As.keywords.struct)){const t=this._struct_decl();return null!=t&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(As.keywords.fn)){const t=this._function_decl();return null!=t&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(As.keywords.fn))return null;const e=this._currentLine,t=this._consume(As.tokens.ident,'Expected function name.').toString();this._consume(As.tokens.paren_left,'Expected \'(\' for function arguments.');const n=[];if(!this._check(As.tokens.paren_right))do{if(this._check(As.tokens.paren_right))break;const e=this._attribute(),t=this._consume(As.tokens.ident,'Expected argument name.').toString();this._consume(As.tokens.colon,'Expected \':\' for argument type.');const s=this._attribute(),i=this._type_decl();null!=i&&(i.attributes=s,n.push(this._updateNode(new xs(t,i,e))))}while(this._match(As.tokens.comma));this._consume(As.tokens.paren_right,'Expected \')\' after function arguments.');let s=null;if(this._match(As.tokens.arrow)){const e=this._attribute();s=this._type_decl(),null!=s&&(s.attributes=e)}const i=this._compound_statement(),r=this._currentLine;return this._updateNode(new In(t,n,s,i,e,r),e)}_compound_statement(){const e=[];for(this._consume(As.tokens.brace_left,'Expected \'{\' for block.');!this._check(As.tokens.brace_right);){const t=this._statement();null!==t&&e.push(t)}return this._consume(As.tokens.brace_right,'Expected \'}\' for block.'),e}_statement(){for(;this._match(As.tokens.semicolon)&&!this._isAtEnd(););if(this._check(As.tokens.attr)&&this._attribute(),this._check(As.keywords.if))return this._if_statement();if(this._check(As.keywords.switch))return this._switch_statement();if(this._check(As.keywords.loop))return this._loop_statement();if(this._check(As.keywords.for))return this._for_statement();if(this._check(As.keywords.while))return this._while_statement();if(this._check(As.keywords.continuing))return this._continuing_statement();if(this._check(As.keywords.static_assert))return this._static_assert_statement();if(this._check(As.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(As.keywords.return))e=this._return_statement();else if(this._check([As.keywords.var,As.keywords.let,As.keywords.const]))e=this._variable_statement();else if(this._match(As.keywords.discard))e=this._updateNode(new Gn);else if(this._match(As.keywords.break)){const t=this._updateNode(new qn);if(!(this._currentLoop.length>0))throw this._error(this._peek(),'Break statement must be inside a loop.');{const e=this._currentLoop[this._currentLoop.length-1];t.loopId=e.id}e=t,this._check(As.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression(),t.condition instanceof hs&&1===t.condition.contents.length&&(t.condition=t.condition.contents[0]))}else if(this._match(As.keywords.continue)){const t=this._updateNode(new Hn);if(!(this._currentLoop.length>0))throw this._error(this._peek(),'Continue statement must be inside a loop.');{const e=this._currentLoop[this._currentLoop.length-1];t.loopId=e.id}e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return null!=e&&this._consume(As.tokens.semicolon,'Expected \';\' after statement.'),e}_static_assert_statement(){if(!this._match(As.keywords.static_assert))return null;const e=this._optional_paren_expression();return this._updateNode(new Cn(e))}_while_statement(){if(!this._match(As.keywords.while))return null;const e=this._updateNode(new $n(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(As.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){if(!this._match(As.keywords.continuing))return null;const e=this._compound_statement();return this._updateNode(new An(e))}_for_statement(){if(!this._match(As.keywords.for))return null;this._consume(As.tokens.paren_left,'Expected \'(\'.');const e=this._updateNode(new En(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(As.tokens.semicolon)?null:this._for_init(),this._consume(As.tokens.semicolon,'Expected \';\'.'),e.condition=this._check(As.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(As.tokens.semicolon,'Expected \';\'.'),e.increment=this._check(As.tokens.paren_right)?null:this._for_increment(),this._consume(As.tokens.paren_right,'Expected \')\'.'),this._check(As.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(As.keywords.var)){const e=this._variable_decl();if(null===e)throw this._error(this._peek(),'Variable declaration expected.');let t=null;return this._match(As.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new Pn(e.name,e.type,e.storage,e.access,t))}if(this._match(As.keywords.let)){const e=this._consume(As.tokens.ident,'Expected name for let.').toString();let t=null;if(this._match(As.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}this._consume(As.tokens.equal,'Expected \'=\' for let.');const n=this._short_circuit_or_expression();return this._updateNode(new Mn(e,t,null,null,n))}if(this._match(As.keywords.const)){const e=this._consume(As.tokens.ident,'Expected name for const.').toString();let t=null;if(this._match(As.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}this._consume(As.tokens.equal,'Expected \'=\' for const.');const n=this._short_circuit_or_expression();return null===t&&n instanceof ls&&(t=n.type),this._updateNode(new Ln(e,t,null,null,n))}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(null==t)return null;if(!this._check(As.increment_operators))return this._current=e,null;const n=this._consume(As.increment_operators,'Expected increment operator');return this._updateNode(new Bn(n.type===As.tokens.plus_plus?hn.increment:hn.decrement,t))}_assignment_statement(){let e=null;if(this._check(As.tokens.brace_right))return null;let t=this._match(As.tokens.underscore);if(t||(e=this._unary_expression()),!t&&null==e)return null;const n=this._consume(As.assignment_operators,'Expected assignment operator.'),s=this._short_circuit_or_expression();return this._updateNode(new Nn(un.parse(n.lexeme),e,s))}_func_call_statement(){if(!this._check(As.tokens.ident))return null;const e=this._current,t=this._consume(As.tokens.ident,'Expected function name.'),n=this._argument_expression_list();return null===n?(this._current=e,null):this._updateNode(new Rn(t.lexeme,n))}_loop_statement(){if(!this._match(As.keywords.loop))return null;this._check(As.tokens.attr)&&this._attribute(),this._consume(As.tokens.brace_left,'Expected \'{\' for loop.');const e=this._updateNode(new Fn([],null));this._currentLoop.push(e);let t=this._statement();for(;null!==t;){if(Array.isArray(t))for(let n of t)e.body.push(n);else e.body.push(t);if(t instanceof An){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(As.tokens.brace_right,'Expected \'}\' for loop.'),e}_switch_statement(){if(!this._match(As.keywords.switch))return null;const e=this._optional_paren_expression();this._check(As.tokens.attr)&&this._attribute(),this._consume(As.tokens.brace_left,'Expected \'{\' for switch.');const t=this._switch_body();if(null==t||0==t.length)throw this._error(this._previous(),'Expected \'case\' or \'default\'.');return this._consume(As.tokens.brace_right,'Expected \'}\' for switch.'),this._updateNode(new Vn(e,t))}_switch_body(){const e=[];if(this._match(As.keywords.case)){const t=this._case_selectors();this._match(As.tokens.colon),this._check(As.tokens.attr)&&this._attribute(),this._consume(As.tokens.brace_left,'Exected \'{\' for switch case.');const n=this._case_body();this._consume(As.tokens.brace_right,'Exected \'}\' for switch case.'),e.push(this._updateNode(new gs(t,n)))}if(this._match(As.keywords.default)){this._match(As.tokens.colon),this._check(As.tokens.attr)&&this._attribute(),this._consume(As.tokens.brace_left,'Exected \'{\' for switch default.');const t=this._case_body();this._consume(As.tokens.brace_right,'Exected \'}\' for switch default.'),e.push(this._updateNode(new vs(t)))}if(this._check([As.keywords.default,As.keywords.case])){const t=this._switch_body();e.push(t[0])}return e}_case_selectors(){const e=[this._shift_expression()];for(;this._match(As.tokens.comma);)e.push(this._shift_expression());return e}_case_body(){if(this._match(As.keywords.fallthrough))return this._consume(As.tokens.semicolon,'Expected \';\''),[];let e=this._statement();if(null==e)return[];e instanceof Array||(e=[e]);const t=this._case_body();return 0==t.length?e:[...e,t[0]]}_if_statement(){if(!this._match(As.keywords.if))return null;const e=this._currentLine,t=this._optional_paren_expression();this._check(As.tokens.attr)&&this._attribute();const n=this._compound_statement();let s=[];this._match_elseif()&&(this._check(As.tokens.attr)&&this._attribute(),s=this._elseif_statement(s));let i=null;return this._match(As.keywords.else)&&(this._check(As.tokens.attr)&&this._attribute(),i=this._compound_statement()),this._updateNode(new zn(t,n,s,i),e)}_match_elseif(){return this._tokens[this._current].type===As.keywords.else&&this._tokens[this._current+1].type===As.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),n=this._compound_statement();return e.push(this._updateNode(new bs(t,n))),this._match_elseif()&&(this._check(As.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(As.keywords.return))return null;const e=this._short_circuit_or_expression();return this._updateNode(new Un(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(As.tokens.or_or);)e=this._updateNode(new ps(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(As.tokens.and_and);)e=this._updateNode(new ps(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(As.tokens.or);)e=this._updateNode(new ps(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(As.tokens.xor);)e=this._updateNode(new ps(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(As.tokens.and);)e=this._updateNode(new ps(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){const e=this._relational_expression();return this._match([As.tokens.equal_equal,As.tokens.not_equal])?this._updateNode(new ps(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([As.tokens.less_than,As.tokens.greater_than,As.tokens.less_than_equal,As.tokens.greater_than_equal]);)e=this._updateNode(new ps(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([As.tokens.shift_left,As.tokens.shift_right]);)e=this._updateNode(new ps(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([As.tokens.plus,As.tokens.minus]);)e=this._updateNode(new ps(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([As.tokens.star,As.tokens.forward_slash,As.tokens.modulo]);)e=this._updateNode(new ps(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([As.tokens.minus,As.tokens.bang,As.tokens.tilde,As.tokens.star,As.tokens.and])?this._updateNode(new fs(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(As.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(As.tokens.bracket_right,'Expected \']\'.');const t=this._updateNode(new us(e)),n=this._postfix_expression();return n&&(t.postfix=n),t}if(this._match(As.tokens.period)){const e=this._consume(As.tokens.ident,'Expected member name.'),t=this._postfix_expression(),n=this._updateNode(new ss(e.lexeme));return t&&(n.postfix=t),n}return null}_getStruct(e){if(this._context.aliases.has(e)){return this._context.aliases.get(e).type}if(this._context.structs.has(e)){return this._context.structs.get(e)}return null}_getType(e){const t=this._getStruct(e);if(null!==t)return t;switch(e){case'bool':return Yn.bool;case'i32':return Yn.i32;case'u32':return Yn.u32;case'f32':return Yn.f32;case'f16':return Yn.f16;case'vec2f':return Zn.vec2f;case'vec3f':return Zn.vec3f;case'vec4f':return Zn.vec4f;case'vec2i':return Zn.vec2i;case'vec3i':return Zn.vec3i;case'vec4i':return Zn.vec4i;case'vec2u':return Zn.vec2u;case'vec3u':return Zn.vec3u;case'vec4u':return Zn.vec4u;case'vec2h':return Zn.vec2h;case'vec3h':return Zn.vec3h;case'vec4h':return Zn.vec4h;case'mat2x2f':return Zn.mat2x2f;case'mat2x3f':return Zn.mat2x3f;case'mat2x4f':return Zn.mat2x4f;case'mat3x2f':return Zn.mat3x2f;case'mat3x3f':return Zn.mat3x3f;case'mat3x4f':return Zn.mat3x4f;case'mat4x2f':return Zn.mat4x2f;case'mat4x3f':return Zn.mat4x3f;case'mat4x4f':return Zn.mat4x4f;case'mat2x2h':return Zn.mat2x2h;case'mat2x3h':return Zn.mat2x3h;case'mat2x4h':return Zn.mat2x4h;case'mat3x2h':return Zn.mat3x2h;case'mat3x3h':return Zn.mat3x3h;case'mat3x4h':return Zn.mat3x4h;case'mat4x2h':return Zn.mat4x2h;case'mat4x3h':return Zn.mat4x3h;case'mat4x4h':return Zn.mat4x4h}return null}_validateTypeRange(e,t){if('i32'===t.name){if(e<-2147483648||e>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if('u32'===t.name&&(e<0||e>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(As.tokens.ident)){const e=this._previous().toString();if(this._check(As.tokens.paren_left)){const t=this._argument_expression_list(),n=this._getType(e);return null!==n?this._updateNode(new is(n,t)):this._updateNode(new rs(e,t))}if(this._context.constants.has(e)){const t=this._context.constants.get(e);return this._updateNode(new as(e,t.value))}return this._updateNode(new os(e))}if(this._match(As.tokens.int_literal)){const e=this._previous().toString();let t=e.endsWith('i')||e.endsWith('i')?Yn.i32:e.endsWith('u')||e.endsWith('U')?Yn.u32:Yn.x32;const n=parseInt(e);return this._validateTypeRange(n,t),this._updateNode(new ls(new Os(n,this._exec.getTypeInfo(t)),t))}if(this._match(As.tokens.uint_literal)){const e=parseInt(this._previous().toString());return this._validateTypeRange(e,Yn.u32),this._updateNode(new ls(new Os(e,this._exec.getTypeInfo(Yn.u32)),Yn.u32))}if(this._match([As.tokens.decimal_float_literal,As.tokens.hex_float_literal])){let e=this._previous().toString(),t=e.endsWith('h');t&&(e=e.substring(0,e.length-1));const n=parseFloat(e);this._validateTypeRange(n,t?Yn.f16:Yn.f32);const s=t?Yn.f16:Yn.f32;return this._updateNode(new ls(new Os(n,this._exec.getTypeInfo(s)),s))}if(this._match([As.keywords.true,As.keywords.false])){let e=this._previous().toString()===As.keywords.true.rule;return this._updateNode(new ls(new Os(e?1:0,this._exec.getTypeInfo(Yn.bool)),Yn.bool))}if(this._check(As.tokens.paren_left))return this._paren_expression();if(this._match(As.keywords.bitcast)){this._consume(As.tokens.less_than,'Expected \'<\'.');const e=this._type_decl();this._consume(As.tokens.greater_than,'Expected \'>\'.');const t=this._paren_expression();return this._updateNode(new cs(e,t))}const e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new is(e,t))}_argument_expression_list(){if(!this._match(As.tokens.paren_left))return null;const e=[];do{if(this._check(As.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(As.tokens.comma));return this._consume(As.tokens.paren_right,'Expected \')\' for agument list'),e}_optional_paren_expression(){this._match(As.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(As.tokens.paren_right),this._updateNode(new hs([e]))}_paren_expression(){this._consume(As.tokens.paren_left,'Expected \'(\'.');const e=this._short_circuit_or_expression();return this._consume(As.tokens.paren_right,'Expected \')\'.'),this._updateNode(new hs([e]))}_struct_decl(){if(!this._match(As.keywords.struct))return null;const e=this._currentLine,t=this._consume(As.tokens.ident,'Expected name for struct.').toString();this._consume(As.tokens.brace_left,'Expected \'{\' for struct body.');const n=[];for(;!this._check(As.tokens.brace_right);){const e=this._attribute(),t=this._consume(As.tokens.ident,'Expected variable name.').toString();this._consume(As.tokens.colon,'Expected \':\' for struct member type.');const s=this._attribute(),i=this._type_decl();null!=i&&(i.attributes=s),this._check(As.tokens.brace_right)?this._match(As.tokens.comma):this._consume(As.tokens.comma,'Expected \',\' for struct member.'),n.push(this._updateNode(new ys(t,i,e)))}this._consume(As.tokens.brace_right,'Expected \'}\' after struct body.');const s=this._currentLine,i=this._updateNode(new Kn(t,n,e,s),e);return this._context.structs.set(t,i),i}_global_variable_decl(){const e=this._variable_decl();if(!e)return null;if(this._match(As.tokens.equal)){const t=this._const_expression(),n=[Yn.f32];try{const s=t.constEvaluate(this._exec,n);e.value=new ls(s,n[0]),this._exec.context.setVariable(e.name,s)}catch(n){e.value=t}}else{const t=new is(e.type,null),n=this._exec.evalExpression(t,this._exec.context);null!==n&&(e.value=new ls(n,e.type),this._exec.context.setVariable(e.name,n))}if(null!==e.type&&e.value instanceof ls){if('x32'!==e.value.type.name&&e.type.name!==e.value.type.name)throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else null===e.type&&e.value instanceof ls&&(e.type='x32'===e.value.type.name?Yn.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(As.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){var e;if(!this._match(As.keywords.const))return null;const t=this._consume(As.tokens.ident,'Expected variable name');let n=null;if(this._match(As.tokens.colon)){const e=this._attribute();n=this._type_decl(),null!=n&&(n.attributes=e)}let s=null;this._consume(As.tokens.equal,'const declarations require an assignment');const i=this._short_circuit_or_expression();try{let e=[Yn.f32];const n=i.constEvaluate(this._exec,e);n instanceof Os&&this._validateTypeRange(n.value,e[0]),e[0]instanceof Zn&&null===e[0].format&&n.typeInfo instanceof ln&&null!==n.typeInfo.format&&('f16'===n.typeInfo.format.name?e[0].format=Yn.f16:'f32'===n.typeInfo.format.name?e[0].format=Yn.f32:'i32'===n.typeInfo.format.name?e[0].format=Yn.i32:'u32'===n.typeInfo.format.name?e[0].format=Yn.u32:'bool'===n.typeInfo.format.name?e[0].format=Yn.bool:console.error(`TODO: impelement template format type ${n.typeInfo.format.name}`)),s=this._updateNode(new ls(n,e[0])),this._exec.context.setVariable(t.toString(),n)}catch(e){s=i}if(null!==n&&s instanceof ls){if('x32'!==s.type.name&&n.name!==s.type.name)throw this._error(this._peek(),`Invalid cast from ${s.type.name} to ${n.name}. Line:${this._currentLine}`);s.type=n,this._validateTypeRange(s.scalarValue,s.type)}else null===n&&s instanceof ls&&(n=null!==(e=null==s?void 0:s.type)&&void 0!==e?e:Yn.f32,n===Yn.x32&&(n=Yn.i32));const r=this._updateNode(new Ln(t.toString(),n,'','',s));return this._context.constants.set(r.name,r),r}_global_let_decl(){if(!this._match(As.keywords.let))return null;const e=this._consume(As.tokens.ident,'Expected variable name');let t=null;if(this._match(As.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}let n=null;if(this._match(As.tokens.equal)){n=this._const_expression();const e=[Yn.f32];try{const t=n.constEvaluate(this._exec,e);null!==t&&(n=new ls(t,e[0]))}catch(e){}}if(null!==t&&n instanceof ls){if('x32'!==n.type.name&&t.name!==n.type.name)throw this._error(this._peek(),`Invalid cast from ${n.type.name} to ${t.name}. Line:${this._currentLine}`);n.type=t}else null===t&&n instanceof ls&&(t='x32'===n.type.name?Yn.i32:n.type);return n instanceof ls&&n.isScalar&&this._validateTypeRange(n.scalarValue,t),this._updateNode(new Mn(e.toString(),t,'','',n))}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(As.keywords.var))return null;let e='',t='';this._match(As.tokens.less_than)&&(e=this._consume(As.storage_class,'Expected storage_class.').toString(),this._match(As.tokens.comma)&&(t=this._consume(As.access_mode,'Expected access_mode.').toString()),this._consume(As.tokens.greater_than,'Expected \'>\'.'));const n=this._consume(As.tokens.ident,'Expected variable name');let s=null;if(this._match(As.tokens.colon)){const e=this._attribute();s=this._type_decl(),null!=s&&(s.attributes=e)}return this._updateNode(new Pn(n.toString(),s,e,t,null))}_override_decl(){if(!this._match(As.keywords.override))return null;const e=this._consume(As.tokens.ident,'Expected variable name');let t=null;if(this._match(As.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}return this._updateNode(new Dn(e.toString(),t,null))}_diagnostic(){this._consume(As.tokens.paren_left,'Expected \'(\'');const e=this._consume(As.tokens.ident,'Expected severity control name.');this._consume(As.tokens.comma,'Expected \',\'');let t=this._consume(As.tokens.ident,'Expected diagnostic rule name.').toString();if(this._match(As.tokens.period)){t+=`.${this._consume(As.tokens.ident,'Expected diagnostic message.').toString()}`}return this._consume(As.tokens.paren_right,'Expected \')\''),this._updateNode(new jn(e.toString(),t))}_enable_directive(){const e=this._consume(As.tokens.ident,'identity expected.');return this._updateNode(new Wn(e.toString()))}_requires_directive(){const e=[this._consume(As.tokens.ident,'identity expected.').toString()];for(;this._match(As.tokens.comma);){const t=this._consume(As.tokens.ident,'identity expected.');e.push(t.toString())}return this._updateNode(new Qn(e))}_type_alias(){const e=this._consume(As.tokens.ident,'identity expected.');this._consume(As.tokens.equal,'Expected \'=\' for type alias.');let t=this._type_decl();if(null===t)throw this._error(this._peek(),'Expected Type for Alias.');this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const n=this._updateNode(new Xn(e.toString(),t));return this._context.aliases.set(n.name,n),n}_type_decl(){if(this._check([As.tokens.ident,...As.texel_format,As.keywords.bool,As.keywords.f32,As.keywords.i32,As.keywords.u32])){const e=this._advance(),t=e.toString();return this._context.structs.has(t)?this._context.structs.get(t):this._context.aliases.has(t)?this._context.aliases.get(t).type:this._updateNode(new Yn(e.toString()))}let e=this._texture_sampler_types();if(e)return e;if(this._check(As.template_types)){let e=this._advance().toString(),t=null,n=null;return this._match(As.tokens.less_than)&&(t=this._type_decl(),n=null,this._match(As.tokens.comma)&&(n=this._consume(As.access_mode,'Expected access_mode for pointer').toString()),this._consume(As.tokens.greater_than,'Expected \'>\' for type.')),this._updateNode(new Zn(e,t,n))}if(this._match(As.keywords.ptr)){let e=this._previous().toString();this._consume(As.tokens.less_than,'Expected \'<\' for pointer.');const t=this._consume(As.storage_class,'Expected storage_class for pointer');this._consume(As.tokens.comma,'Expected \',\' for pointer.');const n=this._type_decl();let s=null;return this._match(As.tokens.comma)&&(s=this._consume(As.access_mode,'Expected access_mode for pointer').toString()),this._consume(As.tokens.greater_than,'Expected \'>\' for pointer.'),this._updateNode(new Jn(e,t.toString(),n,s))}const t=this._attribute();if(this._match(As.keywords.array)){let e=null,n=-1;const s=this._previous();let i=null;if(this._match(As.tokens.less_than)){e=this._type_decl(),this._context.aliases.has(e.name)&&(e=this._context.aliases.get(e.name).type);let t='';if(this._match(As.tokens.comma)){i=this._shift_expression();try{t=i.constEvaluate(this._exec).toString(),i=null}catch(e){t='1'}}this._consume(As.tokens.greater_than,'Expected \'>\' for array.'),n=t?parseInt(t):0}const r=this._updateNode(new es(s.toString(),t,e,n));return i&&this._deferArrayCountEval.push({arrayType:r,countNode:i}),r}return null}_texture_sampler_types(){if(this._match(As.sampler_type))return this._updateNode(new ts(this._previous().toString(),null,null));if(this._match(As.depth_texture_type))return this._updateNode(new ts(this._previous().toString(),null,null));if(this._match(As.sampled_texture_type)||this._match(As.multisampled_texture_type)){const e=this._previous();this._consume(As.tokens.less_than,'Expected \'<\' for sampler type.');const t=this._type_decl();return this._consume(As.tokens.greater_than,'Expected \'>\' for sampler type.'),this._updateNode(new ts(e.toString(),t,null))}if(this._match(As.storage_texture_type)){const e=this._previous();this._consume(As.tokens.less_than,'Expected \'<\' for sampler type.');const t=this._consume(As.texel_format,'Invalid texel format.').toString();this._consume(As.tokens.comma,'Expected \',\' after texel format.');const n=this._consume(As.access_mode,'Expected access mode for storage texture type.').toString();return this._consume(As.tokens.greater_than,'Expected \'>\' for sampler type.'),this._updateNode(new ts(e.toString(),t,n))}return null}_attribute(){let e=[];for(;this._match(As.tokens.attr);){const t=this._consume(As.attribute_name,'Expected attribute name'),n=this._updateNode(new _s(t.toString(),null));if(this._match(As.tokens.paren_left)){if(n.value=this._consume(As.literal_or_ident,'Expected attribute value').toString(),this._check(As.tokens.comma)){this._advance();do{const e=this._consume(As.literal_or_ident,'Expected attribute value').toString();n.value instanceof Array||(n.value=[n.value]),n.value.push(e)}while(this._match(As.tokens.comma))}this._consume(As.tokens.paren_right,'Expected \')\'')}e.push(n)}return 0==e.length?null:e}}class ei{get line(){return-1}}class ti extends ei{constructor(e){super(),this.node=e}get line(){return this.node.line}}class ni extends ei{constructor(e,t){super(),this.node=e,this.statement=t}get line(){return this.statement.line}}class si extends ei{constructor(e){super(),this.id=e}}class ii extends ei{constructor(e){super(),this.id=e}}class ri extends ei{constructor(e,t){super(),this.id=e,this.node=t}get line(){return this.node.line}}class oi extends ei{constructor(e,t,n){super(),this.id=e,this.condition=t,this.node=n}get line(){return this.node.line}}class ai extends ei{constructor(e,t,n){super(),this.lineNo=-1,this.condition=e,this.position=t,this.lineNo=n}get line(){var e,t;return null!==(t=null===(e=this.condition)||void 0===e?void 0:e.line)&&void 0!==t?t:this.lineNo}}class li extends ei{constructor(e){super(),this.statements=[],this.statements=e}get line(){return this.statements.length>0?this.statements[0].line:-1}}class ci{constructor(e,t){this.parent=null,this.commands=[],this.current=0,this.parentCallExpr=null,this.context=e,this.parent=null!=t?t:null}get isAtEnd(){return this.current>=this.commands.length}getNextCommand(){if(this.current>=this.commands.length)return null;const e=this.commands[this.current];return this.current++,e}getCurrentCommand(){return this.current>=this.commands.length?null:this.commands[this.current]}}class hi{constructor(){this.states=[]}get isEmpty(){return 0==this.states.length}get last(){var e;return null!==(e=this.states[this.states.length-1])&&void 0!==e?e:null}pop(){this.states.pop()}}class ui{constructor(e,t){this._runTimer=null,this.breakpoints=new Set,this.runStateCallback=null,this._code=e;const n=(new Js).parse(e);this._exec=new Zs(n),this.runStateCallback=null!=t?t:null}getVariableValue(e){var t,n;const s=null!==(n=null===(t=this._exec.context.getVariable(e))||void 0===t?void 0:t.value)&&void 0!==n?n:null;return null===s?null:s instanceof Os||s instanceof Ts||s instanceof Is?s.value:(console.error(`Unsupported return variable type ${s.typeInfo.name}`),null)}reset(){this._exec=new Zs(this._exec.ast),this._execStack=new hi;const e=this._createState(this._exec.ast,this._exec.context);this._execStack.states.push(e)}startDebug(){this._execStack=new hi;const e=this._createState(this._exec.ast,this._exec.context);this._execStack.states.push(e)}get context(){return this._exec.context}get currentState(){for(;;){if(this._execStack.isEmpty)return null;let e=this._execStack.last;if(null===e)return null;if(e.isAtEnd){if(this._execStack.pop(),this._execStack.isEmpty)return null;e=this._execStack.last}return e}}get currentCommand(){for(;;){if(this._execStack.isEmpty)return null;let e=this._execStack.last;if(null===e)return null;if(e.isAtEnd){if(this._execStack.pop(),this._execStack.isEmpty)return null;e=this._execStack.last}const t=e.getCurrentCommand();if(null!==t)return t}}toggleBreakpoint(e){this.breakpoints.has(e)?this.breakpoints.delete(e):this.breakpoints.add(e)}clearBreakpoints(){this.breakpoints.clear()}get isRunning(){return null!==this._runTimer}run(){this.isRunning||(this._runTimer=setInterval((()=>{const e=this.currentCommand;if(e&&this.breakpoints.has(e.line))return clearInterval(this._runTimer),this._runTimer=null,void(null!==this.runStateCallback&&this.runStateCallback());this.stepNext(!0)||(clearInterval(this._runTimer),this._runTimer=null,null!==this.runStateCallback&&this.runStateCallback())}),0),null!==this.runStateCallback&&this.runStateCallback())}pause(){null!==this._runTimer&&(clearInterval(this._runTimer),this._runTimer=null,null!==this.runStateCallback&&this.runStateCallback())}debugWorkgroup(e,t,n,s,i){this._execStack=new hi;const r=this._exec.context;if(r.currentFunctionName=e,this._dispatchId=t,(i=null!=i?i:{}).constants)for(const e in i.constants){const t=i.constants[e];r.setVariable(e,t)}this._exec._execStatements(this._exec.ast,r);const o=r.functions.get(e);if(!o)return console.error(`Function ${e} not found`),!1;if('number'==typeof n)n=[n,1,1];else{if(0===n.length)return console.error('Invalid dispatch count'),!1;1===n.length?n=[n[0],1,1]:2===n.length?n=[n[0],n[1],1]:n.length>3&&(n=[n[0],n[1],n[2]])}const a=n[2],l=n[1],c=n[0],h=this._exec.typeInfo.vec3u;r.setVariable('@num_workgroups',new Ts(n,h));for(const e in s)for(const t in s[e]){const n=s[e][t];r.variables.forEach((s=>{const i=s.node;if(null==i?void 0:i.attributes){let r=null,o=null;for(const e of i.attributes)'binding'===e.name?r=e.value:'group'===e.name&&(o=e.value);t==r&&e==o&&(void 0!==n.texture&&void 0!==n.size?s.value=new Cs(n.texture,this._exec.getTypeInfo(i.type),0,n.size):void 0!==n.uniform?s.value=new Cs(n.uniform,this._exec.getTypeInfo(i.type)):s.value=new Cs(n,this._exec.getTypeInfo(i.type)))}}))}let u=!1;for(let e=0;e<a&&!u;++e)for(let t=0;t<l&&!u;++t)for(let n=0;n<c&&!u;++n)if(r.setVariable('@workgroup_id',new Ts([n,t,e],h)),this._dispatchWorkgroup(o,[n,t,e],r)){u=!0;break}return u}_shouldExecuteNectCommand(){const e=this.currentCommand;if(null===e)return!1;if(e instanceof ai){if(null===e.condition)return!0}else if(e instanceof si||e instanceof ii)return!0;return!1}stepInto(){this.isRunning||this.stepNext(!0)}stepOver(){this.isRunning||this.stepNext(!1)}stepOut(){const e=this.currentState;if(null===e)return;const t=e.parent;this.isRunning&&(clearInterval(this._runTimer),this._runTimer=null),this._runTimer=setInterval((()=>{const e=this.currentCommand;if(e&&this.breakpoints.has(e.line))return clearInterval(this._runTimer),this._runTimer=null,void(null!==this.runStateCallback&&this.runStateCallback());this.stepNext(!0)||(clearInterval(this._runTimer),this._runTimer=null,null!==this.runStateCallback&&this.runStateCallback());this.currentState===t&&(clearInterval(this._runTimer),this._runTimer=null,null!==this.runStateCallback&&this.runStateCallback())}),0),null!==this.runStateCallback&&this.runStateCallback()}stepNext(e=!0){if(!this._execStack){this._execStack=new hi;const e=this._createState(this._exec.ast,this._exec.context);this._execStack.states.push(e)}for(;;){if(this._execStack.isEmpty)return!1;let t=this._execStack.last;if(null===t)return!1;if(t.isAtEnd){if(this._execStack.pop(),this._execStack.isEmpty)return!1;t=this._execStack.last}const n=t.getNextCommand();if(null!==n){if(e&&n instanceof ni){const e=n.node,s=t.context.functions.get(e.name);if(!s)continue;const i=this._createState(s.node.body,t.context.clone(),t);for(let t=0;t<s.node.args.length;++t){const n=s.node.args[t],r=this._exec.evalExpression(e.args[t],i.context);i.context.setVariable(n.name,r,n)}if(i.parentCallExpr=e,this._execStack.states.push(i),i.context.currentFunctionName=s.name,this._shouldExecuteNectCommand())continue;return!0}if(n instanceof ti){const e=n.node;if(e instanceof Rn){const n=t.context.functions.get(e.name);if(n){const s=this._createState(n.node.body,t.context.clone(),t);for(let t=0;t<n.node.args.length;++t){const i=n.node.args[t],r=this._exec.evalExpression(e.args[t],s.context);s.context.setVariable(i.name,r,i)}if(this._execStack.states.push(s),s.context.currentFunctionName=n.name,this._shouldExecuteNectCommand())continue;return!0}}const s=this._exec.execStatement(e,t.context);if(null!=s){let e=t;for(;e;){if(e.parentCallExpr){e.parentCallExpr.setCachedReturnValue(s);break}e=e.parent}if(null===e&&console.error('Could not find CallExpr to store return value in'),this._shouldExecuteNectCommand())continue;return!0}}else{if(n instanceof si)continue;if(n instanceof ii)continue;if(n instanceof ri){const e=n.id;for(;!this._execStack.isEmpty;){t=this._execStack.last;for(let n=t.commands.length-1;n>=0;--n){const s=t.commands[n];if(s instanceof si&&s.id===e)return t.current=n+1,!0}this._execStack.pop()}return console.error('Continue statement used outside of a loop'),!1}if(n instanceof oi){const e=n.id;if(n.condition){const e=this._exec.evalExpression(n.condition,t.context);if(!(e instanceof Os))return console.error('Condition must be a scalar'),!1;if(!e.value){if(this._shouldExecuteNectCommand())continue;return!0}}for(;!this._execStack.isEmpty;){t=this._execStack.last;for(let n=t.commands.length-1;n>=0;--n){const s=t.commands[n];if(s instanceof ii&&s.id===e)return t.current=n+1,!0}this._execStack.pop()}return console.error('Break statement used outside of a loop'),!1}if(n instanceof ai){if(n.condition){const e=this._exec.evalExpression(n.condition,t.context);if(!(e instanceof Os))return console.error('Condition must be a scalar'),!1;if(e.value){if(this._shouldExecuteNectCommand())continue;return!0}}if(t.current=n.position,this._shouldExecuteNectCommand())continue;return!0}if(n instanceof li){const e=this._createState(n.statements,t.context.clone(),t);this._execStack.states.push(e);continue}}if(t.isAtEnd&&(this._execStack.pop(),this._execStack.isEmpty))return!1;if(!this._shouldExecuteNectCommand())return!0}}}_dispatchWorkgroup(e,t,n){const s=[1,1,1];for(const t of e.node.attributes)if('workgroup_size'===t.name)if(Array.isArray(t.value)){if(t.value.length>0){const e=n.getVariableValue(t.value[0]);s[0]=e instanceof Os?e.value:parseInt(t.value[0])}if(t.value.length>1){const e=n.getVariableValue(t.value[1]);s[1]=e instanceof Os?e.value:parseInt(t.value[1])}if(t.value.length>2){const e=n.getVariableValue(t.value[2]);s[2]=e instanceof Os?e.value:parseInt(t.value[2])}}else s[0]=parseInt(t.value);const i=this._exec.typeInfo.vec3u,r=this._exec.typeInfo.u32;n.setVariable('@workgroup_size',new Ts(s,i));const o=s[0],a=s[1],l=s[2];let c=!1;for(let e=0,h=0;e<l&&!c;++e)for(let l=0;l<a&&!c;++l)for(let a=0;a<o&&!c;++a,++h){const o=[a,l,e],u=[a+t[0]*s[0],l+t[1]*s[1],e+t[2]*s[2]];if(n.setVariable('@local_invocation_id',new Ts(o,i)),n.setVariable('@global_invocation_id',new Ts(u,i)),n.setVariable('@local_invocation_index',new Os(h,r)),u[0]===this._dispatchId[0]&&u[1]===this._dispatchId[1]&&u[2]===this._dispatchId[2]){c=!0;break}}return c&&this._dispatchExec(e,n),c}_dispatchExec(e,t){for(const n of e.node.args)for(const e of n.attributes)if('builtin'===e.name){const s=`@${e.value}`,i=t.getVariable(s);null!==i&&t.variables.set(n.name,i)}const n=this._createState(e.node.body,t);this._execStack.states.push(n)}_createState(e,t,n){const s=new ci(t,null!=n?n:null);for(const t of e)if(t instanceof Mn||t instanceof Pn||t instanceof Nn){const e=[];this._collectFunctionCalls(t.value,e);for(const n of e)s.commands.push(new ni(n,t));s.commands.push(new ti(t))}else if(t instanceof Rn){const e=[];for(const n of t.args)this._collectFunctionCalls(n,e);for(const n of e)s.commands.push(new ni(n,t));s.commands.push(new ti(t))}else if(t instanceof Un){const e=[];this._collectFunctionCalls(t.value,e);for(const n of e)s.commands.push(new ni(n,t));s.commands.push(new ti(t))}else if(t instanceof Bn)s.commands.push(new ti(t));else{if(t instanceof In){const e=new Ns(t);s.context.functions.set(t.name,e);continue}if(t instanceof zn){const e=[];this._collectFunctionCalls(t.condition,e);for(const n of e)s.commands.push(new ni(n,t));let n=new ai(t.condition,0,t.line);s.commands.push(n),t.body.length>0&&s.commands.push(new li(t.body));const i=new ai(null,0,t.line);s.commands.push(i);for(const e of t.elseif){n.position=s.commands.length;const r=[];this._collectFunctionCalls(e.condition,r);for(const e of r)s.commands.push(new ni(e,t));n=new ai(e.condition,0,e.line),s.commands.push(n),e.body.length>0&&s.commands.push(new li(e.body)),s.commands.push(i)}n.position=s.commands.length,t.else&&s.commands.push(new li(t.else)),i.position=s.commands.length}else if(t instanceof $n){const e=[];s.commands.push(new si(t.id)),this._collectFunctionCalls(t.condition,e);for(const n of e)s.commands.push(new ni(n,t));const n=new ai(t.condition,0,t.line);s.commands.push(n);let i=t.line;t.body.length>0&&(s.commands.push(new li(t.body)),i=t.body[t.body.length-1].line),s.commands.push(new ai(t.condition,0,i)),s.commands.push(new ii(t.id)),n.position=s.commands.length}else if(t instanceof En){t.init&&s.commands.push(new ti(t.init));let e=s.commands.length;null===t.increment&&s.commands.push(new si(t.id));let n=null;if(t.condition){const e=[];this._collectFunctionCalls(t.condition,e);for(const n of e)s.commands.push(new ni(n,t));n=new ai(t.condition,0,t.line),s.commands.push(n)}let i=t.line;t.body.length>0&&(s.commands.push(new li(t.body)),i=t.body[t.body.length-1].line),t.increment&&(s.commands.push(new si(t.id)),s.commands.push(new ti(t.increment))),s.commands.push(new ai(null,e,i)),s.commands.push(new ii(t.id)),n.position=s.commands.length}else if(t instanceof Fn){let e=s.commands.length;t.continuing||s.commands.push(new si(t.id));let n=t.line;t.body.length>0&&(s.commands.push(new li(t.body)),n=t.body[t.body.length-1].line),s.commands.push(new ai(null,e,n)),s.commands.push(new ii(t.id))}else t instanceof An?(s.commands.push(new si(t.id)),s.commands.push(new li(t.body))):t instanceof Hn?s.commands.push(new ri(t.loopId,t)):t instanceof qn?s.commands.push(new oi(t.loopId,t.condition,t)):t instanceof Cn?s.commands.push(new ti(t)):console.error(`TODO: statement type ${t.constructor.name}`)}return s}_collectFunctionCalls(e,t){if(e instanceof rs){if(e.args)for(const n of e.args)this._collectFunctionCalls(n,t);e.isBuiltin||t.push(e)}else if(e instanceof ps)this._collectFunctionCalls(e.left,t),this._collectFunctionCalls(e.right,t);else if(e instanceof fs)this._collectFunctionCalls(e.right,t);else if(e instanceof hs)for(const n of e.contents)this._collectFunctionCalls(n,t);else if(e instanceof is){if(e.args)for(const n of e.args)this._collectFunctionCalls(n,t)}else e instanceof cs?this._collectFunctionCalls(e.value,t):e instanceof us?this._collectFunctionCalls(e.index,t):ls||console.error(`TODO: expression type ${e.constructor.name}`)}}let di=[],fi=[];function pi(e){if(e<768)return!1;for(let t=0,n=di.length;;){let s=t+n>>1;if(e<di[s])n=s;else{if(!(e>=fi[s]))return!0;t=s+1}if(t==n)return!1}}function mi(e){return e>=127462&&e<=127487}(()=>{let e='lc,34,7n,7,7b,19,,,,2,,2,,,20,b,1c,l,g,,2t,7,2,6,2,2,,4,z,,u,r,2j,b,1m,9,9,,o,4,,9,,3,,5,17,3,3b,f,,w,1j,,,,4,8,4,,3,7,a,2,t,,1m,,,,2,4,8,,9,,a,2,q,,2,2,1l,,4,2,4,2,2,3,3,,u,2,3,,b,2,1l,,4,5,,2,4,,k,2,m,6,,,1m,,,2,,4,8,,7,3,a,2,u,,1n,,,,c,,9,,14,,3,,1l,3,5,3,,4,7,2,b,2,t,,1m,,2,,2,,3,,5,2,7,2,b,2,s,2,1l,2,,,2,4,8,,9,,a,2,t,,20,,4,,2,3,,,8,,29,,2,7,c,8,2q,,2,9,b,6,22,2,r,,,,,,1j,e,,5,,2,5,b,,10,9,,2u,4,,6,,2,2,2,p,2,4,3,g,4,d,,2,2,6,,f,,jj,3,qa,3,t,3,t,2,u,2,1s,2,,7,8,,2,b,9,,19,3,3b,2,y,,3a,3,4,2,9,,6,3,63,2,2,,1m,,,7,,,,,2,8,6,a,2,,1c,h,1r,4,1c,7,,,5,,14,9,c,2,w,4,2,2,,3,1k,,,2,3,,,3,1m,8,2,2,48,3,,d,,7,4,,6,,3,2,5i,1m,,5,ek,,5f,x,2da,3,3x,,2o,w,fe,6,2x,2,n9w,4,,a,w,2,28,2,7k,,3,,4,,p,2,5,,47,2,q,i,d,,12,8,p,b,1a,3,1c,,2,4,2,2,13,,1v,6,2,2,2,2,c,,8,,1b,,1f,,,3,2,2,5,2,,,16,2,8,,6m,,2,,4,,fn4,,kh,g,g,g,a6,2,gt,,6a,,45,5,1ae,3,,2,5,4,14,3,4,,4l,2,fx,4,ar,2,49,b,4w,,1i,f,1k,3,1d,4,2,2,1x,3,10,5,,8,1q,,c,2,1g,9,a,4,2,,2n,3,2,,,2,6,,4g,,3,8,l,2,1l,2,,,,,m,,e,7,3,5,5f,8,2,3,,,n,,29,,2,6,,,2,,,2,,2,6j,,2,4,6,2,,2,r,2,2d,8,2,,,2,2y,,,,2,6,,,2t,3,2,4,,5,77,9,,2,6t,,a,2,,,4,,40,4,2,2,4,,w,a,14,6,2,4,8,,9,6,2,3,1a,d,,2,ba,7,,6,,,2a,m,2,7,,2,,2,3e,6,3,,,2,,7,,,20,2,3,,,,9n,2,f0b,5,1n,7,t4,,1r,4,29,,f5k,2,43q,,,3,4,5,8,8,2,7,u,4,44,3,1iz,1j,4,1e,8,,e,,m,5,,f,11s,7,,h,2,7,,2,,5,79,7,c5,4,15s,7,31,7,240,5,gx7k,2o,3k,6o'.split(',').map((e=>e?parseInt(e,36):1));for(let t=0,n=0;t<e.length;t++)(t%2?fi:di).push(n+=e[t])})();function gi(e,t,n=!0,s=!0){return(n?vi:xi)(e,t,s)}function vi(e,t,n){if(t==e.length)return t;t&&yi(e.charCodeAt(t))&&_i(e.charCodeAt(t-1))&&t--;let s=bi(e,t);for(t+=wi(s);t<e.length;){let i=bi(e,t);if(8205==s||8205==i||n&&pi(i))t+=wi(i),s=i;else{if(!mi(i))break;{let n=0,s=t-2;for(;s>=0&&mi(bi(e,s));)n++,s-=2;if(n%2==0)break;t+=2}}}return t}function xi(e,t,n){for(;t>0;){let s=vi(e,t-2,n);if(s<t)return s;t--}return 0}function bi(e,t){let n=e.charCodeAt(t);if(!_i(n)||t+1==e.length)return n;let s=e.charCodeAt(t+1);return yi(s)?s-56320+(n-55296<<10)+65536:n}function yi(e){return e>=56320&&e<57344}function _i(e){return e>=55296&&e<56320}function wi(e){return e<65536?1:2}class ki{lineAt(e){if(e<0||e>this.length)throw new RangeError(`Invalid position ${e} in document of length ${this.length}`);return this.lineInner(e,!1,1,0)}line(e){if(e<1||e>this.lines)throw new RangeError(`Invalid line number ${e} in ${this.lines}-line document`);return this.lineInner(e,!0,1,0)}replace(e,t,n){[e,t]=Pi(this,e,t);let s=[];return this.decompose(0,e,s,2),n.length&&n.decompose(0,n.length,s,3),this.decompose(t,this.length,s,1),Si.from(s,this.length-(t-e)+n.length)}append(e){return this.replace(this.length,this.length,e)}slice(e,t=this.length){[e,t]=Pi(this,e,t);let n=[];return this.decompose(e,t,n,0),Si.from(n,t-e)}eq(e){if(e==this)return!0;if(e.length!=this.length||e.lines!=this.lines)return!1;let t=this.scanIdentical(e,1),n=this.length-this.scanIdentical(e,-1),s=new Ci(this),i=new Ci(e);for(let e=t,r=t;;){if(s.next(e),i.next(e),e=0,s.lineBreak!=i.lineBreak||s.done!=i.done||s.value!=i.value)return!1;if(r+=s.value.length,s.done||r>=n)return!0}}iter(e=1){return new Ci(this,e)}iterRange(e,t=this.length){return new $i(this,e,t)}iterLines(e,t){let n;if(null==e)n=this.iter();else{null==t&&(t=this.lines+1);let s=this.line(e).from;n=this.iterRange(s,Math.max(s,t==this.lines+1?this.length:t<=1?0:this.line(t-1).to))}return new Ai(n)}toString(){return this.sliceString(0)}toJSON(){let e=[];return this.flatten(e),e}constructor(){}static of(e){if(0==e.length)throw new RangeError('A document must have at least one line');return 1!=e.length||e[0]?e.length<=32?new Oi(e):Si.from(Oi.split(e,[])):ki.empty}}class Oi extends ki{constructor(e,t=function(e){let t=-1;for(let n of e)t+=n.length+1;return t}(e)){super(),this.text=e,this.length=t}get lines(){return this.text.length}get children(){return null}lineInner(e,t,n,s){for(let i=0;;i++){let r=this.text[i],o=s+r.length;if((t?n:o)>=e)return new Ei(s,o,n,r);s=o+1,n++}}decompose(e,t,n,s){let i=e<=0&&t>=this.length?this:new Oi(Ii(this.text,e,t),Math.min(t,this.length)-Math.max(0,e));if(1&s){let e=n.pop(),t=Ti(i.text,e.text.slice(),0,i.length);if(t.length<=32)n.push(new Oi(t,e.length+i.length));else{let e=t.length>>1;n.push(new Oi(t.slice(0,e)),new Oi(t.slice(e)))}}else n.push(i)}replace(e,t,n){if(!(n instanceof Oi))return super.replace(e,t,n);[e,t]=Pi(this,e,t);let s=Ti(this.text,Ti(n.text,Ii(this.text,0,e)),t),i=this.length+n.length-(t-e);return s.length<=32?new Oi(s,i):Si.from(Oi.split(s,[]),i)}sliceString(e,t=this.length,n='\n'){[e,t]=Pi(this,e,t);let s='';for(let i=0,r=0;i<=t&&r<this.text.length;r++){let o=this.text[r],a=i+o.length;i>e&&r&&(s+=n),e<a&&t>i&&(s+=o.slice(Math.max(0,e-i),t-i)),i=a+1}return s}flatten(e){for(let t of this.text)e.push(t)}scanIdentical(){return 0}static split(e,t){let n=[],s=-1;for(let i of e)n.push(i),s+=i.length+1,32==n.length&&(t.push(new Oi(n,s)),n=[],s=-1);return s>-1&&t.push(new Oi(n,s)),t}}class Si extends ki{constructor(e,t){super(),this.children=e,this.length=t,this.lines=0;for(let t of e)this.lines+=t.lines}lineInner(e,t,n,s){for(let i=0;;i++){let r=this.children[i],o=s+r.length,a=n+r.lines-1;if((t?a:o)>=e)return r.lineInner(e,t,n,s);s=o+1,n=a+1}}decompose(e,t,n,s){for(let i=0,r=0;r<=t&&i<this.children.length;i++){let o=this.children[i],a=r+o.length;if(e<=a&&t>=r){let i=s&((r<=e?1:0)|(a>=t?2:0));r>=e&&a<=t&&!i?n.push(o):o.decompose(e-r,t-r,n,i)}r=a+1}}replace(e,t,n){if([e,t]=Pi(this,e,t),n.lines<this.lines)for(let s=0,i=0;s<this.children.length;s++){let r=this.children[s],o=i+r.length;if(e>=i&&t<=o){let a=r.replace(e-i,t-i,n),l=this.lines-r.lines+a.lines;if(a.lines<l>>4&&a.lines>l>>6){let i=this.children.slice();return i[s]=a,new Si(i,this.length-(t-e)+n.length)}return super.replace(i,o,a)}i=o+1}return super.replace(e,t,n)}sliceString(e,t=this.length,n='\n'){[e,t]=Pi(this,e,t);let s='';for(let i=0,r=0;i<this.children.length&&r<=t;i++){let o=this.children[i],a=r+o.length;r>e&&i&&(s+=n),e<a&&t>r&&(s+=o.sliceString(e-r,t-r,n)),r=a+1}return s}flatten(e){for(let t of this.children)t.flatten(e)}scanIdentical(e,t){if(!(e instanceof Si))return 0;let n=0,[s,i,r,o]=t>0?[0,0,this.children.length,e.children.length]:[this.children.length-1,e.children.length-1,-1,-1];for(;;s+=t,i+=t){if(s==r||i==o)return n;let a=this.children[s],l=e.children[i];if(a!=l)return n+a.scanIdentical(l,t);n+=a.length+1}}static from(e,t=e.reduce(((e,t)=>e+t.length+1),-1)){let n=0;for(let t of e)n+=t.lines;if(n<32){let n=[];for(let t of e)t.flatten(n);return new Oi(n,t)}let s=Math.max(32,n>>5),i=s<<1,r=s>>1,o=[],a=0,l=-1,c=[];function h(e){let t;if(e.lines>i&&e instanceof Si)for(let t of e.children)h(t);else e.lines>r&&(a>r||!a)?(u(),o.push(e)):e instanceof Oi&&a&&(t=c[c.length-1])instanceof Oi&&e.lines+t.lines<=32?(a+=e.lines,l+=e.length+1,c[c.length-1]=new Oi(t.text.concat(e.text),t.length+1+e.length)):(a+e.lines>s&&u(),a+=e.lines,l+=e.length+1,c.push(e))}function u(){0!=a&&(o.push(1==c.length?c[0]:Si.from(c,l)),l=-1,a=c.length=0)}for(let t of e)h(t);return u(),1==o.length?o[0]:new Si(o,t)}}function Ti(e,t,n=0,s=1e9){for(let i=0,r=0,o=!0;r<e.length&&i<=s;r++){let a=e[r],l=i+a.length;l>=n&&(l>s&&(a=a.slice(0,s-i)),i<n&&(a=a.slice(n-i)),o?(t[t.length-1]+=a,o=!1):t.push(a)),i=l+1}return t}function Ii(e,t,n){return Ti(e,[''],t,n)}ki.empty=new Oi([''],0);class Ci{constructor(e,t=1){this.dir=t,this.done=!1,this.lineBreak=!1,this.value='',this.nodes=[e],this.offsets=[t>0?1:(e instanceof Oi?e.text.length:e.children.length)<<1]}nextInner(e,t){for(this.done=this.lineBreak=!1;;){let n=this.nodes.length-1,s=this.nodes[n],i=this.offsets[n],r=i>>1,o=s instanceof Oi?s.text.length:s.children.length;if(r==(t>0?o:0)){if(0==n)return this.done=!0,this.value='',this;t>0&&this.offsets[n-1]++,this.nodes.pop(),this.offsets.pop()}else if((1&i)==(t>0?0:1)){if(this.offsets[n]+=t,0==e)return this.lineBreak=!0,this.value='\n',this;e--}else if(s instanceof Oi){let i=s.text[r+(t<0?-1:0)];if(this.offsets[n]+=t,i.length>Math.max(0,e))return this.value=0==e?i:t>0?i.slice(e):i.slice(0,i.length-e),this;e-=i.length}else{let i=s.children[r+(t<0?-1:0)];e>i.length?(e-=i.length,this.offsets[n]+=t):(t<0&&this.offsets[n]--,this.nodes.push(i),this.offsets.push(t>0?1:(i instanceof Oi?i.text.length:i.children.length)<<1))}}}next(e=0){return e<0&&(this.nextInner(-e,-this.dir),e=this.value.length),this.nextInner(e,this.dir)}}class $i{constructor(e,t,n){this.value='',this.done=!1,this.cursor=new Ci(e,t>n?-1:1),this.pos=t>n?e.length:0,this.from=Math.min(t,n),this.to=Math.max(t,n)}nextInner(e,t){if(t<0?this.pos<=this.from:this.pos>=this.to)return this.value='',this.done=!0,this;e+=Math.max(0,t<0?this.pos-this.to:this.from-this.pos);let n=t<0?this.pos-this.from:this.to-this.pos;e>n&&(e=n),n-=e;let{value:s}=this.cursor.next(e);return this.pos+=(s.length+e)*t,this.value=s.length<=n?s:t<0?s.slice(s.length-n):s.slice(0,n),this.done=!this.value,this}next(e=0){return e<0?e=Math.max(e,this.from-this.pos):e>0&&(e=Math.min(e,this.to-this.pos)),this.nextInner(e,this.cursor.dir)}get lineBreak(){return this.cursor.lineBreak&&''!=this.value}}class Ai{constructor(e){this.inner=e,this.afterBreak=!0,this.value='',this.done=!1}next(e=0){let{done:t,lineBreak:n,value:s}=this.inner.next(e);return t&&this.afterBreak?(this.value='',this.afterBreak=!1):t?(this.done=!0,this.value=''):n?this.afterBreak?this.value='':(this.afterBreak=!0,this.next()):(this.value=s,this.afterBreak=!1),this}get lineBreak(){return!1}}'undefined'!=typeof Symbol&&(ki.prototype[Symbol.iterator]=function(){return this.iter()},Ci.prototype[Symbol.iterator]=$i.prototype[Symbol.iterator]=Ai.prototype[Symbol.iterator]=function(){return this});class Ei{constructor(e,t,n,s){this.from=e,this.to=t,this.number=n,this.text=s}get length(){return this.to-this.from}}function Pi(e,t,n){return[t=Math.max(0,Math.min(e.length,t)),Math.max(t,Math.min(e.length,n))]}function Di(e,t,n=!0,s=!0){return gi(e,t,n,s)}function Mi(e,t){let n=e.charCodeAt(t);if(!(s=n,s>=55296&&s<56320&&t+1!=e.length))return n;var s;let i=e.charCodeAt(t+1);return function(e){return e>=56320&&e<57344}(i)?i-56320+(n-55296<<10)+65536:n}function Li(e){return e<=65535?String.fromCharCode(e):(e-=65536,String.fromCharCode(55296+(e>>10),56320+(1023&e)))}function Bi(e){return e<65536?1:2}const Ni=/\r\n?|\n/;var Ri=(e=>(e[e.Simple=0]='Simple',e[e.TrackDel=1]='TrackDel',e[e.TrackBefore=2]='TrackBefore',e[e.TrackAfter=3]='TrackAfter',e))(Ri||(Ri={}));class Fi{constructor(e){this.sections=e}get length(){let e=0;for(let t=0;t<this.sections.length;t+=2)e+=this.sections[t];return e}get newLength(){let e=0;for(let t=0;t<this.sections.length;t+=2){let n=this.sections[t+1];e+=n<0?this.sections[t]:n}return e}get empty(){return 0==this.sections.length||2==this.sections.length&&this.sections[1]<0}iterGaps(e){for(let t=0,n=0,s=0;t<this.sections.length;){let i=this.sections[t++],r=this.sections[t++];r<0?(e(n,s,i),s+=i):s+=r,n+=i}}iterChangedRanges(e,t=!1){Wi(this,e,t)}get invertedDesc(){let e=[];for(let t=0;t<this.sections.length;){let n=this.sections[t++],s=this.sections[t++];s<0?e.push(n,s):e.push(s,n)}return new Fi(e)}composeDesc(e){return this.empty?e:e.empty?this:ji(this,e)}mapDesc(e,t=!1){return e.empty?this:Qi(this,e,t)}mapPos(e,t=-1,n=Ri.Simple){let s=0,i=0;for(let r=0;r<this.sections.length;){let o=this.sections[r++],a=this.sections[r++],l=s+o;if(a<0){if(l>e)return i+(e-s);i+=o}else{if(n!=Ri.Simple&&l>=e&&(n==Ri.TrackDel&&s<e&&l>e||n==Ri.TrackBefore&&s<e||n==Ri.TrackAfter&&l>e))return null;if(l>e||l==e&&t<0&&!o)return e==s||t<0?i:i+a;i+=a}s=l}if(e>s)throw new RangeError(`Position ${e} is out of range for changeset of length ${s}`);return i}touchesRange(e,t=e){for(let n=0,s=0;n<this.sections.length&&s<=t;){let i=s+this.sections[n++];if(this.sections[n++]>=0&&s<=t&&i>=e)return!(s<e&&i>t)||'cover';s=i}return!1}toString(){let e='';for(let t=0;t<this.sections.length;){let n=this.sections[t++],s=this.sections[t++];e+=(e?' ':'')+n+(s>=0?':'+s:'')}return e}toJSON(){return this.sections}static fromJSON(e){if(!Array.isArray(e)||e.length%2||e.some((e=>'number'!=typeof e)))throw new RangeError('Invalid JSON representation of ChangeDesc');return new Fi(e)}static create(e){return new Fi(e)}}class Vi extends Fi{constructor(e,t){super(e),this.inserted=t}apply(e){if(this.length!=e.length)throw new RangeError('Applying change set to a document with the wrong length');return Wi(this,((t,n,s,i,r)=>e=e.replace(s,s+(n-t),r)),!1),e}mapDesc(e,t=!1){return Qi(this,e,t,!0)}invert(e){let t=this.sections.slice(),n=[];for(let s=0,i=0;s<t.length;s+=2){let r=t[s],o=t[s+1];if(o>=0){t[s]=o,t[s+1]=r;let a=s>>1;for(;n.length<a;)n.push(ki.empty);n.push(r?e.slice(i,i+r):ki.empty)}i+=r}return new Vi(t,n)}compose(e){return this.empty?e:e.empty?this:ji(this,e,!0)}map(e,t=!1){return e.empty?this:Qi(this,e,t,!0)}iterChanges(e,t=!1){Wi(this,e,t)}get desc(){return Fi.create(this.sections)}filter(e){let t=[],n=[],s=[],i=new Xi(this);e:for(let r=0,o=0;;){let a=r==e.length?1e9:e[r++];for(;o<a||o==a&&0==i.len;){if(i.done)break e;let e=Math.min(i.len,a-o);zi(s,e,-1);let r=-1==i.ins?-1:0==i.off?i.ins:0;zi(t,e,r),r>0&&Ui(n,t,i.text),i.forward(e),o+=e}let l=e[r++];for(;o<l;){if(i.done)break e;let e=Math.min(i.len,l-o);zi(t,e,-1),zi(s,e,-1==i.ins?-1:0==i.off?i.ins:0),i.forward(e),o+=e}}return{changes:new Vi(t,n),filtered:Fi.create(s)}}toJSON(){let e=[];for(let t=0;t<this.sections.length;t+=2){let n=this.sections[t],s=this.sections[t+1];s<0?e.push(n):0==s?e.push([n]):e.push([n].concat(this.inserted[t>>1].toJSON()))}return e}static of(e,t,n){let s=[],i=[],r=0,o=null;function a(e=!1){if(!e&&!s.length)return;r<t&&zi(s,t-r,-1);let n=new Vi(s,i);o=o?o.compose(n.map(o)):n,s=[],i=[],r=0}return function e(l){if(Array.isArray(l))for(let t of l)e(t);else if(l instanceof Vi){if(l.length!=t)throw new RangeError(`Mismatched change set length (got ${l.length}, expected ${t})`);a(),o=o?o.compose(l.map(o)):l}else{let{from:e,to:o=e,insert:c}=l;if(e>o||e<0||o>t)throw new RangeError(`Invalid change range ${e} to ${o} (in doc of length ${t})`);let h=c?'string'==typeof c?ki.of(c.split(n||Ni)):c:ki.empty,u=h.length;if(e==o&&0==u)return;e<r&&a(),e>r&&zi(s,e-r,-1),zi(s,o-e,u),Ui(i,s,h),r=o}}(e),a(!o),o}static empty(e){return new Vi(e?[e,-1]:[],[])}static fromJSON(e){if(!Array.isArray(e))throw new RangeError('Invalid JSON representation of ChangeSet');let t=[],n=[];for(let s=0;s<e.length;s++){let i=e[s];if('number'==typeof i)t.push(i,-1);else{if(!Array.isArray(i)||'number'!=typeof i[0]||i.some(((e,t)=>t&&'string'!=typeof e)))throw new RangeError('Invalid JSON representation of ChangeSet');if(1==i.length)t.push(i[0],0);else{for(;n.length<s;)n.push(ki.empty);n[s]=ki.of(i.slice(1)),t.push(i[0],n[s].length)}}}return new Vi(t,n)}static createSet(e,t){return new Vi(e,t)}}function zi(e,t,n,s=!1){if(0==t&&n<=0)return;let i=e.length-2;i>=0&&n<=0&&n==e[i+1]?e[i]+=t:i>=0&&0==t&&0==e[i]?e[i+1]+=n:s?(e[i]+=t,e[i+1]+=n):e.push(t,n)}function Ui(e,t,n){if(0==n.length)return;let s=t.length-2>>1;if(s<e.length)e[e.length-1]=e[e.length-1].append(n);else{for(;e.length<s;)e.push(ki.empty);e.push(n)}}function Wi(e,t,n){let s=e.inserted;for(let i=0,r=0,o=0;o<e.sections.length;){let a=e.sections[o++],l=e.sections[o++];if(l<0)i+=a,r+=a;else{let c=i,h=r,u=ki.empty;for(;c+=a,h+=l,l&&s&&(u=u.append(s[o-2>>1])),!(n||o==e.sections.length||e.sections[o+1]<0);)a=e.sections[o++],l=e.sections[o++];t(i,c,r,h,u),i=c,r=h}}}function Qi(e,t,n,s=!1){let i=[],r=s?[]:null,o=new Xi(e),a=new Xi(t);for(let e=-1;;){if(o.done&&a.len||a.done&&o.len)throw new Error('Mismatched change set lengths');if(-1==o.ins&&-1==a.ins){let e=Math.min(o.len,a.len);zi(i,e,-1),o.forward(e),a.forward(e)}else if(a.ins>=0&&(o.ins<0||e==o.i||0==o.off&&(a.len<o.len||a.len==o.len&&!n))){let t=a.len;for(zi(i,a.ins,-1);t;){let n=Math.min(o.len,t);o.ins>=0&&e<o.i&&o.len<=n&&(zi(i,0,o.ins),r&&Ui(r,i,o.text),e=o.i),o.forward(n),t-=n}a.next()}else{if(!(o.ins>=0)){if(o.done&&a.done)return r?Vi.createSet(i,r):Fi.create(i);throw new Error('Mismatched change set lengths')}{let t=0,n=o.len;for(;n;)if(-1==a.ins){let e=Math.min(n,a.len);t+=e,n-=e,a.forward(e)}else{if(!(0==a.ins&&a.len<n))break;n-=a.len,a.next()}zi(i,t,e<o.i?o.ins:0),r&&e<o.i&&Ui(r,i,o.text),e=o.i,o.forward(o.len-n)}}}}function ji(e,t,n=!1){let s=[],i=n?[]:null,r=new Xi(e),o=new Xi(t);for(let e=!1;;){if(r.done&&o.done)return i?Vi.createSet(s,i):Fi.create(s);if(0==r.ins)zi(s,r.len,0,e),r.next();else if(0!=o.len||o.done){if(r.done||o.done)throw new Error('Mismatched change set lengths');{let t=Math.min(r.len2,o.len),n=s.length;if(-1==r.ins){let n=-1==o.ins?-1:o.off?0:o.ins;zi(s,t,n,e),i&&n&&Ui(i,s,o.text)}else-1==o.ins?(zi(s,r.off?0:r.len,t,e),i&&Ui(i,s,r.textBit(t))):(zi(s,r.off?0:r.len,o.off?0:o.ins,e),i&&!o.off&&Ui(i,s,o.text));e=(r.ins>t||o.ins>=0&&o.len>t)&&(e||s.length>n),r.forward2(t),o.forward(t)}}else zi(s,0,o.ins,e),i&&Ui(i,s,o.text),o.next()}}class Xi{constructor(e){this.set=e,this.i=0,this.next()}next(){let{sections:e}=this.set;this.i<e.length?(this.len=e[this.i++],this.ins=e[this.i++]):(this.len=0,this.ins=-2),this.off=0}get done(){return-2==this.ins}get len2(){return this.ins<0?this.len:this.ins}get text(){let{inserted:e}=this.set,t=this.i-2>>1;return t>=e.length?ki.empty:e[t]}textBit(e){let{inserted:t}=this.set,n=this.i-2>>1;return n>=t.length&&!e?ki.empty:t[n].slice(this.off,null==e?void 0:this.off+e)}forward(e){e==this.len?this.next():(this.len-=e,this.off+=e)}forward2(e){-1==this.ins?this.forward(e):e==this.ins?this.next():(this.ins-=e,this.off+=e)}}class Gi{constructor(e,t,n){this.from=e,this.to=t,this.flags=n}get anchor(){return 32&this.flags?this.to:this.from}get head(){return 32&this.flags?this.from:this.to}get empty(){return this.from==this.to}get assoc(){return 8&this.flags?-1:16&this.flags?1:0}get bidiLevel(){let e=7&this.flags;return 7==e?null:e}get goalColumn(){let e=this.flags>>6;return 16777215==e?void 0:e}map(e,t=-1){let n,s;return this.empty?n=s=e.mapPos(this.from,t):(n=e.mapPos(this.from,1),s=e.mapPos(this.to,-1)),n==this.from&&s==this.to?this:new Gi(n,s,this.flags)}extend(e,t=e){if(e<=this.anchor&&t>=this.anchor)return qi.range(e,t);let n=Math.abs(e-this.anchor)>Math.abs(t-this.anchor)?e:t;return qi.range(this.anchor,n)}eq(e,t=!1){return!(this.anchor!=e.anchor||this.head!=e.head||t&&this.empty&&this.assoc!=e.assoc)}toJSON(){return{anchor:this.anchor,head:this.head}}static fromJSON(e){if(!e||'number'!=typeof e.anchor||'number'!=typeof e.head)throw new RangeError('Invalid JSON representation for SelectionRange');return qi.range(e.anchor,e.head)}static create(e,t,n){return new Gi(e,t,n)}}class qi{constructor(e,t){this.ranges=e,this.mainIndex=t}map(e,t=-1){return e.empty?this:qi.create(this.ranges.map((n=>n.map(e,t))),this.mainIndex)}eq(e,t=!1){if(this.ranges.length!=e.ranges.length||this.mainIndex!=e.mainIndex)return!1;for(let n=0;n<this.ranges.length;n++)if(!this.ranges[n].eq(e.ranges[n],t))return!1;return!0}get main(){return this.ranges[this.mainIndex]}asSingle(){return 1==this.ranges.length?this:new qi([this.main],0)}addRange(e,t=!0){return qi.create([e].concat(this.ranges),t?0:this.mainIndex+1)}replaceRange(e,t=this.mainIndex){let n=this.ranges.slice();return n[t]=e,qi.create(n,this.mainIndex)}toJSON(){return{ranges:this.ranges.map((e=>e.toJSON())),main:this.mainIndex}}static fromJSON(e){if(!e||!Array.isArray(e.ranges)||'number'!=typeof e.main||e.main>=e.ranges.length)throw new RangeError('Invalid JSON representation for EditorSelection');return new qi(e.ranges.map((e=>Gi.fromJSON(e))),e.main)}static single(e,t=e){return new qi([qi.range(e,t)],0)}static create(e,t=0){if(0==e.length)throw new RangeError('A selection needs at least one range');for(let n=0,s=0;s<e.length;s++){let i=e[s];if(i.empty?i.from<=n:i.from<n)return qi.normalized(e.slice(),t);n=i.to}return new qi(e,t)}static cursor(e,t=0,n,s){return Gi.create(e,e,(0==t?0:t<0?8:16)|(null==n?7:Math.min(6,n))|(null!=s?s:16777215)<<6)}static range(e,t,n,s){let i=(null!=n?n:16777215)<<6|(null==s?7:Math.min(6,s));return t<e?Gi.create(t,e,48|i):Gi.create(e,t,(t>e?8:0)|i)}static normalized(e,t=0){let n=e[t];e.sort(((e,t)=>e.from-t.from)),t=e.indexOf(n);for(let n=1;n<e.length;n++){let s=e[n],i=e[n-1];if(s.empty?s.from<=i.to:s.from<i.to){let r=i.from,o=Math.max(s.to,i.to);n<=t&&t--,e.splice(--n,2,s.anchor>s.head?qi.range(o,r):qi.range(r,o))}}return new qi(e,t)}}function Hi(e,t){for(let n of e.ranges)if(n.to>t)throw new RangeError('Selection points outside of document')}let Yi=0;class Ki{constructor(e,t,n,s,i){this.combine=e,this.compareInput=t,this.compare=n,this.isStatic=s,this.id=Yi++,this.default=e([]),this.extensions='function'==typeof i?i(this):i}get reader(){return this}static define(e={}){return new Ki(e.combine||(e=>e),e.compareInput||((e,t)=>e===t),e.compare||(e.combine?(e,t)=>e===t:Zi),!!e.static,e.enables)}of(e){return new Ji([],this,0,e)}compute(e,t){if(this.isStatic)throw new Error('Can\'t compute a static facet');return new Ji(e,this,1,t)}computeN(e,t){if(this.isStatic)throw new Error('Can\'t compute a static facet');return new Ji(e,this,2,t)}from(e,t){return t||(t=e=>e),this.compute([e],(n=>t(n.field(e))))}}function Zi(e,t){return e==t||e.length==t.length&&e.every(((e,n)=>e===t[n]))}class Ji{constructor(e,t,n,s){this.dependencies=e,this.facet=t,this.type=n,this.value=s,this.id=Yi++}dynamicSlot(e){var t;let n=this.value,s=this.facet.compareInput,i=this.id,r=e[i]>>1,o=2==this.type,a=!1,l=!1,c=[];for(let n of this.dependencies)'doc'==n?a=!0:'selection'==n?l=!0:1&(null!==(t=e[n.id])&&void 0!==t?t:1)||c.push(e[n.id]);return{create:e=>(e.values[r]=n(e),1),update(e,t){if(a&&t.docChanged||l&&(t.docChanged||t.selection)||tr(e,c)){let t=n(e);if(o?!er(t,e.values[r],s):!s(t,e.values[r]))return e.values[r]=t,1}return 0},reconfigure:(e,t)=>{let a,l=t.config.address[i];if(null!=l){let i=gr(t,l);if(this.dependencies.every((n=>n instanceof Ki?t.facet(n)===e.facet(n):!(n instanceof ir)||t.field(n,!1)==e.field(n,!1)))||(o?er(a=n(e),i,s):s(a=n(e),i)))return e.values[r]=i,0}else a=n(e);return e.values[r]=a,1}}}}function er(e,t,n){if(e.length!=t.length)return!1;for(let s=0;s<e.length;s++)if(!n(e[s],t[s]))return!1;return!0}function tr(e,t){let n=!1;for(let s of t)1&mr(e,s)&&(n=!0);return n}function nr(e,t,n){let s=n.map((t=>e[t.id])),i=n.map((e=>e.type)),r=s.filter((e=>!(1&e))),o=e[t.id]>>1;function a(e){let n=[];for(let t=0;t<s.length;t++){let r=gr(e,s[t]);if(2==i[t])for(let e of r)n.push(e);else n.push(r)}return t.combine(n)}return{create(e){for(let t of s)mr(e,t);return e.values[o]=a(e),1},update(e,n){if(!tr(e,r))return 0;let s=a(e);return t.compare(s,e.values[o])?0:(e.values[o]=s,1)},reconfigure(e,i){let r=tr(e,s),l=i.config.facets[t.id],c=i.facet(t);if(l&&!r&&Zi(n,l))return e.values[o]=c,0;let h=a(e);return t.compare(h,c)?(e.values[o]=c,0):(e.values[o]=h,1)}}}const sr=Ki.define({static:!0});class ir{constructor(e,t,n,s,i){this.id=e,this.createF=t,this.updateF=n,this.compareF=s,this.spec=i,this.provides=void 0}static define(e){let t=new ir(Yi++,e.create,e.update,e.compare||((e,t)=>e===t),e);return e.provide&&(t.provides=e.provide(t)),t}create(e){let t=e.facet(sr).find((e=>e.field==this));return((null==t?void 0:t.create)||this.createF)(e)}slot(e){let t=e[this.id]>>1;return{create:e=>(e.values[t]=this.create(e),1),update:(e,n)=>{let s=e.values[t],i=this.updateF(s,n);return this.compareF(s,i)?0:(e.values[t]=i,1)},reconfigure:(e,n)=>{let s,i=e.facet(sr),r=n.facet(sr);return(s=i.find((e=>e.field==this)))&&s!=r.find((e=>e.field==this))?(e.values[t]=s.create(e),1):null!=n.config.address[this.id]?(e.values[t]=n.field(this),0):(e.values[t]=this.create(e),1)}}}init(e){return[this,sr.of({field:this,create:e})]}get extension(){return this}}const rr=4,or=3,ar=2,lr=1;function cr(e){return t=>new ur(t,e)}const hr={highest:cr(0),high:cr(lr),default:cr(ar),low:cr(or),lowest:cr(rr)};class ur{constructor(e,t){this.inner=e,this.prec=t}}class dr{of(e){return new fr(this,e)}reconfigure(e){return dr.reconfigure.of({compartment:this,extension:e})}get(e){return e.config.compartments.get(this)}}class fr{constructor(e,t){this.compartment=e,this.inner=t}}class pr{constructor(e,t,n,s,i,r){for(this.base=e,this.compartments=t,this.dynamicSlots=n,this.address=s,this.staticValues=i,this.facets=r,this.statusTemplate=[];this.statusTemplate.length<n.length;)this.statusTemplate.push(0)}staticFacet(e){let t=this.address[e.id];return null==t?e.default:this.staticValues[t>>1]}static resolve(e,t,n){let s=[],i=Object.create(null),r=new Map;for(let n of function(e,t,n){let s=[[],[],[],[],[]],i=new Map;function r(e,o){let a=i.get(e);if(null!=a){if(a<=o)return;let t=s[a].indexOf(e);t>-1&&s[a].splice(t,1),e instanceof fr&&n.delete(e.compartment)}if(i.set(e,o),Array.isArray(e))for(let t of e)r(t,o);else if(e instanceof fr){if(n.has(e.compartment))throw new RangeError('Duplicate use of compartment in extensions');let s=t.get(e.compartment)||e.inner;n.set(e.compartment,s),r(s,o)}else if(e instanceof ur)r(e.inner,e.prec);else if(e instanceof ir)s[o].push(e),e.provides&&r(e.provides,o);else if(e instanceof Ji)s[o].push(e),e.facet.extensions&&r(e.facet.extensions,ar);else{let t=e.extension;if(!t)throw new Error(`Unrecognized extension value in extension set (${e}). This sometimes happens because multiple instances of @codemirror/state are loaded, breaking instanceof checks.`);r(t,o)}}return r(e,ar),s.reduce(((e,t)=>e.concat(t)))}(e,t,r))n instanceof ir?s.push(n):(i[n.facet.id]||(i[n.facet.id]=[])).push(n);let o=Object.create(null),a=[],l=[];for(let e of s)o[e.id]=l.length<<1,l.push((t=>e.slot(t)));let c=null==n?void 0:n.config.facets;for(let e in i){let t=i[e],s=t[0].facet,r=c&&c[e]||[];if(t.every((e=>0==e.type)))if(o[s.id]=a.length<<1|1,Zi(r,t))a.push(n.facet(s));else{let e=s.combine(t.map((e=>e.value)));a.push(n&&s.compare(e,n.facet(s))?n.facet(s):e)}else{for(let e of t)0==e.type?(o[e.id]=a.length<<1|1,a.push(e.value)):(o[e.id]=l.length<<1,l.push((t=>e.dynamicSlot(t))));o[s.id]=l.length<<1,l.push((e=>nr(e,s,t)))}}let h=l.map((e=>e(o)));return new pr(e,r,h,o,a,i)}}function mr(e,t){if(1&t)return 2;let n=t>>1,s=e.status[n];if(4==s)throw new Error('Cyclic dependency between fields and/or facets');if(2&s)return s;e.status[n]=4;let i=e.computeSlot(e,e.config.dynamicSlots[n]);return e.status[n]=2|i}function gr(e,t){return 1&t?e.config.staticValues[t>>1]:e.values[t>>1]}const vr=Ki.define(),xr=Ki.define({combine:e=>e.some((e=>e)),static:!0}),br=Ki.define({combine:e=>e.length?e[0]:void 0,static:!0}),yr=Ki.define(),_r=Ki.define(),wr=Ki.define(),kr=Ki.define({combine:e=>!!e.length&&e[0]});class Or{constructor(e,t){this.type=e,this.value=t}static define(){return new Sr}}class Sr{of(e){return new Or(this,e)}}class Tr{constructor(e){this.map=e}of(e){return new Ir(this,e)}}class Ir{constructor(e,t){this.type=e,this.value=t}map(e){let t=this.type.map(this.value,e);return void 0===t?void 0:t==this.value?this:new Ir(this.type,t)}is(e){return this.type==e}static define(e={}){return new Tr(e.map||(e=>e))}static mapEffects(e,t){if(!e.length)return e;let n=[];for(let s of e){let e=s.map(t);e&&n.push(e)}return n}}Ir.reconfigure=Ir.define(),Ir.appendConfig=Ir.define();class Cr{constructor(e,t,n,s,i,r){this.startState=e,this.changes=t,this.selection=n,this.effects=s,this.annotations=i,this.scrollIntoView=r,this._doc=null,this._state=null,n&&Hi(n,t.newLength),i.some((e=>e.type==Cr.time))||(this.annotations=i.concat(Cr.time.of(Date.now())))}static create(e,t,n,s,i,r){return new Cr(e,t,n,s,i,r)}get newDoc(){return this._doc||(this._doc=this.changes.apply(this.startState.doc))}get newSelection(){return this.selection||this.startState.selection.map(this.changes)}get state(){return this._state||this.startState.applyTransaction(this),this._state}annotation(e){for(let t of this.annotations)if(t.type==e)return t.value}get docChanged(){return!this.changes.empty}get reconfigured(){return this.startState.config!=this.state.config}isUserEvent(e){let t=this.annotation(Cr.userEvent);return!(!t||!(t==e||t.length>e.length&&t.slice(0,e.length)==e&&'.'==t[e.length]))}}function $r(e,t){let n=[];for(let s=0,i=0;;){let r,o;if(s<e.length&&(i==t.length||t[i]>=e[s]))r=e[s++],o=e[s++];else{if(!(i<t.length))return n;r=t[i++],o=t[i++]}!n.length||n[n.length-1]<r?n.push(r,o):n[n.length-1]<o&&(n[n.length-1]=o)}}function Ar(e,t,n){var s;let i,r,o;return n?(i=t.changes,r=Vi.empty(t.changes.length),o=e.changes.compose(t.changes)):(i=t.changes.map(e.changes),r=e.changes.mapDesc(t.changes,!0),o=e.changes.compose(i)),{changes:o,selection:t.selection?t.selection.map(r):null===(s=e.selection)||void 0===s?void 0:s.map(i),effects:Ir.mapEffects(e.effects,i).concat(Ir.mapEffects(t.effects,r)),annotations:e.annotations.length?e.annotations.concat(t.annotations):t.annotations,scrollIntoView:e.scrollIntoView||t.scrollIntoView}}function Er(e,t,n){let s=t.selection,i=Mr(t.annotations);return t.userEvent&&(i=i.concat(Cr.userEvent.of(t.userEvent))),{changes:t.changes instanceof Vi?t.changes:Vi.of(t.changes||[],n,e.facet(br)),selection:s&&(s instanceof qi?s:qi.single(s.anchor,s.head)),effects:Mr(t.effects),annotations:i,scrollIntoView:!!t.scrollIntoView}}function Pr(e,t,n){let s=Er(e,t.length?t[0]:{},e.doc.length);t.length&&!1===t[0].filter&&(n=!1);for(let i=1;i<t.length;i++){!1===t[i].filter&&(n=!1);let r=!!t[i].sequential;s=Ar(s,Er(e,t[i],r?s.changes.newLength:e.doc.length),r)}let i=Cr.create(e,s.changes,s.selection,s.effects,s.annotations,s.scrollIntoView);return function(e){let t=e.startState,n=t.facet(wr),s=e;for(let i=n.length-1;i>=0;i--){let r=n[i](e);r&&Object.keys(r).length&&(s=Ar(s,Er(t,r,e.changes.newLength),!0))}return s==e?e:Cr.create(t,e.changes,e.selection,s.effects,s.annotations,s.scrollIntoView)}(n?function(e){let t=e.startState,n=!0;for(let s of t.facet(yr)){let t=s(e);if(!1===t){n=!1;break}Array.isArray(t)&&(n=!0===n?t:$r(n,t))}if(!0!==n){let s,i;if(!1===n)i=e.changes.invertedDesc,s=Vi.empty(t.doc.length);else{let t=e.changes.filter(n);s=t.changes,i=t.filtered.mapDesc(t.changes).invertedDesc}e=Cr.create(t,s,e.selection&&e.selection.map(i),Ir.mapEffects(e.effects,i),e.annotations,e.scrollIntoView)}let s=t.facet(_r);for(let n=s.length-1;n>=0;n--){let i=s[n](e);e=i instanceof Cr?i:Array.isArray(i)&&1==i.length&&i[0]instanceof Cr?i[0]:Pr(t,Mr(i),!1)}return e}(i):i)}Cr.time=Or.define(),Cr.userEvent=Or.define(),Cr.addToHistory=Or.define(),Cr.remote=Or.define();const Dr=[];function Mr(e){return null==e?Dr:Array.isArray(e)?e:[e]}var Lr=(e=>(e[e.Word=0]='Word',e[e.Space=1]='Space',e[e.Other=2]='Other',e))(Lr||(Lr={}));const Br=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;let Nr;try{Nr=new RegExp('[\\p{Alphabetic}\\p{Number}_]','u')}catch(e){}function Rr(e){return t=>{if(!/\S/.test(t))return Lr.Space;if(function(e){if(Nr)return Nr.test(e);for(let t=0;t<e.length;t++){let n=e[t];if(/\w/.test(n)||n>''&&(n.toUpperCase()!=n.toLowerCase()||Br.test(n)))return!0}return!1}(t))return Lr.Word;for(let n=0;n<e.length;n++)if(t.indexOf(e[n])>-1)return Lr.Word;return Lr.Other}}class Fr{constructor(e,t,n,s,i,r){this.config=e,this.doc=t,this.selection=n,this.values=s,this.status=e.statusTemplate.slice(),this.computeSlot=i,r&&(r._state=this);for(let e=0;e<this.config.dynamicSlots.length;e++)mr(this,e<<1);this.computeSlot=null}field(e,t=!0){let n=this.config.address[e.id];if(null!=n)return mr(this,n),gr(this,n);if(t)throw new RangeError('Field is not present in this state')}update(...e){return Pr(this,e,!0)}applyTransaction(e){let t,n=this.config,{base:s,compartments:i}=n;for(let t of e.effects)t.is(dr.reconfigure)?(n&&(i=new Map,n.compartments.forEach(((e,t)=>i.set(t,e))),n=null),i.set(t.value.compartment,t.value.extension)):t.is(Ir.reconfigure)?(n=null,s=t.value):t.is(Ir.appendConfig)&&(n=null,s=Mr(s).concat(t.value));if(n)t=e.startState.values.slice();else{n=pr.resolve(s,i,this),t=new Fr(n,this.doc,this.selection,n.dynamicSlots.map((()=>null)),((e,t)=>t.reconfigure(e,this)),null).values}let r=e.startState.facet(xr)?e.newSelection:e.newSelection.asSingle();new Fr(n,e.newDoc,r,t,((t,n)=>n.update(t,e)),e)}replaceSelection(e){return'string'==typeof e&&(e=this.toText(e)),this.changeByRange((t=>({changes:{from:t.from,to:t.to,insert:e},range:qi.cursor(t.from+e.length)})))}changeByRange(e){let t=this.selection,n=e(t.ranges[0]),s=this.changes(n.changes),i=[n.range],r=Mr(n.effects);for(let n=1;n<t.ranges.length;n++){let o=e(t.ranges[n]),a=this.changes(o.changes),l=a.map(s);for(let e=0;e<n;e++)i[e]=i[e].map(l);let c=s.mapDesc(a,!0);i.push(o.range.map(c)),s=s.compose(l),r=Ir.mapEffects(r,l).concat(Ir.mapEffects(Mr(o.effects),c))}return{changes:s,selection:qi.create(i,t.mainIndex),effects:r}}changes(e=[]){return e instanceof Vi?e:Vi.of(e,this.doc.length,this.facet(Fr.lineSeparator))}toText(e){return ki.of(e.split(this.facet(Fr.lineSeparator)||Ni))}sliceDoc(e=0,t=this.doc.length){return this.doc.sliceString(e,t,this.lineBreak)}facet(e){let t=this.config.address[e.id];return null==t?e.default:(mr(this,t),gr(this,t))}toJSON(e){let t={doc:this.sliceDoc(),selection:this.selection.toJSON()};if(e)for(let n in e){let s=e[n];s instanceof ir&&null!=this.config.address[s.id]&&(t[n]=s.spec.toJSON(this.field(e[n]),this))}return t}static fromJSON(e,t={},n){if(!e||'string'!=typeof e.doc)throw new RangeError('Invalid JSON representation for EditorState');let s=[];if(n)for(let t in n)if(Object.prototype.hasOwnProperty.call(e,t)){let i=n[t],r=e[t];s.push(i.init((e=>i.spec.fromJSON(r,e))))}return Fr.create({doc:e.doc,selection:qi.fromJSON(e.selection),extensions:t.extensions?s.concat([t.extensions]):s})}static create(e={}){let t=pr.resolve(e.extensions||[],new Map),n=e.doc instanceof ki?e.doc:ki.of((e.doc||'').split(t.staticFacet(Fr.lineSeparator)||Ni)),s=e.selection?e.selection instanceof qi?e.selection:qi.single(e.selection.anchor,e.selection.head):qi.single(0);return Hi(s,n.length),t.staticFacet(xr)||(s=s.asSingle()),new Fr(t,n,s,t.dynamicSlots.map((()=>null)),((e,t)=>t.create(e)),null)}get tabSize(){return this.facet(Fr.tabSize)}get lineBreak(){return this.facet(Fr.lineSeparator)||'\n'}get readOnly(){return this.facet(kr)}phrase(e,...t){for(let t of this.facet(Fr.phrases))if(Object.prototype.hasOwnProperty.call(t,e)){e=t[e];break}return t.length&&(e=e.replace(/\$(\$|\d*)/g,((e,n)=>{if('$'==n)return'$';let s=+(n||1);return!s||s>t.length?e:t[s-1]}))),e}languageDataAt(e,t,n=-1){let s=[];for(let i of this.facet(vr))for(let r of i(this,t,n))Object.prototype.hasOwnProperty.call(r,e)&&s.push(r[e]);return s}charCategorizer(e){return Rr(this.languageDataAt('wordChars',e).join(''))}wordAt(e){let{text:t,from:n,length:s}=this.doc.lineAt(e),i=this.charCategorizer(e),r=e-n,o=e-n;for(;r>0;){let e=Di(t,r,!1);if(i(t.slice(e,r))!=Lr.Word)break;r=e}for(;o<s;){let e=Di(t,o);if(i(t.slice(o,e))!=Lr.Word)break;o=e}return r==o?null:qi.range(r+n,o+n)}}function Vr(e,t,n={}){let s={};for(let t of e)for(let e of Object.keys(t)){let i=t[e],r=s[e];if(void 0===r)s[e]=i;else if(r===i||void 0===i);else{if(!Object.hasOwnProperty.call(n,e))throw new Error('Config merge conflict for field '+e);s[e]=n[e](r,i)}}for(let e in t)void 0===s[e]&&(s[e]=t[e]);return s}Fr.allowMultipleSelections=xr,Fr.tabSize=Ki.define({combine:e=>e.length?e[0]:4}),Fr.lineSeparator=br,Fr.readOnly=kr,Fr.phrases=Ki.define({compare(e,t){let n=Object.keys(e),s=Object.keys(t);return n.length==s.length&&n.every((n=>e[n]==t[n]))}}),Fr.languageData=vr,Fr.changeFilter=yr,Fr.transactionFilter=_r,Fr.transactionExtender=wr,dr.reconfigure=Ir.define();class zr{eq(e){return this==e}range(e,t=e){return Ur.create(e,t,this)}}zr.prototype.startSide=zr.prototype.endSide=0,zr.prototype.point=!1,zr.prototype.mapMode=Ri.TrackDel;class Ur{constructor(e,t,n){this.from=e,this.to=t,this.value=n}static create(e,t,n){return new Ur(e,t,n)}}function Wr(e,t){return e.from-t.from||e.value.startSide-t.value.startSide}class Qr{constructor(e,t,n,s){this.from=e,this.to=t,this.value=n,this.maxPoint=s}get length(){return this.to[this.to.length-1]}findIndex(e,t,n,s=0){let i=n?this.to:this.from;for(let r=s,o=i.length;;){if(r==o)return r;let s=r+o>>1,a=i[s]-e||(n?this.value[s].endSide:this.value[s].startSide)-t;if(s==r)return a>=0?r:o;a>=0?o=s:r=s+1}}between(e,t,n,s){for(let i=this.findIndex(t,-1e9,!0),r=this.findIndex(n,1e9,!1,i);i<r;i++)if(!1===s(this.from[i]+e,this.to[i]+e,this.value[i]))return!1}map(e,t){let n=[],s=[],i=[],r=-1,o=-1;for(let a=0;a<this.value.length;a++){let l,c,h=this.value[a],u=this.from[a]+e,d=this.to[a]+e;if(u==d){let e=t.mapPos(u,h.startSide,h.mapMode);if(null==e)continue;if(l=c=e,h.startSide!=h.endSide&&(c=t.mapPos(u,h.endSide),c<l))continue}else if(l=t.mapPos(u,h.startSide),c=t.mapPos(d,h.endSide),l>c||l==c&&h.startSide>0&&h.endSide<=0)continue;(c-l||h.endSide-h.startSide)<0||(r<0&&(r=l),h.point&&(o=Math.max(o,c-l)),n.push(h),s.push(l-r),i.push(c-r))}return{mapped:n.length?new Qr(s,i,n,o):null,pos:r}}}class jr{constructor(e,t,n,s){this.chunkPos=e,this.chunk=t,this.nextLayer=n,this.maxPoint=s}static create(e,t,n,s){return new jr(e,t,n,s)}get length(){let e=this.chunk.length-1;return e<0?0:Math.max(this.chunkEnd(e),this.nextLayer.length)}get size(){if(this.isEmpty)return 0;let e=this.nextLayer.size;for(let t of this.chunk)e+=t.value.length;return e}chunkEnd(e){return this.chunkPos[e]+this.chunk[e].length}update(e){let{add:t=[],sort:n=!1,filterFrom:s=0,filterTo:i=this.length}=e,r=e.filter;if(0==t.length&&!r)return this;if(n&&(t=t.slice().sort(Wr)),this.isEmpty)return t.length?jr.of(t):this;let o=new qr(this,null,-1).goto(0),a=0,l=[],c=new Xr;for(;o.value||a<t.length;)if(a<t.length&&(o.from-t[a].from||o.startSide-t[a].value.startSide)>=0){let e=t[a++];c.addInner(e.from,e.to,e.value)||l.push(e)}else 1==o.rangeIndex&&o.chunkIndex<this.chunk.length&&(a==t.length||this.chunkEnd(o.chunkIndex)<t[a].from)&&(!r||s>this.chunkEnd(o.chunkIndex)||i<this.chunkPos[o.chunkIndex])&&c.addChunk(this.chunkPos[o.chunkIndex],this.chunk[o.chunkIndex])?o.nextChunk():((!r||s>o.to||i<o.from||r(o.from,o.to,o.value))&&(c.addInner(o.from,o.to,o.value)||l.push(Ur.create(o.from,o.to,o.value))),o.next());return c.finishInner(this.nextLayer.isEmpty&&!l.length?jr.empty:this.nextLayer.update({add:l,filter:r,filterFrom:s,filterTo:i}))}map(e){if(e.empty||this.isEmpty)return this;let t=[],n=[],s=-1;for(let i=0;i<this.chunk.length;i++){let r=this.chunkPos[i],o=this.chunk[i],a=e.touchesRange(r,r+o.length);if(!1===a)s=Math.max(s,o.maxPoint),t.push(o),n.push(e.mapPos(r));else if(!0===a){let{mapped:i,pos:a}=o.map(r,e);i&&(s=Math.max(s,i.maxPoint),t.push(i),n.push(a))}}let i=this.nextLayer.map(e);return 0==t.length?i:new jr(n,t,i||jr.empty,s)}between(e,t,n){if(!this.isEmpty){for(let s=0;s<this.chunk.length;s++){let i=this.chunkPos[s],r=this.chunk[s];if(t>=i&&e<=i+r.length&&!1===r.between(i,e-i,t-i,n))return}this.nextLayer.between(e,t,n)}}iter(e=0){return Hr.from([this]).goto(e)}get isEmpty(){return this.nextLayer==this}static iter(e,t=0){return Hr.from(e).goto(t)}static compare(e,t,n,s,i=-1){let r=e.filter((e=>e.maxPoint>0||!e.isEmpty&&e.maxPoint>=i)),o=t.filter((e=>e.maxPoint>0||!e.isEmpty&&e.maxPoint>=i)),a=Gr(r,o,n),l=new Kr(r,a,i),c=new Kr(o,a,i);n.iterGaps(((e,t,n)=>Zr(l,e,c,t,n,s))),n.empty&&0==n.length&&Zr(l,0,c,0,0,s)}static eq(e,t,n=0,s){null==s&&(s=999999999);let i=e.filter((e=>!e.isEmpty&&t.indexOf(e)<0)),r=t.filter((t=>!t.isEmpty&&e.indexOf(t)<0));if(i.length!=r.length)return!1;if(!i.length)return!0;let o=Gr(i,r),a=new Kr(i,o,0).goto(n),l=new Kr(r,o,0).goto(n);for(;;){if(a.to!=l.to||!Jr(a.active,l.active)||a.point&&(!l.point||!a.point.eq(l.point)))return!1;if(a.to>s)return!0;a.next(),l.next()}}static spans(e,t,n,s,i=-1){let r=new Kr(e,null,i).goto(t),o=t,a=r.openStart;for(;;){let e=Math.min(r.to,n);if(r.point){let n=r.activeForPoint(r.to),i=r.pointFrom<t?n.length+1:r.point.startSide<0?n.length:Math.min(n.length,a);s.point(o,e,r.point,n,i,r.pointRank),a=Math.min(r.openEnd(e),n.length)}else e>o&&(s.span(o,e,r.active,a),a=r.openEnd(e));if(r.to>n)return a+(r.point&&r.to>n?1:0);o=r.to,r.next()}}static of(e,t=!1){let n=new Xr;for(let s of e instanceof Ur?[e]:t?function(e){if(e.length>1)for(let t=e[0],n=1;n<e.length;n++){let s=e[n];if(Wr(t,s)>0)return e.slice().sort(Wr);t=s}return e}(e):e)n.add(s.from,s.to,s.value);return n.finish()}static join(e){if(!e.length)return jr.empty;let t=e[e.length-1];for(let n=e.length-2;n>=0;n--)for(let s=e[n];s!=jr.empty;s=s.nextLayer)t=new jr(s.chunkPos,s.chunk,t,Math.max(s.maxPoint,t.maxPoint));return t}}jr.empty=new jr([],[],null,-1),jr.empty.nextLayer=jr.empty;class Xr{finishChunk(e){this.chunks.push(new Qr(this.from,this.to,this.value,this.maxPoint)),this.chunkPos.push(this.chunkStart),this.chunkStart=-1,this.setMaxPoint=Math.max(this.setMaxPoint,this.maxPoint),this.maxPoint=-1,e&&(this.from=[],this.to=[],this.value=[])}constructor(){this.chunks=[],this.chunkPos=[],this.chunkStart=-1,this.last=null,this.lastFrom=-1e9,this.lastTo=-1e9,this.from=[],this.to=[],this.value=[],this.maxPoint=-1,this.setMaxPoint=-1,this.nextLayer=null}add(e,t,n){this.addInner(e,t,n)||(this.nextLayer||(this.nextLayer=new Xr)).add(e,t,n)}addInner(e,t,n){let s=e-this.lastTo||n.startSide-this.last.endSide;if(s<=0&&(e-this.lastFrom||n.startSide-this.last.startSide)<0)throw new Error('Ranges must be added sorted by `from` position and `startSide`');return!(s<0)&&(250==this.from.length&&this.finishChunk(!0),this.chunkStart<0&&(this.chunkStart=e),this.from.push(e-this.chunkStart),this.to.push(t-this.chunkStart),this.last=n,this.lastFrom=e,this.lastTo=t,this.value.push(n),n.point&&(this.maxPoint=Math.max(this.maxPoint,t-e)),!0)}addChunk(e,t){if((e-this.lastTo||t.value[0].startSide-this.last.endSide)<0)return!1;this.from.length&&this.finishChunk(!0),this.setMaxPoint=Math.max(this.setMaxPoint,t.maxPoint),this.chunks.push(t),this.chunkPos.push(e);let n=t.value.length-1;return this.last=t.value[n],this.lastFrom=t.from[n]+e,this.lastTo=t.to[n]+e,!0}finish(){return this.finishInner(jr.empty)}finishInner(e){if(this.from.length&&this.finishChunk(!1),0==this.chunks.length)return e;let t=jr.create(this.chunkPos,this.chunks,this.nextLayer?this.nextLayer.finishInner(e):e,this.setMaxPoint);return this.from=null,t}}function Gr(e,t,n){let s=new Map;for(let t of e)for(let e=0;e<t.chunk.length;e++)t.chunk[e].maxPoint<=0&&s.set(t.chunk[e],t.chunkPos[e]);let i=new Set;for(let e of t)for(let t=0;t<e.chunk.length;t++){let r=s.get(e.chunk[t]);null==r||(n?n.mapPos(r):r)!=e.chunkPos[t]||(null==n?void 0:n.touchesRange(r,r+e.chunk[t].length))||i.add(e.chunk[t])}return i}class qr{constructor(e,t,n,s=0){this.layer=e,this.skip=t,this.minPoint=n,this.rank=s}get startSide(){return this.value?this.value.startSide:0}get endSide(){return this.value?this.value.endSide:0}goto(e,t=-1e9){return this.chunkIndex=this.rangeIndex=0,this.gotoInner(e,t,!1),this}gotoInner(e,t,n){for(;this.chunkIndex<this.layer.chunk.length;){let t=this.layer.chunk[this.chunkIndex];if(!(this.skip&&this.skip.has(t)||this.layer.chunkEnd(this.chunkIndex)<e||t.maxPoint<this.minPoint))break;this.chunkIndex++,n=!1}if(this.chunkIndex<this.layer.chunk.length){let s=this.layer.chunk[this.chunkIndex].findIndex(e-this.layer.chunkPos[this.chunkIndex],t,!0);(!n||this.rangeIndex<s)&&this.setRangeIndex(s)}this.next()}forward(e,t){(this.to-e||this.endSide-t)<0&&this.gotoInner(e,t,!0)}next(){for(;;){if(this.chunkIndex==this.layer.chunk.length){this.from=this.to=1e9,this.value=null;break}{let e=this.layer.chunkPos[this.chunkIndex],t=this.layer.chunk[this.chunkIndex],n=e+t.from[this.rangeIndex];if(this.from=n,this.to=e+t.to[this.rangeIndex],this.value=t.value[this.rangeIndex],this.setRangeIndex(this.rangeIndex+1),this.minPoint<0||this.value.point&&this.to-this.from>=this.minPoint)break}}}setRangeIndex(e){if(e==this.layer.chunk[this.chunkIndex].value.length){if(this.chunkIndex++,this.skip)for(;this.chunkIndex<this.layer.chunk.length&&this.skip.has(this.layer.chunk[this.chunkIndex]);)this.chunkIndex++;this.rangeIndex=0}else this.rangeIndex=e}nextChunk(){this.chunkIndex++,this.rangeIndex=0,this.next()}compare(e){return this.from-e.from||this.startSide-e.startSide||this.rank-e.rank||this.to-e.to||this.endSide-e.endSide}}class Hr{constructor(e){this.heap=e}static from(e,t=null,n=-1){let s=[];for(let i=0;i<e.length;i++)for(let r=e[i];!r.isEmpty;r=r.nextLayer)r.maxPoint>=n&&s.push(new qr(r,t,n,i));return 1==s.length?s[0]:new Hr(s)}get startSide(){return this.value?this.value.startSide:0}goto(e,t=-1e9){for(let n of this.heap)n.goto(e,t);for(let e=this.heap.length>>1;e>=0;e--)Yr(this.heap,e);return this.next(),this}forward(e,t){for(let n of this.heap)n.forward(e,t);for(let e=this.heap.length>>1;e>=0;e--)Yr(this.heap,e);(this.to-e||this.value.endSide-t)<0&&this.next()}next(){if(0==this.heap.length)this.from=this.to=1e9,this.value=null,this.rank=-1;else{let e=this.heap[0];this.from=e.from,this.to=e.to,this.value=e.value,this.rank=e.rank,e.value&&e.next(),Yr(this.heap,0)}}}function Yr(e,t){for(let n=e[t];;){let s=1+(t<<1);if(s>=e.length)break;let i=e[s];if(s+1<e.length&&i.compare(e[s+1])>=0&&(i=e[s+1],s++),n.compare(i)<0)break;e[s]=n,e[t]=i,t=s}}class Kr{constructor(e,t,n){this.minPoint=n,this.active=[],this.activeTo=[],this.activeRank=[],this.minActive=-1,this.point=null,this.pointFrom=0,this.pointRank=0,this.to=-1e9,this.endSide=0,this.openStart=-1,this.cursor=Hr.from(e,t,n)}goto(e,t=-1e9){return this.cursor.goto(e,t),this.active.length=this.activeTo.length=this.activeRank.length=0,this.minActive=-1,this.to=e,this.endSide=t,this.openStart=-1,this.next(),this}forward(e,t){for(;this.minActive>-1&&(this.activeTo[this.minActive]-e||this.active[this.minActive].endSide-t)<0;)this.removeActive(this.minActive);this.cursor.forward(e,t)}removeActive(e){eo(this.active,e),eo(this.activeTo,e),eo(this.activeRank,e),this.minActive=no(this.active,this.activeTo)}addActive(e){let t=0,{value:n,to:s,rank:i}=this.cursor;for(;t<this.activeRank.length&&(i-this.activeRank[t]||s-this.activeTo[t])>0;)t++;to(this.active,t,n),to(this.activeTo,t,s),to(this.activeRank,t,i),e&&to(e,t,this.cursor.from),this.minActive=no(this.active,this.activeTo)}next(){let e=this.to,t=this.point;this.point=null;let n=this.openStart<0?[]:null;for(;;){let s=this.minActive;if(s>-1&&(this.activeTo[s]-this.cursor.from||this.active[s].endSide-this.cursor.startSide)<0){if(this.activeTo[s]>e){this.to=this.activeTo[s],this.endSide=this.active[s].endSide;break}this.removeActive(s),n&&eo(n,s)}else{if(!this.cursor.value){this.to=this.endSide=1e9;break}if(this.cursor.from>e){this.to=this.cursor.from,this.endSide=this.cursor.startSide;break}{let e=this.cursor.value;if(e.point){if(!(t&&this.cursor.to==this.to&&this.cursor.from<this.cursor.to)){this.point=e,this.pointFrom=this.cursor.from,this.pointRank=this.cursor.rank,this.to=this.cursor.to,this.endSide=e.endSide,this.cursor.next(),this.forward(this.to,this.endSide);break}this.cursor.next()}else this.addActive(n),this.cursor.next()}}}if(n){this.openStart=0;for(let t=n.length-1;t>=0&&n[t]<e;t--)this.openStart++}}activeForPoint(e){if(!this.active.length)return this.active;let t=[];for(let n=this.active.length-1;n>=0&&!(this.activeRank[n]<this.pointRank);n--)(this.activeTo[n]>e||this.activeTo[n]==e&&this.active[n].endSide>=this.point.endSide)&&t.push(this.active[n]);return t.reverse()}openEnd(e){let t=0;for(let n=this.activeTo.length-1;n>=0&&this.activeTo[n]>e;n--)t++;return t}}function Zr(e,t,n,s,i,r){e.goto(t),n.goto(s);let o=s+i,a=s,l=s-t;for(;;){let t=e.to+l-n.to,s=t||e.endSide-n.endSide,i=s<0?e.to+l:n.to,c=Math.min(i,o);if(e.point||n.point?e.point&&n.point&&(e.point==n.point||e.point.eq(n.point))&&Jr(e.activeForPoint(e.to),n.activeForPoint(n.to))||r.comparePoint(a,c,e.point,n.point):c>a&&!Jr(e.active,n.active)&&r.compareRange(a,c,e.active,n.active),i>o)break;(t||e.openEnd!=n.openEnd)&&r.boundChange&&r.boundChange(i),a=i,s<=0&&e.next(),s>=0&&n.next()}}function Jr(e,t){if(e.length!=t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!=t[n]&&!e[n].eq(t[n]))return!1;return!0}function eo(e,t){for(let n=t,s=e.length-1;n<s;n++)e[n]=e[n+1];e.pop()}function to(e,t,n){for(let n=e.length-1;n>=t;n--)e[n+1]=e[n];e[t]=n}function no(e,t){let n=-1,s=1e9;for(let i=0;i<t.length;i++)(t[i]-s||e[i].endSide-e[n].endSide)<0&&(n=i,s=t[i]);return n}function so(e,t,n=e.length){let s=0;for(let i=0;i<n&&i<e.length;)9==e.charCodeAt(i)?(s+=t-s%t,i++):(s++,i=Di(e,i));return s}const io='undefined'==typeof Symbol?'__':Symbol.for(''),ro='undefined'==typeof Symbol?'__styleSet'+Math.floor(1e8*Math.random()):Symbol('styleSet'),oo='undefined'!=typeof globalThis?globalThis:'undefined'!=typeof window?window:{};class ao{constructor(e,t){this.rules=[];let{finish:n}=t||{};function s(e){return/^@/.test(e)?[e]:e.split(/,\s*/)}function i(e,t,r,o){let a=[],l=/^@(\w+)\b/.exec(e[0]),c=l&&'keyframes'==l[1];if(l&&null==t)return r.push(e[0]+';');for(let n in t){let o=t[n];if(/&/.test(n))i(n.split(/,\s*/).map((t=>e.map((e=>t.replace(/&/,e))))).reduce(((e,t)=>e.concat(t))),o,r);else if(o&&'object'==typeof o){if(!l)throw new RangeError('The value of a property ('+n+') should be a primitive value.');i(s(n),o,a,c)}else null!=o&&a.push(n.replace(/_.*/,'').replace(/[A-Z]/g,(e=>'-'+e.toLowerCase()))+': '+o+';')}(a.length||c)&&r.push((!n||l||o?e:e.map(n)).join(', ')+' {'+a.join(' ')+'}')}for(let t in e)i(s(t),e[t],this.rules)}getRules(){return this.rules.join('\n')}static newName(){let e=oo[io]||1;return oo[io]=e+1,''+e.toString(36)}static mount(e,t,n){let s=e[ro],i=n&&n.nonce;s?i&&s.setNonce(i):s=new co(e,i),s.mount(Array.isArray(t)?t:[t],e)}}let lo=new Map;class co{constructor(e,t){let n=e.ownerDocument||e,s=n.defaultView;if(!e.head&&e.adoptedStyleSheets&&s.CSSStyleSheet){let t=lo.get(n);if(t)return e[ro]=t;this.sheet=new s.CSSStyleSheet,lo.set(n,this)}else this.styleTag=n.createElement('style'),t&&this.styleTag.setAttribute('nonce',t);this.modules=[],e[ro]=this}mount(e,t){let n=this.sheet,s=0,i=0;for(let t=0;t<e.length;t++){let r=e[t],o=this.modules.indexOf(r);if(o<i&&o>-1&&(this.modules.splice(o,1),i--,o=-1),-1==o){if(this.modules.splice(i++,0,r),n)for(let e=0;e<r.rules.length;e++)n.insertRule(r.rules[e],s++)}else{for(;i<o;)s+=this.modules[i++].rules.length;s+=r.rules.length,i++}}if(n)t.adoptedStyleSheets.indexOf(this.sheet)<0&&(t.adoptedStyleSheets=[this.sheet,...t.adoptedStyleSheets]);else{let e='';for(let t=0;t<this.modules.length;t++)e+=this.modules[t].getRules()+'\n';this.styleTag.textContent=e;let n=t.head||t;this.styleTag.parentNode!=n&&n.insertBefore(this.styleTag,n.firstChild)}}setNonce(e){this.styleTag&&this.styleTag.getAttribute('nonce')!=e&&this.styleTag.setAttribute('nonce',e)}}for(var ho={8:'Backspace',9:'Tab',10:'Enter',12:'NumLock',13:'Enter',16:'Shift',17:'Control',18:'Alt',20:'CapsLock',27:'Escape',32:' ',33:'PageUp',34:'PageDown',35:'End',36:'Home',37:'ArrowLeft',38:'ArrowUp',39:'ArrowRight',40:'ArrowDown',44:'PrintScreen',45:'Insert',46:'Delete',59:';',61:'=',91:'Meta',92:'Meta',106:'*',107:'+',108:',',109:'-',110:'.',111:'/',144:'NumLock',145:'ScrollLock',160:'Shift',161:'Shift',162:'Control',163:'Control',164:'Alt',165:'Alt',173:'-',186:';',187:'=',188:',',189:'-',190:'.',191:'/',192:'`',219:'[',220:'\\',221:']',222:'\''},uo={48:')',49:'!',50:'@',51:'#',52:'$',53:'%',54:'^',55:'&',56:'*',57:'(',59:':',61:'+',173:'_',186:':',187:'+',188:'<',189:'_',190:'>',191:'?',192:'~',219:'{',220:'|',221:'}',222:'"'},fo='undefined'!=typeof navigator&&/Mac/.test(navigator.platform),po='undefined'!=typeof navigator&&/MSIE \d|Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(navigator.userAgent),mo=0;mo<10;mo++)ho[48+mo]=ho[96+mo]=String(mo);for(mo=1;mo<=24;mo++)ho[mo+111]='F'+mo;for(mo=65;mo<=90;mo++)ho[mo]=String.fromCharCode(mo+32),uo[mo]=String.fromCharCode(mo);for(var go in ho)uo.hasOwnProperty(go)||(uo[go]=ho[go]);function vo(e){let t;return t=11==e.nodeType?e.getSelection?e:e.ownerDocument:e,t.getSelection()}function xo(e,t){return!!t&&(e==t||e.contains(1!=t.nodeType?t.parentNode:t))}function bo(e,t){if(!t.anchorNode)return!1;try{return xo(e,t.anchorNode)}catch(e){return!1}}function yo(e){return 3==e.nodeType?Do(e,0,e.nodeValue.length).getClientRects():1==e.nodeType?e.getClientRects():[]}function _o(e,t,n,s){return!!n&&(Oo(e,t,n,s,-1)||Oo(e,t,n,s,1))}function wo(e){for(var t=0;;t++)if(!(e=e.previousSibling))return t}function ko(e){return 1==e.nodeType&&/^(DIV|P|LI|UL|OL|BLOCKQUOTE|DD|DT|H\d|SECTION|PRE)$/.test(e.nodeName)}function Oo(e,t,n,s,i){for(;;){if(e==n&&t==s)return!0;if(t==(i<0?0:So(e))){if('DIV'==e.nodeName)return!1;let n=e.parentNode;if(!n||1!=n.nodeType)return!1;t=wo(e)+(i<0?0:1),e=n}else{if(1!=e.nodeType)return!1;if(1==(e=e.childNodes[t+(i<0?-1:0)]).nodeType&&'false'==e.contentEditable)return!1;t=i<0?So(e):0}}}function So(e){return 3==e.nodeType?e.nodeValue.length:e.childNodes.length}function To(e,t){let n=t?e.left:e.right;return{left:n,right:n,top:e.top,bottom:e.bottom}}function Io(e){let t=e.visualViewport;return t?{left:0,right:t.width,top:0,bottom:t.height}:{left:0,right:e.innerWidth,top:0,bottom:e.innerHeight}}function Co(e,t){let n=t.width/e.offsetWidth,s=t.height/e.offsetHeight;return(n>.995&&n<1.005||!isFinite(n)||Math.abs(t.width-e.offsetWidth)<1)&&(n=1),(s>.995&&s<1.005||!isFinite(s)||Math.abs(t.height-e.offsetHeight)<1)&&(s=1),{scaleX:n,scaleY:s}}class $o{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}eq(e){return this.anchorNode==e.anchorNode&&this.anchorOffset==e.anchorOffset&&this.focusNode==e.focusNode&&this.focusOffset==e.focusOffset}setRange(e){let{anchorNode:t,focusNode:n}=e;this.set(t,Math.min(e.anchorOffset,t?So(t):0),n,Math.min(e.focusOffset,n?So(n):0))}set(e,t,n,s){this.anchorNode=e,this.anchorOffset=t,this.focusNode=n,this.focusOffset=s}}let Ao,Eo=null;function Po(e){if(e.setActive)return e.setActive();if(Eo)return e.focus(Eo);let t=[];for(let n=e;n&&(t.push(n,n.scrollTop,n.scrollLeft),n!=n.ownerDocument);n=n.parentNode);if(e.focus(null==Eo?{get preventScroll(){return Eo={preventScroll:!0},!0}}:void 0),!Eo){Eo=!1;for(let e=0;e<t.length;){let n=t[e++],s=t[e++],i=t[e++];n.scrollTop!=s&&(n.scrollTop=s),n.scrollLeft!=i&&(n.scrollLeft=i)}}}function Do(e,t,n=t){let s=Ao||(Ao=document.createRange());return s.setEnd(e,n),s.setStart(e,t),s}function Mo(e,t,n,s){let i={key:t,code:t,keyCode:n,which:n,cancelable:!0};s&&({altKey:i.altKey,ctrlKey:i.ctrlKey,shiftKey:i.shiftKey,metaKey:i.metaKey}=s);let r=new KeyboardEvent('keydown',i);r.synthetic=!0,e.dispatchEvent(r);let o=new KeyboardEvent('keyup',i);return o.synthetic=!0,e.dispatchEvent(o),r.defaultPrevented||o.defaultPrevented}function Lo(e){for(;e.attributes.length;)e.removeAttributeNode(e.attributes[0])}function Bo(e){return e.scrollTop>Math.max(1,e.scrollHeight-e.clientHeight-4)}function No(e,t){for(let n=e,s=t;;){if(3==n.nodeType&&s>0)return{node:n,offset:s};if(1==n.nodeType&&s>0){if('false'==n.contentEditable)return null;n=n.childNodes[s-1],s=So(n)}else{if(!n.parentNode||ko(n))return null;s=wo(n),n=n.parentNode}}}function Ro(e,t){for(let n=e,s=t;;){if(3==n.nodeType&&s<n.nodeValue.length)return{node:n,offset:s};if(1==n.nodeType&&s<n.childNodes.length){if('false'==n.contentEditable)return null;n=n.childNodes[s],s=0}else{if(!n.parentNode||ko(n))return null;s=wo(n)+1,n=n.parentNode}}}class Fo{constructor(e,t,n=!0){this.node=e,this.offset=t,this.precise=n}static before(e,t){return new Fo(e.parentNode,wo(e),t)}static after(e,t){return new Fo(e.parentNode,wo(e)+1,t)}}const Vo=[];class zo{constructor(){this.parent=null,this.dom=null,this.flags=2}get overrideDOMText(){return null}get posAtStart(){return this.parent?this.parent.posBefore(this):0}get posAtEnd(){return this.posAtStart+this.length}posBefore(e){let t=this.posAtStart;for(let n of this.children){if(n==e)return t;t+=n.length+n.breakAfter}throw new RangeError('Invalid child in posBefore')}posAfter(e){return this.posBefore(e)+e.length}sync(e,t){if(2&this.flags){let n,s=this.dom,i=null;for(let r of this.children){if(7&r.flags){if(!r.dom&&(n=i?i.nextSibling:s.firstChild)){let e=zo.get(n);(!e||!e.parent&&e.canReuseDOM(r))&&r.reuseDOM(n)}r.sync(e,t),r.flags&=-8}if(n=i?i.nextSibling:s.firstChild,t&&!t.written&&t.node==s&&n!=r.dom&&(t.written=!0),r.dom.parentNode==s)for(;n&&n!=r.dom;)n=Uo(n);else s.insertBefore(r.dom,n);i=r.dom}for(n=i?i.nextSibling:s.firstChild,n&&t&&t.node==s&&(t.written=!0);n;)n=Uo(n)}else if(1&this.flags)for(let n of this.children)7&n.flags&&(n.sync(e,t),n.flags&=-8)}reuseDOM(e){}localPosFromDOM(e,t){let n;if(e==this.dom)n=this.dom.childNodes[t];else{let s=0==So(e)?0:0==t?-1:1;for(;;){let t=e.parentNode;if(t==this.dom)break;0==s&&t.firstChild!=t.lastChild&&(s=e==t.firstChild?-1:1),e=t}n=s<0?e:e.nextSibling}if(n==this.dom.firstChild)return 0;for(;n&&!zo.get(n);)n=n.nextSibling;if(!n)return this.length;for(let e=0,t=0;;e++){let s=this.children[e];if(s.dom==n)return t;t+=s.length+s.breakAfter}}domBoundsAround(e,t,n=0){let s=-1,i=-1,r=-1,o=-1;for(let a=0,l=n,c=n;a<this.children.length;a++){let n=this.children[a],h=l+n.length;if(l<e&&h>t)return n.domBoundsAround(e,t,l);if(h>=e&&-1==s&&(s=a,i=l),l>t&&n.dom.parentNode==this.dom){r=a,o=c;break}c=h,l=h+n.breakAfter}return{from:i,to:o<0?n+this.length:o,startDOM:(s?this.children[s-1].dom.nextSibling:null)||this.dom.firstChild,endDOM:r<this.children.length&&r>=0?this.children[r].dom:null}}markDirty(e=!1){this.flags|=2,this.markParentsDirty(e)}markParentsDirty(e){for(let t=this.parent;t;t=t.parent){if(e&&(t.flags|=2),1&t.flags)return;t.flags|=1,e=!1}}setParent(e){this.parent!=e&&(this.parent=e,7&this.flags&&this.markParentsDirty(!0))}setDOM(e){this.dom!=e&&(this.dom&&(this.dom.cmView=null),this.dom=e,e.cmView=this)}get rootView(){for(let e=this;;){let t=e.parent;if(!t)return e;e=t}}replaceChildren(e,t,n=Vo){this.markDirty();for(let s=e;s<t;s++){let e=this.children[s];e.parent==this&&n.indexOf(e)<0&&e.destroy()}n.length<250?this.children.splice(e,t-e,...n):this.children=[].concat(this.children.slice(0,e),n,this.children.slice(t));for(let e=0;e<n.length;e++)n[e].setParent(this)}ignoreMutation(e){return!1}ignoreEvent(e){return!1}childCursor(e=this.length){return new Wo(this.children,e,this.children.length)}childPos(e,t=1){return this.childCursor().findPos(e,t)}toString(){let e=this.constructor.name.replace('View','');return e+(this.children.length?'('+this.children.join()+')':this.length?'['+('Text'==e?this.text:this.length)+']':'')+(this.breakAfter?'#':'')}static get(e){return e.cmView}get isEditable(){return!0}get isWidget(){return!1}get isHidden(){return!1}merge(e,t,n,s,i,r){return!1}become(e){return!1}canReuseDOM(e){return e.constructor==this.constructor&&!(8&(this.flags|e.flags))}getSide(){return 0}destroy(){for(let e of this.children)e.parent==this&&e.destroy();this.parent=null}}function Uo(e){let t=e.nextSibling;return e.parentNode.removeChild(e),t}zo.prototype.breakAfter=0;class Wo{constructor(e,t,n){this.children=e,this.pos=t,this.i=n,this.off=0}findPos(e,t=1){for(;;){if(e>this.pos||e==this.pos&&(t>0||0==this.i||this.children[this.i-1].breakAfter))return this.off=e-this.pos,this;let n=this.children[--this.i];this.pos-=n.length+n.breakAfter}}}function Qo(e,t,n,s,i,r,o,a,l){let{children:c}=e,h=c.length?c[t]:null,u=r.length?r[r.length-1]:null,d=u?u.breakAfter:o;if(!(t==s&&h&&!o&&!d&&r.length<2&&h.merge(n,i,r.length?u:null,0==n,a,l))){if(s<c.length){let e=c[s];e&&(i<e.length||e.breakAfter&&(null==u?void 0:u.breakAfter))?(t==s&&(e=e.split(i),i=0),!d&&u&&e.merge(0,i,u,!0,0,l)?r[r.length-1]=e:((i||e.children.length&&!e.children[0].length)&&e.merge(0,i,null,!1,0,l),r.push(e))):(null==e?void 0:e.breakAfter)&&(u?u.breakAfter=1:o=1),s++}for(h&&(h.breakAfter=o,n>0&&(!o&&r.length&&h.merge(n,h.length,r[0],!1,a,0)?h.breakAfter=r.shift().breakAfter:(n<h.length||h.children.length&&0==h.children[h.children.length-1].length)&&h.merge(n,h.length,null,!1,a,0),t++));t<s&&r.length;)if(c[s-1].become(r[r.length-1]))s--,r.pop(),l=r.length?0:a;else{if(!c[t].become(r[0]))break;t++,r.shift(),a=r.length?0:l}!r.length&&t&&s<c.length&&!c[t-1].breakAfter&&c[s].merge(0,0,c[t-1],!1,a,l)&&t--,(t<s||r.length)&&e.replaceChildren(t,s,r)}}function jo(e,t,n,s,i,r){let o=e.childCursor(),{i:a,off:l}=o.findPos(n,1),{i:c,off:h}=o.findPos(t,-1),u=t-n;for(let e of s)u+=e.length;e.length+=u,Qo(e,c,h,a,l,s,0,i,r)}let Xo='undefined'!=typeof navigator?navigator:{userAgent:'',vendor:'',platform:''},Go='undefined'!=typeof document?document:{documentElement:{style:{}}};const qo=/Edge\/(\d+)/.exec(Xo.userAgent),Ho=/MSIE \d/.test(Xo.userAgent),Yo=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(Xo.userAgent),Ko=!!(Ho||Yo||qo),Zo=!Ko&&/gecko\/(\d+)/i.test(Xo.userAgent),Jo=!Ko&&/Chrome\/(\d+)/.exec(Xo.userAgent),ea='webkitFontSmoothing'in Go.documentElement.style,ta=!Ko&&/Apple Computer/.test(Xo.vendor),na=ta&&(/Mobile\/\w+/.test(Xo.userAgent)||Xo.maxTouchPoints>2);var sa={mac:na||/Mac/.test(Xo.platform),windows:/Win/.test(Xo.platform),linux:/Linux|X11/.test(Xo.platform),ie:Ko,ie_version:Ho?Go.documentMode||6:Yo?+Yo[1]:qo?+qo[1]:0,gecko:Zo,gecko_version:Zo?+(/Firefox\/(\d+)/.exec(Xo.userAgent)||[0,0])[1]:0,chrome:!!Jo,chrome_version:Jo?+Jo[1]:0,ios:na,android:/Android\b/.test(Xo.userAgent),webkit:ea,safari:ta,webkit_version:ea?+(/\bAppleWebKit\/(\d+)/.exec(Xo.userAgent)||[0,0])[1]:0,tabSize:null!=Go.documentElement.style.tabSize?'tab-size':'-moz-tab-size'};class ia extends zo{constructor(e){super(),this.text=e}get length(){return this.text.length}createDOM(e){this.setDOM(e||document.createTextNode(this.text))}sync(e,t){this.dom||this.createDOM(),this.dom.nodeValue!=this.text&&(t&&t.node==this.dom&&(t.written=!0),this.dom.nodeValue=this.text)}reuseDOM(e){3==e.nodeType&&this.createDOM(e)}merge(e,t,n){return!(8&this.flags||n&&(!(n instanceof ia)||this.length-(t-e)+n.length>256||8&n.flags))&&(this.text=this.text.slice(0,e)+(n?n.text:'')+this.text.slice(t),this.markDirty(),!0)}split(e){let t=new ia(this.text.slice(e));return this.text=this.text.slice(0,e),this.markDirty(),t.flags|=8&this.flags,t}localPosFromDOM(e,t){return e==this.dom?t:t?this.text.length:0}domAtPos(e){return new Fo(this.dom,e)}domBoundsAround(e,t,n){return{from:n,to:n+this.length,startDOM:this.dom,endDOM:this.dom.nextSibling}}coordsAt(e,t){return function(e,t,n){let s=e.nodeValue.length;t>s&&(t=s);let i=t,r=t,o=0;0==t&&n<0||t==s&&n>=0?sa.chrome||sa.gecko||(t?(i--,o=1):r<s&&(r++,o=-1)):n<0?i--:r<s&&r++;let a=Do(e,i,r).getClientRects();if(!a.length)return null;let l=a[(o?o<0:n>=0)?0:a.length-1];sa.safari&&!o&&0==l.width&&(l=Array.prototype.find.call(a,(e=>e.width))||l);return o?To(l,o<0):l||null}(this.dom,e,t)}}class ra extends zo{constructor(e,t=[],n=0){super(),this.mark=e,this.children=t,this.length=n;for(let e of t)e.setParent(this)}setAttrs(e){if(Lo(e),this.mark.class&&(e.className=this.mark.class),this.mark.attrs)for(let t in this.mark.attrs)e.setAttribute(t,this.mark.attrs[t]);return e}canReuseDOM(e){return super.canReuseDOM(e)&&!(8&(this.flags|e.flags))}reuseDOM(e){e.nodeName==this.mark.tagName.toUpperCase()&&(this.setDOM(e),this.flags|=6)}sync(e,t){this.dom?4&this.flags&&this.setAttrs(this.dom):this.setDOM(this.setAttrs(document.createElement(this.mark.tagName))),super.sync(e,t)}merge(e,t,n,s,i,r){return(!n||!(!(n instanceof ra&&n.mark.eq(this.mark))||e&&i<=0||t<this.length&&r<=0))&&(jo(this,e,t,n?n.children.slice():[],i-1,r-1),this.markDirty(),!0)}split(e){let t=[],n=0,s=-1,i=0;for(let r of this.children){let o=n+r.length;o>e&&t.push(n<e?r.split(e-n):r),s<0&&n>=e&&(s=i),n=o,i++}let r=this.length-e;return this.length=e,s>-1&&(this.children.length=s,this.markDirty()),new ra(this.mark,t,r)}domAtPos(e){return la(this,e)}coordsAt(e,t){return ha(this,e,t)}}class oa extends zo{static create(e,t,n){return new oa(e,t,n)}constructor(e,t,n){super(),this.widget=e,this.length=t,this.side=n,this.prevWidget=null}split(e){let t=oa.create(this.widget,this.length-e,this.side);return this.length-=e,t}sync(e){this.dom&&this.widget.updateDOM(this.dom,e)||(this.dom&&this.prevWidget&&this.prevWidget.destroy(this.dom),this.prevWidget=null,this.setDOM(this.widget.toDOM(e)),this.widget.editable||(this.dom.contentEditable='false'))}getSide(){return this.side}merge(e,t,n,s,i,r){return!(n&&(!(n instanceof oa&&this.widget.compare(n.widget))||e>0&&i<=0||t<this.length&&r<=0))&&(this.length=e+(n?n.length:0)+(this.length-t),!0)}become(e){return e instanceof oa&&e.side==this.side&&this.widget.constructor==e.widget.constructor&&(this.widget.compare(e.widget)||this.markDirty(!0),this.dom&&!this.prevWidget&&(this.prevWidget=this.widget),this.widget=e.widget,this.length=e.length,!0)}ignoreMutation(){return!0}ignoreEvent(e){return this.widget.ignoreEvent(e)}get overrideDOMText(){if(0==this.length)return ki.empty;let e=this;for(;e.parent;)e=e.parent;let{view:t}=e,n=t&&t.state.doc,s=this.posAtStart;return n?n.slice(s,s+this.length):ki.empty}domAtPos(e){return(this.length?0==e:this.side>0)?Fo.before(this.dom):Fo.after(this.dom,e==this.length)}domBoundsAround(){return null}coordsAt(e,t){let n=this.widget.coordsAt(this.dom,e,t);if(n)return n;let s=this.dom.getClientRects(),i=null;if(!s.length)return null;let r=this.side?this.side<0:e>0;for(let t=r?s.length-1:0;i=s[t],!(e>0?0==t:t==s.length-1||i.top<i.bottom);t+=r?-1:1);return To(i,!r)}get isEditable(){return!1}get isWidget(){return!0}get isHidden(){return this.widget.isHidden}destroy(){super.destroy(),this.dom&&this.widget.destroy(this.dom)}}class aa extends zo{constructor(e){super(),this.side=e}get length(){return 0}merge(){return!1}become(e){return e instanceof aa&&e.side==this.side}split(){return new aa(this.side)}sync(){if(!this.dom){let e=document.createElement('img');e.className='cm-widgetBuffer',e.setAttribute('aria-hidden','true'),this.setDOM(e)}}getSide(){return this.side}domAtPos(e){return this.side>0?Fo.before(this.dom):Fo.after(this.dom)}localPosFromDOM(){return 0}domBoundsAround(){return null}coordsAt(e){return this.dom.getBoundingClientRect()}get overrideDOMText(){return ki.empty}get isHidden(){return!0}}function la(e,t){let n=e.dom,{children:s}=e,i=0;for(let e=0;i<s.length;i++){let r=s[i],o=e+r.length;if(!(o==e&&r.getSide()<=0)){if(t>e&&t<o&&r.dom.parentNode==n)return r.domAtPos(t-e);if(t<=e)break;e=o}}for(let e=i;e>0;e--){let t=s[e-1];if(t.dom.parentNode==n)return t.domAtPos(t.length)}for(let e=i;e<s.length;e++){let t=s[e];if(t.dom.parentNode==n)return t.domAtPos(0)}return new Fo(n,0)}function ca(e,t,n){let s,{children:i}=e;n>0&&t instanceof ra&&i.length&&(s=i[i.length-1])instanceof ra&&s.mark.eq(t.mark)?ca(s,t.children[0],n-1):(i.push(t),t.setParent(e)),e.length+=t.length}function ha(e,t,n){let s=null,i=-1,r=null,o=-1;!function e(t,a){for(let l=0,c=0;l<t.children.length&&c<=a;l++){let h=t.children[l],u=c+h.length;u>=a&&(h.children.length?e(h,a-c):(!r||r.isHidden&&n>0)&&(u>a||c==u&&h.getSide()>0)?(r=h,o=a-c):(c<a||c==u&&h.getSide()<0&&!h.isHidden)&&(s=h,i=a-c)),c=u}}(e,t);let a=(n<0?s:r)||s||r;return a?a.coordsAt(Math.max(0,a==s?i:o),n):function(e){let t=e.dom.lastChild;if(!t)return e.dom.getBoundingClientRect();let n=yo(t);return n[n.length-1]||null}(e)}function ua(e,t){for(let n in e)'class'==n&&t.class?t.class+=' '+e.class:'style'==n&&t.style?t.style+=';'+e.style:t[n]=e[n];return t}ia.prototype.children=oa.prototype.children=aa.prototype.children=Vo;const da=Object.create(null);function fa(e,t,n){if(e==t)return!0;e||(e=da),t||(t=da);let s=Object.keys(e),i=Object.keys(t);if(s.length-(n&&s.indexOf(n)>-1?1:0)!=i.length-(n&&i.indexOf(n)>-1?1:0))return!1;for(let r of s)if(r!=n&&(-1==i.indexOf(r)||e[r]!==t[r]))return!1;return!0}function pa(e,t,n){let s=!1;if(t)for(let i in t)n&&i in n||(s=!0,'style'==i?e.style.cssText='':e.removeAttribute(i));if(n)for(let i in n)t&&t[i]==n[i]||(s=!0,'style'==i?e.style.cssText=n[i]:e.setAttribute(i,n[i]));return s}function ma(e){let t=Object.create(null);for(let n=0;n<e.attributes.length;n++){let s=e.attributes[n];t[s.name]=s.value}return t}class ga{eq(e){return!1}updateDOM(e,t){return!1}compare(e){return this==e||this.constructor==e.constructor&&this.eq(e)}get estimatedHeight(){return-1}get lineBreaks(){return 0}ignoreEvent(e){return!0}coordsAt(e,t,n){return null}get isHidden(){return!1}get editable(){return!1}destroy(e){}}var va=(e=>(e[e.Text=0]='Text',e[e.WidgetBefore=1]='WidgetBefore',e[e.WidgetAfter=2]='WidgetAfter',e[e.WidgetRange=3]='WidgetRange',e))(va||(va={}));class xa extends zr{constructor(e,t,n,s){super(),this.startSide=e,this.endSide=t,this.widget=n,this.spec=s}get heightRelevant(){return!1}static mark(e){return new ba(e)}static widget(e){let t=Math.max(-1e4,Math.min(1e4,e.side||0)),n=!!e.block;return t+=n&&!e.inlineOrder?t>0?3e8:-4e8:t>0?1e8:-1e8,new _a(e,t,t,n,e.widget||null,!1)}static replace(e){let t,n,s=!!e.block;if(e.isBlockGap)t=-5e8,n=4e8;else{let{start:i,end:r}=wa(e,s);t=(i?s?-3e8:-1:5e8)-1,n=1+(r?s?2e8:1:-6e8)}return new _a(e,t,n,s,e.widget||null,!0)}static line(e){return new ya(e)}static set(e,t=!1){return jr.of(e,t)}hasHeight(){return!!this.widget&&this.widget.estimatedHeight>-1}}xa.none=jr.empty;class ba extends xa{constructor(e){let{start:t,end:n}=wa(e);super(t?-1:5e8,n?1:-6e8,null,e),this.tagName=e.tagName||'span',this.class=e.class||'',this.attrs=e.attributes||null}eq(e){var t,n;return this==e||e instanceof ba&&this.tagName==e.tagName&&(this.class||(null===(t=this.attrs)||void 0===t?void 0:t.class))==(e.class||(null===(n=e.attrs)||void 0===n?void 0:n.class))&&fa(this.attrs,e.attrs,'class')}range(e,t=e){if(e>=t)throw new RangeError('Mark decorations may not be empty');return super.range(e,t)}}ba.prototype.point=!1;class ya extends xa{constructor(e){super(-2e8,-2e8,null,e)}eq(e){return e instanceof ya&&this.spec.class==e.spec.class&&fa(this.spec.attributes,e.spec.attributes)}range(e,t=e){if(t!=e)throw new RangeError('Line decoration ranges must be zero-length');return super.range(e,t)}}ya.prototype.mapMode=Ri.TrackBefore,ya.prototype.point=!0;class _a extends xa{constructor(e,t,n,s,i,r){super(t,n,i,e),this.block=s,this.isReplace=r,this.mapMode=s?t<=0?Ri.TrackBefore:Ri.TrackAfter:Ri.TrackDel}get type(){return this.startSide!=this.endSide?va.WidgetRange:this.startSide<=0?va.WidgetBefore:va.WidgetAfter}get heightRelevant(){return this.block||!!this.widget&&(this.widget.estimatedHeight>=5||this.widget.lineBreaks>0)}eq(e){return e instanceof _a&&(t=this.widget,n=e.widget,t==n||!!(t&&n&&t.compare(n)))&&this.block==e.block&&this.startSide==e.startSide&&this.endSide==e.endSide;var t,n}range(e,t=e){if(this.isReplace&&(e>t||e==t&&this.startSide>0&&this.endSide<=0))throw new RangeError('Invalid range for replacement decoration');if(!this.isReplace&&t!=e)throw new RangeError('Widget decorations can only have zero-length ranges');return super.range(e,t)}}function wa(e,t=!1){let{inclusiveStart:n,inclusiveEnd:s}=e;return null==n&&(n=e.inclusive),null==s&&(s=e.inclusive),{start:null!=n?n:t,end:null!=s?s:t}}function ka(e,t,n,s=0){let i=n.length-1;i>=0&&n[i]+s>=e?n[i]=Math.max(n[i],t):n.push(e,t)}_a.prototype.point=!0;class Oa extends zo{constructor(){super(...arguments),this.children=[],this.length=0,this.prevAttrs=void 0,this.attrs=null,this.breakAfter=0}merge(e,t,n,s,i,r){if(n){if(!(n instanceof Oa))return!1;this.dom||n.transferDOM(this)}return s&&this.setDeco(n?n.attrs:null),jo(this,e,t,n?n.children.slice():[],i,r),!0}split(e){let t=new Oa;if(t.breakAfter=this.breakAfter,0==this.length)return t;let{i:n,off:s}=this.childPos(e);s&&(t.append(this.children[n].split(s),0),this.children[n].merge(s,this.children[n].length,null,!1,0,0),n++);for(let e=n;e<this.children.length;e++)t.append(this.children[e],0);for(;n>0&&0==this.children[n-1].length;)this.children[--n].destroy();return this.children.length=n,this.markDirty(),this.length=e,t}transferDOM(e){this.dom&&(this.markDirty(),e.setDOM(this.dom),e.prevAttrs=void 0===this.prevAttrs?this.attrs:this.prevAttrs,this.prevAttrs=void 0,this.dom=null)}setDeco(e){fa(this.attrs,e)||(this.dom&&(this.prevAttrs=this.attrs,this.markDirty()),this.attrs=e)}append(e,t){ca(this,e,t)}addLineDeco(e){let t=e.spec.attributes,n=e.spec.class;t&&(this.attrs=ua(t,this.attrs||{})),n&&(this.attrs=ua({class:n},this.attrs||{}))}domAtPos(e){return la(this,e)}reuseDOM(e){'DIV'==e.nodeName&&(this.setDOM(e),this.flags|=6)}sync(e,t){var n;this.dom?4&this.flags&&(Lo(this.dom),this.dom.className='cm-line',this.prevAttrs=this.attrs?null:void 0):(this.setDOM(document.createElement('div')),this.dom.className='cm-line',this.prevAttrs=this.attrs?null:void 0),void 0!==this.prevAttrs&&(pa(this.dom,this.prevAttrs,this.attrs),this.dom.classList.add('cm-line'),this.prevAttrs=void 0),super.sync(e,t);let s=this.dom.lastChild;for(;s&&zo.get(s)instanceof ra;)s=s.lastChild;if(!(s&&this.length&&('BR'==s.nodeName||0!=(null===(n=zo.get(s))||void 0===n?void 0:n.isEditable)||sa.ios&&this.children.some((e=>e instanceof ia))))){let e=document.createElement('BR');e.cmIgnore=!0,this.dom.appendChild(e)}}measureTextSize(){if(0==this.children.length||this.length>20)return null;let e,t=0;for(let n of this.children){if(!(n instanceof ia)||/[^ -~]/.test(n.text))return null;let s=yo(n.dom);if(1!=s.length)return null;t+=s[0].width,e=s[0].height}return t?{lineHeight:this.dom.getBoundingClientRect().height,charWidth:t/this.length,textHeight:e}:null}coordsAt(e,t){let n=ha(this,e,t);if(!this.children.length&&n&&this.parent){let{heightOracle:e}=this.parent.view.viewState,t=n.bottom-n.top;if(Math.abs(t-e.lineHeight)<2&&e.textHeight<t){let s=(t-e.textHeight)/2;return{top:n.top+s,bottom:n.bottom-s,left:n.left,right:n.left}}}return n}become(e){return e instanceof Oa&&0==this.children.length&&0==e.children.length&&fa(this.attrs,e.attrs)&&this.breakAfter==e.breakAfter}covers(){return!0}static find(e,t){for(let n=0,s=0;n<e.children.length;n++){let i=e.children[n],r=s+i.length;if(r>=t){if(i instanceof Oa)return i;if(r>t)break}s=r+i.breakAfter}return null}}class Sa extends zo{constructor(e,t,n){super(),this.widget=e,this.length=t,this.deco=n,this.breakAfter=0,this.prevWidget=null}merge(e,t,n,s,i,r){return!(n&&(!(n instanceof Sa&&this.widget.compare(n.widget))||e>0&&i<=0||t<this.length&&r<=0))&&(this.length=e+(n?n.length:0)+(this.length-t),!0)}domAtPos(e){return 0==e?Fo.before(this.dom):Fo.after(this.dom,e==this.length)}split(e){let t=this.length-e;this.length=e;let n=new Sa(this.widget,t,this.deco);return n.breakAfter=this.breakAfter,n}get children(){return Vo}sync(e){this.dom&&this.widget.updateDOM(this.dom,e)||(this.dom&&this.prevWidget&&this.prevWidget.destroy(this.dom),this.prevWidget=null,this.setDOM(this.widget.toDOM(e)),this.widget.editable||(this.dom.contentEditable='false'))}get overrideDOMText(){return this.parent?this.parent.view.state.doc.slice(this.posAtStart,this.posAtEnd):ki.empty}domBoundsAround(){return null}become(e){return e instanceof Sa&&e.widget.constructor==this.widget.constructor&&(e.widget.compare(this.widget)||this.markDirty(!0),this.dom&&!this.prevWidget&&(this.prevWidget=this.widget),this.widget=e.widget,this.length=e.length,this.deco=e.deco,this.breakAfter=e.breakAfter,!0)}ignoreMutation(){return!0}ignoreEvent(e){return this.widget.ignoreEvent(e)}get isEditable(){return!1}get isWidget(){return!0}coordsAt(e,t){let n=this.widget.coordsAt(this.dom,e,t);return n||(this.widget instanceof Ta?null:To(this.dom.getBoundingClientRect(),this.length?0==e:t<=0))}destroy(){super.destroy(),this.dom&&this.widget.destroy(this.dom)}covers(e){let{startSide:t,endSide:n}=this.deco;return t!=n&&(e<0?t<0:n>0)}}class Ta extends ga{constructor(e){super(),this.height=e}toDOM(){let e=document.createElement('div');return e.className='cm-gap',this.updateDOM(e),e}eq(e){return e.height==this.height}updateDOM(e){return e.style.height=this.height+'px',!0}get editable(){return!0}get estimatedHeight(){return this.height}ignoreEvent(){return!1}}class Ia{constructor(e,t,n,s){this.doc=e,this.pos=t,this.end=n,this.disallowBlockEffectsFor=s,this.content=[],this.curLine=null,this.breakAtStart=0,this.pendingBuffer=0,this.bufferMarks=[],this.atCursorPos=!0,this.openStart=-1,this.openEnd=-1,this.text='',this.textOff=0,this.cursor=e.iter(),this.skip=t}posCovered(){if(0==this.content.length)return!this.breakAtStart&&this.doc.lineAt(this.pos).from!=this.pos;let e=this.content[this.content.length-1];return!(e.breakAfter||e instanceof Sa&&e.deco.endSide<0)}getLine(){return this.curLine||(this.content.push(this.curLine=new Oa),this.atCursorPos=!0),this.curLine}flushBuffer(e=this.bufferMarks){this.pendingBuffer&&(this.curLine.append(Ca(new aa(-1),e),e.length),this.pendingBuffer=0)}addBlockWidget(e){this.flushBuffer(),this.curLine=null,this.content.push(e)}finish(e){this.pendingBuffer&&e<=this.bufferMarks.length?this.flushBuffer():this.pendingBuffer=0,this.posCovered()||e&&this.content.length&&this.content[this.content.length-1]instanceof Sa||this.getLine()}buildText(e,t,n){for(;e>0;){if(this.textOff==this.text.length){let{value:t,lineBreak:n,done:s}=this.cursor.next(this.skip);if(this.skip=0,s)throw new Error('Ran out of text content when drawing inline views');if(n){this.posCovered()||this.getLine(),this.content.length?this.content[this.content.length-1].breakAfter=1:this.breakAtStart=1,this.flushBuffer(),this.curLine=null,this.atCursorPos=!0,e--;continue}this.text=t,this.textOff=0}let s=Math.min(this.text.length-this.textOff,e,512);this.flushBuffer(t.slice(t.length-n)),this.getLine().append(Ca(new ia(this.text.slice(this.textOff,this.textOff+s)),t),n),this.atCursorPos=!0,this.textOff+=s,e-=s,n=0}}span(e,t,n,s){this.buildText(t-e,n,s),this.pos=t,this.openStart<0&&(this.openStart=s)}point(e,t,n,s,i,r){if(this.disallowBlockEffectsFor[r]&&n instanceof _a){if(n.block)throw new RangeError('Block decorations may not be specified via plugins');if(t>this.doc.lineAt(this.pos).to)throw new RangeError('Decorations that replace line breaks may not be specified via plugins')}let o=t-e;if(n instanceof _a)if(n.block)n.startSide>0&&!this.posCovered()&&this.getLine(),this.addBlockWidget(new Sa(n.widget||$a.block,o,n));else{let r=oa.create(n.widget||$a.inline,o,o?0:n.startSide),a=this.atCursorPos&&!r.isEditable&&i<=s.length&&(e<t||n.startSide>0),l=!r.isEditable&&(e<t||i>s.length||n.startSide<=0),c=this.getLine();2!=this.pendingBuffer||a||r.isEditable||(this.pendingBuffer=0),this.flushBuffer(s),a&&(c.append(Ca(new aa(1),s),i),i=s.length+Math.max(0,i-s.length)),c.append(Ca(r,s),i),this.atCursorPos=l,this.pendingBuffer=l?e<t||i>s.length?1:2:0,this.pendingBuffer&&(this.bufferMarks=s.slice())}else this.doc.lineAt(this.pos).from==this.pos&&this.getLine().addLineDeco(n);o&&(this.textOff+o<=this.text.length?this.textOff+=o:(this.skip+=o-(this.text.length-this.textOff),this.text='',this.textOff=0),this.pos=t),this.openStart<0&&(this.openStart=i)}static build(e,t,n,s,i){let r=new Ia(e,t,n,i);return r.openEnd=jr.spans(s,t,n,r),r.openStart<0&&(r.openStart=r.openEnd),r.finish(r.openEnd),r}}function Ca(e,t){for(let n of t)e=new ra(n,[e],e.length);return e}class $a extends ga{constructor(e){super(),this.tag=e}eq(e){return e.tag==this.tag}toDOM(){return document.createElement(this.tag)}updateDOM(e){return e.nodeName.toLowerCase()==this.tag}get isHidden(){return!0}}$a.inline=new $a('span'),$a.block=new $a('div');var Aa=(e=>(e[e.LTR=0]='LTR',e[e.RTL=1]='RTL',e))(Aa||(Aa={}));const Ea=Aa.LTR,Pa=Aa.RTL;function Da(e){let t=[];for(let n=0;n<e.length;n++)t.push(1<<+e[n]);return t}const Ma=Da('88888888888888888888888888888888888666888888787833333333337888888000000000000000000000000008888880000000000000000000000000088888888888888888888888888888888888887866668888088888663380888308888800000000000000000000000800000000000000000000000000000008'),La=Da('4444448826627288999999999992222222222222222222222222222222222222222222222229999999999999999999994444444444644222822222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222999999949999999229989999223333333333'),Ba=Object.create(null),Na=[];for(let e of['()','[]','{}']){let t=e.charCodeAt(0),n=e.charCodeAt(1);Ba[t]=n,Ba[n]=-t}function Ra(e){return e<=247?Ma[e]:1424<=e&&e<=1524?2:1536<=e&&e<=1785?La[e-1536]:1774<=e&&e<=2220?4:8192<=e&&e<=8204?256:64336<=e&&e<=65023?4:1}const Fa=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac\ufb50-\ufdff]/;class Va{get dir(){return this.level%2?Pa:Ea}constructor(e,t,n){this.from=e,this.to=t,this.level=n}side(e,t){return this.dir==t==e?this.to:this.from}forward(e,t){return e==(this.dir==t)}static find(e,t,n,s){let i=-1;for(let r=0;r<e.length;r++){let o=e[r];if(o.from<=t&&o.to>=t){if(o.level==n)return r;(i<0||(0!=s?s<0?o.from<t:o.to>t:e[i].level>o.level))&&(i=r)}}if(i<0)throw new RangeError('Index out of range');return i}}function za(e,t){if(e.length!=t.length)return!1;for(let n=0;n<e.length;n++){let s=e[n],i=t[n];if(s.from!=i.from||s.to!=i.to||s.direction!=i.direction||!za(s.inner,i.inner))return!1}return!0}const Ua=[];function Wa(e,t,n,s,i,r,o){let a=s%2?2:1;if(s%2==i%2)for(let l=t,c=0;l<n;){let t=!0,h=!1;if(c==r.length||l<r[c].from){let e=Ua[l];e!=a&&(t=!1,h=16==e)}let u=t||1!=a?null:[],d=t?s:s+1,f=l;e:for(;;)if(c<r.length&&f==r[c].from){if(h)break e;let p=r[c];if(!t)for(let e=p.to,t=c+1;;){if(e==n)break e;if(!(t<r.length&&r[t].from==e)){if(Ua[e]==a)break e;break}e=r[t++].to}if(c++,u)u.push(p);else{p.from>l&&o.push(new Va(l,p.from,d)),Qa(e,p.direction==Ea!=!(d%2)?s+1:s,i,p.inner,p.from,p.to,o),l=p.to}f=p.to}else{if(f==n||(t?Ua[f]!=a:Ua[f]==a))break;f++}u?Wa(e,l,f,s+1,i,u,o):l<f&&o.push(new Va(l,f,d)),l=f}else for(let l=n,c=r.length;l>t;){let n=!0,h=!1;if(!c||l>r[c-1].to){let e=Ua[l-1];e!=a&&(n=!1,h=16==e)}let u=n||1!=a?null:[],d=n?s:s+1,f=l;e:for(;;)if(c&&f==r[c-1].to){if(h)break e;let p=r[--c];if(!n)for(let e=p.from,n=c;;){if(e==t)break e;if(!n||r[n-1].to!=e){if(Ua[e-1]==a)break e;break}e=r[--n].from}if(u)u.push(p);else{p.to<l&&o.push(new Va(p.to,l,d)),Qa(e,p.direction==Ea!=!(d%2)?s+1:s,i,p.inner,p.from,p.to,o),l=p.from}f=p.from}else{if(f==t||(n?Ua[f-1]!=a:Ua[f-1]==a))break;f--}u?Wa(e,f,l,s+1,i,u,o):f<l&&o.push(new Va(f,l,d)),l=f}}function Qa(e,t,n,s,i,r,o){let a=t%2?2:1;!function(e,t,n,s,i){for(let r=0;r<=s.length;r++){let o=r?s[r-1].to:t,a=r<s.length?s[r].from:n,l=r?256:i;for(let t=o,n=l,s=l;t<a;t++){let i=Ra(e.charCodeAt(t));512==i?i=n:8==i&&4==s&&(i=16),Ua[t]=4==i?2:i,7&i&&(s=i),n=i}for(let e=o,t=l,s=l;e<a;e++){let i=Ua[e];if(128==i)e<a-1&&t==Ua[e+1]&&24&t?i=Ua[e]=t:Ua[e]=256;else if(64==i){let i=e+1;for(;i<a&&64==Ua[i];)i++;let r=e&&8==t||i<n&&8==Ua[i]?1==s?1:8:256;for(let t=e;t<i;t++)Ua[t]=r;e=i-1}else 8==i&&1==s&&(Ua[e]=1);t=i,7&i&&(s=i)}}}(e,i,r,s,a),function(e,t,n,s,i){let r=1==i?2:1;for(let o=0,a=0,l=0;o<=s.length;o++){let c=o?s[o-1].to:t,h=o<s.length?s[o].from:n;for(let t,n,s,o=c;o<h;o++)if(n=Ba[t=e.charCodeAt(o)])if(n<0){for(let e=a-3;e>=0;e-=3)if(Na[e+1]==-n){let t=Na[e+2],n=2&t?i:4&t?1&t?r:i:0;n&&(Ua[o]=Ua[Na[e]]=n),a=e;break}}else{if(189==Na.length)break;Na[a++]=o,Na[a++]=t,Na[a++]=l}else if(2==(s=Ua[o])||1==s){let e=s==i;l=e?0:1;for(let t=a-3;t>=0;t-=3){let n=Na[t+2];if(2&n)break;if(e)Na[t+2]|=2;else{if(4&n)break;Na[t+2]|=4}}}}}(e,i,r,s,a),function(e,t,n,s){for(let i=0,r=s;i<=n.length;i++){let o=i?n[i-1].to:e,a=i<n.length?n[i].from:t;for(let l=o;l<a;){let o=Ua[l];if(256==o){let o=l+1;for(;;)if(o==a){if(i==n.length)break;o=n[i++].to,a=i<n.length?n[i].from:t}else{if(256!=Ua[o])break;o++}let c=1==r,h=c==(1==(o<t?Ua[o]:s))?c?1:2:s;for(let t=o,s=i,r=s?n[s-1].to:e;t>l;)t==r&&(t=n[--s].from,r=s?n[s-1].to:e),Ua[--t]=h;l=o}else r=o,l++}}}(i,r,s,a),Wa(e,i,r,t,n,s,o)}function ja(e){return[new Va(0,e,0)]}let Xa='';function Ga(e,t,n,s,i){var r;let o=s.head-e.from,a=Va.find(t,o,null!==(r=s.bidiLevel)&&void 0!==r?r:-1,s.assoc),l=t[a],c=l.side(i,n);if(o==c){let e=a+=i?1:-1;if(e<0||e>=t.length)return null;l=t[a=e],o=l.side(!i,n),c=l.side(i,n)}let h=Di(e.text,o,l.forward(i,n));(h<l.from||h>l.to)&&(h=c),Xa=e.text.slice(Math.min(o,h),Math.max(o,h));let u=a==(i?t.length-1:0)?null:t[a+(i?1:-1)];return u&&h==c&&u.level+(i?0:1)<l.level?qi.cursor(u.side(!i,n)+e.from,u.forward(i,n)?1:-1,u.level):qi.cursor(h+e.from,l.forward(i,n)?-1:1,l.level)}function qa(e,t,n){for(let s=t;s<n;s++){let t=Ra(e.charCodeAt(s));if(1==t)return Ea;if(2==t||4==t)return Pa}return Ea}const Ha=Ki.define(),Ya=Ki.define(),Ka=Ki.define(),Za=Ki.define(),Ja=Ki.define(),el=Ki.define(),tl=Ki.define(),nl=Ki.define(),sl=Ki.define(),il=Ki.define({combine:e=>e.some((e=>e))}),rl=Ki.define({combine:e=>e.some((e=>e))}),ol=Ki.define();class al{constructor(e,t='nearest',n='nearest',s=5,i=5,r=!1){this.range=e,this.y=t,this.x=n,this.yMargin=s,this.xMargin=i,this.isSnapshot=r}map(e){return e.empty?this:new al(this.range.map(e),this.y,this.x,this.yMargin,this.xMargin,this.isSnapshot)}clip(e){return this.range.to<=e.doc.length?this:new al(qi.cursor(e.doc.length),this.y,this.x,this.yMargin,this.xMargin,this.isSnapshot)}}const ll=Ir.define({map:(e,t)=>e.map(t)}),cl=Ir.define();function hl(e,t,n){let s=e.facet(Za);s.length?s[0](t):window.onerror?window.onerror(String(t),n,void 0,void 0,t):n?console.error(n+':',t):console.error(t)}const ul=Ki.define({combine:e=>!e.length||e[0]});let dl=0;const fl=Ki.define();class pl{constructor(e,t,n,s,i){this.id=e,this.create=t,this.domEventHandlers=n,this.domEventObservers=s,this.extension=i(this)}static define(e,t){const{eventHandlers:n,eventObservers:s,provide:i,decorations:r}=t||{};return new pl(dl++,e,n,s,(e=>{let t=[fl.of(e)];return r&&t.push(xl.of((t=>{let n=t.plugin(e);return n?r(n):xa.none}))),i&&t.push(i(e)),t}))}static fromClass(e,t){return pl.define((t=>new e(t)),t)}}class ml{constructor(e){this.spec=e,this.mustUpdate=null,this.value=null}update(e){if(this.value){if(this.mustUpdate){let e=this.mustUpdate;if(this.mustUpdate=null,this.value.update)try{this.value.update(e)}catch(t){if(hl(e.state,t,'CodeMirror plugin crashed'),this.value.destroy)try{this.value.destroy()}catch(e){}this.deactivate()}}}else if(this.spec)try{this.value=this.spec.create(e)}catch(t){hl(e.state,t,'CodeMirror plugin crashed'),this.deactivate()}return this}destroy(e){var t;if(null===(t=this.value)||void 0===t?void 0:t.destroy)try{this.value.destroy()}catch(t){hl(e.state,t,'CodeMirror plugin crashed')}}deactivate(){this.spec=this.value=null}}const gl=Ki.define(),vl=Ki.define(),xl=Ki.define(),bl=Ki.define(),yl=Ki.define(),_l=Ki.define();function wl(e,t){let n=e.state.facet(_l);if(!n.length)return n;let s=n.map((t=>t instanceof Function?t(e):t)),i=[];return jr.spans(s,t.from,t.to,{point(){},span(e,n,s,r){let o=e-t.from,a=n-t.from,l=i;for(let e=s.length-1;e>=0;e--,r--){let n,i=s[e].spec.bidiIsolate;if(null==i&&(i=qa(t.text,o,a)),r>0&&l.length&&(n=l[l.length-1]).to==o&&n.direction==i)n.to=a,l=n.inner;else{let e={from:o,to:a,direction:i,inner:[]};l.push(e),l=e.inner}}}}),i}const kl=Ki.define();function Ol(e){let t=0,n=0,s=0,i=0;for(let r of e.state.facet(kl)){let o=r(e);o&&(null!=o.left&&(t=Math.max(t,o.left)),null!=o.right&&(n=Math.max(n,o.right)),null!=o.top&&(s=Math.max(s,o.top)),null!=o.bottom&&(i=Math.max(i,o.bottom)))}return{left:t,right:n,top:s,bottom:i}}const Sl=Ki.define();class Tl{constructor(e,t,n,s){this.fromA=e,this.toA=t,this.fromB=n,this.toB=s}join(e){return new Tl(Math.min(this.fromA,e.fromA),Math.max(this.toA,e.toA),Math.min(this.fromB,e.fromB),Math.max(this.toB,e.toB))}addToSet(e){let t=e.length,n=this;for(;t>0;t--){let s=e[t-1];if(!(s.fromA>n.toA)){if(s.toA<n.fromA)break;n=n.join(s),e.splice(t-1,1)}}return e.splice(t,0,n),e}static extendWithRanges(e,t){if(0==t.length)return e;let n=[];for(let s=0,i=0,r=0,o=0;;s++){let a=s==e.length?null:e[s],l=r-o,c=a?a.fromB:1e9;for(;i<t.length&&t[i]<c;){let e=t[i],s=t[i+1],r=Math.max(o,e),a=Math.min(c,s);if(r<=a&&new Tl(r+l,a+l,r,a).addToSet(n),s>c)break;i+=2}if(!a)return n;new Tl(a.fromA,a.toA,a.fromB,a.toB).addToSet(n),r=a.toA,o=a.toB}}}class Il{constructor(e,t,n){this.view=e,this.state=t,this.transactions=n,this.flags=0,this.startState=e.state,this.changes=Vi.empty(this.startState.doc.length);for(let e of n)this.changes=this.changes.compose(e.changes);let s=[];this.changes.iterChangedRanges(((e,t,n,i)=>s.push(new Tl(e,t,n,i)))),this.changedRanges=s}static create(e,t,n){return new Il(e,t,n)}get viewportChanged(){return(4&this.flags)>0}get viewportMoved(){return(8&this.flags)>0}get heightChanged(){return(2&this.flags)>0}get geometryChanged(){return this.docChanged||(18&this.flags)>0}get focusChanged(){return(1&this.flags)>0}get docChanged(){return!this.changes.empty}get selectionSet(){return this.transactions.some((e=>e.selection))}get empty(){return 0==this.flags&&0==this.transactions.length}}class Cl extends zo{get length(){return this.view.state.doc.length}constructor(e){super(),this.view=e,this.decorations=[],this.dynamicDecorationMap=[!1],this.domChanged=null,this.hasComposition=null,this.markedForComposition=new Set,this.editContextFormatting=xa.none,this.lastCompositionAfterCursor=!1,this.minWidth=0,this.minWidthFrom=0,this.minWidthTo=0,this.impreciseAnchor=null,this.impreciseHead=null,this.forceSelection=!1,this.lastUpdate=Date.now(),this.setDOM(e.contentDOM),this.children=[new Oa],this.children[0].setParent(this),this.updateDeco(),this.updateInner([new Tl(0,0,0,e.state.doc.length)],0,null)}update(e){var t;let n=e.changedRanges;this.minWidth>0&&n.length&&(n.every((({fromA:e,toA:t})=>t<this.minWidthFrom||e>this.minWidthTo))?(this.minWidthFrom=e.changes.mapPos(this.minWidthFrom,1),this.minWidthTo=e.changes.mapPos(this.minWidthTo,1)):this.minWidth=this.minWidthFrom=this.minWidthTo=0),this.updateEditContextFormatting(e);let s=-1;this.view.inputState.composing>=0&&!this.view.observer.editContext&&((null===(t=this.domChanged)||void 0===t?void 0:t.newSel)?s=this.domChanged.newSel.head:function(e,t){let n=!1;t&&e.iterChangedRanges(((e,s)=>{e<t.to&&s>t.from&&(n=!0)}));return n}(e.changes,this.hasComposition)||e.selectionSet||(s=e.state.selection.main.head));let i=s>-1?function(e,t,n){let s=$l(e,n);if(!s)return null;let{node:i,from:r,to:o}=s,a=i.nodeValue;if(/[\n\r]/.test(a))return null;if(e.state.doc.sliceString(s.from,s.to)!=a)return null;let l=t.invertedDesc,c=new Tl(l.mapPos(r),l.mapPos(o),r,o),h=[];for(let t=i.parentNode;;t=t.parentNode){let n=zo.get(t);if(n instanceof ra)h.push({node:t,deco:n.mark});else{if(n instanceof Oa||'DIV'==t.nodeName&&t.parentNode==e.contentDOM)return{range:c,text:i,marks:h,line:t};if(t==e.contentDOM)return null;h.push({node:t,deco:new ba({inclusive:!0,attributes:ma(t),tagName:t.tagName.toLowerCase()})})}}}(this.view,e.changes,s):null;if(this.domChanged=null,this.hasComposition){this.markedForComposition.clear();let{from:t,to:s}=this.hasComposition;n=new Tl(t,s,e.changes.mapPos(t,-1),e.changes.mapPos(s,1)).addToSet(n.slice())}this.hasComposition=i?{from:i.range.fromB,to:i.range.toB}:null,(sa.ie||sa.chrome)&&!i&&e&&e.state.doc.lines!=e.startState.doc.lines&&(this.forceSelection=!0);let r=function(e,t,n){let s=new Al;return jr.compare(e,t,n,s),s.changes}(this.decorations,this.updateDeco(),e.changes);return n=Tl.extendWithRanges(n,r),!!(7&this.flags||0!=n.length)&&(this.updateInner(n,e.startState.doc.length,i),e.transactions.length&&(this.lastUpdate=Date.now()),!0)}updateInner(e,t,n){this.view.viewState.mustMeasureContent=!0,this.updateChildren(e,t,n);let{observer:s}=this.view;s.ignore((()=>{this.dom.style.height=this.view.viewState.contentHeight/this.view.scaleY+'px',this.dom.style.flexBasis=this.minWidth?this.minWidth+'px':'';let e=sa.chrome||sa.ios?{node:s.selectionRange.focusNode,written:!1}:void 0;this.sync(this.view,e),this.flags&=-8,e&&(e.written||s.selectionRange.focusNode!=e.node)&&(this.forceSelection=!0),this.dom.style.height=''})),this.markedForComposition.forEach((e=>e.flags&=-9));let i=[];if(this.view.viewport.from||this.view.viewport.to<this.view.state.doc.length)for(let e of this.children)e instanceof Sa&&e.widget instanceof Ta&&i.push(e.dom);s.updateGaps(i)}updateChildren(e,t,n){let s=n?n.range.addToSet(e.slice()):e,i=this.childCursor(t);for(let e=s.length-1;;e--){let t=e>=0?s[e]:null;if(!t)break;let r,o,a,l,{fromA:c,toA:h,fromB:u,toB:d}=t;if(n&&n.range.fromB<d&&n.range.toB>u){let e=Ia.build(this.view.state.doc,u,n.range.fromB,this.decorations,this.dynamicDecorationMap),t=Ia.build(this.view.state.doc,n.range.toB,d,this.decorations,this.dynamicDecorationMap);o=e.breakAtStart,a=e.openStart,l=t.openEnd;let s=this.compositionView(n);t.breakAtStart?s.breakAfter=1:t.content.length&&s.merge(s.length,s.length,t.content[0],!1,t.openStart,0)&&(s.breakAfter=t.content[0].breakAfter,t.content.shift()),e.content.length&&s.merge(0,0,e.content[e.content.length-1],!0,0,e.openEnd)&&e.content.pop(),r=e.content.concat(s).concat(t.content)}else({content:r,breakAtStart:o,openStart:a,openEnd:l}=Ia.build(this.view.state.doc,u,d,this.decorations,this.dynamicDecorationMap));let{i:f,off:p}=i.findPos(h,1),{i:m,off:g}=i.findPos(c,-1);Qo(this,m,g,f,p,r,o,a,l)}n&&this.fixCompositionDOM(n)}updateEditContextFormatting(e){this.editContextFormatting=this.editContextFormatting.map(e.changes);for(let t of e.transactions)for(let e of t.effects)e.is(cl)&&(this.editContextFormatting=e.value)}compositionView(e){let t=new ia(e.text.nodeValue);t.flags|=8;for(let{deco:n}of e.marks)t=new ra(n,[t],t.length);let n=new Oa;return n.append(t,0),n}fixCompositionDOM(e){let t=(e,t)=>{t.flags|=8|(t.children.some((e=>7&e.flags))?1:0),this.markedForComposition.add(t);let n=zo.get(e);n&&n!=t&&(n.dom=null),t.setDOM(e)},n=this.childPos(e.range.fromB,1),s=this.children[n.i];t(e.line,s);for(let i=e.marks.length-1;i>=-1;i--)n=s.childPos(n.off,1),s=s.children[n.i],t(i>=0?e.marks[i].node:e.text,s)}updateSelection(e=!1,t=!1){!e&&this.view.observer.selectionRange.focusNode||this.view.observer.readSelectionRange();let n=this.view.root.activeElement,s=n==this.dom,i=!s&&!(this.view.state.facet(ul)||this.dom.tabIndex>-1)&&bo(this.dom,this.view.observer.selectionRange)&&!(n&&this.dom.contains(n));if(!(s||t||i))return;let r=this.forceSelection;this.forceSelection=!1;let o=this.view.state.selection.main,a=this.moveToLine(this.domAtPos(o.anchor)),l=o.empty?a:this.moveToLine(this.domAtPos(o.head));if(sa.gecko&&o.empty&&!this.hasComposition&&(1==(c=a).node.nodeType&&c.node.firstChild&&(0==c.offset||'false'==c.node.childNodes[c.offset-1].contentEditable)&&(c.offset==c.node.childNodes.length||'false'==c.node.childNodes[c.offset].contentEditable))){let e=document.createTextNode('');this.view.observer.ignore((()=>a.node.insertBefore(e,a.node.childNodes[a.offset]||null))),a=l=new Fo(e,0),r=!0}var c;let h=this.view.observer.selectionRange;!r&&h.focusNode&&(_o(a.node,a.offset,h.anchorNode,h.anchorOffset)&&_o(l.node,l.offset,h.focusNode,h.focusOffset)||this.suppressWidgetCursorChange(h,o))||(this.view.observer.ignore((()=>{sa.android&&sa.chrome&&this.dom.contains(h.focusNode)&&function(e,t){for(let n=e;n&&n!=t;n=n.assignedSlot||n.parentNode)if(1==n.nodeType&&'false'==n.contentEditable)return!0;return!1}(h.focusNode,this.dom)&&(this.dom.blur(),this.dom.focus({preventScroll:!0}));let e=vo(this.view.root);if(e)if(o.empty){if(sa.gecko){let e=(t=a.node,s=a.offset,1!=t.nodeType?0:(s&&'false'==t.childNodes[s-1].contentEditable?1:0)|(s<t.childNodes.length&&'false'==t.childNodes[s].contentEditable?2:0));if(e&&3!=e){let t=(1==e?No:Ro)(a.node,a.offset);t&&(a=new Fo(t.node,t.offset))}}e.collapse(a.node,a.offset),null!=o.bidiLevel&&void 0!==e.caretBidiLevel&&(e.caretBidiLevel=o.bidiLevel)}else if(e.extend){e.collapse(a.node,a.offset);try{e.extend(l.node,l.offset)}catch(e){}}else{let t=document.createRange();o.anchor>o.head&&([a,l]=[l,a]),t.setEnd(l.node,l.offset),t.setStart(a.node,a.offset),e.removeAllRanges(),e.addRange(t)}else;var t,s;i&&this.view.root.activeElement==this.dom&&(this.dom.blur(),n&&n.focus())})),this.view.observer.setSelectionRange(a,l)),this.impreciseAnchor=a.precise?null:new Fo(h.anchorNode,h.anchorOffset),this.impreciseHead=l.precise?null:new Fo(h.focusNode,h.focusOffset)}suppressWidgetCursorChange(e,t){return this.hasComposition&&t.empty&&_o(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset)&&this.posFromDOM(e.focusNode,e.focusOffset)==t.head}enforceCursorAssoc(){if(this.hasComposition)return;let{view:e}=this,t=e.state.selection.main,n=vo(e.root),{anchorNode:s,anchorOffset:i}=e.observer.selectionRange;if(!(n&&t.empty&&t.assoc&&n.modify))return;let r=Oa.find(this,t.head);if(!r)return;let o=r.posAtStart;if(t.head==o||t.head==o+r.length)return;let a=this.coordsAt(t.head,-1),l=this.coordsAt(t.head,1);if(!a||!l||a.bottom>l.top)return;let c=this.domAtPos(t.head+t.assoc);n.collapse(c.node,c.offset),n.modify('move',t.assoc<0?'forward':'backward','lineboundary'),e.observer.readSelectionRange();let h=e.observer.selectionRange;e.docView.posFromDOM(h.anchorNode,h.anchorOffset)!=t.from&&n.collapse(s,i)}moveToLine(e){let t,n=this.dom;if(e.node!=n)return e;for(let s=e.offset;!t&&s<n.childNodes.length;s++){let e=zo.get(n.childNodes[s]);e instanceof Oa&&(t=e.domAtPos(0))}for(let s=e.offset-1;!t&&s>=0;s--){let e=zo.get(n.childNodes[s]);e instanceof Oa&&(t=e.domAtPos(e.length))}return t?new Fo(t.node,t.offset,!0):e}nearest(e){for(let t=e;t;){let e=zo.get(t);if(e&&e.rootView==this)return e;t=t.parentNode}return null}posFromDOM(e,t){let n=this.nearest(e);if(!n)throw new RangeError('Trying to find position for a DOM position outside of the document');return n.localPosFromDOM(e,t)+n.posAtStart}domAtPos(e){let{i:t,off:n}=this.childCursor().findPos(e,-1);for(;t<this.children.length-1;){let e=this.children[t];if(n<e.length||e instanceof Oa)break;t++,n=0}return this.children[t].domAtPos(n)}coordsAt(e,t){let n=null,s=0;for(let i=this.length,r=this.children.length-1;r>=0;r--){let o=this.children[r],a=i-o.breakAfter,l=a-o.length;if(a<e)break;if(l<=e&&(l<e||o.covers(-1))&&(a>e||o.covers(1))&&(!n||o instanceof Oa&&!(n instanceof Oa&&t>=0)))n=o,s=l;else if(n&&l==e&&a==e&&o instanceof Sa&&Math.abs(t)<2){if(o.deco.startSide<0)break;r&&(n=null)}i=l}return n?n.coordsAt(e-s,t):null}coordsForChar(e){let{i:t,off:n}=this.childPos(e,1),s=this.children[t];if(!(s instanceof Oa))return null;for(;s.children.length;){let{i:e,off:t}=s.childPos(n,1);for(;;e++){if(e==s.children.length)return null;if((s=s.children[e]).length)break}n=t}if(!(s instanceof ia))return null;let i=Di(s.text,n);if(i==n)return null;let r=Do(s.dom,n,i).getClientRects();for(let e=0;e<r.length;e++){let t=r[e];if(e==r.length-1||t.top<t.bottom&&t.left<t.right)return t}return null}measureVisibleLineHeights(e){let t=[],{from:n,to:s}=e,i=this.view.contentDOM.clientWidth,r=i>Math.max(this.view.scrollDOM.clientWidth,this.minWidth)+1,o=-1,a=this.view.textDirection==Aa.LTR;for(let e=0,l=0;l<this.children.length;l++){let c=this.children[l],h=e+c.length;if(h>s)break;if(e>=n){let n=c.dom.getBoundingClientRect();if(t.push(n.height),r){let t=c.dom.lastChild,s=t?yo(t):[];if(s.length){let t=s[s.length-1],r=a?t.right-n.left:n.right-t.left;r>o&&(o=r,this.minWidth=i,this.minWidthFrom=e,this.minWidthTo=h)}}}e=h+c.breakAfter}return t}textDirectionAt(e){let{i:t}=this.childPos(e,1);return'rtl'==getComputedStyle(this.children[t].dom).direction?Aa.RTL:Aa.LTR}measureTextSize(){for(let e of this.children)if(e instanceof Oa){let t=e.measureTextSize();if(t)return t}let e,t,n,s=document.createElement('div');return s.className='cm-line',s.style.width='99999px',s.style.position='absolute',s.textContent='abc def ghi jkl mno pqr stu',this.view.observer.ignore((()=>{this.dom.appendChild(s);let i=yo(s.firstChild)[0];e=s.getBoundingClientRect().height,t=i?i.width/27:7,n=i?i.height:e,s.remove()})),{lineHeight:e,charWidth:t,textHeight:n}}childCursor(e=this.length){let t=this.children.length;return t&&(e-=this.children[--t].length),new Wo(this.children,e,t)}computeBlockGapDeco(){let e=[],t=this.view.viewState;for(let n=0,s=0;;s++){let i=s==t.viewports.length?null:t.viewports[s],r=i?i.from-1:this.length;if(r>n){let s=(t.lineBlockAt(r).bottom-t.lineBlockAt(n).top)/this.view.scaleY;e.push(xa.replace({widget:new Ta(s),block:!0,inclusive:!0,isBlockGap:!0}).range(n,r))}if(!i)break;n=i.to+1}return xa.set(e)}updateDeco(){let e=1,t=this.view.state.facet(xl).map((t=>(this.dynamicDecorationMap[e++]='function'==typeof t)?t(this.view):t)),n=!1,s=this.view.state.facet(bl).map(((e,t)=>{let s='function'==typeof e;return s&&(n=!0),s?e(this.view):e}));for(s.length&&(this.dynamicDecorationMap[e++]=n,t.push(jr.join(s))),this.decorations=[this.editContextFormatting,...t,this.computeBlockGapDeco(),this.view.viewState.lineGapDeco];e<this.decorations.length;)this.dynamicDecorationMap[e++]=!1;return this.decorations}scrollIntoView(e){if(e.isSnapshot){let t=this.view.viewState.lineBlockAt(e.range.head);return this.view.scrollDOM.scrollTop=t.top-e.yMargin,void(this.view.scrollDOM.scrollLeft=e.xMargin)}for(let t of this.view.state.facet(ol))try{if(t(this.view,e.range,e))return!0}catch(e){hl(this.view.state,e,'scroll handler')}let t,{range:n}=e,s=this.coordsAt(n.head,n.empty?n.assoc:n.head>n.anchor?-1:1);if(!s)return;!n.empty&&(t=this.coordsAt(n.anchor,n.anchor>n.head?-1:1))&&(s={left:Math.min(s.left,t.left),top:Math.min(s.top,t.top),right:Math.max(s.right,t.right),bottom:Math.max(s.bottom,t.bottom)});let i=Ol(this.view),r={left:s.left-i.left,top:s.top-i.top,right:s.right+i.right,bottom:s.bottom+i.bottom},{offsetWidth:o,offsetHeight:a}=this.view.scrollDOM;!function(e,t,n,s,i,r,o,a){let l=e.ownerDocument,c=l.defaultView||window;for(let h=e,u=!1;h&&!u;)if(1==h.nodeType){let e,d=h==l.body,f=1,p=1;if(d)e=Io(c);else{if(/^(fixed|sticky)$/.test(getComputedStyle(h).position)&&(u=!0),h.scrollHeight<=h.clientHeight&&h.scrollWidth<=h.clientWidth){h=h.assignedSlot||h.parentNode;continue}let t=h.getBoundingClientRect();({scaleX:f,scaleY:p}=Co(h,t)),e={left:t.left,right:t.left+h.clientWidth*f,top:t.top,bottom:t.top+h.clientHeight*p}}let m=0,g=0;if('nearest'==i)t.top<e.top?(g=-(e.top-t.top+o),n>0&&t.bottom>e.bottom+g&&(g=t.bottom-e.bottom+g+o)):t.bottom>e.bottom&&(g=t.bottom-e.bottom+o,n<0&&t.top-g<e.top&&(g=-(e.top+g-t.top+o)));else{let s=t.bottom-t.top,r=e.bottom-e.top;g=('center'==i&&s<=r?t.top+s/2-r/2:'start'==i||'center'==i&&n<0?t.top-o:t.bottom-r+o)-e.top}if('nearest'==s?t.left<e.left?(m=-(e.left-t.left+r),n>0&&t.right>e.right+m&&(m=t.right-e.right+m+r)):t.right>e.right&&(m=t.right-e.right+r,n<0&&t.left<e.left+m&&(m=-(e.left+m-t.left+r))):m=('center'==s?t.left+(t.right-t.left)/2-(e.right-e.left)/2:'start'==s==a?t.left-r:t.right-(e.right-e.left)+r)-e.left,m||g)if(d)c.scrollBy(m,g);else{let e=0,n=0;if(g){let e=h.scrollTop;h.scrollTop+=g/p,n=(h.scrollTop-e)*p}if(m){let t=h.scrollLeft;h.scrollLeft+=m/f,e=(h.scrollLeft-t)*f}t={left:t.left-e,top:t.top-n,right:t.right-e,bottom:t.bottom-n},e&&Math.abs(e-m)<1&&(s='nearest'),n&&Math.abs(n-g)<1&&(i='nearest')}if(d)break;h=h.assignedSlot||h.parentNode}else{if(11!=h.nodeType)break;h=h.host}}(this.view.scrollDOM,r,n.head<n.anchor?-1:1,e.x,e.y,Math.max(Math.min(e.xMargin,o),-o),Math.max(Math.min(e.yMargin,a),-a),this.view.textDirection==Aa.LTR)}}function $l(e,t){let n=e.observer.selectionRange;if(!n.focusNode)return null;let s=No(n.focusNode,n.focusOffset),i=Ro(n.focusNode,n.focusOffset),r=s||i;if(i&&s&&i.node!=s.node){let t=zo.get(i.node);if(!t||t instanceof ia&&t.text!=i.node.nodeValue)r=i;else if(e.docView.lastCompositionAfterCursor){let e=zo.get(s.node);!e||e instanceof ia&&e.text!=s.node.nodeValue||(r=i)}}if(e.docView.lastCompositionAfterCursor=r!=s,!r)return null;let o=t-r.offset;return{from:o,to:o+r.node.nodeValue.length,node:r.node}}let Al=class e{constructor(){this.changes=[]}compareRange(e,t){ka(e,t,this.changes)}comparePoint(e,t){ka(e,t,this.changes)}boundChange(e){ka(e,e,this.changes)}};function El(e,t){return t.left>e?t.left-e:Math.max(0,e-t.right)}function Pl(e,t){return t.top>e?t.top-e:Math.max(0,e-t.bottom)}function Dl(e,t){return e.top<t.bottom-1&&e.bottom>t.top+1}function Ml(e,t){return t<e.top?{top:t,left:e.left,right:e.right,bottom:e.bottom}:e}function Ll(e,t){return t>e.bottom?{top:e.top,left:e.left,right:e.right,bottom:t}:e}function Bl(e,t,n){let s,i,r,o,a,l,c,h,u=!1;for(let d=e.firstChild;d;d=d.nextSibling){let e=yo(d);for(let f=0;f<e.length;f++){let p=e[f];i&&Dl(i,p)&&(p=Ml(Ll(p,i.bottom),i.top));let m=El(t,p),g=Pl(n,p);if(0==m&&0==g)return 3==d.nodeType?Nl(d,t,n):Bl(d,t,n);if(!s||o>g||o==g&&r>m){s=d,i=p,r=m,o=g;let a=g?n<p.top?-1:1:m?t<p.left?-1:1:0;u=!a||(a>0?f<e.length-1:f>0)}0==m?n>p.bottom&&(!c||c.bottom<p.bottom)?(a=d,c=p):n<p.top&&(!h||h.top>p.top)&&(l=d,h=p):c&&Dl(c,p)?c=Ll(c,p.bottom):h&&Dl(h,p)&&(h=Ml(h,p.top))}}if(c&&c.bottom>=n?(s=a,i=c):h&&h.top<=n&&(s=l,i=h),!s)return{node:e,offset:0};let d=Math.max(i.left,Math.min(i.right,t));return 3==s.nodeType?Nl(s,d,n):u&&'false'!=s.contentEditable?Bl(s,d,n):{node:e,offset:Array.prototype.indexOf.call(e.childNodes,s)+(t>=(i.left+i.right)/2?1:0)}}function Nl(e,t,n){let s=e.nodeValue.length,i=-1,r=1e9,o=0;for(let a=0;a<s;a++){let s=Do(e,a,a+1).getClientRects();for(let l=0;l<s.length;l++){let c=s[l];if(c.top==c.bottom)continue;o||(o=t-c.left);let h=(c.top>n?c.top-n:n-c.bottom)-1;if(c.left-1<=t&&c.right+1>=t&&h<r){let n=t>=(c.left+c.right)/2,s=n;if(sa.chrome||sa.gecko){Do(e,a).getBoundingClientRect().left==c.right&&(s=!n)}if(h<=0)return{node:e,offset:a+(s?1:0)};i=a+(s?1:0),r=h}}}return{node:e,offset:i>-1?i:o>0?e.nodeValue.length:0}}function Rl(e,t,n,s=-1){var i,r;let o,a=e.contentDOM.getBoundingClientRect(),l=a.top+e.viewState.paddingTop,{docHeight:c}=e.viewState,{x:h,y:u}=t,d=u-l;if(d<0)return 0;if(d>c)return e.state.doc.length;for(let t=e.viewState.heightOracle.textHeight/2,i=!1;o=e.elementAtHeight(d),o.type!=va.Text;)for(;d=s>0?o.bottom+t:o.top-t,!(d>=0&&d<=c);){if(i)return n?null:0;i=!0,s=-s}u=l+d;let f=o.from;if(f<e.viewport.from)return 0==e.viewport.from?0:n?null:Fl(e,a,o,h,u);if(f>e.viewport.to)return e.viewport.to==e.state.doc.length?e.state.doc.length:n?null:Fl(e,a,o,h,u);let p=e.dom.ownerDocument,m=e.root.elementFromPoint?e.root:p,g=m.elementFromPoint(h,u);g&&!e.contentDOM.contains(g)&&(g=null),g||(h=Math.max(a.left+1,Math.min(a.right-1,h)),g=m.elementFromPoint(h,u),g&&!e.contentDOM.contains(g)&&(g=null));let v,x=-1;if(g&&0!=(null===(i=e.docView.nearest(g))||void 0===i?void 0:i.isEditable)){if(p.caretPositionFromPoint){let e=p.caretPositionFromPoint(h,u);e&&({offsetNode:v,offset:x}=e)}else if(p.caretRangeFromPoint){let t=p.caretRangeFromPoint(h,u);t&&(({startContainer:v,startOffset:x}=t),(!e.contentDOM.contains(v)||sa.safari&&function(e,t,n){let s;if(3!=e.nodeType||t!=(s=e.nodeValue.length))return!1;for(let t=e.nextSibling;t;t=t.nextSibling)if(1!=t.nodeType||'BR'!=t.nodeName)return!1;return Do(e,s-1,s).getBoundingClientRect().left>n}(v,x,h)||sa.chrome&&function(e,t,n){if(0!=t)return!1;for(let t=e;;){let e=t.parentNode;if(!e||1!=e.nodeType||e.firstChild!=t)return!1;if(e.classList.contains('cm-line'))break;t=e}let s=1==e.nodeType?e.getBoundingClientRect():Do(e,0,Math.max(e.nodeValue.length,1)).getBoundingClientRect();return n-s.left>5}(v,x,h))&&(v=void 0))}v&&(x=Math.min(So(v),x))}if(!v||!e.docView.dom.contains(v)){let t=Oa.find(e.docView,f);if(!t)return d>o.top+o.height/2?o.to:o.from;({node:v,offset:x}=Bl(t.dom,h,u))}let b=e.docView.nearest(v);if(!b)return null;if(b.isWidget&&1==(null===(r=b.dom)||void 0===r?void 0:r.nodeType)){let e=b.dom.getBoundingClientRect();return t.y<e.top||t.y<=e.bottom&&t.x<=(e.left+e.right)/2?b.posAtStart:b.posAtEnd}return b.localPosFromDOM(v,x)+b.posAtStart}function Fl(e,t,n,s,i){let r=Math.round((s-t.left)*e.defaultCharacterWidth);if(e.lineWrapping&&n.height>1.5*e.defaultLineHeight){let t=e.viewState.heightOracle.textHeight;r+=Math.floor((i-n.top-.5*(e.defaultLineHeight-t))/t)*e.viewState.heightOracle.lineLength}let o=e.state.sliceDoc(n.from,n.to);return n.from+function(e,t,n,s){for(let s=0,i=0;;){if(i>=t)return s;if(s==e.length)break;i+=9==e.charCodeAt(s)?n-i%n:1,s=Di(e,s)}return!0===s?-1:e.length}(o,r,e.state.tabSize)}function Vl(e,t){let n=e.lineBlockAt(t);if(Array.isArray(n.type))for(let e of n.type)if(e.to>t||e.to==t&&(e.to==n.to||e.type==va.Text))return e;return n}function zl(e,t,n,s){let i=e.state.doc.lineAt(t.head),r=e.bidiSpans(i),o=e.textDirectionAt(i.from);for(let a=t,l=null;;){let t=Ga(i,r,o,a,n),c=Xa;if(!t){if(i.number==(n?e.state.doc.lines:1))return a;c='\n',i=e.state.doc.line(i.number+(n?1:-1)),r=e.bidiSpans(i),t=e.visualLineSide(i,!n)}if(l){if(!l(c))return a}else{if(!s)return t;l=s(c)}a=t}}function Ul(e,t,n){for(;;){let s=0;for(let i of e)i.between(t-1,t+1,((e,i,r)=>{if(t>e&&t<i){let r=s||n||(t-e<i-t?-1:1);t=r<0?e:i,s=r}}));if(!s)return t}}function Wl(e,t,n){let s=Ul(e.state.facet(yl).map((t=>t(e))),n.from,t.head>n.from?-1:1);return s==n.from?n:qi.cursor(s,s<n.from?1:-1)}const Ql='';class jl{constructor(e,t){this.points=e,this.text='',this.lineSeparator=t.facet(Fr.lineSeparator)}append(e){this.text+=e}lineBreak(){this.text+=Ql}readRange(e,t){if(!e)return this;let n=e.parentNode;for(let s=e;;){this.findPointBefore(n,s);let e=this.text.length;this.readNode(s);let i=s.nextSibling;if(i==t)break;let r=zo.get(s),o=zo.get(i);(r&&o?r.breakAfter:(r?r.breakAfter:ko(s))||ko(i)&&('BR'!=s.nodeName||s.cmIgnore)&&this.text.length>e)&&this.lineBreak(),s=i}return this.findPointBefore(n,t),this}readTextNode(e){let t=e.nodeValue;for(let n of this.points)n.node==e&&(n.pos=this.text.length+Math.min(n.offset,t.length));for(let n=0,s=this.lineSeparator?null:/\r\n?|\n/g;;){let i,r=-1,o=1;if(this.lineSeparator?(r=t.indexOf(this.lineSeparator,n),o=this.lineSeparator.length):(i=s.exec(t))&&(r=i.index,o=i[0].length),this.append(t.slice(n,r<0?t.length:r)),r<0)break;if(this.lineBreak(),o>1)for(let t of this.points)t.node==e&&t.pos>this.text.length&&(t.pos-=o-1);n=r+o}}readNode(e){if(e.cmIgnore)return;let t=zo.get(e),n=t&&t.overrideDOMText;if(null!=n){this.findPointInside(e,n.length);for(let e=n.iter();!e.next().done;)e.lineBreak?this.lineBreak():this.append(e.value)}else 3==e.nodeType?this.readTextNode(e):'BR'==e.nodeName?e.nextSibling&&this.lineBreak():1==e.nodeType&&this.readRange(e.firstChild,null)}findPointBefore(e,t){for(let n of this.points)n.node==e&&e.childNodes[n.offset]==t&&(n.pos=this.text.length)}findPointInside(e,t){for(let n of this.points)(3==e.nodeType?n.node==e:e.contains(n.node))&&(n.pos=this.text.length+(Xl(e,n.node,n.offset)?t:0))}}function Xl(e,t,n){for(;;){if(!t||n<So(t))return!1;if(t==e)return!0;n=wo(t)+1,t=t.parentNode}}class Gl{constructor(e,t){this.node=e,this.offset=t,this.pos=-1}}class ql{constructor(e,t,n,s){this.typeOver=s,this.bounds=null,this.text='',this.domChanged=t>-1;let{impreciseHead:i,impreciseAnchor:r}=e.docView;if(e.state.readOnly&&t>-1)this.newSel=null;else if(t>-1&&(this.bounds=e.docView.domBoundsAround(t,n,0))){let t=i||r?[]:function(e){let t=[];if(e.root.activeElement!=e.contentDOM)return t;let{anchorNode:n,anchorOffset:s,focusNode:i,focusOffset:r}=e.observer.selectionRange;n&&(t.push(new Gl(n,s)),i==n&&r==s||t.push(new Gl(i,r)));return t}(e),n=new jl(t,e.state);n.readRange(this.bounds.startDOM,this.bounds.endDOM),this.text=n.text,this.newSel=function(e,t){if(0==e.length)return null;let n=e[0].pos,s=2==e.length?e[1].pos:n;return n>-1&&s>-1?qi.single(n+t,s+t):null}(t,this.bounds.from)}else{let t=e.observer.selectionRange,n=i&&i.node==t.focusNode&&i.offset==t.focusOffset||!xo(e.contentDOM,t.focusNode)?e.state.selection.main.head:e.docView.posFromDOM(t.focusNode,t.focusOffset),s=r&&r.node==t.anchorNode&&r.offset==t.anchorOffset||!xo(e.contentDOM,t.anchorNode)?e.state.selection.main.anchor:e.docView.posFromDOM(t.anchorNode,t.anchorOffset),o=e.viewport;if((sa.ios||sa.chrome)&&e.state.selection.main.empty&&n!=s&&(o.from>0||o.to<e.state.doc.length)){let t=Math.min(n,s),i=Math.max(n,s),r=o.from-t,a=o.to-i;0!=r&&1!=r&&0!=t||0!=a&&-1!=a&&i!=e.state.doc.length||(n=0,s=e.state.doc.length)}this.newSel=qi.single(s,n)}}}function Hl(e,t){let n,{newSel:s}=t,i=e.state.selection.main,r=e.inputState.lastKeyTime>Date.now()-100?e.inputState.lastKeyCode:-1;if(t.bounds){let{from:s,to:o}=t.bounds,a=i.from,l=null;(8===r||sa.android&&t.text.length<o-s)&&(a=i.to,l='end');let c=function(e,t,n,s){let i=Math.min(e.length,t.length),r=0;for(;r<i&&e.charCodeAt(r)==t.charCodeAt(r);)r++;if(r==i&&e.length==t.length)return null;let o=e.length,a=t.length;for(;o>0&&a>0&&e.charCodeAt(o-1)==t.charCodeAt(a-1);)o--,a--;if('end'==s){n-=o+Math.max(0,r-Math.min(o,a))-r}if(o<r&&e.length<t.length){r-=n<=r&&n>=o?r-n:0,a=r+(a-o),o=r}else if(a<r){r-=n<=r&&n>=a?r-n:0,o=r+(o-a),a=r}return{from:r,toA:o,toB:a}}(e.state.doc.sliceString(s,o,Ql),t.text,a-s,l);c&&(sa.chrome&&13==r&&c.toB==c.from+2&&t.text.slice(c.from,c.toB)==Ql+Ql&&c.toB--,n={from:s+c.from,to:s+c.toA,insert:ki.of(t.text.slice(c.from,c.toB).split(Ql))})}else s&&(!e.hasFocus&&e.state.facet(ul)||s.main.eq(i))&&(s=null);if(!n&&!s)return!1;if(!n&&t.typeOver&&!i.empty&&s&&s.main.empty?n={from:i.from,to:i.to,insert:e.state.doc.slice(i.from,i.to)}:(sa.mac||sa.android)&&n&&n.from==n.to&&n.from==i.head-1&&/^\. ?$/.test(n.insert.toString())&&'off'==e.contentDOM.getAttribute('autocorrect')?(s&&2==n.insert.length&&(s=qi.single(s.main.anchor-1,s.main.head-1)),n={from:n.from,to:n.to,insert:ki.of([n.insert.toString().replace('.',' ')])}):n&&n.from>=i.from&&n.to<=i.to&&(n.from!=i.from||n.to!=i.to)&&i.to-i.from-(n.to-n.from)<=4?n={from:i.from,to:i.to,insert:e.state.doc.slice(i.from,n.from).append(n.insert).append(e.state.doc.slice(n.to,i.to))}:sa.chrome&&n&&n.from==n.to&&n.from==i.head&&'\n '==n.insert.toString()&&e.lineWrapping&&(s&&(s=qi.single(s.main.anchor-1,s.main.head-1)),n={from:i.from,to:i.to,insert:ki.of([' '])}),n)return Yl(e,n,s,r);if(s&&!s.main.eq(i)){let t=!1,n='select';return e.inputState.lastSelectionTime>Date.now()-50&&('select'==e.inputState.lastSelectionOrigin&&(t=!0),n=e.inputState.lastSelectionOrigin),e.dispatch({selection:s,scrollIntoView:t,userEvent:n}),!0}return!1}function Yl(e,t,n,s=-1){if(sa.ios&&e.inputState.flushIOSKey(t))return!0;let i=e.state.selection.main;if(sa.android&&(t.to==i.to&&(t.from==i.from||t.from==i.from-1&&' '==e.state.sliceDoc(t.from,i.from))&&1==t.insert.length&&2==t.insert.lines&&Mo(e.contentDOM,'Enter',13)||(t.from==i.from-1&&t.to==i.to&&0==t.insert.length||8==s&&t.insert.length<t.to-t.from&&t.to>i.head)&&Mo(e.contentDOM,'Backspace',8)||t.from==i.from&&t.to==i.to+1&&0==t.insert.length&&Mo(e.contentDOM,'Delete',46)))return!0;let r,o=t.insert.toString();e.inputState.composing>=0&&e.inputState.composing++;let a=()=>r||(r=function(e,t,n){let s,i=e.state,r=i.selection.main;if(t.from>=r.from&&t.to<=r.to&&t.to-t.from>=(r.to-r.from)/3&&(!n||n.main.empty&&n.main.from==t.from+t.insert.length)&&e.inputState.composing<0){let n=r.from<t.from?i.sliceDoc(r.from,t.from):'',o=r.to>t.to?i.sliceDoc(t.to,r.to):'';s=i.replaceSelection(e.state.toText(n+t.insert.sliceString(0,void 0,e.state.lineBreak)+o))}else{let o=i.changes(t),a=n&&n.main.to<=o.newLength?n.main:void 0;if(i.selection.ranges.length>1&&e.inputState.composing>=0&&t.to<=r.to&&t.to>=r.to-10){let l,c=e.state.sliceDoc(t.from,t.to),h=n&&$l(e,n.main.head);if(h){let e=t.insert.length-(t.to-t.from);l={from:h.from,to:h.to-e}}else l=e.state.doc.lineAt(r.head);let u=r.to-t.to,d=r.to-r.from;s=i.changeByRange((n=>{if(n.from==r.from&&n.to==r.to)return{changes:o,range:a||n.map(o)};let s=n.to-u,h=s-c.length;if(n.to-n.from!=d||e.state.sliceDoc(h,s)!=c||n.to>=l.from&&n.from<=l.to)return{range:n};let f=i.changes({from:h,to:s,insert:t.insert}),p=n.to-r.to;return{changes:f,range:a?qi.range(Math.max(0,a.anchor+p),Math.max(0,a.head+p)):n.map(f)}}))}else s={changes:o,selection:a&&i.selection.replaceRange(a)}}let o='input.type';(e.composing||e.inputState.compositionPendingChange&&e.inputState.compositionEndedAt>Date.now()-50)&&(e.inputState.compositionPendingChange=!1,o+='.compose',e.inputState.compositionFirstChange&&(o+='.start',e.inputState.compositionFirstChange=!1));return i.update(s,{userEvent:o,scrollIntoView:!0})}(e,t,n));return e.state.facet(el).some((n=>n(e,t.from,t.to,o,a)))||e.dispatch(a()),!0}class Kl{setSelectionOrigin(e){this.lastSelectionOrigin=e,this.lastSelectionTime=Date.now()}constructor(e){this.view=e,this.lastKeyCode=0,this.lastKeyTime=0,this.lastTouchTime=0,this.lastFocusTime=0,this.lastScrollTop=0,this.lastScrollLeft=0,this.pendingIOSKey=void 0,this.tabFocusMode=-1,this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastContextMenu=0,this.scrollHandlers=[],this.handlers=Object.create(null),this.composing=-1,this.compositionFirstChange=null,this.compositionEndedAt=0,this.compositionPendingKey=!1,this.compositionPendingChange=!1,this.mouseSelection=null,this.draggedContent=null,this.handleEvent=this.handleEvent.bind(this),this.notifiedFocused=e.hasFocus,sa.safari&&e.contentDOM.addEventListener('input',(()=>null)),sa.gecko&&function(e){Oc.has(e)||(Oc.add(e),e.addEventListener('copy',(()=>{})),e.addEventListener('cut',(()=>{})))}(e.contentDOM.ownerDocument)}handleEvent(e){(function(e,t){if(!t.bubbles)return!0;if(t.defaultPrevented)return!1;for(let n,s=t.target;s!=e.contentDOM;s=s.parentNode)if(!s||11==s.nodeType||(n=zo.get(s))&&n.ignoreEvent(t))return!1;return!0})(this.view,e)&&!this.ignoreDuringComposition(e)&&('keydown'==e.type&&this.keydown(e)||this.runHandlers(e.type,e))}runHandlers(e,t){let n=this.handlers[e];if(n){for(let e of n.observers)e(this.view,t);for(let e of n.handlers){if(t.defaultPrevented)break;if(e(this.view,t)){t.preventDefault();break}}}}ensureHandlers(e){let t=Jl(e),n=this.handlers,s=this.view.contentDOM;for(let e in t)if('scroll'!=e){let i=!t[e].handlers.length,r=n[e];r&&i!=!r.handlers.length&&(s.removeEventListener(e,this.handleEvent),r=null),r||s.addEventListener(e,this.handleEvent,{passive:i})}for(let e in n)'scroll'==e||t[e]||s.removeEventListener(e,this.handleEvent);this.handlers=t}keydown(e){if(this.lastKeyCode=e.keyCode,this.lastKeyTime=Date.now(),9==e.keyCode&&this.tabFocusMode>-1&&(!this.tabFocusMode||Date.now()<=this.tabFocusMode))return!0;if(this.tabFocusMode>0&&27!=e.keyCode&&nc.indexOf(e.keyCode)<0&&(this.tabFocusMode=-1),sa.android&&sa.chrome&&!e.synthetic&&(13==e.keyCode||8==e.keyCode))return this.view.observer.delayAndroidKey(e.key,e.keyCode),!0;let t;return!sa.ios||e.synthetic||e.altKey||e.metaKey||!((t=ec.find((t=>t.keyCode==e.keyCode)))&&!e.ctrlKey||tc.indexOf(e.key)>-1&&e.ctrlKey&&!e.shiftKey)?(229!=e.keyCode&&this.view.observer.forceFlush(),!1):(this.pendingIOSKey=t||e,setTimeout((()=>this.flushIOSKey()),250),!0)}flushIOSKey(e){let t=this.pendingIOSKey;return!!t&&(!('Enter'==t.key&&e&&e.from<e.to&&/^\S+$/.test(e.insert.toString()))&&(this.pendingIOSKey=void 0,Mo(this.view.contentDOM,t.key,t.keyCode,t instanceof KeyboardEvent?t:void 0)))}ignoreDuringComposition(e){return!!/^key/.test(e.type)&&(this.composing>0||!!(sa.safari&&!sa.ios&&this.compositionPendingKey&&Date.now()-this.compositionEndedAt<100)&&(this.compositionPendingKey=!1,!0))}startMouseSelection(e){this.mouseSelection&&this.mouseSelection.destroy(),this.mouseSelection=e}update(e){this.view.observer.update(e),this.mouseSelection&&this.mouseSelection.update(e),this.draggedContent&&e.docChanged&&(this.draggedContent=this.draggedContent.map(e.changes)),e.transactions.length&&(this.lastKeyCode=this.lastSelectionTime=0)}destroy(){this.mouseSelection&&this.mouseSelection.destroy()}}function Zl(e,t){return(n,s)=>{try{return t.call(e,s,n)}catch(e){hl(n.state,e)}}}function Jl(e){let t=Object.create(null);function n(e){return t[e]||(t[e]={observers:[],handlers:[]})}for(let t of e){let e=t.spec;if(e&&e.domEventHandlers)for(let s in e.domEventHandlers){let i=e.domEventHandlers[s];i&&n(s).handlers.push(Zl(t.value,i))}if(e&&e.domEventObservers)for(let s in e.domEventObservers){let i=e.domEventObservers[s];i&&n(s).observers.push(Zl(t.value,i))}}for(let e in rc)n(e).handlers.push(rc[e]);for(let e in oc)n(e).observers.push(oc[e]);return t}const ec=[{key:'Backspace',keyCode:8,inputType:'deleteContentBackward'},{key:'Enter',keyCode:13,inputType:'insertParagraph'},{key:'Enter',keyCode:13,inputType:'insertLineBreak'},{key:'Delete',keyCode:46,inputType:'deleteContentForward'}],tc='dthko',nc=[16,17,18,20,91,92,224,225];function sc(e){return.7*Math.max(0,e)+8}class ic{constructor(e,t,n,s){this.view=e,this.startEvent=t,this.style=n,this.mustSelect=s,this.scrollSpeed={x:0,y:0},this.scrolling=-1,this.lastEvent=t,this.scrollParents=function(e){let t,n,s=e.ownerDocument;for(let i=e.parentNode;i&&!(i==s.body||t&&n);)if(1==i.nodeType)!n&&i.scrollHeight>i.clientHeight&&(n=i),!t&&i.scrollWidth>i.clientWidth&&(t=i),i=i.assignedSlot||i.parentNode;else{if(11!=i.nodeType)break;i=i.host}return{x:t,y:n}}(e.contentDOM),this.atoms=e.state.facet(yl).map((t=>t(e)));let i=e.contentDOM.ownerDocument;i.addEventListener('mousemove',this.move=this.move.bind(this)),i.addEventListener('mouseup',this.up=this.up.bind(this)),this.extend=t.shiftKey,this.multiple=e.state.facet(Fr.allowMultipleSelections)&&function(e,t){let n=e.state.facet(Ha);return n.length?n[0](t):sa.mac?t.metaKey:t.ctrlKey}(e,t),this.dragging=!(!function(e,t){let{main:n}=e.state.selection;if(n.empty)return!1;let s=vo(e.root);if(!s||0==s.rangeCount)return!0;let i=s.getRangeAt(0).getClientRects();for(let e=0;e<i.length;e++){let n=i[e];if(n.left<=t.clientX&&n.right>=t.clientX&&n.top<=t.clientY&&n.bottom>=t.clientY)return!0}return!1}(e,t)||1!=xc(t))&&null}start(e){!1===this.dragging&&this.select(e)}move(e){if(0==e.buttons)return this.destroy();if(this.dragging||null==this.dragging&&(t=this.startEvent,n=e,Math.max(Math.abs(t.clientX-n.clientX),Math.abs(t.clientY-n.clientY))<10))return;var t,n;this.select(this.lastEvent=e);let s=0,i=0,r=0,o=0,a=this.view.win.innerWidth,l=this.view.win.innerHeight;this.scrollParents.x&&({left:r,right:a}=this.scrollParents.x.getBoundingClientRect()),this.scrollParents.y&&({top:o,bottom:l}=this.scrollParents.y.getBoundingClientRect());let c=Ol(this.view);e.clientX-c.left<=r+6?s=-sc(r-e.clientX):e.clientX+c.right>=a-6&&(s=sc(e.clientX-a)),e.clientY-c.top<=o+6?i=-sc(o-e.clientY):e.clientY+c.bottom>=l-6&&(i=sc(e.clientY-l)),this.setScrollSpeed(s,i)}up(e){null==this.dragging&&this.select(this.lastEvent),this.dragging||e.preventDefault(),this.destroy()}destroy(){this.setScrollSpeed(0,0);let e=this.view.contentDOM.ownerDocument;e.removeEventListener('mousemove',this.move),e.removeEventListener('mouseup',this.up),this.view.inputState.mouseSelection=this.view.inputState.draggedContent=null}setScrollSpeed(e,t){this.scrollSpeed={x:e,y:t},e||t?this.scrolling<0&&(this.scrolling=setInterval((()=>this.scroll()),50)):this.scrolling>-1&&(clearInterval(this.scrolling),this.scrolling=-1)}scroll(){let{x:e,y:t}=this.scrollSpeed;e&&this.scrollParents.x&&(this.scrollParents.x.scrollLeft+=e,e=0),t&&this.scrollParents.y&&(this.scrollParents.y.scrollTop+=t,t=0),(e||t)&&this.view.win.scrollBy(e,t),!1===this.dragging&&this.select(this.lastEvent)}skipAtoms(e){let t=null;for(let n=0;n<e.ranges.length;n++){let s=e.ranges[n],i=null;if(s.empty){let e=Ul(this.atoms,s.from,0);e!=s.from&&(i=qi.cursor(e,-1))}else{let e=Ul(this.atoms,s.from,-1),t=Ul(this.atoms,s.to,1);e==s.from&&t==s.to||(i=qi.range(s.from==s.anchor?e:t,s.from==s.head?e:t))}i&&(t||(t=e.ranges.slice()),t[n]=i)}return t?qi.create(t,e.mainIndex):e}select(e){let{view:t}=this,n=this.skipAtoms(this.style.get(e,this.extend,this.multiple));!this.mustSelect&&n.eq(t.state.selection,!1===this.dragging)||this.view.dispatch({selection:n,userEvent:'select.pointer'}),this.mustSelect=!1}update(e){e.transactions.some((e=>e.isUserEvent('input.type')))?this.destroy():this.style.update(e)&&setTimeout((()=>this.select(this.lastEvent)),20)}}const rc=Object.create(null),oc=Object.create(null),ac=sa.ie&&sa.ie_version<15||sa.ios&&sa.webkit_version<604;function lc(e,t,n){for(let s of e.facet(t))n=s(n,e);return n}function cc(e,t){t=lc(e.state,nl,t);let n,{state:s}=e,i=1,r=s.toText(t),o=r.lines==s.selection.ranges.length;if(null!=yc&&s.selection.ranges.every((e=>e.empty))&&yc==r.toString()){let e=-1;n=s.changeByRange((n=>{let a=s.doc.lineAt(n.from);if(a.from==e)return{range:n};e=a.from;let l=s.toText((o?r.line(i++).text:t)+s.lineBreak);return{changes:{from:a.from,insert:l},range:qi.cursor(n.from+l.length)}}))}else n=o?s.changeByRange((e=>{let t=r.line(i++);return{changes:{from:e.from,to:e.to,insert:t.text},range:qi.cursor(e.from+t.length)}})):s.replaceSelection(r);e.dispatch(n,{userEvent:'input.paste',scrollIntoView:!0})}function hc(e,t,n,s){if(1==s)return qi.cursor(t,n);if(2==s)return function(e,t,n=1){let s=e.charCategorizer(t),i=e.doc.lineAt(t),r=t-i.from;if(0==i.length)return qi.cursor(t);0==r?n=1:r==i.length&&(n=-1);let o=r,a=r;n<0?o=Di(i.text,r,!1):a=Di(i.text,r);let l=s(i.text.slice(o,a));for(;o>0;){let e=Di(i.text,o,!1);if(s(i.text.slice(e,o))!=l)break;o=e}for(;a<i.length;){let e=Di(i.text,a);if(s(i.text.slice(a,e))!=l)break;a=e}return qi.range(o+i.from,a+i.from)}(e.state,t,n);{let n=Oa.find(e.docView,t),s=e.state.doc.lineAt(n?n.posAtEnd:t),i=n?n.posAtStart:s.from,r=n?n.posAtEnd:s.to;return r<e.state.doc.length&&r==s.to&&r++,qi.range(i,r)}}oc.scroll=e=>{e.inputState.lastScrollTop=e.scrollDOM.scrollTop,e.inputState.lastScrollLeft=e.scrollDOM.scrollLeft},rc.keydown=(e,t)=>(e.inputState.setSelectionOrigin('select'),27==t.keyCode&&0!=e.inputState.tabFocusMode&&(e.inputState.tabFocusMode=Date.now()+2e3),!1),oc.touchstart=(e,t)=>{e.inputState.lastTouchTime=Date.now(),e.inputState.setSelectionOrigin('select.pointer')},oc.touchmove=e=>{e.inputState.setSelectionOrigin('select.pointer')},rc.mousedown=(e,t)=>{if(e.observer.flush(),e.inputState.lastTouchTime>Date.now()-2e3)return!1;let n=null;for(let s of e.state.facet(Ka))if(n=s(e,t),n)break;if(n||0!=t.button||(n=function(e,t){let n=fc(e,t),s=xc(t),i=e.state.selection;return{update(e){e.docChanged&&(n.pos=e.changes.mapPos(n.pos),i=i.map(e.changes))},get(t,r,o){let a,l=fc(e,t),c=hc(e,l.pos,l.bias,s);if(n.pos!=l.pos&&!r){let t=hc(e,n.pos,n.bias,s),i=Math.min(t.from,c.from),r=Math.max(t.to,c.to);c=i<c.from?qi.range(i,r):qi.range(r,i)}return r?i.replaceRange(i.main.extend(c.from,c.to)):o&&1==s&&i.ranges.length>1&&(a=function(e,t){for(let n=0;n<e.ranges.length;n++){let{from:s,to:i}=e.ranges[n];if(s<=t&&i>=t)return qi.create(e.ranges.slice(0,n).concat(e.ranges.slice(n+1)),e.mainIndex==n?0:e.mainIndex-(e.mainIndex>n?1:0))}return null}(i,l.pos))?a:o?i.addRange(c):qi.create([c])}}}(e,t)),n){let s=!e.hasFocus;e.inputState.startMouseSelection(new ic(e,t,n,s)),s&&e.observer.ignore((()=>{Po(e.contentDOM);let t=e.root.activeElement;t&&!t.contains(e.contentDOM)&&t.blur()}));let i=e.inputState.mouseSelection;if(i)return i.start(t),!1===i.dragging}return!1};let uc=(e,t,n)=>t>=n.top&&t<=n.bottom&&e>=n.left&&e<=n.right;function dc(e,t,n,s){let i=Oa.find(e.docView,t);if(!i)return 1;let r=t-i.posAtStart;if(0==r)return 1;if(r==i.length)return-1;let o=i.coordsAt(r,-1);if(o&&uc(n,s,o))return-1;let a=i.coordsAt(r,1);return a&&uc(n,s,a)?1:o&&o.bottom>=s?-1:1}function fc(e,t){let n=e.posAtCoords({x:t.clientX,y:t.clientY},!1);return{pos:n,bias:dc(e,n,t.clientX,t.clientY)}}const pc=sa.ie&&sa.ie_version<=11;let mc=null,gc=0,vc=0;function xc(e){if(!pc)return e.detail;let t=mc,n=vc;return mc=e,vc=Date.now(),gc=!t||n>Date.now()-400&&Math.abs(t.clientX-e.clientX)<2&&Math.abs(t.clientY-e.clientY)<2?(gc+1)%3:1}function bc(e,t,n,s){if(!(n=lc(e.state,nl,n)))return;let i=e.posAtCoords({x:t.clientX,y:t.clientY},!1),{draggedContent:r}=e.inputState,o=s&&r&&function(e,t){let n=e.state.facet(Ya);return n.length?n[0](t):sa.mac?!t.altKey:!t.ctrlKey}(e,t)?{from:r.from,to:r.to}:null,a={from:i,insert:n},l=e.state.changes(o?[o,a]:a);e.focus(),e.dispatch({changes:l,selection:{anchor:l.mapPos(i,-1),head:l.mapPos(i,1)},userEvent:o?'move.drop':'input.drop'}),e.inputState.draggedContent=null}rc.dragstart=(e,t)=>{let{selection:{main:n}}=e.state;if(t.target.draggable){let s=e.docView.nearest(t.target);if(s&&s.isWidget){let e=s.posAtStart,t=e+s.length;(e>=n.to||t<=n.from)&&(n=qi.range(e,t))}}let{inputState:s}=e;return s.mouseSelection&&(s.mouseSelection.dragging=!0),s.draggedContent=n,t.dataTransfer&&(t.dataTransfer.setData('Text',lc(e.state,sl,e.state.sliceDoc(n.from,n.to))),t.dataTransfer.effectAllowed='copyMove'),!1},rc.dragend=e=>(e.inputState.draggedContent=null,!1),rc.drop=(e,t)=>{if(!t.dataTransfer)return!1;if(e.state.readOnly)return!0;let n=t.dataTransfer.files;if(n&&n.length){let s=Array(n.length),i=0,r=()=>{++i==n.length&&bc(e,t,s.filter((e=>null!=e)).join(e.state.lineBreak),!1)};for(let e=0;e<n.length;e++){let t=new FileReader;t.onerror=r,t.onload=()=>{/[\x00-\x08\x0e-\x1f]{2}/.test(t.result)||(s[e]=t.result),r()},t.readAsText(n[e])}return!0}{let n=t.dataTransfer.getData('Text');if(n)return bc(e,t,n,!0),!0}return!1},rc.paste=(e,t)=>{if(e.state.readOnly)return!0;e.observer.flush();let n=ac?null:t.clipboardData;return n?(cc(e,n.getData('text/plain')||n.getData('text/uri-list')),!0):(function(e){let t=e.dom.parentNode;if(!t)return;let n=t.appendChild(document.createElement('textarea'));n.style.cssText='position: fixed; left: -10000px; top: 10px',n.focus(),setTimeout((()=>{e.focus(),n.remove(),cc(e,n.value)}),50)}(e),!1)};let yc=null;rc.copy=rc.cut=(e,t)=>{let{text:n,ranges:s,linewise:i}=function(e){let t=[],n=[],s=!1;for(let s of e.selection.ranges)s.empty||(t.push(e.sliceDoc(s.from,s.to)),n.push(s));if(!t.length){let i=-1;for(let{from:s}of e.selection.ranges){let r=e.doc.lineAt(s);r.number>i&&(t.push(r.text),n.push({from:r.from,to:Math.min(e.doc.length,r.to+1)})),i=r.number}s=!0}return{text:lc(e,sl,t.join(e.lineBreak)),ranges:n,linewise:s}}(e.state);if(!n&&!i)return!1;yc=i?n:null,'cut'!=t.type||e.state.readOnly||e.dispatch({changes:s,scrollIntoView:!0,userEvent:'delete.cut'});let r=ac?null:t.clipboardData;return r?(r.clearData(),r.setData('text/plain',n),!0):(function(e,t){let n=e.dom.parentNode;if(!n)return;let s=n.appendChild(document.createElement('textarea'));s.style.cssText='position: fixed; left: -10000px; top: 10px',s.value=t,s.focus(),s.selectionEnd=t.length,s.selectionStart=0,setTimeout((()=>{s.remove(),e.focus()}),50)}(e,n),!1)};const _c=Or.define();function wc(e,t){let n=[];for(let s of e.facet(tl)){let i=s(e,t);i&&n.push(i)}return n?e.update({effects:n,annotations:_c.of(!0)}):null}function kc(e){setTimeout((()=>{let t=e.hasFocus;if(t!=e.inputState.notifiedFocused){let n=wc(e.state,t);n?e.dispatch(n):e.update([])}}),10)}oc.focus=e=>{e.inputState.lastFocusTime=Date.now(),e.scrollDOM.scrollTop||!e.inputState.lastScrollTop&&!e.inputState.lastScrollLeft||(e.scrollDOM.scrollTop=e.inputState.lastScrollTop,e.scrollDOM.scrollLeft=e.inputState.lastScrollLeft),kc(e)},oc.blur=e=>{e.observer.clearSelectionRange(),kc(e)},oc.compositionstart=oc.compositionupdate=e=>{e.observer.editContext||(null==e.inputState.compositionFirstChange&&(e.inputState.compositionFirstChange=!0),e.inputState.composing<0&&(e.inputState.composing=0))},oc.compositionend=e=>{e.observer.editContext||(e.inputState.composing=-1,e.inputState.compositionEndedAt=Date.now(),e.inputState.compositionPendingKey=!0,e.inputState.compositionPendingChange=e.observer.pendingRecords().length>0,e.inputState.compositionFirstChange=null,sa.chrome&&sa.android?e.observer.flushSoon():e.inputState.compositionPendingChange?Promise.resolve().then((()=>e.observer.flush())):setTimeout((()=>{e.inputState.composing<0&&e.docView.hasComposition&&e.update([])}),50))},oc.contextmenu=e=>{e.inputState.lastContextMenu=Date.now()},rc.beforeinput=(e,t)=>{var n,s;if('insertReplacementText'==t.inputType&&e.observer.editContext){let s=null===(n=t.dataTransfer)||void 0===n?void 0:n.getData('text/plain'),i=t.getTargetRanges();if(s&&i.length){let t=i[0],n=e.posAtDOM(t.startContainer,t.startOffset),r=e.posAtDOM(t.endContainer,t.endOffset);return Yl(e,{from:n,to:r,insert:e.state.toText(s)},null),!0}}let i;if(sa.chrome&&sa.android&&(i=ec.find((e=>e.inputType==t.inputType)))&&(e.observer.delayAndroidKey(i.key,i.keyCode),'Backspace'==i.key||'Delete'==i.key)){let t=(null===(s=window.visualViewport)||void 0===s?void 0:s.height)||0;setTimeout((()=>{var n;((null===(n=window.visualViewport)||void 0===n?void 0:n.height)||0)>t+10&&e.hasFocus&&(e.contentDOM.blur(),e.focus())}),100)}return sa.ios&&'deleteContentForward'==t.inputType&&e.observer.flushSoon(),sa.safari&&'insertText'==t.inputType&&e.inputState.composing>=0&&setTimeout((()=>oc.compositionend(e,t)),20),!1};const Oc=new Set;const Sc=['pre-wrap','normal','pre-line','break-spaces'];let Tc=!1;function Ic(){Tc=!1}class Cc{constructor(e){this.lineWrapping=e,this.doc=ki.empty,this.heightSamples={},this.lineHeight=14,this.charWidth=7,this.textHeight=14,this.lineLength=30}heightForGap(e,t){let n=this.doc.lineAt(t).number-this.doc.lineAt(e).number+1;return this.lineWrapping&&(n+=Math.max(0,Math.ceil((t-e-n*this.lineLength*.5)/this.lineLength))),this.lineHeight*n}heightForLine(e){if(!this.lineWrapping)return this.lineHeight;return(1+Math.max(0,Math.ceil((e-this.lineLength)/(this.lineLength-5))))*this.lineHeight}setDoc(e){return this.doc=e,this}mustRefreshForWrapping(e){return Sc.indexOf(e)>-1!=this.lineWrapping}mustRefreshForHeights(e){let t=!1;for(let n=0;n<e.length;n++){let s=e[n];s<0?n++:this.heightSamples[Math.floor(10*s)]||(t=!0,this.heightSamples[Math.floor(10*s)]=!0)}return t}refresh(e,t,n,s,i,r){let o=Sc.indexOf(e)>-1,a=Math.round(t)!=Math.round(this.lineHeight)||this.lineWrapping!=o;if(this.lineWrapping=o,this.lineHeight=t,this.charWidth=n,this.textHeight=s,this.lineLength=i,a){this.heightSamples={};for(let e=0;e<r.length;e++){let t=r[e];t<0?e++:this.heightSamples[Math.floor(10*t)]=!0}}return a}}class $c{constructor(e,t){this.from=e,this.heights=t,this.index=0}get more(){return this.index<this.heights.length}}class Ac{constructor(e,t,n,s,i){this.from=e,this.length=t,this.top=n,this.height=s,this._content=i}get type(){return'number'==typeof this._content?va.Text:Array.isArray(this._content)?this._content:this._content.type}get to(){return this.from+this.length}get bottom(){return this.top+this.height}get widget(){return this._content instanceof _a?this._content.widget:null}get widgetLineBreaks(){return'number'==typeof this._content?this._content:0}join(e){let t=(Array.isArray(this._content)?this._content:[this]).concat(Array.isArray(e._content)?e._content:[e]);return new Ac(this.from,this.length+e.length,this.top,this.height+e.height,t)}}var Ec=(e=>(e[e.ByPos=0]='ByPos',e[e.ByHeight=1]='ByHeight',e[e.ByPosNoHeight=2]='ByPosNoHeight',e))(Ec||(Ec={}));const Pc=.001;class Dc{constructor(e,t,n=2){this.length=e,this.height=t,this.flags=n}get outdated(){return(2&this.flags)>0}set outdated(e){this.flags=(e?2:0)|-3&this.flags}setHeight(e){this.height!=e&&(Math.abs(this.height-e)>Pc&&(Tc=!0),this.height=e)}replace(e,t,n){return Dc.of(n)}decomposeLeft(e,t){t.push(this)}decomposeRight(e,t){t.push(this)}applyChanges(e,t,n,s){let i=this,r=n.doc;for(let o=s.length-1;o>=0;o--){let{fromA:a,toA:l,fromB:c,toB:h}=s[o],u=i.lineAt(a,Ec.ByPosNoHeight,n.setDoc(t),0,0),d=u.to>=l?u:i.lineAt(l,Ec.ByPosNoHeight,n,0,0);for(h+=d.to-l,l=d.to;o>0&&u.from<=s[o-1].toA;)a=s[o-1].fromA,c=s[o-1].fromB,o--,a<u.from&&(u=i.lineAt(a,Ec.ByPosNoHeight,n,0,0));c+=u.from-a,a=u.from;let f=Vc.build(n.setDoc(r),e,c,h);i=Mc(i,i.replace(a,l,f))}return i.updateHeight(n,0)}static empty(){return new Bc(0,0)}static of(e){if(1==e.length)return e[0];let t=0,n=e.length,s=0,i=0;for(;;)if(t==n)if(s>2*i){let i=e[t-1];i.break?e.splice(--t,1,i.left,null,i.right):e.splice(--t,1,i.left,i.right),n+=1+i.break,s-=i.size}else{if(!(i>2*s))break;{let t=e[n];t.break?e.splice(n,1,t.left,null,t.right):e.splice(n,1,t.left,t.right),n+=2+t.break,i-=t.size}}else if(s<i){let n=e[t++];n&&(s+=n.size)}else{let t=e[--n];t&&(i+=t.size)}let r=0;return null==e[t-1]?(r=1,t--):null==e[t]&&(r=1,n++),new Rc(Dc.of(e.slice(0,t)),r,Dc.of(e.slice(n)))}}function Mc(e,t){return e==t?e:(e.constructor!=t.constructor&&(Tc=!0),t)}Dc.prototype.size=1;class Lc extends Dc{constructor(e,t,n){super(e,t),this.deco=n}blockAt(e,t,n,s){return new Ac(s,this.length,n,this.height,this.deco||0)}lineAt(e,t,n,s,i){return this.blockAt(0,n,s,i)}forEachLine(e,t,n,s,i,r){e<=i+this.length&&t>=i&&r(this.blockAt(0,n,s,i))}updateHeight(e,t=0,n=!1,s){return s&&s.from<=t&&s.more&&this.setHeight(s.heights[s.index++]),this.outdated=!1,this}toString(){return`block(${this.length})`}}class Bc extends Lc{constructor(e,t){super(e,t,null),this.collapsed=0,this.widgetHeight=0,this.breaks=0}blockAt(e,t,n,s){return new Ac(s,this.length,n,this.height,this.breaks)}replace(e,t,n){let s=n[0];return 1==n.length&&(s instanceof Bc||s instanceof Nc&&4&s.flags)&&Math.abs(this.length-s.length)<10?(s instanceof Nc?s=new Bc(s.length,this.height):s.height=this.height,this.outdated||(s.outdated=!1),s):Dc.of(n)}updateHeight(e,t=0,n=!1,s){return s&&s.from<=t&&s.more?this.setHeight(s.heights[s.index++]):(n||this.outdated)&&this.setHeight(Math.max(this.widgetHeight,e.heightForLine(this.length-this.collapsed))+this.breaks*e.lineHeight),this.outdated=!1,this}toString(){return`line(${this.length}${this.collapsed?-this.collapsed:''}${this.widgetHeight?':'+this.widgetHeight:''})`}}class Nc extends Dc{constructor(e){super(e,0)}heightMetrics(e,t){let n,s=e.doc.lineAt(t).number,i=e.doc.lineAt(t+this.length).number,r=i-s+1,o=0;if(e.lineWrapping){let t=Math.min(this.height,e.lineHeight*r);n=t/r,this.length>r+1&&(o=(this.height-t)/(this.length-r-1))}else n=this.height/r;return{firstLine:s,lastLine:i,perLine:n,perChar:o}}blockAt(e,t,n,s){let{firstLine:i,lastLine:r,perLine:o,perChar:a}=this.heightMetrics(t,s);if(t.lineWrapping){let i=s+(e<t.lineHeight?0:Math.round(Math.max(0,Math.min(1,(e-n)/this.height))*this.length)),r=t.doc.lineAt(i),l=o+r.length*a,c=Math.max(n,e-l/2);return new Ac(r.from,r.length,c,l,0)}{let s=Math.max(0,Math.min(r-i,Math.floor((e-n)/o))),{from:a,length:l}=t.doc.line(i+s);return new Ac(a,l,n+o*s,o,0)}}lineAt(e,t,n,s,i){if(t==Ec.ByHeight)return this.blockAt(e,n,s,i);if(t==Ec.ByPosNoHeight){let{from:t,to:s}=n.doc.lineAt(e);return new Ac(t,s-t,0,0,0)}let{firstLine:r,perLine:o,perChar:a}=this.heightMetrics(n,i),l=n.doc.lineAt(e),c=o+l.length*a,h=l.number-r,u=s+o*h+a*(l.from-i-h);return new Ac(l.from,l.length,Math.max(s,Math.min(u,s+this.height-c)),c,0)}forEachLine(e,t,n,s,i,r){e=Math.max(e,i),t=Math.min(t,i+this.length);let{firstLine:o,perLine:a,perChar:l}=this.heightMetrics(n,i);for(let c=e,h=s;c<=t;){let t=n.doc.lineAt(c);if(c==e){let n=t.number-o;h+=a*n+l*(e-i-n)}let s=a+l*t.length;r(new Ac(t.from,t.length,h,s,0)),h+=s,c=t.to+1}}replace(e,t,n){let s=this.length-t;if(s>0){let e=n[n.length-1];e instanceof Nc?n[n.length-1]=new Nc(e.length+s):n.push(null,new Nc(s-1))}if(e>0){let t=n[0];t instanceof Nc?n[0]=new Nc(e+t.length):n.unshift(new Nc(e-1),null)}return Dc.of(n)}decomposeLeft(e,t){t.push(new Nc(e-1),null)}decomposeRight(e,t){t.push(null,new Nc(this.length-e-1))}updateHeight(e,t=0,n=!1,s){let i=t+this.length;if(s&&s.from<=t+this.length&&s.more){let n=[],r=Math.max(t,s.from),o=-1;for(s.from>t&&n.push(new Nc(s.from-t-1).updateHeight(e,t));r<=i&&s.more;){let t=e.doc.lineAt(r).length;n.length&&n.push(null);let i=s.heights[s.index++];-1==o?o=i:Math.abs(i-o)>=Pc&&(o=-2);let a=new Bc(t,i);a.outdated=!1,n.push(a),r+=t+1}r<=i&&n.push(null,new Nc(i-r).updateHeight(e,r));let a=Dc.of(n);return(o<0||Math.abs(a.height-this.height)>=Pc||Math.abs(o-this.heightMetrics(e,t).perLine)>=Pc)&&(Tc=!0),Mc(this,a)}return(n||this.outdated)&&(this.setHeight(e.heightForGap(t,t+this.length)),this.outdated=!1),this}toString(){return`gap(${this.length})`}}class Rc extends Dc{constructor(e,t,n){super(e.length+t+n.length,e.height+n.height,t|(e.outdated||n.outdated?2:0)),this.left=e,this.right=n,this.size=e.size+n.size}get break(){return 1&this.flags}blockAt(e,t,n,s){let i=n+this.left.height;return e<i?this.left.blockAt(e,t,n,s):this.right.blockAt(e,t,i,s+this.left.length+this.break)}lineAt(e,t,n,s,i){let r=s+this.left.height,o=i+this.left.length+this.break,a=t==Ec.ByHeight?e<r:e<o,l=a?this.left.lineAt(e,t,n,s,i):this.right.lineAt(e,t,n,r,o);if(this.break||(a?l.to<o:l.from>o))return l;let c=t==Ec.ByPosNoHeight?Ec.ByPosNoHeight:Ec.ByPos;return a?l.join(this.right.lineAt(o,c,n,r,o)):this.left.lineAt(o,c,n,s,i).join(l)}forEachLine(e,t,n,s,i,r){let o=s+this.left.height,a=i+this.left.length+this.break;if(this.break)e<a&&this.left.forEachLine(e,t,n,s,i,r),t>=a&&this.right.forEachLine(e,t,n,o,a,r);else{let l=this.lineAt(a,Ec.ByPos,n,s,i);e<l.from&&this.left.forEachLine(e,l.from-1,n,s,i,r),l.to>=e&&l.from<=t&&r(l),t>l.to&&this.right.forEachLine(l.to+1,t,n,o,a,r)}}replace(e,t,n){let s=this.left.length+this.break;if(t<s)return this.balanced(this.left.replace(e,t,n),this.right);if(e>this.left.length)return this.balanced(this.left,this.right.replace(e-s,t-s,n));let i=[];e>0&&this.decomposeLeft(e,i);let r=i.length;for(let e of n)i.push(e);if(e>0&&Fc(i,r-1),t<this.length){let e=i.length;this.decomposeRight(t,i),Fc(i,e)}return Dc.of(i)}decomposeLeft(e,t){let n=this.left.length;if(e<=n)return this.left.decomposeLeft(e,t);t.push(this.left),this.break&&(n++,e>=n&&t.push(null)),e>n&&this.right.decomposeLeft(e-n,t)}decomposeRight(e,t){let n=this.left.length,s=n+this.break;if(e>=s)return this.right.decomposeRight(e-s,t);e<n&&this.left.decomposeRight(e,t),this.break&&e<s&&t.push(null),t.push(this.right)}balanced(e,t){return e.size>2*t.size||t.size>2*e.size?Dc.of(this.break?[e,null,t]:[e,t]):(this.left=Mc(this.left,e),this.right=Mc(this.right,t),this.setHeight(e.height+t.height),this.outdated=e.outdated||t.outdated,this.size=e.size+t.size,this.length=e.length+this.break+t.length,this)}updateHeight(e,t=0,n=!1,s){let{left:i,right:r}=this,o=t+i.length+this.break,a=null;return s&&s.from<=t+i.length&&s.more?a=i=i.updateHeight(e,t,n,s):i.updateHeight(e,t,n),s&&s.from<=o+r.length&&s.more?a=r=r.updateHeight(e,o,n,s):r.updateHeight(e,o,n),a?this.balanced(i,r):(this.height=this.left.height+this.right.height,this.outdated=!1,this)}toString(){return this.left+(this.break?' ':'-')+this.right}}function Fc(e,t){let n,s;null==e[t]&&(n=e[t-1])instanceof Nc&&(s=e[t+1])instanceof Nc&&e.splice(t-1,3,new Nc(n.length+1+s.length))}class Vc{constructor(e,t){this.pos=e,this.oracle=t,this.nodes=[],this.lineStart=-1,this.lineEnd=-1,this.covering=null,this.writtenTo=e}get isCovered(){return this.covering&&this.nodes[this.nodes.length-1]==this.covering}span(e,t){if(this.lineStart>-1){let e=Math.min(t,this.lineEnd),n=this.nodes[this.nodes.length-1];n instanceof Bc?n.length+=e-this.pos:(e>this.pos||!this.isCovered)&&this.nodes.push(new Bc(e-this.pos,-1)),this.writtenTo=e,t>e&&(this.nodes.push(null),this.writtenTo++,this.lineStart=-1)}this.pos=t}point(e,t,n){if(e<t||n.heightRelevant){let s=n.widget?n.widget.estimatedHeight:0,i=n.widget?n.widget.lineBreaks:0;s<0&&(s=this.oracle.lineHeight);let r=t-e;n.block?this.addBlock(new Lc(r,s,n)):(r||i||s>=5)&&this.addLineDeco(s,i,r)}else t>e&&this.span(e,t);this.lineEnd>-1&&this.lineEnd<this.pos&&(this.lineEnd=this.oracle.doc.lineAt(this.pos).to)}enterLine(){if(this.lineStart>-1)return;let{from:e,to:t}=this.oracle.doc.lineAt(this.pos);this.lineStart=e,this.lineEnd=t,this.writtenTo<e&&((this.writtenTo<e-1||null==this.nodes[this.nodes.length-1])&&this.nodes.push(this.blankContent(this.writtenTo,e-1)),this.nodes.push(null)),this.pos>e&&this.nodes.push(new Bc(this.pos-e,-1)),this.writtenTo=this.pos}blankContent(e,t){let n=new Nc(t-e);return this.oracle.doc.lineAt(e).to==t&&(n.flags|=4),n}ensureLine(){this.enterLine();let e=this.nodes.length?this.nodes[this.nodes.length-1]:null;if(e instanceof Bc)return e;let t=new Bc(0,-1);return this.nodes.push(t),t}addBlock(e){this.enterLine();let t=e.deco;t&&t.startSide>0&&!this.isCovered&&this.ensureLine(),this.nodes.push(e),this.writtenTo=this.pos=this.pos+e.length,t&&t.endSide>0&&(this.covering=e)}addLineDeco(e,t,n){let s=this.ensureLine();s.length+=n,s.collapsed+=n,s.widgetHeight=Math.max(s.widgetHeight,e),s.breaks+=t,this.writtenTo=this.pos=this.pos+n}finish(e){let t=0==this.nodes.length?null:this.nodes[this.nodes.length-1];!(this.lineStart>-1)||t instanceof Bc||this.isCovered?(this.writtenTo<this.pos||null==t)&&this.nodes.push(this.blankContent(this.writtenTo,this.pos)):this.nodes.push(new Bc(0,-1));let n=e;for(let e of this.nodes)e instanceof Bc&&e.updateHeight(this.oracle,n),n+=e?e.length:1;return this.nodes}static build(e,t,n,s){let i=new Vc(n,e);return jr.spans(t,n,s,i,0),i.finish(n)}}class zc{constructor(){this.changes=[]}compareRange(){}comparePoint(e,t,n,s){(e<t||n&&n.heightRelevant||s&&s.heightRelevant)&&ka(e,t,this.changes,5)}}function Uc(e,t){let n=e.getBoundingClientRect(),s=e.ownerDocument,i=s.defaultView||window,r=Math.max(0,n.left),o=Math.min(i.innerWidth,n.right),a=Math.max(0,n.top),l=Math.min(i.innerHeight,n.bottom);for(let t=e.parentNode;t&&t!=s.body;)if(1==t.nodeType){let n=t,s=window.getComputedStyle(n);if((n.scrollHeight>n.clientHeight||n.scrollWidth>n.clientWidth)&&'visible'!=s.overflow){let s=n.getBoundingClientRect();r=Math.max(r,s.left),o=Math.min(o,s.right),a=Math.max(a,s.top),l=Math.min(t==e.parentNode?i.innerHeight:l,s.bottom)}t='absolute'==s.position||'fixed'==s.position?n.offsetParent:n.parentNode}else{if(11!=t.nodeType)break;t=t.host}return{left:r-n.left,right:Math.max(r,o)-n.left,top:a-(n.top+t),bottom:Math.max(a,l)-(n.top+t)}}function Wc(e,t){let n=e.getBoundingClientRect();return{left:0,right:n.right-n.left,top:t,bottom:n.bottom-(n.top+t)}}class Qc{constructor(e,t,n,s){this.from=e,this.to=t,this.size=n,this.displaySize=s}static same(e,t){if(e.length!=t.length)return!1;for(let n=0;n<e.length;n++){let s=e[n],i=t[n];if(s.from!=i.from||s.to!=i.to||s.size!=i.size)return!1}return!0}draw(e,t){return xa.replace({widget:new jc(this.displaySize*(t?e.scaleY:e.scaleX),t)}).range(this.from,this.to)}}class jc extends ga{constructor(e,t){super(),this.size=e,this.vertical=t}eq(e){return e.size==this.size&&e.vertical==this.vertical}toDOM(){let e=document.createElement('div');return this.vertical?e.style.height=this.size+'px':(e.style.width=this.size+'px',e.style.height='2px',e.style.display='inline-block'),e}get estimatedHeight(){return this.vertical?this.size:-1}}class Xc{constructor(e){this.state=e,this.pixelViewport={left:0,right:window.innerWidth,top:0,bottom:0},this.inView=!0,this.paddingTop=0,this.paddingBottom=0,this.contentDOMWidth=0,this.contentDOMHeight=0,this.editorHeight=0,this.editorWidth=0,this.scrollTop=0,this.scrolledToBottom=!1,this.scaleX=1,this.scaleY=1,this.scrollAnchorPos=0,this.scrollAnchorHeight=-1,this.scaler=Yc,this.scrollTarget=null,this.printing=!1,this.mustMeasureContent=!0,this.defaultTextDirection=Aa.LTR,this.visibleRanges=[],this.mustEnforceCursorAssoc=!1;let t=e.facet(vl).some((e=>'function'!=typeof e&&'cm-lineWrapping'==e.class));this.heightOracle=new Cc(t),this.stateDeco=e.facet(xl).filter((e=>'function'!=typeof e)),this.heightMap=Dc.empty().applyChanges(this.stateDeco,ki.empty,this.heightOracle.setDoc(e.doc),[new Tl(0,0,0,e.doc.length)]);for(let e=0;e<2&&(this.viewport=this.getViewport(0,null),this.updateForViewport());e++);this.updateViewportLines(),this.lineGaps=this.ensureLineGaps([]),this.lineGapDeco=xa.set(this.lineGaps.map((e=>e.draw(this,!1)))),this.computeVisibleRanges()}updateForViewport(){let e=[this.viewport],{main:t}=this.state.selection;for(let n=0;n<=1;n++){let s=n?t.head:t.anchor;if(!e.some((({from:e,to:t})=>s>=e&&s<=t))){let{from:t,to:n}=this.lineBlockAt(s);e.push(new Gc(t,n))}}return this.viewports=e.sort(((e,t)=>e.from-t.from)),this.updateScaler()}updateScaler(){let e=this.scaler;return this.scaler=this.heightMap.height<=7e6?Yc:new Kc(this.heightOracle,this.heightMap,this.viewports),e.eq(this.scaler)?0:2}updateViewportLines(){this.viewportLines=[],this.heightMap.forEachLine(this.viewport.from,this.viewport.to,this.heightOracle.setDoc(this.state.doc),0,0,(e=>{this.viewportLines.push(Zc(e,this.scaler))}))}update(e,t=null){this.state=e.state;let n=this.stateDeco;this.stateDeco=this.state.facet(xl).filter((e=>'function'!=typeof e));let s=e.changedRanges,i=Tl.extendWithRanges(s,function(e,t,n){let s=new zc;return jr.compare(e,t,n,s,0),s.changes}(n,this.stateDeco,e?e.changes:Vi.empty(this.state.doc.length))),r=this.heightMap.height,o=this.scrolledToBottom?null:this.scrollAnchorAt(this.scrollTop);Ic(),this.heightMap=this.heightMap.applyChanges(this.stateDeco,e.startState.doc,this.heightOracle.setDoc(this.state.doc),i),(this.heightMap.height!=r||Tc)&&(e.flags|=2),o?(this.scrollAnchorPos=e.changes.mapPos(o.from,-1),this.scrollAnchorHeight=o.top):(this.scrollAnchorPos=-1,this.scrollAnchorHeight=this.heightMap.height);let a=i.length?this.mapViewport(this.viewport,e.changes):this.viewport;(t&&(t.range.head<a.from||t.range.head>a.to)||!this.viewportIsAppropriate(a))&&(a=this.getViewport(0,t));let l=a.from!=this.viewport.from||a.to!=this.viewport.to;this.viewport=a,e.flags|=this.updateForViewport(),(l||!e.changes.empty||2&e.flags)&&this.updateViewportLines(),(this.lineGaps.length||this.viewport.to-this.viewport.from>4e3)&&this.updateLineGaps(this.ensureLineGaps(this.mapLineGaps(this.lineGaps,e.changes))),e.flags|=this.computeVisibleRanges(e.changes),t&&(this.scrollTarget=t),!this.mustEnforceCursorAssoc&&e.selectionSet&&e.view.lineWrapping&&e.state.selection.main.empty&&e.state.selection.main.assoc&&!e.state.facet(rl)&&(this.mustEnforceCursorAssoc=!0)}measure(e){let t=e.contentDOM,n=window.getComputedStyle(t),s=this.heightOracle,i=n.whiteSpace;this.defaultTextDirection='rtl'==n.direction?Aa.RTL:Aa.LTR;let r=this.heightOracle.mustRefreshForWrapping(i),o=t.getBoundingClientRect(),a=r||this.mustMeasureContent||this.contentDOMHeight!=o.height;this.contentDOMHeight=o.height,this.mustMeasureContent=!1;let l=0,c=0;if(o.width&&o.height){let{scaleX:e,scaleY:n}=Co(t,o);(e>.005&&Math.abs(this.scaleX-e)>.005||n>.005&&Math.abs(this.scaleY-n)>.005)&&(this.scaleX=e,this.scaleY=n,l|=16,r=a=!0)}let h=(parseInt(n.paddingTop)||0)*this.scaleY,u=(parseInt(n.paddingBottom)||0)*this.scaleY;this.paddingTop==h&&this.paddingBottom==u||(this.paddingTop=h,this.paddingBottom=u,l|=18),this.editorWidth!=e.scrollDOM.clientWidth&&(s.lineWrapping&&(a=!0),this.editorWidth=e.scrollDOM.clientWidth,l|=16);let d=e.scrollDOM.scrollTop*this.scaleY;this.scrollTop!=d&&(this.scrollAnchorHeight=-1,this.scrollTop=d),this.scrolledToBottom=Bo(e.scrollDOM);let f=(this.printing?Wc:Uc)(t,this.paddingTop),p=f.top-this.pixelViewport.top,m=f.bottom-this.pixelViewport.bottom;this.pixelViewport=f;let g=this.pixelViewport.bottom>this.pixelViewport.top&&this.pixelViewport.right>this.pixelViewport.left;if(g!=this.inView&&(this.inView=g,g&&(a=!0)),!this.inView&&!this.scrollTarget&&!function(e){let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView||window;return t.left<n.innerWidth&&t.right>0&&t.top<n.innerHeight&&t.bottom>0}(e.dom))return 0;let v=o.width;if(this.contentDOMWidth==v&&this.editorHeight==e.scrollDOM.clientHeight||(this.contentDOMWidth=o.width,this.editorHeight=e.scrollDOM.clientHeight,l|=16),a){let t=e.docView.measureVisibleLineHeights(this.viewport);if(s.mustRefreshForHeights(t)&&(r=!0),r||s.lineWrapping&&Math.abs(v-this.contentDOMWidth)>s.charWidth){let{lineHeight:n,charWidth:o,textHeight:a}=e.docView.measureTextSize();r=n>0&&s.refresh(i,n,o,a,v/o,t),r&&(e.docView.minWidth=0,l|=16)}p>0&&m>0?c=Math.max(p,m):p<0&&m<0&&(c=Math.min(p,m)),Ic();for(let n of this.viewports){let i=n.from==this.viewport.from?t:e.docView.measureVisibleLineHeights(n);this.heightMap=(r?Dc.empty().applyChanges(this.stateDeco,ki.empty,this.heightOracle,[new Tl(0,0,0,e.state.doc.length)]):this.heightMap).updateHeight(s,0,r,new $c(n.from,i))}Tc&&(l|=2)}let x=!this.viewportIsAppropriate(this.viewport,c)||this.scrollTarget&&(this.scrollTarget.range.head<this.viewport.from||this.scrollTarget.range.head>this.viewport.to);return x&&(2&l&&(l|=this.updateScaler()),this.viewport=this.getViewport(c,this.scrollTarget),l|=this.updateForViewport()),(2&l||x)&&this.updateViewportLines(),(this.lineGaps.length||this.viewport.to-this.viewport.from>4e3)&&this.updateLineGaps(this.ensureLineGaps(r?[]:this.lineGaps,e)),l|=this.computeVisibleRanges(),this.mustEnforceCursorAssoc&&(this.mustEnforceCursorAssoc=!1,e.docView.enforceCursorAssoc()),l}get visibleTop(){return this.scaler.fromDOM(this.pixelViewport.top)}get visibleBottom(){return this.scaler.fromDOM(this.pixelViewport.bottom)}getViewport(e,t){let n=.5-Math.max(-.5,Math.min(.5,e/1e3/2)),s=this.heightMap,i=this.heightOracle,{visibleTop:r,visibleBottom:o}=this,a=new Gc(s.lineAt(r-1e3*n,Ec.ByHeight,i,0,0).from,s.lineAt(o+1e3*(1-n),Ec.ByHeight,i,0,0).to);if(t){let{head:e}=t.range;if(e<a.from||e>a.to){let n,r=Math.min(this.editorHeight,this.pixelViewport.bottom-this.pixelViewport.top),o=s.lineAt(e,Ec.ByPos,i,0,0);n='center'==t.y?(o.top+o.bottom)/2-r/2:'start'==t.y||'nearest'==t.y&&e<a.from?o.top:o.bottom-r,a=new Gc(s.lineAt(n-500,Ec.ByHeight,i,0,0).from,s.lineAt(n+r+500,Ec.ByHeight,i,0,0).to)}}return a}mapViewport(e,t){let n=t.mapPos(e.from,-1),s=t.mapPos(e.to,1);return new Gc(this.heightMap.lineAt(n,Ec.ByPos,this.heightOracle,0,0).from,this.heightMap.lineAt(s,Ec.ByPos,this.heightOracle,0,0).to)}viewportIsAppropriate({from:e,to:t},n=0){if(!this.inView)return!0;let{top:s}=this.heightMap.lineAt(e,Ec.ByPos,this.heightOracle,0,0),{bottom:i}=this.heightMap.lineAt(t,Ec.ByPos,this.heightOracle,0,0),{visibleTop:r,visibleBottom:o}=this;return(0==e||s<=r-Math.max(10,Math.min(-n,250)))&&(t==this.state.doc.length||i>=o+Math.max(10,Math.min(n,250)))&&s>r-2e3&&i<o+2e3}mapLineGaps(e,t){if(!e.length||t.empty)return e;let n=[];for(let s of e)t.touchesRange(s.from,s.to)||n.push(new Qc(t.mapPos(s.from),t.mapPos(s.to),s.size,s.displaySize));return n}ensureLineGaps(e,t){let n=this.heightOracle.lineWrapping,s=n?1e4:2e3,i=s>>1,r=s<<1;if(this.defaultTextDirection!=Aa.LTR&&!n)return[];let o=[],a=(s,r,l,c)=>{if(r-s<i)return;let h=this.state.selection.main,u=[h.from];h.empty||u.push(h.to);for(let e of u)if(e>s&&e<r)return a(s,e-10,l,c),void a(e+10,r,l,c);let d=function(e,t){for(let n of e)if(t(n))return n;return}(e,(e=>e.from>=l.from&&e.to<=l.to&&Math.abs(e.from-s)<i&&Math.abs(e.to-r)<i&&!u.some((t=>e.from<t&&e.to>t))));if(!d){if(r<l.to&&t&&n&&t.visibleRanges.some((e=>e.from<=r&&e.to>=r))){let e=t.moveToLineBoundary(qi.cursor(r),!1,!0).head;e>s&&(r=e)}let e=this.gapSize(l,s,r,c);d=new Qc(s,r,e,n||e<2e6?e:2e6)}o.push(d)},l=t=>{if(t.length<r||t.type!=va.Text)return;let i=function(e,t,n){let s=[],i=e,r=0;jr.spans(n,e,t,{span(){},point(e,t){e>i&&(s.push({from:i,to:e}),r+=e-i),i=t}},20),i<t&&(s.push({from:i,to:t}),r+=t-i);return{total:r,ranges:s}}(t.from,t.to,this.stateDeco);if(i.total<r)return;let o,l,c=this.scrollTarget?this.scrollTarget.range.head:null;if(n){let e,n,r=s/this.heightOracle.lineLength*this.heightOracle.lineHeight;if(null!=c){let s=Hc(i,c),o=((this.visibleBottom-this.visibleTop)/2+r)/t.height;e=s-o,n=s+o}else e=(this.visibleTop-t.top-r)/t.height,n=(this.visibleBottom-t.top+r)/t.height;o=qc(i,e),l=qc(i,n)}else{let n=i.total*this.heightOracle.charWidth,r=s*this.heightOracle.charWidth,a=0;if(n>2e6)for(let n of e)n.from>=t.from&&n.from<t.to&&n.size!=n.displaySize&&n.from*this.heightOracle.charWidth+a<this.pixelViewport.left&&(a=n.size-n.displaySize);let h,u,d=this.pixelViewport.left+a,f=this.pixelViewport.right+a;if(null!=c){let e=Hc(i,c),t=((f-d)/2+r)/n;h=e-t,u=e+t}else h=(d-r)/n,u=(f+r)/n;o=qc(i,h),l=qc(i,u)}o>t.from&&a(t.from,o,t,i),l<t.to&&a(l,t.to,t,i)};for(let e of this.viewportLines)Array.isArray(e.type)?e.type.forEach(l):l(e);return o}gapSize(e,t,n,s){let i=Hc(s,n)-Hc(s,t);return this.heightOracle.lineWrapping?e.height*i:s.total*this.heightOracle.charWidth*i}updateLineGaps(e){Qc.same(e,this.lineGaps)||(this.lineGaps=e,this.lineGapDeco=xa.set(e.map((e=>e.draw(this,this.heightOracle.lineWrapping)))))}computeVisibleRanges(e){let t=this.stateDeco;this.lineGaps.length&&(t=t.concat(this.lineGapDeco));let n=[];jr.spans(t,this.viewport.from,this.viewport.to,{span(e,t){n.push({from:e,to:t})},point(){}},20);let s=0;if(n.length!=this.visibleRanges.length)s=12;else for(let t=0;t<n.length&&!(8&s);t++){let i=this.visibleRanges[t],r=n[t];i.from==r.from&&i.to==r.to||(s|=4,e&&e.mapPos(i.from,-1)==r.from&&e.mapPos(i.to,1)==r.to||(s|=8))}return this.visibleRanges=n,s}lineBlockAt(e){return e>=this.viewport.from&&e<=this.viewport.to&&this.viewportLines.find((t=>t.from<=e&&t.to>=e))||Zc(this.heightMap.lineAt(e,Ec.ByPos,this.heightOracle,0,0),this.scaler)}lineBlockAtHeight(e){return e>=this.viewportLines[0].top&&e<=this.viewportLines[this.viewportLines.length-1].bottom&&this.viewportLines.find((t=>t.top<=e&&t.bottom>=e))||Zc(this.heightMap.lineAt(this.scaler.fromDOM(e),Ec.ByHeight,this.heightOracle,0,0),this.scaler)}scrollAnchorAt(e){let t=this.lineBlockAtHeight(e+8);return t.from>=this.viewport.from||this.viewportLines[0].top-e>200?t:this.viewportLines[0]}elementAtHeight(e){return Zc(this.heightMap.blockAt(this.scaler.fromDOM(e),this.heightOracle,0,0),this.scaler)}get docHeight(){return this.scaler.toDOM(this.heightMap.height)}get contentHeight(){return this.docHeight+this.paddingTop+this.paddingBottom}}class Gc{constructor(e,t){this.from=e,this.to=t}}function qc({total:e,ranges:t},n){if(n<=0)return t[0].from;if(n>=1)return t[t.length-1].to;let s=Math.floor(e*n);for(let e=0;;e++){let{from:n,to:i}=t[e],r=i-n;if(s<=r)return n+s;s-=r}}function Hc(e,t){let n=0;for(let{from:s,to:i}of e.ranges){if(t<=i){n+=t-s;break}n+=i-s}return n/e.total}const Yc={toDOM:e=>e,fromDOM:e=>e,scale:1,eq(e){return e==this}};class Kc{constructor(e,t,n){let s=0,i=0,r=0;this.viewports=n.map((({from:n,to:i})=>{let r=t.lineAt(n,Ec.ByPos,e,0,0).top,o=t.lineAt(i,Ec.ByPos,e,0,0).bottom;return s+=o-r,{from:n,to:i,top:r,bottom:o,domTop:0,domBottom:0}})),this.scale=(7e6-s)/(t.height-s);for(let e of this.viewports)e.domTop=r+(e.top-i)*this.scale,r=e.domBottom=e.domTop+(e.bottom-e.top),i=e.bottom}toDOM(e){for(let t=0,n=0,s=0;;t++){let i=t<this.viewports.length?this.viewports[t]:null;if(!i||e<i.top)return s+(e-n)*this.scale;if(e<=i.bottom)return i.domTop+(e-i.top);n=i.bottom,s=i.domBottom}}fromDOM(e){for(let t=0,n=0,s=0;;t++){let i=t<this.viewports.length?this.viewports[t]:null;if(!i||e<i.domTop)return n+(e-s)/this.scale;if(e<=i.domBottom)return i.top+(e-i.domTop);n=i.bottom,s=i.domBottom}}eq(e){return e instanceof Kc&&(this.scale==e.scale&&this.viewports.length==e.viewports.length&&this.viewports.every(((t,n)=>t.from==e.viewports[n].from&&t.to==e.viewports[n].to)))}}function Zc(e,t){if(1==t.scale)return e;let n=t.toDOM(e.top),s=t.toDOM(e.bottom);return new Ac(e.from,e.length,n,s-n,Array.isArray(e._content)?e._content.map((e=>Zc(e,t))):e._content)}const Jc=Ki.define({combine:e=>e.join(' ')}),eh=Ki.define({combine:e=>e.indexOf(!0)>-1}),th=ao.newName(),nh=ao.newName(),sh=ao.newName(),ih={'&light':'.'+nh,'&dark':'.'+sh};function rh(e,t,n){return new ao(t,{finish:t=>/&/.test(t)?t.replace(/&\w*/,(t=>{if('&'==t)return e;if(!n||!n[t])throw new RangeError(`Unsupported selector: ${t}`);return n[t]})):e+' '+t})}const oh=rh('.'+th,{'&':{position:'relative !important',boxSizing:'border-box','&.cm-focused':{outline:'1px dotted #212121'},display:'flex !important',flexDirection:'column'},'.cm-scroller':{display:'flex !important',alignItems:'flex-start !important',fontFamily:'monospace',lineHeight:1.4,height:'100%',overflowX:'auto',position:'relative',zIndex:0,overflowAnchor:'none'},'.cm-content':{margin:0,flexGrow:2,flexShrink:0,display:'block',whiteSpace:'pre',wordWrap:'normal',boxSizing:'border-box',minHeight:'100%',padding:'4px 0',outline:'none','&[contenteditable=true]':{WebkitUserModify:'read-write-plaintext-only'}},'.cm-lineWrapping':{whiteSpace_fallback:'pre-wrap',whiteSpace:'break-spaces',wordBreak:'break-word',overflowWrap:'anywhere',flexShrink:1},'&light .cm-content':{caretColor:'black'},'&dark .cm-content':{caretColor:'white'},'.cm-line':{display:'block',padding:'0 2px 0 6px'},'.cm-layer':{position:'absolute',left:0,top:0,contain:'size style','& > *':{position:'absolute'}},'&light .cm-selectionBackground':{background:'#d9d9d9'},'&dark .cm-selectionBackground':{background:'#222'},'&light.cm-focused > .cm-scroller > .cm-selectionLayer .cm-selectionBackground':{background:'#d7d4f0'},'&dark.cm-focused > .cm-scroller > .cm-selectionLayer .cm-selectionBackground':{background:'#233'},'.cm-cursorLayer':{pointerEvents:'none'},'&.cm-focused > .cm-scroller > .cm-cursorLayer':{animation:'steps(1) cm-blink 1.2s infinite'},'@keyframes cm-blink':{'0%':{},'50%':{opacity:0},'100%':{}},'@keyframes cm-blink2':{'0%':{},'50%':{opacity:0},'100%':{}},'.cm-cursor, .cm-dropCursor':{borderLeft:'1.2px solid black',marginLeft:'-0.6px',pointerEvents:'none'},'.cm-cursor':{display:'none'},'&dark .cm-cursor':{borderLeftColor:'#ddd'},'.cm-dropCursor':{position:'absolute'},'&.cm-focused > .cm-scroller > .cm-cursorLayer .cm-cursor':{display:'block'},'.cm-iso':{unicodeBidi:'isolate'},'.cm-announced':{position:'fixed',top:'-10000px'},'@media print':{'.cm-announced':{display:'none'}},'&light .cm-activeLine':{backgroundColor:'#cceeff44'},'&dark .cm-activeLine':{backgroundColor:'#99eeff33'},'&light .cm-specialChar':{color:'red'},'&dark .cm-specialChar':{color:'#f78'},'.cm-gutters':{flexShrink:0,display:'flex',height:'100%',boxSizing:'border-box',insetInlineStart:0,zIndex:200},'&light .cm-gutters':{backgroundColor:'#f5f5f5',color:'#6c6c6c',borderRight:'1px solid #ddd'},'&dark .cm-gutters':{backgroundColor:'#333338',color:'#ccc'},'.cm-gutter':{display:'flex !important',flexDirection:'column',flexShrink:0,boxSizing:'border-box',minHeight:'100%',overflow:'hidden'},'.cm-gutterElement':{boxSizing:'border-box'},'.cm-lineNumbers .cm-gutterElement':{padding:'0 3px 0 5px',minWidth:'20px',textAlign:'right',whiteSpace:'nowrap'},'&light .cm-activeLineGutter':{backgroundColor:'#e2f2ff'},'&dark .cm-activeLineGutter':{backgroundColor:'#222227'},'.cm-panels':{boxSizing:'border-box',position:'sticky',left:0,right:0,zIndex:300},'&light .cm-panels':{backgroundColor:'#f5f5f5',color:'black'},'&light .cm-panels-top':{borderBottom:'1px solid #ddd'},'&light .cm-panels-bottom':{borderTop:'1px solid #ddd'},'&dark .cm-panels':{backgroundColor:'#333338',color:'white'},'.cm-tab':{display:'inline-block',overflow:'hidden',verticalAlign:'bottom'},'.cm-widgetBuffer':{verticalAlign:'text-top',height:'1em',width:0,display:'inline'},'.cm-placeholder':{color:'#888',display:'inline-block',verticalAlign:'top'},'.cm-highlightSpace':{backgroundImage:'radial-gradient(circle at 50% 55%, #aaa 20%, transparent 5%)',backgroundPosition:'center'},'.cm-highlightTab':{backgroundImage:'url(\'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="20"><path stroke="%23888" stroke-width="1" fill="none" d="M1 10H196L190 5M190 15L196 10M197 4L197 16"/></svg>\')',backgroundSize:'auto 100%',backgroundPosition:'right 90%',backgroundRepeat:'no-repeat'},'.cm-trailingSpace':{backgroundColor:'#ff332255'},'.cm-button':{verticalAlign:'middle',color:'inherit',fontSize:'70%',padding:'.2em 1em',borderRadius:'1px'},'&light .cm-button':{backgroundImage:'linear-gradient(#eff1f5, #d9d9df)',border:'1px solid #888','&:active':{backgroundImage:'linear-gradient(#b4b4b4, #d0d3d6)'}},'&dark .cm-button':{backgroundImage:'linear-gradient(#393939, #111)',border:'1px solid #888','&:active':{backgroundImage:'linear-gradient(#111, #333)'}},'.cm-textfield':{verticalAlign:'middle',color:'inherit',fontSize:'70%',border:'1px solid silver',padding:'.2em .5em'},'&light .cm-textfield':{backgroundColor:'white'},'&dark .cm-textfield':{border:'1px solid #555',backgroundColor:'inherit'}},ih),ah={childList:!0,characterData:!0,subtree:!0,attributes:!0,characterDataOldValue:!0},lh=sa.ie&&sa.ie_version<=11;class ch{constructor(e){this.view=e,this.active=!1,this.editContext=null,this.selectionRange=new $o,this.selectionChanged=!1,this.delayedFlush=-1,this.resizeTimeout=-1,this.queue=[],this.delayedAndroidKey=null,this.flushingAndroidKey=-1,this.lastChange=0,this.scrollTargets=[],this.intersection=null,this.resizeScroll=null,this.intersecting=!1,this.gapIntersection=null,this.gaps=[],this.printQuery=null,this.parentCheck=-1,this.dom=e.contentDOM,this.observer=new MutationObserver((t=>{for(let e of t)this.queue.push(e);(sa.ie&&sa.ie_version<=11||sa.ios&&e.composing)&&t.some((e=>'childList'==e.type&&e.removedNodes.length||'characterData'==e.type&&e.oldValue.length>e.target.nodeValue.length))?this.flushSoon():this.flush()})),!window.EditContext||!1===e.constructor.EDIT_CONTEXT||sa.chrome&&sa.chrome_version<126||(this.editContext=new dh(e),e.state.facet(ul)&&(e.contentDOM.editContext=this.editContext.editContext)),lh&&(this.onCharData=e=>{this.queue.push({target:e.target,type:'characterData',oldValue:e.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this),this.onResize=this.onResize.bind(this),this.onPrint=this.onPrint.bind(this),this.onScroll=this.onScroll.bind(this),window.matchMedia&&(this.printQuery=window.matchMedia('print')),'function'==typeof ResizeObserver&&(this.resizeScroll=new ResizeObserver((()=>{var e;(null===(e=this.view.docView)||void 0===e?void 0:e.lastUpdate)<Date.now()-75&&this.onResize()})),this.resizeScroll.observe(e.scrollDOM)),this.addWindowListeners(this.win=e.win),this.start(),'function'==typeof IntersectionObserver&&(this.intersection=new IntersectionObserver((e=>{this.parentCheck<0&&(this.parentCheck=setTimeout(this.listenForScroll.bind(this),1e3)),e.length>0&&e[e.length-1].intersectionRatio>0!=this.intersecting&&(this.intersecting=!this.intersecting,this.intersecting!=this.view.inView&&this.onScrollChanged(document.createEvent('Event')))}),{threshold:[0,.001]}),this.intersection.observe(this.dom),this.gapIntersection=new IntersectionObserver((e=>{e.length>0&&e[e.length-1].intersectionRatio>0&&this.onScrollChanged(document.createEvent('Event'))}),{})),this.listenForScroll(),this.readSelectionRange()}onScrollChanged(e){this.view.inputState.runHandlers('scroll',e),this.intersecting&&this.view.measure()}onScroll(e){this.intersecting&&this.flush(!1),this.editContext&&this.view.requestMeasure(this.editContext.measureReq),this.onScrollChanged(e)}onResize(){this.resizeTimeout<0&&(this.resizeTimeout=setTimeout((()=>{this.resizeTimeout=-1,this.view.requestMeasure()}),50))}onPrint(e){('change'!=e.type&&e.type||e.matches)&&(this.view.viewState.printing=!0,this.view.measure(),setTimeout((()=>{this.view.viewState.printing=!1,this.view.requestMeasure()}),500))}updateGaps(e){if(this.gapIntersection&&(e.length!=this.gaps.length||this.gaps.some(((t,n)=>t!=e[n])))){this.gapIntersection.disconnect();for(let t of e)this.gapIntersection.observe(t);this.gaps=e}}onSelectionChange(e){let t=this.selectionChanged;if(!this.readSelectionRange()||this.delayedAndroidKey)return;let{view:n}=this,s=this.selectionRange;if(n.state.facet(ul)?n.root.activeElement!=this.dom:!bo(this.dom,s))return;let i=s.anchorNode&&n.docView.nearest(s.anchorNode);i&&i.ignoreEvent(e)?t||(this.selectionChanged=!1):(sa.ie&&sa.ie_version<=11||sa.android&&sa.chrome)&&!n.state.selection.main.empty&&s.focusNode&&_o(s.focusNode,s.focusOffset,s.anchorNode,s.anchorOffset)?this.flushSoon():this.flush(!1)}readSelectionRange(){let{view:e}=this,t=vo(e.root);if(!t)return!1;let n=sa.safari&&11==e.root.nodeType&&e.root.activeElement==this.dom&&function(e,t){if(t.getComposedRanges){let n=t.getComposedRanges(e.root)[0];if(n)return uh(e,n)}let n=null;function s(e){e.preventDefault(),e.stopImmediatePropagation(),n=e.getTargetRanges()[0]}return e.contentDOM.addEventListener('beforeinput',s,!0),e.dom.ownerDocument.execCommand('indent'),e.contentDOM.removeEventListener('beforeinput',s,!0),n?uh(e,n):null}(this.view,t)||t;if(!n||this.selectionRange.eq(n))return!1;let s=bo(this.dom,n);return s&&!this.selectionChanged&&e.inputState.lastFocusTime>Date.now()-200&&e.inputState.lastTouchTime<Date.now()-300&&function(e,t){let n=t.focusNode,s=t.focusOffset;if(!n||t.anchorNode!=n||t.anchorOffset!=s)return!1;for(s=Math.min(s,So(n));;)if(s){if(1!=n.nodeType)return!1;let e=n.childNodes[s-1];'false'==e.contentEditable?s--:(n=e,s=So(n))}else{if(n==e)return!0;s=wo(n),n=n.parentNode}}(this.dom,n)?(this.view.inputState.lastFocusTime=0,e.docView.updateSelection(),!1):(this.selectionRange.setRange(n),s&&(this.selectionChanged=!0),!0)}setSelectionRange(e,t){this.selectionRange.set(e.node,e.offset,t.node,t.offset),this.selectionChanged=!1}clearSelectionRange(){this.selectionRange.set(null,0,null,0)}listenForScroll(){this.parentCheck=-1;let e=0,t=null;for(let n=this.dom;n;)if(1==n.nodeType)!t&&e<this.scrollTargets.length&&this.scrollTargets[e]==n?e++:t||(t=this.scrollTargets.slice(0,e)),t&&t.push(n),n=n.assignedSlot||n.parentNode;else{if(11!=n.nodeType)break;n=n.host}if(e<this.scrollTargets.length&&!t&&(t=this.scrollTargets.slice(0,e)),t){for(let e of this.scrollTargets)e.removeEventListener('scroll',this.onScroll);for(let e of this.scrollTargets=t)e.addEventListener('scroll',this.onScroll)}}ignore(e){if(!this.active)return e();try{return this.stop(),e()}finally{this.start(),this.clear()}}start(){this.active||(this.observer.observe(this.dom,ah),lh&&this.dom.addEventListener('DOMCharacterDataModified',this.onCharData),this.active=!0)}stop(){this.active&&(this.active=!1,this.observer.disconnect(),lh&&this.dom.removeEventListener('DOMCharacterDataModified',this.onCharData))}clear(){this.processRecords(),this.queue.length=0,this.selectionChanged=!1}delayAndroidKey(e,t){var n;if(!this.delayedAndroidKey){let e=()=>{let e=this.delayedAndroidKey;if(e){this.clearDelayedAndroidKey(),this.view.inputState.lastKeyCode=e.keyCode,this.view.inputState.lastKeyTime=Date.now(),!this.flush()&&e.force&&Mo(this.dom,e.key,e.keyCode)}};this.flushingAndroidKey=this.view.win.requestAnimationFrame(e)}this.delayedAndroidKey&&'Enter'!=e||(this.delayedAndroidKey={key:e,keyCode:t,force:this.lastChange<Date.now()-50||!!(null===(n=this.delayedAndroidKey)||void 0===n?void 0:n.force)})}clearDelayedAndroidKey(){this.win.cancelAnimationFrame(this.flushingAndroidKey),this.delayedAndroidKey=null,this.flushingAndroidKey=-1}flushSoon(){this.delayedFlush<0&&(this.delayedFlush=this.view.win.requestAnimationFrame((()=>{this.delayedFlush=-1,this.flush()})))}forceFlush(){this.delayedFlush>=0&&(this.view.win.cancelAnimationFrame(this.delayedFlush),this.delayedFlush=-1),this.flush()}pendingRecords(){for(let e of this.observer.takeRecords())this.queue.push(e);return this.queue}processRecords(){let e=this.pendingRecords();e.length&&(this.queue=[]);let t=-1,n=-1,s=!1;for(let i of e){let e=this.readMutation(i);e&&(e.typeOver&&(s=!0),-1==t?({from:t,to:n}=e):(t=Math.min(e.from,t),n=Math.max(e.to,n)))}return{from:t,to:n,typeOver:s}}readChange(){let{from:e,to:t,typeOver:n}=this.processRecords(),s=this.selectionChanged&&bo(this.dom,this.selectionRange);if(e<0&&!s)return null;e>-1&&(this.lastChange=Date.now()),this.view.inputState.lastFocusTime=0,this.selectionChanged=!1;let i=new ql(this.view,e,t,n);return this.view.docView.domChanged={newSel:i.newSel?i.newSel.main:null},i}flush(e=!0){if(this.delayedFlush>=0||this.delayedAndroidKey)return!1;e&&this.readSelectionRange();let t=this.readChange();if(!t)return this.view.requestMeasure(),!1;let n=this.view.state,s=Hl(this.view,t);return this.view.state==n&&(t.domChanged||t.newSel&&!t.newSel.main.eq(this.view.state.selection.main))&&this.view.update([]),s}readMutation(e){let t=this.view.docView.nearest(e.target);if(!t||t.ignoreMutation(e))return null;if(t.markDirty('attributes'==e.type),'attributes'==e.type&&(t.flags|=4),'childList'==e.type){let n=hh(t,e.previousSibling||e.target.previousSibling,-1),s=hh(t,e.nextSibling||e.target.nextSibling,1);return{from:n?t.posAfter(n):t.posAtStart,to:s?t.posBefore(s):t.posAtEnd,typeOver:!1}}return'characterData'==e.type?{from:t.posAtStart,to:t.posAtEnd,typeOver:e.target.nodeValue==e.oldValue}:null}setWindow(e){e!=this.win&&(this.removeWindowListeners(this.win),this.win=e,this.addWindowListeners(this.win))}addWindowListeners(e){e.addEventListener('resize',this.onResize),this.printQuery?this.printQuery.addEventListener?this.printQuery.addEventListener('change',this.onPrint):this.printQuery.addListener(this.onPrint):e.addEventListener('beforeprint',this.onPrint),e.addEventListener('scroll',this.onScroll),e.document.addEventListener('selectionchange',this.onSelectionChange)}removeWindowListeners(e){e.removeEventListener('scroll',this.onScroll),e.removeEventListener('resize',this.onResize),this.printQuery?this.printQuery.removeEventListener?this.printQuery.removeEventListener('change',this.onPrint):this.printQuery.removeListener(this.onPrint):e.removeEventListener('beforeprint',this.onPrint),e.document.removeEventListener('selectionchange',this.onSelectionChange)}update(e){this.editContext&&(this.editContext.update(e),e.startState.facet(ul)!=e.state.facet(ul)&&(e.view.contentDOM.editContext=e.state.facet(ul)?this.editContext.editContext:null))}destroy(){var e,t,n;this.stop(),null===(e=this.intersection)||void 0===e||e.disconnect(),null===(t=this.gapIntersection)||void 0===t||t.disconnect(),null===(n=this.resizeScroll)||void 0===n||n.disconnect();for(let e of this.scrollTargets)e.removeEventListener('scroll',this.onScroll);this.removeWindowListeners(this.win),clearTimeout(this.parentCheck),clearTimeout(this.resizeTimeout),this.win.cancelAnimationFrame(this.delayedFlush),this.win.cancelAnimationFrame(this.flushingAndroidKey),this.editContext&&(this.view.contentDOM.editContext=null,this.editContext.destroy())}}function hh(e,t,n){for(;t;){let s=zo.get(t);if(s&&s.parent==e)return s;let i=t.parentNode;t=i!=e.dom?i:n>0?t.nextSibling:t.previousSibling}return null}function uh(e,t){let n=t.startContainer,s=t.startOffset,i=t.endContainer,r=t.endOffset,o=e.docView.domAtPos(e.state.selection.main.anchor);return _o(o.node,o.offset,i,r)&&([n,s,i,r]=[i,r,n,s]),{anchorNode:n,anchorOffset:s,focusNode:i,focusOffset:r}}class dh{constructor(e){this.from=0,this.to=0,this.pendingContextChange=null,this.handlers=Object.create(null),this.composing=null,this.resetRange(e.state);let t=this.editContext=new window.EditContext({text:e.state.doc.sliceString(this.from,this.to),selectionStart:this.toContextPos(Math.max(this.from,Math.min(this.to,e.state.selection.main.anchor))),selectionEnd:this.toContextPos(e.state.selection.main.head)});this.handlers.textupdate=t=>{let n=e.state.selection.main,{anchor:s,head:i}=n,r=this.toEditorPos(t.updateRangeStart),o=this.toEditorPos(t.updateRangeEnd);e.inputState.composing>=0&&!this.composing&&(this.composing={contextBase:t.updateRangeStart,editorBase:r,drifted:!1});let a={from:r,to:o,insert:ki.of(t.text.split('\n'))};if(a.from==this.from&&s<this.from?a.from=s:a.to==this.to&&s>this.to&&(a.to=s),a.from!=a.to||a.insert.length){if((sa.mac||sa.android)&&a.from==i-1&&/^\. ?$/.test(t.text)&&'off'==e.contentDOM.getAttribute('autocorrect')&&(a={from:r,to:o,insert:ki.of([t.text.replace('.',' ')])}),this.pendingContextChange=a,!e.state.readOnly){let n=this.to-this.from+(a.to-a.from+a.insert.length);Yl(e,a,qi.single(this.toEditorPos(t.selectionStart,n),this.toEditorPos(t.selectionEnd,n)))}this.pendingContextChange&&(this.revertPending(e.state),this.setSelection(e.state))}else{let s=qi.single(this.toEditorPos(t.selectionStart),this.toEditorPos(t.selectionEnd));s.main.eq(n)||e.dispatch({selection:s,userEvent:'select'})}},this.handlers.characterboundsupdate=n=>{let s=[],i=null;for(let t=this.toEditorPos(n.rangeStart),r=this.toEditorPos(n.rangeEnd);t<r;t++){let n=e.coordsForChar(t);i=n&&new DOMRect(n.left,n.top,n.right-n.left,n.bottom-n.top)||i||new DOMRect,s.push(i)}t.updateCharacterBounds(n.rangeStart,s)},this.handlers.textformatupdate=t=>{let n=[];for(let e of t.getTextFormats()){let t=e.underlineStyle,s=e.underlineThickness;if('None'!=t&&'None'!=s){let i=this.toEditorPos(e.rangeStart),r=this.toEditorPos(e.rangeEnd);if(i<r){let e=`text-decoration: underline ${'Dashed'==t?'dashed ':'Squiggle'==t?'wavy ':''}${'Thin'==s?1:2}px`;n.push(xa.mark({attributes:{style:e}}).range(i,r))}}}e.dispatch({effects:cl.of(xa.set(n))})},this.handlers.compositionstart=()=>{e.inputState.composing<0&&(e.inputState.composing=0,e.inputState.compositionFirstChange=!0)},this.handlers.compositionend=()=>{if(e.inputState.composing=-1,e.inputState.compositionFirstChange=null,this.composing){let{drifted:t}=this.composing;this.composing=null,t&&this.reset(e.state)}};for(let e in this.handlers)t.addEventListener(e,this.handlers[e]);this.measureReq={read:e=>{this.editContext.updateControlBounds(e.contentDOM.getBoundingClientRect());let t=vo(e.root);t&&t.rangeCount&&this.editContext.updateSelectionBounds(t.getRangeAt(0).getBoundingClientRect())}}}applyEdits(e){let t=0,n=!1,s=this.pendingContextChange;return e.changes.iterChanges(((i,r,o,a,l)=>{if(n)return;let c=l.length-(r-i);if(s&&r>=s.to){if(s.from==i&&s.to==r&&s.insert.eq(l))return s=this.pendingContextChange=null,t+=c,void(this.to+=c);s=null,this.revertPending(e.state)}if(i+=t,(r+=t)<=this.from)this.from+=c,this.to+=c;else if(i<this.to){if(i<this.from||r>this.to||this.to-this.from+l.length>3e4)return void(n=!0);this.editContext.updateText(this.toContextPos(i),this.toContextPos(r),l.toString()),this.to+=c}t+=c})),s&&!n&&this.revertPending(e.state),!n}update(e){let t=this.pendingContextChange;this.composing&&(this.composing.drifted||e.transactions.some((e=>!e.isUserEvent('input.type')&&e.changes.touchesRange(this.from,this.to))))?(this.composing.drifted=!0,this.composing.editorBase=e.changes.mapPos(this.composing.editorBase)):this.applyEdits(e)&&this.rangeIsValid(e.state)?(e.docChanged||e.selectionSet||t)&&this.setSelection(e.state):(this.pendingContextChange=null,this.reset(e.state)),(e.geometryChanged||e.docChanged||e.selectionSet)&&e.view.requestMeasure(this.measureReq)}resetRange(e){let{head:t}=e.selection.main;this.from=Math.max(0,t-1e4),this.to=Math.min(e.doc.length,t+1e4)}reset(e){this.resetRange(e),this.editContext.updateText(0,this.editContext.text.length,e.doc.sliceString(this.from,this.to)),this.setSelection(e)}revertPending(e){let t=this.pendingContextChange;this.pendingContextChange=null,this.editContext.updateText(this.toContextPos(t.from),this.toContextPos(t.from+t.insert.length),e.doc.sliceString(t.from,t.to))}setSelection(e){let{main:t}=e.selection,n=this.toContextPos(Math.max(this.from,Math.min(this.to,t.anchor))),s=this.toContextPos(t.head);this.editContext.selectionStart==n&&this.editContext.selectionEnd==s||this.editContext.updateSelection(n,s)}rangeIsValid(e){let{head:t}=e.selection.main;return!(this.from>0&&t-this.from<500||this.to<e.doc.length&&this.to-t<500||this.to-this.from>3e4)}toEditorPos(e,t=this.to-this.from){e=Math.min(e,t);let n=this.composing;return n&&n.drifted?n.editorBase+(e-n.contextBase):e+this.from}toContextPos(e){let t=this.composing;return t&&t.drifted?t.contextBase+(e-t.editorBase):e-this.from}destroy(){for(let e in this.handlers)this.editContext.removeEventListener(e,this.handlers[e])}}class fh{get state(){return this.viewState.state}get viewport(){return this.viewState.viewport}get visibleRanges(){return this.viewState.visibleRanges}get inView(){return this.viewState.inView}get composing(){return this.inputState.composing>0}get compositionStarted(){return this.inputState.composing>=0}get root(){return this._root}get win(){return this.dom.ownerDocument.defaultView||window}constructor(e={}){var t;this.plugins=[],this.pluginMap=new Map,this.editorAttrs={},this.contentAttrs={},this.bidiCache=[],this.destroyed=!1,this.updateState=2,this.measureScheduled=-1,this.measureRequests=[],this.contentDOM=document.createElement('div'),this.scrollDOM=document.createElement('div'),this.scrollDOM.tabIndex=-1,this.scrollDOM.className='cm-scroller',this.scrollDOM.appendChild(this.contentDOM),this.announceDOM=document.createElement('div'),this.announceDOM.className='cm-announced',this.announceDOM.setAttribute('aria-live','polite'),this.dom=document.createElement('div'),this.dom.appendChild(this.announceDOM),this.dom.appendChild(this.scrollDOM),e.parent&&e.parent.appendChild(this.dom);let{dispatch:n}=e;this.dispatchTransactions=e.dispatchTransactions||n&&(e=>e.forEach((e=>n(e,this))))||(e=>this.update(e)),this.dispatch=this.dispatch.bind(this),this._root=e.root||function(e){for(;e;){if(e&&(9==e.nodeType||11==e.nodeType&&e.host))return e;e=e.assignedSlot||e.parentNode}return null}(e.parent)||document,this.viewState=new Xc(e.state||Fr.create(e)),e.scrollTo&&e.scrollTo.is(ll)&&(this.viewState.scrollTarget=e.scrollTo.value.clip(this.viewState.state)),this.plugins=this.state.facet(fl).map((e=>new ml(e)));for(let e of this.plugins)e.update(this);this.observer=new ch(this),this.inputState=new Kl(this),this.inputState.ensureHandlers(this.plugins),this.docView=new Cl(this),this.mountStyles(),this.updateAttrs(),this.updateState=0,this.requestMeasure(),(null===(t=document.fonts)||void 0===t?void 0:t.ready)&&document.fonts.ready.then((()=>this.requestMeasure()))}dispatch(...e){let t=1==e.length&&e[0]instanceof Cr?e:1==e.length&&Array.isArray(e[0])?e[0]:[this.state.update(...e)];this.dispatchTransactions(t,this)}update(e){if(0!=this.updateState)throw new Error('Calls to EditorView.update are not allowed while an update is in progress');let t,n=!1,s=!1,i=this.state;for(let t of e){if(t.startState!=i)throw new RangeError('Trying to update state with a transaction that doesn\'t start from the previous state.');i=t.state}if(this.destroyed)return void(this.viewState.state=i);let r=this.hasFocus,o=0,a=null;e.some((e=>e.annotation(_c)))?(this.inputState.notifiedFocused=r,o=1):r!=this.inputState.notifiedFocused&&(this.inputState.notifiedFocused=r,a=wc(i,r),a||(o=1));let l=this.observer.delayedAndroidKey,c=null;if(l?(this.observer.clearDelayedAndroidKey(),c=this.observer.readChange(),(c&&!this.state.doc.eq(i.doc)||!this.state.selection.eq(i.selection))&&(c=null)):this.observer.clear(),i.facet(Fr.phrases)!=this.state.facet(Fr.phrases))return this.setState(i);t=Il.create(this,i,e),t.flags|=o;let h=this.viewState.scrollTarget;try{this.updateState=2;for(let t of e){if(h&&(h=h.map(t.changes)),t.scrollIntoView){let{main:e}=t.state.selection;h=new al(e.empty?e:qi.cursor(e.head,e.head>e.anchor?-1:1))}for(let e of t.effects)e.is(ll)&&(h=e.value.clip(this.state))}this.viewState.update(t,h),this.bidiCache=gh.update(this.bidiCache,t.changes),t.empty||(this.updatePlugins(t),this.inputState.update(t)),n=this.docView.update(t),this.state.facet(Sl)!=this.styleModules&&this.mountStyles(),s=this.updateAttrs(),this.showAnnouncements(e),this.docView.updateSelection(n,e.some((e=>e.isUserEvent('select.pointer'))))}finally{this.updateState=0}if(t.startState.facet(Jc)!=t.state.facet(Jc)&&(this.viewState.mustMeasureContent=!0),(n||s||h||this.viewState.mustEnforceCursorAssoc||this.viewState.mustMeasureContent)&&this.requestMeasure(),n&&this.docViewUpdate(),!t.empty)for(let e of this.state.facet(Ja))try{e(t)}catch(e){hl(this.state,e,'update listener')}(a||c)&&Promise.resolve().then((()=>{a&&this.state==a.startState&&this.dispatch(a),c&&!Hl(this,c)&&l.force&&Mo(this.contentDOM,l.key,l.keyCode)}))}setState(e){if(0!=this.updateState)throw new Error('Calls to EditorView.setState are not allowed while an update is in progress');if(this.destroyed)return void(this.viewState.state=e);this.updateState=2;let t=this.hasFocus;try{for(let e of this.plugins)e.destroy(this);this.viewState=new Xc(e),this.plugins=e.facet(fl).map((e=>new ml(e))),this.pluginMap.clear();for(let e of this.plugins)e.update(this);this.docView.destroy(),this.docView=new Cl(this),this.inputState.ensureHandlers(this.plugins),this.mountStyles(),this.updateAttrs(),this.bidiCache=[]}finally{this.updateState=0}t&&this.focus(),this.requestMeasure()}updatePlugins(e){let t=e.startState.facet(fl),n=e.state.facet(fl);if(t!=n){let s=[];for(let i of n){let n=t.indexOf(i);if(n<0)s.push(new ml(i));else{let t=this.plugins[n];t.mustUpdate=e,s.push(t)}}for(let t of this.plugins)t.mustUpdate!=e&&t.destroy(this);this.plugins=s,this.pluginMap.clear()}else for(let t of this.plugins)t.mustUpdate=e;for(let e=0;e<this.plugins.length;e++)this.plugins[e].update(this);t!=n&&this.inputState.ensureHandlers(this.plugins)}docViewUpdate(){for(let e of this.plugins){let t=e.value;if(t&&t.docViewUpdate)try{t.docViewUpdate(this)}catch(e){hl(this.state,e,'doc view update listener')}}}measure(e=!0){if(this.destroyed)return;if(this.measureScheduled>-1&&this.win.cancelAnimationFrame(this.measureScheduled),this.observer.delayedAndroidKey)return this.measureScheduled=-1,void this.requestMeasure();this.measureScheduled=0,e&&this.observer.forceFlush();let t=null,n=this.scrollDOM,s=n.scrollTop*this.scaleY,{scrollAnchorPos:i,scrollAnchorHeight:r}=this.viewState;Math.abs(s-this.viewState.scrollTop)>1&&(r=-1),this.viewState.scrollAnchorHeight=-1;try{for(let e=0;;e++){if(r<0)if(Bo(n))i=-1,r=this.viewState.heightMap.height;else{let e=this.viewState.scrollAnchorAt(s);i=e.from,r=e.top}this.updateState=1;let o=this.viewState.measure(this);if(!o&&!this.measureRequests.length&&null==this.viewState.scrollTarget)break;if(e>5){console.warn(this.measureRequests.length?'Measure loop restarted more than 5 times':'Viewport failed to stabilize');break}let a=[];4&o||([this.measureRequests,a]=[a,this.measureRequests]);let l=a.map((e=>{try{return e.read(this)}catch(e){return hl(this.state,e),mh}})),c=Il.create(this,this.state,[]),h=!1;c.flags|=o,t?t.flags|=o:t=c,this.updateState=2,c.empty||(this.updatePlugins(c),this.inputState.update(c),this.updateAttrs(),h=this.docView.update(c),h&&this.docViewUpdate());for(let e=0;e<a.length;e++)if(l[e]!=mh)try{let t=a[e];t.write&&t.write(l[e],this)}catch(e){hl(this.state,e)}if(h&&this.docView.updateSelection(!0),!c.viewportChanged&&0==this.measureRequests.length){if(this.viewState.editorHeight){if(this.viewState.scrollTarget){this.docView.scrollIntoView(this.viewState.scrollTarget),this.viewState.scrollTarget=null,r=-1;continue}{let e=(i<0?this.viewState.heightMap.height:this.viewState.lineBlockAt(i).top)-r;if(e>1||e<-1){s+=e,n.scrollTop=s/this.scaleY,r=-1;continue}}}break}}}finally{this.updateState=0,this.measureScheduled=-1}if(t&&!t.empty)for(let e of this.state.facet(Ja))e(t)}get themeClasses(){return th+' '+(this.state.facet(eh)?sh:nh)+' '+this.state.facet(Jc)}updateAttrs(){let e=vh(this,gl,{class:'cm-editor'+(this.hasFocus?' cm-focused ':' ')+this.themeClasses}),t={spellcheck:'false',autocorrect:'off',autocapitalize:'off',writingsuggestions:'false',translate:'no',contenteditable:this.state.facet(ul)?'true':'false',class:'cm-content',style:`${sa.tabSize}: ${this.state.tabSize}`,role:'textbox','aria-multiline':'true'};this.state.readOnly&&(t['aria-readonly']='true'),vh(this,vl,t);let n=this.observer.ignore((()=>{let n=pa(this.contentDOM,this.contentAttrs,t),s=pa(this.dom,this.editorAttrs,e);return n||s}));return this.editorAttrs=e,this.contentAttrs=t,n}showAnnouncements(e){let t=!0;for(let n of e)for(let e of n.effects)if(e.is(fh.announce)){t&&(this.announceDOM.textContent=''),t=!1,this.announceDOM.appendChild(document.createElement('div')).textContent=e.value}}mountStyles(){this.styleModules=this.state.facet(Sl);let e=this.state.facet(fh.cspNonce);ao.mount(this.root,this.styleModules.concat(oh).reverse(),e?{nonce:e}:void 0)}readMeasured(){if(2==this.updateState)throw new Error('Reading the editor layout isn\'t allowed during an update');0==this.updateState&&this.measureScheduled>-1&&this.measure(!1)}requestMeasure(e){if(this.measureScheduled<0&&(this.measureScheduled=this.win.requestAnimationFrame((()=>this.measure()))),e){if(this.measureRequests.indexOf(e)>-1)return;if(null!=e.key)for(let t=0;t<this.measureRequests.length;t++)if(this.measureRequests[t].key===e.key)return void(this.measureRequests[t]=e);this.measureRequests.push(e)}}plugin(e){let t=this.pluginMap.get(e);return(void 0===t||t&&t.spec!=e)&&this.pluginMap.set(e,t=this.plugins.find((t=>t.spec==e))||null),t&&t.update(this).value}get documentTop(){return this.contentDOM.getBoundingClientRect().top+this.viewState.paddingTop}get documentPadding(){return{top:this.viewState.paddingTop,bottom:this.viewState.paddingBottom}}get scaleX(){return this.viewState.scaleX}get scaleY(){return this.viewState.scaleY}elementAtHeight(e){return this.readMeasured(),this.viewState.elementAtHeight(e)}lineBlockAtHeight(e){return this.readMeasured(),this.viewState.lineBlockAtHeight(e)}get viewportLineBlocks(){return this.viewState.viewportLines}lineBlockAt(e){return this.viewState.lineBlockAt(e)}get contentHeight(){return this.viewState.contentHeight}moveByChar(e,t,n){return Wl(this,e,zl(this,e,t,n))}moveByGroup(e,t){return Wl(this,e,zl(this,e,t,(t=>function(e,t,n){let s=e.state.charCategorizer(t),i=s(n);return e=>{let t=s(e);return i==Lr.Space&&(i=t),i==t}}(this,e.head,t))))}visualLineSide(e,t){let n=this.bidiSpans(e),s=this.textDirectionAt(e.from),i=n[t?n.length-1:0];return qi.cursor(i.side(t,s)+e.from,i.forward(!t,s)?1:-1)}moveToLineBoundary(e,t,n=!0){return function(e,t,n,s){let i=Vl(e,t.head),r=s&&i.type==va.Text&&(e.lineWrapping||i.widgetLineBreaks)?e.coordsAtPos(t.assoc<0&&t.head>i.from?t.head-1:t.head):null;if(r){let t=e.dom.getBoundingClientRect(),s=e.textDirectionAt(i.from),o=e.posAtCoords({x:n==(s==Aa.LTR)?t.right-1:t.left+1,y:(r.top+r.bottom)/2});if(null!=o)return qi.cursor(o,n?-1:1)}return qi.cursor(n?i.to:i.from,n?-1:1)}(this,e,t,n)}moveVertically(e,t,n){return Wl(this,e,function(e,t,n,s){let i=t.head,r=n?1:-1;if(i==(n?e.state.doc.length:0))return qi.cursor(i,t.assoc);let o,a=t.goalColumn,l=e.contentDOM.getBoundingClientRect(),c=e.coordsAtPos(i,t.assoc||-1),h=e.documentTop;if(c)null==a&&(a=c.left-l.left),o=r<0?c.top:c.bottom;else{let t=e.viewState.lineBlockAt(i);null==a&&(a=Math.min(l.right-l.left,e.defaultCharacterWidth*(i-t.from))),o=(r<0?t.top:t.bottom)+h}let u=l.left+a,d=null!=s?s:e.viewState.heightOracle.textHeight>>1;for(let t=0;;t+=10){let n=o+(d+t)*r,s=Rl(e,{x:u,y:n},!1,r);if(n<l.top||n>l.bottom||(r<0?s<i:s>i)){let t=e.docView.coordsForChar(s),i=!t||n<t.top?-1:1;return qi.cursor(s,i,void 0,a)}}}(this,e,t,n))}domAtPos(e){return this.docView.domAtPos(e)}posAtDOM(e,t=0){return this.docView.posFromDOM(e,t)}posAtCoords(e,t=!0){return this.readMeasured(),Rl(this,e,t)}coordsAtPos(e,t=1){this.readMeasured();let n=this.docView.coordsAt(e,t);if(!n||n.left==n.right)return n;let s=this.state.doc.lineAt(e),i=this.bidiSpans(s);return To(n,i[Va.find(i,e-s.from,-1,t)].dir==Aa.LTR==t>0)}coordsForChar(e){return this.readMeasured(),this.docView.coordsForChar(e)}get defaultCharacterWidth(){return this.viewState.heightOracle.charWidth}get defaultLineHeight(){return this.viewState.heightOracle.lineHeight}get textDirection(){return this.viewState.defaultTextDirection}textDirectionAt(e){return!this.state.facet(il)||e<this.viewport.from||e>this.viewport.to?this.textDirection:(this.readMeasured(),this.docView.textDirectionAt(e))}get lineWrapping(){return this.viewState.heightOracle.lineWrapping}bidiSpans(e){if(e.length>ph)return ja(e.length);let t,n=this.textDirectionAt(e.from);for(let s of this.bidiCache)if(s.from==e.from&&s.dir==n&&(s.fresh||za(s.isolates,t=wl(this,e))))return s.order;t||(t=wl(this,e));let s=function(e,t,n){if(!e)return[new Va(0,0,t==Pa?1:0)];if(t==Ea&&!n.length&&!Fa.test(e))return ja(e.length);if(n.length)for(;e.length>Ua.length;)Ua[Ua.length]=256;let s=[],i=t==Ea?0:1;return Qa(e,i,i,n,0,e.length,s),s}(e.text,n,t);return this.bidiCache.push(new gh(e.from,e.to,n,t,!0,s)),s}get hasFocus(){var e;return(this.dom.ownerDocument.hasFocus()||sa.safari&&(null===(e=this.inputState)||void 0===e?void 0:e.lastContextMenu)>Date.now()-3e4)&&this.root.activeElement==this.contentDOM}focus(){this.observer.ignore((()=>{Po(this.contentDOM),this.docView.updateSelection()}))}setRoot(e){this._root!=e&&(this._root=e,this.observer.setWindow((9==e.nodeType?e:e.ownerDocument).defaultView||window),this.mountStyles())}destroy(){this.root.activeElement==this.contentDOM&&this.contentDOM.blur();for(let e of this.plugins)e.destroy(this);this.plugins=[],this.inputState.destroy(),this.docView.destroy(),this.dom.remove(),this.observer.destroy(),this.measureScheduled>-1&&this.win.cancelAnimationFrame(this.measureScheduled),this.destroyed=!0}static scrollIntoView(e,t={}){return ll.of(new al('number'==typeof e?qi.cursor(e):e,t.y,t.x,t.yMargin,t.xMargin))}scrollSnapshot(){let{scrollTop:e,scrollLeft:t}=this.scrollDOM,n=this.viewState.scrollAnchorAt(e);return ll.of(new al(qi.cursor(n.from),'start','start',n.top-e,t,!0))}setTabFocusMode(e){null==e?this.inputState.tabFocusMode=this.inputState.tabFocusMode<0?0:-1:'boolean'==typeof e?this.inputState.tabFocusMode=e?0:-1:0!=this.inputState.tabFocusMode&&(this.inputState.tabFocusMode=Date.now()+e)}static domEventHandlers(e){return pl.define((()=>({})),{eventHandlers:e})}static domEventObservers(e){return pl.define((()=>({})),{eventObservers:e})}static theme(e,t){let n=ao.newName(),s=[Jc.of(n),Sl.of(rh(`.${n}`,e))];return t&&t.dark&&s.push(eh.of(!0)),s}static baseTheme(e){return hr.lowest(Sl.of(rh('.'+th,e,ih)))}static findFromDOM(e){var t;let n=e.querySelector('.cm-content'),s=n&&zo.get(n)||zo.get(e);return(null===(t=null==s?void 0:s.rootView)||void 0===t?void 0:t.view)||null}}fh.styleModule=Sl,fh.inputHandler=el,fh.clipboardInputFilter=nl,fh.clipboardOutputFilter=sl,fh.scrollHandler=ol,fh.focusChangeEffect=tl,fh.perLineTextDirection=il,fh.exceptionSink=Za,fh.updateListener=Ja,fh.editable=ul,fh.mouseSelectionStyle=Ka,fh.dragMovesSelection=Ya,fh.clickAddsSelectionRange=Ha,fh.decorations=xl,fh.outerDecorations=bl,fh.atomicRanges=yl,fh.bidiIsolatedRanges=_l,fh.scrollMargins=kl,fh.darkTheme=eh,fh.cspNonce=Ki.define({combine:e=>e.length?e[0]:''}),fh.contentAttributes=vl,fh.editorAttributes=gl,fh.lineWrapping=fh.contentAttributes.of({class:'cm-lineWrapping'}),fh.announce=Ir.define();const ph=4096,mh={};class gh{constructor(e,t,n,s,i,r){this.from=e,this.to=t,this.dir=n,this.isolates=s,this.fresh=i,this.order=r}static update(e,t){if(t.empty&&!e.some((e=>e.fresh)))return e;let n=[],s=e.length?e[e.length-1].dir:Aa.LTR;for(let i=Math.max(0,e.length-10);i<e.length;i++){let r=e[i];r.dir!=s||t.touchesRange(r.from,r.to)||n.push(new gh(t.mapPos(r.from,1),t.mapPos(r.to,-1),r.dir,r.isolates,!1,r.order))}return n}}function vh(e,t,n){for(let s=e.state.facet(t),i=s.length-1;i>=0;i--){let t=s[i],r='function'==typeof t?t(e):t;r&&ua(r,n)}return n}const xh=sa.mac?'mac':sa.windows?'win':sa.linux?'linux':'key';function bh(e,t,n){return t.altKey&&(e='Alt-'+e),t.ctrlKey&&(e='Ctrl-'+e),t.metaKey&&(e='Meta-'+e),!1!==n&&t.shiftKey&&(e='Shift-'+e),e}const yh=hr.default(fh.domEventHandlers({keydown:(e,t)=>Ih(kh(t.state),e,t,'editor')})),_h=Ki.define({enables:yh}),wh=new WeakMap;function kh(e){let t=e.facet(_h),n=wh.get(t);return n||wh.set(t,n=function(e,t=xh){let n=Object.create(null),s=Object.create(null),i=(e,t)=>{let n=s[e];if(null==n)s[e]=t;else if(n!=t)throw new Error('Key binding '+e+' is used both as a regular binding and as a multi-stroke prefix')},r=(e,s,r,o,a)=>{var l,c;let h=n[e]||(n[e]=Object.create(null)),u=s.split(/ (?!$)/).map((e=>function(e,t){const n=e.split(/-(?!$)/);let s,i,r,o,a=n[n.length-1];'Space'==a&&(a=' ');for(let e=0;e<n.length-1;++e){const a=n[e];if(/^(cmd|meta|m)$/i.test(a))o=!0;else if(/^a(lt)?$/i.test(a))s=!0;else if(/^(c|ctrl|control)$/i.test(a))i=!0;else if(/^s(hift)?$/i.test(a))r=!0;else{if(!/^mod$/i.test(a))throw new Error('Unrecognized modifier name: '+a);'mac'==t?o=!0:i=!0}}return s&&(a='Alt-'+a),i&&(a='Ctrl-'+a),o&&(a='Meta-'+a),r&&(a='Shift-'+a),a}(e,t)));for(let t=1;t<u.length;t++){let n=u.slice(0,t).join(' ');i(n,!0),h[n]||(h[n]={preventDefault:!0,stopPropagation:!1,run:[t=>{let s=Oh={view:t,prefix:n,scope:e};return setTimeout((()=>{Oh==s&&(Oh=null)}),Sh),!0}]})}let d=u.join(' ');i(d,!1);let f=h[d]||(h[d]={preventDefault:!1,stopPropagation:!1,run:(null===(c=null===(l=h._any)||void 0===l?void 0:l.run)||void 0===c?void 0:c.slice())||[]});r&&f.run.push(r),o&&(f.preventDefault=!0),a&&(f.stopPropagation=!0)};for(let s of e){let e=s.scope?s.scope.split(' '):['editor'];if(s.any)for(let t of e){let e=n[t]||(n[t]=Object.create(null));e._any||(e._any={preventDefault:!1,stopPropagation:!1,run:[]});let{any:i}=s;for(let t in e)e[t].run.push((e=>i(e,Th)))}let i=s[t]||s.key;if(i)for(let t of e)r(t,i,s.run,s.preventDefault,s.stopPropagation),s.shift&&r(t,'Shift-'+i,s.shift,s.preventDefault,s.stopPropagation)}return n}(t.reduce(((e,t)=>e.concat(t)),[]))),n}let Oh=null;const Sh=4e3;let Th=null;function Ih(e,t,n,s){Th=t;let i=function(e){var t=!(fo&&e.metaKey&&e.shiftKey&&!e.ctrlKey&&!e.altKey||po&&e.shiftKey&&e.key&&1==e.key.length||'Unidentified'==e.key)&&e.key||(e.shiftKey?uo:ho)[e.keyCode]||e.key||'Unidentified';return'Esc'==t&&(t='Escape'),'Del'==t&&(t='Delete'),'Left'==t&&(t='ArrowLeft'),'Up'==t&&(t='ArrowUp'),'Right'==t&&(t='ArrowRight'),'Down'==t&&(t='ArrowDown'),t}(t),r=Bi(Mi(i,0))==i.length&&' '!=i,o='',a=!1,l=!1,c=!1;Oh&&Oh.view==n&&Oh.scope==s&&(o=Oh.prefix+' ',nc.indexOf(t.keyCode)<0&&(l=!0,Oh=null));let h,u,d=new Set,f=e=>{if(e){for(let t of e.run)if(!d.has(t)&&(d.add(t),t(n)))return e.stopPropagation&&(c=!0),!0;e.preventDefault&&(e.stopPropagation&&(c=!0),l=!0)}return!1},p=e[s];return p&&(f(p[o+bh(i,t,!r)])?a=!0:r&&(t.altKey||t.metaKey||t.ctrlKey)&&!(sa.windows&&t.ctrlKey&&t.altKey)&&(h=ho[t.keyCode])&&h!=i?(f(p[o+bh(h,t,!0)])||t.shiftKey&&(u=uo[t.keyCode])!=i&&u!=h&&f(p[o+bh(u,t,!1)]))&&(a=!0):r&&t.shiftKey&&f(p[o+bh(i,t,!0)])&&(a=!0),!a&&f(p._any)&&(a=!0)),l&&(a=!0),a&&c&&t.stopPropagation(),Th=null,a}class Ch{constructor(e,t,n,s,i){this.className=e,this.left=t,this.top=n,this.width=s,this.height=i}draw(){let e=document.createElement('div');return e.className=this.className,this.adjust(e),e}update(e,t){return t.className==this.className&&(this.adjust(e),!0)}adjust(e){e.style.left=this.left+'px',e.style.top=this.top+'px',null!=this.width&&(e.style.width=this.width+'px'),e.style.height=this.height+'px'}eq(e){return this.left==e.left&&this.top==e.top&&this.width==e.width&&this.height==e.height&&this.className==e.className}static forRange(e,t,n){if(n.empty){let s=e.coordsAtPos(n.head,n.assoc||1);if(!s)return[];let i=$h(e);return[new Ch(t,s.left-i.left,s.top-i.top,null,s.bottom-s.top)]}return function(e,t,n){if(n.to<=e.viewport.from||n.from>=e.viewport.to)return[];let s=Math.max(n.from,e.viewport.from),i=Math.min(n.to,e.viewport.to),r=e.textDirection==Aa.LTR,o=e.contentDOM,a=o.getBoundingClientRect(),l=$h(e),c=o.querySelector('.cm-line'),h=c&&window.getComputedStyle(c),u=a.left+(h?parseInt(h.paddingLeft)+Math.min(0,parseInt(h.textIndent)):0),d=a.right-(h?parseInt(h.paddingRight):0),f=Vl(e,s),p=Vl(e,i),m=f.type==va.Text?f:null,g=p.type==va.Text?p:null;m&&(e.lineWrapping||f.widgetLineBreaks)&&(m=Ah(e,s,1,m));g&&(e.lineWrapping||p.widgetLineBreaks)&&(g=Ah(e,i,-1,g));if(m&&g&&m.from==g.from&&m.to==g.to)return x(b(n.from,n.to,m));{let t=m?b(n.from,null,m):y(f,!1),s=g?b(null,n.to,g):y(p,!0),i=[];return(m||f).to<(g||p).from-(m&&g?1:0)||f.widgetLineBreaks>1&&t.bottom+e.defaultLineHeight/2<s.top?i.push(v(u,t.bottom,d,s.top)):t.bottom<s.top&&e.elementAtHeight((t.bottom+s.top)/2).type==va.Text&&(t.bottom=s.top=(t.bottom+s.top)/2),x(t).concat(i).concat(x(s))}function v(e,n,s,i){return new Ch(t,e-l.left,n-l.top,s-e,i-n)}function x({top:e,bottom:t,horizontal:n}){let s=[];for(let i=0;i<n.length;i+=2)s.push(v(n[i],e,n[i+1],t));return s}function b(t,n,s){let i=1e9,o=-1e9,a=[];function l(t,n,l,c,h){let f=e.coordsAtPos(t,t==s.to?-2:2),p=e.coordsAtPos(l,l==s.from?2:-2);f&&p&&(i=Math.min(f.top,p.top,i),o=Math.max(f.bottom,p.bottom,o),h==Aa.LTR?a.push(r&&n?u:f.left,r&&c?d:p.right):a.push(!r&&c?u:p.left,!r&&n?d:f.right))}let c=null!=t?t:s.from,h=null!=n?n:s.to;for(let s of e.visibleRanges)if(s.to>c&&s.from<h)for(let i=Math.max(s.from,c),r=Math.min(s.to,h);;){let s=e.state.doc.lineAt(i);for(let o of e.bidiSpans(s)){let e=o.from+s.from,a=o.to+s.from;if(e>=r)break;a>i&&l(Math.max(e,i),null==t&&e<=c,Math.min(a,r),null==n&&a>=h,o.dir)}if(i=s.to+1,i>=r)break}return 0==a.length&&l(c,null==t,h,null==n,e.textDirection),{top:i,bottom:o,horizontal:a}}function y(e,t){let n=a.top+(t?e.top:e.bottom);return{top:n,bottom:n,horizontal:[]}}}(e,t,n)}}function $h(e){let t=e.scrollDOM.getBoundingClientRect();return{left:(e.textDirection==Aa.LTR?t.left:t.right-e.scrollDOM.clientWidth*e.scaleX)-e.scrollDOM.scrollLeft*e.scaleX,top:t.top-e.scrollDOM.scrollTop*e.scaleY}}function Ah(e,t,n,s){let i=e.coordsAtPos(t,2*n);if(!i)return s;let r=e.dom.getBoundingClientRect(),o=(i.top+i.bottom)/2,a=e.posAtCoords({x:r.left+1,y:o}),l=e.posAtCoords({x:r.right-1,y:o});return null==a||null==l?s:{from:Math.max(s.from,Math.min(a,l)),to:Math.min(s.to,Math.max(a,l))}}class Eh{constructor(e,t){this.view=e,this.layer=t,this.drawn=[],this.scaleX=1,this.scaleY=1,this.measureReq={read:this.measure.bind(this),write:this.draw.bind(this)},this.dom=e.scrollDOM.appendChild(document.createElement('div')),this.dom.classList.add('cm-layer'),t.above&&this.dom.classList.add('cm-layer-above'),t.class&&this.dom.classList.add(t.class),this.scale(),this.dom.setAttribute('aria-hidden','true'),this.setOrder(e.state),e.requestMeasure(this.measureReq),t.mount&&t.mount(this.dom,e)}update(e){e.startState.facet(Ph)!=e.state.facet(Ph)&&this.setOrder(e.state),(this.layer.update(e,this.dom)||e.geometryChanged)&&(this.scale(),e.view.requestMeasure(this.measureReq))}docViewUpdate(e){!1!==this.layer.updateOnDocViewUpdate&&e.requestMeasure(this.measureReq)}setOrder(e){let t=0,n=e.facet(Ph);for(;t<n.length&&n[t]!=this.layer;)t++;this.dom.style.zIndex=String((this.layer.above?150:-1)-t)}measure(){return this.layer.markers(this.view)}scale(){let{scaleX:e,scaleY:t}=this.view;e==this.scaleX&&t==this.scaleY||(this.scaleX=e,this.scaleY=t,this.dom.style.transform=`scale(${1/e}, ${1/t})`)}draw(e){if(e.length!=this.drawn.length||e.some(((e,t)=>{return n=e,s=this.drawn[t],!(n.constructor==s.constructor&&n.eq(s));var n,s}))){let t=this.dom.firstChild,n=0;for(let s of e)s.update&&t&&s.constructor&&this.drawn[n].constructor&&s.update(t,this.drawn[n])?(t=t.nextSibling,n++):this.dom.insertBefore(s.draw(),t);for(;t;){let e=t.nextSibling;t.remove(),t=e}this.drawn=e}}destroy(){this.layer.destroy&&this.layer.destroy(this.dom,this.view),this.dom.remove()}}const Ph=Ki.define();function Dh(e){return[pl.define((t=>new Eh(t,e))),Ph.of(e)]}const Mh=!(sa.ios&&sa.webkit&&sa.webkit_version<534),Lh=Ki.define({combine:e=>Vr(e,{cursorBlinkRate:1200,drawRangeCursor:!0},{cursorBlinkRate:(e,t)=>Math.min(e,t),drawRangeCursor:(e,t)=>e||t})});function Bh(e={}){return[Lh.of(e),Rh,Vh,Uh,rl.of(!0)]}function Nh(e){return e.startState.facet(Lh)!=e.state.facet(Lh)}const Rh=Dh({above:!0,markers(e){let{state:t}=e,n=t.facet(Lh),s=[];for(let i of t.selection.ranges){let r=i==t.selection.main;if(i.empty?!r||Mh:n.drawRangeCursor){let t=r?'cm-cursor cm-cursor-primary':'cm-cursor cm-cursor-secondary',n=i.empty?i:qi.cursor(i.head,i.head>i.anchor?-1:1);for(let i of Ch.forRange(e,t,n))s.push(i)}}return s},update(e,t){e.transactions.some((e=>e.selection))&&(t.style.animationName='cm-blink'==t.style.animationName?'cm-blink2':'cm-blink');let n=Nh(e);return n&&Fh(e.state,t),e.docChanged||e.selectionSet||n},mount(e,t){Fh(t.state,e)},class:'cm-cursorLayer'});function Fh(e,t){t.style.animationDuration=e.facet(Lh).cursorBlinkRate+'ms'}const Vh=Dh({above:!1,markers:e=>e.state.selection.ranges.map((t=>t.empty?[]:Ch.forRange(e,'cm-selectionBackground',t))).reduce(((e,t)=>e.concat(t))),update:(e,t)=>e.docChanged||e.selectionSet||e.viewportChanged||Nh(e),class:'cm-selectionLayer'}),zh={'.cm-line':{'& ::selection, &::selection':{backgroundColor:'transparent !important'}},'.cm-content':{'& :focus':{caretColor:'initial !important','&::selection, & ::selection':{backgroundColor:'Highlight !important'}}}};Mh&&(zh['.cm-line'].caretColor=zh['.cm-content'].caretColor='transparent !important');const Uh=hr.highest(fh.theme(zh)),Wh=Ir.define({map:(e,t)=>null==e?null:t.mapPos(e)}),Qh=ir.define({create:()=>null,update:(e,t)=>(null!=e&&(e=t.changes.mapPos(e)),t.effects.reduce(((e,t)=>t.is(Wh)?t.value:e),e))}),jh=pl.fromClass(class{constructor(e){this.view=e,this.cursor=null,this.measureReq={read:this.readPos.bind(this),write:this.drawCursor.bind(this)}}update(e){var t;let n=e.state.field(Qh);null==n?null!=this.cursor&&(null===(t=this.cursor)||void 0===t||t.remove(),this.cursor=null):(this.cursor||(this.cursor=this.view.scrollDOM.appendChild(document.createElement('div')),this.cursor.className='cm-dropCursor'),(e.startState.field(Qh)!=n||e.docChanged||e.geometryChanged)&&this.view.requestMeasure(this.measureReq))}readPos(){let{view:e}=this,t=e.state.field(Qh),n=null!=t&&e.coordsAtPos(t);if(!n)return null;let s=e.scrollDOM.getBoundingClientRect();return{left:n.left-s.left+e.scrollDOM.scrollLeft*e.scaleX,top:n.top-s.top+e.scrollDOM.scrollTop*e.scaleY,height:n.bottom-n.top}}drawCursor(e){if(this.cursor){let{scaleX:t,scaleY:n}=this.view;e?(this.cursor.style.left=e.left/t+'px',this.cursor.style.top=e.top/n+'px',this.cursor.style.height=e.height/n+'px'):this.cursor.style.left='-100000px'}}destroy(){this.cursor&&this.cursor.remove()}setDropPos(e){this.view.state.field(Qh)!=e&&this.view.dispatch({effects:Wh.of(e)})}},{eventObservers:{dragover(e){this.setDropPos(this.view.posAtCoords({x:e.clientX,y:e.clientY}))},dragleave(e){e.target!=this.view.contentDOM&&this.view.contentDOM.contains(e.relatedTarget)||this.setDropPos(null)},dragend(){this.setDropPos(null)},drop(){this.setDropPos(null)}}});function Xh(){return[Qh,jh]}function Gh(e,t,n,s,i){t.lastIndex=0;for(let r,o=e.iterRange(n,s),a=n;!o.next().done;a+=o.value.length)if(!o.lineBreak)for(;r=t.exec(o.value);)i(a+r.index,r)}class qh{constructor(e){const{regexp:t,decoration:n,decorate:s,boundary:i,maxLength:r=1e3}=e;if(!t.global)throw new RangeError('The regular expression given to MatchDecorator should have its \'g\' flag set');if(this.regexp=t,s)this.addMatch=(e,t,n,i)=>s(i,n,n+e[0].length,e,t);else if('function'==typeof n)this.addMatch=(e,t,s,i)=>{let r=n(e,t,s);r&&i(s,s+e[0].length,r)};else{if(!n)throw new RangeError('Either \'decorate\' or \'decoration\' should be provided to MatchDecorator');this.addMatch=(e,t,s,i)=>i(s,s+e[0].length,n)}this.boundary=i,this.maxLength=r}createDeco(e){let t=new Xr,n=t.add.bind(t);for(let{from:t,to:s}of function(e,t){let n=e.visibleRanges;if(1==n.length&&n[0].from==e.viewport.from&&n[0].to==e.viewport.to)return n;let s=[];for(let{from:i,to:r}of n)i=Math.max(e.state.doc.lineAt(i).from,i-t),r=Math.min(e.state.doc.lineAt(r).to,r+t),s.length&&s[s.length-1].to>=i?s[s.length-1].to=r:s.push({from:i,to:r});return s}(e,this.maxLength))Gh(e.state.doc,this.regexp,t,s,((t,s)=>this.addMatch(s,e,t,n)));return t.finish()}updateDeco(e,t){let n=1e9,s=-1;return e.docChanged&&e.changes.iterChanges(((t,i,r,o)=>{o>=e.view.viewport.from&&r<=e.view.viewport.to&&(n=Math.min(r,n),s=Math.max(o,s))})),e.viewportMoved||s-n>1e3?this.createDeco(e.view):s>-1?this.updateRange(e.view,t.map(e.changes),n,s):t}updateRange(e,t,n,s){for(let i of e.visibleRanges){let r=Math.max(i.from,n),o=Math.min(i.to,s);if(o>r){let n=e.state.doc.lineAt(r),s=n.to<o?e.state.doc.lineAt(o):n,a=Math.max(i.from,n.from),l=Math.min(i.to,s.to);if(this.boundary){for(;r>n.from;r--)if(this.boundary.test(n.text[r-1-n.from])){a=r;break}for(;o<s.to;o++)if(this.boundary.test(s.text[o-s.from])){l=o;break}}let c,h=[],u=(e,t,n)=>h.push(n.range(e,t));if(n==s)for(this.regexp.lastIndex=a-n.from;(c=this.regexp.exec(n.text))&&c.index<l-n.from;)this.addMatch(c,e,c.index+n.from,u);else Gh(e.state.doc,this.regexp,a,l,((t,n)=>this.addMatch(n,e,t,u)));t=t.update({filterFrom:a,filterTo:l,filter:(e,t)=>e<a||t>l,add:h})}}return t}}const Hh=null!=/x/.unicode?'gu':'g',Yh=new RegExp('[\0-\b\n--\u2028\u2029\ufeff-]',Hh),Kh={0:'null',7:'bell',8:'backspace',10:'newline',11:'vertical tab',13:'carriage return',27:'escape',8203:'zero width space',8204:'zero width non-joiner',8205:'zero width joiner',8206:'left-to-right mark',8207:'right-to-left mark',8232:'line separator',8237:'left-to-right override',8238:'right-to-left override',8294:'left-to-right isolate',8295:'right-to-left isolate',8297:'pop directional isolate',8233:'paragraph separator',65279:'zero width no-break space',65532:'object replacement'};let Zh=null;const Jh=Ki.define({combine(e){let t=Vr(e,{render:null,specialChars:Yh,addSpecialChars:null});return(t.replaceTabs=!function(){var e;if(null==Zh&&'undefined'!=typeof document&&document.body){let t=document.body.style;Zh=null!=(null!==(e=t.tabSize)&&void 0!==e?e:t.MozTabSize)}return Zh||!1}())&&(t.specialChars=new RegExp('\t|'+t.specialChars.source,Hh)),t.addSpecialChars&&(t.specialChars=new RegExp(t.specialChars.source+'|'+t.addSpecialChars.source,Hh)),t}});function eu(e={}){return[Jh.of(e),tu||(tu=pl.fromClass(class{constructor(e){this.view=e,this.decorations=xa.none,this.decorationCache=Object.create(null),this.decorator=this.makeDecorator(e.state.facet(Jh)),this.decorations=this.decorator.createDeco(e)}makeDecorator(e){return new qh({regexp:e.specialChars,decoration:(t,n,s)=>{let{doc:i}=n.state,r=Mi(t[0],0);if(9==r){let e=i.lineAt(s),t=n.state.tabSize,r=so(e.text,t,s-e.from);return xa.replace({widget:new su((t-r%t)*this.view.defaultCharacterWidth/this.view.scaleX)})}return this.decorationCache[r]||(this.decorationCache[r]=xa.replace({widget:new nu(e,r)}))},boundary:e.replaceTabs?void 0:/[^]/})}update(e){let t=e.state.facet(Jh);e.startState.facet(Jh)!=t?(this.decorator=this.makeDecorator(t),this.decorations=this.decorator.createDeco(e.view)):this.decorations=this.decorator.updateDeco(e,this.decorations)}},{decorations:e=>e.decorations}))]}let tu=null;class nu extends ga{constructor(e,t){super(),this.options=e,this.code=t}eq(e){return e.code==this.code}toDOM(e){let t=function(e){return e>=32?'':10==e?'':String.fromCharCode(9216+e)}(this.code),n=e.state.phrase('Control character')+' '+(Kh[this.code]||'0x'+this.code.toString(16)),s=this.options.render&&this.options.render(this.code,n,t);if(s)return s;let i=document.createElement('span');return i.textContent=t,i.title=n,i.setAttribute('aria-label',n),i.className='cm-specialChar',i}ignoreEvent(){return!1}}class su extends ga{constructor(e){super(),this.width=e}eq(e){return e.width==this.width}toDOM(){let e=document.createElement('span');return e.textContent='\t',e.className='cm-tab',e.style.width=this.width+'px',e}ignoreEvent(){return!1}}const iu={Alt:[18,e=>!!e.altKey],Control:[17,e=>!!e.ctrlKey],Shift:[16,e=>!!e.shiftKey],Meta:[91,e=>!!e.metaKey]},ru={style:'cursor: crosshair'};function ou(e={}){let[t,n]=iu[e.key||'Alt'],s=pl.fromClass(class{constructor(e){this.view=e,this.isDown=!1}set(e){this.isDown!=e&&(this.isDown=e,this.view.update([]))}},{eventObservers:{keydown(e){this.set(e.keyCode==t||n(e))},keyup(e){e.keyCode!=t&&n(e)||this.set(!1)},mousemove(e){this.set(n(e))}}});return[s,fh.contentAttributes.of((e=>{var t;return(null===(t=e.plugin(s))||void 0===t?void 0:t.isDown)?ru:null}))]}const au='-10000px';class lu{constructor(e,t,n,s){this.facet=t,this.createTooltipView=n,this.removeTooltipView=s,this.input=e.state.facet(t),this.tooltips=this.input.filter((e=>e));let i=null;this.tooltipViews=this.tooltips.map((e=>i=n(e,i)))}update(e,t){var n;let s=e.state.facet(this.facet),i=s.filter((e=>e));if(s===this.input){for(let t of this.tooltipViews)t.update&&t.update(e);return!1}let r=[],o=t?[]:null;for(let n=0;n<i.length;n++){let s=i[n],a=-1;if(s){for(let e=0;e<this.tooltips.length;e++){let t=this.tooltips[e];t&&t.create==s.create&&(a=e)}if(a<0)r[n]=this.createTooltipView(s,n?r[n-1]:null),o&&(o[n]=!!s.above);else{let s=r[n]=this.tooltipViews[a];o&&(o[n]=t[a]),s.update&&s.update(e)}}}for(let e of this.tooltipViews)r.indexOf(e)<0&&(this.removeTooltipView(e),null===(n=e.destroy)||void 0===n||n.call(e));return t&&(o.forEach(((e,n)=>t[n]=e)),t.length=o.length),this.input=s,this.tooltips=i,this.tooltipViews=r,!0}}function cu(e){let{win:t}=e;return{top:0,left:0,bottom:t.innerHeight,right:t.innerWidth}}const hu=Ki.define({combine:e=>{var t,n,s;return{position:sa.ios?'absolute':(null===(t=e.find((e=>e.position)))||void 0===t?void 0:t.position)||'fixed',parent:(null===(n=e.find((e=>e.parent)))||void 0===n?void 0:n.parent)||null,tooltipSpace:(null===(s=e.find((e=>e.tooltipSpace)))||void 0===s?void 0:s.tooltipSpace)||cu}}}),uu=new WeakMap,du=pl.fromClass(class{constructor(e){this.view=e,this.above=[],this.inView=!0,this.madeAbsolute=!1,this.lastTransaction=0,this.measureTimeout=-1;let t=e.state.facet(hu);this.position=t.position,this.parent=t.parent,this.classes=e.themeClasses,this.createContainer(),this.measureReq={read:this.readMeasure.bind(this),write:this.writeMeasure.bind(this),key:this},this.resizeObserver='function'==typeof ResizeObserver?new ResizeObserver((()=>this.measureSoon())):null,this.manager=new lu(e,gu,((e,t)=>this.createTooltip(e,t)),(e=>{this.resizeObserver&&this.resizeObserver.unobserve(e.dom),e.dom.remove()})),this.above=this.manager.tooltips.map((e=>!!e.above)),this.intersectionObserver='function'==typeof IntersectionObserver?new IntersectionObserver((e=>{Date.now()>this.lastTransaction-50&&e.length>0&&e[e.length-1].intersectionRatio<1&&this.measureSoon()}),{threshold:[1]}):null,this.observeIntersection(),e.win.addEventListener('resize',this.measureSoon=this.measureSoon.bind(this)),this.maybeMeasure()}createContainer(){this.parent?(this.container=document.createElement('div'),this.container.style.position='relative',this.container.className=this.view.themeClasses,this.parent.appendChild(this.container)):this.container=this.view.dom}observeIntersection(){if(this.intersectionObserver){this.intersectionObserver.disconnect();for(let e of this.manager.tooltipViews)this.intersectionObserver.observe(e.dom)}}measureSoon(){this.measureTimeout<0&&(this.measureTimeout=setTimeout((()=>{this.measureTimeout=-1,this.maybeMeasure()}),50))}update(e){e.transactions.length&&(this.lastTransaction=Date.now());let t=this.manager.update(e,this.above);t&&this.observeIntersection();let n=t||e.geometryChanged,s=e.state.facet(hu);if(s.position!=this.position&&!this.madeAbsolute){this.position=s.position;for(let e of this.manager.tooltipViews)e.dom.style.position=this.position;n=!0}if(s.parent!=this.parent){this.parent&&this.container.remove(),this.parent=s.parent,this.createContainer();for(let e of this.manager.tooltipViews)this.container.appendChild(e.dom);n=!0}else this.parent&&this.view.themeClasses!=this.classes&&(this.classes=this.container.className=this.view.themeClasses);n&&this.maybeMeasure()}createTooltip(e,t){let n=e.create(this.view),s=t?t.dom:null;if(n.dom.classList.add('cm-tooltip'),e.arrow&&!n.dom.querySelector('.cm-tooltip > .cm-tooltip-arrow')){let e=document.createElement('div');e.className='cm-tooltip-arrow',n.dom.appendChild(e)}return n.dom.style.position=this.position,n.dom.style.top=au,n.dom.style.left='0px',this.container.insertBefore(n.dom,s),n.mount&&n.mount(this.view),this.resizeObserver&&this.resizeObserver.observe(n.dom),n}destroy(){var e,t,n;this.view.win.removeEventListener('resize',this.measureSoon);for(let t of this.manager.tooltipViews)t.dom.remove(),null===(e=t.destroy)||void 0===e||e.call(t);this.parent&&this.container.remove(),null===(t=this.resizeObserver)||void 0===t||t.disconnect(),null===(n=this.intersectionObserver)||void 0===n||n.disconnect(),clearTimeout(this.measureTimeout)}readMeasure(){let e=1,t=1,n=!1;if('fixed'==this.position&&this.manager.tooltipViews.length){let{dom:e}=this.manager.tooltipViews[0];if(sa.gecko)n=e.offsetParent!=this.container.ownerDocument.body;else if(e.style.top==au&&'0px'==e.style.left){let t=e.getBoundingClientRect();n=Math.abs(t.top+1e4)>1||Math.abs(t.left)>1}}if(n||'absolute'==this.position)if(this.parent){let n=this.parent.getBoundingClientRect();n.width&&n.height&&(e=n.width/this.parent.offsetWidth,t=n.height/this.parent.offsetHeight)}else({scaleX:e,scaleY:t}=this.view.viewState);let s=this.view.scrollDOM.getBoundingClientRect(),i=Ol(this.view);return{visible:{left:s.left+i.left,top:s.top+i.top,right:s.right-i.right,bottom:s.bottom-i.bottom},parent:this.parent?this.container.getBoundingClientRect():this.view.dom.getBoundingClientRect(),pos:this.manager.tooltips.map(((e,t)=>{let n=this.manager.tooltipViews[t];return n.getCoords?n.getCoords(e.pos):this.view.coordsAtPos(e.pos)})),size:this.manager.tooltipViews.map((({dom:e})=>e.getBoundingClientRect())),space:this.view.state.facet(hu).tooltipSpace(this.view),scaleX:e,scaleY:t,makeAbsolute:n}}writeMeasure(e){var t;if(e.makeAbsolute){this.madeAbsolute=!0,this.position='absolute';for(let e of this.manager.tooltipViews)e.dom.style.position='absolute'}let{visible:n,space:s,scaleX:i,scaleY:r}=e,o=[];for(let a=0;a<this.manager.tooltips.length;a++){let l=this.manager.tooltips[a],c=this.manager.tooltipViews[a],{dom:h}=c,u=e.pos[a],d=e.size[a];if(!u||!1!==l.clip&&(u.bottom<=Math.max(n.top,s.top)||u.top>=Math.min(n.bottom,s.bottom)||u.right<Math.max(n.left,s.left)-.1||u.left>Math.min(n.right,s.right)+.1)){h.style.top=au;continue}let f=l.arrow?c.dom.querySelector('.cm-tooltip-arrow'):null,p=f?7:0,m=d.right-d.left,g=null!==(t=uu.get(c))&&void 0!==t?t:d.bottom-d.top,v=c.offset||mu,x=this.view.textDirection==Aa.LTR,b=d.width>s.right-s.left?x?s.left:s.right-d.width:x?Math.max(s.left,Math.min(u.left-(f?14:0)+v.x,s.right-m)):Math.min(Math.max(s.left,u.left-m+(f?14:0)-v.x),s.right-m),y=this.above[a];!l.strictSide&&(y?u.top-g-p-v.y<s.top:u.bottom+g+p+v.y>s.bottom)&&y==s.bottom-u.bottom>u.top-s.top&&(y=this.above[a]=!y);let _=(y?u.top-s.top:s.bottom-u.bottom)-p;if(_<g&&!1!==c.resize){if(_<this.view.defaultLineHeight){h.style.top=au;continue}uu.set(c,g),h.style.height=(g=_)/r+'px'}else h.style.height&&(h.style.height='');let w=y?u.top-g-p-v.y:u.bottom+p+v.y,k=b+m;if(!0!==c.overlap)for(let e of o)e.left<k&&e.right>b&&e.top<w+g&&e.bottom>w&&(w=y?e.top-g-2-p:e.bottom+p+2);if('absolute'==this.position?(h.style.top=(w-e.parent.top)/r+'px',fu(h,(b-e.parent.left)/i)):(h.style.top=w/r+'px',fu(h,b/i)),f){let e=u.left+(x?v.x:-v.x)-(b+14-7);f.style.left=e/i+'px'}!0!==c.overlap&&o.push({left:b,top:w,right:k,bottom:w+g}),h.classList.toggle('cm-tooltip-above',y),h.classList.toggle('cm-tooltip-below',!y),c.positioned&&c.positioned(e.space)}}maybeMeasure(){if(this.manager.tooltips.length&&(this.view.inView&&this.view.requestMeasure(this.measureReq),this.inView!=this.view.inView&&(this.inView=this.view.inView,!this.inView)))for(let e of this.manager.tooltipViews)e.dom.style.top=au}},{eventObservers:{scroll(){this.maybeMeasure()}}});function fu(e,t){let n=parseInt(e.style.left,10);(isNaN(n)||Math.abs(t-n)>1)&&(e.style.left=t+'px')}const pu=fh.baseTheme({'.cm-tooltip':{zIndex:500,boxSizing:'border-box'},'&light .cm-tooltip':{border:'1px solid #bbb',backgroundColor:'#f5f5f5'},'&light .cm-tooltip-section:not(:first-child)':{borderTop:'1px solid #bbb'},'&dark .cm-tooltip':{backgroundColor:'#333338',color:'white'},'.cm-tooltip-arrow':{height:'7px',width:'14px',position:'absolute',zIndex:-1,overflow:'hidden','&:before, &:after':{content:'\'\'',position:'absolute',width:0,height:0,borderLeft:'7px solid transparent',borderRight:'7px solid transparent'},'.cm-tooltip-above &':{bottom:'-7px','&:before':{borderTop:'7px solid #bbb'},'&:after':{borderTop:'7px solid #f5f5f5',bottom:'1px'}},'.cm-tooltip-below &':{top:'-7px','&:before':{borderBottom:'7px solid #bbb'},'&:after':{borderBottom:'7px solid #f5f5f5',top:'1px'}}},'&dark .cm-tooltip .cm-tooltip-arrow':{'&:before':{borderTopColor:'#333338',borderBottomColor:'#333338'},'&:after':{borderTopColor:'transparent',borderBottomColor:'transparent'}}}),mu={x:0,y:0},gu=Ki.define({enables:[du,pu]}),vu=Ki.define({combine:e=>e.reduce(((e,t)=>e.concat(t)),[])});class xu{static create(e){return new xu(e)}constructor(e){this.view=e,this.mounted=!1,this.dom=document.createElement('div'),this.dom.classList.add('cm-tooltip-hover'),this.manager=new lu(e,vu,((e,t)=>this.createHostedView(e,t)),(e=>e.dom.remove()))}createHostedView(e,t){let n=e.create(this.view);return n.dom.classList.add('cm-tooltip-section'),this.dom.insertBefore(n.dom,t?t.dom.nextSibling:this.dom.firstChild),this.mounted&&n.mount&&n.mount(this.view),n}mount(e){for(let t of this.manager.tooltipViews)t.mount&&t.mount(e);this.mounted=!0}positioned(e){for(let t of this.manager.tooltipViews)t.positioned&&t.positioned(e)}update(e){this.manager.update(e)}destroy(){var e;for(let t of this.manager.tooltipViews)null===(e=t.destroy)||void 0===e||e.call(t)}passProp(e){let t;for(let n of this.manager.tooltipViews){let s=n[e];if(void 0!==s)if(void 0===t)t=s;else if(t!==s)return}return t}get offset(){return this.passProp('offset')}get getCoords(){return this.passProp('getCoords')}get overlap(){return this.passProp('overlap')}get resize(){return this.passProp('resize')}}const bu=gu.compute([vu],(e=>{let t=e.facet(vu);return 0===t.length?null:{pos:Math.min(...t.map((e=>e.pos))),end:Math.max(...t.map((e=>{var t;return null!==(t=e.end)&&void 0!==t?t:e.pos}))),create:xu.create,above:t[0].above,arrow:t.some((e=>e.arrow))}}));class yu{constructor(e,t,n,s,i){this.view=e,this.source=t,this.field=n,this.setHover=s,this.hoverTime=i,this.hoverTimeout=-1,this.restartTimeout=-1,this.pending=null,this.lastMove={x:0,y:0,target:e.dom,time:0},this.checkHover=this.checkHover.bind(this),e.dom.addEventListener('mouseleave',this.mouseleave=this.mouseleave.bind(this)),e.dom.addEventListener('mousemove',this.mousemove=this.mousemove.bind(this))}update(){this.pending&&(this.pending=null,clearTimeout(this.restartTimeout),this.restartTimeout=setTimeout((()=>this.startHover()),20))}get active(){return this.view.state.field(this.field)}checkHover(){if(this.hoverTimeout=-1,this.active.length)return;let e=Date.now()-this.lastMove.time;e<this.hoverTime?this.hoverTimeout=setTimeout(this.checkHover,this.hoverTime-e):this.startHover()}startHover(){clearTimeout(this.restartTimeout);let{view:e,lastMove:t}=this,n=e.docView.nearest(t.target);if(!n)return;let s,i=1;if(n instanceof oa)s=n.posAtStart;else{if(s=e.posAtCoords(t),null==s)return;let n=e.coordsAtPos(s);if(!n||t.y<n.top||t.y>n.bottom||t.x<n.left-e.defaultCharacterWidth||t.x>n.right+e.defaultCharacterWidth)return;let r=e.bidiSpans(e.state.doc.lineAt(s)).find((e=>e.from<=s&&e.to>=s)),o=r&&r.dir==Aa.RTL?-1:1;i=t.x<n.left?-o:o}let r=this.source(e,s,i);if(null==r?void 0:r.then){let t=this.pending={pos:s};r.then((n=>{this.pending==t&&(this.pending=null,!n||Array.isArray(n)&&!n.length||e.dispatch({effects:this.setHover.of(Array.isArray(n)?n:[n])}))}),(t=>hl(e.state,t,'hover tooltip')))}else!r||Array.isArray(r)&&!r.length||e.dispatch({effects:this.setHover.of(Array.isArray(r)?r:[r])})}get tooltip(){let e=this.view.plugin(du),t=e?e.manager.tooltips.findIndex((e=>e.create==xu.create)):-1;return t>-1?e.manager.tooltipViews[t]:null}mousemove(e){var t,n;this.lastMove={x:e.clientX,y:e.clientY,target:e.target,time:Date.now()},this.hoverTimeout<0&&(this.hoverTimeout=setTimeout(this.checkHover,this.hoverTime));let{active:s,tooltip:i}=this;if(s.length&&i&&!function(e,t){let n,{left:s,right:i,top:r,bottom:o}=e.getBoundingClientRect();if(n=e.querySelector('.cm-tooltip-arrow')){let e=n.getBoundingClientRect();r=Math.min(e.top,r),o=Math.max(e.bottom,o)}return t.clientX>=s-_u&&t.clientX<=i+_u&&t.clientY>=r-_u&&t.clientY<=o+_u}(i.dom,e)||this.pending){let{pos:i}=s[0]||this.pending,r=null!==(n=null===(t=s[0])||void 0===t?void 0:t.end)&&void 0!==n?n:i;(i==r?this.view.posAtCoords(this.lastMove)==i:function(e,t,n,s,i){let r=e.scrollDOM.getBoundingClientRect(),o=e.documentTop+e.documentPadding.top+e.contentHeight;if(r.left>s||r.right<s||r.top>i||Math.min(r.bottom,o)<i)return!1;let a=e.posAtCoords({x:s,y:i},!1);return a>=t&&a<=n}(this.view,i,r,e.clientX,e.clientY))||(this.view.dispatch({effects:this.setHover.of([])}),this.pending=null)}}mouseleave(e){clearTimeout(this.hoverTimeout),this.hoverTimeout=-1;let{active:t}=this;if(t.length){let{tooltip:t}=this;t&&t.dom.contains(e.relatedTarget)?this.watchTooltipLeave(t.dom):this.view.dispatch({effects:this.setHover.of([])})}}watchTooltipLeave(e){let t=n=>{e.removeEventListener('mouseleave',t),this.active.length&&!this.view.dom.contains(n.relatedTarget)&&this.view.dispatch({effects:this.setHover.of([])})};e.addEventListener('mouseleave',t)}destroy(){clearTimeout(this.hoverTimeout),this.view.dom.removeEventListener('mouseleave',this.mouseleave),this.view.dom.removeEventListener('mousemove',this.mousemove)}}const _u=4;function wu(e,t={}){let n=Ir.define(),s=ir.define({create:()=>[],update(e,s){if(e.length&&(t.hideOnChange&&(s.docChanged||s.selection)?e=[]:t.hideOn&&(e=e.filter((e=>!t.hideOn(s,e)))),s.docChanged)){let t=[];for(let n of e){let e=s.changes.mapPos(n.pos,-1,Ri.TrackDel);if(null!=e){let i=Object.assign(Object.create(null),n);i.pos=e,null!=i.end&&(i.end=s.changes.mapPos(i.end)),t.push(i)}}e=t}for(let t of s.effects)t.is(n)&&(e=t.value),t.is(Ou)&&(e=[]);return e},provide:e=>vu.from(e)});return{active:s,extension:[s,pl.define((i=>new yu(i,e,s,n,t.hoverTime||300))),bu]}}function ku(e,t){let n=e.plugin(du);if(!n)return null;let s=n.manager.tooltips.indexOf(t);return s<0?null:n.manager.tooltipViews[s]}const Ou=Ir.define(),Su=Ki.define({combine(e){let t,n;for(let s of e)t=t||s.topContainer,n=n||s.bottomContainer;return{topContainer:t,bottomContainer:n}}});function Tu(e,t){let n=e.plugin(Iu),s=n?n.specs.indexOf(t):-1;return s>-1?n.panels[s]:null}const Iu=pl.fromClass(class{constructor(e){this.input=e.state.facet(Au),this.specs=this.input.filter((e=>e)),this.panels=this.specs.map((t=>t(e)));let t=e.state.facet(Su);this.top=new Cu(e,!0,t.topContainer),this.bottom=new Cu(e,!1,t.bottomContainer),this.top.sync(this.panels.filter((e=>e.top))),this.bottom.sync(this.panels.filter((e=>!e.top)));for(let e of this.panels)e.dom.classList.add('cm-panel'),e.mount&&e.mount()}update(e){let t=e.state.facet(Su);this.top.container!=t.topContainer&&(this.top.sync([]),this.top=new Cu(e.view,!0,t.topContainer)),this.bottom.container!=t.bottomContainer&&(this.bottom.sync([]),this.bottom=new Cu(e.view,!1,t.bottomContainer)),this.top.syncClasses(),this.bottom.syncClasses();let n=e.state.facet(Au);if(n!=this.input){let t=n.filter((e=>e)),s=[],i=[],r=[],o=[];for(let n of t){let t,a=this.specs.indexOf(n);a<0?(t=n(e.view),o.push(t)):(t=this.panels[a],t.update&&t.update(e)),s.push(t),(t.top?i:r).push(t)}this.specs=t,this.panels=s,this.top.sync(i),this.bottom.sync(r);for(let e of o)e.dom.classList.add('cm-panel'),e.mount&&e.mount()}else for(let t of this.panels)t.update&&t.update(e)}destroy(){this.top.sync([]),this.bottom.sync([])}},{provide:e=>fh.scrollMargins.of((t=>{let n=t.plugin(e);return n&&{top:n.top.scrollMargin(),bottom:n.bottom.scrollMargin()}}))});class Cu{constructor(e,t,n){this.view=e,this.top=t,this.container=n,this.dom=void 0,this.classes='',this.panels=[],this.syncClasses()}sync(e){for(let t of this.panels)t.destroy&&e.indexOf(t)<0&&t.destroy();this.panels=e,this.syncDOM()}syncDOM(){if(0==this.panels.length)return void(this.dom&&(this.dom.remove(),this.dom=void 0));if(!this.dom){this.dom=document.createElement('div'),this.dom.className=this.top?'cm-panels cm-panels-top':'cm-panels cm-panels-bottom',this.dom.style[this.top?'top':'bottom']='0';let e=this.container||this.view.dom;e.insertBefore(this.dom,this.top?e.firstChild:null)}let e=this.dom.firstChild;for(let t of this.panels)if(t.dom.parentNode==this.dom){for(;e!=t.dom;)e=$u(e);e=e.nextSibling}else this.dom.insertBefore(t.dom,e);for(;e;)e=$u(e)}scrollMargin(){return!this.dom||this.container?0:Math.max(0,this.top?this.dom.getBoundingClientRect().bottom-Math.max(0,this.view.scrollDOM.getBoundingClientRect().top):Math.min(innerHeight,this.view.scrollDOM.getBoundingClientRect().bottom)-this.dom.getBoundingClientRect().top)}syncClasses(){if(this.container&&this.classes!=this.view.themeClasses){for(let e of this.classes.split(' '))e&&this.container.classList.remove(e);for(let e of(this.classes=this.view.themeClasses).split(' '))e&&this.container.classList.add(e)}}}function $u(e){let t=e.nextSibling;return e.remove(),t}const Au=Ki.define({enables:Iu});class Eu extends zr{compare(e){return this==e||this.constructor==e.constructor&&this.eq(e)}eq(e){return!1}destroy(e){}}Eu.prototype.elementClass='',Eu.prototype.toDOM=void 0,Eu.prototype.mapMode=Ri.TrackBefore,Eu.prototype.startSide=Eu.prototype.endSide=-1,Eu.prototype.point=!0;const Pu=Ki.define(),Du=Ki.define(),Mu={class:'',renderEmptyElements:!1,elementStyle:'',markers:()=>jr.empty,lineMarker:()=>null,widgetMarker:()=>null,lineMarkerChange:null,initialSpacer:null,updateSpacer:null,domEventHandlers:{}},Lu=Ki.define();function Bu(e){return[Ru(),Lu.of(Object.assign(Object.assign({},Mu),e))]}const Nu=Ki.define({combine:e=>e.some((e=>e))});function Ru(e){let t=[Fu];return e&&!1===e.fixed&&t.push(Nu.of(!0)),t}const Fu=pl.fromClass(class{constructor(e){this.view=e,this.prevViewport=e.viewport,this.dom=document.createElement('div'),this.dom.className='cm-gutters',this.dom.setAttribute('aria-hidden','true'),this.dom.style.minHeight=this.view.contentHeight/this.view.scaleY+'px',this.gutters=e.state.facet(Lu).map((t=>new Wu(e,t)));for(let e of this.gutters)this.dom.appendChild(e.dom);this.fixed=!e.state.facet(Nu),this.fixed&&(this.dom.style.position='sticky'),this.syncGutters(!1),e.scrollDOM.insertBefore(this.dom,e.contentDOM)}update(e){if(this.updateGutters(e)){let t=this.prevViewport,n=e.view.viewport,s=Math.min(t.to,n.to)-Math.max(t.from,n.from);this.syncGutters(s<.8*(n.to-n.from))}e.geometryChanged&&(this.dom.style.minHeight=this.view.contentHeight/this.view.scaleY+'px'),this.view.state.facet(Nu)!=!this.fixed&&(this.fixed=!this.fixed,this.dom.style.position=this.fixed?'sticky':''),this.prevViewport=e.view.viewport}syncGutters(e){let t=this.dom.nextSibling;e&&this.dom.remove();let n=jr.iter(this.view.state.facet(Pu),this.view.viewport.from),s=[],i=this.gutters.map((e=>new Uu(e,this.view.viewport,-this.view.documentPadding.top)));for(let e of this.view.viewportLineBlocks)if(s.length&&(s=[]),Array.isArray(e.type)){let t=!0;for(let r of e.type)if(r.type==va.Text&&t){zu(n,s,r.from);for(let e of i)e.line(this.view,r,s);t=!1}else if(r.widget)for(let e of i)e.widget(this.view,r)}else if(e.type==va.Text){zu(n,s,e.from);for(let t of i)t.line(this.view,e,s)}else if(e.widget)for(let t of i)t.widget(this.view,e);for(let e of i)e.finish();e&&this.view.scrollDOM.insertBefore(this.dom,t)}updateGutters(e){let t=e.startState.facet(Lu),n=e.state.facet(Lu),s=e.docChanged||e.heightChanged||e.viewportChanged||!jr.eq(e.startState.facet(Pu),e.state.facet(Pu),e.view.viewport.from,e.view.viewport.to);if(t==n)for(let t of this.gutters)t.update(e)&&(s=!0);else{s=!0;let i=[];for(let s of n){let n=t.indexOf(s);n<0?i.push(new Wu(this.view,s)):(this.gutters[n].update(e),i.push(this.gutters[n]))}for(let e of this.gutters)e.dom.remove(),i.indexOf(e)<0&&e.destroy();for(let e of i)this.dom.appendChild(e.dom);this.gutters=i}return s}destroy(){for(let e of this.gutters)e.destroy();this.dom.remove()}},{provide:e=>fh.scrollMargins.of((t=>{let n=t.plugin(e);return n&&0!=n.gutters.length&&n.fixed?t.textDirection==Aa.LTR?{left:n.dom.offsetWidth*t.scaleX}:{right:n.dom.offsetWidth*t.scaleX}:null}))});function Vu(e){return Array.isArray(e)?e:[e]}function zu(e,t,n){for(;e.value&&e.from<=n;)e.from==n&&t.push(e.value),e.next()}class Uu{constructor(e,t,n){this.gutter=e,this.height=n,this.i=0,this.cursor=jr.iter(e.markers,t.from)}addElement(e,t,n){let{gutter:s}=this,i=(t.top-this.height)/e.scaleY,r=t.height/e.scaleY;if(this.i==s.elements.length){let t=new Qu(e,r,i,n);s.elements.push(t),s.dom.appendChild(t.dom)}else s.elements[this.i].update(e,r,i,n);this.height=t.bottom,this.i++}line(e,t,n){let s=[];zu(this.cursor,s,t.from),n.length&&(s=s.concat(n));let i=this.gutter.config.lineMarker(e,t,s);i&&s.unshift(i);let r=this.gutter;(0!=s.length||r.config.renderEmptyElements)&&this.addElement(e,t,s)}widget(e,t){let n=this.gutter.config.widgetMarker(e,t.widget,t),s=n?[n]:null;for(let n of e.state.facet(Du)){let i=n(e,t.widget,t);i&&(s||(s=[])).push(i)}s&&this.addElement(e,t,s)}finish(){let e=this.gutter;for(;e.elements.length>this.i;){let t=e.elements.pop();e.dom.removeChild(t.dom),t.destroy()}}}class Wu{constructor(e,t){this.view=e,this.config=t,this.elements=[],this.spacer=null,this.dom=document.createElement('div'),this.dom.className='cm-gutter'+(this.config.class?' '+this.config.class:'');for(let n in t.domEventHandlers)this.dom.addEventListener(n,(s=>{let i,r=s.target;if(r!=this.dom&&this.dom.contains(r)){for(;r.parentNode!=this.dom;)r=r.parentNode;let e=r.getBoundingClientRect();i=(e.top+e.bottom)/2}else i=s.clientY;let o=e.lineBlockAtHeight(i-e.documentTop);t.domEventHandlers[n](e,o,s)&&s.preventDefault()}));this.markers=Vu(t.markers(e)),t.initialSpacer&&(this.spacer=new Qu(e,0,0,[t.initialSpacer(e)]),this.dom.appendChild(this.spacer.dom),this.spacer.dom.style.cssText+='visibility: hidden; pointer-events: none')}update(e){let t=this.markers;if(this.markers=Vu(this.config.markers(e.view)),this.spacer&&this.config.updateSpacer){let t=this.config.updateSpacer(this.spacer.markers[0],e);t!=this.spacer.markers[0]&&this.spacer.update(e.view,0,0,[t])}let n=e.view.viewport;return!jr.eq(this.markers,t,n.from,n.to)||!!this.config.lineMarkerChange&&this.config.lineMarkerChange(e)}destroy(){for(let e of this.elements)e.destroy()}}class Qu{constructor(e,t,n,s){this.height=-1,this.above=0,this.markers=[],this.dom=document.createElement('div'),this.dom.className='cm-gutterElement',this.update(e,t,n,s)}update(e,t,n,s){this.height!=t&&(this.height=t,this.dom.style.height=t+'px'),this.above!=n&&(this.dom.style.marginTop=(this.above=n)?n+'px':''),function(e,t){if(e.length!=t.length)return!1;for(let n=0;n<e.length;n++)if(!e[n].compare(t[n]))return!1;return!0}(this.markers,s)||this.setMarkers(e,s)}setMarkers(e,t){let n='cm-gutterElement',s=this.dom.firstChild;for(let i=0,r=0;;){let o=r,a=i<t.length?t[i++]:null,l=!1;if(a){let e=a.elementClass;e&&(n+=' '+e);for(let e=r;e<this.markers.length;e++)if(this.markers[e].compare(a)){o=e,l=!0;break}}else o=this.markers.length;for(;r<o;){let e=this.markers[r++];if(e.toDOM){e.destroy(s);let t=s.nextSibling;s.remove(),s=t}}if(!a)break;a.toDOM&&(l?s=s.nextSibling:this.dom.insertBefore(a.toDOM(e),s)),l&&r++}this.dom.className=n,this.markers=t}destroy(){this.setMarkers(null,[])}}const ju=Ki.define(),Xu=Ki.define(),Gu=Ki.define({combine:e=>Vr(e,{formatNumber:String,domEventHandlers:{}},{domEventHandlers(e,t){let n=Object.assign({},e);for(let e in t){let s=n[e],i=t[e];n[e]=s?(e,t,n)=>s(e,t,n)||i(e,t,n):i}return n}})});class qu extends Eu{constructor(e){super(),this.number=e}eq(e){return this.number==e.number}toDOM(){return document.createTextNode(this.number)}}function Hu(e,t){return e.state.facet(Gu).formatNumber(t,e.state)}const Yu=Lu.compute([Gu],(e=>({class:'cm-lineNumbers',renderEmptyElements:!1,markers:e=>e.state.facet(ju),lineMarker:(e,t,n)=>n.some((e=>e.toDOM))?null:new qu(Hu(e,e.state.doc.lineAt(t.from).number)),widgetMarker:(e,t,n)=>{for(let s of e.state.facet(Xu)){let i=s(e,t,n);if(i)return i}return null},lineMarkerChange:e=>e.startState.facet(Gu)!=e.state.facet(Gu),initialSpacer:e=>new qu(Hu(e,Zu(e.state.doc.lines))),updateSpacer(e,t){let n=Hu(t.view,Zu(t.view.state.doc.lines));return n==e.number?e:new qu(n)},domEventHandlers:e.facet(Gu).domEventHandlers})));function Ku(e={}){return[Gu.of(e),Ru(),Yu]}function Zu(e){let t=9;for(;t<e;)t=10*t+9;return t}const Ju=new class extends Eu{constructor(){super(...arguments),this.elementClass='cm-activeLineGutter'}},ed=Pu.compute(['selection'],(e=>{let t=[],n=-1;for(let s of e.selection.ranges){let i=e.doc.lineAt(s.head).from;i>n&&(n=i,t.push(Ju.range(i)))}return jr.of(t)}));const td=1024;let nd=0;class sd{constructor(e,t){this.from=e,this.to=t}}class id{constructor(e={}){this.id=nd++,this.perNode=!!e.perNode,this.deserialize=e.deserialize||(()=>{throw new Error('This node type doesn\'t define a deserialize function')})}add(e){if(this.perNode)throw new RangeError('Can\'t add per-node props to node types');return'function'!=typeof e&&(e=ad.match(e)),t=>{let n=e(t);return void 0===n?null:[this,n]}}}id.closedBy=new id({deserialize:e=>e.split(' ')}),id.openedBy=new id({deserialize:e=>e.split(' ')}),id.group=new id({deserialize:e=>e.split(' ')}),id.isolate=new id({deserialize:e=>{if(e&&'rtl'!=e&&'ltr'!=e&&'auto'!=e)throw new RangeError('Invalid value for isolate: '+e);return e||'auto'}}),id.contextHash=new id({perNode:!0}),id.lookAhead=new id({perNode:!0}),id.mounted=new id({perNode:!0});class rd{constructor(e,t,n){this.tree=e,this.overlay=t,this.parser=n}static get(e){return e&&e.props&&e.props[id.mounted.id]}}const od=Object.create(null);class ad{constructor(e,t,n,s=0){this.name=e,this.props=t,this.id=n,this.flags=s}static define(e){let t=e.props&&e.props.length?Object.create(null):od,n=(e.top?1:0)|(e.skipped?2:0)|(e.error?4:0)|(null==e.name?8:0),s=new ad(e.name||'',t,e.id,n);if(e.props)for(let n of e.props)if(Array.isArray(n)||(n=n(s)),n){if(n[0].perNode)throw new RangeError('Can\'t store a per-node prop on a node type');t[n[0].id]=n[1]}return s}prop(e){return this.props[e.id]}get isTop(){return(1&this.flags)>0}get isSkipped(){return(2&this.flags)>0}get isError(){return(4&this.flags)>0}get isAnonymous(){return(8&this.flags)>0}is(e){if('string'==typeof e){if(this.name==e)return!0;let t=this.prop(id.group);return!!t&&t.indexOf(e)>-1}return this.id==e}static match(e){let t=Object.create(null);for(let n in e)for(let s of n.split(' '))t[s]=e[n];return e=>{for(let n=e.prop(id.group),s=-1;s<(n?n.length:0);s++){let i=t[s<0?e.name:n[s]];if(i)return i}}}}ad.none=new ad('',Object.create(null),0,8);class ld{constructor(e){this.types=e;for(let t=0;t<e.length;t++)if(e[t].id!=t)throw new RangeError('Node type ids should correspond to array positions when creating a node set')}extend(...e){let t=[];for(let n of this.types){let s=null;for(let t of e){let e=t(n);e&&(s||(s=Object.assign({},n.props)),s[e[0].id]=e[1])}t.push(s?new ad(n.name,s,n.id,n.flags):n)}return new ld(t)}}const cd=new WeakMap,hd=new WeakMap;var ud;(e=>{e[e.ExcludeBuffers=1]='ExcludeBuffers',e[e.IncludeAnonymous=2]='IncludeAnonymous',e[e.IgnoreMounts=4]='IgnoreMounts',e[e.IgnoreOverlays=8]='IgnoreOverlays'})(ud||(ud={}));class dd{constructor(e,t,n,s,i){if(this.type=e,this.children=t,this.positions=n,this.length=s,this.props=null,i&&i.length){this.props=Object.create(null);for(let[e,t]of i)this.props['number'==typeof e?e:e.id]=t}}toString(){let e=rd.get(this);if(e&&!e.overlay)return e.tree.toString();let t='';for(let e of this.children){let n=e.toString();n&&(t&&(t+=','),t+=n)}return this.type.name?(/\W/.test(this.type.name)&&!this.type.isError?JSON.stringify(this.type.name):this.type.name)+(t.length?'('+t+')':''):t}cursor(e=0){return new Sd(this.topNode,e)}cursorAt(e,t=0,n=0){let s=cd.get(this)||this.topNode,i=new Sd(s);return i.moveTo(e,t),cd.set(this,i._tree),i}get topNode(){return new xd(this,0,0,null)}resolve(e,t=0){let n=gd(cd.get(this)||this.topNode,e,t,!1);return cd.set(this,n),n}resolveInner(e,t=0){let n=gd(hd.get(this)||this.topNode,e,t,!0);return hd.set(this,n),n}resolveStack(e,t=0){return function(e,t,n){let s=e.resolveInner(t,n),i=null;for(let e=s instanceof xd?s:s.context.parent;e;e=e.parent)if(e.index<0){let r=e.parent;(i||(i=[s])).push(r.resolve(t,n)),e=r}else{let r=rd.get(e.tree);if(r&&r.overlay&&r.overlay[0].from<=t&&r.overlay[r.overlay.length-1].to>=t){let o=new xd(r.tree,r.overlay[0].from+e.from,-1,e);(i||(i=[s])).push(gd(o,t,n,!1))}}return i?kd(i):s}(this,e,t)}iterate(e){let{enter:t,leave:n,from:s=0,to:i=this.length}=e,r=e.mode||0,o=(r&ud.IncludeAnonymous)>0;for(let e=this.cursor(r|ud.IncludeAnonymous);;){let r=!1;if(e.from<=i&&e.to>=s&&(!o&&e.type.isAnonymous||!1!==t(e))){if(e.firstChild())continue;r=!0}for(;r&&n&&(o||!e.type.isAnonymous)&&n(e),!e.nextSibling();){if(!e.parent())return;r=!0}}}prop(e){return e.perNode?this.props?this.props[e.id]:void 0:this.type.prop(e)}get propValues(){let e=[];if(this.props)for(let t in this.props)e.push([+t,this.props[t]]);return e}balance(e={}){return this.children.length<=8?this:$d(ad.none,this.children,this.positions,0,this.children.length,0,this.length,((e,t,n)=>new dd(this.type,e,t,n,this.propValues)),e.makeTree||((e,t,n)=>new dd(ad.none,e,t,n)))}static build(e){return function(e){var t;let{buffer:n,nodeSet:s,maxBufferLength:i=td,reused:r=[],minRepeatType:o=s.types.length}=e,a=Array.isArray(n)?new fd(n,n.length):n,l=s.types,c=0,h=0;function u(e,t,n,x,b,y){let{id:_,start:w,end:k,size:O}=a,S=h,T=c;for(;O<0;){if(a.next(),-1==O){let t=r[_];return n.push(t),void x.push(w-e)}if(-3==O)return void(c=_);if(-4==O)return void(h=_);throw new RangeError(`Unrecognized record size: ${O}`)}let I,C,$=l[_],A=w-e;if(k-w<=i&&(C=g(a.pos-t,b))){let t=new Uint16Array(C.size-C.skip),n=a.pos-C.size,i=t.length;for(;a.pos>n;)i=v(C.start,t,i);I=new pd(t,k-C.start,s),A=C.start-e}else{let e=a.pos-O;a.next();let t=[],n=[],s=_>=o?_:-1,r=0,l=k;for(;a.pos>e;)s>=0&&a.id==s&&a.size>=0?(a.end<=l-i&&(p(t,n,w,r,a.end,l,s,S,T),r=t.length,l=a.end),a.next()):y>2500?d(w,e,t,n):u(w,e,t,n,s,y+1);if(s>=0&&r>0&&r<t.length&&p(t,n,w,r,w,l,s,S,T),t.reverse(),n.reverse(),s>-1&&r>0){let e=f($,T);I=$d($,t,n,0,t.length,0,k-w,e,e)}else I=m($,t,n,k-w,S-k,T)}n.push(I),x.push(A)}function d(e,t,n,r){let o=[],l=0,c=-1;for(;a.pos>t;){let{id:e,start:t,end:n,size:s}=a;if(s>4)a.next();else{if(c>-1&&t<c)break;c<0&&(c=n-i),o.push(e,t,n),l++,a.next()}}if(l){let t=new Uint16Array(4*l),i=o[o.length-2];for(let e=o.length-3,n=0;e>=0;e-=3)t[n++]=o[e],t[n++]=o[e+1]-i,t[n++]=o[e+2]-i,t[n++]=n;n.push(new pd(t,o[2]-i,s)),r.push(i-e)}}function f(e,t){return(n,s,i)=>{let r,o,a=0,l=n.length-1;if(l>=0&&(r=n[l])instanceof dd){if(!l&&r.type==e&&r.length==i)return r;(o=r.prop(id.lookAhead))&&(a=s[l]+r.length+o)}return m(e,n,s,i,a,t)}}function p(e,t,n,i,r,o,a,l,c){let h=[],u=[];for(;e.length>i;)h.push(e.pop()),u.push(t.pop()+n-r);e.push(m(s.types[a],h,u,o-r,l-o,c)),t.push(r-n)}function m(e,t,n,s,i,r,o){if(r){let e=[id.contextHash,r];o=o?[e].concat(o):[e]}if(i>25){let e=[id.lookAhead,i];o=o?[e].concat(o):[e]}return new dd(e,t,n,s,o)}function g(e,t){let n=a.fork(),s=0,r=0,l=0,c=n.end-i,h={size:0,start:0,skip:0};e:for(let i=n.pos-e;n.pos>i;){let e=n.size;if(n.id==t&&e>=0){h.size=s,h.start=r,h.skip=l,l+=4,s+=4,n.next();continue}let a=n.pos-e;if(e<0||a<i||n.start<c)break;let u=n.id>=o?4:0,d=n.start;for(n.next();n.pos>a;){if(n.size<0){if(-3!=n.size)break e;u+=4}else n.id>=o&&(u+=4);n.next()}r=d,s+=e,l+=u}return(t<0||s==e)&&(h.size=s,h.start=r,h.skip=l),h.size>4?h:void 0}function v(e,t,n){let{id:s,start:i,end:r,size:l}=a;if(a.next(),l>=0&&s<o){let o=n;if(l>4){let s=a.pos-(l-4);for(;a.pos>s;)n=v(e,t,n)}t[--n]=o,t[--n]=r-e,t[--n]=i-e,t[--n]=s}else-3==l?c=s:-4==l&&(h=s);return n}let x=[],b=[];for(;a.pos>0;)u(e.start||0,e.bufferStart||0,x,b,-1,0);let y=null!==(t=e.length)&&void 0!==t?t:x.length?b[0]+x[0].length:0;return new dd(l[e.topID],x.reverse(),b.reverse(),y)}(e)}}dd.empty=new dd(ad.none,[],[],0);class fd{constructor(e,t){this.buffer=e,this.index=t}get id(){return this.buffer[this.index-4]}get start(){return this.buffer[this.index-3]}get end(){return this.buffer[this.index-2]}get size(){return this.buffer[this.index-1]}get pos(){return this.index}next(){this.index-=4}fork(){return new fd(this.buffer,this.index)}}class pd{constructor(e,t,n){this.buffer=e,this.length=t,this.set=n}get type(){return ad.none}toString(){let e=[];for(let t=0;t<this.buffer.length;)e.push(this.childString(t)),t=this.buffer[t+3];return e.join(',')}childString(e){let t=this.buffer[e],n=this.buffer[e+3],s=this.set.types[t],i=s.name;if(/\W/.test(i)&&!s.isError&&(i=JSON.stringify(i)),n==(e+=4))return i;let r=[];for(;e<n;)r.push(this.childString(e)),e=this.buffer[e+3];return i+'('+r.join(',')+')'}findChild(e,t,n,s,i){let{buffer:r}=this,o=-1;for(let a=e;a!=t&&!(md(i,s,r[a+1],r[a+2])&&(o=a,n>0));a=r[a+3]);return o}slice(e,t,n){let s=this.buffer,i=new Uint16Array(t-e),r=0;for(let o=e,a=0;o<t;){i[a++]=s[o++],i[a++]=s[o++]-n;let t=i[a++]=s[o++]-n;i[a++]=s[o++]-e,r=Math.max(r,t)}return new pd(i,r,this.set)}}function md(e,t,n,s){switch(e){case-2:return n<t;case-1:return s>=t&&n<t;case 0:return n<t&&s>t;case 1:return n<=t&&s>t;case 2:return s>t;case 4:return!0}}function gd(e,t,n,s){for(var i;e.from==e.to||(n<1?e.from>=t:e.from>t)||(n>-1?e.to<=t:e.to<t);){let t=!s&&e instanceof xd&&e.index<0?null:e.parent;if(!t)return e;e=t}let r=s?0:ud.IgnoreOverlays;if(s)for(let s=e,o=s.parent;o;s=o,o=s.parent)s instanceof xd&&s.index<0&&(null===(i=o.enter(t,n,r))||void 0===i?void 0:i.from)!=s.from&&(e=o);for(;;){let s=e.enter(t,n,r);if(!s)return e;e=s}}class vd{cursor(e=0){return new Sd(this,e)}getChild(e,t=null,n=null){let s=bd(this,e,t,n);return s.length?s[0]:null}getChildren(e,t=null,n=null){return bd(this,e,t,n)}resolve(e,t=0){return gd(this,e,t,!1)}resolveInner(e,t=0){return gd(this,e,t,!0)}matchContext(e){return yd(this.parent,e)}enterUnfinishedNodesBefore(e){let t=this.childBefore(e),n=this;for(;t;){let e=t.lastChild;if(!e||e.to!=t.to)break;e.type.isError&&e.from==e.to?(n=t,t=e.prevSibling):t=e}return n}get node(){return this}get next(){return this.parent}}class xd extends vd{constructor(e,t,n,s){super(),this._tree=e,this.from=t,this.index=n,this._parent=s}get type(){return this._tree.type}get name(){return this._tree.type.name}get to(){return this.from+this._tree.length}nextChild(e,t,n,s,i=0){for(let r=this;;){for(let{children:o,positions:a}=r._tree,l=t>0?o.length:-1;e!=l;e+=t){let l=o[e],c=a[e]+r.from;if(md(s,n,c,c+l.length))if(l instanceof pd){if(i&ud.ExcludeBuffers)continue;let o=l.findChild(0,l.buffer.length,t,n-c,s);if(o>-1)return new wd(new _d(r,l,e,c),null,o)}else if(i&ud.IncludeAnonymous||!l.type.isAnonymous||Td(l)){let o;if(!(i&ud.IgnoreMounts)&&(o=rd.get(l))&&!o.overlay)return new xd(o.tree,c,e,r);let a=new xd(l,c,e,r);return i&ud.IncludeAnonymous||!a.type.isAnonymous?a:a.nextChild(t<0?l.children.length-1:0,t,n,s)}}if(i&ud.IncludeAnonymous||!r.type.isAnonymous)return null;if(e=r.index>=0?r.index+t:t<0?-1:r._parent._tree.children.length,r=r._parent,!r)return null}}get firstChild(){return this.nextChild(0,1,0,4)}get lastChild(){return this.nextChild(this._tree.children.length-1,-1,0,4)}childAfter(e){return this.nextChild(0,1,e,2)}childBefore(e){return this.nextChild(this._tree.children.length-1,-1,e,-2)}enter(e,t,n=0){let s;if(!(n&ud.IgnoreOverlays)&&(s=rd.get(this._tree))&&s.overlay){let n=e-this.from;for(let{from:e,to:i}of s.overlay)if((t>0?e<=n:e<n)&&(t<0?i>=n:i>n))return new xd(s.tree,s.overlay[0].from+this.from,-1,this)}return this.nextChild(0,1,e,t,n)}nextSignificantParent(){let e=this;for(;e.type.isAnonymous&&e._parent;)e=e._parent;return e}get parent(){return this._parent?this._parent.nextSignificantParent():null}get nextSibling(){return this._parent&&this.index>=0?this._parent.nextChild(this.index+1,1,0,4):null}get prevSibling(){return this._parent&&this.index>=0?this._parent.nextChild(this.index-1,-1,0,4):null}get tree(){return this._tree}toTree(){return this._tree}toString(){return this._tree.toString()}}function bd(e,t,n,s){let i=e.cursor(),r=[];if(!i.firstChild())return r;if(null!=n)for(let e=!1;!e;)if(e=i.type.is(n),!i.nextSibling())return r;for(;;){if(null!=s&&i.type.is(s))return r;if(i.type.is(t)&&r.push(i.node),!i.nextSibling())return null==s?r:[]}}function yd(e,t,n=t.length-1){for(let s=e;n>=0;s=s.parent){if(!s)return!1;if(!s.type.isAnonymous){if(t[n]&&t[n]!=s.name)return!1;n--}}return!0}class _d{constructor(e,t,n,s){this.parent=e,this.buffer=t,this.index=n,this.start=s}}class wd extends vd{get name(){return this.type.name}get from(){return this.context.start+this.context.buffer.buffer[this.index+1]}get to(){return this.context.start+this.context.buffer.buffer[this.index+2]}constructor(e,t,n){super(),this.context=e,this._parent=t,this.index=n,this.type=e.buffer.set.types[e.buffer.buffer[n]]}child(e,t,n){let{buffer:s}=this.context,i=s.findChild(this.index+4,s.buffer[this.index+3],e,t-this.context.start,n);return i<0?null:new wd(this.context,this,i)}get firstChild(){return this.child(1,0,4)}get lastChild(){return this.child(-1,0,4)}childAfter(e){return this.child(1,e,2)}childBefore(e){return this.child(-1,e,-2)}enter(e,t,n=0){if(n&ud.ExcludeBuffers)return null;let{buffer:s}=this.context,i=s.findChild(this.index+4,s.buffer[this.index+3],t>0?1:-1,e-this.context.start,t);return i<0?null:new wd(this.context,this,i)}get parent(){return this._parent||this.context.parent.nextSignificantParent()}externalSibling(e){return this._parent?null:this.context.parent.nextChild(this.context.index+e,e,0,4)}get nextSibling(){let{buffer:e}=this.context,t=e.buffer[this.index+3];return t<(this._parent?e.buffer[this._parent.index+3]:e.buffer.length)?new wd(this.context,this._parent,t):this.externalSibling(1)}get prevSibling(){let{buffer:e}=this.context,t=this._parent?this._parent.index+4:0;return this.index==t?this.externalSibling(-1):new wd(this.context,this._parent,e.findChild(t,this.index,-1,0,4))}get tree(){return null}toTree(){let e=[],t=[],{buffer:n}=this.context,s=this.index+4,i=n.buffer[this.index+3];if(i>s){let r=n.buffer[this.index+1];e.push(n.slice(s,i,r)),t.push(0)}return new dd(this.type,e,t,this.to-this.from)}toString(){return this.context.buffer.childString(this.index)}}function kd(e){if(!e.length)return null;let t=0,n=e[0];for(let s=1;s<e.length;s++){let i=e[s];(i.from>n.from||i.to<n.to)&&(n=i,t=s)}let s=n instanceof xd&&n.index<0?null:n.parent,i=e.slice();return s?i[t]=s:i.splice(t,1),new Od(i,n)}class Od{constructor(e,t){this.heads=e,this.node=t}get next(){return kd(this.heads)}}class Sd{get name(){return this.type.name}constructor(e,t=0){if(this.mode=t,this.buffer=null,this.stack=[],this.index=0,this.bufferNode=null,e instanceof xd)this.yieldNode(e);else{this._tree=e.context.parent,this.buffer=e.context;for(let t=e._parent;t;t=t._parent)this.stack.unshift(t.index);this.bufferNode=e,this.yieldBuf(e.index)}}yieldNode(e){return!!e&&(this._tree=e,this.type=e.type,this.from=e.from,this.to=e.to,!0)}yieldBuf(e,t){this.index=e;let{start:n,buffer:s}=this.buffer;return this.type=t||s.set.types[s.buffer[e]],this.from=n+s.buffer[e+1],this.to=n+s.buffer[e+2],!0}yield(e){return!!e&&(e instanceof xd?(this.buffer=null,this.yieldNode(e)):(this.buffer=e.context,this.yieldBuf(e.index,e.type)))}toString(){return this.buffer?this.buffer.buffer.childString(this.index):this._tree.toString()}enterChild(e,t,n){if(!this.buffer)return this.yield(this._tree.nextChild(e<0?this._tree._tree.children.length-1:0,e,t,n,this.mode));let{buffer:s}=this.buffer,i=s.findChild(this.index+4,s.buffer[this.index+3],e,t-this.buffer.start,n);return!(i<0)&&(this.stack.push(this.index),this.yieldBuf(i))}firstChild(){return this.enterChild(1,0,4)}lastChild(){return this.enterChild(-1,0,4)}childAfter(e){return this.enterChild(1,e,2)}childBefore(e){return this.enterChild(-1,e,-2)}enter(e,t,n=this.mode){return this.buffer?!(n&ud.ExcludeBuffers)&&this.enterChild(1,e,t):this.yield(this._tree.enter(e,t,n))}parent(){if(!this.buffer)return this.yieldNode(this.mode&ud.IncludeAnonymous?this._tree._parent:this._tree.parent);if(this.stack.length)return this.yieldBuf(this.stack.pop());let e=this.mode&ud.IncludeAnonymous?this.buffer.parent:this.buffer.parent.nextSignificantParent();return this.buffer=null,this.yieldNode(e)}sibling(e){if(!this.buffer)return!!this._tree._parent&&this.yield(this._tree.index<0?null:this._tree._parent.nextChild(this._tree.index+e,e,0,4,this.mode));let{buffer:t}=this.buffer,n=this.stack.length-1;if(e<0){let e=n<0?0:this.stack[n]+4;if(this.index!=e)return this.yieldBuf(t.findChild(e,this.index,-1,0,4))}else{let e=t.buffer[this.index+3];if(e<(n<0?t.buffer.length:t.buffer[this.stack[n]+3]))return this.yieldBuf(e)}return n<0&&this.yield(this.buffer.parent.nextChild(this.buffer.index+e,e,0,4,this.mode))}nextSibling(){return this.sibling(1)}prevSibling(){return this.sibling(-1)}atLastNode(e){let t,n,{buffer:s}=this;if(s){if(e>0){if(this.index<s.buffer.buffer.length)return!1}else for(let e=0;e<this.index;e++)if(s.buffer.buffer[e+3]<this.index)return!1;({index:t,parent:n}=s)}else({index:t,_parent:n}=this._tree);for(;n;({index:t,_parent:n}=n))if(t>-1)for(let s=t+e,i=e<0?-1:n._tree.children.length;s!=i;s+=e){let e=n._tree.children[s];if(this.mode&ud.IncludeAnonymous||e instanceof pd||!e.type.isAnonymous||Td(e))return!1}return!0}move(e,t){if(t&&this.enterChild(e,0,4))return!0;for(;;){if(this.sibling(e))return!0;if(this.atLastNode(e)||!this.parent())return!1}}next(e=!0){return this.move(1,e)}prev(e=!0){return this.move(-1,e)}moveTo(e,t=0){for(;(this.from==this.to||(t<1?this.from>=e:this.from>e)||(t>-1?this.to<=e:this.to<e))&&this.parent(););for(;this.enterChild(1,e,t););return this}get node(){if(!this.buffer)return this._tree;let e=this.bufferNode,t=null,n=0;if(e&&e.context==this.buffer)e:for(let s=this.index,i=this.stack.length;i>=0;){for(let r=e;r;r=r._parent)if(r.index==s){if(s==this.index)return r;t=r,n=i+1;break e}s=this.stack[--i]}for(let e=n;e<this.stack.length;e++)t=new wd(this.buffer,t,this.stack[e]);return this.bufferNode=new wd(this.buffer,t,this.index)}get tree(){return this.buffer?null:this._tree._tree}iterate(e,t){for(let n=0;;){let s=!1;if(this.type.isAnonymous||!1!==e(this)){if(this.firstChild()){n++;continue}this.type.isAnonymous||(s=!0)}for(;;){if(s&&t&&t(this),s=this.type.isAnonymous,!n)return;if(this.nextSibling())break;this.parent(),n--,s=!0}}}matchContext(e){if(!this.buffer)return yd(this.node.parent,e);let{buffer:t}=this.buffer,{types:n}=t.set;for(let s=e.length-1,i=this.stack.length-1;s>=0;i--){if(i<0)return yd(this._tree,e,s);let r=n[t.buffer[this.stack[i]]];if(!r.isAnonymous){if(e[s]&&e[s]!=r.name)return!1;s--}}return!0}}function Td(e){return e.children.some((e=>e instanceof pd||!e.type.isAnonymous||Td(e)))}const Id=new WeakMap;function Cd(e,t){if(!e.isAnonymous||t instanceof pd||t.type!=e)return 1;let n=Id.get(t);if(null==n){n=1;for(let s of t.children){if(s.type!=e||!(s instanceof dd)){n=1;break}n+=Cd(e,s)}Id.set(t,n)}return n}function $d(e,t,n,s,i,r,o,a,l){let c=0;for(let n=s;n<i;n++)c+=Cd(e,t[n]);let h=Math.ceil(1.5*c/8),u=[],d=[];return function t(n,s,i,o,a){for(let c=i;c<o;){let i=c,f=s[c],p=Cd(e,n[c]);for(c++;c<o;c++){let t=Cd(e,n[c]);if(p+t>=h)break;p+=t}if(c==i+1){if(p>h){let e=n[i];t(e.children,e.positions,0,e.children.length,s[i]+a);continue}u.push(n[i])}else{let t=s[c-1]+n[c-1].length-f;u.push($d(e,n,s,i,c,f,t,null,l))}d.push(f+a-r)}}(t,n,s,i,0),(a||l)(u,d,o)}class Ad{constructor(e,t,n,s,i=!1,r=!1){this.from=e,this.to=t,this.tree=n,this.offset=s,this.open=(i?1:0)|(r?2:0)}get openStart(){return(1&this.open)>0}get openEnd(){return(2&this.open)>0}static addTree(e,t=[],n=!1){let s=[new Ad(0,e.length,e,0,!1,n)];for(let n of t)n.to>e.length&&s.push(n);return s}static applyChanges(e,t,n=128){if(!t.length)return e;let s=[],i=1,r=e.length?e[0]:null;for(let o=0,a=0,l=0;;o++){let c=o<t.length?t[o]:null,h=c?c.fromA:1e9;if(h-a>=n)for(;r&&r.from<h;){let t=r;if(a>=t.from||h<=t.to||l){let e=Math.max(t.from,a)-l,n=Math.min(t.to,h)-l;t=e>=n?null:new Ad(e,n,t.tree,t.offset+l,o>0,!!c)}if(t&&s.push(t),r.to>h)break;r=i<e.length?e[i++]:null}if(!c)break;a=c.toA,l=c.toA-c.toB}return s}}class Ed{startParse(e,t,n){return'string'==typeof e&&(e=new Pd(e)),n=n?n.length?n.map((e=>new sd(e.from,e.to))):[new sd(0,0)]:[new sd(0,e.length)],this.createParse(e,t||[],n)}parse(e,t,n){let s=this.startParse(e,t,n);for(;;){let e=s.advance();if(e)return e}}}class Pd{constructor(e){this.string=e}get length(){return this.string.length}chunk(e){return this.string.slice(e)}get lineChunks(){return!1}read(e,t){return this.string.slice(e,t)}}new id({perNode:!0});let Dd=0;class Md{constructor(e,t,n,s){this.name=e,this.set=t,this.base=n,this.modified=s,this.id=Dd++}toString(){let{name:e}=this;for(let t of this.modified)t.name&&(e=`${t.name}(${e})`);return e}static define(e,t){let n='string'==typeof e?e:'?';if(e instanceof Md&&(t=e),null==t?void 0:t.base)throw new Error('Can not derive from a modified tag');let s=new Md(n,[],null,[]);if(s.set.push(s),t)for(let e of t.set)s.set.push(e);return s}static defineModifier(e){let t=new Bd(e);return e=>e.modified.indexOf(t)>-1?e:Bd.get(e.base||e,e.modified.concat(t).sort(((e,t)=>e.id-t.id)))}}let Ld=0;class Bd{constructor(e){this.name=e,this.instances=[],this.id=Ld++}static get(e,t){if(!t.length)return e;let n=t[0].instances.find((n=>{return n.base==e&&(s=t,i=n.modified,s.length==i.length&&s.every(((e,t)=>e==i[t])));var s,i}));if(n)return n;let s=[],i=new Md(e.name,s,e,t);for(let e of t)e.instances.push(i);let r=function(e){let t=[[]];for(let n=0;n<e.length;n++)for(let s=0,i=t.length;s<i;s++)t.push(t[s].concat(e[n]));return t.sort(((e,t)=>t.length-e.length))}(t);for(let t of e.set)if(!t.modified.length)for(let e of r)s.push(Bd.get(t,e));return i}}function Nd(e){let t=Object.create(null);for(let n in e){let s=e[n];Array.isArray(s)||(s=[s]);for(let e of n.split(' '))if(e){let n=[],i=2,r=e;for(let t=0;;){if('...'==r&&t>0&&t+3==e.length){i=1;break}let s=/^"(?:[^"\\]|\\.)*?"|[^\/!]+/.exec(r);if(!s)throw new RangeError('Invalid path: '+e);if(n.push('*'==s[0]?'':'"'==s[0][0]?JSON.parse(s[0]):s[0]),t+=s[0].length,t==e.length)break;let o=e[t++];if(t==e.length&&'!'==o){i=0;break}if('/'!=o)throw new RangeError('Invalid path: '+e);r=e.slice(t)}let o=n.length-1,a=n[o];if(!a)throw new RangeError('Invalid path: '+e);let l=new Fd(s,i,o>0?n.slice(0,o):null);t[a]=l.sort(t[a])}}return Rd.add(t)}const Rd=new id;class Fd{constructor(e,t,n,s){this.tags=e,this.mode=t,this.context=n,this.next=s}get opaque(){return 0==this.mode}get inherit(){return 1==this.mode}sort(e){return!e||e.depth<this.depth?(this.next=e,this):(e.next=this.sort(e.next),e)}get depth(){return this.context?this.context.length:0}}function Vd(e,t){let n=Object.create(null);for(let t of e)if(Array.isArray(t.tag))for(let e of t.tag)n[e.id]=t.class;else n[t.tag.id]=t.class;let{scope:s,all:i=null}=t||{};return{style:e=>{let t=i;for(let s of e)for(let e of s.set){let s=n[e.id];if(s){t=t?t+' '+s:s;break}}return t},scope:s}}function zd(e,t,n,s=0,i=e.length){let r=new Ud(s,Array.isArray(t)?t:[t],n);r.highlightRange(e.cursor(),s,i,'',r.highlighters),r.flush(i)}Fd.empty=new Fd([],2,null);class Ud{constructor(e,t,n){this.at=e,this.highlighters=t,this.span=n,this.class=''}startSpan(e,t){t!=this.class&&(this.flush(e),e>this.at&&(this.at=e),this.class=t)}flush(e){e>this.at&&this.class&&this.span(this.at,e,this.class)}highlightRange(e,t,n,s,i){let{type:r,from:o,to:a}=e;if(o>=n||a<=t)return;r.isTop&&(i=this.highlighters.filter((e=>!e.scope||e.scope(r))));let l=s,c=function(e){let t=e.type.prop(Rd);for(;t&&t.context&&!e.matchContext(t.context);)t=t.next;return t||null}(e)||Fd.empty,h=function(e,t){let n=null;for(let s of e){let e=s.style(t);e&&(n=n?n+' '+e:e)}return n}(i,c.tags);if(h&&(l&&(l+=' '),l+=h,1==c.mode&&(s+=(s?' ':'')+h)),this.startSpan(Math.max(t,o),l),c.opaque)return;let u=e.tree&&e.tree.prop(id.mounted);if(u&&u.overlay){let r=e.node.enter(u.overlay[0].from+o,1),c=this.highlighters.filter((e=>!e.scope||e.scope(u.tree.type))),h=e.firstChild();for(let d=0,f=o;;d++){let p=d<u.overlay.length?u.overlay[d]:null,m=p?p.from+o:a,g=Math.max(t,f),v=Math.min(n,m);if(g<v&&h)for(;e.from<v&&(this.highlightRange(e,g,v,s,i),this.startSpan(Math.min(v,e.to),l),!(e.to>=m)&&e.nextSibling()););if(!p||m>n)break;f=p.to+o,f>t&&(this.highlightRange(r.cursor(),Math.max(t,p.from+o),Math.min(n,f),'',c),this.startSpan(Math.min(n,f),l))}h&&e.parent()}else if(e.firstChild()){u&&(s='');do{if(!(e.to<=t)){if(e.from>=n)break;this.highlightRange(e,t,n,s,i),this.startSpan(Math.min(n,e.to),l)}}while(e.nextSibling());e.parent()}}}const Wd=Md.define,Qd=Wd(),jd=Wd(),Xd=Wd(jd),Gd=Wd(jd),qd=Wd(),Hd=Wd(qd),Yd=Wd(qd),Kd=Wd(),Zd=Wd(Kd),Jd=Wd(),ef=Wd(),tf=Wd(),nf=Wd(tf),sf=Wd(),rf={comment:Qd,lineComment:Wd(Qd),blockComment:Wd(Qd),docComment:Wd(Qd),name:jd,variableName:Wd(jd),typeName:Xd,tagName:Wd(Xd),propertyName:Gd,attributeName:Wd(Gd),className:Wd(jd),labelName:Wd(jd),namespace:Wd(jd),macroName:Wd(jd),literal:qd,string:Hd,docString:Wd(Hd),character:Wd(Hd),attributeValue:Wd(Hd),number:Yd,integer:Wd(Yd),float:Wd(Yd),bool:Wd(qd),regexp:Wd(qd),escape:Wd(qd),color:Wd(qd),url:Wd(qd),keyword:Jd,self:Wd(Jd),null:Wd(Jd),atom:Wd(Jd),unit:Wd(Jd),modifier:Wd(Jd),operatorKeyword:Wd(Jd),controlKeyword:Wd(Jd),definitionKeyword:Wd(Jd),moduleKeyword:Wd(Jd),operator:ef,derefOperator:Wd(ef),arithmeticOperator:Wd(ef),logicOperator:Wd(ef),bitwiseOperator:Wd(ef),compareOperator:Wd(ef),updateOperator:Wd(ef),definitionOperator:Wd(ef),typeOperator:Wd(ef),controlOperator:Wd(ef),punctuation:tf,separator:Wd(tf),bracket:nf,angleBracket:Wd(nf),squareBracket:Wd(nf),paren:Wd(nf),brace:Wd(nf),content:Kd,heading:Zd,heading1:Wd(Zd),heading2:Wd(Zd),heading3:Wd(Zd),heading4:Wd(Zd),heading5:Wd(Zd),heading6:Wd(Zd),contentSeparator:Wd(Kd),list:Wd(Kd),quote:Wd(Kd),emphasis:Wd(Kd),strong:Wd(Kd),link:Wd(Kd),monospace:Wd(Kd),strikethrough:Wd(Kd),inserted:Wd(),deleted:Wd(),changed:Wd(),invalid:Wd(),meta:sf,documentMeta:Wd(sf),annotation:Wd(sf),processingInstruction:Wd(sf),definition:Md.defineModifier('definition'),constant:Md.defineModifier('constant'),function:Md.defineModifier('function'),standard:Md.defineModifier('standard'),local:Md.defineModifier('local'),special:Md.defineModifier('special')};for(let e in rf){let t=rf[e];t instanceof Md&&(t.name=e)}var of;Vd([{tag:rf.link,class:'tok-link'},{tag:rf.heading,class:'tok-heading'},{tag:rf.emphasis,class:'tok-emphasis'},{tag:rf.strong,class:'tok-strong'},{tag:rf.keyword,class:'tok-keyword'},{tag:rf.atom,class:'tok-atom'},{tag:rf.bool,class:'tok-bool'},{tag:rf.url,class:'tok-url'},{tag:rf.labelName,class:'tok-labelName'},{tag:rf.inserted,class:'tok-inserted'},{tag:rf.deleted,class:'tok-deleted'},{tag:rf.literal,class:'tok-literal'},{tag:rf.string,class:'tok-string'},{tag:rf.number,class:'tok-number'},{tag:[rf.regexp,rf.escape,rf.special(rf.string)],class:'tok-string2'},{tag:rf.variableName,class:'tok-variableName'},{tag:rf.local(rf.variableName),class:'tok-variableName tok-local'},{tag:rf.definition(rf.variableName),class:'tok-variableName tok-definition'},{tag:rf.special(rf.variableName),class:'tok-variableName2'},{tag:rf.definition(rf.propertyName),class:'tok-propertyName tok-definition'},{tag:rf.typeName,class:'tok-typeName'},{tag:rf.namespace,class:'tok-namespace'},{tag:rf.className,class:'tok-className'},{tag:rf.macroName,class:'tok-macroName'},{tag:rf.propertyName,class:'tok-propertyName'},{tag:rf.operator,class:'tok-operator'},{tag:rf.comment,class:'tok-comment'},{tag:rf.meta,class:'tok-meta'},{tag:rf.invalid,class:'tok-invalid'},{tag:rf.punctuation,class:'tok-punctuation'}]);const af=new id;const lf=new id;class cf{constructor(e,t,n=[],s=''){this.data=e,this.name=s,Fr.prototype.hasOwnProperty('tree')||Object.defineProperty(Fr.prototype,'tree',{get(){return df(this)}}),this.parser=t,this.extension=[_f.of(this),Fr.languageData.of(((e,t,n)=>{let s=hf(e,t,n),i=s.type.prop(af);if(!i)return[];let r=e.facet(i),o=s.type.prop(lf);if(o){let i=s.resolve(t-s.from,n);for(let t of o)if(t.test(i,e)){let n=e.facet(t.facet);return'replace'==t.type?n:n.concat(r)}}return r}))].concat(n)}isActiveAt(e,t,n=-1){return hf(e,t,n).type.prop(af)==this.data}findRegions(e){let t=e.facet(_f);if((null==t?void 0:t.data)==this.data)return[{from:0,to:e.doc.length}];if(!t||!t.allowsNesting)return[];let n=[],s=(e,t)=>{if(e.prop(af)==this.data)return void n.push({from:t,to:t+e.length});let i=e.prop(id.mounted);if(i){if(i.tree.prop(af)==this.data){if(i.overlay)for(let e of i.overlay)n.push({from:e.from+t,to:e.to+t});else n.push({from:t,to:t+e.length});return}if(i.overlay){let e=n.length;if(s(i.tree,i.overlay[0].from+t),n.length>e)return}}for(let n=0;n<e.children.length;n++){let i=e.children[n];i instanceof dd&&s(i,e.positions[n]+t)}};return s(df(e),0),n}get allowsNesting(){return!0}}function hf(e,t,n){let s=e.facet(_f),i=df(e).topNode;if(!s||s.allowsNesting)for(let e=i;e;e=e.enter(t,n,ud.ExcludeBuffers))e.type.isTop&&(i=e);return i}cf.setState=Ir.define();class uf extends cf{constructor(e,t,n){super(e,t,[],n),this.parser=t}static define(e){let t=(n=e.languageData,Ki.define({combine:n?e=>e.concat(n):void 0}));var n;return new uf(t,e.parser.configure({props:[af.add((e=>e.isTop?t:void 0))]}),e.name)}configure(e,t){return new uf(this.data,this.parser.configure(e),t||this.name)}get allowsNesting(){return this.parser.hasWrappers()}}function df(e){let t=e.field(cf.state,!1);return t?t.tree:dd.empty}class ff{constructor(e){this.doc=e,this.cursorPos=0,this.string='',this.cursor=e.iter()}get length(){return this.doc.length}syncTo(e){return this.string=this.cursor.next(e-this.cursorPos).value,this.cursorPos=e+this.string.length,this.cursorPos-this.string.length}chunk(e){return this.syncTo(e),this.string}get lineChunks(){return!0}read(e,t){let n=this.cursorPos-this.string.length;return e<n||t>=this.cursorPos?this.doc.sliceString(e,t):this.string.slice(e-n,t-n)}}let pf=null;class mf{constructor(e,t,n=[],s,i,r,o,a){this.parser=e,this.state=t,this.fragments=n,this.tree=s,this.treeLen=i,this.viewport=r,this.skipped=o,this.scheduleOn=a,this.parse=null,this.tempSkipped=[]}static create(e,t,n){return new mf(e,t,[],dd.empty,0,n,[],null)}startParse(){return this.parser.startParse(new ff(this.state.doc),this.fragments)}work(e,t){return null!=t&&t>=this.state.doc.length&&(t=void 0),this.tree!=dd.empty&&this.isDone(null!=t?t:this.state.doc.length)?(this.takeTree(),!0):this.withContext((()=>{var n;if('number'==typeof e){let t=Date.now()+e;e=()=>Date.now()>t}for(this.parse||(this.parse=this.startParse()),null!=t&&(null==this.parse.stoppedAt||this.parse.stoppedAt>t)&&t<this.state.doc.length&&this.parse.stopAt(t);;){let s=this.parse.advance();if(s){if(this.fragments=this.withoutTempSkipped(Ad.addTree(s,this.fragments,null!=this.parse.stoppedAt)),this.treeLen=null!==(n=this.parse.stoppedAt)&&void 0!==n?n:this.state.doc.length,this.tree=s,this.parse=null,!(this.treeLen<(null!=t?t:this.state.doc.length)))return!0;this.parse=this.startParse()}if(e())return!1}}))}takeTree(){let e,t;this.parse&&(e=this.parse.parsedPos)>=this.treeLen&&((null==this.parse.stoppedAt||this.parse.stoppedAt>e)&&this.parse.stopAt(e),this.withContext((()=>{for(;!(t=this.parse.advance()););})),this.treeLen=e,this.tree=t,this.fragments=this.withoutTempSkipped(Ad.addTree(this.tree,this.fragments,!0)),this.parse=null)}withContext(e){let t=pf;pf=this;try{return e()}finally{pf=t}}withoutTempSkipped(e){for(let t;t=this.tempSkipped.pop();)e=gf(e,t.from,t.to);return e}changes(e,t){let{fragments:n,tree:s,treeLen:i,viewport:r,skipped:o}=this;if(this.takeTree(),!e.empty){let t=[];if(e.iterChangedRanges(((e,n,s,i)=>t.push({fromA:e,toA:n,fromB:s,toB:i}))),n=Ad.applyChanges(n,t),s=dd.empty,i=0,r={from:e.mapPos(r.from,-1),to:e.mapPos(r.to,1)},this.skipped.length){o=[];for(let t of this.skipped){let n=e.mapPos(t.from,1),s=e.mapPos(t.to,-1);n<s&&o.push({from:n,to:s})}}}return new mf(this.parser,t,n,s,i,r,o,this.scheduleOn)}updateViewport(e){if(this.viewport.from==e.from&&this.viewport.to==e.to)return!1;this.viewport=e;let t=this.skipped.length;for(let t=0;t<this.skipped.length;t++){let{from:n,to:s}=this.skipped[t];n<e.to&&s>e.from&&(this.fragments=gf(this.fragments,n,s),this.skipped.splice(t--,1))}return!(this.skipped.length>=t)&&(this.reset(),!0)}reset(){this.parse&&(this.takeTree(),this.parse=null)}skipUntilInView(e,t){this.skipped.push({from:e,to:t})}static getSkippingParser(e){return new class extends Ed{createParse(t,n,s){let i=s[0].from,r=s[s.length-1].to;return{parsedPos:i,advance(){let t=pf;if(t){for(let e of s)t.tempSkipped.push(e);e&&(t.scheduleOn=t.scheduleOn?Promise.all([t.scheduleOn,e]):e)}return this.parsedPos=r,new dd(ad.none,[],[],r-i)},stoppedAt:null,stopAt(){}}}}}isDone(e){e=Math.min(e,this.state.doc.length);let t=this.fragments;return this.treeLen>=e&&t.length&&0==t[0].from&&t[0].to>=e}static get(){return pf}}function gf(e,t,n){return Ad.applyChanges(e,[{fromA:t,toA:n,fromB:t,toB:n}])}class vf{constructor(e){this.context=e,this.tree=e.tree}apply(e){if(!e.docChanged&&this.tree==this.context.tree)return this;let t=this.context.changes(e.changes,e.state),n=this.context.treeLen==e.startState.doc.length?void 0:Math.max(e.changes.mapPos(this.context.treeLen),t.viewport.to);return t.work(20,n)||t.takeTree(),new vf(t)}static init(e){let t=Math.min(3e3,e.doc.length),n=mf.create(e.facet(_f).parser,e,{from:0,to:t});return n.work(20,t)||n.takeTree(),new vf(n)}}cf.state=ir.define({create:vf.init,update(e,t){for(let e of t.effects)if(e.is(cf.setState))return e.value;return t.startState.facet(_f)!=t.state.facet(_f)?vf.init(t.state):e.apply(t)}});let xf=e=>{let t=setTimeout((()=>e()),500);return()=>clearTimeout(t)};'undefined'!=typeof requestIdleCallback&&(xf=e=>{let t=-1,n=setTimeout((()=>{t=requestIdleCallback(e,{timeout:400})}),100);return()=>t<0?clearTimeout(n):cancelIdleCallback(t)});const bf='undefined'!=typeof navigator&&(null===(of=navigator.scheduling)||void 0===of?void 0:of.isInputPending)?()=>navigator.scheduling.isInputPending():null,yf=pl.fromClass(class e{constructor(e){this.view=e,this.working=null,this.workScheduled=0,this.chunkEnd=-1,this.chunkBudget=-1,this.work=this.work.bind(this),this.scheduleWork()}update(e){let t=this.view.state.field(cf.state).context;(t.updateViewport(e.view.viewport)||this.view.viewport.to>t.treeLen)&&this.scheduleWork(),(e.docChanged||e.selectionSet)&&(this.view.hasFocus&&(this.chunkBudget+=50),this.scheduleWork()),this.checkAsyncSchedule(t)}scheduleWork(){if(this.working)return;let{state:e}=this.view,t=e.field(cf.state);t.tree==t.context.tree&&t.context.isDone(e.doc.length)||(this.working=xf(this.work))}work(e){this.working=null;let t=Date.now();if(this.chunkEnd<t&&(this.chunkEnd<0||this.view.hasFocus)&&(this.chunkEnd=t+3e4,this.chunkBudget=3e3),this.chunkBudget<=0)return;let{state:n,viewport:{to:s}}=this.view,i=n.field(cf.state);if(i.tree==i.context.tree&&i.context.isDone(s+1e5))return;let r=Date.now()+Math.min(this.chunkBudget,100,e&&!bf?Math.max(25,e.timeRemaining()-5):1e9),o=i.context.treeLen<s&&n.doc.length>s+1e3,a=i.context.work((()=>bf&&bf()||Date.now()>r),s+(o?0:1e5));this.chunkBudget-=Date.now()-t,(a||this.chunkBudget<=0)&&(i.context.takeTree(),this.view.dispatch({effects:cf.setState.of(new vf(i.context))})),this.chunkBudget>0&&(!a||o)&&this.scheduleWork(),this.checkAsyncSchedule(i.context)}checkAsyncSchedule(e){e.scheduleOn&&(this.workScheduled++,e.scheduleOn.then((()=>this.scheduleWork())).catch((e=>hl(this.view.state,e))).then((()=>this.workScheduled--)),e.scheduleOn=null)}destroy(){this.working&&this.working()}isWorking(){return!!(this.working||this.workScheduled>0)}},{eventHandlers:{focus(){this.scheduleWork()}}}),_f=Ki.define({combine:e=>e.length?e[0]:null,enables:e=>[cf.state,yf,fh.contentAttributes.compute([e],(t=>{let n=t.facet(e);return n&&n.name?{'data-language':n.name}:{}}))]});class wf{constructor(e,t=[]){this.language=e,this.support=t,this.extension=[e,t]}}const kf=Ki.define(),Of=Ki.define({combine:e=>{if(!e.length)return'  ';let t=e[0];if(!t||/\S/.test(t)||Array.from(t).some((e=>e!=t[0])))throw new Error('Invalid indent unit: '+JSON.stringify(e[0]));return t}});function Sf(e){let t=e.facet(Of);return 9==t.charCodeAt(0)?e.tabSize*t.length:t.length}function Tf(e,t){let n='',s=e.tabSize,i=e.facet(Of)[0];if('\t'==i){for(;t>=s;)n+='\t',t-=s;i=' '}for(let e=0;e<t;e++)n+=i;return n}function If(e,t){e instanceof Fr&&(e=new Cf(e));for(let n of e.state.facet(kf)){let s=n(e,t);if(void 0!==s)return s}let n=df(e.state);return n.length>=t?function(e,t,n){let s=t.resolveStack(n),i=t.resolveInner(n,-1).resolve(n,0).enterUnfinishedNodesBefore(n);if(i!=s.node){let e=[];for(let t=i;t&&(t.from!=s.node.from||t.type!=s.node.type);t=t.parent)e.push(t);for(let t=e.length-1;t>=0;t--)s={node:e[t],next:s}}return Af(s,e,n)}(e,n,t):null}class Cf{constructor(e,t={}){this.state=e,this.options=t,this.unit=Sf(e)}lineAt(e,t=1){let n=this.state.doc.lineAt(e),{simulateBreak:s,simulateDoubleBreak:i}=this.options;return null!=s&&s>=n.from&&s<=n.to?i&&s==e?{text:'',from:e}:(t<0?s<e:s<=e)?{text:n.text.slice(s-n.from),from:s}:{text:n.text.slice(0,s-n.from),from:n.from}:n}textAfterPos(e,t=1){if(this.options.simulateDoubleBreak&&e==this.options.simulateBreak)return'';let{text:n,from:s}=this.lineAt(e,t);return n.slice(e-s,Math.min(n.length,e+100-s))}column(e,t=1){let{text:n,from:s}=this.lineAt(e,t),i=this.countColumn(n,e-s),r=this.options.overrideIndentation?this.options.overrideIndentation(s):-1;return r>-1&&(i+=r-this.countColumn(n,n.search(/\S|$/))),i}countColumn(e,t=e.length){return so(e,this.state.tabSize,t)}lineIndent(e,t=1){let{text:n,from:s}=this.lineAt(e,t),i=this.options.overrideIndentation;if(i){let e=i(s);if(e>-1)return e}return this.countColumn(n,n.search(/\S|$/))}get simulatedBreak(){return this.options.simulateBreak||null}}const $f=new id;function Af(e,t,n){for(let s=e;s;s=s.next){let e=Ef(s.node);if(e)return e(Df.create(t,n,s))}return 0}function Ef(e){let t=e.type.prop($f);if(t)return t;let n,s=e.firstChild;if(s&&(n=s.type.prop(id.closedBy))){let t=e.lastChild,s=t&&n.indexOf(t.name)>-1;return e=>Bf(e,!0,1,void 0,s&&!function(e){return e.pos==e.options.simulateBreak&&e.options.simulateDoubleBreak}(e)?t.from:void 0)}return null==e.parent?Pf:null}function Pf(){return 0}class Df extends Cf{constructor(e,t,n){super(e.state,e.options),this.base=e,this.pos=t,this.context=n}get node(){return this.context.node}static create(e,t,n){return new Df(e,t,n)}get textAfter(){return this.textAfterPos(this.pos)}get baseIndent(){return this.baseIndentFor(this.node)}baseIndentFor(e){let t=this.state.doc.lineAt(e.from);for(;;){let n=e.resolve(t.from);for(;n.parent&&n.parent.from==n.from;)n=n.parent;if(Mf(n,e))break;t=this.state.doc.lineAt(n.from)}return this.lineIndent(t.from)}continue(){return Af(this.context.next,this.base,this.pos)}}function Mf(e,t){for(let n=t;n;n=n.parent)if(e==n)return!0;return!1}function Lf({closing:e,align:t=!0,units:n=1}){return s=>Bf(s,t,n,e)}function Bf(e,t,n,s,i){let r=e.textAfter,o=r.match(/^\s*/)[0].length,a=s&&r.slice(o,o+s.length)==s||i==e.pos+o,l=t?function(e){let t=e.node,n=t.childAfter(t.from),s=t.lastChild;if(!n)return null;let i=e.options.simulateBreak,r=e.state.doc.lineAt(n.from),o=null==i||i<=r.from?r.to:Math.min(r.to,i);for(let e=n.to;;){let i=t.childAfter(e);if(!i||i==s)return null;if(!i.type.isSkipped){if(i.from>=o)return null;let e=/^ */.exec(r.text.slice(n.to-r.from))[0].length;return{from:n.from,to:n.to+e}}e=i.to}}(e):null;return l?a?e.column(l.from):e.column(l.to):e.baseIndent+(a?0:e.unit*n)}function Nf(){return Fr.transactionFilter.of((e=>{if(!e.docChanged||!e.isUserEvent('input.type')&&!e.isUserEvent('input.complete'))return e;let t=e.startState.languageDataAt('indentOnInput',e.startState.selection.main.head);if(!t.length)return e;let n=e.newDoc,{head:s}=e.newSelection.main,i=n.lineAt(s);if(s>i.from+200)return e;let r=n.sliceString(i.from,s);if(!t.some((e=>e.test(r))))return e;let{state:o}=e,a=-1,l=[];for(let{head:e}of o.selection.ranges){let t=o.doc.lineAt(e);if(t.from==a)continue;a=t.from;let n=If(o,t.from);if(null==n)continue;let s=/^\s*/.exec(t.text)[0],i=Tf(o,n);s!=i&&l.push({from:t.from,to:t.from+s.length,insert:i})}return l.length?[e,{changes:l,sequential:!0}]:e}))}const Rf=Ki.define(),Ff=new id;function Vf(e){let t=e.lastChild;return t&&t.to==e.to&&t.type.isError}function zf(e,t,n){for(let s of e.facet(Rf)){let i=s(e,t,n);if(i)return i}return function(e,t,n){let s=df(e);if(s.length<n)return null;let i=null;for(let r=s.resolveStack(n,1);r;r=r.next){let o=r.node;if(o.to<=n||o.from>n)continue;if(i&&o.from<t)break;let a=o.type.prop(Ff);if(a&&(o.to<s.length-50||s.length==e.doc.length||!Vf(o))){let s=a(o,e);s&&s.from<=n&&s.from>=t&&s.to>n&&(i=s)}}return i}(e,t,n)}function Uf(e,t){let n=t.mapPos(e.from,1),s=t.mapPos(e.to,-1);return n>=s?void 0:{from:n,to:s}}const Wf=Ir.define({map:Uf}),Qf=Ir.define({map:Uf});function jf(e){let t=[];for(let{head:n}of e.state.selection.ranges)t.some((e=>e.from<=n&&e.to>=n))||t.push(e.lineBlockAt(n));return t}const Xf=ir.define({create:()=>xa.none,update(e,t){e=e.map(t.changes);for(let n of t.effects)if(n.is(Wf)&&!qf(e,n.value.from,n.value.to)){let{preparePlaceholder:s}=t.state.facet(Jf),i=s?xa.replace({widget:new sp(s(t.state,n.value))}):np;e=e.update({add:[i.range(n.value.from,n.value.to)]})}else n.is(Qf)&&(e=e.update({filter:(e,t)=>n.value.from!=e||n.value.to!=t,filterFrom:n.value.from,filterTo:n.value.to}));if(t.selection){let n=!1,{head:s}=t.selection.main;e.between(s,s,((e,t)=>{e<s&&t>s&&(n=!0)})),n&&(e=e.update({filterFrom:s,filterTo:s,filter:(e,t)=>t<=s||e>=s}))}return e},provide:e=>fh.decorations.from(e),toJSON(e,t){let n=[];return e.between(0,t.doc.length,((e,t)=>{n.push(e,t)})),n},fromJSON(e){if(!Array.isArray(e)||e.length%2)throw new RangeError('Invalid JSON for fold state');let t=[];for(let n=0;n<e.length;){let s=e[n++],i=e[n++];if('number'!=typeof s||'number'!=typeof i)throw new RangeError('Invalid JSON for fold state');t.push(np.range(s,i))}return xa.set(t,!0)}});function Gf(e,t,n){var s;let i=null;return null===(s=e.field(Xf,!1))||void 0===s||s.between(t,n,((e,t)=>{(!i||i.from>e)&&(i={from:e,to:t})})),i}function qf(e,t,n){let s=!1;return e.between(t,t,((e,i)=>{e==t&&i==n&&(s=!0)})),s}function Hf(e,t){return e.field(Xf,!1)?t:t.concat(Ir.appendConfig.of(ep()))}function Yf(e,t,n=!0){let s=e.state.doc.lineAt(t.from).number,i=e.state.doc.lineAt(t.to).number;return fh.announce.of(`${e.state.phrase(n?'Folded lines':'Unfolded lines')} ${s} ${e.state.phrase('to')} ${i}.`)}const Kf=[{key:'Ctrl-Shift-[',mac:'Cmd-Alt-[',run:e=>{for(let t of jf(e)){let n=zf(e.state,t.from,t.to);if(n)return e.dispatch({effects:Hf(e.state,[Wf.of(n),Yf(e,n)])}),!0}return!1}},{key:'Ctrl-Shift-]',mac:'Cmd-Alt-]',run:e=>{if(!e.state.field(Xf,!1))return!1;let t=[];for(let n of jf(e)){let s=Gf(e.state,n.from,n.to);s&&t.push(Qf.of(s),Yf(e,s,!1))}return t.length&&e.dispatch({effects:t}),t.length>0}},{key:'Ctrl-Alt-[',run:e=>{let{state:t}=e,n=[];for(let s=0;s<t.doc.length;){let i=e.lineBlockAt(s),r=zf(t,i.from,i.to);r&&n.push(Wf.of(r)),s=(r?e.lineBlockAt(r.to):i).to+1}return n.length&&e.dispatch({effects:Hf(e.state,n)}),!!n.length}},{key:'Ctrl-Alt-]',run:e=>{let t=e.state.field(Xf,!1);if(!t||!t.size)return!1;let n=[];return t.between(0,e.state.doc.length,((e,t)=>{n.push(Qf.of({from:e,to:t}))})),e.dispatch({effects:n}),!0}}],Zf={placeholderDOM:null,preparePlaceholder:null,placeholderText:''},Jf=Ki.define({combine:e=>Vr(e,Zf)});function ep(e){let t=[Xf,ap];return e&&t.push(Jf.of(e)),t}function tp(e,t){let{state:n}=e,s=n.facet(Jf),i=t=>{let n=e.lineBlockAt(e.posAtDOM(t.target)),s=Gf(e.state,n.from,n.to);s&&e.dispatch({effects:Qf.of(s)}),t.preventDefault()};if(s.placeholderDOM)return s.placeholderDOM(e,i,t);let r=document.createElement('span');return r.textContent=s.placeholderText,r.setAttribute('aria-label',n.phrase('folded code')),r.title=n.phrase('unfold'),r.className='cm-foldPlaceholder',r.onclick=i,r}const np=xa.replace({widget:new class extends ga{toDOM(e){return tp(e,null)}}});class sp extends ga{constructor(e){super(),this.value=e}eq(e){return this.value==e.value}toDOM(e){return tp(e,this.value)}}const ip={openText:'',closedText:'',markerDOM:null,domEventHandlers:{},foldingChanged:()=>!1};class rp extends Eu{constructor(e,t){super(),this.config=e,this.open=t}eq(e){return this.config==e.config&&this.open==e.open}toDOM(e){if(this.config.markerDOM)return this.config.markerDOM(this.open);let t=document.createElement('span');return t.textContent=this.open?this.config.openText:this.config.closedText,t.title=e.state.phrase(this.open?'Fold line':'Unfold line'),t}}function op(e={}){let t=Object.assign(Object.assign({},ip),e),n=new rp(t,!0),s=new rp(t,!1),i=pl.fromClass(class{constructor(e){this.from=e.viewport.from,this.markers=this.buildMarkers(e)}update(e){(e.docChanged||e.viewportChanged||e.startState.facet(_f)!=e.state.facet(_f)||e.startState.field(Xf,!1)!=e.state.field(Xf,!1)||df(e.startState)!=df(e.state)||t.foldingChanged(e))&&(this.markers=this.buildMarkers(e.view))}buildMarkers(e){let t=new Xr;for(let i of e.viewportLineBlocks){let r=Gf(e.state,i.from,i.to)?s:zf(e.state,i.from,i.to)?n:null;r&&t.add(i.from,i.from,r)}return t.finish()}}),{domEventHandlers:r}=t;return[i,Bu({class:'cm-foldGutter',markers(e){var t;return(null===(t=e.plugin(i))||void 0===t?void 0:t.markers)||jr.empty},initialSpacer:()=>new rp(t,!1),domEventHandlers:Object.assign(Object.assign({},r),{click:(e,t,n)=>{if(r.click&&r.click(e,t,n))return!0;let s=Gf(e.state,t.from,t.to);if(s)return e.dispatch({effects:Qf.of(s)}),!0;let i=zf(e.state,t.from,t.to);return!!i&&(e.dispatch({effects:Wf.of(i)}),!0)}})}),ep()]}const ap=fh.baseTheme({'.cm-foldPlaceholder':{backgroundColor:'#eee',border:'1px solid #ddd',color:'#888',borderRadius:'.2em',margin:'0 1px',padding:'0 1px',cursor:'pointer'},'.cm-foldGutter span':{padding:'0 1px',cursor:'pointer'}});class lp{constructor(e,t){let n;function s(e){let t=ao.newName();return(n||(n=Object.create(null)))['.'+t]=e,t}this.specs=e;const i='string'==typeof t.all?t.all:t.all?s(t.all):void 0,r=t.scope;this.scope=r instanceof cf?e=>e.prop(af)==r.data:r?e=>e==r:void 0,this.style=Vd(e.map((e=>({tag:e.tag,class:e.class||s(Object.assign({},e,{tag:null}))}))),{all:i}).style,this.module=n?new ao(n):null,this.themeType=t.themeType}static define(e,t){return new lp(e,t||{})}}const cp=Ki.define(),hp=Ki.define({combine:e=>e.length?[e[0]]:null});function up(e){let t=e.facet(cp);return t.length?t:e.facet(hp)}function dp(e,t){let n,s=[pp];return e instanceof lp&&(e.module&&s.push(fh.styleModule.of(e.module)),n=e.themeType),(null==t?void 0:t.fallback)?s.push(hp.of(e)):n?s.push(cp.computeN([fh.darkTheme],(t=>t.facet(fh.darkTheme)==('dark'==n)?[e]:[]))):s.push(cp.of(e)),s}class fp{constructor(e){this.markCache=Object.create(null),this.tree=df(e.state),this.decorations=this.buildDeco(e,up(e.state)),this.decoratedTo=e.viewport.to}update(e){let t=df(e.state),n=up(e.state),s=n!=up(e.startState),{viewport:i}=e.view,r=e.changes.mapPos(this.decoratedTo,1);t.length<i.to&&!s&&t.type==this.tree.type&&r>=i.to?(this.decorations=this.decorations.map(e.changes),this.decoratedTo=r):(t!=this.tree||e.viewportChanged||s)&&(this.tree=t,this.decorations=this.buildDeco(e.view,n),this.decoratedTo=i.to)}buildDeco(e,t){if(!t||!this.tree.length)return xa.none;let n=new Xr;for(let{from:s,to:i}of e.visibleRanges)zd(this.tree,t,((e,t,s)=>{n.add(e,t,this.markCache[s]||(this.markCache[s]=xa.mark({class:s})))}),s,i);return n.finish()}}const pp=hr.high(pl.fromClass(fp,{decorations:e=>e.decorations})),mp=lp.define([{tag:rf.meta,color:'#404740'},{tag:rf.link,textDecoration:'underline'},{tag:rf.heading,textDecoration:'underline',fontWeight:'bold'},{tag:rf.emphasis,fontStyle:'italic'},{tag:rf.strong,fontWeight:'bold'},{tag:rf.strikethrough,textDecoration:'line-through'},{tag:rf.keyword,color:'#708'},{tag:[rf.atom,rf.bool,rf.url,rf.contentSeparator,rf.labelName],color:'#219'},{tag:[rf.literal,rf.inserted],color:'#164'},{tag:[rf.string,rf.deleted],color:'#a11'},{tag:[rf.regexp,rf.escape,rf.special(rf.string)],color:'#e40'},{tag:rf.definition(rf.variableName),color:'#00f'},{tag:rf.local(rf.variableName),color:'#30a'},{tag:[rf.typeName,rf.namespace],color:'#085'},{tag:rf.className,color:'#167'},{tag:[rf.special(rf.variableName),rf.macroName],color:'#256'},{tag:rf.definition(rf.propertyName),color:'#00c'},{tag:rf.comment,color:'#940'},{tag:rf.invalid,color:'#f00'}]),gp=fh.baseTheme({'&.cm-focused .cm-matchingBracket':{backgroundColor:'#328c8252'},'&.cm-focused .cm-nonmatchingBracket':{backgroundColor:'#bb555544'}}),vp='()[]{}',xp=Ki.define({combine:e=>Vr(e,{afterCursor:!0,brackets:vp,maxScanDistance:1e4,renderMatch:_p})}),bp=xa.mark({class:'cm-matchingBracket'}),yp=xa.mark({class:'cm-nonmatchingBracket'});function _p(e){let t=[],n=e.matched?bp:yp;return t.push(n.range(e.start.from,e.start.to)),e.end&&t.push(n.range(e.end.from,e.end.to)),t}const wp=ir.define({create:()=>xa.none,update(e,t){if(!t.docChanged&&!t.selection)return e;let n=[],s=t.state.facet(xp);for(let e of t.state.selection.ranges){if(!e.empty)continue;let i=Cp(t.state,e.head,-1,s)||e.head>0&&Cp(t.state,e.head-1,1,s)||s.afterCursor&&(Cp(t.state,e.head,1,s)||e.head<t.state.doc.length&&Cp(t.state,e.head+1,-1,s));i&&(n=n.concat(s.renderMatch(i,t.state)))}return xa.set(n,!0)},provide:e=>fh.decorations.from(e)}),kp=[wp,gp];function Op(e={}){return[xp.of(e),kp]}const Sp=new id;function Tp(e,t,n){let s=e.prop(t<0?id.openedBy:id.closedBy);if(s)return s;if(1==e.name.length){let s=n.indexOf(e.name);if(s>-1&&s%2==(t<0?1:0))return[n[s+t]]}return null}function Ip(e){let t=e.type.prop(Sp);return t?t(e.node):e}function Cp(e,t,n,s={}){let i=s.maxScanDistance||1e4,r=s.brackets||vp,o=df(e),a=o.resolveInner(t,n);for(let s=a;s;s=s.parent){let i=Tp(s.type,n,r);if(i&&s.from<s.to){let o=Ip(s);if(o&&(n>0?t>=o.from&&t<o.to:t>o.from&&t<=o.to))return $p(e,t,n,s,o,i,r)}}return function(e,t,n,s,i,r,o){let a=n<0?e.sliceDoc(t-1,t):e.sliceDoc(t,t+1),l=o.indexOf(a);if(l<0||l%2==0!=n>0)return null;let c={from:n<0?t-1:t,to:n>0?t+1:t},h=e.doc.iterRange(t,n>0?e.doc.length:0),u=0;for(let e=0;!h.next().done&&e<=r;){let r=h.value;n<0&&(e+=r.length);let a=t+e*n;for(let e=n>0?0:r.length-1,t=n>0?r.length:-1;e!=t;e+=n){let t=o.indexOf(r[e]);if(!(t<0||s.resolveInner(a+e,1).type!=i))if(t%2==0==n>0)u++;else{if(1==u)return{start:c,end:{from:a+e,to:a+e+1},matched:t>>1==l>>1};u--}}n>0&&(e+=r.length)}return h.done?{start:c,matched:!1}:null}(e,t,n,o,a.type,i,r)}function $p(e,t,n,s,i,r,o){let a=s.parent,l={from:i.from,to:i.to},c=0,h=null==a?void 0:a.cursor();if(h&&(n<0?h.childBefore(s.from):h.childAfter(s.to)))do{if(n<0?h.to<=s.from:h.from>=s.to){if(0==c&&r.indexOf(h.type.name)>-1&&h.from<h.to){let e=Ip(h);return{start:l,end:e?{from:e.from,to:e.to}:void 0,matched:!0}}if(Tp(h.type,n,o))c++;else if(Tp(h.type,-n,o)){if(0==c){let e=Ip(h);return{start:l,end:e&&e.from<e.to?{from:e.from,to:e.to}:void 0,matched:!1}}c--}}}while(n<0?h.prevSibling():h.nextSibling());return{start:l,matched:!1}}const Ap=Object.create(null),Ep=[ad.none],Pp=[],Dp=Object.create(null),Mp=Object.create(null);for(let[e,t]of[['variable','variableName'],['variable-2','variableName.special'],['string-2','string.special'],['def','variableName.definition'],['tag','tagName'],['attribute','attributeName'],['type','typeName'],['builtin','variableName.standard'],['qualifier','modifier'],['error','invalid'],['header','heading'],['property','propertyName']])Mp[e]=Bp(Ap,t);function Lp(e,t){Pp.indexOf(e)>-1||(Pp.push(e),console.warn(t))}function Bp(e,t){let n=[];for(let s of t.split(' ')){let t=[];for(let n of s.split('.')){let s=e[n]||rf[n];s?'function'==typeof s?t.length?t=t.map(s):Lp(n,`Modifier ${n} used at start of tag`):t.length?Lp(n,`Tag ${n} used as modifier`):t=Array.isArray(s)?s:[s]:Lp(n,`Unknown highlighting tag ${n}`)}for(let e of t)n.push(e)}if(!n.length)return 0;let s=t.replace(/ /g,'_'),i=s+' '+n.map((e=>e.id)),r=Dp[i];if(r)return r.id;let o=Dp[i]=ad.define({id:Ep.length,name:s,props:[Nd({[s]:n})]});return Ep.push(o),o.id}Aa.RTL,Aa.LTR;function Np(e,t){return({state:n,dispatch:s})=>{if(n.readOnly)return!1;let i=e(t,n);return!!i&&(s(n.update(i)),!0)}}const Rp=Np(Qp,0),Fp=Np(Wp,0),Vp=Np(((e,t)=>Wp(e,t,function(e){let t=[];for(let n of e.selection.ranges){let s=e.doc.lineAt(n.from),i=n.to<=s.to?s:e.doc.lineAt(n.to);i.from>s.from&&i.from==n.to&&(i=n.to==s.to+1?s:e.doc.lineAt(n.to-1));let r=t.length-1;r>=0&&t[r].to>s.from?t[r].to=i.to:t.push({from:s.from+/^\s*/.exec(s.text)[0].length,to:i.to})}return t}(t))),0);function zp(e,t){let n=e.languageDataAt('commentTokens',t);return n.length?n[0]:{}}const Up=50;function Wp(e,t,n=t.selection.ranges){let s=n.map((e=>zp(t,e.from).block));if(!s.every((e=>e)))return null;let i=n.map(((e,n)=>function(e,{open:t,close:n},s,i){let r,o,a=e.sliceDoc(s-Up,s),l=e.sliceDoc(i,i+Up),c=/\s*$/.exec(a)[0].length,h=/^\s*/.exec(l)[0].length,u=a.length-c;if(a.slice(u-t.length,u)==t&&l.slice(h,h+n.length)==n)return{open:{pos:s-c,margin:c&&1},close:{pos:i+h,margin:h&&1}};i-s<=2*Up?r=o=e.sliceDoc(s,i):(r=e.sliceDoc(s,s+Up),o=e.sliceDoc(i-Up,i));let d=/^\s*/.exec(r)[0].length,f=/\s*$/.exec(o)[0].length,p=o.length-f-n.length;return r.slice(d,d+t.length)==t&&o.slice(p,p+n.length)==n?{open:{pos:s+d+t.length,margin:/\s/.test(r.charAt(d+t.length))?1:0},close:{pos:i-f-n.length,margin:/\s/.test(o.charAt(p-1))?1:0}}:null}(t,s[n],e.from,e.to)));if(2!=e&&!i.every((e=>e)))return{changes:t.changes(n.map(((e,t)=>i[t]?[]:[{from:e.from,insert:s[t].open+' '},{from:e.to,insert:' '+s[t].close}])))};if(1!=e&&i.some((e=>e))){let e=[];for(let t,n=0;n<i.length;n++)if(t=i[n]){let i=s[n],{open:r,close:o}=t;e.push({from:r.pos-i.open.length,to:r.pos+r.margin},{from:o.pos-o.margin,to:o.pos+i.close.length})}return{changes:e}}return null}function Qp(e,t,n=t.selection.ranges){let s=[],i=-1;for(let{from:e,to:r}of n){let n=s.length,o=1e9,a=zp(t,e).line;if(a){for(let n=e;n<=r;){let l=t.doc.lineAt(n);if(l.from>i&&(e==r||r>l.from)){i=l.from;let e=/^\s*/.exec(l.text)[0].length,t=e==l.length,n=l.text.slice(e,e+a.length)==a?e:-1;e<l.text.length&&e<o&&(o=e),s.push({line:l,comment:n,token:a,indent:e,empty:t,single:!1})}n=l.to+1}if(o<1e9)for(let e=n;e<s.length;e++)s[e].indent<s[e].line.text.length&&(s[e].indent=o);s.length==n+1&&(s[n].single=!0)}}if(2!=e&&s.some((e=>e.comment<0&&(!e.empty||e.single)))){let e=[];for(let{line:t,token:n,indent:i,empty:r,single:o}of s)!o&&r||e.push({from:t.from+i,insert:n+' '});let n=t.changes(e);return{changes:n,selection:t.selection.map(n,1)}}if(1!=e&&s.some((e=>e.comment>=0))){let e=[];for(let{line:t,comment:n,token:i}of s)if(n>=0){let s=t.from+n,r=s+i.length;' '==t.text[r-t.from]&&r++,e.push({from:s,to:r})}return{changes:e}}return null}const jp=Or.define(),Xp=Or.define(),Gp=Ki.define(),qp=Ki.define({combine:e=>Vr(e,{minDepth:100,newGroupDelay:500,joinToEvent:(e,t)=>t},{minDepth:Math.max,newGroupDelay:Math.min,joinToEvent:(e,t)=>(n,s)=>e(n,s)||t(n,s)})}),Hp=ir.define({create:()=>dm.empty,update(e,t){let n=t.state.facet(qp),s=t.annotation(jp);if(s){let i=nm.fromTransaction(t,s.selection),r=s.side,o=0==r?e.undone:e.done;return o=i?sm(o,o.length,n.minDepth,i):am(o,t.startState.selection),new dm(0==r?s.rest:o,0==r?o:s.rest)}let i=t.annotation(Xp);if('full'!=i&&'before'!=i||(e=e.isolate()),!1===t.annotation(Cr.addToHistory))return t.changes.empty?e:e.addMapping(t.changes.desc);let r=nm.fromTransaction(t),o=t.annotation(Cr.time),a=t.annotation(Cr.userEvent);return r?e=e.addChanges(r,o,a,n,t):t.selection&&(e=e.addSelection(t.startState.selection,o,a,n.newGroupDelay)),'full'!=i&&'after'!=i||(e=e.isolate()),e},toJSON:e=>({done:e.done.map((e=>e.toJSON())),undone:e.undone.map((e=>e.toJSON()))}),fromJSON:e=>new dm(e.done.map(nm.fromJSON),e.undone.map(nm.fromJSON))});function Yp(e={}){return[Hp,qp.of(e),fh.domEventHandlers({beforeinput(e,t){let n='historyUndo'==e.inputType?Zp:'historyRedo'==e.inputType?Jp:null;return!!n&&(e.preventDefault(),n(t))}})]}function Kp(e,t){return({state:n,dispatch:s})=>{if(!t&&n.readOnly)return!1;let i=n.field(Hp,!1);if(!i)return!1;let r=i.pop(e,n,t);return!!r&&(s(r),!0)}}const Zp=Kp(0,!1),Jp=Kp(1,!1),em=Kp(0,!0),tm=Kp(1,!0);class nm{constructor(e,t,n,s,i){this.changes=e,this.effects=t,this.mapped=n,this.startSelection=s,this.selectionsAfter=i}setSelAfter(e){return new nm(this.changes,this.effects,this.mapped,this.startSelection,e)}toJSON(){var e,t,n;return{changes:null===(e=this.changes)||void 0===e?void 0:e.toJSON(),mapped:null===(t=this.mapped)||void 0===t?void 0:t.toJSON(),startSelection:null===(n=this.startSelection)||void 0===n?void 0:n.toJSON(),selectionsAfter:this.selectionsAfter.map((e=>e.toJSON()))}}static fromJSON(e){return new nm(e.changes&&Vi.fromJSON(e.changes),[],e.mapped&&Fi.fromJSON(e.mapped),e.startSelection&&qi.fromJSON(e.startSelection),e.selectionsAfter.map(qi.fromJSON))}static fromTransaction(e,t){let n=rm;for(let t of e.startState.facet(Gp)){let s=t(e);s.length&&(n=n.concat(s))}return!n.length&&e.changes.empty?null:new nm(e.changes.invert(e.startState.doc),n,void 0,t||e.startState.selection,rm)}static selection(e){return new nm(void 0,rm,void 0,void 0,e)}}function sm(e,t,n,s){let i=t+1>n+20?t-n-1:0,r=e.slice(i,t);return r.push(s),r}function im(e,t){return e.length?t.length?e.concat(t):e:t}const rm=[],om=200;function am(e,t){if(e.length){let n=e[e.length-1],s=n.selectionsAfter.slice(Math.max(0,n.selectionsAfter.length-om));return s.length&&s[s.length-1].eq(t)?e:(s.push(t),sm(e,e.length-1,1e9,n.setSelAfter(s)))}return[nm.selection([t])]}function lm(e){let t=e[e.length-1],n=e.slice();return n[e.length-1]=t.setSelAfter(t.selectionsAfter.slice(0,t.selectionsAfter.length-1)),n}function cm(e,t){if(!e.length)return e;let n=e.length,s=rm;for(;n;){let i=hm(e[n-1],t,s);if(i.changes&&!i.changes.empty||i.effects.length){let t=e.slice(0,n);return t[n-1]=i,t}t=i.mapped,n--,s=i.selectionsAfter}return s.length?[nm.selection(s)]:rm}function hm(e,t,n){let s=im(e.selectionsAfter.length?e.selectionsAfter.map((e=>e.map(t))):rm,n);if(!e.changes)return nm.selection(s);let i=e.changes.map(t),r=t.mapDesc(e.changes,!0),o=e.mapped?e.mapped.composeDesc(r):r;return new nm(i,Ir.mapEffects(e.effects,t),o,e.startSelection.map(r),s)}const um=/^(input\.type|delete)($|\.)/;class dm{constructor(e,t,n=0,s=void 0){this.done=e,this.undone=t,this.prevTime=n,this.prevUserEvent=s}isolate(){return this.prevTime?new dm(this.done,this.undone):this}addChanges(e,t,n,s,i){let r=this.done,o=r[r.length-1];return r=o&&o.changes&&!o.changes.empty&&e.changes&&(!n||um.test(n))&&(!o.selectionsAfter.length&&t-this.prevTime<s.newGroupDelay&&s.joinToEvent(i,function(e,t){let n=[],s=!1;return e.iterChangedRanges(((e,t)=>n.push(e,t))),t.iterChangedRanges(((e,t,i,r)=>{for(let e=0;e<n.length;){let t=n[e++],o=n[e++];r>=t&&i<=o&&(s=!0)}})),s}(o.changes,e.changes))||'input.type.compose'==n)?sm(r,r.length-1,s.minDepth,new nm(e.changes.compose(o.changes),im(Ir.mapEffects(e.effects,o.changes),o.effects),o.mapped,o.startSelection,rm)):sm(r,r.length,s.minDepth,e),new dm(r,rm,t,n)}addSelection(e,t,n,s){let i=this.done.length?this.done[this.done.length-1].selectionsAfter:rm;return i.length>0&&t-this.prevTime<s&&n==this.prevUserEvent&&n&&/^select($|\.)/.test(n)&&(r=i[i.length-1],o=e,r.ranges.length==o.ranges.length&&0===r.ranges.filter(((e,t)=>e.empty!=o.ranges[t].empty)).length)?this:new dm(am(this.done,e),this.undone,t,n);var r,o}addMapping(e){return new dm(cm(this.done,e),cm(this.undone,e),this.prevTime,this.prevUserEvent)}pop(e,t,n){let s=0==e?this.done:this.undone;if(0==s.length)return null;let i=s[s.length-1],r=i.selectionsAfter[0]||t.selection;if(n&&i.selectionsAfter.length)return t.update({selection:i.selectionsAfter[i.selectionsAfter.length-1],annotations:jp.of({side:e,rest:lm(s),selection:r}),userEvent:0==e?'select.undo':'select.redo',scrollIntoView:!0});if(i.changes){let n=1==s.length?rm:s.slice(0,s.length-1);return i.mapped&&(n=cm(n,i.mapped)),t.update({changes:i.changes,selection:i.startSelection,effects:i.effects,annotations:jp.of({side:e,rest:n,selection:r}),filter:!1,userEvent:0==e?'undo':'redo',scrollIntoView:!0})}return null}}dm.empty=new dm(rm,rm);const fm=[{key:'Mod-z',run:Zp,preventDefault:!0},{key:'Mod-y',mac:'Mod-Shift-z',run:Jp,preventDefault:!0},{linux:'Ctrl-Shift-z',run:Jp,preventDefault:!0},{key:'Mod-u',run:em,preventDefault:!0},{key:'Alt-u',mac:'Mod-Shift-u',run:tm,preventDefault:!0}];function pm(e,t){return qi.create(e.ranges.map(t),e.mainIndex)}function mm(e,t){return e.update({selection:t,scrollIntoView:!0,userEvent:'select'})}function gm({state:e,dispatch:t},n){let s=pm(e.selection,n);return!s.eq(e.selection,!0)&&(t(mm(e,s)),!0)}function vm(e,t){return qi.cursor(t?e.to:e.from)}function xm(e,t){return gm(e,(n=>n.empty?e.moveByChar(n,t):vm(n,t)))}function bm(e){return e.textDirectionAt(e.state.selection.main.head)==Aa.LTR}const ym=e=>xm(e,!bm(e)),_m=e=>xm(e,bm(e));function wm(e,t){return gm(e,(n=>n.empty?e.moveByGroup(n,t):vm(n,t)))}function km(e,t,n){if(t.type.prop(n))return!0;let s=t.to-t.from;return s&&(s>2||/[^\s,.;:]/.test(e.sliceDoc(t.from,t.to)))||t.firstChild}function Om(e,t,n){let s,i,r=df(e).resolveInner(t.head),o=n?id.closedBy:id.openedBy;for(let s=t.head;;){let t=n?r.childAfter(s):r.childBefore(s);if(!t)break;km(e,t,o)?r=t:s=n?t.to:t.from}return i=r.type.prop(o)&&(s=n?Cp(e,r.from,1):Cp(e,r.to,-1))&&s.matched?n?s.end.to:s.end.from:n?r.to:r.from,qi.cursor(i,n?-1:1)}function Sm(e,t){return gm(e,(n=>{if(!n.empty)return vm(n,t);let s=e.moveVertically(n,t);return s.head!=n.head?s:e.moveToLineBoundary(n,t)}))}const Tm=e=>Sm(e,!1),Im=e=>Sm(e,!0);function Cm(e){let t,n=e.scrollDOM.clientHeight<e.scrollDOM.scrollHeight-2,s=0,i=0;if(n){for(let t of e.state.facet(fh.scrollMargins)){let n=t(e);(null==n?void 0:n.top)&&(s=Math.max(null==n?void 0:n.top,s)),(null==n?void 0:n.bottom)&&(i=Math.max(null==n?void 0:n.bottom,i))}t=e.scrollDOM.clientHeight-s-i}else t=(e.dom.ownerDocument.defaultView||window).innerHeight;return{marginTop:s,marginBottom:i,selfScroll:n,height:Math.max(e.defaultLineHeight,t-5)}}function $m(e,t){let n,s=Cm(e),{state:i}=e,r=pm(i.selection,(n=>n.empty?e.moveVertically(n,t,s.height):vm(n,t)));if(r.eq(i.selection))return!1;if(s.selfScroll){let t=e.coordsAtPos(i.selection.main.head),o=e.scrollDOM.getBoundingClientRect(),a=o.top+s.marginTop,l=o.bottom-s.marginBottom;t&&t.top>a&&t.bottom<l&&(n=fh.scrollIntoView(r.main.head,{y:'start',yMargin:t.top-a}))}return e.dispatch(mm(i,r),{effects:n}),!0}const Am=e=>$m(e,!1),Em=e=>$m(e,!0);function Pm(e,t,n){let s=e.lineBlockAt(t.head),i=e.moveToLineBoundary(t,n);if(i.head==t.head&&i.head!=(n?s.to:s.from)&&(i=e.moveToLineBoundary(t,n,!1)),!n&&i.head==s.from&&s.length){let n=/^\s*/.exec(e.state.sliceDoc(s.from,Math.min(s.from+100,s.to)))[0].length;n&&t.head!=s.from+n&&(i=qi.cursor(s.from+n))}return i}function Dm(e,t){let n=pm(e.state.selection,(e=>{let n=t(e);return qi.range(e.anchor,n.head,n.goalColumn,n.bidiLevel||void 0)}));return!n.eq(e.state.selection)&&(e.dispatch(mm(e.state,n)),!0)}function Mm(e,t){return Dm(e,(n=>e.moveByChar(n,t)))}const Lm=e=>Mm(e,!bm(e)),Bm=e=>Mm(e,bm(e));function Nm(e,t){return Dm(e,(n=>e.moveByGroup(n,t)))}function Rm(e,t){return Dm(e,(n=>e.moveVertically(n,t)))}const Fm=e=>Rm(e,!1),Vm=e=>Rm(e,!0);function zm(e,t){return Dm(e,(n=>e.moveVertically(n,t,Cm(e).height)))}const Um=e=>zm(e,!1),Wm=e=>zm(e,!0),Qm=({state:e,dispatch:t})=>(t(mm(e,{anchor:0})),!0),jm=({state:e,dispatch:t})=>(t(mm(e,{anchor:e.doc.length})),!0),Xm=({state:e,dispatch:t})=>(t(mm(e,{anchor:e.selection.main.anchor,head:0})),!0),Gm=({state:e,dispatch:t})=>(t(mm(e,{anchor:e.selection.main.anchor,head:e.doc.length})),!0);function qm(e,t){if(e.state.readOnly)return!1;let n='delete.selection',{state:s}=e,i=s.changeByRange((s=>{let{from:i,to:r}=s;if(i==r){let o=t(s);o<i?(n='delete.backward',o=Hm(e,o,!1)):o>i&&(n='delete.forward',o=Hm(e,o,!0)),i=Math.min(i,o),r=Math.max(r,o)}else i=Hm(e,i,!1),r=Hm(e,r,!0);return i==r?{range:s}:{changes:{from:i,to:r},range:qi.cursor(i,i<s.head?-1:1)}}));return!i.changes.empty&&(e.dispatch(s.update(i,{scrollIntoView:!0,userEvent:n,effects:'delete.selection'==n?fh.announce.of(s.phrase('Selection deleted')):void 0})),!0)}function Hm(e,t,n){if(e instanceof fh)for(let s of e.state.facet(fh.atomicRanges).map((t=>t(e))))s.between(t,t,((e,s)=>{e<t&&s>t&&(t=n?s:e)}));return t}const Ym=(e,t,n)=>qm(e,(s=>{let i,r,o=s.from,{state:a}=e,l=a.doc.lineAt(o);if(n&&!t&&o>l.from&&o<l.from+200&&!/[^ \t]/.test(i=l.text.slice(0,o-l.from))){if('\t'==i[i.length-1])return o-1;let e=so(i,a.tabSize)%Sf(a)||Sf(a);for(let t=0;t<e&&' '==i[i.length-1-t];t++)o--;r=o}else r=Di(l.text,o-l.from,t,t)+l.from,r==o&&l.number!=(t?a.doc.lines:1)?r+=t?1:-1:!t&&/[\ufe00-\ufe0f]/.test(l.text.slice(r-l.from,o-l.from))&&(r=Di(l.text,r-l.from,!1,!1)+l.from);return r})),Km=e=>Ym(e,!1,!0),Zm=e=>Ym(e,!0,!1),Jm=(e,t)=>qm(e,(n=>{let s=n.head,{state:i}=e,r=i.doc.lineAt(s),o=i.charCategorizer(s);for(let e=null;;){if(s==(t?r.to:r.from)){s==n.head&&r.number!=(t?i.doc.lines:1)&&(s+=t?1:-1);break}let a=Di(r.text,s-r.from,t)+r.from,l=r.text.slice(Math.min(s,a)-r.from,Math.max(s,a)-r.from),c=o(l);if(null!=e&&c!=e)break;' '==l&&s==n.head||(e=c),s=a}return s})),eg=e=>Jm(e,!1);function tg(e){let t=[],n=-1;for(let s of e.selection.ranges){let i=e.doc.lineAt(s.from),r=e.doc.lineAt(s.to);if(s.empty||s.to!=r.from||(r=e.doc.lineAt(s.to-1)),n>=i.number){let e=t[t.length-1];e.to=r.to,e.ranges.push(s)}else t.push({from:i.from,to:r.to,ranges:[s]});n=r.number+1}return t}function ng(e,t,n){if(e.readOnly)return!1;let s=[],i=[];for(let t of tg(e)){if(n?t.to==e.doc.length:0==t.from)continue;let r=e.doc.lineAt(n?t.to+1:t.from-1),o=r.length+1;if(n){s.push({from:t.to,to:r.to},{from:t.from,insert:r.text+e.lineBreak});for(let n of t.ranges)i.push(qi.range(Math.min(e.doc.length,n.anchor+o),Math.min(e.doc.length,n.head+o)))}else{s.push({from:r.from,to:t.from},{from:t.to,insert:e.lineBreak+r.text});for(let e of t.ranges)i.push(qi.range(e.anchor-o,e.head-o))}}return!!s.length&&(t(e.update({changes:s,scrollIntoView:!0,selection:qi.create(i,e.selection.mainIndex),userEvent:'move.line'})),!0)}function sg(e,t,n){if(e.readOnly)return!1;let s=[];for(let t of tg(e))n?s.push({from:t.from,insert:e.doc.slice(t.from,t.to)+e.lineBreak}):s.push({from:t.to,insert:e.lineBreak+e.doc.slice(t.from,t.to)});return t(e.update({changes:s,scrollIntoView:!0,userEvent:'input.copyline'})),!0}const ig=rg(!1);function rg(e){return({state:t,dispatch:n})=>{if(t.readOnly)return!1;let s=t.changeByRange((n=>{let{from:s,to:i}=n,r=t.doc.lineAt(s),o=!e&&s==i&&function(e,t){if(/\(\)|\[\]|\{\}/.test(e.sliceDoc(t-1,t+1)))return{from:t,to:t};let n,s=df(e).resolveInner(t),i=s.childBefore(t),r=s.childAfter(t);return i&&r&&i.to<=t&&r.from>=t&&(n=i.type.prop(id.closedBy))&&n.indexOf(r.name)>-1&&e.doc.lineAt(i.to).from==e.doc.lineAt(r.from).from&&!/\S/.test(e.sliceDoc(i.to,r.from))?{from:i.to,to:r.from}:null}(t,s);e&&(s=i=(i<=r.to?r:t.doc.lineAt(i)).to);let a=new Cf(t,{simulateBreak:s,simulateDoubleBreak:!!o}),l=If(a,s);for(null==l&&(l=so(/^\s*/.exec(t.doc.lineAt(s).text)[0],t.tabSize));i<r.to&&/\s/.test(r.text[i-r.from]);)i++;o?({from:s,to:i}=o):s>r.from&&s<r.from+100&&!/\S/.test(r.text.slice(0,s))&&(s=r.from);let c=['',Tf(t,l)];return o&&c.push(Tf(t,a.lineIndent(r.from,-1))),{changes:{from:s,to:i,insert:ki.of(c)},range:qi.cursor(s+1+c[1].length)}}));return n(t.update(s,{scrollIntoView:!0,userEvent:'input'})),!0}}function og(e,t){let n=-1;return e.changeByRange((s=>{let i=[];for(let r=s.from;r<=s.to;){let o=e.doc.lineAt(r);o.number>n&&(s.empty||s.to>o.from)&&(t(o,i,s),n=o.number),r=o.to+1}let r=e.changes(i);return{changes:i,range:qi.range(r.mapPos(s.anchor,1),r.mapPos(s.head,1))}}))}const ag=({state:e,dispatch:t})=>!e.readOnly&&(t(e.update(og(e,((t,n)=>{n.push({from:t.from,insert:e.facet(Of)})})),{userEvent:'input.indent'})),!0),lg=({state:e,dispatch:t})=>!e.readOnly&&(t(e.update(og(e,((t,n)=>{let s=/^\s*/.exec(t.text)[0];if(!s)return;let i=so(s,e.tabSize),r=0,o=Tf(e,Math.max(0,i-Sf(e)));for(;r<s.length&&r<o.length&&s.charCodeAt(r)==o.charCodeAt(r);)r++;n.push({from:t.from+r,to:t.from+s.length,insert:o.slice(r)})})),{userEvent:'delete.dedent'})),!0),cg=[{key:'Alt-ArrowLeft',mac:'Ctrl-ArrowLeft',run:e=>gm(e,(t=>Om(e.state,t,!bm(e)))),shift:e=>Dm(e,(t=>Om(e.state,t,!bm(e))))},{key:'Alt-ArrowRight',mac:'Ctrl-ArrowRight',run:e=>gm(e,(t=>Om(e.state,t,bm(e)))),shift:e=>Dm(e,(t=>Om(e.state,t,bm(e))))},{key:'Alt-ArrowUp',run:({state:e,dispatch:t})=>ng(e,t,!1)},{key:'Shift-Alt-ArrowUp',run:({state:e,dispatch:t})=>sg(e,t,!1)},{key:'Alt-ArrowDown',run:({state:e,dispatch:t})=>ng(e,t,!0)},{key:'Shift-Alt-ArrowDown',run:({state:e,dispatch:t})=>sg(e,t,!0)},{key:'Escape',run:({state:e,dispatch:t})=>{let n=e.selection,s=null;return n.ranges.length>1?s=qi.create([n.main]):n.main.empty||(s=qi.create([qi.cursor(n.main.head)])),!!s&&(t(mm(e,s)),!0)}},{key:'Mod-Enter',run:rg(!0)},{key:'Alt-l',mac:'Ctrl-l',run:({state:e,dispatch:t})=>{let n=tg(e).map((({from:t,to:n})=>qi.range(t,Math.min(n+1,e.doc.length))));return t(e.update({selection:qi.create(n),userEvent:'select'})),!0}},{key:'Mod-i',run:({state:e,dispatch:t})=>{let n=pm(e.selection,(t=>{let n=df(e),s=n.resolveStack(t.from,1);if(t.empty){let e=n.resolveStack(t.from,-1);e.node.from>=s.node.from&&e.node.to<=s.node.to&&(s=e)}for(let e=s;e;e=e.next){let{node:n}=e;if((n.from<t.from&&n.to>=t.to||n.to>t.to&&n.from<=t.from)&&e.next)return qi.range(n.to,n.from)}return t}));return!n.eq(e.selection)&&(t(mm(e,n)),!0)},preventDefault:!0},{key:'Mod-[',run:lg},{key:'Mod-]',run:ag},{key:'Mod-Alt-\\',run:({state:e,dispatch:t})=>{if(e.readOnly)return!1;let n=Object.create(null),s=new Cf(e,{overrideIndentation:e=>{let t=n[e];return t??-1}}),i=og(e,((t,i,r)=>{let o=If(s,t.from);if(null==o)return;/\S/.test(t.text)||(o=0);let a=/^\s*/.exec(t.text)[0],l=Tf(e,o);(a!=l||r.from<t.from+a.length)&&(n[t.from]=o,i.push({from:t.from,to:t.from+a.length,insert:l}))}));return i.changes.empty||t(e.update(i,{userEvent:'indent'})),!0}},{key:'Shift-Mod-k',run:e=>{if(e.state.readOnly)return!1;let{state:t}=e,n=t.changes(tg(t).map((({from:e,to:n})=>(e>0?e--:n<t.doc.length&&n++,{from:e,to:n})))),s=pm(t.selection,(t=>{let n;if(e.lineWrapping){let s=e.lineBlockAt(t.head),i=e.coordsAtPos(t.head,t.assoc||1);i&&(n=s.bottom+e.documentTop-i.bottom+e.defaultLineHeight/2)}return e.moveVertically(t,!0,n)})).map(n);return e.dispatch({changes:n,selection:s,scrollIntoView:!0,userEvent:'delete.line'}),!0}},{key:'Shift-Mod-\\',run:({state:e,dispatch:t})=>function(e,t,n){let s=!1,i=pm(e.selection,(t=>{let i=Cp(e,t.head,-1)||Cp(e,t.head,1)||t.head>0&&Cp(e,t.head-1,1)||t.head<e.doc.length&&Cp(e,t.head+1,-1);if(!i||!i.end)return t;s=!0;let r=i.start.from==t.head?i.end.to:i.end.from;return n?qi.range(t.anchor,r):qi.cursor(r)}));return!!s&&(t(mm(e,i)),!0)}(e,t,!1)},{key:'Mod-/',run:e=>{let{state:t}=e,n=t.doc.lineAt(t.selection.main.from),s=zp(e.state,n.from);return s.line?Rp(e):!!s.block&&Vp(e)}},{key:'Alt-A',run:Fp},{key:'Ctrl-m',mac:'Shift-Alt-m',run:e=>(e.setTabFocusMode(),!0)}].concat([{key:'ArrowLeft',run:ym,shift:Lm,preventDefault:!0},{key:'Mod-ArrowLeft',mac:'Alt-ArrowLeft',run:e=>wm(e,!bm(e)),shift:e=>Nm(e,!bm(e)),preventDefault:!0},{mac:'Cmd-ArrowLeft',run:e=>gm(e,(t=>Pm(e,t,!bm(e)))),shift:e=>Dm(e,(t=>Pm(e,t,!bm(e)))),preventDefault:!0},{key:'ArrowRight',run:_m,shift:Bm,preventDefault:!0},{key:'Mod-ArrowRight',mac:'Alt-ArrowRight',run:e=>wm(e,bm(e)),shift:e=>Nm(e,bm(e)),preventDefault:!0},{mac:'Cmd-ArrowRight',run:e=>gm(e,(t=>Pm(e,t,bm(e)))),shift:e=>Dm(e,(t=>Pm(e,t,bm(e)))),preventDefault:!0},{key:'ArrowUp',run:Tm,shift:Fm,preventDefault:!0},{mac:'Cmd-ArrowUp',run:Qm,shift:Xm},{mac:'Ctrl-ArrowUp',run:Am,shift:Um},{key:'ArrowDown',run:Im,shift:Vm,preventDefault:!0},{mac:'Cmd-ArrowDown',run:jm,shift:Gm},{mac:'Ctrl-ArrowDown',run:Em,shift:Wm},{key:'PageUp',run:Am,shift:Um},{key:'PageDown',run:Em,shift:Wm},{key:'Home',run:e=>gm(e,(t=>Pm(e,t,!1))),shift:e=>Dm(e,(t=>Pm(e,t,!1))),preventDefault:!0},{key:'Mod-Home',run:Qm,shift:Xm},{key:'End',run:e=>gm(e,(t=>Pm(e,t,!0))),shift:e=>Dm(e,(t=>Pm(e,t,!0))),preventDefault:!0},{key:'Mod-End',run:jm,shift:Gm},{key:'Enter',run:ig,shift:ig},{key:'Mod-a',run:({state:e,dispatch:t})=>(t(e.update({selection:{anchor:0,head:e.doc.length},userEvent:'select'})),!0)},{key:'Backspace',run:Km,shift:Km},{key:'Delete',run:Zm},{key:'Mod-Backspace',mac:'Alt-Backspace',run:eg},{key:'Mod-Delete',mac:'Alt-Delete',run:e=>Jm(e,!0)},{mac:'Mod-Backspace',run:e=>qm(e,(t=>{let n=e.moveToLineBoundary(t,!1).head;return t.head>n?n:Math.max(0,t.head-1)}))},{mac:'Mod-Delete',run:e=>qm(e,(t=>{let n=e.moveToLineBoundary(t,!0).head;return t.head<n?n:Math.min(e.state.doc.length,t.head+1)}))}].concat([{key:'Ctrl-b',run:ym,shift:Lm,preventDefault:!0},{key:'Ctrl-f',run:_m,shift:Bm},{key:'Ctrl-p',run:Tm,shift:Fm},{key:'Ctrl-n',run:Im,shift:Vm},{key:'Ctrl-a',run:e=>gm(e,(t=>qi.cursor(e.lineBlockAt(t.head).from,1))),shift:e=>Dm(e,(t=>qi.cursor(e.lineBlockAt(t.head).from)))},{key:'Ctrl-e',run:e=>gm(e,(t=>qi.cursor(e.lineBlockAt(t.head).to,-1))),shift:e=>Dm(e,(t=>qi.cursor(e.lineBlockAt(t.head).to)))},{key:'Ctrl-d',run:Zm},{key:'Ctrl-h',run:Km},{key:'Ctrl-k',run:e=>qm(e,(t=>{let n=e.lineBlockAt(t.head).to;return t.head<n?n:Math.min(e.state.doc.length,t.head+1)}))},{key:'Ctrl-Alt-h',run:eg},{key:'Ctrl-o',run:({state:e,dispatch:t})=>{if(e.readOnly)return!1;let n=e.changeByRange((e=>({changes:{from:e.from,to:e.to,insert:ki.of(['',''])},range:qi.cursor(e.from)})));return t(e.update(n,{scrollIntoView:!0,userEvent:'input'})),!0}},{key:'Ctrl-t',run:({state:e,dispatch:t})=>{if(e.readOnly)return!1;let n=e.changeByRange((t=>{if(!t.empty||0==t.from||t.from==e.doc.length)return{range:t};let n=t.from,s=e.doc.lineAt(n),i=n==s.from?n-1:Di(s.text,n-s.from,!1)+s.from,r=n==s.to?n+1:Di(s.text,n-s.from,!0)+s.from;return{changes:{from:i,to:r,insert:e.doc.slice(n,r).append(e.doc.slice(i,n))},range:qi.cursor(r)}}));return!n.changes.empty&&(t(e.update(n,{scrollIntoView:!0,userEvent:'move.character'})),!0)}},{key:'Ctrl-v',run:Em}].map((e=>({mac:e.key,run:e.run,shift:e.shift}))))),hg={key:'Tab',run:ag,shift:lg};function ug(){var e=arguments[0];'string'==typeof e&&(e=document.createElement(e));var t=1,n=arguments[1];if(n&&'object'==typeof n&&null==n.nodeType&&!Array.isArray(n)){for(var s in n)if(Object.prototype.hasOwnProperty.call(n,s)){var i=n[s];'string'==typeof i?e.setAttribute(s,i):null!=i&&(e[s]=i)}t++}for(;t<arguments.length;t++)dg(e,arguments[t]);return e}function dg(e,t){if('string'==typeof t)e.appendChild(document.createTextNode(t));else if(null==t);else if(null!=t.nodeType)e.appendChild(t);else{if(!Array.isArray(t))throw new RangeError('Unsupported child node: '+t);for(var n=0;n<t.length;n++)dg(e,t[n])}}const fg='function'==typeof String.prototype.normalize?e=>e.normalize('NFKD'):e=>e;class pg{constructor(e,t,n=0,s=e.length,i,r){this.test=r,this.value={from:0,to:0},this.done=!1,this.matches=[],this.buffer='',this.bufferPos=0,this.iter=e.iterRange(n,s),this.bufferStart=n,this.normalize=i?e=>i(fg(e)):fg,this.query=this.normalize(t)}peek(){if(this.bufferPos==this.buffer.length){if(this.bufferStart+=this.buffer.length,this.iter.next(),this.iter.done)return-1;this.bufferPos=0,this.buffer=this.iter.value}return Mi(this.buffer,this.bufferPos)}next(){for(;this.matches.length;)this.matches.pop();return this.nextOverlapping()}nextOverlapping(){for(;;){let e=this.peek();if(e<0)return this.done=!0,this;let t=Li(e),n=this.bufferStart+this.bufferPos;this.bufferPos+=Bi(e);let s=this.normalize(t);if(s.length)for(let e=0,i=n;;e++){let r=s.charCodeAt(e),o=this.match(r,i,this.bufferPos+this.bufferStart);if(e==s.length-1){if(o)return this.value=o,this;break}i==n&&e<t.length&&t.charCodeAt(e)==r&&i++}}}match(e,t,n){let s=null;for(let t=0;t<this.matches.length;t+=2){let i=this.matches[t],r=!1;this.query.charCodeAt(i)==e&&(i==this.query.length-1?s={from:this.matches[t+1],to:n}:(this.matches[t]++,r=!0)),r||(this.matches.splice(t,2),t-=2)}return this.query.charCodeAt(0)==e&&(1==this.query.length?s={from:t,to:n}:this.matches.push(1,t)),s&&this.test&&!this.test(s.from,s.to,this.buffer,this.bufferStart)&&(s=null),s}}'undefined'!=typeof Symbol&&(pg.prototype[Symbol.iterator]=function(){return this});const mg={from:-1,to:-1,match:/.*/.exec('')},gg='gm'+(null==/x/.unicode?'':'u');class vg{constructor(e,t,n,s=0,i=e.length){if(this.text=e,this.to=i,this.curLine='',this.done=!1,this.value=mg,/\\[sWDnr]|\n|\r|\[\^/.test(t))return new yg(e,t,n,s,i);this.re=new RegExp(t,gg+((null==n?void 0:n.ignoreCase)?'i':'')),this.test=null==n?void 0:n.test,this.iter=e.iter();let r=e.lineAt(s);this.curLineStart=r.from,this.matchPos=_g(e,s),this.getLine(this.curLineStart)}getLine(e){this.iter.next(e),this.iter.lineBreak?this.curLine='':(this.curLine=this.iter.value,this.curLineStart+this.curLine.length>this.to&&(this.curLine=this.curLine.slice(0,this.to-this.curLineStart)),this.iter.next())}nextLine(){this.curLineStart=this.curLineStart+this.curLine.length+1,this.curLineStart>this.to?this.curLine='':this.getLine(0)}next(){for(let e=this.matchPos-this.curLineStart;;){this.re.lastIndex=e;let t=this.matchPos<=this.to&&this.re.exec(this.curLine);if(t){let n=this.curLineStart+t.index,s=n+t[0].length;if(this.matchPos=_g(this.text,s+(n==s?1:0)),n==this.curLineStart+this.curLine.length&&this.nextLine(),(n<s||n>this.value.to)&&(!this.test||this.test(n,s,t)))return this.value={from:n,to:s,match:t},this;e=this.matchPos-this.curLineStart}else{if(!(this.curLineStart+this.curLine.length<this.to))return this.done=!0,this;this.nextLine(),e=0}}}}const xg=new WeakMap;class bg{constructor(e,t){this.from=e,this.text=t}get to(){return this.from+this.text.length}static get(e,t,n){let s=xg.get(e);if(!s||s.from>=n||s.to<=t){let s=new bg(t,e.sliceString(t,n));return xg.set(e,s),s}if(s.from==t&&s.to==n)return s;let{text:i,from:r}=s;return r>t&&(i=e.sliceString(t,r)+i,r=t),s.to<n&&(i+=e.sliceString(s.to,n)),xg.set(e,new bg(r,i)),new bg(t,i.slice(t-r,n-r))}}class yg{constructor(e,t,n,s,i){this.text=e,this.to=i,this.done=!1,this.value=mg,this.matchPos=_g(e,s),this.re=new RegExp(t,gg+((null==n?void 0:n.ignoreCase)?'i':'')),this.test=null==n?void 0:n.test,this.flat=bg.get(e,s,this.chunkEnd(s+5e3))}chunkEnd(e){return e>=this.to?this.to:this.text.lineAt(e).to}next(){for(;;){let e=this.re.lastIndex=this.matchPos-this.flat.from,t=this.re.exec(this.flat.text);if(t&&!t[0]&&t.index==e&&(this.re.lastIndex=e+1,t=this.re.exec(this.flat.text)),t){let e=this.flat.from+t.index,n=e+t[0].length;if((this.flat.to>=this.to||t.index+t[0].length<=this.flat.text.length-10)&&(!this.test||this.test(e,n,t)))return this.value={from:e,to:n,match:t},this.matchPos=_g(this.text,n+(e==n?1:0)),this}if(this.flat.to==this.to)return this.done=!0,this;this.flat=bg.get(this.text,this.flat.from,this.chunkEnd(this.flat.from+2*this.flat.text.length))}}}function _g(e,t){if(t>=e.length)return t;let n,s=e.lineAt(t);for(;t<s.to&&(n=s.text.charCodeAt(t-s.from))>=56320&&n<57344;)t++;return t}function wg(e){let t=ug('input',{class:'cm-textfield',name:'line',value:String(e.state.doc.lineAt(e.state.selection.main.head).number)});function n(){let n=/^([+-])?(\d+)?(:\d+)?(%)?$/.exec(t.value);if(!n)return;let{state:s}=e,i=s.doc.lineAt(s.selection.main.head),[,r,o,a,l]=n,c=a?+a.slice(1):0,h=o?+o:i.number;if(o&&l){let e=h/100;r&&(e=e*('-'==r?-1:1)+i.number/s.doc.lines),h=Math.round(s.doc.lines*e)}else o&&r&&(h=h*('-'==r?-1:1)+i.number);let u=s.doc.line(Math.max(1,Math.min(s.doc.lines,h))),d=qi.cursor(u.from+Math.max(0,Math.min(c,u.length)));e.dispatch({effects:[kg.of(!1),fh.scrollIntoView(d.from,{y:'center'})],selection:d}),e.focus()}return{dom:ug('form',{class:'cm-gotoLine',onkeydown:t=>{27==t.keyCode?(t.preventDefault(),e.dispatch({effects:kg.of(!1)}),e.focus()):13==t.keyCode&&(t.preventDefault(),n())},onsubmit:e=>{e.preventDefault(),n()}},ug('label',e.state.phrase('Go to line'),': ',t),' ',ug('button',{class:'cm-button',type:'submit'},e.state.phrase('go')))}}'undefined'!=typeof Symbol&&(vg.prototype[Symbol.iterator]=yg.prototype[Symbol.iterator]=function(){return this});const kg=Ir.define(),Og=ir.define({create:()=>!0,update(e,t){for(let n of t.effects)n.is(kg)&&(e=n.value);return e},provide:e=>Au.from(e,(e=>e?wg:null))}),Sg=fh.baseTheme({'.cm-panel.cm-gotoLine':{padding:'2px 6px 4px','& label':{fontSize:'80%'}}});const Tg=Ki.define({combine:e=>Vr(e,{top:!1,caseSensitive:!1,literal:!1,regexp:!1,wholeWord:!1,createPanel:e=>new tv(e),scrollToMatch:e=>fh.scrollIntoView(e)})});class Ig{constructor(e){this.search=e.search,this.caseSensitive=!!e.caseSensitive,this.literal=!!e.literal,this.regexp=!!e.regexp,this.replace=e.replace||'',this.valid=!!this.search&&(!this.regexp||function(e){try{return new RegExp(e,gg),!0}catch(e){return!1}}(this.search)),this.unquoted=this.unquote(this.search),this.wholeWord=!!e.wholeWord}unquote(e){return this.literal?e:e.replace(/\\([nrt\\])/g,((e,t)=>'n'==t?'\n':'r'==t?'\r':'t'==t?'\t':'\\'))}eq(e){return this.search==e.search&&this.replace==e.replace&&this.caseSensitive==e.caseSensitive&&this.regexp==e.regexp&&this.wholeWord==e.wholeWord}create(){return this.regexp?new Mg(this):new Ag(this)}getCursor(e,t=0,n){let s=e.doc?e:Fr.create({doc:e});return null==n&&(n=s.doc.length),this.regexp?Eg(this,s,t,n):$g(this,s,t,n)}}class Cg{constructor(e){this.spec=e}}function $g(e,t,n,s){return new pg(t.doc,e.unquoted,n,s,e.caseSensitive?void 0:e=>e.toLowerCase(),e.wholeWord?function(e,t){return(n,s,i,r)=>((r>n||r+i.length<s)&&(r=Math.max(0,n-2),i=e.sliceString(r,Math.min(e.length,s+2))),!(t(Pg(i,n-r))==Lr.Word&&t(Dg(i,n-r))==Lr.Word||t(Dg(i,s-r))==Lr.Word&&t(Pg(i,s-r))==Lr.Word))}(t.doc,t.charCategorizer(t.selection.main.head)):void 0)}class Ag extends Cg{constructor(e){super(e)}nextMatch(e,t,n){let s=$g(this.spec,e,n,e.doc.length).nextOverlapping();if(s.done){let n=Math.min(e.doc.length,t+this.spec.unquoted.length);s=$g(this.spec,e,0,n).nextOverlapping()}return s.done||s.value.from==t&&s.value.to==n?null:s.value}prevMatchInRange(e,t,n){for(let s=n;;){let n=Math.max(t,s-1e4-this.spec.unquoted.length),i=$g(this.spec,e,n,s),r=null;for(;!i.nextOverlapping().done;)r=i.value;if(r)return r;if(n==t)return null;s-=1e4}}prevMatch(e,t,n){let s=this.prevMatchInRange(e,0,t);return s||(s=this.prevMatchInRange(e,Math.max(0,n-this.spec.unquoted.length),e.doc.length)),!s||s.from==t&&s.to==n?null:s}getReplacement(e){return this.spec.unquote(this.spec.replace)}matchAll(e,t){let n=$g(this.spec,e,0,e.doc.length),s=[];for(;!n.next().done;){if(s.length>=t)return null;s.push(n.value)}return s}highlight(e,t,n,s){let i=$g(this.spec,e,Math.max(0,t-this.spec.unquoted.length),Math.min(n+this.spec.unquoted.length,e.doc.length));for(;!i.next().done;)s(i.value.from,i.value.to)}}function Eg(e,t,n,s){return new vg(t.doc,e.search,{ignoreCase:!e.caseSensitive,test:e.wholeWord?(i=t.charCategorizer(t.selection.main.head),(e,t,n)=>!n[0].length||(i(Pg(n.input,n.index))!=Lr.Word||i(Dg(n.input,n.index))!=Lr.Word)&&(i(Dg(n.input,n.index+n[0].length))!=Lr.Word||i(Pg(n.input,n.index+n[0].length))!=Lr.Word)):void 0},n,s);var i}function Pg(e,t){return e.slice(Di(e,t,!1),t)}function Dg(e,t){return e.slice(t,Di(e,t))}class Mg extends Cg{nextMatch(e,t,n){let s=Eg(this.spec,e,n,e.doc.length).next();return s.done&&(s=Eg(this.spec,e,0,t).next()),s.done?null:s.value}prevMatchInRange(e,t,n){for(let s=1;;s++){let i=Math.max(t,n-1e4*s),r=Eg(this.spec,e,i,n),o=null;for(;!r.next().done;)o=r.value;if(o&&(i==t||o.from>i+10))return o;if(i==t)return null}}prevMatch(e,t,n){return this.prevMatchInRange(e,0,t)||this.prevMatchInRange(e,n,e.doc.length)}getReplacement(e){return this.spec.unquote(this.spec.replace).replace(/\$([$&]|\d+)/g,((t,n)=>{if('&'==n)return e.match[0];if('$'==n)return'$';for(let t=n.length;t>0;t--){let s=+n.slice(0,t);if(s>0&&s<e.match.length)return e.match[s]+n.slice(t)}return t}))}matchAll(e,t){let n=Eg(this.spec,e,0,e.doc.length),s=[];for(;!n.next().done;){if(s.length>=t)return null;s.push(n.value)}return s}highlight(e,t,n,s){let i=Eg(this.spec,e,Math.max(0,t-250),Math.min(n+250,e.doc.length));for(;!i.next().done;)s(i.value.from,i.value.to)}}const Lg=Ir.define(),Bg=Ir.define(),Ng=ir.define({create:e=>new Rg(Hg(e).create(),null),update(e,t){for(let n of t.effects)n.is(Lg)?e=new Rg(n.value.create(),e.panel):n.is(Bg)&&(e=new Rg(e.query,n.value?qg:null));return e},provide:e=>Au.from(e,(e=>e.panel))});class Rg{constructor(e,t){this.query=e,this.panel=t}}const Fg=xa.mark({class:'cm-searchMatch'}),Vg=xa.mark({class:'cm-searchMatch cm-searchMatch-selected'}),zg=pl.fromClass(class{constructor(e){this.view=e,this.decorations=this.highlight(e.state.field(Ng))}update(e){let t=e.state.field(Ng);(t!=e.startState.field(Ng)||e.docChanged||e.selectionSet||e.viewportChanged)&&(this.decorations=this.highlight(t))}highlight({query:e,panel:t}){if(!t||!e.spec.valid)return xa.none;let{view:n}=this,s=new Xr;for(let t=0,i=n.visibleRanges,r=i.length;t<r;t++){let{from:o,to:a}=i[t];for(;t<r-1&&a>i[t+1].from-500;)a=i[++t].to;e.highlight(n.state,o,a,((e,t)=>{let i=n.state.selection.ranges.some((n=>n.from==e&&n.to==t));s.add(e,t,i?Vg:Fg)}))}return s.finish()}},{decorations:e=>e.decorations});function Ug(e){return t=>{let n=t.state.field(Ng,!1);return n&&n.query.spec.valid?e(t,n):Zg(t)}}const Wg=Ug(((e,{query:t})=>{let{to:n}=e.state.selection.main,s=t.nextMatch(e.state,n,n);if(!s)return!1;let i=qi.single(s.from,s.to),r=e.state.facet(Tg);return e.dispatch({selection:i,effects:[rv(e,s),r.scrollToMatch(i.main,e)],userEvent:'select.search'}),Kg(e),!0})),Qg=Ug(((e,{query:t})=>{let{state:n}=e,{from:s}=n.selection.main,i=t.prevMatch(n,s,s);if(!i)return!1;let r=qi.single(i.from,i.to),o=e.state.facet(Tg);return e.dispatch({selection:r,effects:[rv(e,i),o.scrollToMatch(r.main,e)],userEvent:'select.search'}),Kg(e),!0})),jg=Ug(((e,{query:t})=>{let n=t.matchAll(e.state,1e3);return!(!n||!n.length)&&(e.dispatch({selection:qi.create(n.map((e=>qi.range(e.from,e.to)))),userEvent:'select.search.matches'}),!0)})),Xg=Ug(((e,{query:t})=>{let{state:n}=e,{from:s,to:i}=n.selection.main;if(n.readOnly)return!1;let r=t.nextMatch(n,s,s);if(!r)return!1;let o,a,l=r,c=[],h=[];if(l.from==s&&l.to==i&&(a=n.toText(t.getReplacement(l)),c.push({from:l.from,to:l.to,insert:a}),l=t.nextMatch(n,l.from,l.to),h.push(fh.announce.of(n.phrase('replaced match on line $',n.doc.lineAt(s).number)+'.'))),l){let t=0==c.length||c[0].from>=r.to?0:r.to-r.from-a.length;o=qi.single(l.from-t,l.to-t),h.push(rv(e,l)),h.push(n.facet(Tg).scrollToMatch(o.main,e))}return e.dispatch({changes:c,selection:o,effects:h,userEvent:'input.replace'}),!0})),Gg=Ug(((e,{query:t})=>{if(e.state.readOnly)return!1;let n=t.matchAll(e.state,1e9).map((e=>{let{from:n,to:s}=e;return{from:n,to:s,insert:t.getReplacement(e)}}));if(!n.length)return!1;let s=e.state.phrase('replaced $ matches',n.length)+'.';return e.dispatch({changes:n,effects:fh.announce.of(s),userEvent:'input.replace.all'}),!0}));function qg(e){return e.state.facet(Tg).createPanel(e)}function Hg(e,t){var n,s,i,r,o;let a=e.selection.main,l=a.empty||a.to>a.from+100?'':e.sliceDoc(a.from,a.to);if(t&&!l)return t;let c=e.facet(Tg);return new Ig({search:(null!==(n=null==t?void 0:t.literal)&&void 0!==n?n:c.literal)?l:l.replace(/\n/g,'\\n'),caseSensitive:null!==(s=null==t?void 0:t.caseSensitive)&&void 0!==s?s:c.caseSensitive,literal:null!==(i=null==t?void 0:t.literal)&&void 0!==i?i:c.literal,regexp:null!==(r=null==t?void 0:t.regexp)&&void 0!==r?r:c.regexp,wholeWord:null!==(o=null==t?void 0:t.wholeWord)&&void 0!==o?o:c.wholeWord})}function Yg(e){let t=Tu(e,qg);return t&&t.dom.querySelector('[main-field]')}function Kg(e){let t=Yg(e);t&&t==e.root.activeElement&&t.select()}const Zg=e=>{let t=e.state.field(Ng,!1);if(t&&t.panel){let n=Yg(e);if(n&&n!=e.root.activeElement){let s=Hg(e.state,t.query.spec);s.valid&&e.dispatch({effects:Lg.of(s)}),n.focus(),n.select()}}else e.dispatch({effects:[Bg.of(!0),t?Lg.of(Hg(e.state,t.query.spec)):Ir.appendConfig.of(av)]});return!0},Jg=e=>{let t=e.state.field(Ng,!1);if(!t||!t.panel)return!1;let n=Tu(e,qg);return n&&n.dom.contains(e.root.activeElement)&&e.focus(),e.dispatch({effects:Bg.of(!1)}),!0},ev=[{key:'Mod-f',run:Zg,scope:'editor search-panel'},{key:'F3',run:Wg,shift:Qg,scope:'editor search-panel',preventDefault:!0},{key:'Mod-g',run:Wg,shift:Qg,scope:'editor search-panel',preventDefault:!0},{key:'Escape',run:Jg,scope:'editor search-panel'},{key:'Mod-Shift-l',run:({state:e,dispatch:t})=>{let n=e.selection;if(n.ranges.length>1||n.main.empty)return!1;let{from:s,to:i}=n.main,r=[],o=0;for(let t=new pg(e.doc,e.sliceDoc(s,i));!t.next().done;){if(r.length>1e3)return!1;t.value.from==s&&(o=r.length),r.push(qi.range(t.value.from,t.value.to))}return t(e.update({selection:qi.create(r,o),userEvent:'select.search.matches'})),!0}},{key:'Mod-Alt-g',run:e=>{let t=Tu(e,wg);if(!t){let n=[kg.of(!0)];null==e.state.field(Og,!1)&&n.push(Ir.appendConfig.of([Og,Sg])),e.dispatch({effects:n}),t=Tu(e,wg)}return t&&t.dom.querySelector('input').select(),!0}},{key:'Mod-d',run:({state:e,dispatch:t})=>{let{ranges:n}=e.selection;if(n.some((e=>e.from===e.to)))return(({state:e,dispatch:t})=>{let{selection:n}=e,s=qi.create(n.ranges.map((t=>e.wordAt(t.head)||qi.cursor(t.head))),n.mainIndex);return!s.eq(n)&&(t(e.update({selection:s})),!0)})({state:e,dispatch:t});let s=e.sliceDoc(n[0].from,n[0].to);if(e.selection.ranges.some((t=>e.sliceDoc(t.from,t.to)!=s)))return!1;let i=function(e,t){let{main:n,ranges:s}=e.selection,i=e.wordAt(n.head),r=i&&i.from==n.from&&i.to==n.to;for(let n=!1,i=new pg(e.doc,t,s[s.length-1].to);;){if(i.next(),!i.done){if(n&&s.some((e=>e.from==i.value.from)))continue;if(r){let t=e.wordAt(i.value.from);if(!t||t.from!=i.value.from||t.to!=i.value.to)continue}return i.value}if(n)return null;i=new pg(e.doc,t,0,Math.max(0,s[s.length-1].from-1)),n=!0}}(e,s);return!!i&&(t(e.update({selection:e.selection.addRange(qi.range(i.from,i.to),!1),effects:fh.scrollIntoView(i.to)})),!0)},preventDefault:!0}];class tv{constructor(e){this.view=e;let t=this.query=e.state.field(Ng).query.spec;function n(e,t,n){return ug('button',{class:'cm-button',name:e,onclick:t,type:'button'},n)}this.commit=this.commit.bind(this),this.searchField=ug('input',{value:t.search,placeholder:nv(e,'Find'),'aria-label':nv(e,'Find'),class:'cm-textfield',name:'search',form:'','main-field':'true',onchange:this.commit,onkeyup:this.commit}),this.replaceField=ug('input',{value:t.replace,placeholder:nv(e,'Replace'),'aria-label':nv(e,'Replace'),class:'cm-textfield',name:'replace',form:'',onchange:this.commit,onkeyup:this.commit}),this.caseField=ug('input',{type:'checkbox',name:'case',form:'',checked:t.caseSensitive,onchange:this.commit}),this.reField=ug('input',{type:'checkbox',name:'re',form:'',checked:t.regexp,onchange:this.commit}),this.wordField=ug('input',{type:'checkbox',name:'word',form:'',checked:t.wholeWord,onchange:this.commit}),this.dom=ug('div',{onkeydown:e=>this.keydown(e),class:'cm-search'},[this.searchField,n('next',(()=>Wg(e)),[nv(e,'next')]),n('prev',(()=>Qg(e)),[nv(e,'previous')]),n('select',(()=>jg(e)),[nv(e,'all')]),ug('label',null,[this.caseField,nv(e,'match case')]),ug('label',null,[this.reField,nv(e,'regexp')]),ug('label',null,[this.wordField,nv(e,'by word')]),...e.state.readOnly?[]:[ug('br'),this.replaceField,n('replace',(()=>Xg(e)),[nv(e,'replace')]),n('replaceAll',(()=>Gg(e)),[nv(e,'replace all')])],ug('button',{name:'close',onclick:()=>Jg(e),'aria-label':nv(e,'close'),type:'button'},[''])])}commit(){let e=new Ig({search:this.searchField.value,caseSensitive:this.caseField.checked,regexp:this.reField.checked,wholeWord:this.wordField.checked,replace:this.replaceField.value});e.eq(this.query)||(this.query=e,this.view.dispatch({effects:Lg.of(e)}))}keydown(e){var t,n,s;t=this.view,n=e,s='search-panel',Ih(kh(t.state),n,t,s)?e.preventDefault():13==e.keyCode&&e.target==this.searchField?(e.preventDefault(),(e.shiftKey?Qg:Wg)(this.view)):13==e.keyCode&&e.target==this.replaceField&&(e.preventDefault(),Xg(this.view))}update(e){for(let t of e.transactions)for(let e of t.effects)e.is(Lg)&&!e.value.eq(this.query)&&this.setQuery(e.value)}setQuery(e){this.query=e,this.searchField.value=e.search,this.replaceField.value=e.replace,this.caseField.checked=e.caseSensitive,this.reField.checked=e.regexp,this.wordField.checked=e.wholeWord}mount(){this.searchField.select()}get pos(){return 80}get top(){return this.view.state.facet(Tg).top}}function nv(e,t){return e.state.phrase(t)}const sv=30,iv=/[\s\.,:;?!]/;function rv(e,{from:t,to:n}){let s=e.state.doc.lineAt(t),i=e.state.doc.lineAt(n).to,r=Math.max(s.from,t-sv),o=Math.min(i,n+sv),a=e.state.sliceDoc(r,o);if(r!=s.from)for(let e=0;e<sv;e++)if(!iv.test(a[e+1])&&iv.test(a[e])){a=a.slice(e);break}if(o!=i)for(let e=a.length-1;e>a.length-sv;e--)if(!iv.test(a[e-1])&&iv.test(a[e])){a=a.slice(0,e);break}return fh.announce.of(`${e.state.phrase('current match')}. ${a} ${e.state.phrase('on line')} ${s.number}.`)}const ov=fh.baseTheme({'.cm-panel.cm-search':{padding:'2px 6px 4px',position:'relative','& [name=close]':{position:'absolute',top:'0',right:'4px',backgroundColor:'inherit',border:'none',font:'inherit',padding:0,margin:0},'& input, & button, & label':{margin:'.2em .6em .2em 0'},'& input[type=checkbox]':{marginRight:'.2em'},'& label':{fontSize:'80%',whiteSpace:'pre'}},'&light .cm-searchMatch':{backgroundColor:'#ffff0054'},'&dark .cm-searchMatch':{backgroundColor:'#00ffff8a'},'&light .cm-searchMatch-selected':{backgroundColor:'#ff6a0054'},'&dark .cm-searchMatch-selected':{backgroundColor:'#ff00ff8a'}}),av=[Ng,hr.low(zg),ov];class lv{constructor(e,t,n,s){this.state=e,this.pos=t,this.explicit=n,this.view=s,this.abortListeners=[],this.abortOnDocChange=!1}tokenBefore(e){let t=df(this.state).resolveInner(this.pos,-1);for(;t&&e.indexOf(t.name)<0;)t=t.parent;return t?{from:t.from,to:this.pos,text:this.state.sliceDoc(t.from,this.pos),type:t.type}:null}matchBefore(e){let t=this.state.doc.lineAt(this.pos),n=Math.max(t.from,this.pos-250),s=t.text.slice(n-t.from,this.pos-t.from),i=s.search(fv(e,!1));return i<0?null:{from:n+i,to:this.pos,text:s.slice(i)}}get aborted(){return null==this.abortListeners}addEventListener(e,t,n){'abort'==e&&this.abortListeners&&(this.abortListeners.push(t),n&&n.onDocChange&&(this.abortOnDocChange=!0))}}function cv(e){let t=Object.keys(e).join(''),n=/\w/.test(t);return n&&(t=t.replace(/\w/g,'')),`[${n?'\\w':''}${t.replace(/[^\w\s]/g,'\\$&')}]`}function hv(e){let t=e.map((e=>'string'==typeof e?{label:e}:e)),[n,s]=t.every((e=>/^\w+$/.test(e.label)))?[/\w*$/,/\w+$/]:function(e){let t=Object.create(null),n=Object.create(null);for(let{label:s}of e){t[s[0]]=!0;for(let e=1;e<s.length;e++)n[s[e]]=!0}let s=cv(t)+cv(n)+'*$';return[new RegExp('^'+s),new RegExp(s)]}(t);return e=>{let i=e.matchBefore(s);return i||e.explicit?{from:i?i.from:e.pos,options:t,validFor:n}:null}}class uv{constructor(e,t,n,s){this.completion=e,this.source=t,this.match=n,this.score=s}}function dv(e){return e.selection.main.from}function fv(e,t){var n;let{source:s}=e,i=t&&'^'!=s[0],r='$'!=s[s.length-1];return i||r?new RegExp(`${i?'^':''}(?:${s})${r?'$':''}`,null!==(n=e.flags)&&void 0!==n?n:e.ignoreCase?'i':''):e}const pv=Or.define();const mv=new WeakMap;function gv(e){if(!Array.isArray(e))return e;let t=mv.get(e);return t||mv.set(e,t=hv(e)),t}const vv=Ir.define(),xv=Ir.define();class bv{constructor(e){this.pattern=e,this.chars=[],this.folded=[],this.any=[],this.precise=[],this.byWord=[],this.score=0,this.matched=[];for(let t=0;t<e.length;){let n=Mi(e,t),s=Bi(n);this.chars.push(n);let i=e.slice(t,t+s),r=i.toUpperCase();this.folded.push(Mi(r==i?i.toLowerCase():r,0)),t+=s}this.astral=e.length!=this.chars.length}ret(e,t){return this.score=e,this.matched=t,this}match(e){if(0==this.pattern.length)return this.ret(-100,[]);if(e.length<this.pattern.length)return null;let{chars:t,folded:n,any:s,precise:i,byWord:r}=this;if(1==t.length){let s=Mi(e,0),i=Bi(s),r=i==e.length?0:-100;if(s==t[0]);else{if(s!=n[0])return null;r+=-200}return this.ret(r,[0,i])}let o=e.indexOf(this.pattern);if(0==o)return this.ret(e.length==this.pattern.length?0:-100,[0,this.pattern.length]);let a=t.length,l=0;if(o<0){for(let i=0,r=Math.min(e.length,200);i<r&&l<a;){let r=Mi(e,i);r!=t[l]&&r!=n[l]||(s[l++]=i),i+=Bi(r)}if(l<a)return null}let c=0,h=0,u=!1,d=0,f=-1,p=-1,m=/[a-z]/.test(e),g=!0;for(let s=0,l=Math.min(e.length,200),v=0;s<l&&h<a;){let l=Mi(e,s);o<0&&(c<a&&l==t[c]&&(i[c++]=s),d<a&&(l==t[d]||l==n[d]?(0==d&&(f=s),p=s+1,d++):d=0));let x,b=l<255?l>=48&&l<=57||l>=97&&l<=122?2:l>=65&&l<=90?1:0:(x=Li(l))!=x.toLowerCase()?1:x!=x.toUpperCase()?2:0;(!s||1==b&&m||0==v&&0!=b)&&(t[h]==l||n[h]==l&&(u=!0)?r[h++]=s:r.length&&(g=!1)),v=b,s+=Bi(l)}return h==a&&0==r[0]&&g?this.result((u?-200:0)-100,r,e):d==a&&0==f?this.ret(-200-e.length+(p==e.length?0:-100),[0,p]):o>-1?this.ret(-700-e.length,[o,o+this.pattern.length]):d==a?this.ret(-900-e.length,[f,p]):h==a?this.result((u?-200:0)-100-700+(g?0:-1100),r,e):2==t.length?null:this.result((s[0]?-700:0)-200-1100,s,e)}result(e,t,n){let s=[],i=0;for(let e of t){let t=e+(this.astral?Bi(Mi(n,e)):1);i&&s[i-1]==e?s[i-1]=t:(s[i++]=e,s[i++]=t)}return this.ret(e-n.length,s)}}class yv{constructor(e){this.pattern=e,this.matched=[],this.score=0,this.folded=e.toLowerCase()}match(e){if(e.length<this.pattern.length)return null;let t=e.slice(0,this.pattern.length),n=t==this.pattern?0:t.toLowerCase()==this.folded?-200:null;return null==n?null:(this.matched=[0,t.length],this.score=n+(e.length==this.pattern.length?0:-100),this)}}const _v=Ki.define({combine:e=>Vr(e,{activateOnTyping:!0,activateOnCompletion:()=>!1,activateOnTypingDelay:100,selectOnOpen:!0,override:null,closeOnBlur:!0,maxRenderedOptions:100,defaultKeymap:!0,tooltipClass:()=>'',optionClass:()=>'',aboveCursor:!1,icons:!0,addToOptions:[],positionInfo:kv,filterStrict:!1,compareCompletions:(e,t)=>e.label.localeCompare(t.label),interactionDelay:75,updateSyncTime:100},{defaultKeymap:(e,t)=>e&&t,closeOnBlur:(e,t)=>e&&t,icons:(e,t)=>e&&t,tooltipClass:(e,t)=>n=>wv(e(n),t(n)),optionClass:(e,t)=>n=>wv(e(n),t(n)),addToOptions:(e,t)=>e.concat(t),filterStrict:(e,t)=>e||t})});function wv(e,t){return e?t?e+' '+t:e:t}function kv(e,t,n,s,i,r){let o,a,l=e.textDirection==Aa.RTL,c=l,h=!1,u='top',d=t.left-i.left,f=i.right-t.right,p=s.right-s.left,m=s.bottom-s.top;if(c&&d<Math.min(p,f)?c=!1:!c&&f<Math.min(p,d)&&(c=!0),p<=(c?d:f))o=Math.max(i.top,Math.min(n.top,i.bottom-m))-t.top,a=Math.min(400,c?d:f);else{h=!0,a=Math.min(400,(l?t.right:i.right-t.left)-30);let e=i.bottom-t.bottom;e>=m||e>t.top?o=n.bottom-t.top:(u='bottom',o=t.bottom-n.top)}return{style:`${u}: ${o/((t.bottom-t.top)/r.offsetHeight)}px; max-width: ${a/((t.right-t.left)/r.offsetWidth)}px`,class:'cm-completionInfo-'+(h?l?'left-narrow':'right-narrow':c?'left':'right')}}function Ov(e,t,n){if(e<=n)return{from:0,to:e};if(t<0&&(t=0),t<=e>>1){let e=Math.floor(t/n);return{from:e*n,to:(e+1)*n}}let s=Math.floor((e-t)/n);return{from:e-(s+1)*n,to:e-s*n}}class Sv{constructor(e,t,n){this.view=e,this.stateField=t,this.applyCompletion=n,this.info=null,this.infoDestroy=null,this.placeInfoReq={read:()=>this.measureInfo(),write:e=>this.placeInfo(e),key:this},this.space=null,this.currentClass='';let s=e.state.field(t),{options:i,selected:r}=s.open,o=e.state.facet(_v);this.optionContent=function(e){let t=e.addToOptions.slice();return e.icons&&t.push({render(e){let t=document.createElement('div');return t.classList.add('cm-completionIcon'),e.type&&t.classList.add(...e.type.split(/\s+/g).map((e=>'cm-completionIcon-'+e))),t.setAttribute('aria-hidden','true'),t},position:20}),t.push({render(e,t,n,s){let i=document.createElement('span');i.className='cm-completionLabel';let r=e.displayLabel||e.label,o=0;for(let e=0;e<s.length;){let t=s[e++],n=s[e++];t>o&&i.appendChild(document.createTextNode(r.slice(o,t)));let a=i.appendChild(document.createElement('span'));a.appendChild(document.createTextNode(r.slice(t,n))),a.className='cm-completionMatchedText',o=n}return o<r.length&&i.appendChild(document.createTextNode(r.slice(o))),i},position:50},{render(e){if(!e.detail)return null;let t=document.createElement('span');return t.className='cm-completionDetail',t.textContent=e.detail,t},position:80}),t.sort(((e,t)=>e.position-t.position)).map((e=>e.render))}(o),this.optionClass=o.optionClass,this.tooltipClass=o.tooltipClass,this.range=Ov(i.length,r,o.maxRenderedOptions),this.dom=document.createElement('div'),this.dom.className='cm-tooltip-autocomplete',this.updateTooltipClass(e.state),this.dom.addEventListener('mousedown',(n=>{let{options:s}=e.state.field(t).open;for(let t,i=n.target;i&&i!=this.dom;i=i.parentNode)if('LI'==i.nodeName&&(t=/-(\d+)$/.exec(i.id))&&+t[1]<s.length)return this.applyCompletion(e,s[+t[1]]),void n.preventDefault()})),this.dom.addEventListener('focusout',(t=>{let n=e.state.field(this.stateField,!1);n&&n.tooltip&&e.state.facet(_v).closeOnBlur&&t.relatedTarget!=e.contentDOM&&e.dispatch({effects:xv.of(null)})})),this.showOptions(i,s.id)}mount(){this.updateSel()}showOptions(e,t){this.list&&this.list.remove(),this.list=this.dom.appendChild(this.createListBox(e,t,this.range)),this.list.addEventListener('scroll',(()=>{this.info&&this.view.requestMeasure(this.placeInfoReq)}))}update(e){var t;let n=e.state.field(this.stateField),s=e.startState.field(this.stateField);if(this.updateTooltipClass(e.state),n!=s){let{options:i,selected:r,disabled:o}=n.open;s.open&&s.open.options==i||(this.range=Ov(i.length,r,e.state.facet(_v).maxRenderedOptions),this.showOptions(i,n.id)),this.updateSel(),o!=(null===(t=s.open)||void 0===t?void 0:t.disabled)&&this.dom.classList.toggle('cm-tooltip-autocomplete-disabled',!!o)}}updateTooltipClass(e){let t=this.tooltipClass(e);if(t!=this.currentClass){for(let e of this.currentClass.split(' '))e&&this.dom.classList.remove(e);for(let e of t.split(' '))e&&this.dom.classList.add(e);this.currentClass=t}}positioned(e){this.space=e,this.info&&this.view.requestMeasure(this.placeInfoReq)}updateSel(){let e=this.view.state.field(this.stateField),t=e.open;if((t.selected>-1&&t.selected<this.range.from||t.selected>=this.range.to)&&(this.range=Ov(t.options.length,t.selected,this.view.state.facet(_v).maxRenderedOptions),this.showOptions(t.options,e.id)),this.updateSelectedOption(t.selected)){this.destroyInfo();let{completion:n}=t.options[t.selected],{info:s}=n;if(!s)return;let i='string'==typeof s?document.createTextNode(s):s(n);if(!i)return;'then'in i?i.then((t=>{t&&this.view.state.field(this.stateField,!1)==e&&this.addInfoPane(t,n)})).catch((e=>hl(this.view.state,e,'completion info'))):this.addInfoPane(i,n)}}addInfoPane(e,t){this.destroyInfo();let n=this.info=document.createElement('div');if(n.className='cm-tooltip cm-completionInfo',null!=e.nodeType)n.appendChild(e),this.infoDestroy=null;else{let{dom:t,destroy:s}=e;n.appendChild(t),this.infoDestroy=s||null}this.dom.appendChild(n),this.view.requestMeasure(this.placeInfoReq)}updateSelectedOption(e){let t=null;for(let n=this.list.firstChild,s=this.range.from;n;n=n.nextSibling,s++)'LI'==n.nodeName&&n.id?s==e?n.hasAttribute('aria-selected')||(n.setAttribute('aria-selected','true'),t=n):n.hasAttribute('aria-selected')&&n.removeAttribute('aria-selected'):s--;return t&&function(e,t){let n=e.getBoundingClientRect(),s=t.getBoundingClientRect(),i=n.height/e.offsetHeight;s.top<n.top?e.scrollTop-=(n.top-s.top)/i:s.bottom>n.bottom&&(e.scrollTop+=(s.bottom-n.bottom)/i)}(this.list,t),t}measureInfo(){let e=this.dom.querySelector('[aria-selected]');if(!e||!this.info)return null;let t=this.dom.getBoundingClientRect(),n=this.info.getBoundingClientRect(),s=e.getBoundingClientRect(),i=this.space;if(!i){let e=this.dom.ownerDocument.documentElement;i={left:0,top:0,right:e.clientWidth,bottom:e.clientHeight}}return s.top>Math.min(i.bottom,t.bottom)-10||s.bottom<Math.max(i.top,t.top)+10?null:this.view.state.facet(_v).positionInfo(this.view,t,s,n,i,this.dom)}placeInfo(e){this.info&&(e?(e.style&&(this.info.style.cssText=e.style),this.info.className='cm-tooltip cm-completionInfo '+(e.class||'')):this.info.style.cssText='top: -1e6px')}createListBox(e,t,n){const s=document.createElement('ul');s.id=t,s.setAttribute('role','listbox'),s.setAttribute('aria-expanded','true'),s.setAttribute('aria-label',this.view.state.phrase('Completions')),s.addEventListener('mousedown',(e=>{e.target==s&&e.preventDefault()}));let i=null;for(let r=n.from;r<n.to;r++){let{completion:o,match:a}=e[r],{section:l}=o;if(l){let e='string'==typeof l?l:l.name;if(e!=i&&(r>n.from||0==n.from))if(i=e,'string'!=typeof l&&l.header)s.appendChild(l.header(l));else{s.appendChild(document.createElement('completion-section')).textContent=e}}const c=s.appendChild(document.createElement('li'));c.id=t+'-'+r,c.setAttribute('role','option');let h=this.optionClass(o);h&&(c.className=h);for(let e of this.optionContent){let t=e(o,this.view.state,this.view,a);t&&c.appendChild(t)}}return n.from&&s.classList.add('cm-completionListIncompleteTop'),n.to<e.length&&s.classList.add('cm-completionListIncompleteBottom'),s}destroyInfo(){this.info&&(this.infoDestroy&&this.infoDestroy(),this.info.remove(),this.info=null)}destroy(){this.destroyInfo()}}function Tv(e,t){return n=>new Sv(n,e,t)}function Iv(e){return 100*(e.boost||0)+(e.apply?10:0)+(e.info?5:0)+(e.type?1:0)}class Cv{constructor(e,t,n,s,i,r){this.options=e,this.attrs=t,this.tooltip=n,this.timestamp=s,this.selected=i,this.disabled=r}setSelected(e,t){return e==this.selected||e>=this.options.length?this:new Cv(this.options,Pv(t,e),this.tooltip,this.timestamp,e,this.disabled)}static build(e,t,n,s,i,r){if(s&&!r&&e.some((e=>e.isPending)))return s.setDisabled();let o=function(e,t){let n=[],s=null,i=e=>{n.push(e);let{section:t}=e.completion;if(t){s||(s=[]);let e='string'==typeof t?t:t.name;s.some((t=>t.name==e))||s.push('string'==typeof t?{name:e}:t)}},r=t.facet(_v);for(let s of e)if(s.hasResult()){let e=s.result.getMatch;if(!1===s.result.filter)for(let t of s.result.options)i(new uv(t,s.source,e?e(t):[],1e9-n.length));else{let n,o=t.sliceDoc(s.from,s.to),a=r.filterStrict?new yv(o):new bv(o);for(let t of s.result.options)if(n=a.match(t.label)){let r=t.displayLabel?e?e(t,n.matched):[]:n.matched;i(new uv(t,s.source,r,n.score+(t.boost||0)))}}}if(s){let e=Object.create(null),t=0,i=(e,t)=>{var n,s;return(null!==(n=e.rank)&&void 0!==n?n:1e9)-(null!==(s=t.rank)&&void 0!==s?s:1e9)||(e.name<t.name?-1:1)};for(let n of s.sort(i))t-=1e5,e[n.name]=t;for(let t of n){let{section:n}=t.completion;n&&(t.score+=e['string'==typeof n?n:n.name])}}let o=[],a=null,l=r.compareCompletions;for(let e of n.sort(((e,t)=>t.score-e.score||l(e.completion,t.completion)))){let t=e.completion;!a||a.label!=t.label||a.detail!=t.detail||null!=a.type&&null!=t.type&&a.type!=t.type||a.apply!=t.apply||a.boost!=t.boost?o.push(e):Iv(e.completion)>Iv(a)&&(o[o.length-1]=e),a=e.completion}return o}(e,t);if(!o.length)return s&&e.some((e=>e.isPending))?s.setDisabled():null;let a=t.facet(_v).selectOnOpen?0:-1;if(s&&s.selected!=a&&-1!=s.selected){let e=s.options[s.selected].completion;for(let t=0;t<o.length;t++)if(o[t].completion==e){a=t;break}}return new Cv(o,Pv(n,a),{pos:e.reduce(((e,t)=>t.hasResult()?Math.min(e,t.from):e),1e8),create:zv,above:i.aboveCursor},s?s.timestamp:Date.now(),a,!1)}map(e){return new Cv(this.options,this.attrs,Object.assign(Object.assign({},this.tooltip),{pos:e.mapPos(this.tooltip.pos)}),this.timestamp,this.selected,this.disabled)}setDisabled(){return new Cv(this.options,this.attrs,this.tooltip,this.timestamp,this.selected,!0)}}class $v{constructor(e,t,n){this.active=e,this.id=t,this.open=n}static start(){return new $v(Dv,'cm-ac-'+Math.floor(2e6*Math.random()).toString(36),null)}update(e){let{state:t}=e,n=t.facet(_v),s=(n.override||t.languageDataAt('autocomplete',dv(t)).map(gv)).map((t=>(this.active.find((e=>e.source==t))||new Lv(t,this.active.some((e=>0!=e.state))?1:0)).update(e,n)));s.length==this.active.length&&s.every(((e,t)=>e==this.active[t]))&&(s=this.active);let i=this.open,r=e.effects.some((e=>e.is(Nv)));i&&e.docChanged&&(i=i.map(e.changes)),e.selection||s.some((t=>t.hasResult()&&e.changes.touchesRange(t.from,t.to)))||!function(e,t){if(e==t)return!0;for(let n=0,s=0;;){for(;n<e.length&&!e[n].hasResult();)n++;for(;s<t.length&&!t[s].hasResult();)s++;let i=n==e.length,r=s==t.length;if(i||r)return i==r;if(e[n++].result!=t[s++].result)return!1}}(s,this.active)||r?i=Cv.build(s,t,this.id,i,n,r):i&&i.disabled&&!s.some((e=>e.isPending))&&(i=null),!i&&s.every((e=>!e.isPending))&&s.some((e=>e.hasResult()))&&(s=s.map((e=>e.hasResult()?new Lv(e.source,0):e)));for(let t of e.effects)t.is(Rv)&&(i=i&&i.setSelected(t.value,this.id));return s==this.active&&i==this.open?this:new $v(s,this.id,i)}get tooltip(){return this.open?this.open.tooltip:null}get attrs(){return this.open?this.open.attrs:this.active.length?Av:Ev}}const Av={'aria-autocomplete':'list'},Ev={};function Pv(e,t){let n={'aria-autocomplete':'list','aria-haspopup':'listbox','aria-controls':e};return t>-1&&(n['aria-activedescendant']=e+'-'+t),n}const Dv=[];function Mv(e,t){if(e.isUserEvent('input.complete')){let n=e.annotation(pv);if(n&&t.activateOnCompletion(n))return 12}let n=e.isUserEvent('input.type');return n&&t.activateOnTyping?5:n?1:e.isUserEvent('delete.backward')?2:e.selection?8:e.docChanged?16:0}class Lv{constructor(e,t,n=!1){this.source=e,this.state=t,this.explicit=n}hasResult(){return!1}get isPending(){return 1==this.state}update(e,t){let n=Mv(e,t),s=this;(8&n||16&n&&this.touches(e))&&(s=new Lv(s.source,0)),4&n&&0==s.state&&(s=new Lv(this.source,1)),s=s.updateFor(e,n);for(let t of e.effects)if(t.is(vv))s=new Lv(s.source,1,t.value);else if(t.is(xv))s=new Lv(s.source,0);else if(t.is(Nv))for(let e of t.value)e.source==s.source&&(s=e);return s}updateFor(e,t){return this.map(e.changes)}map(e){return this}touches(e){return e.changes.touchesRange(dv(e.state))}}class Bv extends Lv{constructor(e,t,n,s,i,r){super(e,3,t),this.limit=n,this.result=s,this.from=i,this.to=r}hasResult(){return!0}updateFor(e,t){var n;if(!(3&t))return this.map(e.changes);let s=this.result;s.map&&!e.changes.empty&&(s=s.map(s,e.changes));let i=e.changes.mapPos(this.from),r=e.changes.mapPos(this.to,1),o=dv(e.state);if(o>r||!s||2&t&&(dv(e.startState)==this.from||o<this.limit))return new Lv(this.source,4&t?1:0);let a=e.changes.mapPos(this.limit);return function(e,t,n,s){if(!e)return!1;let i=t.sliceDoc(n,s);return'function'==typeof e?e(i,n,s,t):fv(e,!0).test(i)}(s.validFor,e.state,i,r)?new Bv(this.source,this.explicit,a,s,i,r):s.update&&(s=s.update(s,i,r,new lv(e.state,o,!1)))?new Bv(this.source,this.explicit,a,s,s.from,null!==(n=s.to)&&void 0!==n?n:dv(e.state)):new Lv(this.source,1,this.explicit)}map(e){if(e.empty)return this;return(this.result.map?this.result.map(this.result,e):this.result)?new Bv(this.source,this.explicit,e.mapPos(this.limit),this.result,e.mapPos(this.from),e.mapPos(this.to,1)):new Lv(this.source,0)}touches(e){return e.changes.touchesRange(this.from,this.to)}}const Nv=Ir.define({map:(e,t)=>e.map((e=>e.map(t)))}),Rv=Ir.define(),Fv=ir.define({create:()=>$v.start(),update:(e,t)=>e.update(t),provide:e=>[gu.from(e,(e=>e.tooltip)),fh.contentAttributes.from(e,(e=>e.attrs))]});function Vv(e,t){const n=t.completion.apply||t.completion.label;let s=e.state.field(Fv).active.find((e=>e.source==t.source));return s instanceof Bv&&('string'==typeof n?e.dispatch(Object.assign(Object.assign({},function(e,t,n,s){let{main:i}=e.selection,r=n-i.from,o=s-i.from;return Object.assign(Object.assign({},e.changeByRange((a=>{if(a!=i&&n!=s&&e.sliceDoc(a.from+r,a.from+o)!=e.sliceDoc(n,s))return{range:a};let l=e.toText(t);return{changes:{from:a.from+r,to:s==i.from?a.to:a.from+o,insert:l},range:qi.cursor(a.from+r+l.length)}}))),{scrollIntoView:!0,userEvent:'input.complete'})}(e.state,n,s.from,s.to)),{annotations:pv.of(t.completion)})):n(e,t.completion,s.from,s.to),!0)}const zv=Tv(Fv,Vv);function Uv(e,t='option'){return n=>{let s=n.state.field(Fv,!1);if(!s||!s.open||s.open.disabled||Date.now()-s.open.timestamp<n.state.facet(_v).interactionDelay)return!1;let i,r=1;'page'==t&&(i=ku(n,s.open.tooltip))&&(r=Math.max(2,Math.floor(i.dom.offsetHeight/i.dom.querySelector('li').offsetHeight)-1));let{length:o}=s.open.options,a=s.open.selected>-1?s.open.selected+r*(e?1:-1):e?0:o-1;return a<0?a='page'==t?0:o-1:a>=o&&(a='page'==t?o-1:0),n.dispatch({effects:Rv.of(a)}),!0}}const Wv=e=>!!e.state.field(Fv,!1)&&(e.dispatch({effects:vv.of(!0)}),!0);class Qv{constructor(e,t){this.active=e,this.context=t,this.time=Date.now(),this.updates=[],this.done=void 0}}const jv=pl.fromClass(class{constructor(e){this.view=e,this.debounceUpdate=-1,this.running=[],this.debounceAccept=-1,this.pendingStart=!1,this.composing=0;for(let t of e.state.field(Fv).active)t.isPending&&this.startQuery(t)}update(e){let t=e.state.field(Fv),n=e.state.facet(_v);if(!e.selectionSet&&!e.docChanged&&e.startState.field(Fv)==t)return;let s=e.transactions.some((e=>{let t=Mv(e,n);return 8&t||(e.selection||e.docChanged)&&!(3&t)}));for(let t=0;t<this.running.length;t++){let n=this.running[t];if(s||n.context.abortOnDocChange&&e.docChanged||n.updates.length+e.transactions.length>50&&Date.now()-n.time>1e3){for(let e of n.context.abortListeners)try{e()}catch(e){hl(this.view.state,e)}n.context.abortListeners=null,this.running.splice(t--,1)}else n.updates.push(...e.transactions)}this.debounceUpdate>-1&&clearTimeout(this.debounceUpdate),e.transactions.some((e=>e.effects.some((e=>e.is(vv)))))&&(this.pendingStart=!0);let i=this.pendingStart?50:n.activateOnTypingDelay;if(this.debounceUpdate=t.active.some((e=>e.isPending&&!this.running.some((t=>t.active.source==e.source))))?setTimeout((()=>this.startUpdate()),i):-1,0!=this.composing)for(let t of e.transactions)t.isUserEvent('input.type')?this.composing=2:2==this.composing&&t.selection&&(this.composing=3)}startUpdate(){this.debounceUpdate=-1,this.pendingStart=!1;let{state:e}=this.view,t=e.field(Fv);for(let e of t.active)e.isPending&&!this.running.some((t=>t.active.source==e.source))&&this.startQuery(e);this.running.length&&t.open&&t.open.disabled&&(this.debounceAccept=setTimeout((()=>this.accept()),this.view.state.facet(_v).updateSyncTime))}startQuery(e){let{state:t}=this.view,n=dv(t),s=new lv(t,n,e.explicit,this.view),i=new Qv(e,s);this.running.push(i),Promise.resolve(e.source(s)).then((e=>{i.context.aborted||(i.done=e||null,this.scheduleAccept())}),(e=>{this.view.dispatch({effects:xv.of(null)}),hl(this.view.state,e)}))}scheduleAccept(){this.running.every((e=>void 0!==e.done))?this.accept():this.debounceAccept<0&&(this.debounceAccept=setTimeout((()=>this.accept()),this.view.state.facet(_v).updateSyncTime))}accept(){var e;this.debounceAccept>-1&&clearTimeout(this.debounceAccept),this.debounceAccept=-1;let t=[],n=this.view.state.facet(_v),s=this.view.state.field(Fv);for(let i=0;i<this.running.length;i++){let r=this.running[i];if(void 0===r.done)continue;if(this.running.splice(i--,1),r.done){let s=dv(r.updates.length?r.updates[0].startState:this.view.state),i=Math.min(s,r.done.from+(r.active.explicit?0:1)),o=new Bv(r.active.source,r.active.explicit,i,r.done,r.done.from,null!==(e=r.done.to)&&void 0!==e?e:s);for(let e of r.updates)o=o.update(e,n);if(o.hasResult()){t.push(o);continue}}let o=s.active.find((e=>e.source==r.active.source));if(o&&o.isPending)if(null==r.done){let e=new Lv(r.active.source,0);for(let t of r.updates)e=e.update(t,n);e.isPending||t.push(e)}else this.startQuery(o)}(t.length||s.open&&s.open.disabled)&&this.view.dispatch({effects:Nv.of(t)})}},{eventHandlers:{blur(e){let t=this.view.state.field(Fv,!1);if(t&&t.tooltip&&this.view.state.facet(_v).closeOnBlur){let n=t.open&&ku(this.view,t.open.tooltip);n&&n.dom.contains(e.relatedTarget)||setTimeout((()=>this.view.dispatch({effects:xv.of(null)})),10)}},compositionstart(){this.composing=1},compositionend(){3==this.composing&&setTimeout((()=>this.view.dispatch({effects:vv.of(!1)})),20),this.composing=0}}}),Xv='object'==typeof navigator&&/Win/.test(navigator.platform),Gv=hr.highest(fh.domEventHandlers({keydown(e,t){let n=t.state.field(Fv,!1);if(!n||!n.open||n.open.disabled||n.open.selected<0||e.key.length>1||e.ctrlKey&&(!Xv||!e.altKey)||e.metaKey)return!1;let s=n.open.options[n.open.selected],i=n.active.find((e=>e.source==s.source)),r=s.completion.commitCharacters||i.result.commitCharacters;return r&&r.indexOf(e.key)>-1&&Vv(t,s),!1}})),qv=fh.baseTheme({'.cm-tooltip.cm-tooltip-autocomplete':{'& > ul':{fontFamily:'monospace',whiteSpace:'nowrap',overflow:'hidden auto',maxWidth_fallback:'700px',maxWidth:'min(700px, 95vw)',minWidth:'250px',maxHeight:'10em',height:'100%',listStyle:'none',margin:0,padding:0,'& > li, & > completion-section':{padding:'1px 3px',lineHeight:1.2},'& > li':{overflowX:'hidden',textOverflow:'ellipsis',cursor:'pointer'},'& > completion-section':{display:'list-item',borderBottom:'1px solid silver',paddingLeft:'0.5em',opacity:.7}}},'&light .cm-tooltip-autocomplete ul li[aria-selected]':{background:'#17c',color:'white'},'&light .cm-tooltip-autocomplete-disabled ul li[aria-selected]':{background:'#777'},'&dark .cm-tooltip-autocomplete ul li[aria-selected]':{background:'#347',color:'white'},'&dark .cm-tooltip-autocomplete-disabled ul li[aria-selected]':{background:'#444'},'.cm-completionListIncompleteTop:before, .cm-completionListIncompleteBottom:after':{content:'""',opacity:.5,display:'block',textAlign:'center'},'.cm-tooltip.cm-completionInfo':{position:'absolute',padding:'3px 9px',width:'max-content',maxWidth:'400px',boxSizing:'border-box',whiteSpace:'pre-line'},'.cm-completionInfo.cm-completionInfo-left':{right:'100%'},'.cm-completionInfo.cm-completionInfo-right':{left:'100%'},'.cm-completionInfo.cm-completionInfo-left-narrow':{right:'30px'},'.cm-completionInfo.cm-completionInfo-right-narrow':{left:'30px'},'&light .cm-snippetField':{backgroundColor:'#00000022'},'&dark .cm-snippetField':{backgroundColor:'#ffffff22'},'.cm-snippetFieldPosition':{verticalAlign:'text-top',width:0,height:'1.15em',display:'inline-block',margin:'0 -0.7px -.7em',borderLeft:'1.4px dotted #888'},'.cm-completionMatchedText':{textDecoration:'underline'},'.cm-completionDetail':{marginLeft:'0.5em',fontStyle:'italic'},'.cm-completionIcon':{fontSize:'90%',width:'.8em',display:'inline-block',textAlign:'center',paddingRight:'.6em',opacity:'0.6',boxSizing:'content-box'},'.cm-completionIcon-function, .cm-completionIcon-method':{'&:after':{content:'\'\''}},'.cm-completionIcon-class':{'&:after':{content:'\'\''}},'.cm-completionIcon-interface':{'&:after':{content:'\'\''}},'.cm-completionIcon-variable':{'&:after':{content:'\'\''}},'.cm-completionIcon-constant':{'&:after':{content:'\'\''}},'.cm-completionIcon-type':{'&:after':{content:'\'\''}},'.cm-completionIcon-enum':{'&:after':{content:'\'\''}},'.cm-completionIcon-property':{'&:after':{content:'\'\''}},'.cm-completionIcon-keyword':{'&:after':{content:'\'\''}},'.cm-completionIcon-namespace':{'&:after':{content:'\'\''}},'.cm-completionIcon-text':{'&:after':{content:'\'abc\'',fontSize:'50%',verticalAlign:'middle'}}}),Hv={brackets:['(','[','{','\'','"'],before:')]}:;>',stringPrefixes:[]},Yv=Ir.define({map(e,t){let n=t.mapPos(e,-1,Ri.TrackAfter);return n??void 0}}),Kv=new class extends zr{};Kv.startSide=1,Kv.endSide=-1;const Zv=ir.define({create:()=>jr.empty,update(e,t){if(e=e.map(t.changes),t.selection){let n=t.state.doc.lineAt(t.selection.main.head);e=e.update({filter:e=>e>=n.from&&e<=n.to})}for(let n of t.effects)n.is(Yv)&&(e=e.update({add:[Kv.range(n.value,n.value+1)]}));return e}});function Jv(){return[ix,Zv]}const ex='()[]{}<>';function tx(e){for(let t=0;t<16;t+=2)if(ex.charCodeAt(t)==e)return ex.charAt(t+1);return Li(e<128?e:e+1)}function nx(e,t){return e.languageDataAt('closeBrackets',t)[0]||Hv}const sx='object'==typeof navigator&&/Android\b/.test(navigator.userAgent),ix=fh.inputHandler.of(((e,t,n,s)=>{if((sx?e.composing:e.compositionStarted)||e.state.readOnly)return!1;let i=e.state.selection.main;if(s.length>2||2==s.length&&1==Bi(Mi(s,0))||t!=i.from||n!=i.to)return!1;let r=function(e,t){let n=nx(e,e.selection.main.head),s=n.brackets||Hv.brackets;for(let i of s){let r=tx(Mi(i,0));if(t==i)return r==i?hx(e,i,s.indexOf(i+i+i)>-1,n):lx(e,i,r,n.before||Hv.before);if(t==r&&ox(e,e.selection.main.from))return cx(e,i,r)}return null}(e.state,s);return!!r&&(e.dispatch(r),!0)})),rx=[{key:'Backspace',run:({state:e,dispatch:t})=>{if(e.readOnly)return!1;let n=nx(e,e.selection.main.head).brackets||Hv.brackets,s=null,i=e.changeByRange((t=>{if(t.empty){let s=function(e,t){let n=e.sliceString(t-2,t);return Bi(Mi(n,0))==n.length?n:n.slice(1)}(e.doc,t.head);for(let i of n)if(i==s&&ax(e.doc,t.head)==tx(Mi(i,0)))return{changes:{from:t.head-i.length,to:t.head+i.length},range:qi.cursor(t.head-i.length)}}return{range:s=t}}));return s||t(e.update(i,{scrollIntoView:!0,userEvent:'delete.backward'})),!s}}];function ox(e,t){let n=!1;return e.field(Zv).between(0,e.doc.length,(e=>{e==t&&(n=!0)})),n}function ax(e,t){let n=e.sliceString(t,t+2);return n.slice(0,Bi(Mi(n,0)))}function lx(e,t,n,s){let i=null,r=e.changeByRange((r=>{if(!r.empty)return{changes:[{insert:t,from:r.from},{insert:n,from:r.to}],effects:Yv.of(r.to+t.length),range:qi.range(r.anchor+t.length,r.head+t.length)};let o=ax(e.doc,r.head);return!o||/\s/.test(o)||s.indexOf(o)>-1?{changes:{insert:t+n,from:r.head},effects:Yv.of(r.head+t.length),range:qi.cursor(r.head+t.length)}:{range:i=r}}));return i?null:e.update(r,{scrollIntoView:!0,userEvent:'input.type'})}function cx(e,t,n){let s=null,i=e.changeByRange((t=>t.empty&&ax(e.doc,t.head)==n?{changes:{from:t.head,to:t.head+n.length,insert:n},range:qi.cursor(t.head+n.length)}:s={range:t}));return s?null:e.update(i,{scrollIntoView:!0,userEvent:'input.type'})}function hx(e,t,n,s){let i=s.stringPrefixes||Hv.stringPrefixes,r=null,o=e.changeByRange((s=>{if(!s.empty)return{changes:[{insert:t,from:s.from},{insert:t,from:s.to}],effects:Yv.of(s.to+t.length),range:qi.range(s.anchor+t.length,s.head+t.length)};let o,a=s.head,l=ax(e.doc,a);if(l==t){if(ux(e,a))return{changes:{insert:t+t,from:a},effects:Yv.of(a+t.length),range:qi.cursor(a+t.length)};if(ox(e,a)){let s=n&&e.sliceDoc(a,a+3*t.length)==t+t+t?t+t+t:t;return{changes:{from:a,to:a+s.length,insert:s},range:qi.cursor(a+s.length)}}}else{if(n&&e.sliceDoc(a-2*t.length,a)==t+t&&(o=dx(e,a-2*t.length,i))>-1&&ux(e,o))return{changes:{insert:t+t+t+t,from:a},effects:Yv.of(a+t.length),range:qi.cursor(a+t.length)};if(e.charCategorizer(a)(l)!=Lr.Word&&dx(e,a,i)>-1&&!function(e,t,n,s){let i=df(e).resolveInner(t,-1),r=s.reduce(((e,t)=>Math.max(e,t.length)),0);for(let o=0;o<5;o++){let o=e.sliceDoc(i.from,Math.min(i.to,i.from+n.length+r)),a=o.indexOf(n);if(!a||a>-1&&s.indexOf(o.slice(0,a))>-1){let t=i.firstChild;for(;t&&t.from==i.from&&t.to-t.from>n.length+a;){if(e.sliceDoc(t.to-n.length,t.to)==n)return!1;t=t.firstChild}return!0}let l=i.to==t&&i.parent;if(!l)break;i=l}return!1}(e,a,t,i))return{changes:{insert:t+t,from:a},effects:Yv.of(a+t.length),range:qi.cursor(a+t.length)}}return{range:r=s}}));return r?null:e.update(o,{scrollIntoView:!0,userEvent:'input.type'})}function ux(e,t){let n=df(e).resolveInner(t+1);return n.parent&&n.from==t}function dx(e,t,n){let s=e.charCategorizer(t);if(s(e.sliceDoc(t-1,t))!=Lr.Word)return t;for(let i of n){let n=t-i.length;if(e.sliceDoc(n,t)==i&&s(e.sliceDoc(n-1,n))!=Lr.Word)return n}return-1}function fx(e={}){return[Gv,Fv,_v.of(e),jv,mx,qv]}const px=[{key:'Ctrl-Space',run:Wv},{mac:'Alt-`',run:Wv},{key:'Escape',run:e=>{let t=e.state.field(Fv,!1);return!(!t||!t.active.some((e=>0!=e.state)))&&(e.dispatch({effects:xv.of(null)}),!0)}},{key:'ArrowDown',run:Uv(!0)},{key:'ArrowUp',run:Uv(!1)},{key:'PageDown',run:Uv(!0,'page')},{key:'PageUp',run:Uv(!1,'page')},{key:'Enter',run:e=>{let t=e.state.field(Fv,!1);return!(e.state.readOnly||!t||!t.open||t.open.selected<0||t.open.disabled||Date.now()-t.open.timestamp<e.state.facet(_v).interactionDelay)&&Vv(e,t.open.options[t.open.selected])}}],mx=hr.highest(_h.computeN([_v],(e=>e.facet(_v).defaultKeymap?[px]:[])));class gx{constructor(e,t,n){this.from=e,this.to=t,this.diagnostic=n}}class vx{constructor(e,t,n){this.diagnostics=e,this.panel=t,this.selected=n}static init(e,t,n){let s=e,i=n.facet(Cx).markerFilter;i&&(s=i(s,n));let r=e.slice().sort(((e,t)=>e.from-t.from||e.to-t.to)),o=new Xr,a=[],l=0;for(let e=0;;){let t,s,i=e==r.length?null:r[e];if(!i&&!a.length)break;for(a.length?(t=l,s=a.reduce(((e,t)=>Math.min(e,t.to)),i&&i.from>t?i.from:1e8)):(t=i.from,s=i.to,a.push(i),e++);e<r.length;){let n=r[e];if(n.from!=t||!(n.to>n.from||n.to==t)){s=Math.min(n.from,s);break}a.push(n),e++,s=Math.min(n.to,s)}let c=Nx(a);if(a.some((e=>e.from==e.to||e.from==e.to-1&&n.doc.lineAt(e.from).to==e.from)))o.add(t,t,xa.widget({widget:new Ex(c),diagnostics:a.slice()}));else{let e=a.reduce(((e,t)=>t.markClass?e+' '+t.markClass:e),'');o.add(t,s,xa.mark({class:'cm-lintRange cm-lintRange-'+c+e,diagnostics:a.slice(),inclusiveEnd:a.some((e=>e.to>s))}))}l=s;for(let e=0;e<a.length;e++)a[e].to<=l&&a.splice(e--,1)}let c=o.finish();return new vx(c,t,xx(c))}}function xx(e,t=null,n=0){let s=null;return e.between(n,1e9,((e,n,{spec:i})=>{if(!(t&&i.diagnostics.indexOf(t)<0))if(s){if(i.diagnostics.indexOf(s.diagnostic)<0)return!1;s=new gx(s.from,n,s.diagnostic)}else s=new gx(e,n,t||i.diagnostics[0])})),s}const bx=Ir.define(),yx=Ir.define(),_x=Ir.define(),wx=ir.define({create:()=>new vx(xa.none,null,null),update(e,t){if(t.docChanged&&e.diagnostics.size){let n=e.diagnostics.map(t.changes),s=null,i=e.panel;if(e.selected){let i=t.changes.mapPos(e.selected.from,1);s=xx(n,e.selected.diagnostic,i)||xx(n,null,i)}!n.size&&i&&t.state.facet(Cx).autoPanel&&(i=null),e=new vx(n,i,s)}for(let n of t.effects)if(n.is(bx)){let s=t.state.facet(Cx).autoPanel?n.value.length?Dx.open:null:e.panel;e=vx.init(n.value,s,t.state)}else n.is(yx)?e=new vx(e.diagnostics,n.value?Dx.open:null,e.selected):n.is(_x)&&(e=new vx(e.diagnostics,e.panel,n.value));return e},provide:e=>[Au.from(e,(e=>e.panel)),fh.decorations.from(e,(e=>e.diagnostics))]}),kx=xa.mark({class:'cm-lintRange cm-lintRange-active'});function Ox(e,t,n){let s,{diagnostics:i}=e.state.field(wx),r=-1,o=-1;i.between(t-(n<0?1:0),t+(n>0?1:0),((e,i,{spec:a})=>{if(t>=e&&t<=i&&(e==i||(t>e||n>0)&&(t<i||n<0)))return s=a.diagnostics,r=e,o=i,!1}));let a=e.state.facet(Cx).tooltipFilter;return s&&a&&(s=a(s,e.state)),s?{pos:r,end:o,above:e.state.doc.lineAt(r).to<o,create:()=>({dom:Sx(e,s)})}:null}function Sx(e,t){return ug('ul',{class:'cm-tooltip-lint'},t.map((t=>Ax(e,t,!1))))}const Tx=e=>{let t=e.state.field(wx,!1);return!(!t||!t.panel)&&(e.dispatch({effects:yx.of(!1)}),!0)},Ix=[{key:'Mod-Shift-m',run:e=>{let t=e.state.field(wx,!1);var n,s;t&&t.panel||e.dispatch({effects:(n=e.state,s=[yx.of(!0)],n.field(wx,!1)?s:s.concat(Ir.appendConfig.of(Rx)))});let i=Tu(e,Dx.open);return i&&i.dom.querySelector('.cm-panel-lint ul').focus(),!0},preventDefault:!0},{key:'F8',run:e=>{let t=e.state.field(wx,!1);if(!t)return!1;let n=e.state.selection.main,s=t.diagnostics.iter(n.to+1);return!(!s.value&&(s=t.diagnostics.iter(0),!s.value||s.from==n.from&&s.to==n.to))&&(e.dispatch({selection:{anchor:s.from,head:s.to},scrollIntoView:!0}),!0)}}],Cx=Ki.define({combine:e=>Object.assign({sources:e.map((e=>e.source)).filter((e=>null!=e))},Vr(e.map((e=>e.config)),{delay:750,markerFilter:null,tooltipFilter:null,needsRefresh:null,hideOn:()=>null},{needsRefresh:(e,t)=>e?t?n=>e(n)||t(n):e:t}))});function $x(e){let t=[];if(e)e:for(let{name:n}of e){for(let e=0;e<n.length;e++){let s=n[e];if(/[a-zA-Z]/.test(s)&&!t.some((e=>e.toLowerCase()==s.toLowerCase()))){t.push(s);continue e}}t.push('')}return t}function Ax(e,t,n){var s;let i=n?$x(t.actions):[];return ug('li',{class:'cm-diagnostic cm-diagnostic-'+t.severity},ug('span',{class:'cm-diagnosticText'},t.renderMessage?t.renderMessage(e):t.message),null===(s=t.actions)||void 0===s?void 0:s.map(((n,s)=>{let r=!1,o=s=>{if(s.preventDefault(),r)return;r=!0;let i=xx(e.state.field(wx).diagnostics,t);i&&n.apply(e,i.from,i.to)},{name:a}=n,l=i[s]?a.indexOf(i[s]):-1,c=l<0?a:[a.slice(0,l),ug('u',a.slice(l,l+1)),a.slice(l+1)];return ug('button',{type:'button',class:'cm-diagnosticAction',onclick:o,onmousedown:o,'aria-label':` Action: ${a}${l<0?'':` (access key "${i[s]})"`}.`},c)})),t.source&&ug('div',{class:'cm-diagnosticSource'},t.source))}class Ex extends ga{constructor(e){super(),this.sev=e}eq(e){return e.sev==this.sev}toDOM(){return ug('span',{class:'cm-lintPoint cm-lintPoint-'+this.sev})}}class Px{constructor(e,t){this.diagnostic=t,this.id='item_'+Math.floor(4294967295*Math.random()).toString(16),this.dom=Ax(e,t,!0),this.dom.id=this.id,this.dom.setAttribute('role','option')}}class Dx{constructor(e){this.view=e,this.items=[];this.list=ug('ul',{tabIndex:0,role:'listbox','aria-label':this.view.state.phrase('Diagnostics'),onkeydown:t=>{if(27==t.keyCode)Tx(this.view),this.view.focus();else if(38==t.keyCode||33==t.keyCode)this.moveSelection((this.selectedIndex-1+this.items.length)%this.items.length);else if(40==t.keyCode||34==t.keyCode)this.moveSelection((this.selectedIndex+1)%this.items.length);else if(36==t.keyCode)this.moveSelection(0);else if(35==t.keyCode)this.moveSelection(this.items.length-1);else if(13==t.keyCode)this.view.focus();else{if(!(t.keyCode>=65&&t.keyCode<=90&&this.selectedIndex>=0))return;{let{diagnostic:n}=this.items[this.selectedIndex],s=$x(n.actions);for(let i=0;i<s.length;i++)if(s[i].toUpperCase().charCodeAt(0)==t.keyCode){let t=xx(this.view.state.field(wx).diagnostics,n);t&&n.actions[i].apply(e,t.from,t.to)}}}t.preventDefault()},onclick:e=>{for(let t=0;t<this.items.length;t++)this.items[t].dom.contains(e.target)&&this.moveSelection(t)}}),this.dom=ug('div',{class:'cm-panel-lint'},this.list,ug('button',{type:'button',name:'close','aria-label':this.view.state.phrase('close'),onclick:()=>Tx(this.view)},'')),this.update()}get selectedIndex(){let e=this.view.state.field(wx).selected;if(!e)return-1;for(let t=0;t<this.items.length;t++)if(this.items[t].diagnostic==e.diagnostic)return t;return-1}update(){let{diagnostics:e,selected:t}=this.view.state.field(wx),n=0,s=!1,i=null,r=new Set;for(e.between(0,this.view.state.doc.length,((e,o,{spec:a})=>{for(let e of a.diagnostics){if(r.has(e))continue;r.add(e);let o,a=-1;for(let t=n;t<this.items.length;t++)if(this.items[t].diagnostic==e){a=t;break}a<0?(o=new Px(this.view,e),this.items.splice(n,0,o),s=!0):(o=this.items[a],a>n&&(this.items.splice(n,a-n),s=!0)),t&&o.diagnostic==t.diagnostic?o.dom.hasAttribute('aria-selected')||(o.dom.setAttribute('aria-selected','true'),i=o):o.dom.hasAttribute('aria-selected')&&o.dom.removeAttribute('aria-selected'),n++}}));n<this.items.length&&!(1==this.items.length&&this.items[0].diagnostic.from<0);)s=!0,this.items.pop();0==this.items.length&&(this.items.push(new Px(this.view,{from:-1,to:-1,severity:'info',message:this.view.state.phrase('No diagnostics')})),s=!0),i?(this.list.setAttribute('aria-activedescendant',i.id),this.view.requestMeasure({key:this,read:()=>({sel:i.dom.getBoundingClientRect(),panel:this.list.getBoundingClientRect()}),write:({sel:e,panel:t})=>{let n=t.height/this.list.offsetHeight;e.top<t.top?this.list.scrollTop-=(t.top-e.top)/n:e.bottom>t.bottom&&(this.list.scrollTop+=(e.bottom-t.bottom)/n)}})):this.selectedIndex<0&&this.list.removeAttribute('aria-activedescendant'),s&&this.sync()}sync(){let e=this.list.firstChild;function t(){let t=e;e=t.nextSibling,t.remove()}for(let n of this.items)if(n.dom.parentNode==this.list){for(;e!=n.dom;)t();e=n.dom.nextSibling}else this.list.insertBefore(n.dom,e);for(;e;)t()}moveSelection(e){if(this.selectedIndex<0)return;let t=xx(this.view.state.field(wx).diagnostics,this.items[e].diagnostic);t&&this.view.dispatch({selection:{anchor:t.from,head:t.to},scrollIntoView:!0,effects:_x.of(t)})}static open(e){return new Dx(e)}}function Mx(e){return function(e,t='viewBox="0 0 40 40"'){return`url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" ${t}>${encodeURIComponent(e)}</svg>')`}(`<path d="m0 2.5 l2 -1.5 l1 0 l2 1.5 l1 0" stroke="${e}" fill="none" stroke-width=".7"/>`,'width="6" height="3"')}const Lx=fh.baseTheme({'.cm-diagnostic':{padding:'3px 6px 3px 8px',marginLeft:'-1px',display:'block',whiteSpace:'pre-wrap'},'.cm-diagnostic-error':{borderLeft:'5px solid #d11'},'.cm-diagnostic-warning':{borderLeft:'5px solid orange'},'.cm-diagnostic-info':{borderLeft:'5px solid #999'},'.cm-diagnostic-hint':{borderLeft:'5px solid #66d'},'.cm-diagnosticAction':{font:'inherit',border:'none',padding:'2px 4px',backgroundColor:'#444',color:'white',borderRadius:'3px',marginLeft:'8px',cursor:'pointer'},'.cm-diagnosticSource':{fontSize:'70%',opacity:.7},'.cm-lintRange':{backgroundPosition:'left bottom',backgroundRepeat:'repeat-x',paddingBottom:'0.7px'},'.cm-lintRange-error':{backgroundImage:Mx('#d11')},'.cm-lintRange-warning':{backgroundImage:Mx('orange')},'.cm-lintRange-info':{backgroundImage:Mx('#999')},'.cm-lintRange-hint':{backgroundImage:Mx('#66d')},'.cm-lintRange-active':{backgroundColor:'#ffdd9980'},'.cm-tooltip-lint':{padding:0,margin:0},'.cm-lintPoint':{position:'relative','&:after':{content:'""',position:'absolute',bottom:0,left:'-2px',borderLeft:'3px solid transparent',borderRight:'3px solid transparent',borderBottom:'4px solid #d11'}},'.cm-lintPoint-warning':{'&:after':{borderBottomColor:'orange'}},'.cm-lintPoint-info':{'&:after':{borderBottomColor:'#999'}},'.cm-lintPoint-hint':{'&:after':{borderBottomColor:'#66d'}},'.cm-panel.cm-panel-lint':{position:'relative','& ul':{maxHeight:'100px',overflowY:'auto','& [aria-selected]':{backgroundColor:'#ddd','& u':{textDecoration:'underline'}},'&:focus [aria-selected]':{background_fallback:'#bdf',backgroundColor:'Highlight',color_fallback:'white',color:'HighlightText'},'& u':{textDecoration:'none'},padding:0,margin:0},'& [name=close]':{position:'absolute',top:'0',right:'2px',background:'inherit',border:'none',font:'inherit',padding:0,margin:0}}});function Bx(e){return'error'==e?4:'warning'==e?3:'info'==e?2:1}function Nx(e){let t='hint',n=1;for(let s of e){let e=Bx(s.severity);e>n&&(n=e,t=s.severity)}return t}const Rx=[wx,fh.decorations.compute([wx],(e=>{let{selected:t,panel:n}=e.field(wx);return t&&n&&t.from!=t.to?xa.set([kx.range(t.from,t.to)]):xa.none})),wu(Ox,{hideOn:function(e,t){let n=t.pos,s=t.end||n,i=e.state.facet(Cx).hideOn(e,n,s);if(null!=i)return i;let r=e.startState.doc.lineAt(t.pos);return!(!e.effects.some((e=>e.is(bx)))&&!e.changes.touchesRange(r.from,Math.max(r.to,s)))}}),Lx];class Fx{constructor(e,t,n,s,i,r,o,a,l,c=0,h){this.p=e,this.stack=t,this.state=n,this.reducePos=s,this.pos=i,this.score=r,this.buffer=o,this.bufferBase=a,this.curContext=l,this.lookAhead=c,this.parent=h}toString(){return`[${this.stack.filter(((e,t)=>t%3==0)).concat(this.state)}]@${this.pos}${this.score?'!'+this.score:''}`}static start(e,t,n=0){let s=e.parser.context;return new Fx(e,[],t,n,n,0,[],0,s?new Vx(s,s.start):null,0,null)}get context(){return this.curContext?this.curContext.context:null}pushState(e,t){this.stack.push(this.state,t,this.bufferBase+this.buffer.length),this.state=e}reduce(e){var t;let n=e>>19,s=65535&e,{parser:i}=this.p,r=this.reducePos<this.pos-25;r&&this.setLookAhead(this.pos);let o=i.dynamicPrecedence(s);if(o&&(this.score+=o),0==n)return this.pushState(i.getGoto(this.state,s,!0),this.reducePos),s<i.minRepeatTerm&&this.storeNode(s,this.reducePos,this.reducePos,r?8:4,!0),void this.reduceContext(s,this.reducePos);let a=this.stack.length-3*(n-1)-(262144&e?6:0),l=a?this.stack[a-2]:this.p.ranges[0].from,c=this.reducePos-l;c>=2e3&&!(null===(t=this.p.parser.nodeSet.types[s])||void 0===t?void 0:t.isAnonymous)&&(l==this.p.lastBigReductionStart?(this.p.bigReductionCount++,this.p.lastBigReductionSize=c):this.p.lastBigReductionSize<c&&(this.p.bigReductionCount=1,this.p.lastBigReductionStart=l,this.p.lastBigReductionSize=c));let h=a?this.stack[a-1]:0,u=this.bufferBase+this.buffer.length-h;if(s<i.minRepeatTerm||131072&e){let e=i.stateFlag(this.state,1)?this.pos:this.reducePos;this.storeNode(s,l,e,u+4,!0)}if(262144&e)this.state=this.stack[a];else{let e=this.stack[a-3];this.state=i.getGoto(e,s,!0)}for(;this.stack.length>a;)this.stack.pop();this.reduceContext(s,l)}storeNode(e,t,n,s=4,i=!1){if(0==e&&(!this.stack.length||this.stack[this.stack.length-1]<this.buffer.length+this.bufferBase)){let e=this,s=this.buffer.length;if(0==s&&e.parent&&(s=e.bufferBase-e.parent.bufferBase,e=e.parent),s>0&&0==e.buffer[s-4]&&e.buffer[s-1]>-1){if(t==n)return;if(e.buffer[s-2]>=t)return void(e.buffer[s-2]=n)}}if(i&&this.pos!=n){let i=this.buffer.length;if(i>0&&0!=this.buffer[i-4]){let e=!1;for(let t=i;t>0&&this.buffer[t-2]>n;t-=4)if(this.buffer[t-1]>=0){e=!0;break}if(e)for(;i>0&&this.buffer[i-2]>n;)this.buffer[i]=this.buffer[i-4],this.buffer[i+1]=this.buffer[i-3],this.buffer[i+2]=this.buffer[i-2],this.buffer[i+3]=this.buffer[i-1],i-=4,s>4&&(s-=4)}this.buffer[i]=e,this.buffer[i+1]=t,this.buffer[i+2]=n,this.buffer[i+3]=s}else this.buffer.push(e,t,n,s)}shift(e,t,n,s){if(131072&e)this.pushState(65535&e,this.pos);else if(262144&e)this.pos=s,this.shiftContext(t,n),t<=this.p.parser.maxNode&&this.buffer.push(t,n,s,4);else{let i=e,{parser:r}=this.p;(s>this.pos||t<=r.maxNode)&&(this.pos=s,r.stateFlag(i,1)||(this.reducePos=s)),this.pushState(i,n),this.shiftContext(t,n),t<=r.maxNode&&this.buffer.push(t,n,s,4)}}apply(e,t,n,s){65536&e?this.reduce(e):this.shift(e,t,n,s)}useNode(e,t){let n=this.p.reused.length-1;(n<0||this.p.reused[n]!=e)&&(this.p.reused.push(e),n++);let s=this.pos;this.reducePos=this.pos=s+e.length,this.pushState(t,s),this.buffer.push(n,s,this.reducePos,-1),this.curContext&&this.updateContext(this.curContext.tracker.reuse(this.curContext.context,e,this,this.p.stream.reset(this.pos-e.length)))}split(){let e=this,t=e.buffer.length;for(;t>0&&e.buffer[t-2]>e.reducePos;)t-=4;let n=e.buffer.slice(t),s=e.bufferBase+t;for(;e&&s==e.bufferBase;)e=e.parent;return new Fx(this.p,this.stack.slice(),this.state,this.reducePos,this.pos,this.score,n,s,this.curContext,this.lookAhead,e)}recoverByDelete(e,t){let n=e<=this.p.parser.maxNode;n&&this.storeNode(e,this.pos,t,4),this.storeNode(0,this.pos,t,n?8:4),this.pos=this.reducePos=t,this.score-=190}canShift(e){for(let t=new zx(this);;){let n=this.p.parser.stateSlot(t.state,4)||this.p.parser.hasAction(t.state,e);if(0==n)return!1;if(!(65536&n))return!0;t.reduce(n)}}recoverByInsert(e){if(this.stack.length>=300)return[];let t=this.p.parser.nextStates(this.state);if(t.length>8||this.stack.length>=120){let n=[];for(let s,i=0;i<t.length;i+=2)(s=t[i+1])!=this.state&&this.p.parser.hasAction(s,e)&&n.push(t[i],s);if(this.stack.length<120)for(let e=0;n.length<8&&e<t.length;e+=2){let s=t[e+1];n.some(((e,t)=>1&t&&e==s))||n.push(t[e],s)}t=n}let n=[];for(let e=0;e<t.length&&n.length<4;e+=2){let s=t[e+1];if(s==this.state)continue;let i=this.split();i.pushState(s,this.pos),i.storeNode(0,i.pos,i.pos,4,!0),i.shiftContext(t[e],this.pos),i.reducePos=this.pos,i.score-=200,n.push(i)}return n}forceReduce(){let{parser:e}=this.p,t=e.stateSlot(this.state,5);if(!(65536&t))return!1;if(!e.validAction(this.state,t)){let n=t>>19,s=65535&t,i=this.stack.length-3*n;if(i<0||e.getGoto(this.stack[i],s,!1)<0){let e=this.findForcedReduction();if(null==e)return!1;t=e}this.storeNode(0,this.pos,this.pos,4,!0),this.score-=100}return this.reducePos=this.pos,this.reduce(t),!0}findForcedReduction(){let{parser:e}=this.p,t=[],n=(s,i)=>{if(!t.includes(s))return t.push(s),e.allActions(s,(t=>{if(393216&t);else if(65536&t){let n=(t>>19)-i;if(n>1){let s=65535&t,i=this.stack.length-3*n;if(i>=0&&e.getGoto(this.stack[i],s,!1)>=0)return n<<19|65536|s}}else{let e=n(t,i+1);if(null!=e)return e}}))};return n(this.state,0)}forceAll(){for(;!this.p.parser.stateFlag(this.state,2);)if(!this.forceReduce()){this.storeNode(0,this.pos,this.pos,4,!0);break}return this}get deadEnd(){if(3!=this.stack.length)return!1;let{parser:e}=this.p;return 65535==e.data[e.stateSlot(this.state,1)]&&!e.stateSlot(this.state,4)}restart(){this.storeNode(0,this.pos,this.pos,4,!0),this.state=this.stack[0],this.stack.length=0}sameState(e){if(this.state!=e.state||this.stack.length!=e.stack.length)return!1;for(let t=0;t<this.stack.length;t+=3)if(this.stack[t]!=e.stack[t])return!1;return!0}get parser(){return this.p.parser}dialectEnabled(e){return this.p.parser.dialect.flags[e]}shiftContext(e,t){this.curContext&&this.updateContext(this.curContext.tracker.shift(this.curContext.context,e,this,this.p.stream.reset(t)))}reduceContext(e,t){this.curContext&&this.updateContext(this.curContext.tracker.reduce(this.curContext.context,e,this,this.p.stream.reset(t)))}emitContext(){let e=this.buffer.length-1;(e<0||-3!=this.buffer[e])&&this.buffer.push(this.curContext.hash,this.pos,this.pos,-3)}emitLookAhead(){let e=this.buffer.length-1;(e<0||-4!=this.buffer[e])&&this.buffer.push(this.lookAhead,this.pos,this.pos,-4)}updateContext(e){if(e!=this.curContext.context){let t=new Vx(this.curContext.tracker,e);t.hash!=this.curContext.hash&&this.emitContext(),this.curContext=t}}setLookAhead(e){e>this.lookAhead&&(this.emitLookAhead(),this.lookAhead=e)}close(){this.curContext&&this.curContext.tracker.strict&&this.emitContext(),this.lookAhead>0&&this.emitLookAhead()}}class Vx{constructor(e,t){this.tracker=e,this.context=t,this.hash=e.strict?e.hash(t):0}}class zx{constructor(e){this.start=e,this.state=e.state,this.stack=e.stack,this.base=this.stack.length}reduce(e){let t=65535&e,n=e>>19;0==n?(this.stack==this.start.stack&&(this.stack=this.stack.slice()),this.stack.push(this.state,0,0),this.base+=3):this.base-=3*(n-1);let s=this.start.p.parser.getGoto(this.stack[this.base-3],t,!0);this.state=s}}class Ux{constructor(e,t,n){this.stack=e,this.pos=t,this.index=n,this.buffer=e.buffer,0==this.index&&this.maybeNext()}static create(e,t=e.bufferBase+e.buffer.length){return new Ux(e,t,t-e.bufferBase)}maybeNext(){let e=this.stack.parent;null!=e&&(this.index=this.stack.bufferBase-e.bufferBase,this.stack=e,this.buffer=e.buffer)}get id(){return this.buffer[this.index-4]}get start(){return this.buffer[this.index-3]}get end(){return this.buffer[this.index-2]}get size(){return this.buffer[this.index-1]}next(){this.index-=4,this.pos-=4,0==this.index&&this.maybeNext()}fork(){return new Ux(this.stack,this.pos,this.index)}}function Wx(e,t=Uint16Array){if('string'!=typeof e)return e;let n=null;for(let s=0,i=0;s<e.length;){let r=0;for(;;){let t=e.charCodeAt(s++),n=!1;if(126==t){r=65535;break}t>=92&&t--,t>=34&&t--;let i=t-32;if(i>=46&&(i-=46,n=!0),r+=i,n)break;r*=46}n?n[i++]=r:n=new t(r)}return n}class Qx{constructor(){this.start=-1,this.value=-1,this.end=-1,this.extended=-1,this.lookAhead=0,this.mask=0,this.context=0}}const jx=new Qx;class Xx{constructor(e,t){this.input=e,this.ranges=t,this.chunk='',this.chunkOff=0,this.chunk2='',this.chunk2Pos=0,this.next=-1,this.token=jx,this.rangeIndex=0,this.pos=this.chunkPos=t[0].from,this.range=t[0],this.end=t[t.length-1].to,this.readNext()}resolveOffset(e,t){let n=this.range,s=this.rangeIndex,i=this.pos+e;for(;i<n.from;){if(!s)return null;let e=this.ranges[--s];i-=n.from-e.to,n=e}for(;t<0?i>n.to:i>=n.to;){if(s==this.ranges.length-1)return null;let e=this.ranges[++s];i+=e.from-n.to,n=e}return i}clipPos(e){if(e>=this.range.from&&e<this.range.to)return e;for(let t of this.ranges)if(t.to>e)return Math.max(e,t.from);return this.end}peek(e){let t,n,s=this.chunkOff+e;if(s>=0&&s<this.chunk.length)t=this.pos+e,n=this.chunk.charCodeAt(s);else{let s=this.resolveOffset(e,1);if(null==s)return-1;if(t=s,t>=this.chunk2Pos&&t<this.chunk2Pos+this.chunk2.length)n=this.chunk2.charCodeAt(t-this.chunk2Pos);else{let e=this.rangeIndex,s=this.range;for(;s.to<=t;)s=this.ranges[++e];this.chunk2=this.input.chunk(this.chunk2Pos=t),t+this.chunk2.length>s.to&&(this.chunk2=this.chunk2.slice(0,s.to-t)),n=this.chunk2.charCodeAt(0)}}return t>=this.token.lookAhead&&(this.token.lookAhead=t+1),n}acceptToken(e,t=0){let n=t?this.resolveOffset(t,-1):this.pos;if(null==n||n<this.token.start)throw new RangeError('Token end out of bounds');this.token.value=e,this.token.end=n}acceptTokenTo(e,t){this.token.value=e,this.token.end=t}getChunk(){if(this.pos>=this.chunk2Pos&&this.pos<this.chunk2Pos+this.chunk2.length){let{chunk:e,chunkPos:t}=this;this.chunk=this.chunk2,this.chunkPos=this.chunk2Pos,this.chunk2=e,this.chunk2Pos=t,this.chunkOff=this.pos-this.chunkPos}else{this.chunk2=this.chunk,this.chunk2Pos=this.chunkPos;let e=this.input.chunk(this.pos),t=this.pos+e.length;this.chunk=t>this.range.to?e.slice(0,this.range.to-this.pos):e,this.chunkPos=this.pos,this.chunkOff=0}}readNext(){return this.chunkOff>=this.chunk.length&&(this.getChunk(),this.chunkOff==this.chunk.length)?this.next=-1:this.next=this.chunk.charCodeAt(this.chunkOff)}advance(e=1){for(this.chunkOff+=e;this.pos+e>=this.range.to;){if(this.rangeIndex==this.ranges.length-1)return this.setDone();e-=this.range.to-this.pos,this.range=this.ranges[++this.rangeIndex],this.pos=this.range.from}return this.pos+=e,this.pos>=this.token.lookAhead&&(this.token.lookAhead=this.pos+1),this.readNext()}setDone(){return this.pos=this.chunkPos=this.end,this.range=this.ranges[this.rangeIndex=this.ranges.length-1],this.chunk='',this.next=-1}reset(e,t){if(t?(this.token=t,t.start=e,t.lookAhead=e+1,t.value=t.extended=-1):this.token=jx,this.pos!=e){if(this.pos=e,e==this.end)return this.setDone(),this;for(;e<this.range.from;)this.range=this.ranges[--this.rangeIndex];for(;e>=this.range.to;)this.range=this.ranges[++this.rangeIndex];e>=this.chunkPos&&e<this.chunkPos+this.chunk.length?this.chunkOff=e-this.chunkPos:(this.chunk='',this.chunkOff=0),this.readNext()}return this}read(e,t){if(e>=this.chunkPos&&t<=this.chunkPos+this.chunk.length)return this.chunk.slice(e-this.chunkPos,t-this.chunkPos);if(e>=this.chunk2Pos&&t<=this.chunk2Pos+this.chunk2.length)return this.chunk2.slice(e-this.chunk2Pos,t-this.chunk2Pos);if(e>=this.range.from&&t<=this.range.to)return this.input.read(e,t);let n='';for(let s of this.ranges){if(s.from>=t)break;s.to>e&&(n+=this.input.read(Math.max(s.from,e),Math.min(s.to,t)))}return n}}class Gx{constructor(e,t){this.data=e,this.id=t}token(e,t){let{parser:n}=t.p;Hx(this.data,e,t,this.id,n.data,n.tokenPrecTable)}}Gx.prototype.contextual=Gx.prototype.fallback=Gx.prototype.extend=!1;class qx{constructor(e,t,n){this.precTable=t,this.elseToken=n,this.data='string'==typeof e?Wx(e):e}token(e,t){let n=e.pos,s=0;for(;;){let n=e.next<0,i=e.resolveOffset(1,1);if(Hx(this.data,e,t,0,this.data,this.precTable),e.token.value>-1)break;if(null==this.elseToken)return;if(n||s++,null==i)break;e.reset(i,e.token)}s&&(e.reset(n,e.token),e.acceptToken(this.elseToken,s))}}function Hx(e,t,n,s,i,r){let o=0,a=1<<s,{dialect:l}=n.p.parser;e:for(;a&e[o];){let n=e[o+1];for(let s=o+3;s<n;s+=2)if((e[s+1]&a)>0){let n=e[s];if(l.allows(n)&&(-1==t.token.value||t.token.value==n||Kx(n,t.token.value,i,r))){t.acceptToken(n);break}}let s=t.next,c=0,h=e[o+2];if(!(t.next<0&&h>c&&65535==e[n+3*h-3])){for(;c<h;){let i=c+h>>1,r=n+i+(i<<1),a=e[r],l=e[r+1]||65536;if(s<a)h=i;else{if(!(s>=l)){o=e[r+2],t.advance();continue e}c=i+1}}break}o=e[n+3*h-1]}}function Yx(e,t,n){for(let s,i=t;65535!=(s=e[i]);i++)if(s==n)return i-t;return-1}function Kx(e,t,n,s){let i=Yx(n,s,t);return i<0||Yx(n,s,e)<i}qx.prototype.contextual=Gx.prototype.fallback=Gx.prototype.extend=!1;const Zx='undefined'!=typeof process&&process.env&&/\bparse\b/.test(process.env.LOG);let Jx=null;function eb(e,t,n){let s=e.cursor(ud.IncludeAnonymous);for(s.moveTo(t);;)if(!(n<0?s.childBefore(t):s.childAfter(t)))for(;;){if((n<0?s.to<t:s.from>t)&&!s.type.isError)return n<0?Math.max(0,Math.min(s.to-1,t-25)):Math.min(e.length,Math.max(s.from+1,t+25));if(n<0?s.prevSibling():s.nextSibling())break;if(!s.parent())return n<0?0:e.length}}class tb{constructor(e,t){this.fragments=e,this.nodeSet=t,this.i=0,this.fragment=null,this.safeFrom=-1,this.safeTo=-1,this.trees=[],this.start=[],this.index=[],this.nextFragment()}nextFragment(){let e=this.fragment=this.i==this.fragments.length?null:this.fragments[this.i++];if(e){for(this.safeFrom=e.openStart?eb(e.tree,e.from+e.offset,1)-e.offset:e.from,this.safeTo=e.openEnd?eb(e.tree,e.to+e.offset,-1)-e.offset:e.to;this.trees.length;)this.trees.pop(),this.start.pop(),this.index.pop();this.trees.push(e.tree),this.start.push(-e.offset),this.index.push(0),this.nextStart=this.safeFrom}else this.nextStart=1e9}nodeAt(e){if(e<this.nextStart)return null;for(;this.fragment&&this.safeTo<=e;)this.nextFragment();if(!this.fragment)return null;for(;;){let t=this.trees.length-1;if(t<0)return this.nextFragment(),null;let n=this.trees[t],s=this.index[t];if(s==n.children.length){this.trees.pop(),this.start.pop(),this.index.pop();continue}let i=n.children[s],r=this.start[t]+n.positions[s];if(r>e)return this.nextStart=r,null;if(i instanceof dd){if(r==e){if(r<this.safeFrom)return null;let e=r+i.length;if(e<=this.safeTo){let t=i.prop(id.lookAhead);if(!t||e+t<this.fragment.to)return i}}this.index[t]++,r+i.length>=Math.max(this.safeFrom,e)&&(this.trees.push(i),this.start.push(r),this.index.push(0))}else this.index[t]++,this.nextStart=r+i.length}}}class nb{constructor(e,t){this.stream=t,this.tokens=[],this.mainToken=null,this.actions=[],this.tokens=e.tokenizers.map((e=>new Qx))}getActions(e){let t=0,n=null,{parser:s}=e.p,{tokenizers:i}=s,r=s.stateSlot(e.state,3),o=e.curContext?e.curContext.hash:0,a=0;for(let s=0;s<i.length;s++){if(!(1<<s&r))continue;let l=i[s],c=this.tokens[s];if((!n||l.fallback)&&((l.contextual||c.start!=e.pos||c.mask!=r||c.context!=o)&&(this.updateCachedToken(c,l,e),c.mask=r,c.context=o),c.lookAhead>c.end+25&&(a=Math.max(c.lookAhead,a)),0!=c.value)){let s=t;if(c.extended>-1&&(t=this.addActions(e,c.extended,c.end,t)),t=this.addActions(e,c.value,c.end,t),!l.extend&&(n=c,t>s))break}}for(;this.actions.length>t;)this.actions.pop();return a&&e.setLookAhead(a),n||e.pos!=this.stream.end||(n=new Qx,n.value=e.p.parser.eofTerm,n.start=n.end=e.pos,t=this.addActions(e,n.value,n.end,t)),this.mainToken=n,this.actions}getMainToken(e){if(this.mainToken)return this.mainToken;let t=new Qx,{pos:n,p:s}=e;return t.start=n,t.end=Math.min(n+1,s.stream.end),t.value=n==s.stream.end?s.parser.eofTerm:0,t}updateCachedToken(e,t,n){let s=this.stream.clipPos(n.pos);if(t.token(this.stream.reset(s,e),n),e.value>-1){let{parser:t}=n.p;for(let s=0;s<t.specialized.length;s++)if(t.specialized[s]==e.value){let i=t.specializers[s](this.stream.read(e.start,e.end),n);if(i>=0&&n.p.parser.dialect.allows(i>>1)){1&i?e.extended=i>>1:e.value=i>>1;break}}}else e.value=0,e.end=this.stream.clipPos(s+1)}putAction(e,t,n,s){for(let t=0;t<s;t+=3)if(this.actions[t]==e)return s;return this.actions[s++]=e,this.actions[s++]=t,this.actions[s++]=n,s}addActions(e,t,n,s){let{state:i}=e,{parser:r}=e.p,{data:o}=r;for(let e=0;e<2;e++)for(let a=r.stateSlot(i,e?2:1);;a+=3){if(65535==o[a]){if(1!=o[a+1]){0==s&&2==o[a+1]&&(s=this.putAction(ab(o,a+2),t,n,s));break}a=ab(o,a+2)}o[a]==t&&(s=this.putAction(ab(o,a+1),t,n,s))}return s}}class sb{constructor(e,t,n,s){this.parser=e,this.input=t,this.ranges=s,this.recovering=0,this.nextStackID=9812,this.minStackPos=0,this.reused=[],this.stoppedAt=null,this.lastBigReductionStart=-1,this.lastBigReductionSize=0,this.bigReductionCount=0,this.stream=new Xx(t,s),this.tokens=new nb(e,this.stream),this.topTerm=e.top[1];let{from:i}=s[0];this.stacks=[Fx.start(this,e.top[0],i)],this.fragments=n.length&&this.stream.end-i>4*e.bufferLength?new tb(n,e.nodeSet):null}get parsedPos(){return this.minStackPos}advance(){let e,t,n=this.stacks,s=this.minStackPos,i=this.stacks=[];if(this.bigReductionCount>300&&1==n.length){let[e]=n;for(;e.forceReduce()&&e.stack.length&&e.stack[e.stack.length-2]>=this.lastBigReductionStart;);this.bigReductionCount=this.lastBigReductionSize=0}for(let r=0;r<n.length;r++){let o=n[r];for(;;){if(this.tokens.mainToken=null,o.pos>s)i.push(o);else{if(this.advanceStack(o,i,n))continue;{e||(e=[],t=[]),e.push(o);let n=this.tokens.getMainToken(o);t.push(n.value,n.end)}}break}}if(!i.length){let t=e&&function(e){let t=null;for(let n of e){let e=n.p.stoppedAt;(n.pos==n.p.stream.end||null!=e&&n.pos>e)&&n.p.parser.stateFlag(n.state,2)&&(!t||t.score<n.score)&&(t=n)}return t}(e);if(t)return Zx&&console.log('Finish with '+this.stackID(t)),this.stackToTree(t);if(this.parser.strict)throw Zx&&e&&console.log('Stuck with token '+(this.tokens.mainToken?this.parser.getName(this.tokens.mainToken.value):'none')),new SyntaxError('No parse at '+s);this.recovering||(this.recovering=5)}if(this.recovering&&e){let n=null!=this.stoppedAt&&e[0].pos>this.stoppedAt?e[0]:this.runRecovery(e,t,i);if(n)return Zx&&console.log('Force-finish '+this.stackID(n)),this.stackToTree(n.forceAll())}if(this.recovering){let e=1==this.recovering?1:3*this.recovering;if(i.length>e)for(i.sort(((e,t)=>t.score-e.score));i.length>e;)i.pop();i.some((e=>e.reducePos>s))&&this.recovering--}else if(i.length>1){e:for(let e=0;e<i.length-1;e++){let t=i[e];for(let n=e+1;n<i.length;n++){let s=i[n];if(t.sameState(s)||t.buffer.length>500&&s.buffer.length>500){if(!((t.score-s.score||t.buffer.length-s.buffer.length)>0)){i.splice(e--,1);continue e}i.splice(n--,1)}}}i.length>12&&i.splice(12,i.length-12)}this.minStackPos=i[0].pos;for(let e=1;e<i.length;e++)i[e].pos<this.minStackPos&&(this.minStackPos=i[e].pos);return null}stopAt(e){if(null!=this.stoppedAt&&this.stoppedAt<e)throw new RangeError('Can\'t move stoppedAt forward');this.stoppedAt=e}advanceStack(e,t,n){let s=e.pos,{parser:i}=this,r=Zx?this.stackID(e)+' -> ':'';if(null!=this.stoppedAt&&s>this.stoppedAt)return e.forceReduce()?e:null;if(this.fragments){let t=e.curContext&&e.curContext.tracker.strict,n=t?e.curContext.hash:0;for(let o=this.fragments.nodeAt(s);o;){let s=this.parser.nodeSet.types[o.type.id]==o.type?i.getGoto(e.state,o.type.id):-1;if(s>-1&&o.length&&(!t||(o.prop(id.contextHash)||0)==n))return e.useNode(o,s),Zx&&console.log(r+this.stackID(e)+` (via reuse of ${i.getName(o.type.id)})`),!0;if(!(o instanceof dd)||0==o.children.length||o.positions[0]>0)break;let a=o.children[0];if(!(a instanceof dd&&0==o.positions[0]))break;o=a}}let o=i.stateSlot(e.state,4);if(o>0)return e.reduce(o),Zx&&console.log(r+this.stackID(e)+` (via always-reduce ${i.getName(65535&o)})`),!0;if(e.stack.length>=8400)for(;e.stack.length>6e3&&e.forceReduce(););let a=this.tokens.getActions(e);for(let o=0;o<a.length;){let l=a[o++],c=a[o++],h=a[o++],u=o==a.length||!n,d=u?e:e.split(),f=this.tokens.mainToken;if(d.apply(l,c,f?f.start:d.pos,h),Zx&&console.log(r+this.stackID(d)+` (via ${65536&l?`reduce of ${i.getName(65535&l)}`:'shift'} for ${i.getName(c)} @ ${s}${d==e?'':', split'})`),u)return!0;d.pos>s?t.push(d):n.push(d)}return!1}advanceFully(e,t){let n=e.pos;for(;;){if(!this.advanceStack(e,null,null))return!1;if(e.pos>n)return ib(e,t),!0}}runRecovery(e,t,n){let s=null,i=!1;for(let r=0;r<e.length;r++){let o=e[r],a=t[r<<1],l=t[1+(r<<1)],c=Zx?this.stackID(o)+' -> ':'';if(o.deadEnd){if(i)continue;if(i=!0,o.restart(),Zx&&console.log(c+this.stackID(o)+' (restarted)'),this.advanceFully(o,n))continue}let h=o.split(),u=c;for(let e=0;h.forceReduce()&&e<10;e++){if(Zx&&console.log(u+this.stackID(h)+' (via force-reduce)'),this.advanceFully(h,n))break;Zx&&(u=this.stackID(h)+' -> ')}for(let e of o.recoverByInsert(a))Zx&&console.log(c+this.stackID(e)+' (via recover-insert)'),this.advanceFully(e,n);this.stream.end>o.pos?(l==o.pos&&(l++,a=0),o.recoverByDelete(a,l),Zx&&console.log(c+this.stackID(o)+` (via recover-delete ${this.parser.getName(a)})`),ib(o,n)):(!s||s.score<o.score)&&(s=o)}return s}stackToTree(e){return e.close(),dd.build({buffer:Ux.create(e),nodeSet:this.parser.nodeSet,topID:this.topTerm,maxBufferLength:this.parser.bufferLength,reused:this.reused,start:this.ranges[0].from,length:e.pos-this.ranges[0].from,minRepeatType:this.parser.minRepeatTerm})}stackID(e){let t=(Jx||(Jx=new WeakMap)).get(e);return t||Jx.set(e,t=String.fromCodePoint(this.nextStackID++)),t+e}}function ib(e,t){for(let n=0;n<t.length;n++){let s=t[n];if(s.pos==e.pos&&s.sameState(e))return void(t[n].score<e.score&&(t[n]=e))}t.push(e)}class rb{constructor(e,t,n){this.source=e,this.flags=t,this.disabled=n}allows(e){return!this.disabled||0==this.disabled[e]}}class ob extends Ed{constructor(e){if(super(),this.wrappers=[],14!=e.version)throw new RangeError(`Parser version (${e.version}) doesn't match runtime version (14)`);let t=e.nodeNames.split(' ');this.minRepeatTerm=t.length;for(let n=0;n<e.repeatNodeCount;n++)t.push('');let n=Object.keys(e.topRules).map((t=>e.topRules[t][1])),s=[];for(let e=0;e<t.length;e++)s.push([]);function i(e,t,n){s[e].push([t,t.deserialize(String(n))])}if(e.nodeProps)for(let t of e.nodeProps){let e=t[0];'string'==typeof e&&(e=id[e]);for(let n=1;n<t.length;){let s=t[n++];if(s>=0)i(s,e,t[n++]);else{let r=t[n+-s];for(let o=-s;o>0;o--)i(t[n++],e,r);n++}}}this.nodeSet=new ld(t.map(((t,i)=>ad.define({name:i>=this.minRepeatTerm?void 0:t,id:i,props:s[i],top:n.indexOf(i)>-1,error:0==i,skipped:e.skippedNodes&&e.skippedNodes.indexOf(i)>-1})))),e.propSources&&(this.nodeSet=this.nodeSet.extend(...e.propSources)),this.strict=!1,this.bufferLength=td;let r=Wx(e.tokenData);this.context=e.context,this.specializerSpecs=e.specialized||[],this.specialized=new Uint16Array(this.specializerSpecs.length);for(let e=0;e<this.specializerSpecs.length;e++)this.specialized[e]=this.specializerSpecs[e].term;this.specializers=this.specializerSpecs.map(lb),this.states=Wx(e.states,Uint32Array),this.data=Wx(e.stateData),this.goto=Wx(e.goto),this.maxTerm=e.maxTerm,this.tokenizers=e.tokenizers.map((e=>'number'==typeof e?new Gx(r,e):e)),this.topRules=e.topRules,this.dialects=e.dialects||{},this.dynamicPrecedences=e.dynamicPrecedences||null,this.tokenPrecTable=e.tokenPrec,this.termNames=e.termNames||null,this.maxNode=this.nodeSet.types.length-1,this.dialect=this.parseDialect(),this.top=this.topRules[Object.keys(this.topRules)[0]]}createParse(e,t,n){let s=new sb(this,e,t,n);for(let i of this.wrappers)s=i(s,e,t,n);return s}getGoto(e,t,n=!1){let s=this.goto;if(t>=s[0])return-1;for(let i=s[t+1];;){let t=s[i++],r=1&t,o=s[i++];if(r&&n)return o;for(let n=i+(t>>1);i<n;i++)if(s[i]==e)return o;if(r)return-1}}hasAction(e,t){let n=this.data;for(let s=0;s<2;s++)for(let i,r=this.stateSlot(e,s?2:1);;r+=3){if(65535==(i=n[r])){if(1!=n[r+1]){if(2==n[r+1])return ab(n,r+2);break}i=n[r=ab(n,r+2)]}if(i==t||0==i)return ab(n,r+1)}return 0}stateSlot(e,t){return this.states[6*e+t]}stateFlag(e,t){return(this.stateSlot(e,0)&t)>0}validAction(e,t){return!!this.allActions(e,(e=>e==t||null))}allActions(e,t){let n=this.stateSlot(e,4),s=n?t(n):void 0;for(let n=this.stateSlot(e,1);null==s;n+=3){if(65535==this.data[n]){if(1!=this.data[n+1])break;n=ab(this.data,n+2)}s=t(ab(this.data,n+1))}return s}nextStates(e){let t=[];for(let n=this.stateSlot(e,1);;n+=3){if(65535==this.data[n]){if(1!=this.data[n+1])break;n=ab(this.data,n+2)}if(!(1&this.data[n+2])){let e=this.data[n+1];t.some(((t,n)=>1&n&&t==e))||t.push(this.data[n],e)}}return t}configure(e){let t=Object.assign(Object.create(ob.prototype),this);if(e.props&&(t.nodeSet=this.nodeSet.extend(...e.props)),e.top){let n=this.topRules[e.top];if(!n)throw new RangeError(`Invalid top rule name ${e.top}`);t.top=n}return e.tokenizers&&(t.tokenizers=this.tokenizers.map((t=>{let n=e.tokenizers.find((e=>e.from==t));return n?n.to:t}))),e.specializers&&(t.specializers=this.specializers.slice(),t.specializerSpecs=this.specializerSpecs.map(((n,s)=>{let i=e.specializers.find((e=>e.from==n.external));if(!i)return n;let r=Object.assign(Object.assign({},n),{external:i.to});return t.specializers[s]=lb(r),r}))),e.contextTracker&&(t.context=e.contextTracker),e.dialect&&(t.dialect=this.parseDialect(e.dialect)),null!=e.strict&&(t.strict=e.strict),e.wrap&&(t.wrappers=t.wrappers.concat(e.wrap)),null!=e.bufferLength&&(t.bufferLength=e.bufferLength),t}hasWrappers(){return this.wrappers.length>0}getName(e){return this.termNames?this.termNames[e]:String(e<=this.maxNode&&this.nodeSet.types[e].name||e)}get eofTerm(){return this.maxNode+1}get topNode(){return this.nodeSet.types[this.top[1]]}dynamicPrecedence(e){let t=this.dynamicPrecedences;return null==t?0:t[e]||0}parseDialect(e){let t=Object.keys(this.dialects),n=t.map((()=>!1));if(e)for(let s of e.split(' ')){let e=t.indexOf(s);e>=0&&(n[e]=!0)}let s=null;for(let e=0;e<t.length;e++)if(!n[e])for(let n,i=this.dialects[t[e]];65535!=(n=this.data[i++]);)(s||(s=new Uint8Array(this.maxTerm+1)))[n]=1;return new rb(e,n,s)}static deserialize(e){return new ob(e)}}function ab(e,t){return e[t]|e[t+1]<<16}function lb(e){if(e.external){let t=e.extend?1:0;return(n,s)=>e.external(n,s)<<1|t}return e.get}const cb={__proto__:null,enable:12,var:30,function:34,private:36,workgroup:38,uniform:40,storage:42,read:44,write:46,read_write:48,bool:54,f32:56,i32:58,u32:60,vec2i:62,vec3i:64,vec4i:66,vec2u:68,vec3u:70,vec4u:72,vec2f:74,vec3f:76,vec4f:78,vec2h:80,vec3h:82,vec4h:84,vec2:86,vec3:88,vec4:90,ptr:92,array:94,mat2x2:96,mat2x3:98,mat2x4:100,mat3x2:102,mat3x3:104,mat3x4:106,mat4x2:108,mat4x3:110,mat4x4:112,atomic:114,sampler:116,sampler_comparison:118,texture_depth_2d:120,texture_depth_2d_array:122,texture_depth_cube:124,texture_depth_cube_array:126,texture_depth_multisampled_2d:128,texture_1d:130,texture_2d:132,texture_2d_array:134,texture_3d:136,texture_cube:138,texture_cube_array:140,texture_multisampled_2d:142,texture_storage_1d:144,texture_storage_2d:146,texture_storage_2d_array:148,texture_storage_3d:150,rgba8unorm:152,rgba8snorm:154,rgba8uint:156,rgba8sint:158,rgba16uint:160,rgba16sint:162,rgba16float:164,r32uint:166,r32sint:168,r32float:170,rg32uint:172,rg32sint:174,rg32float:176,rgba32uint:178,rgba32sint:180,rgba32float:182,true:188,false:190,const:194,override:196,asm:202,bf16:204,do:206,enum:208,f16:210,f64:212,handle:214,i8:216,i16:218,i64:220,mat:222,premerge:224,regardless:226,typedef:228,u8:230,u16:232,u64:234,unless:236,using:238,vec:240,void:242,while:244,bitcast:248,type:296,struct:300,fn:310,return:322,if:324,else:326,switch:328,case:330,fallthrough:332,default:334,loop:336,continuing:340,for:342,let:344,break:370,continue:372,discard:374,import:378,use:386},hb=ob.deserialize({version:14,states:'!$WO!QQPOOP!XOPOOO!^QPO\'#G{O!eQPO\'#CfOOQO\'#Gi\'#GiO!jQPO\'#CeO&_QPO\'#CdO&sQPO\'#CcOOQO\'#Cc\'#CcOOQO\'#G}\'#G}OOQO\'#Gh\'#GhO&xQPO\'#G{QOQPOOO\'PQPO\'#C`OOQO\'#Gg\'#GgO\'UQPO\'#G`O\'^QPO\'#G`P\'cO`O\'#C^POOO)CBk)CBkOOQO-E:e-E:eO\'nQPO,5=gO\'uQPO,59QOOQO-E:g-E:gO+mQPO,59OO+uQPO,5<VO,mQPO\'#CjO,uQPO,5:zO,uQPO,5:zO,zQPO,5<PO-PQPO,5<RO-UQPO\'#FlOOQO,58},58}OOQO-E:f-E:fO-ZQPO,58zO-`QPO\'#GbOOQO,5<z,5<zO-eQQO,5<zO-jQPO,5<zPOOO\'#Gf\'#GfP.bO`O,58xPOOO,58x,58xO.mQPO1G.lO.{QPO1G.jO3nQPO\'#FqOOQO1G1q1G1qO3uQPO\'#HTOOQO\'#Cl\'#ClO4WQQO\'#CuOOQO\'#Cu\'#CuOOQO,59U,59UO,uQPO,59UO4cQPO1G0fO4hQPO1G0fO4pQPO1G1kO4xQPO1G1mO4}QPO,5<WOOQO1G.f1G.fO5SQQO\'#GcO5_QPO,5<|O-`QPO,5<|O5gQPO1G2fO\'XQPO1G2fPOOO-E:d-E:dPOOO1G.d1G.dOOQO\'#HQ\'#HQO5lQPO7+$WO.mQPO7+$WOOQO\'#H`\'#H`O5tQPO\'#H`O5yQPO\'#H`OOQO\'#Cv\'#CvOOQO\'#Hh\'#HhO6OQPO\'#HgOOQO\'#Hg\'#HgOOQO\'#E]\'#E]OOQO7+$U7+$UO6TQPO\'#H^OOQO\'#Ha\'#HaOOQO\'#Hb\'#HbOOQO\'#Hc\'#HcOOQO\'#Hd\'#HdO6YQPO\'#CvO7gQPO\'#CvO5tQPO\'#CvO7lQPO\'#IYOOQO\'#Gr\'#GrO7tQPO\'#I[O8SQQO\'#I]O7tQPO\'#I]O9WQQO\'#I[O;PQQO\'#IZOOQO\'#Fr\'#FrO;ZQPO\'#FrOOQO\'#Go\'#GoO;`QPO,5<]OOQO,5<],5<]OAPQPO\'#H}O;gQPO\'#IOO;gQPO\'#IQOAWQPO\'#IUO,uQPO\'#IYOA]QPO\'#IVOOQO\'#I`\'#I`OAbQPO,5=oOOQO\'#HV\'#HVOAjQPO,5=tOOQO1G.p1G.pO.{QPO7+&QO;gQPO7+&QOAjQPO7+\'VODxQPO\'#FiOOQO7+\'X7+\'XOETQPO1G1rOE`QPO,5<}OEeQPO1G2hOOQO1G2h1G2hOEmQPO1G2hOOQO-E:q-E:qOOQO7+(Q7+(QOOQO,5=U,5=UOOQO<<Gr<<GrOEuQPO<<GrOOQO-E:h-E:hOAjQPO\'#H[OOQO,5=z,5=zOE}QPO\'#HeOGRQPO,5>ROAjQPO,5=xOOQO,59b,59bO3uQPO\'#H]O;gQPO,5>tOOQO-E:p-E:pOOQO\'#I]\'#I]OGYQQO,5>vOH^QPO\'#HqOHeQPO,5<^OHjQPO,5>wO;gQPO\'#HsOHoQPO\'#HsOOQO,5>v,5>vOOQO\'#I^\'#I^O;gQPO,5>uOOQO,5<^,5<^OOQO-E:m-E:mOOQO1G1w1G1wOIiQSO\'#CvO;gQPO\'#HrOOQO\'#Hp\'#HpOJoQPO\'#HpOK]QSO\'#HoOOQO\'#Hn\'#HnO;gQPO\'#HnOMyQSO\'#HmO! OQSO\'#HlO! }QSO\'#HkO!!kQSO\'#HjO!#fQPO\'#HuO!#}QPO\'#HiO!$SQPO\'#HiO!$XQPO\'#HiO!$^QPO\'#HiO!$cQPO\'#HiOOQO\'#Ed\'#EdO5tQPO\'#HpOOQO,5>i,5>iO3iQPO,5>jO!$hQPO,5>lO!$mQPO,5>pO!$wQPO,5>tO!%_QPO,5>qOOQO1G3Z1G3ZO!%iQPO1G3ZOOQO1G3`1G3`OOQO<<Il<<IlOOQO\'#Ec\'#EcOOQO<<Jq<<JqO!%tQPO\'#FjO!%yQPO,5<TO!&RQPO,5<TOOQO,5<T,5<TO!%tQPO\'#FoO!&ZQPO\'#FnO!&RQPO\'#FnO!&cQPO7+\'^OOQO1G2i1G2iOOQO7+(S7+(SO!&hQPO7+(SP!&pQPO\'#GsOOQOAN=^AN=^P!&uQPO\'#GjO!&zQPO,5=vO!\'PQPO,5>POOQO\'#Hf\'#HfO!\'UQPO1G3mO.{QPO1G3mOOQO1G3m1G3mO!\'^QPO1G3dO!\'fQPO,5=wOOQO1G4`1G4`OOQO1G4b1G4bO!\'kQPO,5>]O;gQPO,5>]OOQO,5>],5>]OOQO1G1x1G1xOOQO1G4c1G4cO!\'sQPO,5>_O!(aQQO,5>_OOQO1G4a1G4aO!)dQPO,5>^OOQO,5>[,5>[OOQO,5>Z,5>ZOOQO,5>Y,5>YO;gQPO,5>VO;gQPO,5>XO;gQPO,5>WO;gQPO,5>UO;gQPO,5>aO;gQPO,5>bO;gQPO,5>cO;gQPO,5>dO;gQPO,5>eO@zQPO,5>[O!)iQPO1G4UO!*yQPO1G4WO!+RQPO1G4[O3iQPO\'#F{OOQO1G4[1G4[O!+]QPO1G4[O;gQPO1G4`O!+bQQO\'#I]O:[QQO\'#IZOOQO\'#IX\'#IXO!,`QPO\'#IWO!,gQPO\'#IWO!,lQPO1G4]O!,qQPO7+(uOOQO\'#HW\'#HWO!,vQQO\'#HYOOQO,5<U,5<UO!,{QPO1G1oOOQO1G1o1G1oO!-WQPO1G1oOOQO-E:k-E:kOOQO,5<Z,5<ZO!-`QPO,5=YO!-kQPO,5<YOOQO-E:l-E:lO!-sQWO<<JxOOQO<<Kn<<KnPOQO,5=_,5=_OOQO1G3b1G3bO!%iQPO1G3kO!2]QPO7+)XOOQO7+)X7+)XO!2dQPO7+)XOOQO-E:i-E:iOOQO7+)O7+)OO!2lQPO7+)OOAjQPO1G3cO!8aQPO1G3wOOQO1G3w1G3wO!8hQPO1G3wOOQO-E:j-E:jO!9XQQO1G3yOOQO1G3y1G3yOOQO1G3x1G3xO!:[QSO,5>_OOQO1G3q1G3qOOQO1G3s1G3sOOQO\'#Hm\'#HmO!<`QSO1G3rO!=nQSO\'#HmONWQPO\'#HlO!=xQPO\'#HkOOQO1G3p1G3pO!>eQPO1G3{O!>lQPO1G3|O!>sQPO1G3}O!>zQPO1G4OO!?RQPO1G4POOQO1G3v1G3vO!?YQPO7+)pOOQO\'#Gp\'#GpO!?bQPO7+)rO!?mQPO\'#IRO!@OQQO\'#IROOQO7+)v7+)vO!@TQPO7+)vOOQO,5<g,5<gOOQO7+)z7+)zOOQO,5>s,5>sO!@YQPO,5>rO!@kQPO,5>rO!@pQPO,5>rO3iQPO7+)wOOQO<<La<<LaOOQO7+\'Z7+\'ZO!@wQPO7+\'ZP!ASQPO\'#GmO!AXQPO1G1tP!AdQPO\'#GnO!AiQPO\'#FpOOQOAN@dAN@dO!DzQPO7+)VOOQO<<Ls<<LsO!EPQPO<<LsP!EWQPO\'#GkOOQO\'#H_\'#H_O!E]QPO<<LjO!EbQPO7+(}OOQO7+)c7+)cO!EjQPO7+)cP!EqQPO\'#GlOOQO7+)e7+)eO!EvQSO1G3yOOQO\'#IP\'#IPOOQO<<M[<<M[OOQO-E:n-E:nOOQO<<M^<<M^O!GSQQO\'#ISO!?mQPO\'#ISO!G[QQO,5>mO!GaQPO,5>mOOQO<<Mb<<MbO8SQQO\'#I]O!GfQQO\'#I_OOQO\'#I_\'#I_OOQO1G4^1G4^O!GpQPO1G4^O!HRQPO1G4^OOQO<<Mc<<McOOQO<<Ju<<JuPOQO,5=X,5=XPOQO,5=Y,5=YOAjQPO,5<[OOQO<<Lq<<LqOOQOANB_ANB_POQO,5=V,5=VOOQOANBUANBUOOQO<<Li<<LiO!%iQPO<<LiOOQO<<L}<<L}POQO,5=W,5=WOHtQQO\'#CvO!HWQQO\'#HoO!;hQPO1G3rO!HsQWO,5=]O!HzQQO,5>nOOQO-E:o-E:oO!ISQPO1G4XO!IXQPO1G4XOOQO,5>y,5>yOOQO7+)x7+)xO!IcQPO7+)xOOQO1G1v1G1vO!ItQPOANBTO!IyQWO1G4YP!JQQPO\'#GqO!JVQPO7+)sO!JaQPO\'#ITO!JkQPO\'#ITOOQO7+)s7+)sO!JpQPO7+)sOOQO<<Md<<MdOOQOG27oG27oPOQO,5=],5=]OOQO<<M_<<M_O!JuQPO<<M_OOQO,5>o,5>oOOQOANByANByO!JzQPO\'#HsO!KPQPO\'#HnO#![QPO,5>_O!KPQPO,5>VO;gQPO,5>WOLiQSO\'#HmO;gQPO\'#Hs',stateData:'#!j~O%jOSPOS%kPQ~OU]O%T_O%X`O%pXO%rRO_XP#TXP#UXP$YXP$[XP$aXP~O%h%oP~P]O%kaO~O%h%oX~P]OTeO~O%rRO_XX#TXX#UXX$YXX$[XX$aXXTXXkXXlXXmXXnXXoXXpXXqXXrXXsXXtXXuXXvXXwXXxXXyXXzXX{XX|XX}XX!OXX!PXX!QXX!RXX!SXX!TXX!UXX!VXX!WXX!XXX!YXX!ZXX![XX!]XX!^XX!_XX!`XX!aXX!bXX!cXX!dXX!eXX!fXX!gXX!hXX!iXX!jXX!kXX!lXX!mXX~O_iO#TjO#UkO$YlO$[mO$anO~O%poO~O%h%oX~P`OTqO~O%WsO&nrO~O%WuO~O%lvO%mvO%nxO~O%h%oa~P`O%syO_Ya#TYa#UYa$YYa$[Ya$aYa%rYaTYakYalYamYanYaoYapYaqYarYasYatYauYavYawYaxYayYazYa{Ya|Ya}Ya!OYa!PYa!QYa!RYa!SYa!TYa!UYa!VYa!WYa!XYa!YYa!ZYa![Ya!]Ya!^Ya!_Ya!`Ya!aYa!bYa!cYa!dYa!eYa!fYa!gYa!hYa!iYa!jYa!kYa!lYa!mYa~O#OzO%pWa~O&n{O_$_a#T$_a#U$_a$Y$_a$[$_a$a$_a%T$_a%X$_a%h$_a%p$_a%r$_a~OT!PO%x}O~OT!PO~OT!VO~OT!WO~OT!XO~O%p!YO~OT!ZO~O\'U!^O~O\'V!_O_%Sa#T%Sa#U%Sa$Y%Sa$[%Sa$a%Sa%T%Sa%X%Sa%h%Sa%p%Sa%r%Sa~O%lvO%mvO%n!aO~OT!bOZ!bO[!bO]!bO~OT!hOZ!iO[!iO]!iOk!hOl!hOm!hOn!hOo!hOp!hOq!hOr!hOs!hOt!hOu!hOv!hOw!hOx!hOy!hOz!hO{!sO|!sO}!sO!O!tO!P!nO!Q!sO!R!sO!S!sO!T!sO!U!sO!V!sO!W!sO!X!sO!Y!sO!Z!uO![!oO!]!oO!^!pO!_!pO!`!pO!a!pO!b!pO!c!qO!d!qO!e!qO!f!qO!g!qO!h!qO!i!fO!j!rO!k!rO!l!rO!m!rO#Q!iO#R!iO~OT!yO_iO#v!wO#w!wO$g#SO$h#TO$j#UO$n#VO$q#XO$r#WO%P#YO%Q#YO%R#YO%p!}O%s!zO&n{O~O&o#RO~P2jOa#[Ob#[Oc#[Od#[Oe#[O~O%}#]O#OiX%piX~O#O#_O~O#O#`O%p#Si~O#O#aO%p$Xi~O&n#bO~O%s#dO~O\'T#eO%u%VX&o%VX~O%u#fO&o#gO~O%W#jO~O%u#kO%v#lO~O%x#oO~O%x#qO~O%s#rO~O%x#sO~O%x#oO%sjX#OjX%pjX%{jX%ujX&ojX%vjX_jX#TjX#UjX$YjX$[jX$ajX%TjX%XjX%hjX%rjX&njX~O%x#uO~O#O#vO%p&|X~OT#xO#v!wO#w!wO%s!zO~O%s#zO#O\'PX#q\'PX$s\'PX$t\'PX$u\'PX$v\'PX$w\'PX$x\'PX$y\'PX$z\'PX${\'PX$|\'PX$}\'PX%O\'PX&h\'PX~O#q#}O&h$OO#O\'OX$s\'OX$t\'OX$u\'OX$v\'OX$w\'OX$x\'OX$y\'OX$z\'OX${\'OX$|\'OX$}\'OX%O\'OX%v\'OX~O#O$RO$s$QO$t$QO$u$QO$v$QO$w$QO$x$QO$y$QO$z$QO${$QO$|$QO~O$}#{O%O#{O~P:[O%p$SO~O&o$UO~P2jOT$VOZ!iO[!iO]!iOk!hOl!hOm!hOn!hOo!hOp!hOq!hOr!hOs!hOt!hOu!hOv!hOw!hOx!hOy!hOz!hO{!sO|!sO}!sO!O!tO!P!nO!Q!sO!R!sO!S!sO!T!sO!U!sO!V!sO!W!sO!X!sO!Y!sO!Z!uO![!oO!]!oO!^!pO!_!pO!`!pO!a!pO!b!pO!c!qO!d!qO!e!qO!f!qO!g!qO!h!qO!i!fO!j!rO!k!rO!l!rO!m!rO#Q!iO#R!iO#X$hO#Y$hO#Z$hO#[$hO#]$hO#^$hO#_$hO#`$hO#a$hO#b$hO#c$hO#d$hO#e$hO#f$hO#g$hO#h$hO#i$hO#j$hO#k$hO#l$hO#m$hO#n$hO#p$iO#s$]O#t$]O#u$]O#v$]O#w$]O%s$WO~O%p&qX~P;gO&n$mO~O%s$oO~O%u$qO%{$pO~OT!hOk!hOl!hOm!hOn!hOo!hOp!hOq!hOr!hOs!hOt!hOu!hOv!hOw!hOx!hOy!hOz!hO{!sO|!sO}!sO!O!tO!P!nO!Q!sO!R!sO!S!sO!T!sO!U!sO!V!sO!W!sO!X!sO!Y!sO!Z!uO![!oO!]!oO!^!pO!_!pO!`!pO!a!pO!b!pO!c!qO!d!qO!e!qO!f!qO!g!qO!h!qO!i!fO!j!rO!k!rO!l!rO!m!rO~O%rRO&o$yOTXP~O%rROTXP%v$bP~OT%OO~O&o%POT%ga~O%u%QO&o%PO~O%u#kO%v%SO~O!n%WO!o%WO!p%WO!q%WO!r%WO!s%WO!t%WO!u%WO!v%WO!w%WO!x%WO!y%WO!z%WO!{%WO!|%WO!}%WO~O%v%ZO~P.{O#q#}O&h$OO#O\'Oa$s\'Oa$t\'Oa$u\'Oa$v\'Oa$w\'Oa$x\'Oa$y\'Oa$z\'Oa${\'Oa$|\'Oa$}\'Oa%O\'Oa%v\'Oa~O%v%bO~P;gO%p%cO~O%v%dO~OT%fO~O#q&dX$T&dX$U&dX%p&dX%sjX%s#oX&h&dX&n&dX%u&dX%v&dX#r&dX~O#s&dX#v&dX#w&dX#x&dX#y&dX#z&dX#{&dX#|&dX#}&dX$O&dX$P&dX$Q&dX$R&dX$S&dX$V&dX$W&dX~PHtO%s#zO~O$T&cX$U&cX%p&cX&n&cX%u&cX%v&cX#r&cX~O#q)WO&h)QO#s&cX#v&cX#w&cX#x&cX#y&cX#z&cX#{&cX#|&cX#}&cX$O&cX$P&cX$Q&cX$R&cX$S&cX$V&cX$W&cX~PJtO#{%lO#|%lO#s&aX#v&aX#x&aX#y&aX#z&aX#}&aX$O&aX$P&aX$Q&aX$R&aX$S&aX$T&aX$U&aX%p&aX&n&aX%u&aX%v&aX#r&aX~O#w&kX$V&lX$W&mX~PLiO#v%mO#x%mO#y%mO#s&`X#z&`X$T&`X$U&`X%p&`X&n&`X%u&`X%v&`X#r&`X~O#}&`X$O&`X$P&`X$Q&`X$R&`X$S&`X~PNWO$T&_X$U&_X%p&_X&n&_X%u&_X%v&_X#r&_X~O#s%nO#z%nO#}&_X$O&_X$P&_X$Q&_X$R&_X$S&_X~P! fO#}%oO$O%oO$P%oO$Q%oO$R%oO$S%oO$T&^X$U&^X%p&^X&n&^X%u&^X%v&^X#r&^X~O$T&iX$U&jX%p&]X&n&]X%u&]X%v&]X#r&]X~O$T%pO~O$U%qO~O#w%rO~O$V%sO~O$W%tO~O&n%wO~O$p%yO&o%zO~P2jO#O%|O~O_iO#v!wO#w!wO$r#WO%s!zO~OT%}O%p&QO~P!$|Of&UOg&UOh&UO~OT&VO~O%u&XO&o&YO~O%rROTXP~O%u&^O%v$bX~O%v&aO~O&o&bOT%ga~O%u&cO~O%u#kO~O%{&dO~O%u&eO~O%u&fO%v&gO~O%u&kO%{&jO~O%u&lO~O%u&mO%v&nO~O#r&qO~O%v&ga$T&ga$U&ga%p&ga&n&ga%u&ga#r&ga~O#q#}O&h$OO#O&ga$s&ga$t&ga$u&ga$v&ga$w&ga$x&ga$y&ga$z&ga${&ga$|&ga$}&ga%O&ga~P!\'xO%v&sO~O$i\'TOT&ri_&ri#v&ri#w&ri$g&ri$h&ri$j&ri$n&ri$q&ri$r&ri%P&ri%Q&ri%R&ri%p&ri%s&ri&n&ri&o&ri$p&ri$l&ri~O$k\'WO$m\'XO~O$p%yO&o\'YO~P2jO&o\'YO~O%s#zO#O\'PX#q\'PX$s\'PX$t\'PX$u\'PX$v\'PX$w\'PX$x\'PX$y\'PX$z\'PX${\'PX$|\'PX&h\'PX~O%p\'_O~P;gO%p\'aO~O%v\'bO~O%{\'cO~O%}#]O~O&o\'dOT%aa%r%aa~O%u\'eO&o\'dO~OT%ba%r%ba%v$ba~O%u\'gO%v$ba~O&p\'iO_$dP#T$dP#U$dP$Y$dP$[$dP$a$dP%T$dP%X$dP%h$dP%p$dP%r$dP&n$dP~OT%_aZ%_a[%_a]%_ak%_al%_am%_an%_ao%_ap%_aq%_ar%_as%_at%_au%_av%_aw%_ax%_ay%_az%_a{%_a|%_a}%_a!O%_a!P%_a!Q%_a!R%_a!S%_a!T%_a!U%_a!V%_a!W%_a!X%_a!Y%_a!Z%_a![%_a!]%_a!^%_a!_%_a!`%_a!a%_a!b%_a!c%_a!d%_a!e%_a!f%_a!g%_a!h%_a!i%_a!j%_a!k%_a!l%_a!m%_a#Q%_a#R%_a~O%v\'lO~P!.nO%u\'mO%v\'lO~OT\'oOZ\'oO[\'oO~OT%`aZ%`a[%`a]%`ak%`al%`am%`an%`ao%`ap%`aq%`ar%`as%`at%`au%`av%`aw%`ax%`ay%`az%`a{%`a|%`a}%`a!O%`a!P%`a!Q%`a!R%`a!S%`a!T%`a!U%`a!V%`a!W%`a!X%`a!Y%`a!Z%`a![%`a!]%`a!^%`a!_%`a!`%`a!a%`a!b%`a!c%`a!d%`a!e%`a!f%`a!g%`a!h%`a!i%`a!j%`a!k%`a!l%`a!m%`a#Q%`a#R%`a#X%`a#Y%`a#Z%`a#[%`a#]%`a#^%`a#_%`a#`%`a#a%`a#b%`a#c%`a#d%`a#e%`a#f%`a#g%`a#h%`a#i%`a#j%`a#k%`a#l%`a#m%`a#n%`a#p%`a#s%`a#t%`a#u%`a#v%`a#w%`a%s%`a~O%v\'rO~P!2wO%u\'sO%v\'rO~O%v&gi$T&gi$U&gi%p&gi&n&gi%u&gi#r&gi~O#q#}O&h$OO#O&gi$s&gi$t&gi$u&gi$v&gi$w&gi$x&gi$y&gi$z&gi${&gi$|&gi$}&gi%O&gi~P!8pO#q)WO&h)QO#s&ga#v&ga#w&ga#x&ga#y&ga#z&ga#{&ga#|&ga#}&ga$O&ga$P&ga$Q&ga$R&ga$S&ga$V&ga$W&ga~P!\'xO#v%mO#x%mO#y%mO#s&`i#z&`i$T&`i$U&`i%p&`i&n&`i%u&`i%v&`i#r&`i~O#}&`i$O&`i$P&`i$Q&`i$R&`i$S&`i~P!;hO#s&aX#v&aX#x&aX#y&aX#z&aX$T&aX$U&aX%p&aX&n&aX%u&aX%v&aX#r&aX~O#{)TO#|)TO~P!<vO#s)UO#z)UO~P! fO%p&]i&n&]i%u&]i%v&]i#r&]i~O$T&ii~P!>SO$U&ji~P!>SO#w&ki~P!>SO$V&li~P!>SO$W&mi~P!>SO$h#TO&n{O~O$k\'WO$m\'XO&o\'zO~OZ!iO[!iO]!iO#Q!iO#R!iO~O%}(OO~O&o(PO~OT(QO#v!wO#w!wO%s!zO%v&za~O%p(UO~O%p(UO~P;gO&o(XOT%aa%r%aa~O%u(YO~OT%ba%r%ba%v$bi~O%u(ZO~O%rROTXPkXPlXPmXPnXPoXPpXPqXPrXPsXPtXPuXPvXPwXPxXPyXPzXP{XP|XP}XP!OXP!PXP!QXP!RXP!SXP!TXP!UXP!VXP!WXP!XXP!YXP!ZXP![XP!]XP!^XP!_XP!`XP!aXP!bXP!cXP!dXP!eXP!fXP!gXP!hXP!iXP!jXP!kXP!lXP!mXP~O%{(]O~O%v(^O~P!.nO%u(_O~O%{(`O~O%u(bO%{(aO~O%v(cO~P!2wO%u(dO~O#q)WO&h)QO#s&gi#v&gi#w&gi#x&gi#y&gi#z&gi#{&gi#|&gi#}&gi$O&gi$P&gi$Q&gi$R&gi$S&gi$V&gi$W&gi~P!8pO%u(hO%}&vX~O%}(kO~O&n(lO~O$}(mO%O(mO~P:[OT(QO#v!wO#w!wO%s!zO%v&zi~O%p(oO~O#q#}O&h$OO~PJtOZ%ea[%ea]%ea#Q%ea#R%ea~O%}&va~P!HbO%u(rO%}&va~O&n(tO~O$l(vO&o(wO~P2jOT(QO#v!wO#w!wO%s!zO%v&zq~O%{(zO~O%}&vi~P!HbO%u({O~O$l(vO&o(|O~P2jO$l(vO&o&wX~P2jO%p)OO~O&o(|O~O&o)PO~OT&tO~OT(eOk!hOl!hOm!hOn!hOo!hOp!hOq!hOr!hOs!hOt!hOu!hOv!hOw!hOx!hOy!hOz!hO{!sO|!sO}!sO!O!tO!P!nO!Q!sO!R!sO!S!sO!T!sO!U!sO!V!sO!W!sO!X!sO!Y!sO!Z!uO![!oO!]!oO!^!pO!_!pO!`!pO!a!pO!b!pO!c!qO!d!qO!e!qO!f!qO!g!qO!h!qO!i!fO!j!rO!k!rO!l!rO!m!rO#X$hO#Y$hO#Z$hO#[$hO#]$hO#^$hO#_$hO#`$hO#a$hO#b$hO#c$hO#d$hO#e$hO#f$hO#g$hO#h$hO#i$hO#j$hO#k$hO#l$hO#m$hO#n$hO#p$iO#s)RO#t)RO#u)RO#v)RO#w)RO%s$WO~P!?mO#r\'vO~OP#x][Z#sT[~',goto:'@{\'TPP\'UP\'XPP\']\'c\'i\'zPPP(WP(ePPPPPPPP(h(wPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP*OPP\'cPP*U*_PPPPPPPPPPPPPPPPPPPPPP*|PPPPPPPPPPPPPPPPPPPPPPP\'cP+kP+q+t+k+zP+},Q,W,Z,sPPPPPPPP-OPPPPPPPPPPPPPPPPPP\']P-U-[PP-b-h-n-x.W.^.d.j.p.v/Q/W/^/oPPPPPPP/uP/xPP0OPP0UP0X0_P0hP0u1P1S1{1S2O2O2w3p4i4l4o4y5t6l7S7i8O8k9l:Z:z;W;xP<[<l<|=^=nPPP>O>X>e>h>q>u>x>h>h?R?U?X?e?v@[@m@r>ORbPT^OQXXOQZdXVOQZdWUOQZdS$v#b$xS$z#d$|R([\'ieSOQTZd#b#d$x$|\'iQgUa!v{#Q$m$o%x(l(t(uR!SiQ!RiQ!TjQ!UkQ#^!SR$n#WW!jz#_#r%Y!W$Y#S#T#U#`#v#z#}$R$W$]%a%l%m%n%o%p%q%r%s%t%|&Q\'a)R)T)U)WQ$r#]Q$u#aQ%U#oQ%[#sQ\'q&lR(p([Q!mzR$s#_Q$s#`Q%^#vR\']%|!X$X#S#T#U#`#v#z#}$R$W$]%a%l%m%n%o%p%q%r%s%t%|&Q\'a)R)T)U)W!X$Y#S#T#U#`#v#z#}$R$W$]%a%l%m%n%o%p%q%r%s%t%|&Q\'a)R)T)U)WXWOQZdR#c!WQ$w#bR&Z$xRhUR$}#dQ${#dR&_$|R\'j&aQ|h^!}{#Q$m%x(l(t(uQ%v$kQ\'[%yQ\'w\'TR(W\'bW#P{#Q$m%xV(u(l(t(uQ%{$mR\'Z%xQt_R#j!_Q![rR#h!]QwaR!`wQQORcQQZOQdQTpZdbTOQZd#b#d$x$|\'iRfTQ!dyR#n!dQ%Y#rR&i%YQ%a#zR&p%aQ$x#bR&[$xQ$|#dR&`$|Q#Q{S$T#Q%xR%x$mQ\'V%wR\'y\'VQ\'|\'WR(j\'|h!x{!z#Q$m$o%x\'_(U(l(o(t(uR#w!xQ!]rR#i!]R[OXYOQZdQ!cyR#m!dR!OiQ#Z}R%]#uQ&T$qQ\'k&eR(q(bY!Qijk!S#WQ&W$vR&]$zQ#p!fS#t!s!uR%u$iR#t!t!m!hz#S#T#U#]#_#`#a#o#r#s#v#z#}$R$W$]%Y%a%l%m%n%o%p%q%r%s%t%|&Q&l\'a([)R)T)U)WR\'p&k!m!ez#S#T#U#]#_#`#a#o#r#s#v#z#}$R$W$]%Y%a%l%m%n%o%p%q%r%s%t%|&Q&l\'a([)R)T)U)W!m!fz#S#T#U#]#_#`#a#o#r#s#v#z#}$R$W$]%Y%a%l%m%n%o%p%q%r%s%t%|&Q&l\'a([)R)T)U)W!m!gz#S#T#U#]#_#`#a#o#r#s#v#z#}$R$W$]%Y%a%l%m%n%o%p%q%r%s%t%|&Q&l\'a([)R)T)U)WR#p!gR%V#qS!lz#_Q%X#rR&h%YW!kz#_#r%Y!W$X#S#T#U#`#v#z#}$R$W$]%a%l%m%n%o%p%q%r%s%t%|&Q\'a)R)T)U)WQ\'{\'WR(i\'|Q$j#SQ$k#TQ$l#UU$t#`#v%|Q%`#zQ%e#}Q%g$RQ%h$WQ&o%aQ\'`&QQ(V\'aR)S)Wl$b#S#T#U#`#v#z#}$R$W%a%|&Q\'a)WQ&}%pR\'O%qp$a#S#T#U#`#v#z#}$R$W%a%p%q%|&Q\'a)WR&|%op$`#S#T#U#`#v#z#}$R$W%a%p%q%|&Q\'a)WR&{%op$_#S#T#U#`#v#z#}$R$W%a%p%q%|&Q\'a)WQ&x%nQ&z%oR(g)Ul$^#S#T#U#`#v#z#}$R$W%a%|&Q\'a)WS%k$])RS&u%l)TQ&v%mS&w%n)UQ&y%oQ\'P%rQ\'Q%sQ\'R%tT)V%p%q!X$[#S#T#U#`#v#z#}$R$W$]%a%l%m%n%o%p%q%r%s%t%|&Q\'a)R)T)U)W!S$Z#S#T#U#`#v#z#}$R$W$]%a%l%m%n%o%p%q%r%s%t%|&Q\'a)U)WT(f)R)TQ#{!yQ%i$YQ\'^%}R(m(Q!W$X#S#T#U#`#v#z#}$R$W$]%a%l%m%n%o%p%q%r%s%t%|&Q\'a)R)T)U)WR\'S%uQ$P!{Q%_#yS%j$Z(fS&r%f&tT\'u&q\'vm$c#S#T#U#`#v#z#}$R$W%a%|&Q\'a)Wm$d#S#T#U#`#v#z#}$R$W%a%|&Q\'a)Wm$e#S#T#U#`#v#z#}$R$W%a%|&Q\'a)Wm$f#S#T#U#`#v#z#}$R$W%a%|&Q\'a)Wm$g#S#T#U#`#v#z#}$R$W%a%|&Q\'a)W_#O{#Q$m%x(l(t(u^!}{#Q$m%x(l(t(uR\'w\'TR\'x\'T_!}{#Q$m%x(l(t(uT\'U%w\'VR\'}\'WQ(x(lQ(}(tR)O(uR&S$oR&R$o^#O{#Q$m%x(l(t(uR&P$o^#O{#Q$m%x(l(t(uQ&P$oV(S\'_(U(o^!|{#Q$m%x(l(t(uQ#|!zQ&O$oV(R\'_(U(oh!{{!z#Q$m$o%x\'_(U(l(o(t(uR#y!xV$R!|&O(RQ(T\'_Q(n(UR(y(o',nodeNames:' LineComment BlockComment Program EnableDirective Identifier Directive LocalDeclaration GlobalVariableDeclaration AttributeList Attribute IntLiteral UintLiteral FloatLiteral VariableDeclaration Keyword VariableQualifier Keyword Keyword Keyword Keyword Keyword Keyword Keyword Keyword VariableIdentifier TypeDeclaration Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Keyword Keyword Keyword Keyword Keyword Type Type Type Type Type Type Keyword Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Type Assign Value Boolean Boolean GlobalConstantDeclaration Keyword Keyword Value Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved Reserved FunctionCall Keyword LeftBracket RightBracket Sub Bang Tilde Mul And Div Mod Add Left Right Lt Gt Lte Gte Eq Neq OrOr AndAnd Or Xor TypeAliasDeclaration Keyword StructDeclaration Keyword StructBodyDeclaration StructMember FunctionDeclaration FunctionHeader Keyword ParamList Param ReturnType CompoundStatement Statement Keyword Keyword Keyword Keyword Keyword Keyword Keyword Keyword ContinuingStatement Keyword Keyword Keyword AddAssign SubAssign MulAssign DivAssign ModAssign AndAssign XorAssign OrAssign LeftAssign RightAssign Inc Dec Keyword Keyword Keyword ImportDeclaration Keyword ImportDeclarationList ImportDeclarationIdentifier String Keyword',maxTerm:283,skippedNodes:[0,1,2,194],repeatNodeCount:14,tokenData:'8z~R|X^#{pq#{qr$prs$}uv&vvw\'Twx\'jxy)^yz)cz{)h{|)u|}*[}!O*a!O!P/T!P!Q/]!Q!R0^!R![1x![!]2^!]!^2k!^!_2p!_!`3a!`!a3n!b!c4_!c!}4d!}#O4u#P#Q4z#Q#R5P#R#S4d#T#U5^#U#Y4d#Y#Z6Y#Z#o4d#o#p8U#p#q8Z#q#r8p#r#s8u#y#z#{$f$g#{#BY#BZ#{$IS$I_#{$I|$JO#{$JT$JU#{$KV$KW#{&FU&FV#{~$QY%j~X^#{pq#{#y#z#{$f$g#{#BY#BZ#{$IS$I_#{$I|$JO#{$JT$JU#{$KV$KW#{&FU&FV#{Y$uP#tQ!_!`$xW$}O$SW~%QVOr$}rs%gs#O$}#O#P%l#P;\'S$};\'S;=`&p<%lO$}~%lO%W~~%oVOr$}rs&Us#O$}#O#P%l#P;\'S$};\'S;=`&p<%lO$}~&ZV%W~Or$}rs%gs#O$}#O#P%l#P;\'S$};\'S;=`&p<%lO$}~&sP;=`<%l$}^&{P#yY!_!`\'OS\'TO$wS~\'YQ#wYvw\'`!_!`\'e~\'eO$U~S\'jO$xS~\'mVOw\'jwx%gx#O\'j#O#P(S#P;\'S\'j;\'S;=`)W<%lO\'j~(VVOw\'jwx(lx#O\'j#O#P(S#P;\'S\'j;\'S;=`)W<%lO\'j~(qV%W~Ow\'jwx%gx#O\'j#O#P(S#P;\'S\'j;\'S;=`)W<%lO\'j~)ZP;=`<%l\'j~)cO%s~~)hO%v~^)mP#vY!_!`)pS)uO$uS^)zQ#zY{|*Q!_!`*VS*VO$}SS*[O$sS~*aO%u~~*fU#sY}!O*x!O!P*}!Q!R,Y!R![.h!_!`.y!`!a/OS*}O%OSb+QP!Q![+Tb+YS]b!Q![+T!g!h+f#X#Y+f#Y#Z,Tb+iR{|+r}!O+r!Q![+xb+uP!Q![+xb+}Q]b!Q![+x#Y#Z,Tb,YO]b~,]U!O!P+T!Q![,o!g!h+f!z!{-O#X#Y+f#l#m-Ob,rS!O!P+T!Q![,o!g!h+f#X#Y+f~-RS!O!P-_!Q![.P!c!i.P#T#Z.Pb-bR!Q![-k!c!i-k#T#Z-kb-pT]b!Q![-k!c!i-k!r!s+f#T#Z-k#d#e+f~.UUZ~!O!P-k!Q![.P!c!i.P!r!s+f#T#Z.P#d#e+f~.mSZ~!O!P+T!Q![.h!g!h+f#X#Y+fS/OO$tS`/TO&p`n/YP&h[!Q![+T~/bR#xYz{/k!P!Q/p!_!`0X~/pO%k~~/uSP~OY/pZ;\'S/p;\'S;=`0R<%lO/p~0UP;=`<%l/pS0^O$vS~0cVZ~!O!P+T!Q![,o!g!h+f!z!{0x#X#Y+f#i#j1s#l#m0x~0{S!O!P-_!Q![1X!c!i1X#T#Z1X~1^VZ~!O!P-k!Q![1X!c!i1X!r!s+f#T#Z1X#d#e+f#i#j1s~1xO[~~1}TZ~!O!P+T!Q![1x!g!h+f#X#Y+f#i#j1sf2cP%}d![!]2fQ2kO\'VQ~2pO%p~^2wQ%xQ#}W!^!_2}!_!`3[[3SP#{W!_!`3VS3[O${SW3aO$PW^3fP#OU!_!`3iW3nO$RW^3uQ%{Q$OW!_!`3{!`!a4QW4QO$QW[4VP#|W!_!`4YS4_O$|S~4dO%r~b4iSTb!Q![4d!c!}4d#R#S4d#T#o4d~4zO#q~~5PO#r~^5UP$WY!_!`5XS5^O$ySf5cUTb!Q![4d!c!}4d#R#S4d#T#g4d#g#h5u#h#o4df5|S\'TSTb!Q![4d!c!}4d#R#S4d#T#o4df6_UTb!Q![4d!c!}4d#R#S4d#T#f4d#f#g6q#g#o4df6vUTb!Q![4d!c!}4d#R#S4d#T#c4d#c#d7Y#d#o4df7_UTb!Q![4d!c!}4d#R#S4d#T#a4d#a#b7q#b#o4df7xS\'USTb!Q![4d!c!}4d#R#S4d#T#o4d~8ZO&n~~8`Q$VY!_!`8f#p#q8kS8kO$zS~8pO$T~~8uO&o~~8zO#u~',tokenizers:[1,2,3,4,new qx('j~RQYZXz{^~^O%m~~aP!P!Qd~iO%n~~',25,212)],topRules:{Program:[0,3]},specialized:[{term:5,get:e=>cb[e]||-1}],tokenPrec:4295}).configure({props:[Nd({Assign:rf.operator,AddAssign:rf.operator,SubAssign:rf.operator,MulAssign:rf.operator,DivAssign:rf.operator,ModAssign:rf.operator,LeftAssign:rf.operator,RightAssign:rf.operator,AndAssign:rf.operator,XorAssign:rf.operator,OrAssign:rf.operator,Add:rf.operator,Sub:rf.operator,Mul:rf.operator,Div:rf.operator,Mod:rf.operator,Left:rf.operator,Right:rf.operator,And:rf.operator,Xor:rf.operator,Or:rf.operator,AndAnd:rf.operator,OrOr:rf.operator,Inc:rf.operator,Dec:rf.operator,Bang:rf.operator,Tilde:rf.operator,Eq:rf.operator,Neq:rf.operator,Lt:rf.operator,Lte:rf.operator,Gt:rf.operator,Gte:rf.operator,'<':rf.operator,'>':rf.operator,ReturnType:rf.operator,Comment:rf.comment,LineComment:rf.comment,BlockComment:rf.comment,'FunctionHeader/Identifier':rf.macroName,'FunctionCall/Identifier':rf.macroName,Keyword:rf.keyword,Type:rf.typeName,TypeDeclaration:rf.typeName,Attribute:rf.attributeName,'Attribute/Identifier':rf.attributeName,'Attribute/IntLiteral':rf.number,IntLiteral:rf.number,UintLiteral:rf.number,FloatLiteral:rf.number,String:rf.string,true:rf.number,false:rf.number,Directive:rf.keyword,Identifier:rf.macroName}),$f.add({ifStatement:function({except:e,units:t=1}={}){return n=>{let s=e&&e.test(n.textAfter);return n.baseIndent+(s?0:t*n.unit)}}({except:/^\s*({|else\b)/}),CompoundStatement:Lf({closing:'}'}),StructBodyDeclaration:Lf({closing:'}'})})]}),ub=uf.define({name:'wgsl',parser:hb,languageData:{closeBrackets:{brackets:['(','[','{','\'','"','`']},commentTokens:{line:'//',block:{open:'/*',close:'*/'}},indentOnInput:/^\s*(?:case |default:|\{|\}|<\/)$/,wordChars:'$'}});function db(){return new wf(ub)}const fb=({variant:e,settings:t,styles:n})=>[fh.theme({'&':{backgroundColor:t.background,color:t.foreground},'.cm-content':{caretColor:t.caret},'.cm-cursor, .cm-dropCursor':{borderLeftColor:t.caret},'&.cm-focused .cm-selectionBackgroundm .cm-selectionBackground, .cm-content ::selection':{backgroundColor:t.selection},'.cm-activeLine':{backgroundColor:t.lineHighlight},'.cm-gutters':{backgroundColor:t.gutterBackground,color:t.gutterForeground},'.cm-activeLineGutter':{backgroundColor:t.lineHighlight}},{dark:'dark'===e}),dp(lp.define(n))];fb({variant:'dark',settings:{background:'#200020',foreground:'#D0D0FF',caret:'#7070FF',selection:'#80000080',gutterBackground:'#200020',gutterForeground:'#C080C0',lineHighlight:'#80000040'},styles:[{tag:rf.comment,color:'#404080'},{tag:[rf.string,rf.regexp],color:'#999999'},{tag:rf.number,color:'#7090B0'},{tag:[rf.bool,rf.null],color:'#8080A0'},{tag:[rf.punctuation,rf.derefOperator],color:'#805080'},{tag:rf.keyword,color:'#60B0FF'},{tag:rf.definitionKeyword,color:'#B0FFF0'},{tag:rf.moduleKeyword,color:'#60B0FF'},{tag:rf.operator,color:'#A0A0FF'},{tag:[rf.variableName,rf.self],color:'#008080'},{tag:rf.operatorKeyword,color:'#A0A0FF'},{tag:rf.controlKeyword,color:'#80A0FF'},{tag:rf.className,color:'#70E080'},{tag:[rf.function(rf.propertyName),rf.propertyName],color:'#50A0A0'},{tag:rf.tagName,color:'#009090'},{tag:rf.modifier,color:'#B0FFF0'},{tag:[rf.squareBracket,rf.attributeName],color:'#D0D0FF'}]}),fb({variant:'light',settings:{background:'#fcfcfc',foreground:'#5c6166',caret:'#ffaa33',selection:'#036dd626',gutterBackground:'#fcfcfc',gutterForeground:'#8a919966',lineHighlight:'#8a91991a'},styles:[{tag:rf.comment,color:'#787b8099'},{tag:rf.string,color:'#86b300'},{tag:rf.regexp,color:'#4cbf99'},{tag:[rf.number,rf.bool,rf.null],color:'#ffaa33'},{tag:rf.variableName,color:'#5c6166'},{tag:[rf.definitionKeyword,rf.modifier],color:'#fa8d3e'},{tag:[rf.keyword,rf.special(rf.brace)],color:'#fa8d3e'},{tag:rf.operator,color:'#ed9366'},{tag:rf.separator,color:'#5c6166b3'},{tag:rf.punctuation,color:'#5c6166'},{tag:[rf.definition(rf.propertyName),rf.function(rf.variableName)],color:'#f2ae49'},{tag:[rf.className,rf.definition(rf.typeName)],color:'#22a4e6'},{tag:[rf.tagName,rf.typeName,rf.self,rf.labelName],color:'#55b4d4'},{tag:rf.angleBracket,color:'#55b4d480'},{tag:rf.attributeName,color:'#f2ae49'}]}),fb({variant:'dark',settings:{background:'#15191EFA',foreground:'#EEF2F7',caret:'#C4C4C4',selection:'#90B2D557',gutterBackground:'#15191EFA',gutterForeground:'#aaaaaa95',lineHighlight:'#57575712'},styles:[{tag:rf.comment,color:'#6E6E6E'},{tag:[rf.string,rf.regexp,rf.special(rf.brace)],color:'#5C81B3'},{tag:rf.number,color:'#C1E1B8'},{tag:rf.bool,color:'#53667D'},{tag:[rf.definitionKeyword,rf.modifier,rf.function(rf.propertyName)],color:'#A3D295',fontWeight:'bold'},{tag:[rf.keyword,rf.moduleKeyword,rf.operatorKeyword,rf.operator],color:'#697A8E',fontWeight:'bold'},{tag:[rf.variableName,rf.attributeName],color:'#708E67'},{tag:[rf.function(rf.variableName),rf.definition(rf.propertyName),rf.derefOperator],color:'#fff'},{tag:rf.tagName,color:'#A3D295'}]}),fb({variant:'dark',settings:{background:'#2e241d',foreground:'#BAAE9E',caret:'#A7A7A7',selection:'#DDF0FF33',gutterBackground:'#28211C',gutterForeground:'#BAAE9E90',lineHighlight:'#FFFFFF08'},styles:[{tag:rf.comment,color:'#666666'},{tag:[rf.string,rf.special(rf.brace)],color:'#54BE0D'},{tag:rf.regexp,color:'#E9C062'},{tag:rf.number,color:'#CF6A4C'},{tag:[rf.keyword,rf.operator],color:'#5EA6EA'},{tag:rf.variableName,color:'#7587A6'},{tag:[rf.definitionKeyword,rf.modifier],color:'#F9EE98'},{tag:[rf.propertyName,rf.function(rf.variableName)],color:'#937121'},{tag:[rf.typeName,rf.angleBracket,rf.tagName],color:'#9B859D'}]}),fb({variant:'dark',settings:{background:'#3b2627',foreground:'#E6E1C4',caret:'#E6E1C4',selection:'#16120E',gutterBackground:'#3b2627',gutterForeground:'#E6E1C490',lineHighlight:'#1F1611'},styles:[{tag:rf.comment,color:'#6B4E32'},{tag:[rf.keyword,rf.operator,rf.derefOperator],color:'#EF5D32'},{tag:rf.className,color:'#EFAC32',fontWeight:'bold'},{tag:[rf.typeName,rf.propertyName,rf.function(rf.variableName),rf.definition(rf.variableName)],color:'#EFAC32'},{tag:rf.definition(rf.typeName),color:'#EFAC32',fontWeight:'bold'},{tag:rf.labelName,color:'#EFAC32',fontWeight:'bold'},{tag:[rf.number,rf.bool],color:'#6C99BB'},{tag:[rf.variableName,rf.self],color:'#7DAF9C'},{tag:[rf.string,rf.special(rf.brace),rf.regexp],color:'#D9D762'},{tag:[rf.angleBracket,rf.tagName,rf.attributeName],color:'#EFCB43'}]}),fb({variant:'dark',settings:{background:'#000205',foreground:'#FFFFFF',caret:'#E60065',selection:'#E60C6559',gutterBackground:'#000205',gutterForeground:'#ffffff90',lineHighlight:'#4DD7FC1A'},styles:[{tag:rf.comment,color:'#404040'},{tag:[rf.string,rf.special(rf.brace),rf.regexp],color:'#00D8FF'},{tag:rf.number,color:'#E62286'},{tag:[rf.variableName,rf.attributeName,rf.self],color:'#E62286',fontWeight:'bold'},{tag:rf.function(rf.variableName),color:'#fff',fontWeight:'bold'}]}),fb({variant:'light',settings:{background:'#fff',foreground:'#000',caret:'#000',selection:'#BDD5FC',gutterBackground:'#fff',gutterForeground:'#00000070',lineHighlight:'#FFFBD1'},styles:[{tag:rf.comment,color:'#BCC8BA'},{tag:[rf.string,rf.special(rf.brace),rf.regexp],color:'#5D90CD'},{tag:[rf.number,rf.bool,rf.null],color:'#46A609'},{tag:rf.keyword,color:'#AF956F'},{tag:[rf.definitionKeyword,rf.modifier],color:'#C52727'},{tag:[rf.angleBracket,rf.tagName,rf.attributeName],color:'#606060'},{tag:rf.self,color:'#000'}]});const pb=fb({variant:'dark',settings:{background:'#00254b',foreground:'#FFFFFF',caret:'#FFFFFF',selection:'#B36539BF',gutterBackground:'#00254b',gutterForeground:'#FFFFFF70',lineHighlight:'#00000059'},styles:[{tag:rf.comment,color:'#0088FF'},{tag:rf.string,color:'#3AD900'},{tag:rf.regexp,color:'#80FFC2'},{tag:[rf.number,rf.bool,rf.null],color:'#FF628C'},{tag:[rf.definitionKeyword,rf.modifier],color:'#FFEE80'},{tag:rf.variableName,color:'#CCCCCC'},{tag:rf.self,color:'#FF80E1'},{tag:[rf.className,rf.definition(rf.propertyName),rf.function(rf.variableName),rf.definition(rf.typeName),rf.labelName],color:'#FFDD00'},{tag:[rf.keyword,rf.operator],color:'#FF9D00'},{tag:[rf.propertyName,rf.typeName],color:'#80FFBB'},{tag:rf.special(rf.brace),color:'#EDEF7D'},{tag:rf.attributeName,color:'#9EFFFF'},{tag:rf.derefOperator,color:'#fff'}]});fb({variant:'dark',settings:{background:'#060521',foreground:'#E0E0E0',caret:'#FFFFFFA6',selection:'#122BBB',gutterBackground:'#060521',gutterForeground:'#E0E0E090',lineHighlight:'#FFFFFF0F'},styles:[{tag:rf.comment,color:'#AEAEAE'},{tag:[rf.string,rf.special(rf.brace),rf.regexp],color:'#8DFF8E'},{tag:[rf.className,rf.definition(rf.propertyName),rf.function(rf.variableName),rf.function(rf.definition(rf.variableName)),rf.definition(rf.typeName)],color:'#A3EBFF'},{tag:[rf.number,rf.bool,rf.null],color:'#62E9BD'},{tag:[rf.keyword,rf.operator],color:'#2BF1DC'},{tag:[rf.definitionKeyword,rf.modifier],color:'#F8FBB1'},{tag:[rf.variableName,rf.self],color:'#B683CA'},{tag:[rf.angleBracket,rf.tagName,rf.typeName,rf.propertyName],color:'#60A4F1'},{tag:rf.derefOperator,color:'#E0E0E0'},{tag:rf.attributeName,color:'#7BACCA'}]}),fb({variant:'dark',settings:{background:'#2d2f3f',foreground:'#f8f8f2',caret:'#f8f8f0',selection:'#44475a',gutterBackground:'#282a36',gutterForeground:'rgb(144, 145, 148)',lineHighlight:'#44475a'},styles:[{tag:rf.comment,color:'#6272a4'},{tag:[rf.string,rf.special(rf.brace)],color:'#f1fa8c'},{tag:[rf.number,rf.self,rf.bool,rf.null],color:'#bd93f9'},{tag:[rf.keyword,rf.operator],color:'#ff79c6'},{tag:[rf.definitionKeyword,rf.typeName],color:'#8be9fd'},{tag:rf.definition(rf.typeName),color:'#f8f8f2'},{tag:[rf.className,rf.definition(rf.propertyName),rf.function(rf.variableName),rf.attributeName],color:'#50fa7b'}]}),fb({variant:'light',settings:{background:'#FFFFFF',foreground:'#000000',caret:'#000000',selection:'#80C7FF',gutterBackground:'#FFFFFF',gutterForeground:'#00000070',lineHighlight:'#C1E2F8'},styles:[{tag:rf.comment,color:'#AAAAAA'},{tag:[rf.keyword,rf.operator,rf.typeName,rf.tagName,rf.propertyName],color:'#2F6F9F',fontWeight:'bold'},{tag:[rf.attributeName,rf.definition(rf.propertyName)],color:'#4F9FD0'},{tag:[rf.className,rf.string,rf.special(rf.brace)],color:'#CF4F5F'},{tag:rf.number,color:'#CF4F5F',fontWeight:'bold'},{tag:rf.variableName,fontWeight:'bold'}]}),fb({variant:'light',settings:{background:'#f2f1f8',foreground:'#0c006b',caret:'#5c49e9',selection:'#d5d1f2',gutterBackground:'#f2f1f8',gutterForeground:'#0c006b70',lineHighlight:'#e1def3'},styles:[{tag:rf.comment,color:'#9995b7'},{tag:rf.keyword,color:'#ff5792',fontWeight:'bold'},{tag:[rf.definitionKeyword,rf.modifier],color:'#ff5792'},{tag:[rf.className,rf.tagName,rf.definition(rf.typeName)],color:'#0094f0'},{tag:[rf.number,rf.bool,rf.null,rf.special(rf.brace)],color:'#5842ff'},{tag:[rf.definition(rf.propertyName),rf.function(rf.variableName)],color:'#0095a8'},{tag:rf.typeName,color:'#b3694d'},{tag:[rf.propertyName,rf.variableName],color:'#fa8900'},{tag:rf.operator,color:'#ff5792'},{tag:rf.self,color:'#e64100'},{tag:[rf.string,rf.regexp],color:'#00b368'},{tag:[rf.paren,rf.bracket],color:'#0431fa'},{tag:rf.labelName,color:'#00bdd6'},{tag:rf.attributeName,color:'#e64100'},{tag:rf.angleBracket,color:'#9995b7'}]}),fb({variant:'light',settings:{background:'#faf4ed',foreground:'#575279',caret:'#575279',selection:'#6e6a8614',gutterBackground:'#faf4ed',gutterForeground:'#57527970',lineHighlight:'#6e6a860d'},styles:[{tag:rf.comment,color:'#9893a5'},{tag:[rf.bool,rf.null],color:'#286983'},{tag:rf.number,color:'#d7827e'},{tag:rf.className,color:'#d7827e'},{tag:[rf.angleBracket,rf.tagName,rf.typeName],color:'#56949f'},{tag:rf.attributeName,color:'#907aa9'},{tag:rf.punctuation,color:'#797593'},{tag:[rf.keyword,rf.modifier],color:'#286983'},{tag:[rf.string,rf.regexp],color:'#ea9d34'},{tag:rf.variableName,color:'#d7827e'}]}),fb({variant:'light',settings:{background:'#FFFFFF',foreground:'#000000',caret:'#000000',selection:'#FFFD0054',gutterBackground:'#FFFFFF',gutterForeground:'#00000070',lineHighlight:'#00000008'},styles:[{tag:rf.comment,color:'#CFCFCF'},{tag:[rf.number,rf.bool,rf.null],color:'#E66C29'},{tag:[rf.className,rf.definition(rf.propertyName),rf.function(rf.variableName),rf.labelName,rf.definition(rf.typeName)],color:'#2EB43B'},{tag:rf.keyword,color:'#D8B229'},{tag:rf.operator,color:'#4EA44E',fontWeight:'bold'},{tag:[rf.definitionKeyword,rf.modifier],color:'#925A47'},{tag:rf.string,color:'#704D3D'},{tag:rf.typeName,color:'#2F8996'},{tag:[rf.variableName,rf.propertyName],color:'#77ACB0'},{tag:rf.self,color:'#77ACB0',fontWeight:'bold'},{tag:rf.regexp,color:'#E3965E'},{tag:[rf.tagName,rf.angleBracket],color:'#BAA827'},{tag:rf.attributeName,color:'#B06520'},{tag:rf.derefOperator,color:'#000'}]}),fb({variant:'light',settings:{background:'#fef7e5',foreground:'#586E75',caret:'#000000',selection:'#073642',gutterBackground:'#fef7e5',gutterForeground:'#586E7580',lineHighlight:'#EEE8D5'},styles:[{tag:rf.comment,color:'#93A1A1'},{tag:rf.string,color:'#2AA198'},{tag:rf.regexp,color:'#D30102'},{tag:rf.number,color:'#D33682'},{tag:rf.variableName,color:'#268BD2'},{tag:[rf.keyword,rf.operator,rf.punctuation],color:'#859900'},{tag:[rf.definitionKeyword,rf.modifier],color:'#073642',fontWeight:'bold'},{tag:[rf.className,rf.self,rf.definition(rf.propertyName)],color:'#268BD2'},{tag:rf.function(rf.variableName),color:'#268BD2'},{tag:[rf.bool,rf.null],color:'#B58900'},{tag:rf.tagName,color:'#268BD2',fontWeight:'bold'},{tag:rf.angleBracket,color:'#93A1A1'},{tag:rf.attributeName,color:'#93A1A1'},{tag:rf.typeName,color:'#859900'}]}),fb({variant:'light',settings:{background:'#FFFFFF',foreground:'#4D4D4C',caret:'#AEAFAD',selection:'#D6D6D6',gutterBackground:'#FFFFFF',gutterForeground:'#4D4D4C80',lineHighlight:'#EFEFEF'},styles:[{tag:rf.comment,color:'#8E908C'},{tag:[rf.variableName,rf.self,rf.propertyName,rf.attributeName,rf.regexp],color:'#C82829'},{tag:[rf.number,rf.bool,rf.null],color:'#F5871F'},{tag:[rf.className,rf.typeName,rf.definition(rf.typeName)],color:'#C99E00'},{tag:[rf.string,rf.special(rf.brace)],color:'#718C00'},{tag:rf.operator,color:'#3E999F'},{tag:[rf.definition(rf.propertyName),rf.function(rf.variableName)],color:'#4271AE'},{tag:rf.keyword,color:'#8959A8'},{tag:rf.derefOperator,color:'#4D4D4C'}]});const mb=Ir.define({map:(e,t)=>({pos:t.mapPos(e.pos),on:e.on})}),gb=Ir.define({map:(e,t)=>({lineNo:t.mapPos(e.lineNo)})}),vb=ir.define({create:()=>jr.empty,update(e,t){e=e.map(t.changes);for(let n of t.effects)n.is(mb)&&(e=n.value.on?e.update({add:[xb.range(n.value.pos)]}):e.update({filter:e=>e!=n.value.pos}));return e}});const xb=new class extends Eu{toDOM(){const e=document.createElement('div');return e.classList.add('cm-breakpoint-marker'),e}},bb=[vb,Bu({class:'cm-breakpoint-gutter',markers:e=>e.state.field(vb),initialSpacer:()=>xb,domEventHandlers:{mousedown(e,t){const n=e.state.doc.lineAt(t.from).number;return e.debugger.toggleBreakpoint(n),function(e,t){let n=e.state.field(vb),s=!1;n.between(t,t,(()=>{s=!0})),e.dispatch({effects:mb.of({pos:t,on:!s})})}(e,t.from),!0}}}),fh.baseTheme({'.cm-breakpoint-gutter':{cursor:'pointer',backgroundColor:'rgb(45, 45, 45)'},'.cm-breakpoint-gutter .cm-gutterElement':{color:'red',paddingLeft:'5px',cursor:'pointer',backgroundColor:'rgb(45, 45, 45)'}})],yb=ir.define({create:()=>xa.none,update(e,t){e=e.map(t.changes);for(let n of t.effects)n.is(gb)&&(e=xa.none,n.value.lineNo>0&&(e=e.update({add:[_b.range(n.value.lineNo)]})));return e},provide:e=>fh.decorations.from(e)}),_b=xa.line({attributes:{style:'background-color:rgb(64, 73, 14)'}}),wb=[bb,yb,Ku(),eu(),Fr.readOnly.of(!0),Yp(),op(),Bh(),Xh(),Nf(),dp(mp,{fallback:!0}),Op(),Jv(),ou(),pb,db(),_h.of([hg,...rx,...cg,...ev,...fm,...Kf,...px,...Ix])];class kb extends At{constructor(e,t,n,s,i,r){super(null,r),this._element.classList.add('shader-debugger'),this._hotkeyEvent=this.hotkeyEvent.bind(this),document.addEventListener('keydown',this._hotkeyEvent),this.capturePanel=i,this.command=e,this.captureData=n,this.database=s,this.entry=t,this.pipelineState=this.capturePanel._getPipelineState(e);const o=this.pipelineState.pipeline.args,a=o[0]?.__id,l=s.getObject(a).descriptor,c=l.compute?.module?.__id;this.module=s.getObject(c);const h=this.module.descriptor.code;this._idX=0,this._idY=0,this._idZ=0,this.controls=new At(this,{style:'display: flex; flex-direction: row; margin-top: 5px;'}),new Rt(this.controls,{text:'Thread ID:',style:'margin-left: 10px; margin-right: 5px; vertical-align: middle; color: #bbb;'}),this.idXInput=new Qt(this.controls,{value:0,min:0,precision:0,step:1,style:'flex: 0 0 auto; display: inline-block; width: 100px; margin-right: 10px; vertical-align: middle;',onChange:e=>{this._idX=e}}),this.idYInput=new Qt(this.controls,{value:0,min:0,step:1,precision:0,style:'flex: 0 0 auto; display: inline-block; width: 100px; margin-right: 10px; vertical-align: middle;',onChange:e=>{this._idY=e}}),this.idZInput=new Qt(this.controls,{value:0,min:0,step:1,precision:0,style:'flex: 0 0 auto; display: inline-block; width: 100px; margin-right: 10px; vertical-align: middle;',onChange:e=>{this._idZ=e}}),new Nt(this.controls,{children:[new nn(null,{title:'Debug Shader (F8)',src:'img/debug.svg',style:'width: 15px; height: 15px; filter: invert(1);'})],title:'Debug Shader (F8)',onClick:()=>{this.debug()}}),new At(this.controls,{style:'flex-grow: 1;'}),this.continueButton=new Nt(this.controls,{children:[new nn(null,{title:'Continue (F5)',src:'img/debug-continue-small.svg',style:'width: 15px; height: 15px; filter: invert(1);'})],title:'Continue (F5)',style:'background-color: #777;',onClick:()=>{this.pauseContinue()}}),new Nt(this.controls,{children:[new nn(null,{title:'Step Over (F10)',src:'img/debug-step-over.svg',style:'width: 15px; height: 15px; filter: invert(1);'})],title:'Step Over (F10)',style:'background-color: #777;',onClick:()=>{this.stepOver()}}),new Nt(this.controls,{children:[new nn(null,{title:'Step Into (F11)',src:'img/debug-step-into.svg',style:'width: 15px; height: 15px; filter: invert(1);'})],title:'Step Into (F11)',style:'background-color: #777;',onClick:()=>{this.stepInto()}}),new Nt(this.controls,{children:[new nn(null,{title:'Step Out (F12)',src:'img/debug-step-out.svg',style:'width: 15px; height: 15px; filter: invert(1);'})],title:'Step Out (F12)',style:'background-color: #777;',onClick:()=>{this.stepOut()}}),new Nt(this.controls,{children:[new nn(null,{title:'Restart (F7)',src:'img/debug-restart.svg',style:'width: 15px; height: 15px; filter: invert(1);'})],title:'Restart (F7)',style:'background-color: #777;',onClick:()=>{this.restart()}}),new At(this.controls,{style:'flex-grow: 2;'});const u=new At(this,{style:'height: 100%;'}),d=new tn(u,{direction:tn.Horizontal,position:.7}),f=new Rt(d,{style:'flex-grow: 1; height: calc(100% - 35px); overflow: auto;'}),p=new Rt(d,{style:'flex-grow: 1; height: calc(100% - 35px); overflow: auto;'});this.editorView=new fh({doc:h,extensions:[wb],parent:f.element}),this.editorView.dom.style.height='100%',this.editorView.debugger=this,Zg(this.editorView),this.watch=new At(p,{style:'overflow: auto; background-color: #333; color: #bbb; height: 100%;'}),this.variables=new Ft(this.watch,{collapsed:!1,label:'Variables'}),this.globals=new Ft(this.watch,{collapsed:!1,label:'Globals'}),this.callstack=new Ft(this.watch,{collapsed:!1,label:'Callstack'}),this.debug()}onDestroy(){document.removeEventListener('keydown',this._hotkeyEvent)}hotkeyEvent(e){'none'!==this.display&&('F5'===e.key?(this.pauseContinue(),e.preventDefault()):'F10'===e.key?(this.stepOver(),e.preventDefault()):'F11'===e.key?(this.stepInto(),e.preventDefault()):'F12'===e.key?(this.stepOut(),e.preventDefault()):'F8'===e.key?(this.debug(),e.preventDefault()):'F7'===e.key&&(this.restart(),e.preventDefault()))}toggleBreakpoint(e){this.debugger.toggleBreakpoint(e)}runStateChanged(){this.debugger.isRunning?this.continueButton.children[0].src='img/debug-pause.svg':this.continueButton.children[0].src='img/debug-continue-small.svg',this.update()}pauseContinue(){this.debugger||this.debug(),this.debugger.isRunning?(this.debugger.pause(),this.update()):(this.debugger.run(),this.update())}restart(){this.debug()}debug(){const e=Math.floor(this._idX),t=Math.floor(this._idY),n=Math.floor(this._idZ),s=[1,1,1],i=this.command.args[0];i instanceof Array?(s[0]=i[0],i.length>1&&(s[1]=i[1]),i.length>2&&(s[2]=i[2])):s[0]=i;const r=this.module?.reflection;if(!r)return;let o=null;if(this.entry&&(o=r.entry.compute.find((e=>e.name===this.entry))),!o&&(o=r.entry.compute[0],!o))return;const a=o.name,l={};if(this.pipelineState.bindGroups.forEach((e=>{const t=e.args[0],n=this.pipelineState.bindGroups[t],s={};l[t]=s;const i=this.database.getObject(e.args[1].__id);if(void 0!==n.bufferData){const e=n.bufferData;let t=0;for(const n of e){if(n){s[i.descriptor.entries[t].binding]=n}t++}}for(const e of i.descriptor.entries){const t=e.binding;if(void 0!==s[t])continue;const n=this.database.getObject(e.resource.__id);if(n instanceof xt){const e=n.__texture;if(!e.imageData){console.log('No image data for texture',e);continue}const i=[e.width,e.height,e.depthOrArrayLayers];s[t]={texture:e.imageData,size:i}}}})),this.debugger)this.debugger.reset();else{const e=this.module.descriptor.code;this.debugger=new ui(e,this.runStateChanged.bind(this))}this.debugger.debugWorkgroup(a,[e,t,n],s,l),this.update()}stepInto(){this.debugger&&(this.debugger.stepInto(),this.update())}stepOver(){this.debugger&&(this.debugger.stepOver(),this.update())}stepOut(){this.debugger&&(this.debugger.stepOut(),this.update())}_createVariableDiv(e,t){if(!e.value)return;const n=new At(t),s=e.value.typeInfo;let i=s.name;s.format&&(i=`${i}<${s.format.name}>`),new Rt(n,{text:e.name,class:'watch-var-name'}),new Rt(n,{text:i,class:'watch-var-type'}),new Rt(n,{text:`${e.value}`,class:'watch-var-value'})}update(){if(!this.debugger)return;const e=this.debugger.currentCommand;if(null===e||this.debugger.isRunning)this._highlightLine(0);else{e.line>-1?this._highlightLine(e.line):this._highlightLine(0)}this.variables.body.removeAllChildren(),this.globals.body.removeAllChildren(),this.callstack.body.removeAllChildren();let t=this.debugger.currentState;if(null===t){const e=this.debugger.context,t=e.currentFunctionName;new At(this.variables.body,{text:t||'<shader>',style:'font-weight: bold; color: #eee; padding-bottom: 2px;'}),new At(this.callstack.body,{text:t||'<shader>',style:'font-weight: bold; color: #eee; padding-bottom: 2px;'}),e.variables.forEach(((e,t)=>{t.startsWith('@')||this._createVariableDiv(e,this.variables.body)})),e.variables.forEach(((e,t)=>{t.startsWith('@')&&this._createVariableDiv(e,this.globals.body)}))}else{let e=t,n=null;for(;null!==t;){const s=t.context,i=s.currentFunctionName||'<shader>';new At(this.variables.body,{text:i,style:'font-weight: bold; color: #eee; padding-bottom: 2px;'}),i!==n&&new At(this.callstack.body,{text:i,style:'font-weight: bold; color: #eee; padding-bottom: 2px;'}),n=i,s.variables.forEach(((e,t)=>{t.startsWith('@')||this._createVariableDiv(e,this.variables.body)})),e=t,t=t.parent}if(e){e.context.variables.forEach(((e,t)=>{t.startsWith('@')&&this._createVariableDiv(e,this.globals.body)}))}}}_highlightLine(e){if(e>0){const t=this.editorView.state.doc.line(e),n=fh.scrollIntoView(t.from,{y:'center'});this.editorView.dispatch({effects:[gb.of({lineNo:t.from}),n]})}else this.editorView.dispatch({effects:gb.of({lineNo:0})})}}const Ob='background-color: rgb(40, 40, 40);';class Sb{constructor(e,n){this.window=e;const s=this,i=e.port;this.statistics=new Bt,this._captureData=null;const o=new At(n,{style:'background-color: #333; box-shadow: #000 0px 3px 3px; border-bottom: 1px solid #000; margin-bottom: 10px; padding-left: 20px; padding-top: 10px; padding-bottom: 10px;'});new Nt(o,{label:'Capture',style:'background-color: #557;',callback:()=>{try{this._captureData=new Jt(this.database),this._captureData.onCaptureFrameResults.addListener(s._captureFrameResults,s),this._captureData.onUpdateCaptureStatus.addListener(s._updateCaptureStatus,s);const e=0===s.captureMode?-1:s.captureSpecificFrame;s.port.postMessage({action:r,captureFrameCount:this.captureFrameCount,maxBufferSize:s.maxBufferSize,frame:e})}catch(e){console.error(e.message)}}}),this.captureMode=0,new Gt(o,{options:['Immediate','Specific Frame'],style:'margin-right: 10px; vertical-align: middle;',onChange:(e,t)=>{s.captureMode=t,0===s.captureMode?s.captureFrameEdit.style.display='none':s.captureFrameEdit.style.display='inline-block'}}),this.captureSpecificFrame=0,this.captureFrameEdit=new Qt(o,{value:this.captureSpecificFrame,min:-1,step:1,precision:0,style:'display: inline-block; width: 75px; margin-right: 10px; vertical-align: middle;',onChange:e=>{s.captureSpecificFrame=Math.max(e,-1)}}),0===this.captureMode&&(this.captureFrameEdit.style.display='none'),this.captureFrameCount=1,new Rt(o,{text:'Frames:',style:'margin-left: 10px; margin-right: 5px; vertical-align: middle; color: #bbb;'}),new Qt(o,{value:this.captureFrameCount,min:1,step:1,precision:0,style:'display: inline-block; width: 100px; margin-right: 10px; vertical-align: middle;',onChange:e=>{s.captureFrameCount=Math.max(e,1)}}),this.maxBufferSize=1048576,new Rt(o,{text:'Max Buffer Size (Bytes):',style:'margin-left: 10px; margin-right: 5px; vertical-align: middle; color: #bbb;'}),new Qt(o,{value:this.maxBufferSize,min:1,step:1,precision:0,style:'display: inline-block; width: 100px; margin-right: 10px; vertical-align: middle;',onChange:e=>{s.maxBufferSize=Math.max(e,1)}}),new Rt(o,{style:''}),this._captureFrame=new Rt(o,{style:'margin-left: 20px; margin-right: 10px; vertical-align: middle;'}),this._captureStats=new Nt(o,{label:'Frame Stats',style:'display: none;'}),this._captureStatus=new Rt(o,{style:'margin-left: 20px; margin-right: 10px; vertical-align: middle;'}),this._capturePanel=new At(n,{style:'overflow: hidden; white-space: nowrap; height: calc(-85px + 100vh); display: flex;'}),e.onTextureLoaded.addListener(this._textureLoaded,this),e.onTextureDataChunkLoaded.addListener(this._textureDataChunkLoaded,this),this._frameImageList=[],this._lastSelectedCommand=null,this._gpuTextureMap=new Map,this._passEncoderCommands=new Map,i.addListener((e=>{if(s._captureData)switch(e.action){case t.CaptureTextureFrames:s._captureData.captureTextureFrames(e),s._updateCaptureStatus();break;case t.CaptureFrameResults:s._captureData.captureFrameResults(e);break;case t.CaptureFrameCommands:s._captureData.captureFrameCommands(e);break;case t.CaptureBuffers:s._captureData.captureBuffers(e),s._updateCaptureStatus();break;case t.CaptureBufferData:s._captureData.captureBufferData(e)}}))}_clampedTextureWidth(e){return Math.max(Math.min(Math.max(e.width,e.height),256),64)}_getObject(e){return this.database.getObject(e)}_updateCaptureStatus(){let e=this._captureData?.getCaptureStatus()??'';this._captureStatus.text=e}get database(){return this.window.database}get port(){return this.window.port}get textureUtils(){return this.window.textureUtils}_processCommandArgs(e){if(!e)return e;if(void 0!==e.__id){const t=this._getObject(e.__id);return t?`${t.constructor.className} ID:${e.__id}`:`${e.__class||'Object'}.${e.__id}`}if(e instanceof Array){const t=[];for(const n in e)t[n]=this._processCommandArgs(e[n]);return t}if(e instanceof Object){const t={};for(const n in e)t[n]=this._processCommandArgs(e[n]);return t}return e}_filterCommands(e,t){for(let n=0,s=t.length;n<s;++n){const s=t[n];if(!s)break;const i=s.method,r=s.widget;r&&(i.includes(e)?r.element.style.display='block':r.element.style.display='none')}}_captureObjectsFromArgs(e){if(e instanceof Array||e instanceof Object)for(const t in e){const n=e[t];if(n instanceof Object)if(void 0!==n.__id){const e=this._getObject(n.__id);if(e&&(this.database.capturedObjects.set(n.__id,e),e.incrementReferenceCount(),e instanceof xt)){const t=this.database.getTextureFromView(e);t&&(this.database.capturedObjects.set(t.id,t),t.incrementReferenceCount())}}else this._captureObjectsFromArgs(n)}}_captureFrameResults(e,t){const n=this._capturePanel;this._captureFrame.text=`Frame ${e}`,this._captureStats.style.display='inline-block',n.html='',this._captureTab=new Dt(n,{displayCloseButton:!0,style:'width: 100%;'});const s=new At(null,{style:'overflow: hidden; white-space: nowrap; height: calc(-100px + 100vh); display: flex;'});this._captureTab.addTab(`Frame ${e}`,s),this._captureCommands=t,this.database.clearCapturedObjects(),this._frameImageList.length=0,this._passEncoderCommands.clear(),this._gpuTextureMap.forEach((e=>{e.removeReference()})),this._gpuTextureMap.clear(),this._frameImages=new Rt(s,{class:'capture_frameImages',style:'flex: 0 0 auto;'}),this._frameImages.style.display='none';const i=new Rt(s,{class:'capture_frameContents',style:'flex: 0 0 auto; width: 590px; height: calc(-105px + 100vh);'}),r=new Rt(s,{class:'capture_commandInfo',style:'flex: 1 1 auto; display: flex;'}),o=new At(r,{style:'flex: 1 1 auto;'}),a=this,l=new At(i,{class:'capture_filterArea'});new Rt(l,{text:'Filter: ',style:'margin-right: 5px;'}),this.filterEdit=new Wt(l,{style:'width: 200px;',placeholder:'Filter',onEdit:e=>{a._filterCommands(e,t)}});const c=new At(i,{class:'capture_frame'});this._captureStats.callback=()=>{a._inspectStats(o)};const h=[c],u=[];let d=0,f=new At(c,{class:'capture_commandBlock'});this._lastSelectedCommand=null;const p=this.statistics;p.reset();const m=new Map;let g=0,v=0,x=0,b=0;for(let e=0,n=t.length;e<n;++e){const n=t[e];n.id=e;const s=n.method;if('beginRenderPass'===s)m.set(n.result,-1);else if('beginComputePass'===s)m.set(n.result,-2);else if('end'===s){const e=m.get(n.object);-1===e?m.set(n.object,v++):-2===e&&m.set(n.object,x++)}else if('createRenderBundleEncoder'===s)m.set(n.result,-3);else if('finish'===s){-3===m.get(n.object)&&m.set(n.object,b++)}}let y=!0;for(let e=0,n=t.length;e<n;++e){const n=t[e];if(!n)break;const s=n.method,i=n.args;if(this._captureObjectsFromArgs(i),p.updateStats(this.database,n),'pushDebugGroup'===s){let n=e+1,s=t[n],i=!1,r=1;for(;s;){const e=s.method;if('pushDebugGroup'===e)r++;else{if('popDebugGroup'!==e){i=!0;break}if(r--,0===r)break}n++,s=t[n]}if(!i){e=n;continue}}let r=h[h.length-1];if('beginRenderPass'===s){const e=m.get(n.result);this._passEncoderCommands.set(n.result,[n]),n._passIndex=e,f.children.length||f.remove(),f=new At(r,{class:'capture_renderpass'});const t=new At(f,{id:`RenderPass_${e}`,class:'capture_renderpass_header'}),s=new Rt(t,{text:'-',style:'margin-right: 10px; font-size: 12pt;'});let o=`Render Pass ${e}`;void 0!==n.duration&&(o+=` Duration:${n.duration}ms`),n.header=new Rt(t,{text:o});const a=new Rt(t,{style:'margin-left: 10px;'}),l=new At(f,{class:'capture_renderpass_block'});t.element.onclick=()=>{l.element.classList.toggle('collapsed'),l.element.classList.contains('collapsed')?(s.text='+',a.text='...'):(s.text='-',a.text='')},f=l,f._passIndex=e;for(const e of i[0]?.colorAttachments){const t=this._getTextureViewFromAttachment(e);t&&this.database.getTextureFromView(t)}if(i[0]?.depthStencilAttachment){const e=this._getTextureViewFromAttachment(i[0]?.depthStencilAttachment);e&&this.database.getTextureFromView(e)}}else if('beginComputePass'===s){const e=m.get(n.result);this._passEncoderCommands.set(n.result,[n]),this._renderBundleCommands=null,n._passIndex=e,f.children.length||f.remove(),f=new At(r,{class:'capture_computepass'});const t=new At(f,{id:`ComputePass_${e}`,class:'capture_computepass_header'}),s=new Rt(t,{text:'-',style:'margin-right: 10px; font-size: 12pt;'});n.header=new Rt(t,{text:`Compute Pass ${e}`});const i=new Rt(t,{style:'margin-left: 10px;'}),o=new At(f);t.element.onclick=()=>{o.element.classList.toggle('collapsed'),o.element.classList.contains('collapsed')?(s.text='+',i.text='...'):(s.text='-',i.text='')},f=o,f._passIndex=e}else if('popDebugGroup'===s)h.pop(),r=h[h.length-1],f.children.length||f.remove(),f=new At(r,{class:'capture_commandBlock'});else if('createRenderBundleEncoder'===s){const e=n.result.__id??m.get(n.result);this._passEncoderCommands.set(n.result,[n]),n._passIndex=e,f.children.length||f.remove(),f=new At(r,{class:'capture_renderbundle'});const t=new At(f,{id:`RenderBundle_${e}`,class:'capture_renderbundle_header'}),s=new Rt(t,{text:'-',style:'margin-right: 10px; font-size: 12pt;'});n.header=new Rt(t,{text:`Render Bundle ${e}`});const i=new Rt(t,{style:'margin-left: 10px;'}),o=new At(f);t.element.onclick=()=>{o.element.classList.toggle('collapsed'),o.element.classList.contains('collapsed')?(s.text='+',i.text='...'):(s.text='-',i.text='')},f=o,f._passIndex=e,f._object=n.result}else if('popDebugGroup'===s)h.pop(),r=h[h.length-1],f.children.length||f.remove(),f=new At(r,{class:'capture_commandBlock'});else if('pushDebugGroup'!==s){const e=n.object,t=this._passEncoderCommands.get(e);if(t&&t.push(n),m.has(e)){const t=m.get(e);if(f._passIndex!==t){f.children.length||f.remove(),f=new At(r,{class:'capture_renderpass',style:'margin-top: 5px;'});const e=new At(f,{id:`RenderPass_${t}`,class:'capture_renderpass_header',style:'display: none;'}),n=new Rt(e,{text:'-',style:'margin-right: 10px; font-size: 12pt;'});new Rt(e,{text:`Render Pass ${t}`});const s=new Rt(e,{style:'margin-left: 10px;'}),i=new At(f,{class:'capture_renderpass_block'});e.element.onclick=()=>{i.element.classList.toggle('collapsed'),i.element.classList.contains('collapsed')?(n.text='+',s.text='...'):(n.text='-',s.text='')},f=i,f._passIndex=t}}}const a=['capture_command'];'draw'!==s&&'drawIndexed'!==s&&'drawIndirect'!==s&&'drawIndexedIndirect'!==s&&'dispatchWorkgroups'!==s&&'dispatchWorkgroupsIndirect'!=s||a.push('capture_drawcall');if(!('pushDebugGroup'===s||'popDebugGroup'===s)){const t=this._createCommandWidget(f,e,n,a,o,u);y&&(t.element.click(),y=!1)}if('pushDebugGroup'===s){const e=[['capture_debugGroup_header1','capture_debugGroup1'],['capture_debugGroup_header2','capture_debugGroup2'],['capture_debugGroup_header3','capture_debugGroup3'],['capture_debugGroup_header4','capture_debugGroup4'],['capture_debugGroup_header5','capture_debugGroup5']][g%5],t=['capture_debugGroup',e[1]],n=['capture_debugGroup_header',e[0]],s=new At(r,{id:`DebugGroup_${d}`,class:n}),o=new Rt(s,{text:'-',style:'margin-right: 10px; font-size: 12pt;'});new Rt(s,{text:`${i[0]}`});const a=new Rt(s,{style:'margin-left: 10px;'}),l=new At(r,{class:t});g++,h.push(l),d++,r=l,s.element.onclick=()=>{l.element.classList.toggle('collapsed'),l.element.classList.contains('collapsed')?(o.text='+',a.text='...'):(o.text='-',a.text='')},f.children.length||f.remove(),f=new At(r,{class:'capture_commandBlock'})}'popDebugGroup'==s&&g--,'end'===s&&(f.children.length||f.remove(),f=new At(r,{class:'capture_commandBlock'})),'finish'===s&&n.object===f._object&&(f.children.length||f.remove(),f=new At(r,{class:'capture_commandBlock'}))}}_createCommandWidget(e,t,n,s,i,r){const o=n.method,a=n.args,l=new At(e,{id:`CaptureCommand_${t}`,class:s});'end'===o?l.element.id=`Pass_${e._passIndex}_end`:'beginRenderPass'===o&&(l.element.id=`RenderPass_${e._passIndex}_begin`),n.widget=l;let c=null;'executeBundles'===o&&(l.style.paddingLeft='0px',c=new Rt(l,{class:'expand_button',text:'+'}),c.element.onclick=()=>{c.panel&&(c.panel.element.classList.toggle('collapsed'),c.panel.element.classList.contains('collapsed')?c.text='+':c.text='-')}),new Rt(l,{class:'capture_callnum',text:`${t}.`});const h=this;function u(e,t){if(void 0===e)return'';const n=h._getObject(e);return n?`${n.label||n.name}(${n.idName})`:t?`${t}(${e})`:`${e}`}if(new Rt(l,{class:'capture_methodName',text:`${o}`}),'executeBundles'===o){const t=[];for(const e of a[0])t.push(u(e.__id,'GPURenderBundle'));new Rt(l,{class:'capture_method_args',text:`bundles:[${t.join(', ')}]`}),c.panel=new At(e,{class:['collapsed']});let n=0;for(const e of a[0]){const t=h._getObject(e.__id),s=u(e.__id,'GPURenderBundle'),o=new At(c.panel,{class:'capture_renderbundle_header',text:`- ${s}`,style:'margin-left: 20px; margin-bottom: 0px; border-radius: 5px 5px 0px 0px; line-height: 20px;'}),a=new At(c.panel,{class:['render_bundle_group']});if(o.element.onclick=()=>{a.element.classList.toggle('collapsed'),a.element.classList.contains('collapsed')?o.text=`+ ${s}`:o.text=`- ${s}`},t?.commands)for(const e of t?.commands)this._createCommandWidget(a,n++,e,['capture_command'],i,r)}}else'createRenderPipeline'===o?new Rt(l,{class:'capture_method_args',text:`=> ${u(n.result,'GPURenderPipeline')}`}):'createBindGroup'===o?new Rt(l,{class:'capture_method_args',text:`=> ${u(n.result,'GPUBindGroup')}`}):'createBindGroupLayout'===o?new Rt(l,{class:'capture_method_args',text:`=> ${u(n.result,'GPUBindGroupLayout')}`}):'createPipelineLayout'===o?new Rt(l,{class:'capture_method_args',text:`=> ${u(n.result,'GPUPipelineLayout')}`}):'createShaderModule'===o?new Rt(l,{class:'capture_method_args',text:`=> ${u(n.result,'GPUShaderModule')}`}):'createTexture'===o?new Rt(l,{class:'capture_method_args',text:`=> ${u(n.result,'GPUTexture')}`}):'createSampler'===o?new Rt(l,{class:'capture_method_args',text:`=> ${u(n.result,'GPUSampler')}`}):'createCommandEncoder'===o?new Rt(l,{class:'capture_method_args',text:`=> ${u(n.result,'GPUCommandEncoder')}`}):'finish'===o&&new Rt(l,{class:'capture_method_args',text:`${u(n.object,n.class)} => ${u(n.result,'GPUCommandBuffer')}`});if('getMappedRange'===o)new Rt(l,{class:'capture_method_args',text:u(n.object)});else if('unmap'===o)new Rt(l,{class:'capture_method_args',text:u(n.object)});else if('copyBufferToBuffer'===o)new Rt(l,{class:'capture_method_args',text:`src:${u(a[0]?.__id)} srcOffset:${a[1]} dest:${u(a[2]?.__id)} destOffset:${a[3]} size:${a[4]}`});else if('clearBuffer'===o)new Rt(l,{class:'capture_method_args',text:`src:${u(a[0]?.__id)} offset:${a[1]} size:${a[4]}`});else if('copyBufferToTexture'===o)new Rt(l,{class:'capture_method_args',text:`buffer:${u(a[0]?.buffer?.__id)} texture:${u(a[1]?.texture?.__id)}`});else if('copyTextureToBuffer'===o)new Rt(l,{class:'capture_method_args',text:`texture:${u(a[0]?.texture?.__id)} buffer:${u(a[1]?.buffer?.__id)}`});else if('copyTextureToTexture'===o)new Rt(l,{class:'capture_method_args',text:`src:${u(a[0]?.texture.__id)} dest:${u(a[1]?.texture.__id)}`});else if('setViewport'===o)new Rt(l,{class:'capture_method_args',text:`x:${a[0]} y:${a[1]} w:${a[2]} h:${a[3]} minZ:${a[4]} maxZ:${a[5]}`});else if('setScissorRect'===o)new Rt(l,{class:'capture_method_args',text:`x:${a[0]} y:${a[1]} w:${a[2]} h:${a[3]}`});else if('setStencilReference'===o)new Rt(l,{class:'capture_method_args',text:`reference:${a[0]}`});else if('setBindGroup'===o){new Rt(l,{class:'capture_method_args',text:`index:${a[0]} bindGroup:${u(a[1]?.__id)}`});const e=this._getObject(a[1]?.__id);if(e)for(const t of e.descriptor.entries)if(t.resource?.__id){const e=this._getObject(t.resource.__id);e instanceof xt&&this._getObject(e.texture?.id??e.texture)}else t.resource?.buffer?.__id&&this._getObject(t.resource.buffer.__id)}else if('writeBuffer'===o){const e=a[2];if(e.constructor===String){const t=e.split(' ')[2];new Rt(l,{class:'capture_method_args',text:`buffer:${u(a[0]?.__id)} offset:${a[1]} data:${t} Bytes`})}else new Rt(l,{class:'capture_method_args',text:`buffer:${u(a[0]?.__id)} offset:${a[1]} data:${a[2]?.length} Bytes`})}else if('setPipeline'===o)new Rt(l,{class:'capture_method_args',text:`renderPipeline:${u(a[0]?.__id)}`});else if('setVertexBuffer'===o)new Rt(l,{class:'capture_method_args',text:`slot:${a[0]} buffer:${u(a[1]?.__id)} offset:${a[2]??0}`});else if('setIndexBuffer'===o)new Rt(l,{class:'capture_method_args',text:`buffer:${u(a[0]?.__id)} indexFormat:${a[1]} offset:${a[2]??0}`});else if('drawIndexed'===o)new Rt(l,{class:'capture_method_args',text:`indexCount:${a[0]} instanceCount:${a[1]??1} firstIndex:${a[2]??0} baseVertex:${a[3]??0} firstInstance:${a[4]??0}`});else if('draw'===o)new Rt(l,{class:'capture_method_args',text:`vertexCount:${a[0]} instanceCount:${a[1]??1} firstVertex:${a[2]??0} firstInstance:${a[3]??0}`});else if('drawIndirect'===o)new Rt(l,{class:'capture_method_args',text:`indirectBuffer:${u(a[0]?.__id)} offset:${a[1]}`});else if('drawIndexedIndirect'===o)new Rt(l,{class:'capture_method_args',text:`indirectBuffer:${u(a[0]?.__id)} offset:${a[1]}`});else if('dispatchWorkgroups'===o)new Rt(l,{class:'capture_method_args',text:`countX:${a[0]} countY:${a[1]??1} countZ:${a[2]??1}`});else if('dispatchWorkgroupsIndirect'===o)new Rt(l,{class:'capture_method_args',text:`indirectBuffer:${u(a[0]?.__id)} offset:${a[1]}`});else if('pushDebugGroup'===o)r.push(a[0]),new Rt(l,{class:'capture_method_args',text:a[0]});else if('popDebugGroup'===o){const e=r.pop();new Rt(l,{class:'capture_method_args',text:e})}else if('createView'===o)new Rt(l,{class:'capture_method_args',text:`${u(n.object)} => ${u(n.result,'GPUTextureView')}`});else if('beginRenderPass'===o)new Rt(l,{class:'capture_method_args',text:`${u(n.object,n.class)} => ${u(n.result,'GPURenderPassEncoder')}`});else if('beginComputePass'===o)new Rt(l,{class:'capture_method_args',text:`${u(n.object,n.class)} => ${u(n.result,'GPUComputePassEncoder')}`});else if('end'===o)new Rt(l,{class:'capture_method_args',text:`${u(n.object,n.class)}`});else if('createBuffer'===o)new Rt(l,{class:'capture_method_args',text:`size:${a[0]?.size} usage:${a[0]?.usage} mappedAtCreation:${a[0]?.mappedAtCreation??!1} => ${u(n.result,'GPUBuffer')}`});else if('writeTexture'===o)new Rt(l,{class:'capture_method_args',text:`dest:${u(a[0]?.texture.__id)}`});else if('destroy'===o)new Rt(l,{class:'capture_method_args',text:`${u(n.object,n.class)}`});else if('getCurrentTexture'===o)new Rt(l,{class:'capture_method_args',text:`=> ${u(n.result,'GPUTexture')}`});else if('submit'===o){let e='[';for(const t of a[0])'['!==e&&(e+=', '),e+=`${u(t.__id,'GPUCommandBuffer')}`;e+=']',new Rt(l,{class:'capture_method_args',text:`=> ${e}`})}return l.element.onclick=()=>{h._lastSelectedCommand!==l&&(h._lastSelectedCommand&&h._lastSelectedCommand.classList.remove('capture_command_selected'),l.classList.add('capture_command_selected'),h._lastSelectedCommand=l),h._showCaptureCommandInfo(n,'',i)},l}_getTextureViewFromAttachment(e){return e?e.resolveTarget?this._getObject(e.resolveTarget.__id):this._getObject(e.view?.__id):null}_getTextureFromAttachment(e){if(!e)return null;if(e.resolveTarget){if(e.resolveTarget?.__texture?.__id)return this._getObject(e.resolveTarget.__texture.__id)}else if(e.view?.__texture?.__id)return this._getObject(e.view.__texture.__id);const t=this._getTextureViewFromAttachment(e);return t?this.database.getTextureFromView(t):null}_createTextureWidget(e,t,n,s,i){const r=this._gpuTextureMap.get(n)??t.gpuTexture;if('2d'!==t.dimension)return;let o=0,a=0;s&&(t.width>t.height?(o=s,a=Math.round(o*(t.height/t.width))):(a=s,o=Math.round(a*(t.width/t.height))));const l=new At(e),c=t.layerRanges,h=t.depthOrArrayLayers;for(let e=0;e<h;++e){const n=new $t('canvas',new At(l),{style:i});n.element.width=t.width,n.element.height=t.height,o&&(n.element.style.width=`${o}px`,n.element.style.height=`${a}px`);const s=r.object.createView({dimension:'2d',baseArrayLayer:e,layerArrayCount:1});let h=null;c&&(h={exposure:1,channels:0,minRange:c[e].min,maxRange:c[e].max});const u=n.element.getContext('webgpu'),d=navigator.gpu.getPreferredCanvasFormat();u.configure({device:this.window.device,format:navigator.gpu.getPreferredCanvasFormat()});const f=u.getCurrentTexture();this.textureUtils.blitTexture(s,t.format,1,f.createView(),d,h)}return l}_showCaptureCommandInfo_beginRenderPass(e,t){const n=e._passIndex,s=e.args,i=this,r=s[0]?.colorAttachments;for(let e=0,s=r.length;e<s;++e){const s=r[e],o=this._getTextureFromAttachment(s);if(o){const r=o.descriptor.format;if(o.gpuTexture){const s=new Ft(t,{label:`Color Attachment ${e}: Texture:${o.idName} ${r} ${o.resolutionString}`});new Nt(s.body,{label:'Inspect',style:Ob,callback:()=>{i.window.inspectObject(o)}});const a=this._getPassId(n,e);this._createTextureWidget(s.body,o,a,this._clampedTextureWidth(o),'margin-left: 20px; margin-top: 10px;')}else{const n=new Ft(t,{label:`Color Attachment ${e}: ${r} ${o.resolutionString}`});new Nt(n.body,{label:'Inspect',style:Ob,callback:()=>{i.window.inspectObject(o)}}),new $t('pre',n.body,{text:JSON.stringify(s.view.descriptor,void 0,4)});const a=this._processCommandArgs(o.descriptor);a.usage&&(a.usage=Xt(a.usage,GPUTextureUsage)),new $t('pre',n.body,{text:JSON.stringify(a,void 0,4)})}}}const o=s[0]?.depthStencilAttachment;if(o){const e=this._getTextureFromAttachment(o);if(e)if(e.gpuTexture){const n=e.descriptor.format,s=new Ft(t,{label:`Depth-Stencil Attachment ${n} ${e.resolutionString}`});new Nt(s.body,{label:'Inspect',style:Ob,callback:()=>{i.window.inspectObject(e)}}),this._createTextureWidget(s.body,e,-1,this._clampedTextureWidth(e),'margin-left: 20px; margin-top: 10px;')}else{const n=new Ft(t,{label:`Depth-Stencil Attachment: ${e?.format??'<unknown format>'} ${e.resolutionString}`});new Nt(n.body,{label:'Inspect',style:Ob,callback:()=>{i.window.inspectObject(e)}}),new $t('pre',n.body,{text:JSON.stringify(o.view.descriptor,void 0,4)});const s=this._processCommandArgs(e.descriptor);s.usage&&(s.usage=Xt(s.usage,GPUTextureUsage)),new $t('pre',n.body,{text:JSON.stringify(s,void 0,4)})}}}_showBufferDataType(e,t,n,s=0,i=10){if(!t)return;function r(e,t){return 16===t?`0x${e.toString(16)}`:2===t?`0b${e.toString(2)}`:8===t?`0o${e.toString(8)}`:`${e}`}i=t.radix||i;const o=this._getTypeName(t);if('uint8x2'===o){const a=new Uint8Array(n.buffer,s,2);new $t('li',e,{text:`${r(a[0],i)}, ${r(a[1],i)}`})}else if('uint8x4'===o){const l=new Uint8Array(n.buffer,s,4);new $t('li',e,{text:`${r(l[0],i)}, ${r(l[1],i)}, ${r(l[2],i)}, ${r(l[3],i)}`})}else if('sint8x2'===o){const c=new Int8Array(n.buffer,s,2);new $t('li',e,{text:`${r(c[0],i)}, ${r(c[1],i)}`})}else if('sint8x4'===o){const h=new Int8Array(n.buffer,s,4);new $t('li',e,{text:`${r(h[0],i)}, ${r(h[1],i)}, ${r(h[2],i)}, ${r(h[3],i)}`})}else if('unorm8x2'===o){const u=new Uint8Array(n.buffer,s,2);new $t('li',e,{text:`${u[0]/255}, ${u[1]/255}`})}else if('unorm8x4'===o){const d=new Uint8Array(n.buffer,s,4);new $t('li',e,{text:`${d[0]/255}, ${d[1]/255}, ${d[2]/255}, ${d[3]/255}`})}else if('snorm8x2'===o){const f=new Int8Array(n.buffer,s,2);new $t('li',e,{text:`${f[0]/128}, ${f[1]/128}`})}else if('snorm8x4'===o){const p=new Int8Array(n.buffer,s,4);new $t('li',e,{text:`${p[0]/128}, ${p[1]/128}, ${p[2]/128}, ${p[3]/128}`})}else if('uint16x2'===o){const m=new Uint16Array(n.buffer,s,2);new $t('li',e,{text:`${r(m[0],i)}, ${r(m[1],i)}`})}else if('uint16x4'===o){const g=new Uint16Array(n.buffer,s,4);new $t('li',e,{text:`${r(g[0],i)}, ${r(g[1],i)}, ${r(g[2],i)}, ${r(g[3],i)}`})}else if('sint16x2'===o){const v=new Int16Array(n.buffer,s,2);new $t('li',e,{text:`${r(v[0],i)}, ${r(v[1],i)}`})}else if('sint16x4'===o){const x=new Int16Array(n.buffer,s,4);new $t('li',e,{text:`${r(x[0],i)}, ${r(x[1],i)}, ${r(x[2],i)}, ${r(x[3],i)}`})}else if('unorm16x2'===o){const b=new Uint16Array(n.buffer,s,2);new $t('li',e,{text:`${b[0]/65535}, ${b[1]/65535}`})}else if('unorm16x4'===o){const y=new Uint16Array(n.buffer,s,4);new $t('li',e,{text:`${y[0]/65535}, ${y[1]/65535}, ${y[2]/65535}, ${y[3]/65535}`})}else if('snorm16x2'===o){const _=new Int16Array(n.buffer,s,2);new $t('li',e,{text:`${_[0]/32767}, ${_[1]/32767}`})}else if('snorm16x4'===o){const w=new Int16Array(n.buffer,s,4);new $t('li',e,{text:`${w[0]/32767}, ${w[1]/32767}, ${w[2]/32767}, ${w[3]/32767}`})}else if('float16x2'===o);else if('float16x4'===o);else if('unorm10-10-10-2'===o);else if('f32'===o||'float32'===o){const k=new Float32Array(n.buffer,s,1);new $t('li',e,{text:`${r(k[0],i)}`})}else if('i32'===o||'sint32'===o){const O=new Int32Array(n.buffer,s,1);new $t('li',e,{text:`${r(O[0],i)}`})}else if('u32'===o||'uint32'===o){const S=new Uint32Array(n.buffer,s,1);new $t('li',e,{text:`${r(S[0],i)}`})}else if('bool'===o){const T=new Uint32Array(n.buffer,s,1);new $t('li',e,{text:''+(T[0]?'true':'false')})}else if('vec2i'===o||'vec2<i32>'===o||'sint32x2'===o){const I=new Int32Array(n.buffer,s,2);new $t('li',e,{text:`${r(I[0],i)}, ${r(I[1],i)}`})}else if('vec2u'===o||'vec2<u32>'===o||'uint32x2'===o){const C=new Uint32Array(n.buffer,s,2);new $t('li',e,{text:`${r(C[0],i)}, ${r(C[1],i)}`})}else if('vec2f'===o||'vec2<f32>'===o||'float32x2'===o){const $=new Float32Array(n.buffer,s,2);new $t('li',e,{text:`${r($[0],i)},${r($[1],i)}`})}else if('vec3i'===o||'vec3<i32>'===o||'sint32x3'===o){const A=new Int32Array(n.buffer,s,3);new $t('li',e,{text:`${r(A[0],i)}, ${r(A[1],i)}, ${r(A[2],i)}`})}else if('vec3u'===o||'vec3<u32>'===o||'uint32x3'===o){const E=new Uint32Array(n.buffer,s,3);new $t('li',e,{text:`${r(E[0],i)}, ${r(E[1],i)}, ${r(E[2],i)}`})}else if('vec3f'===o||'vec3<f32>'===o||'float32x3'===o){const P=new Float32Array(n.buffer,s,3);new $t('li',e,{text:`${r(P[0],i)}, ${r(P[1],i)}, ${r(P[2],i)}`})}else if('vec4i'===o||'vec4<i32>'===o||'sint32x4'===o){const D=new Int32Array(n.buffer,s,4);new $t('li',e,{text:`${r(D[0],i)}, ${r(D[1],i)}, ${r(D[2],i)}, ${r(D[3],i)}`})}else if('vec4u'===o||'vec4<u32>'===o||'uint32x4'===o){const M=new Uint32Array(n.buffer,s,4);new $t('li',e,{text:`${r(M[0],i)}, ${r(M[1],i)}, ${r(M[2],i)}, ${r(M[3],i)}`})}else if('vec4f'===o||'vec4<f32>'===o||'float32x4'===o){const L=new Float32Array(n.buffer,s,4);new $t('li',e,{text:`${r(L[0],i)}, ${r(L[1],i)}, ${r(L[2],i)}, ${r(L[3],i)}`})}else if(Sb.matrixTypes[t.name]){const B=Sb.matrixTypes[t.name],N=B.rows,R=B.columns,F=new Float32Array(n.buffer,s,N*R);for(let V=0,z=0;V<N;++V){let U='';for(let W=0;W<R;++W,++z)U+=`${0==W?'':' '}${F[z]}`;new $t('li',e,{text:U})}}else if(t.members){const Q=new $t('ul',e);for(const j of t.members){const X=this._getTypeName(j.type);new $t('li',Q,{text:`${j.name}: ${X}`});const G=new $t('ul',Q);this._showBufferDataType(G,j.type,n,s+j.offset,i)}}else if('array'===t.name){let q=t.count??0;0===q&&(q=Math.floor((n.length-s)/(t.stride||t.format.size)));const H=new At(e,{class:'capture_array_view'});let Y=null;q>100&&(Y=new At(H,{class:'capture_array_view_filter'}));const K=new $t('ul',H);if(q){let Z=0,J=100;const ee=this;function te(e,o,a){let l=t.stride,c=s+o*l,h=Math.min(q-o,a),u=t.format;const d=ee._getTypeName(u);for(let t=0;t<h;++t){let s=null;if('f32'===d||'atomic<f32>'===d){s=r(new Float32Array(n.buffer,c,1)[0],i)}else if('i32'===d||'atomic<i32>'===d){s=r(new Int32Array(n.buffer,c,1)[0],i)}else if('u32'===d||'atomic<u32>'===d){s=r(new Uint32Array(n.buffer,c,1)[0],i)}else if('bool'===d||'atomic<bool>'===d){s=new Uint32Array(n.buffer,c,1)[0]?'true':'false'}else if('vec2i'===d||'vec2<i32>'===d){const e=new Int32Array(n.buffer,c,2);s=`${r(e[0],i)}, ${e[1]}`}else if('vec2u'===d||'vec2<u32>'===d){const e=new Uint32Array(n.buffer,c,2);s=`${r(e[0],i)}, ${r(e[1],i)}`}else if('vec2f'===d||'vec2<f32>'===d){const e=new Float32Array(n.buffer,c,2);s=`${r(e[0],i)}, ${r(e[1],i)}`}else if('vec3i'===d||'vec3<i32>'===d){const e=new Int32Array(n.buffer,c,3);s=`${e[0]}, ${r(e[1],i)}, ${r(e[2],i)}`}else if('vec3u'===d||'vec3<u32>'===d){const e=new Uint32Array(n.buffer,c,3);s=`${r(e[0],i)}, ${r(e[1],i)}, ${r(e[2],i)}`}else if('vec3f'===d||'vec3<f32>'===d){const e=new Float32Array(n.buffer,c,3);s=`${r(e[0],i)}, ${r(e[1],i)}, ${r(e[2],i)}`}else if('vec4i'===d||'vec4<i32>'===d){const e=new Int32Array(n.buffer,c,4);s=`${r(e[0],i)}, ${r(e[1],i)}, ${r(e[2],i)}, ${r(e[3],i)}`}else if('vec4u'===d||'vec4<u32>'===d){const e=new Uint32Array(n.buffer,c,4);s=`${e[0]}, ${r(e[1],i)}, ${r(e[2],i)}, ${r(e[3],i)}`}else if('vec4f'===d||'vec4<f32>'===d){const e=new Float32Array(n.buffer,c,4);s=`${r(e[0],i)}, ${r(e[1],i)}, ${r(e[2],i)}, ${r(e[3],i)}`}if(u.isStruct&&1===u.members?.length){const e=u.members[0];if(e.isArray){const t=e.format,o=ee._getTypeName(t);if('u32'===o||'atomic<u32>'===o){if(1===e.count){s=`${r(new Uint32Array(n.buffer,c,1)[0],i)}`}else if(2===e.count){const e=new Uint32Array(n.buffer,c,2);s=`${r(e[0],i)}, ${r(e[1],i)}`}else if(3===e.count){const e=new Uint32Array(n.buffer,c,3);s=`${r(e[0],i)}, ${r(e[1],i)}, ${r(e[2],i)}`}else if(4===e.count){const e=new Uint32Array(n.buffer,c,4);s=`${r(e[0],i)}, ${r(e[1],i)}, ${r(e[2],i)}, ${r(e[3],i)}`}}else if('i32'===o||'atomic<i32>'===o){if(1===e.count){s=`${r(new Int32Array(n.buffer,c,1)[0],i)}`}else if(2===e.count){const e=new Int32Array(n.buffer,c,2);s=`${r(e[0],i)}, ${r(e[1],i)}`}else if(3===e.count){const e=new Int32Array(n.buffer,c,3);s=`${r(e[0],i)}, ${r(e[1],i)}, ${r(e[2],i)}`}else if(4===e.count){const e=new Int32Array(n.buffer,c,4);s=`${r(e[0],i)}, ${r(e[1],i)}, ${r(e[2],i)}, ${r(e[3],i)}`}}else if('f32'===o||'atomic<f32>'===o)if(1===e.count){s=`${r(new Float32Array(n.buffer,c,1)[0],i)}`}else if(2===e.count){const e=new Float32Array(n.buffer,c,2);s=`${r(e[0],i)}, ${r(e[1],i)}`}else if(3===e.count){const e=new Float32Array(n.buffer,c,3);s=`${e[0]}, ${r(e[1],i)}, ${r(e[2],i)}`}else if(4===e.count){const e=new Float32Array(n.buffer,c,4);s=`${r(e[0],i)}, ${r(e[1],i)}, ${r(e[2],i)}, ${r(e[3],i)}`}}}if(null!==s)new $t('li',e,{text:`[${t+o}]: ${s}`});else{new $t('li',e,{text:`[${t+o}]: ${d}`});const s=new $t('ul',e);ee._showBufferDataType(s,u,n,c)}c+=l}}q>100&&(new Rt(Y,{text:'Offset:'}),new Qt(Y,{value:0,min:0,max:q,precision:0,step:1,tooltip:'Starting element of the array to display',onChange:e=>{try{Z=Math.max(parseInt(e),0)}catch(e){console.log(e.message),Z=0}K.removeAllChildren(),te(K,Z,J)},style:'display: inline-block; width: 75px; margin-right: 10px; vertical-align: middle;'}),new Rt(Y,{text:'Count:'}),new Qt(Y,{value:100,min:1,max:1e3,precision:0,step:1,tooltip:'Number of elements to display',onChange:e=>{try{J=Math.max(parseInt(e),1)}catch(e){console.log(e.message),J=100}K.removeAllChildren(),te(K,Z,J)},style:'display: inline-block; width: 75px; margin-right: 10px; vertical-align: middle;'}),new Rt(Y,{text:`/ ${q}`})),te(K,Z,J)}}}_setBufferFormat(e,t,n,s=!1,i=10){try{let r=new gt(n);if(r){for(const n of r.structs)if(n.name===t)return e.replacement=n,void(e.replacement.radix=i);if(r.structs.length>0)return e.replacement=r.structs[r.structs.length-1],void(e.replacement.radix=i)}if(!s){const t=`_${e.name}`,s=`struct _${e.name} { _: ${n} }`;this._setBufferFormat(e,t,s,!0,i)}}catch(e){}}_createFormatButton(e,t,n,s){function i(e){return e.type.replacement||e.type}new Nt(e,{label:'Format',callback:()=>{const e=new Vt({title:'Buffer Format',width:300,draggable:!0}),r=Kt(i(t)),o=new jt(e.body,{value:r,style:'width: 100%; height: 200px;'}),a=new At(e.body,{style:'padding-left: 10px; margin-top: 4px;'});new Rt(a,{text:'Radix:',style:'margin-right: 5px;'});const l=[10,16,8,2];let c=i(t)?.radix||10;new Gt(a,{options:['Decimal','Hexadecimal','Octal','Binary'],value:16===c?'Hexadecimal':8===c?'Octal':2===c?'Binary':'Decimal',onChange:(e,t)=>{c=l[t]}});const h=new At(e.body,{style:'width: 100%; margin-top: 20px;'}),u=this;new Nt(h,{label:'Apply',style:'margin-left: 15px; auto;',callback:()=>{e.close();const r=i(t);u._setBufferFormat(t.type,r.name,o.value,!1,c),n.html='';const a=i(t);u._showBufferDataType(n,a,s)}}),new Nt(h,{label:'Revert',style:'margin-left: 15px; auto;',callback:()=>{t.type.replacement=null,e.close(),n.html='',u._showBufferDataType(n,t.type,s)}}),new Nt(h,{label:'Cancel',style:'margin-left: 15px; auto;',callback:()=>{e.close()}})}})}_showBufferDataInfo(e,t,n){function s(e){return e.type.replacement||e.type}if(t.resourceType===S.Uniform){const i=this._getTypeName(t.type);new At(e,{text:`UNIFORM: ${t.name}: ${i}`});const r=new At(null);this._createFormatButton(e,t,r,n),r.parent=e,this._showBufferDataType(r,s(t),n)}else if(t.resourceType===S.Storage){const i=this._getTypeName(t.type);new At(e,{text:`STORAGE ${t.access}: ${t.name}: ${i}`});const r=new At(null);this._createFormatButton(e,t,r,n),r.parent=e,this._showBufferDataType(r,s(t),n)}}_findBindingResourceFromState(e,t,n){if(!e)return null;const s=e.pipeline?.args[0]?.__id,i=this._getObject(s);if(i){const e=i.descriptor,s=e.vertex?.module?.__id,r=e.fragment?.module?.__id,o=e.compute?.module?.__id;if(o){const e=this._getObject(o);if(e?.reflection){const s=e.reflection.findResource(t,n);if(s)return s}}else if(void 0!==s&&s===r){const e=this._getObject(s);if(e?.reflection){const s=e.reflection.findResource(t,n);if(s)return s}}else{const e=this._getObject(s);if(e?.reflection){const s=e.reflection.findResource(t,n);if(s)return s}const i=this._getObject(r);if(i?.reflection){const e=i.reflection.findResource(t,n);if(e)return e}}}return null}_showBufferData(e,t,n,s,i,r){new At(e,{text:`Group ${t} Binding ${n} Size: ${r.length}`});const o=this._findBindingResourceFromState(i,t,n);o&&this._showBufferDataInfo(e,o,r)}_showCaptureCommandInfo_setBindGroup(e,t,n,s,i,r){const o=e.args,a=o[1]?.__id,l=this._getObject(a);if(!l)return;const c=this,h=o[0],u=new Ft(t,{collapsed:!0,label:`BindGroup ${n??''} ID:${a}`});new Nt(u.body,{label:'Inspect',style:Ob,callback:()=>{c.window.inspectObject(l)}});const d=l.descriptor,f=this._processCommandArgs(d),p=JSON.stringify(f,void 0,4);function m(e){if(void 0!==e.__id){const t=c._getObject(e.__id);if(t)return t.constructor.className}return e.buffer?'Buffer':e.__class?e.__class:'<unknown resource type>'}function g(e){return void 0!==e.__id?e.__id:void 0!==e.buffer?.__id?e.buffer.__id:0}function v(e){if(e.buffer){const t=c._getObject(e.buffer.__id);if(t){return t.descriptor.usage&GPUBufferUsage.UNIFORM?'Uniform':t.descriptor.usage&GPUBufferUsage.STORAGE?'Storage':''}}return''}function x(e,t,n){if(e){const s=e.pipeline?.args[0]?.__id,i=c._getObject(s);if(i){const e=i.descriptor,s=e.vertex?.module?.__id,r=e.fragment?.module?.__id,o=e.compute?.module?.__id;if(o){const e=c._getObject(o);if(e){const s=e.reflection;if(s)for(const e of s.storage)if(e.group==t&&e.binding==n)return e.access}}else if(void 0!==s&&s===r){const e=c._getObject(s);if(e){const s=e.reflection;if(s)for(const e of s.storage)if(e.group==t&&e.binding==n)return e.access}}else{const e=c._getObject(s);if(e){const s=e.reflection;if(s)for(const e of s.storage)if(e.group==t&&e.binding==n)return e.access}const i=c._getObject(r);if(i){const e=i.reflection;if(e)for(const s of e.storage)if(s.group==t&&s.binding==n)return s.access}}}}return''}if(new $t('pre',u.body,{text:p}),!s){const e=[];if(l?.entries)for(const t of l.entries)if(t.resource?.__id){const n=this._getObject(t.resource.__id);if(n instanceof xt){const s=t.binding;e.push({textureView:n,group:h,binding:s})}}if(e.length){const n=new Ft(t,{collapsed:!0,label:'Input Textures'});for(const t of e){const e=this.database.getTextureFromView(t.textureView);if(e)if(new Nt(n.body,{label:'Inspect',style:Ob,callback:()=>{c.window.inspectObject(e)}}),e.gpuTexture){const s=new At(n.body);new At(s,{text:`Group: ${t.group} Binding: ${t.binding} Texture: ${e.idName} ${e.format} ${e.resolutionString}`}),this._createTextureWidget(s,e,-1,this._clampedTextureWidth(e),'margin-left: 20px; margin-top: 10px;')}else this.database.requestTextureData(e)}}}const y=i?.bindGroups[n];for(const s in d.entries){const o=d.entries[s],a=o.binding,h=o.resource,u=void 0!==n?`Group ${n} `:'';let f=x(i,n,a),p=null;if(h.buffer&&y?.isBufferDataLoaded&&y.isBufferDataLoaded[s]){const e=y.bufferData[s];e&&(p=e.length)}let _=`${u}Binding ${a}: ${m(h)} ID:${g(h)} ${v(h)}`;if(f&&(_+=` ${f}`),p&&(_+=` Size: ${p}`),h.buffer){const e=this._findBindingResourceFromState(i,n,s);if(e){const t=this._getTypeName(e.type);t&&(_+=` Type: ${t}`)}}const w=new Ft(t,{collapsed:!0,label:_});if(void 0!==h.__id){const e=this._getObject(h.__id);if(e)if(new Nt(w.body,{label:'Inspect',style:Ob,callback:()=>{c.window.inspectObject(e)}}),e instanceof b)new At(w.body,{text:`${h.__class} ID:${h.__id}`}),new $t('pre',w.body,{text:JSON.stringify(e.descriptor,void 0,4)});else if(e instanceof xt){const t=this._getObject(e.texture);if(new At(w.body,{text:`${h.__class} ID:${h.__id}`}),new $t('pre',w.body,{text:JSON.stringify(e.descriptor,void 0,4)}),t){new At(w.body,{text:`GPUTexture ID:${t.idName}`});const e=this._processCommandArgs(t.descriptor);if(e.usage&&(e.usage=Xt(e.usage,GPUTextureUsage)),new $t('pre',w.body,{text:JSON.stringify(e,void 0,4)}),t.gpuTexture){const e=Math.max(Math.min(t.width,t.height,256),64);this._createTextureWidget(w.body,t,-1,e,'margin-left: 20px; margin-top: 10px; margin-bottom: 10px;')}}}else new At(w.body,{text:`${h.__class} ID:${h.__id}`}),new $t('pre',w.body,{text:JSON.stringify(e.descriptor,void 0,4)});else new At(w.body,{text:`${h.__class} ID:${h.__id}`})}else if(h.buffer){const t=h.buffer.__id,o=this._getObject(t);if(o){new Nt(w.body,{label:'Inspect',style:Ob,callback:()=>{c.window.inspectObject(o)}});const e=o.descriptor,t=this._processCommandArgs(e);t.usage&&(t.usage=Xt(t.usage,GPUBufferUsage)),new $t('pre',w.body,{text:JSON.stringify(t,void 0,4)})}else new At(w.body,{text:`Buffer ID:${t}`});const u=[];let d=this._captureCommands.indexOf(e);if(-1!==d){for(d--;d>=0;--d){const e=this._captureCommands[d];if('writeBuffer'===e.method)e.args[0]?.__id===t&&u.push(e);else if('createBuffer'===e.method)e.result.__id===t&&u.push(e);else if('dispatchWorkgroups'===e.method||'dispatchWorkgroupsIndirect'===e.method){const n=this._getPipelineState(e,r);if(n)for(const s of n.bindGroups){const i=s.args[0],r=this.database.getObject(s.args[1]?.__id);if(r){const s=r.descriptor;for(const r of s.entries)if(r.resource?.buffer?.__id===t){const t=x(n,i,r.binding);'write'!==t&&'read_write'!==t||u.push(e);break}}}}}if(u.length){new At(w.body,{text:'Affected by:'});const e=new $t('ul',w.body,{style:'max-height:150px; overflow:auto; scrollbar-width:thin;'});for(const t of u){new $t('li',e,{text:`${t.id}: ${t.method}`}).element.onclick=()=>{t.widget.element.click()}}}}if(y?.isBufferDataLoaded&&y.isBufferDataLoaded[s]){const e=y.bufferData[s];e&&this._showBufferData(w.body,n,a,l,i,e)}}else new $t('pre',w.body,{text:JSON.stringify(h,void 0,4)})}}_showCaptureCommandInfo_setPipeline(e,t,n){const s=e.args,i=this,r=s[0]?.__id,o=this._getObject(r);if(o){const s=new Ft(t,{collapsed:!0,label:`Pipeline ID:${r}`});new Nt(s.body,{label:'Inspect',style:Ob,callback:()=>{i.window.inspectObject(o)}});const a=o.descriptor,l=this._processCommandArgs(a),c=JSON.stringify(l,void 0,4);new $t('pre',s.body,{text:c});const h=a.vertex?.module?.__id,u=a.fragment?.module?.__id;if(void 0!==h&&h===u){const e=this._getObject(h);if(e){const n=a.vertex?.entryPoint??'@vertex',s=a.fragment?.entryPoint??'@fragment',r=new Ft(t,{collapsed:!0,label:`Module ID:${h} Vertex: ${n} Fragment: ${s}`});new Nt(r.body,{label:'Inspect',style:Ob,callback:()=>{i.window.inspectObject(e)}});const o=e.descriptor.code;new $t('pre',r.body,{text:o}),this._shaderInfo('Vertex+Fragment',e,t)}}else{if(void 0!==h){const e=this._getObject(h);if(e){const n=a.vertex?.entryPoint??'@vertex',s=new Ft(t,{collapsed:!0,label:`Vertex Module ID:${h} Entry: ${n}`});new Nt(s.body,{label:'Inspect',style:Ob,callback:()=>{i.window.inspectObject(e)}});const r=e.descriptor.code;new $t('pre',s.body,{text:r}),this._shaderInfo('Vertex',e,t)}}if(void 0!==u){const e=this._getObject(u);if(e){const n=a.fragment?.entryPoint??'@fragment',s=new Ft(t,{collapsed:!0,label:`Fragment Module ID:${u} Entry: ${n}`});new Nt(s.body,{label:'Inspect',style:Ob,callback:()=>{i.window.inspectObject(e)}});const r=e.descriptor.code;new $t('pre',s.body,{text:r}),this._shaderInfo('Fragment',e,t)}}}const d=a.compute?.module?.__id;if(void 0!==d){const s=this._getObject(d);if(s){const r=a.compute?.entryPoint??'@compute',o=new Ft(t,{collapsed:!0,label:`Compute Module ID:${d} Entry: ${r}`});new Nt(o.body,{label:'Inspect',style:Ob,callback:()=>{i.window.inspectObject(s)}}),n&&new Nt(o.body,{text:'Debug',title:'Debug Shader',style:'background-color: rgb(90, 40, 40);',callback:()=>{i._debugShader(e,r,n)}});const l=s.descriptor.code;new $t('pre',o.body,{text:l}),this._shaderInfo('Compute',s,t)}}}}_debugShader(e,t,n){const s=e.args,i=s[0]?.__id,r=this._getObject(i).descriptor,o=r.compute?.module?.__id,a=new kb(n,t,this._captureData,this.database,this,{style:'overflow: clip;'});this._captureTab.addTab(`Compute Module ID:${o}: ${t}`,a),this._captureTab.setActivePanel(a)}_showCaptureCommandInfo_writeBuffer(e,t){const n=e.args,s=n[0]?.__id,i=this._getObject(s);if(i){const e=new Ft(t,{label:`Buffer ID:${s}`}),n=i.descriptor,r=this._processCommandArgs(n);r.usage&&(r.usage=Xt(r.usage,GPUBufferUsage)),new $t('pre',e.body,{text:JSON.stringify(r,void 0,4)})}}_showCaptureCommandInfo_setIndexBuffer(e,t,n){const s=e.args,i=this,r=s[0]?.__id,o=this._getObject(r);if(o){const a=new Ft(t,{collapsed:n,label:`Index Buffer ID:${r}`});new Nt(a.body,{label:'Inspect',style:Ob,callback:()=>{i.window.inspectObject(o)}});const l=o.descriptor,c=this._processCommandArgs(l);if(c.usage&&(c.usage=Xt(c.usage,GPUBufferUsage)),new $t('pre',a.body,{text:JSON.stringify(c,void 0,4)}),e.isBufferDataLoaded&&e.bufferData){const t=e.bufferData[0];if(t){const e='uint32'===s[1]?new Uint32Array(t.buffer,t.byteOffset,t.byteLength/4):new Uint16Array(t.buffer,t.byteOffset,t.byteLength/2);new At(a.body,{text:`Index Buffer: ${o.name}(${o.id}) Format:${e instanceof Uint32Array?'uint32':'uint16'} Count:${e.length}`});const n=new Nt(a.body,{label:'Show Data',callback:()=>{if('Hide Data'===n.element.innerText)return n.element.innerText='Show Data',void a.body.removeChild(a.body.lastChild);n.element.innerText='Hide Data';const t=new $t('ol',a.body);for(const n of e)new $t('li',t,{text:`${n}`})}})}}}}_showCaptureCommandInfo_setVertexBuffer(e,t,n,s){const i=e.args,r=this,o=i[0],a=i[1]?.__id,l=this._getObject(a);let c=null;const h=this._getObject(s?.pipeline?.args[0]?.__id);if(h){const e=h.descriptor,t=e?.vertex?.module?.__id,n=this._getObject(t),s=n?.reflection;c=s?.entry.vertex[0]?.inputs}if(l){const s=new Ft(t,{collapsed:n,label:`Vertex Buffer ${o} ID:${a}`});new Nt(s.body,{label:'Inspect',style:Ob,callback:()=>{r.window.inspectObject(l)}});const i=l.descriptor,u=this._processCommandArgs(i);if(u.usage&&(u.usage=Xt(u.usage,GPUBufferUsage)),new $t('pre',s.body,{text:JSON.stringify(u,void 0,4)}),e.isBufferDataLoaded&&e.bufferData){const t=e.bufferData[o];if(t){const e=new Nt(s.body,{label:'Show Data',callback:()=>{if('Hide Data'===e.element.innerText)return e.element.innerText='Show Data',void s.body.removeChild(s.body.lastChild);e.element.innerText='Hide Data';let n=0;const i=[],a=h?.descriptor?.vertex?.buffers;if(a){const e=a[o];if(!e)return;n=e.arrayStride;const t=e.attributes;if(t)for(const e of t){const t=e.shaderLocation,n=e.offset,s={name:e.format};let r=t;if(c)for(const e of c)if(e?.location===t&&e.name){r=e.name;break}i.push({name:r,type:s,offset:n})}}const l={name:'array',count:0,stride:n,format:{isStruct:!0,name:'',members:i,stride:n}};r._showBufferDataType(s.body,l,t)}})}}}}_getPipelineState(e){const t=e.object?.commands||(this._passEncoderCommands.get(e.object)??null);if(null===t)return null;const n=t.indexOf(e);if(-1===n)return null;let s=null,i=[],r=null,o=[],a=null,l=null;for(let e=n-1;e>=0;--e){const n=t[e];if('beginRenderPass'===n.method){a=n;break}if('beginComputePass'===n.method){l=n;break}if('setIndexBuffer'!==n.method||r||(r=n),'setVertexBuffer'===n.method){const e=n.args[0];i[e]||(i[e]=n)}if('setPipeline'!==n.method||s||(s=n),'setBindGroup'===n.method){const e=n.args[0];o[e]||(o[e]=n)}}const c=this._getObject(s?.args[0]?.__id),h=c?.descriptor?.vertex?.buffers;if(h)for(let e=0;e<i.length;++e){if(!h[e]){i.length=e;break}}else i.length=0;return{renderPass:a,computePass:l,pipeline:s,vertexBuffers:i,indexBuffer:r,bindGroups:o}}_getTypeName(e){return e?e.format?'array'===e.name&&e.count?`${e.name}<${e.format.name}, ${e.count}>`:`${e.name}<${e.format.name}>`:e.name:''}_addShaderTypeInfo(e,t){if(t)if(t.members){new $t('li',e,{text:'Members:'});const n=new $t('ul',e);for(const e of t.members){new $t('li',n,{text:`${e.name}: ${this._getTypeName(e.type)}`});const t=new $t('ul',n);new $t('li',t,{text:`Offset: ${e.offset}`}),new $t('li',t,{text:`Size: ${e.size||'<runtime>'}`}),this._addShaderTypeInfo(t,e.type.format)}}else'array'===t.name&&this._addShaderTypeInfo(t.format)}_shaderInfoEntryFunction(e,t){if(new $t('li',e,{text:`Entry: ${t.name}`}),t.inputs.length){new $t('li',e,{text:`Inputs: ${t.inputs.length}`});const n=new $t('ul',e);for(const e of t.inputs)new $t('li',n,{text:`@${e.locationType}(${e.location}) ${e.name}: ${this._getTypeName(e.type)} ${e.interpolation||''}`})}if(t.outputs.length){new $t('li',e,{text:`Outputs: ${t.outputs.length}`});const n=new $t('ul',e);for(const e of t.outputs)new $t('li',n,{text:`@${e.locationType}(${e.location}) ${e.name}: ${this._getTypeName(e.type)}`})}}_shaderInfo(e,t,n){const s=t.reflection;if(s){const t=new Ft(n,{collapsed:!0,label:`${e} Shader Info`});if(s.entry.vertex.length){new At(t.body,{text:`Vertex Entry Functions: ${s.entry.vertex.length}`});const e=new $t('ul',t.body);for(const t of s.entry.vertex)this._shaderInfoEntryFunction(e,t)}if(s.entry.fragment.length){new At(t.body,{text:`Fragment Entry Functions: ${s.entry.fragment.length}`});const e=new $t('ul',t.body);for(const t of s.entry.fragment)this._shaderInfoEntryFunction(e,t)}if(s.entry.compute.length){new At(t.body,{text:`Compute Entry Functions: ${s.entry.compute.length}`});const e=new $t('ul',t.body);for(const t of s.entry.compute)this._shaderInfoEntryFunction(e,t)}if(s.uniforms.length){new At(t.body,{text:`Uniform Buffers: ${s.uniforms.length}`});const e=new $t('ul',t.body);for(const t of s.uniforms){new $t('li',e,{text:`${t.name}: ${this._getTypeName(t.type)}`});const n=new $t('ul',e);new $t('li',n,{text:`Bind Group: ${t.group}`}),new $t('li',n,{text:`Bind Index: ${t.binding}`}),new $t('li',n,{text:`Size: ${t.type.size||'<runtime>'}`}),this._addShaderTypeInfo(n,t.type)}}if(s.storage.length){new At(t.body,{text:`Storage Buffers: ${s.storage.length}`});const e=new $t('ul',t.body);for(const t of s.storage){new $t('li',e,{text:`${t.name}: ${this._getTypeName(t.type)}`});const n=new $t('ul',e);new $t('li',n,{text:`Bind Group: ${t.group}`}),new $t('li',n,{text:`Bind Index: ${t.binding}`}),new $t('li',n,{text:`Access: ${t.access}`}),new $t('li',n,{text:`Size: ${t.type.size||'<runtime>'}`}),this._addShaderTypeInfo(n,t.type)}}if(s.textures.length){new At(t.body,{text:`Textures: ${s.textures.length}`});const e=new $t('ul',t.body);for(const t of s.textures){new $t('li',e,{text:`${t.name}: ${this._getTypeName(t.type)}`});const n=new $t('ul',e);new $t('li',n,{text:`Bind Group: ${t.group}`}),new $t('li',n,{text:`Bind Index: ${t.binding}`})}}if(s.samplers.length){new At(t.body,{text:`Samplers: ${s.samplers.length}`});const e=new $t('ul',t.body);for(const t of s.samplers){new $t('li',e,{text:`${t.name}: ${this._getTypeName(t.type)}`});const n=new $t('ul',e);new $t('li',n,{text:`Bind Group: ${t.group}`}),new $t('li',n,{text:`Bind Index: ${t.binding}`})}}}}_showTextureOutputs(e,t,n){let s=0;const i={color:[],depthStencil:null};if(e.renderPass){s=e.renderPass._passIndex;const t=e.renderPass.args[0];if(t?.colorAttachments)for(const e of t.colorAttachments){const t=this._getTextureFromAttachment(e);i.color.push(t)}if(t?.depthStencilAttachment){const e=this._getTextureFromAttachment(t.depthStencilAttachment);i.depthStencil=e}}if(i.color.length||i.depthStencil){const e=this,r=new Ft(t,{collapsed:n,label:'Output Textures'});for(let t=0,n=i.color.length;t<n;++t){const n=i.color[t],o=this._getPassId(s,t);if(n)if(new Nt(r.body,{label:'Inspect',style:Ob,callback:()=>{e.window.inspectObject(n)}}),n.gpuTexture){const e=new At(r.body);new At(e,{text:`Color: ${t} Texture: ${n.idName} ${n.format} ${n.resolutionString}`}),this._createTextureWidget(e,n,o,this._clampedTextureWidth(n),'margin-left: 20px; margin-top: 10px;')}else new At(r.body,{text:`Color: ${t} Texture: ${n.idName} ${n.format} ${n.resolutionString}`}),this.database.requestTextureData(n)}if(i.depthStencil){const t=i.depthStencil;if(t)if(new Nt(r.body,{label:'Inspect',style:Ob,callback:()=>{e.window.inspectObject(t)}}),t.gpuTexture){const e=new At(r.body);new At(e,{text:`DepthStencil Texture: ${t.idName} ${t.format} ${t.resolutionString}`}),this._createTextureWidget(e,t,-1,this._clampedTextureWidth(t),'margin-left: 20px; margin-top: 10px;')}else new At(r.body,{text:`DepthStencil Texture: ${t.idName} ${t.format} ${t.resolutionString}`}),this.database.requestTextureData(t)}}}_showTextureInputs(e,t){const n=[];for(const t of e.bindGroups){const e=t.args[0],s=this._getObject(t.args[1]?.__id);if(s?.entries)for(const t of s.entries)if(t.resource?.__id){const s=this._getObject(t.resource.__id);if(s instanceof xt){const i=t.binding;n.push({textureView:s,group:e,binding:i})}}}if(n.length){const e=this,s=new Ft(t,{collapsed:!0,label:'Input Textures'});for(const t of n){const n=this.database.getTextureFromView(t.textureView);if(n)if(new Nt(s.body,{label:'Inspect',style:Ob,callback:()=>{e.window.inspectObject(n)}}),n.gpuTexture){const e=new At(s.body);new At(e,{text:`Group: ${t.group} Binding: ${t.binding} Texture: ${n.idName} ${n.format} ${n.resolutionString}`}),this._createTextureWidget(e,n,-1,this._clampedTextureWidth(n),'margin-left: 20px; margin-top: 10px;')}else this.database.requestTextureData(n)}}}_showCaptureCommandInfo_end(e,t){const n=this._getPipelineState(e);this._showTextureOutputs(n,t,!1)}_showCaptureCommandInfo_draw(e,t){const n=this._getPipelineState(e);if(n){this._showTextureOutputs(n,t,!0),this._showTextureInputs(n,t),n.pipeline&&this._showCaptureCommandInfo_setPipeline(n.pipeline,t);for(const e of n.vertexBuffers)this._showCaptureCommandInfo_setVertexBuffer(e,t,!0,n);for(const e in n.bindGroups)this._showCaptureCommandInfo_setBindGroup(n.bindGroups[e],t,e,!0,n)}}_showCaptureCommandInfo_drawIndexed(e,t){const n=this._getPipelineState(e);if(n){this._showTextureOutputs(n,t,!0),this._showTextureInputs(n,t),n.pipeline&&this._showCaptureCommandInfo_setPipeline(n.pipeline,t),n.indexBuffer&&this._showCaptureCommandInfo_setIndexBuffer(n.indexBuffer,t,!0);for(const e of n.vertexBuffers)this._showCaptureCommandInfo_setVertexBuffer(e,t,!0,n);for(const e in n.bindGroups)this._showCaptureCommandInfo_setBindGroup(n.bindGroups[e],t,e,!0,n)}}_showCaptureCommandInfo_indirectBuffer(e,t,n,s,i){const r=t.__id,o=this._getObject(r);if(o){const t=this,a=new Ft(s,{collapsed:i,label:`Indirect Buffer ID:${r} ${o.label}`});new Nt(a.body,{label:'Inspect',style:Ob,callback:()=>{t.window.inspectObject(o)}});const l=o.descriptor,c=this._processCommandArgs(l);if(c.usage&&(c.usage=Xt(c.usage,GPUBufferUsage)),new $t('pre',a.body,{text:JSON.stringify(c,void 0,4)}),e.isBufferDataLoaded&&e.bufferData){const t=e.bufferData[0];if(t){const s=new Uint32Array(t.buffer,n);'dispatchWorkgroupsIndirect'===e.method?(new At(a.body,{text:`Workgroup Count X: ${s[0]}`}),new At(a.body,{text:`Workgroup Count Y: ${s[1]}`}),new At(a.body,{text:`Workgroup Count Z: ${s[2]}`})):'drawIndexedIndirect'===e.method?(new At(a.body,{text:`Index Count: ${s[0]}`}),new At(a.body,{text:`Instance Count: ${s[1]}`}),new At(a.body,{text:`First Index: ${s[2]}`}),new At(a.body,{text:`Base Vertex: ${s[3]}`}),new At(a.body,{text:`First Instance: ${s[4]}`})):'drawIndirect'===e.method&&(new At(a.body,{text:`Vertex Count: ${s[0]}`}),new At(a.body,{text:`Instance Count: ${s[1]}`}),new At(a.body,{text:`First Index: ${s[2]}`}),new At(a.body,{text:`First Instance: ${s[3]}`}))}}}}_showCaptureCommandInfo_drawIndirect(e,t){const n=this._getPipelineState(e);this._showTextureOutputs(n,t,!0),this._showTextureInputs(n,t),this._showCaptureCommandInfo_indirectBuffer(e,e.args[0],e.args[1],t,!0),n.pipeline&&this._showCaptureCommandInfo_setPipeline(n.pipeline,t);for(const e of n.vertexBuffers)this._showCaptureCommandInfo_setVertexBuffer(e,t,!0,n);for(const e in n.bindGroups)this._showCaptureCommandInfo_setBindGroup(n.bindGroups[e],t,e,!0,n)}_showCaptureCommandInfo_drawIndexedIndirect(e,t){const n=this._getPipelineState(e);this._showTextureOutputs(n,t,!0),this._showTextureInputs(n,t),this._showCaptureCommandInfo_indirectBuffer(e,e.args[0],e.args[1],t,!0),n.pipeline&&this._showCaptureCommandInfo_setPipeline(n.pipeline,t),n.indexBuffer&&this._showCaptureCommandInfo_setIndexBuffer(n.indexBuffer,t,!0);for(const e of n.vertexBuffers)this._showCaptureCommandInfo_setVertexBuffer(e,t,!0,n);for(const e in n.bindGroups)this._showCaptureCommandInfo_setBindGroup(n.bindGroups[e],t,e,!0,n)}_showCaptureCommandInfo_dispatchWorkgroups(e,t){const n=this._getPipelineState(e);n.pipeline&&this._showCaptureCommandInfo_setPipeline(n.pipeline,t,e);for(const e in n.bindGroups)this._showCaptureCommandInfo_setBindGroup(n.bindGroups[e],t,e,!0,n)}_showCaptureCommandInfo_dispatchWorkgroupsIndirect(e,t){this._showCaptureCommandInfo_indirectBuffer(e,e.args[0],e.args[1],t,!0,!0);const n=this._getPipelineState(e);n.pipeline&&this._showCaptureCommandInfo_setPipeline(n.pipeline,t,e);for(const e in n.bindGroups)this._showCaptureCommandInfo_setBindGroup(n.bindGroups[e],t,e,!0,n)}_showCaptureCommandInfo_createView(e,t){const n=this._getObject(e.object);if(!n)return;const s=this,i=new Ft(t,{collapsed:!1,label:`Texture ${n.idName} ${n.format} ${n.resolutionString}`});if(new Nt(i.body,{label:'Inspect',style:Ob,callback:()=>{s.window.inspectObject(n)}}),n.gpuTexture){const e=new At(i.body);this._createTextureWidget(e,n,-1,this._clampedTextureWidth(n),'margin-left: 20px; margin-top: 10px;')}else this.database.requestTextureData(n)}_showCaptureCommandInfo_executeBundles(e,t){const n=e.args[0];for(const e of n){this._getObject(e.__id)}}_inspectStats(e){e.html='';const t=new Ft(e,{label:'Frame Statistics'}),n=new $t('ul',t.body),s=this.statistics;for(const e in s)new $t('li',n,{text:`${e}: ${s[e].toLocaleString('en-US')}`,style:'padding-left: 20px; line-height: 25px; font-size: 12pt;'})}_showCaptureCommandInfo(e,t,n,s=!0){n.html='';const i=e.method,r=e.args;if(s&&new At(n,{text:`${t} ${i}`,style:'background-color: #575; padding-left: 20px; line-height: 40px;'}),'beginRenderPass'===i){const e=r[0],t=e.colorAttachments;for(const e in t){const s=t[e],i=this._getTextureFromAttachment(s);if(i){const t=i.descriptor.format;new At(n,{text:`Color ${e}: ${t} ${i.resolutionString}`,style:'background-color: #353; padding-left: 40px; line-height: 20px;'})}}const s=e.depthStencilAttachment;if(s){const e=this._getTextureFromAttachment(s);if(e){const t=e.descriptor.format;new At(n,{text:`Depth-Stencil: ${t} ${e.resolutionString}`,style:'background-color: #353; padding-left: 40px; line-height: 20px;'})}}}else if('draw'===i||'drawIndexed'===i||'drawIndirect'===i||'drawIndexedIndirect'===i){const t=this._getPipelineState(e);if(t.pipeline){const s=this._getObject(t.pipeline.args[0]?.__id)?.topology??'triangle-list';let o=0;if('drawIndirect'===i||'drawIndexedIndirect'===i){if(e.isBufferDataLoaded&&e.bufferData){const t=e.bufferData[0];if(t){o=new Uint32Array(t.buffer)[0]}}}else o=r[0]??0;if('triangle-list'===s){const e=(o/3).toLocaleString('en-US');new At(n,{text:`Triangles: ${e}`,style:'background-color: #353; padding-left: 40px; line-height: 20px;'})}else if('triangle-strip'===s){const e=(o-2).toLocaleString('en-US');new At(n,{text:`Triangles: ${e}`,style:'background-color: #353; padding-left: 40px; line-height: 20px;'})}else if('point-list'===s){const e=o.toLocaleString('en-US');new At(n,{text:`Points: ${e}`,style:'background-color: #353; padding-left: 40px; line-height: 20px;'})}else if('line-list'===s){const e=(o/2).toLocaleString('en-US');new At(n,{text:`Lines: ${e}`,style:'background-color: #353; padding-left: 40px; line-height: 20px;'})}else if('line-strip'===s){const e=(o-1).toLocaleString('en-US');new At(n,{text:`Lines: ${e}`,style:'background-color: #353; padding-left: 40px; line-height: 20px;'})}}}if(e.stacktrace){const t=new Ft(n,{collapsed:!0,label:'Stacktrace'});new At(t.body,{text:e.stacktrace,style:'font-size: 10pt;color: #ddd;overflow: auto;background-color: rgb(51, 51, 85);box-shadow: #000 0 3px 5px;padding: 5px;padding-left: 10px;'})}const o=new Ft(n,{label:'Arguments'}),a=this._processCommandArgs(r);if(Sb._commandArgs[i]){const e=Sb._commandArgs[i];for(let t=0,n=a.length;t<n;++t){const n=e[t],s=a[t],i=s instanceof Array?`[${s.length}]: ${s}`:JSON.stringify(s,void 0,4);new $t('pre',o.body,void 0!==n?{text:`${n}: ${i}`,style:'margin-left: 10px;'}:{text:`[${t}]: ${i}`,style:'margin-left: 10px;'})}}else new $t('pre',o.body,{text:JSON.stringify(a,void 0,4)});if('createRenderPipeline'===i||'createBindGroup'===i||'createBindGroupLayout'===i||'createShaderModule'===i||'createPipelineLayout'===i){const t=this._getObject(e.result),s=this;new Nt(n,{label:'Inspect',style:Ob,callback:()=>{s.window.inspectObject(t)}})}else'beginRenderPass'==i?this._showCaptureCommandInfo_beginRenderPass(e,n):'setBindGroup'===i?this._showCaptureCommandInfo_setBindGroup(e,n,0,!1):'setPipeline'===i?this._showCaptureCommandInfo_setPipeline(e,n):'writeBuffer'===i?this._showCaptureCommandInfo_writeBuffer(e,n):'setIndexBuffer'===i?this._showCaptureCommandInfo_setIndexBuffer(e,n):'setVertexBuffer'===i?this._showCaptureCommandInfo_setVertexBuffer(e,n):'drawIndexed'===i?this._showCaptureCommandInfo_drawIndexed(e,n):'draw'===i?this._showCaptureCommandInfo_draw(e,n):'drawIndirect'===i?this._showCaptureCommandInfo_drawIndirect(e,n):'drawIndexedIndirect'===i?this._showCaptureCommandInfo_drawIndexedIndirect(e,n):'dispatchWorkgroups'===i?this._showCaptureCommandInfo_dispatchWorkgroups(e,n):'dispatchWorkgroupsIndirect'===i?this._showCaptureCommandInfo_dispatchWorkgroupsIndirect(e,n):'end'===i?this._showCaptureCommandInfo_end(e,n):'createView'===i?this._showCaptureCommandInfo_createView(e,n):'executeBundles'===i&&this._showCaptureCommandInfo_executeBundles(e,n)}_textureDataChunkLoaded(){this._captureData&&(this._captureData.captureTextureDataChunk(),this._updateCaptureStatus())}_findCanvas(e){if('CANVAS'===e.element.tagName)return e;for(const t of e.children){const e=this._findCanvas(t);if(e)return e}return null}_getPassId(e,t){return 10*e+t}_getPassIdCanvas(e){const t=this._frameImageList[e];return t?this._findCanvas(t):null}_textureLoaded(e,t){if(!this._captureData)return;this._captureData.captureTextureLoaded(),this._lastSelectedCommand&&this._lastSelectedCommand.element.click(),this._updateCaptureStatus();const n=this._frameImages;if(-1!=t&&n){const s=t/10,i=Math.floor(s),r=t-10*i;n.style.display='block';let o=null;if(t>=this._frameImageList.length)o=new At(n,{class:'capture_pass_texture'}),this._frameImageList[t]=o;else{o=new At(null,{class:'capture_pass_texture'});let e=!1;for(let s=t-1;s>=0;--s)if(this._frameImageList[s]){n.insertAfter(o,this._frameImageList[s]),e=!0;break}e||n.insertBefore(o,n.children[0]),this._frameImageList[t]=o}new At(o,{text:`Render Pass ${i} Attachment ${r}`,style:'color: #ddd; margin-bottom: 5px;'});const a=e.id<0?'CANVAS':e.id;new At(o,{text:`${e.name} ID:${a}`,style:'color: #ddd; margin-bottom: 10px;'}),new At(o,{text:`${e.format} ${e.resolutionString}`,style:'color: #ddd; margin-bottom: 10px; font-size: 9pt;'}),this._createTextureWidget(o,e,t,256),this._gpuTextureMap.set(t,e.gpuTexture),e.gpuTexture.addReference(),o.element.onclick=()=>{const e=document.getElementById(`RenderPass_${i}`);if(e){e.scrollIntoView();const t=document.getElementById(`RenderPass_${i}_begin`);t&&t.click()}}}}}Sb.matrixTypes={mat2x2:{columns:2,rows:2},mat2x2f:{columns:2,rows:2},mat2x3:{columns:2,rows:3},mat2x3f:{columns:2,rows:3},mat2x4:{columns:2,rows:4},mat2x4f:{columns:2,rows:4},mat3x2:{columns:3,rows:2},mat3x2f:{columns:3,rows:2},mat3x3:{columns:3,rows:3},mat3x3f:{columns:3,rows:3},mat3x4:{columns:3,rows:4},mat3x4f:{columns:3,rows:4},mat4x2:{columns:4,rows:2},mat4x2f:{columns:4,rows:2},mat4x3:{columns:4,rows:3},mat4x3f:{columns:4,rows:3},mat4x4:{columns:4,rows:4},mat4x4f:{columns:4,rows:4}},Sb._commandArgs={beginComputePass:['descriptor'],beginOcclusionQuery:['queryIndex'],beginRenderPass:['descriptor'],configure:['configuration'],clearBuffer:['buffer','offset','size'],copyBufferToBuffer:['source','sourceOffset','destination','destinationOffset','size'],copyBufferToTexture:['source','destination','copySize'],copyTextureToBuffer:['source','destination','copySize'],copyTextureToTexture:['source','destination','copySize'],createBindGroup:['descriptor'],createBindGroupLayout:['descriptor'],createBuffer:['descriptor'],createCommandEncoder:['descriptor'],createComputePipeline:['descriptor'],createComputePipelineAsync:['descriptor'],createPipelineLayout:['descriptor'],createQuerySet:['descriptor'],createRenderBundleEncoder:['descriptor'],createRenderPipeline:['descriptor'],createRenderPipelineAsync:['descriptor'],createSampler:['descriptor'],createShaderModule:['descriptor'],createTexture:['descriptor'],createView:['descriptor'],destroy:[],dispatchWorkgroups:['workgroupCountX','workgroupCountY','workgroupCountZ'],dispatchWorkgroupsIndirect:['indirectBuffer','indirectOffset'],draw:['vertexCount','instanceCount','firstVertex','firstInstance'],drawIndexed:['indexCount','instanceCount','firstIndex','baseVertex','firstInstance'],drawIndirect:['indirectBuffer','indirectOffset'],drawIndexedIndirect:['indirectBuffer','indirectOffset'],end:[],endOcclusionQuery:[],executeBundles:['bundles'],finish:['descriptor'],getCompilationInfo:[],getCurrentTexture:[],getMappedRange:['offset','size'],importExternalTexture:['descriptor'],insertDebugMarker:['markerLabel'],mapAsync:['mode','offset','size'],onSubmittedWorkDone:['workDonePromise','callback'],pushDebugGroup:['groupLabel'],popDebugGroup:[],resolveQuerySet:['querySet','firstQuery','queryCount','destination','destinationOffset'],setBindGroup:['index','bindGroup','dynamicOffsets'],setBlendColor:['color'],setIndexBuffer:['buffer','indexFormat','offset','size'],setVertexBuffer:['slot','buffer','offset','size'],setPipeline:['pipeline'],setScissorRect:['x','y','width','height'],setStencilReference:['reference'],setViewport:['x','y','width','height','minDepth','maxDepth'],submit:['commandBuffers'],unmap:[],writeBuffer:['buffer','bufferOffset','data','dataOffset','size'],writeTexture:['destination','data','dataLayout','size','bytesPerRow'],copyExternalImageToTexture:['source','destination','copySize']};class Tb extends Rt{constructor(e,t){super(e,t),this.classList.add('styled-checkbox-container'),this.input=new Ut(this,t),this.input.type='checkbox',this.input.classList.add('styled-checkbox'),this.label||(this.label=new zt('',this,{for:this})),t?.tooltip&&(this.input.title=t.tooltip,this.label.title=t.tooltip)}get checked(){return this.input.checked}set checked(e){this.input.checked=e}get label(){return this.input.label}set label(e){this.input.label=e}get indeterminate(){return this.input.indeterminate}set indeterminate(e){this.input.indeterminate=e}}class Ib{constructor(e){this.window=e,this.data=[],this.initiazeCommands=[],this.frames=[],this._dataCount=0,this._commandCount=0,this.dataReady=!1,this._commandsReady=!1,this.onReady=new l,this._objectMap=new Map,this._canvas=null,this._context=null,this._device=null,this._textureUtils=null}get ready(){return this.dataReady&&this._commandsReady}clear(){this.data=[],this.initiazeCommands=[],this.frames=[],this._dataCount=0,this._commandCount=0,this.dataReady=!1,this._commandsReady=!1}addData(e,t,n,s){if(void 0===e)return this.data[n]=new Uint8Array(s),this._dataCount++,void(this._dataCount>=s?(this.dataReady=!0,this.ready&&this.onReady.emit()):this.dataReady=!1);const i=this;(async function(e,t,n){try{const n=await fetch(e),s=new Uint8Array(await n.arrayBuffer());return'Uint32Array'==t?new Uint32Array(s.buffer,0,s.length/4):new Uint8Array(s.buffer,0,s.length)}catch(e){console.log(e.message)}return new Uint8Array(n)})(e,t,0).then((e=>{i.data[n]=e,i._dataCount++,i._dataCount>=s?(i.dataReady=!0,i.ready&&i.onReady.emit()):i.dataReady=!1}))}addCommand(e,t,n,s,i){try{if('requestDevice'===e.method){const t=this.window.adapter,n=[];for(const e of t.features)n.push(e);const s={},i=new Set(['minSubgroupSize','maxSubgroupSize']);for(const e in t.limits)i.has(e)||(s[e]=t.limits[e]);e.args=[{requiredFeatures:n,requiredLimits:s}]}else e.args=JSON.parse(e.args);n<0?this.initiazeCommands[t]=e:(void 0===this.frames[n]&&(this.frames[n]=[]),this.frames[n][t]=e),this._commandCount++,this._commandCount>=i?(this._commandsReady=!0,this.ready&&this.onReady.emit()):this._commandsReady=!1}catch(t){console.log(t.message,e.method,e.args)}}_getObject(e){return'x1'===e?navigator.gpu:'context'===e?(this._context||(this._context=this._canvas.element.getContext('webgpu')),this._context):this._objectMap.get(e)}async executeCommands(e,t,n){n??=-1,this._objectMap.forEach((e=>{e instanceof GPUDevice&&e.destroy()})),this._objectMap.clear(),this._canvas=e,this._context=null,this._device=null,this._textureUtils=null;let s=0;for(const e of this.initiazeCommands)await this._executeCommand(e,-1,s),s++;t=Math.max(0,Math.min(t,this.frames.length-1));const i=n>=0,r=new Set,o=new Set,a=new Set;let l=0,c=null;for(let e=0;e<=t;++e){const h=this.frames[e];if(!h)continue;s=0;const u=i&&e===t;for(const i of h){if(u&&s>n){if(o.size>0&&'end'===i.method){await this._executeCommand(i,e,s);const t=this._getObject(i.object);t&&o.delete(t),c=t}if(r.size>0&&'finish'===i.method){await this._executeCommand(i,e,s);const t=this._getObject(i.object);t&&r.delete(t),a.add(i.result)}if('popDebugGroup'===i.method&&l>0&&(this._executeCommand(i,e,s),l--),'submit'===i.method){let t=!1;if(a.size>0){for(const e of i.args[0])for(const n of a)if(n===e.__id){t=!0,a.delete(n);break}t&&await this._executeCommand(i,e,s)}}s++;continue}const h=await this._executeCommand(i,e,s);if(s++,e===t)if('pushDebugGroup'===i.method)l++;else if('popDebugGroup'===i.method)l--;else if('createCommandEncoder'===i.method)r.add(h);else if('beginRenderPass'===i.method||'beginComputePass'===i.method)h.__descriptor=i.args[0],o.add(h);else if('end'===i.method){const e=this._getObject(i.object);e&&o.delete(e)}else if('finish'===i.method){const e=this._getObject(i.object);e&&r.delete(e)}}}if(c instanceof GPURenderPassEncoder&&c.__descriptor.colorAttachments.length>0){const e=this._getObject(c.__descriptor.colorAttachments[0].resolveTarget?.__id??c.__descriptor.colorAttachments[0].view?.__id);if(!e.texture.isCanvasTexture){const t=this._context.getCurrentTexture(),n=t.createView();this._textureUtils||this._device&&(this._textureUtils=new Mt(this._device)),this._textureUtils&&this._textureUtils.blitTexture(e,e.texture.format,1,n,t.format,null)}}}_prepareObject(e){const t={};for(const n in e)'string'!=typeof e[n]&&void 0!==e[n].length?t[n]=this._prepareArgs(e[n]):e[n]instanceof Object?void 0!==e[n].__id?t[n]=this._getObject(e[n].__id):void 0!==e[n].__data?t[n]=this.data[e[n].__data]:t[n]=this._prepareObject(e[n]):t[n]=e[n];return t}_prepareArgs(e){const t=[...e];for(let e=0;e<t.length;++e)'string'!=typeof t[e]&&void 0!==t[e].length?t[e]=this._prepareArgs(t[e]):t[e]instanceof Object&&(void 0!==t[e].__id?t[e]=this._getObject(t[e].__id):void 0!==t[e].__data?t[e]=this.data[t[e].__data]:t[e]=this._prepareObject(t[e]));return t}async _executeCommand(e,t,n){const s=this._getObject(e.object);let i=e.method;if('pushDebugGroup'===i||'popDebugGroup'===i)return;if(!s)return;s instanceof GPUDevice&&(this._device=s),'__writeTexture'===i&&(i='writeTexture');const r=this._prepareArgs(e.args);if('__setCanvasSize'===i)return this._canvas.element.width=r[0],void(this._canvas.element.height=r[1]);if('__writeData'!==i){if('__getQueue'!==i){if('createTexture'===i&&(r[0].usage|=GPUTextureUsage.TEXTURE_BINDING),e.async){let o;this._device&&this._device.pushErrorScope('validation');try{o=await s[i](...r)}catch(e){console.log(`EXCEPTION frame:${t} command:${n} ${s?.constructor.name} ${i}: ${e.message}`)}return this._device&&this._device.popErrorScope().then((e=>{e&&console.log(`ERROR frame:${t} command:${n} ${s?.constructor.name} ${i}: ${e.message}`)})).catch((e=>{console.log(`ERROR frame:${t} command:${n} ${s?.constructor.name} ${i}: ${e.message}`)})),e.result&&this._objectMap.set(e.result,o),o instanceof GPUDevice&&(this._device=o),o}{let o;this._device&&this._device.pushErrorScope('validation');try{o=s[i](...r)}catch(e){console.log(`EXCEPTION frame:${t} command:${n} ${s?.constructor.name} ${i}: ${e.message}`)}return'createView'===i?o.texture=s:'getCurrentTexture'===i&&(o.isCanvasTexture=!0),this._device&&this._device.popErrorScope().then((e=>{e&&console.log(`ERROR frame:${t} command:${n} ${s?.constructor.name} ${i}: ${e.message}`)})),e.result&&this._objectMap.set(e.result,o),o}}this._objectMap.set(e.result,s.queue)}else{const e=r[0],t=this.data[e];new Uint8Array(s).set(t)}}}class Cb{constructor(e,n){this.window=e,this._recorderData=new Ib(e),this._recorderData.onReady.addListener(this._recordingReady,this);const s=this,i=e.port,r=new At(n,{style:'background-color: #333; box-shadow: #000 0px 3px 3px; border-bottom: 1px solid #000; margin-bottom: 5px; padding-left: 20px; padding-top: 10px; padding-bottom: 10px;'});this.recordButton=new Nt(r,{label:'Record',style:'background-color: #755;',callback:()=>{const e=s.recordFramesInput.value||1,t=s.recordNameInput.value,n=s._downloadCheckbox.checked;s._recorderData.clear(),i.postMessage({action:a,frames:e,filename:t,download:n})}}),new Rt(r,{text:'Frames:',style:'margin-left: 20px; margin-right: 10px; vertical-align: middle;'}),this.recordFramesInput=new Ut(r,{id:'record_frames',type:'number',value:1,style:'width: 60px; display: inline-block;'}),this._downloadCheckbox=new Tb(r,{label:'Download',tooltip:'Automatically Download Recording',checked:!0,style:'margin-left: 20px; color: #fff;'}),new Rt(r,{text:'Name:',style:'margin-left: 20px; margin-right: 10px;  vertical-align: middle;'}),this.recordNameInput=new Ut(r,{id:'record_frames',type:'text',value:'webgpu_record'}),this.recorderDataPanel=new At(n,{style:'width: 100%; height: calc(-80px + 100vh); position: relative;'}),i.addListener((e=>{switch(e.action){case t.RecordingDataCount:0===e.count&&(s._recorderData.dataReady=!0);break;case t.RecordingData:{const t=e.data,n=e.type,i=e.index,r=e.count;s._recorderData.addData(t,n,i,r);break}case t.RecordingCommand:{const t=e.command,n=e.commandIndex,i=e.frame,r=e.index,o=e.count;s._recorderData.addCommand(t,n,i,r,o);break}}}))}_recordingReady(){this.recorderDataPanel.html='';const e=this,t=new At(this.recorderDataPanel,{style:'background-color: #333; padding: 10px; box-shadow: #000 0px 3px 3px; border-bottom: 1px solid #000;'}),n=this._recorderData.frames.length-1;new Rt(t,{text:'Frame:',style:'margin-left: 20px; margin-right: 10px; vertical-align: middle;'}),new Qt(t,{precision:0,value:n,min:0,max:n,style:'width: 60px; display: inline-block;',onChange:t=>{e._recorderData.executeCommands(i,t)}});const s=new tn(this.recorderDataPanel,{direction:tn.Horizontal,position:800,style:'height: calc(-118px + 100vh);'}),i=new $t('canvas',new At(s,{style:'overflow: auto;'}));i.element.width=800,i.element.height=600;const r=new At(s,{style:'overflow: auto;'});s.position=800;const o=new At(r,{class:'capture_filterArea'});new Rt(o,{text:'Filter: ',style:'margin-right: 5px;'}),this.filterEdit=new Wt(o,{style:'width: 200px;',placeholder:'Filter',onEdit:t=>{e._filterCommands(t)}});let a=new Ft(r,{label:'Initialize Commands',collapsed:!0});this._captureFrameResults(a.body,this._recorderData.initiazeCommands,i,-1);for(let e=0;e<this._recorderData.frames.length;++e)this._recorderData.frames[e]&&(a=new Ft(r,{label:`Frame ${e}`,collapsed:!0}),this._captureFrameResults(a.body,this._recorderData.frames[e],i,e));this._recorderData.executeCommands(i,n)}_filterCommands(e){function t(t){for(let n=0,s=t.length;n<s;++n){const s=t[n];if(!s)break;const i=s.method,r=s.widget;r&&(i.includes(e)?r.element.style.display='block':r.element.style.display='none')}}t(this._recorderData.initiazeCommands);for(let e=0;e<this._recorderData.frames.length;++e)t(this._recorderData.frames[e])}_captureFrameResults(e,t,n,s){if(void 0===t)return;this._passEncoderCommands=new Map;const i=new At(e,{class:'capture_frame'}),r=[i],o=[];let a=0,l=new At(i,{class:'capture_commandBlock'});this._lastSelectedCommand=null;const c=new Map;let h=0,u=0;for(let f=0,p=t.length;f<p;++f){const m=t[f];m.id=f;const g=m.method;if('beginRenderPass'===g)c.set(m.result,-1);else if('beginComputePass'===g)c.set(m.result,-2);else if('end'===g){const v=c.get(m.object);-1===v?c.set(m.object,h++):-2===v&&c.set(m.object,u++)}}let d=0;for(let x=0,b=t.length;x<b;++x){const y=t[x];if(!y)break;y.class;const _=y.method,w=y.args;if('pushDebugGroup'===_){let S=x+1,T=t[S],I=!1,C=1;for(;T;){const $=T.method;if('pushDebugGroup'===$)C++;else{if('popDebugGroup'!==$){I=!0;break}if(C--,0===C)break}S++,T=t[S]}if(!I){x=S;continue}}let k=r[r.length-1];if('beginRenderPass'===_){const A=c.get(y.result);this._passEncoderCommands.set(y.result,[y]),y._passIndex=A,l.children.length||l.remove(),l=new At(k,{class:'capture_renderpass'});const E=new At(l,{id:`RenderPass_${A}`,class:'capture_renderpass_header'}),P=new Rt(E,{text:'-',style:'margin-right: 10px; font-size: 12pt;'});new Rt(E,{text:`Render Pass ${A}`});const D=new Rt(E,{style:'margin-left: 10px;'}),M=new At(l,{class:'capture_renderpass_block'});E.element.onclick=()=>{M.element.classList.toggle('collapsed'),M.element.classList.contains('collapsed')?(P.text='+',D.text='...'):(P.text='-',D.text='')},l=M,l._passIndex=A}else if('beginComputePass'===_){const L=c.get(y.result);this._passEncoderCommands.set(y.result,[y]),y._passIndex=L,l.children.length||l.remove(),l=new At(k,{class:'capture_computepass'});const B=new At(l,{id:`ComputePass_${L}`,class:'capture_computepass_header'}),N=new Rt(B,{text:'-',style:'margin-right: 10px; font-size: 12pt;'});new Rt(B,{text:`Compute Pass ${L}`});const R=new Rt(B,{style:'margin-left: 10px;'}),F=new At(l);B.element.onclick=()=>{F.element.classList.toggle('collapsed'),F.element.classList.contains('collapsed')?(N.text='+',R.text='...'):(N.text='-',R.text='')},l=F,l._passIndex=L}else if('popDebugGroup'===_)r.pop(),k=r[r.length-1],l.children.length||l.remove(),l=new At(k,{class:'capture_commandBlock'});else if('pushDebugGroup'!==_){const V=y.object,z=this._passEncoderCommands.get(V);if(z&&z.push(y),c.has(V)){const U=c.get(V);if(l._passIndex!==U){l.children.length||l.remove(),l=new At(k,{class:'capture_renderpass',style:'margin-top: 5px;'});const W=new At(l,{id:`RenderPass_${U}`,class:'capture_renderpass_header'}),Q=new Rt(W,{text:'-',style:'margin-right: 10px; font-size: 12pt;'});new Rt(W,{text:`Render Pass ${U}`});const j=new Rt(W,{style:'margin-left: 10px;'}),X=new At(l,{class:'capture_renderpass_block'});W.element.onclick=()=>{X.element.classList.toggle('collapsed'),X.element.classList.contains('collapsed')?(Q.text='+',j.text='...'):(Q.text='-',j.text='')},l=X,l._passIndex=U}}}const O=['capture_command'];'draw'!==_&&'drawIndexed'!==_&&'drawIndirect'!==_&&'drawIndexedIndirect'!==_&&'dispatchWorkgroups'!==_&&'dispatchWorkgroupsIndirect'!=_||O.push('capture_drawcall');if(!('pushDebugGroup'===_||'popDebugGroup'===_)){const G=new At(l,{id:`CaptureCommand_${x}`,class:O});'end'===_?G.element.id=`Pass_${l._passIndex}_end`:'beginRenderPass'===_&&(G.element.id=`RenderPass_${l._passIndex}_begin`),y.widget=G,new Rt(G,{class:'capture_callnum',text:`${x}.`});const q=this;function H(e,t){return void 0===e?'':t?`${t}(${e})`:`${e}`}if(new Rt(G,{class:'capture_methodName',text:`${_}`}),'createCommandEncoder'===_?new Rt(G,{class:'capture_method_args',text:`=> ${H(y.result,'GPUCommandEncoder')}`}):'finish'===_&&new Rt(G,{class:'capture_method_args',text:`${H(y.object,y.class)} => ${H(y.result,'GPUCommandBuffer')}`}),'getMappedRange'===_)new Rt(G,{class:'capture_method_args',text:H(y.object)});else if('unmap'===_)new Rt(G,{class:'capture_method_args',text:H(y.object)});else if('copyBufferToBuffer'===_)new Rt(G,{class:'capture_method_args',text:`src:${H(w[0]?.__id)} srcOffset:${w[1]} dest:${H(w[2]?.__id)} destOffset:${w[3]} size:${w[4]}`});else if('clearBuffer'===_)new Rt(G,{class:'capture_method_args',text:`src:${H(w[0]?.__id)} offset:${w[1]} size:${w[4]}`});else if('copyBufferToTexture'===_)new Rt(G,{class:'capture_method_args',text:`buffer:${H(w[0]?.buffer?.__id)} texture:${H(w[1]?.texture?.__id)}`});else if('copyTextureToBuffer'===_)new Rt(G,{class:'capture_method_args',text:`texture:${H(w[0]?.texture?.__id)} buffer:${H(w[1]?.buffer?.__id)}`});else if('copyTextureToTexture'===_)new Rt(G,{class:'capture_method_args',text:`src:${H(w[0]?.texture?.__id)} dest:${H(w[1]?.texture?.__id)}`});else if('setViewport'===_)new Rt(G,{class:'capture_method_args',text:`x:${w[0]} y:${w[1]} w:${w[2]} h:${w[3]} minZ:${w[4]} maxZ:${w[5]}`});else if('setScissorRect'===_)new Rt(G,{class:'capture_method_args',text:`x:${w[0]} y:${w[1]} w:${w[2]} h:${w[3]}`});else if('setStencilReference'===_)new Rt(G,{class:'capture_method_args',text:`reference:${w[0]}`});else if('setBindGroup'===_)new Rt(G,{class:'capture_method_args',text:`index:${w[0]} bindGroup:${H(w[1]?.__id)}`});else if('__writeData'===_)new Rt(G,{class:'capture_method_args',text:`buffer:${H(y.object)} Data:${w[0]}`});else if('writeBuffer'===_){const Y=w[2];if(Y.constructor===String){const K=Y.split(' ')[2];new Rt(G,{class:'capture_method_args',text:`buffer:${H(w[0]?.__id)} offset:${w[1]} data:${K} Bytes`})}else new Rt(G,{class:'capture_method_args',text:`buffer:${H(w[0]?.__id)} offset:${w[1]} data:${w[2]?.length} Bytes`})}else if('setPipeline'===_)new Rt(G,{class:'capture_method_args',text:`renderPipeline:${H(w[0]?.__id)}`});else if('setVertexBuffer'===_)new Rt(G,{class:'capture_method_args',text:`slot:${w[0]} buffer:${H(w[1]?.__id)} offset:${w[2]??0}`});else if('setIndexBuffer'===_)new Rt(G,{class:'capture_method_args',text:`buffer:${H(w[0]?.__id)} indexFormat:${w[1]} offset:${w[2]??0}`});else if('drawIndexed'===_)new Rt(G,{class:'capture_method_args',text:`indexCount:${w[0]} instanceCount:${w[1]??1} firstIndex:${w[2]??0} baseVertex:${w[3]??0} firstInstance:${w[4]??0}`});else if('draw'===_)new Rt(G,{class:'capture_method_args',text:`vertexCount:${w[0]} instanceCount:${w[1]??1} firstVertex:${w[2]??0} firstInstance:${w[3]??0}`});else if('drawIndirect'===_)new Rt(G,{class:'capture_method_args',text:`indirectBuffer:${H(w[0]?.__id)} offset:${w[1]}`});else if('drawIndexedIndirect'===_)new Rt(G,{class:'capture_method_args',text:`indirectBuffer:${H(w[0]?.__id)} offset:${w[1]}`});else if('dispatchWorkgroups'===_)new Rt(G,{class:'capture_method_args',text:`countX:${w[0]} countY:${w[1]??1} countZ:${w[2]??1}`});else if('dispatchWorkgroupsIndirect'===_)new Rt(G,{class:'capture_method_args',text:`indirectBuffer:${H(w[0]?.__id)} offset:${w[1]}`});else if('pushDebugGroup'===_)o.push(w[0]),new Rt(G,{class:'capture_method_args',text:w[0]});else if('popDebugGroup'===_){const Z=o.pop();new Rt(G,{class:'capture_method_args',text:Z})}else if('createView'===_)new Rt(G,{class:'capture_method_args',text:`${H(y.object)} => ${H(y.result,'GPUTextureView')}`});else if('beginRenderPass'===_)new Rt(G,{class:'capture_method_args',text:`${H(y.object,y.class)} => ${H(y.result,'GPURenderPassEncoder')}`});else if('beginComputePass'===_)new Rt(G,{class:'capture_method_args',text:`${H(y.object,y.class)} => ${H(y.result,'GPUComputePassEncoder')}`});else if('end'===_)new Rt(G,{class:'capture_method_args',text:`${H(y.object,y.class)}`});else if('createBuffer'===_)new Rt(G,{class:'capture_method_args',text:`size:${w[0]?.size} usage:${w[0]?.usage} mappedAtCreation:${w[0]?.mappedAtCreation??!1} => ${H(y.result,'GPUBuffer')}`});else if('writeTexture'===_)new Rt(G,{class:'capture_method_args',text:`dest:${H(w[0]?.texture?.__id)}`});else if('destroy'===_)new Rt(G,{class:'capture_method_args',text:`${H(y.object,y.class)}`});else if('getCurrentTexture'===_)new Rt(G,{class:'capture_method_args',text:`=> ${H(y.result,'GPUTexture')}`});else if('submit'===_){let J='[';for(const ee of w[0])'['!==J&&(J+=', '),J+=`${H(ee.__id,'GPUCommandBuffer')}`;J+=']',new Rt(G,{class:'capture_method_args',text:`=> ${J}`})}G.element.onclick=()=>{q._lastSelectedCommand!==G&&(q._lastSelectedCommand&&q._lastSelectedCommand.classList.remove('capture_command_selected'),G.classList.add('capture_command_selected'),q._lastSelectedCommand=G),s>=0&&q._recorderData.executeCommands(n,s,x)}}if('pushDebugGroup'===_){const te=[['capture_debugGroup_header1','capture_debugGroup1'],['capture_debugGroup_header2','capture_debugGroup2'],['capture_debugGroup_header3','capture_debugGroup3'],['capture_debugGroup_header4','capture_debugGroup4'],['capture_debugGroup_header5','capture_debugGroup5']][d%5],ne=['capture_debugGroup',te[1]],se=['capture_debugGroup_header',te[0]];d++;const ie=new At(k,{id:`DebugGroup_${a}`,class:se}),re=new Rt(ie,{text:'-',style:'margin-right: 10px; font-size: 12pt;'});new Rt(ie,{text:`${w[0]}`});const oe=new Rt(ie,{style:'margin-left: 10px;'}),ae=new At(k,{class:ne});r.push(ae),a++,k=ae,ie.element.onclick=()=>{ae.element.classList.toggle('collapsed'),ae.element.classList.contains('collapsed')?(re.text='+',oe.text='...'):(re.text='-',oe.text='')},l.children.length||l.remove(),l=new At(k,{class:'capture_commandBlock'})}'popDebugGroup'==_&&d--,'end'===_&&(l.children.length||l.remove(),l=new At(k,{class:'capture_commandBlock'}))}}}class $b{constructor(e,t){this.name=e,this._size=t,this.data=new Float32Array(t),this.index=0,this.count=0,this.min=1e10,this.max=-1e10}reset(){this.index=0,this.count=0,this.min=1e10,this.max=-1e10}get size(){return this._size}set size(e){if(e===this._size)return;const t=this.data;this._size=e,this.data=new Float32Array(e);for(let e=0;e<this.count;++e)this.data[e]=t[e]}add(e){this.data[this.index]=e,this.index=(this.index+1)%this._size,this.count=Math.min(this.count+1,this._size),this.min=Math.min(this.min,e),this.max=Math.max(this.max,e)}get(e){return this.count<this._size?this.data[e]:this.data[(this.index+e)%this._size]}}class Ab extends At{constructor(e,t){t??={},t.class=t.class?t.class+' plot':'plot',super(e,t),this.canvas=new $t('canvas',this),this.context=this.canvas.element.getContext('2d'),this.data=new Map,this.suffix=t.suffix??'',this.precision=t.precision??0,this.onResize(),this.draw()}reset(){for(const e of this.data.values())e.reset()}onResize(){if(this.canvas){this.canvas.element.width=this.width,this.canvas.element.height=this.height;for(const e of this.data.values())e.size=this.width}}addData(e){const t=new $b(e,this.width);return this.data.set(e,t),t}getData(e){return this.data.get(e)}draw(){const e=this.context;e.fillStyle='#333',e.fillRect(0,0,this.width,this.height);for(const e of this.data.values())this._drawData(e)}_drawData(e){const t=this.context;t.strokeStyle='#999';const n=this.height;let s=1e10,i=-1e10;const r=e.count;for(let t=0;t<r;++t){let n=e.get(t);n<s&&(s=n),n>i&&(i=n)}if(0==r)return;t.fillStyle='#fff',t.fillText(`${i.toFixed(this.precision)}${this.suffix}`,2,10),t.fillText(`${s.toFixed(this.precision)}${this.suffix}`,2,n-1),i===s&&(s-=1,i+=1),t.beginPath();let o=e.get(0);o=(o-s)/(i-s)*n,t.moveTo(0,n-o);for(let r=1;r<e.count;++r)o=e.get(r),o=(o-s)/(i-s)*n,t.lineTo(r,n-o);t.stroke()}}const Eb=[Ku(),ed,eu(),Yp(),op(),Bh(),Xh(),Fr.allowMultipleSelections.of(!0),Nf(),dp(mp,{fallback:!0}),Op(),Jv(),fx(),ou(),pb,db(),_h.of([hg,...rx,...cg,...ev,...fm,...Kf,...px,...Ix])];class Pb{constructor(e,t){this.window=e;const n=this,s=new At(t,{style:'background-color: #333; box-shadow: #000 0px 3px 3px; border-bottom: 1px solid #000; margin-bottom: 10px; padding-left: 20px; padding-top: 10px; padding-bottom: 10px; font-size: 10pt;'});this.inspectButton=new Nt(s,{label:'Start',style:'background-color: #575;',callback:()=>{try{n._reset(),n.port.postMessage({action:o})}catch(e){}}});const i=new Rt(s,{style:'border-left: 1px solid #aaa; padding-left: 10px; margin-left: 20px; height: 20px; padding-top: 5px; color: #ddd;'});this.uiFrameTime=new Rt(i,{style:'width: 140px; overflow: hidden;'}),this.uiTotalTextureMemory=new Rt(i,{style:'margin-left: 20px;'}),this.uiTotalBufferMemory=new Rt(i,{style:'margin-left: 20px;'}),this.plots=new At(t,{style:'display: flex; flex-direction: row; margin-bottom: 10px; height: 30px;'}),new Rt(this.plots,{text:'Frame Time',style:'color: #ccc; padding-top: 5px; margin-right: 10px; font-size: 10pt;'}),this.frameRatePlot=new Ab(this.plots,{precision:2,suffix:'ms',style:'flex-grow: 1; margin-right: 10px; max-width: 500px; box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.5);'}),this.frameRateData=this.frameRatePlot.addData('Frame Time'),this._objectCountType=null,this._objectCountObject=null,new Gt(this.plots,{options:['GPU Objects','Buffer','BindGroup','TextureView','Texture','Sampler','PipelineLayout','BindGroupLayout','ShaderModule','ComputePipeline','RenderPipeline','RenderBundle'],index:0,style:'color: #ccc; padding-top: 5px; margin-right: 10px; font-size: 10pt;',onChange:e=>{n._changeObjectCountPlot(e)}}),this.objectCountPlot=new Ab(this.plots,{style:'flex-grow: 1; max-width: 500px; box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.5);'}),this.objectCountData=this.objectCountPlot.addData('Object Count'),this._changeObjectCountPlot(0),this.inspectorGUI=new At(t,{style:'overflow: hidden; white-space: nowrap; height: calc(-85px + 100vh); display: flex;'}),this.database.onObjectLabelChanged.addListener(this._objectLabelChanged,this),this.database.onAddObject.addListener(this._addObject,this),this.database.onDeleteObject.addListener(this._deleteObject,this),this.database.onDeltaFrameTime.addListener(this._updateFrameStats,this),this.database.onValidationError.addListener(this._validationError,this),this.database.onResolvePendingObject.addListener(this._resolvePendingObject,this),e.onTextureLoaded.addListener(this._textureLoaded,this);setInterval((()=>{const e=performance.now();for(const t in this._recycledWidgets){const n=this._recycledWidgets[t];for(let t=n.length-1;t>=0;--t){const s=n[t];e-s._destroyTime>5e3&&(s.element.remove(),n.splice(t,1))}}}),2e3),this._reset()}get database(){return this.window.database}get port(){return this.window.port}get textureUtils(){return this.window.textureUtils}get inspectedObject(){return this.database.inspectedObject}inspectObject(e){e&&e.widget&&(e.widget.group.expand(),e.widget.element.click())}_changeObjectCountPlot(e){if(e!==this._objectCountType){switch(this._objectCountType=e,e){case'GPU Objects':this._objectCountObject=this.database.allObjects;break;case'Buffer':this._objectCountObject=this.database.buffers;break;case'BindGroup':this._objectCountObject=this.database.bindGroups;break;case'TextureView':this._objectCountObject=this.database.textureViews;break;case'Texture':this._objectCountObject=this.database.textures;break;case'Sampler':this._objectCountObject=this.database.samplers;break;case'PipelineLayout':this._objectCountObject=this.database.pipelineLayouts;break;case'BindGroupLayout':this._objectCountObject=this.database.bindGroupLayouts;break;case'ShaderModule':this._objectCountObject=this.database.shaderModules;break;case'ComputePipeline':this._objectCountObject=this.database.computePipelines;break;case'RenderPipeline':this._objectCountObject=this.database.renderPipelines;break;case'RenderBundle':this._objectCountObject=this.database.renderBundles}this.objectCountPlot.reset()}}_reset(){this.database.reset(),this.frameRatePlot.reset(),this.objectCountPlot.reset(),this._recycledWidgets={},this._inspectedInfoBox=null,this._selectedObject=null,this._selectedGroup=null,this.inspectorGUI.html='';const e=new tn(this.inspectorGUI,{direction:tn.Horizontal,position:340}),t=new Rt(e),n=new Dt(t),s=new At(null,{style:'font-size: 11pt; overflow: auto; height: calc(-115px + 100vh);'});n.addTab('Objects',s);const i=new Rt(e,{style:'flex-grow: 1; overflow: hidden;'}),r=new Dt(i);this.inspectPanel=new At(null,{class:'inspector_panel_content'}),r.addTab('Inspect',this.inspectPanel),this.uiAdapters=this._createObjectListUI(s,'Adapters'),this.uiDevices=this._createObjectListUI(s,'Devices'),this.uiRenderPipelines=this._createObjectListUI(s,'Render Pipelines'),this.uiComputePipelines=this._createObjectListUI(s,'Compute Pipelines'),this.uiShaderModules=this._createObjectListUI(s,'Shader Modules'),this.uiBuffers=this._createObjectListUI(s,'Buffers'),this.uiTextures=this._createObjectListUI(s,'Textures'),this.uiTextureViews=this._createObjectListUI(s,'Texture Views'),this.uiSamplers=this._createObjectListUI(s,'Samplers'),this.uiBindGroups=this._createObjectListUI(s,'BindGroups'),this.uiBindGroupLayouts=this._createObjectListUI(s,'Bind Group Layouts'),this.uiPipelineLayouts=this._createObjectListUI(s,'Pipeline Layouts'),this.uiRenderBundles=this._createObjectListUI(s,'Render Bundles'),this.uiPendingAsyncRenderPipelines=this._createObjectListUI(s,'Pending Async Render Pipelines'),this.uiPendingAsyncComputePipelines=this._createObjectListUI(s,'Pending Async Compute Pipelines'),this.uiValidationErrors=this._createObjectListUI(s,'Validation Errors')}_validationError(e){this._addObject(e,!1),e.object===this.inspectedObject?.id&&this._inspectObject(this.inspectedObject);const t=this.database.getObject(e.object);if(t?.widget){t.widget.element.classList.add('error'),t.widget.tooltip=e.message;for(const n of t.widget.children)n.tooltip=e.message}}_textureLoaded(e){if(this.inspectedObject===e)this._inspectObject(e);else if(this.inspectedObject instanceof xt){this.database.getTextureFromView(this.inspectedObject)===e&&this._inspectObject(this.inspectedObject)}}_updateFrameStats(){this.uiFrameTime.text=`Frame Time: ${this.database.deltaFrameTime.toFixed(2)}ms`;const e=this.database.totalTextureMemory.toLocaleString('en-US');this.uiTotalTextureMemory.text=`Texture Memory: ${e} Bytes`;const t=this.database.totalBufferMemory.toLocaleString('en-US');this.uiTotalBufferMemory.text=`Buffer Memory: ${t} Bytes`,this.frameRateData.add(this.database.deltaFrameTime),this.frameRatePlot.draw(),this.objectCountData.add(this._objectCountObject?.size??this.database.allObjects.size),this.objectCountPlot.draw()}_objectLabelChanged(e,t,n){t?.widget?.nameWidget&&(t.widget.nameWidget.text=n||t.constructor.className)}_getRecycledWidget(e){const t=e.constructor.className;return this._recycledWidgets[t]?this._recycledWidgets[t].pop():null}_recycleWidget(e,t){const n=e.constructor.className;this._recycledWidgets[n]||(this._recycledWidgets[n]=[]),this._recycledWidgets[n].push(t)}_resolvePendingObject(e,t){const n=t?.widget;n&&(n.element.remove(),t.widget=null,this._addObject(t,!1))}_deleteObject(e,t){const n=t?.widget;n&&(this._recycleWidget(t,n),n.element.style.display='none',n._destroyTime=performance.now(),t.widget=null),this._updateObjectStat(t),t===this.inspectedObject&&this._inspectedInfoBox&&(this._inspectedInfoBox.style.backgroundColor='#533')}_updateObjectStat(e){e instanceof u?this.uiAdapters.label.text=`Adapters ${this.database.adapters.size}`:e instanceof g?this.uiDevices.label.text=`Devices ${this.database.devices.size}`:e instanceof p?this.uiBuffers.label.text=`Buffers ${this.database.buffers.size}`:e instanceof b?this.uiSamplers.label.text=`Samplers ${this.database.samplers.size}`:e instanceof kt?this.uiTextures.label.text=`Textures ${this.database.textures.size}`:e instanceof xt?this.uiTextureViews.label.text=`Texture Views ${this.database.textureViews.size}`:e instanceof vt?this.uiShaderModules.label.text=`Shader Modules ${this.database.shaderModules.size}`:e instanceof d?this.uiBindGroupLayouts.label.text=`Bind Group Layouts ${this.database.bindGroupLayouts.size}`:e instanceof v?this.uiPipelineLayouts.label.text=`Pipeline Layouts ${this.database.pipelineLayouts.size}`:e instanceof f?this.uiBindGroups.label.text=`Bind Groups ${this.database.bindGroups.size}`:e instanceof x?(this.uiPendingAsyncRenderPipelines.label.text=`Pending Async Render Pipelines ${this.database.pendingRenderPipelines.size}`,this.uiRenderPipelines.label.text=`Render Pipelines ${this.database.renderPipelines.size}`):e instanceof m?(this.uiPendingAsyncComputePipelines.label.text=`Pending Async Compute Pipelines ${this.database.pendingComputePipelines.size}`,this.uiComputePipelines.label.text=`Compute Pipelines ${this.database.computePipelines.size}`):e instanceof Ot?this.uiValidationErrors.label.text=`Validation Errors ${this.database.validationErrors.size}`:e instanceof St&&(this.uiRenderBundles.label.text=`Render Bundles ${this.database.renderBundles.size}`)}_addObject(e,t){this._updateObjectStat(e),e instanceof u?this._addObjectToUI(e,this.uiAdapters):e instanceof g?this._addObjectToUI(e,this.uiDevices):e instanceof p?this._addObjectToUI(e,this.uiBuffers):e instanceof b?this._addObjectToUI(e,this.uiSamplers):e instanceof kt?this._addObjectToUI(e,this.uiTextures):e instanceof xt?this._addObjectToUI(e,this.uiTextureViews):e instanceof vt?this._addObjectToUI(e,this.uiShaderModules):e instanceof d?this._addObjectToUI(e,this.uiBindGroupLayouts):e instanceof v?this._addObjectToUI(e,this.uiPipelineLayouts):e instanceof f?this._addObjectToUI(e,this.uiBindGroups):e instanceof x?this._addObjectToUI(e,t?this.uiPendingAsyncRenderPipelines:this.uiRenderPipelines):e instanceof m?this._addObjectToUI(e,t?this.uiPendingAsyncComputePipelines:this.uiComputePipelines):e instanceof Ot?this._addObjectToUI(e,this.uiValidationErrors):e instanceof St&&this._addObjectToUI(e,this.uiRenderBundles)}_createObjectListUI(e,t){const n=new Ft(e,{collapsed:!0,label:`${t} 0`});n.body.style.maxHeight='300px',n.body.style.overflow='auto';const s=this;n.onExpanded.addListener((()=>{s._selectedGroup&&s._selectedGroup!=n&&(s._selectedGroup.collapsed=!0),s._selectedGroup=n}));const i=new $t('ol',n.body,{style:'margin-top: 10px; margin-bottom: 10px;'});return n.objectList=i,n}_addObjectToUI(e,t){const n=`${e.name}`;let s='';if(e instanceof vt)e.hasVertexEntries&&(s+=' VERTEX'),e.hasFragmentEntries&&(s+=' FRAGMENT'),e.hasComputeEntries&&(s+=' COMPUTE');else if(e instanceof kt)s+=` ${e.descriptor.format} ${e.resolutionString}`;else if(e instanceof xt){const t=this.database.getTextureFromView(e);t&&(s+=` Texture:${t.idName} ${t.descriptor.format} ${t.resolutionString}`)}else if(e instanceof p){const t=e.descriptor.usage;t&GPUBufferUsage.INDEX&&(s+=' INDEX'),t&GPUBufferUsage.VERTEX&&(s+=' VERTEX'),t&GPUBufferUsage.UNIFORM&&(s+=' UNIFORM'),t&GPUBufferUsage.STORAGE&&(s+=' STORAGE'),t&GPUBufferUsage.INDIRECT&&(s+=' INDIRECT'),t&GPUBufferUsage.QUERY_RESOLVE&&(s+=' QUERY_RESOLVE')}const i=e.idName;let r=this._getRecycledWidget(e);if(r){const e=t.objectList;e.removeChild(r),e.appendChild(r),r.element.style.display='list-item',r.nameWidget.text=n,r.idWidget.text=`ID:${i}`,r.typeWidget.text=s}else r=new $t('li',t.objectList),r.nameWidget=new Rt(r,{text:n}),r.idWidget=new Rt(r,{text:`ID:${i}`,style:'margin-left: 10px; vertical-align: baseline; font-size: 10pt; color: #ddd; font-style: italic;'}),r.typeWidget=new Rt(r,{text:s,style:'margin-left: 10px; vertical-align: baseline; font-size: 10pt; color: #ddd; font-style: italic;'});e.widget=r,r.group=t;const o=this;e.widget.element.onclick=()=>{o._selectedObject&&o._selectedObject.widget&&o._selectedObject.widget.element.classList.remove('selected'),e.widget.element.classList.add('selected'),o._selectedObject=e,o._inspectObject(e)}}_getTypeName(e){return e.format?'array'===e.name&&e.count?`${e.name}<${e.format.name}, ${e.count}>`:`${e.name}<${e.format.name}>`:e.name}_shaderInfoEntryFunction(e,t){if(new $t('li',e,{text:`Entry: ${t.name}`}),t.inputs.length){new $t('li',e,{text:`Inputs: ${t.inputs.length}`});const n=new $t('ul',e);for(const e of t.inputs)new $t('li',n,{text:`@${e.locationType}(${e.location}) ${e.name}: ${this._getTypeName(e.type)} ${e.interpolation||''}`})}if(t.outputs.length){new $t('li',e,{text:`Outputs: ${t.outputs.length}`});const n=new $t('ul',e);for(const e of t.outputs)new $t('li',n,{text:`@${e.locationType}(${e.location}) ${e.name}: ${this._getTypeName(e.type)}`})}}_addShaderTypeInfo(e,t){if(t)if(t.members){new $t('li',e,{text:'Members:'});const n=new $t('ul',e);for(const e of t.members){new $t('li',n,{text:`${e.name}: ${this._getTypeName(e.type)}`});const t=new $t('ul',n);new $t('li',t,{text:`Offset: ${e.offset}`}),new $t('li',t,{text:`Size: ${e.size||'<runtime>'}`}),this._addShaderTypeInfo(t,e.type.format)}}else'array'===t.name&&this._addShaderTypeInfo(t.format)}_inspectObject(e){this.inspectPanel.html='',this.database.inspectedObject=e;const t=e.isDeleted?'background-color: #533;':'background-color: #353;',n=new At(this.inspectPanel,{style:`${t} padding: 10px;`}),s=e.idName;if(new At(n,{text:`${e.name} ID: ${s} ${e.isDeleted?'<deleted>':''}`}),this._inspectedInfoBox=n,e instanceof kt){const t=e.getGpuSize(),s=t<0?'<unknown>':t.toLocaleString('en-US');new At(n,{text:`GPU Size: ${s} Bytes`,style:'font-size: 10pt; margin-top: 5px;'})}const i=this.database.getObjectDependencies(e);new At(n,{text:`Reference Count: ${e.referenceCount}`,style:'font-size: 10pt; color: #aaa;'}),e instanceof St&&new At(n,{text:`Bundle Commands: ${e.commands.length}`,style:'font-size: 10pt; color: #aaa;'});const r=new At(n,{style:'font-size: 10pt; color: #aaa; padding-left: 20px; max-height: 50px; overflow: auto;'});for(const e of i)new At(r,{text:`${e.name} ${e.idName}`});if(e.stacktrace){const t=new Ft(n,{collapsed:!0,label:'Stacktrace',collapsed:!0});new At(t.body,{text:e.stacktrace,style:'font-size: 10pt;color: #ddd;overflow: auto;background-color: rgb(51, 51, 85);box-shadow: #000 0 3px 5px;padding: 5px;padding-left: 10px;'})}const o=this.database.findObjectErrors(e.id);if(o.length>0){const e=new Ft(n,{collapsed:!0,label:'Errors',collapsed:!0});for(const t of o){new At(e.body,{text:t.message,class:'inspect_info_error'});const n=/.+ :([0-9]+):([0-9]+) error: (.+)/.exec(t.message);4==n?.length&&(n[1],n[3])}}function a(e,t,n){new $t('li',n,{text:t,class:'dependency_link'}).element.onclick=()=>{e.widget.group.expand(),e.widget.element.click()}}let l=null,c=null;if(e instanceof x||e instanceof m){const t=new Ft(n,{label:'Dependencies',collapsed:!0}),s=new $t('ul',t.body),i=e.descriptor;if(i.layout){const e=this.database.getObject(i.layout.__id);e&&a(e,`Layout: ${e.name}(${e.idName})`,s)}if(i.vertex){const e=this.database.getObject(i.vertex.module.__id);e&&a(e,`Vertex Module: ${e.name}(${e.idName})`,s)}if(i.fragment){const e=this.database.getObject(i.fragment.module.__id);e&&a(e,`Fragment Module: ${e.name}(${e.idName})`,s)}}if(e instanceof v){const t=new Ft(n,{label:'Dependencies',collapsed:!0}),s=new $t('ul',t.body),i=e.descriptor.bindGroupLayouts;for(let e=0;e<i.length;++e){const t=this.database.getObject(i[e].__id);t&&a(t,`Bind Group Layout ${e}: ${t.name}(${t.idName})`,s)}}if(e instanceof f){const t=new Ft(n,{label:'Dependencies',collapsed:!0}),s=new $t('ul',t.body),i=e.descriptor,r=this.database.getObject(i.layout?.__id);if(r&&a(r,`Layout: ${r.name}(${r.idName})`,s),i.entries)for(let e=0;e<i.entries.length;++e){const t=i.entries[e];if(t.resource.buffer?.__id){const e=this.database.getObject(t.resource.buffer.__id);a(e,`Buffer ${t.binding}: ${e.name}(${e.idName})`,s)}else if(t.resource.__id){const e=this.database.getObject(t.resource.__id);a(e,e instanceof b?`Sampler ${t.binding}: ${e.name}(${e.idName})`:`Texture View ${t.binding}: ${e.name}(${e.idName})`,s)}}}if(e instanceof vt){const t=e.reflection;if(t){const e=new Ft(n,{label:'Reflection Info',collapsed:!0});if(e.body.style.maxHeight='600px',t.entry.vertex.length){new At(e.body,{text:`Vertex Entry Functions: ${t.entry.vertex.length}`});const n=new $t('ul',e.body);for(const e of t.entry.vertex)this._shaderInfoEntryFunction(n,e)}if(t.entry.fragment.length){new At(e.body,{text:`Fragment Entry Functions: ${t.entry.fragment.length}`});const n=new $t('ul',e.body);for(const e of t.entry.fragment)this._shaderInfoEntryFunction(n,e)}if(t.entry.compute.length){new At(e.body,{text:`Compute Entry Functions: ${t.entry.compute.length}`});const n=new $t('ul',e.body);for(const e of t.entry.compute)this._shaderInfoEntryFunction(n,e)}if(t.uniforms.length){new At(e.body,{text:`Uniform Buffers: ${t.uniforms.length}`});const n=new $t('ul',e.body);for(const e of t.uniforms){new $t('li',n,{text:`${e.name}: ${this._getTypeName(e.type)}`});const t=new $t('ul',n);new $t('li',t,{text:`Bind Group: ${e.group}`}),new $t('li',t,{text:`Bind Index: ${e.binding}`}),new $t('li',t,{text:`Buffer Size: ${e.type.size||'<runtime>'}`}),this._addShaderTypeInfo(t,e.type)}}if(t.storage.length){new At(e.body,{text:`Storage Buffers: ${t.storage.length}`});const n=new $t('ul',e.body);for(const e of t.storage){new $t('li',n,{text:`${e.name}: ${this._getTypeName(e.type)}`});const t=new $t('ul',n);new $t('li',t,{text:`Bind Group: ${e.group}`}),new $t('li',t,{text:`Bind Index: ${e.binding}`}),new $t('li',t,{text:`Buffer Size: ${e.type.size||'<runtime>'}`}),this._addShaderTypeInfo(t,e.type)}}if(t.textures.length){new At(e.body,{text:`Textures: ${t.textures.length}`});const n=new $t('ul',e.body);for(const e of t.textures){new $t('li',n,{text:`${e.name}: ${this._getTypeName(e.type)}`});const t=new $t('ul',n);new $t('li',t,{text:`Bind Group: ${e.group}`}),new $t('li',t,{text:`Bind Index: ${e.binding}`})}}if(t.samplers.length){new At(e.body,{text:`Samplers: ${t.samplers.length}`});const n=new $t('ul',e.body);for(const e of t.samplers){new $t('li',n,{text:`${e.name}: ${this._getTypeName(e.type)}`});const t=new $t('ul',n);new $t('li',t,{text:`Bind Group: ${e.group}`}),new $t('li',t,{text:`Bind Index: ${e.binding}`})}}}const s=e.replacementCode&&e.replacementCode!==e.descriptor.code,i=new At(this.inspectPanel);l=new Nt(i,{label:'Compile',style:'background-color: rgb(200, 150, 51);'}),c=s?new Nt(i,{label:'Revert',style:'background-color: rgb(200, 150, 51);'}):null}const h=new At(this.inspectPanel,{style:'height: calc(-320px + 100vh); overflow: auto;'});if(e instanceof vt){const t=this,n=e.replacementCode||e.descriptor.code,s=new fh({doc:n,extensions:[Eb],parent:h.element});l.callback=()=>{const n=s.state.doc.toString();n===e.descriptor.code?(t._revertShader(e),e.replacementCode=null,t._inspectObject(e)):(t._compileShader(e,n),e.replacementCode=n,t._inspectObject(e))},c&&(c.callback=()=>{t._revertShader(e),e.replacementCode=null,t._inspectObject(e)})}else if(e instanceof Ot){const t=e.object;if(t){const e=this.database.getObject(t);if(e){const t=this;new Nt(n,{label:`${e.name}.${e.idName}`,style:'background-color: #733; color: #fff;',callback:()=>{e.widget?(e.widget.group&&(e.widget.group.collapsed=!1),e.widget.element.click()):t._inspectObject(e)}})}}const s=e.message;new $t('pre',h,{text:s})}else{const t=new Ft(h,{label:'Descriptor',collapsed:!1}),n=this._getDescriptorInfo(e,e.descriptor),s=JSON.stringify(n,void 0,4);new $t('pre',t.body,{text:s})}if(e instanceof St);else if(e instanceof kt){const t=this,n=new Nt(h,{label:'Load',callback:()=>{t.database.requestTextureData(e,e.display?.mipLevel??0)}});e.gpuTexture?this._createTexturePreview(e,h):n.disabled||this.database.requestTextureData(e,e.display?.mipLevel??0)}else if(e instanceof xt){const t=this.database.getTextureFromView(e);if(t){const e=new Ft(h,{label:`Texture ${t.idName} ${t.dimension} ${t.format} ${t.resolutionString}`});e.body.style.maxHeight='unset';const n=this._getDescriptorInfo(t,t.descriptor),s=JSON.stringify(n,void 0,4);new $t('pre',e.body,{text:s});const i=this,r=new Nt(e.body,{label:'Load',callback:()=>{i.database.requestTextureData(t)}});t.gpuTexture?this._createTexturePreview(t,e.body):r.disabled||this.database.requestTextureData(t)}}}_revertShader(e){this.port.postMessage({action:i,id:e.id})}_compileShader(e,t){if(t!==e.code){if(e.widget){e.widget.element.classList.remove('error'),e.widget.tooltip='';for(const t of e.widget.children)t.tooltip=''}this.database.removeErrorsForObject(e.id),this.port.postMessage({action:s,id:e.id,code:t})}}_createTexturePreview(e,t,n,s){const i=Math.max(Math.min(e.display.mipLevel||0,e.mipLevelCount),0);n??=e.width>>i||e.width,s??=e.height>>i||e.height;const r=e.depthOrArrayLayers,o=e.layerRanges,a=new At(t,{style:'margin-bottom: 5px; margin-top: 10px;'}),c=new l,h=new At(a),u=Array.from({length:e.mipLevelCount},((e,t)=>t.toString())),d=this;new Rt(h,{text:'Mip Level',style:'margin-right: 3px; font-size: 9pt; color: #bbb;'}),new Gt(h,{options:u,index:e.display.mipLevel,style:'color: #fff; margin-left: 10px; font-size: 10pt; width: 100px;',onChange:t=>{const n=u.indexOf(t);e.display.mipLevel=n||0,d._tooltip&&(d._tooltip.style.display='none',document.body.removeChild(d._tooltip),d._tooltip=null),d.database.requestTextureData(e,e.display.mipLevel||0)}}),new Rt(h,{text:'Exposure',style:'margin-right: 3px; font-size: 9pt; color: #bbb;'}),new Qt(h,{value:e.display.exposure,step:.01,onChange:t=>{e.display.exposure=t,c.emit()},style:'width: 100px; display: inline-block;'});const f=['RGB','Red','Green','Blue','Alpha','Luminance'];function p(e){if(!e)return'<unknown pixel value>';let t='';return void 0!==e.r&&(t+=`R: ${e.r}\n`),void 0!==e.g&&(t+=`G: ${e.g}\n`),void 0!==e.b&&(t+=`B: ${e.b}\n`),void 0!==e.a&&(t+=`A: ${e.a}\n`),t}new Gt(h,{options:f,index:0,style:'color: #fff; margin-left: 10px; font-size: 10pt; width: 100px;',onChange:t=>{const n=f.indexOf(t);e.display.channels=n,c.emit()}}),this._toolTip||(this._tooltip=document.createElement('pre'),document.body.appendChild(this._tooltip),this._tooltip.classList.add('inspector-tooltip'),this._tooltip.style.display='none');const m=.5/r;for(let t=0;t<r;++t){const l=new At(a);new Rt(l,o?{text:`Layer ${t} Min Value: ${o[t].min} Max Value: ${o[t].max}`,class:'inspect_texture_layer_info'}:{text:`Layer ${t}`,class:'inspect_texture_layer_info'});const h=new $t('canvas',new At(a),{style:'box-shadow: 5px 5px 5px rgba(0,0,0,0.5);'});h.element.addEventListener('mouseenter',(e=>{this._tooltip&&(this._tooltip.style.display='block')})),h.element.addEventListener('mouseleave',(e=>{this._tooltip&&(this._tooltip.style.display='none')})),h.element.addEventListener('mousemove',(n=>{if(this._tooltip){const s=n.offsetX,i=n.offsetY,r=e.getPixel(s,i,t,this.display?.mipLevel??0);this._tooltip.style.left=`${n.pageX+10}px`,this._tooltip.style.top=`${n.pageY+10}px`;const o=p(r);this._tooltip.innerHTML=`X:${s} Y:${i}\n${o}`}})),h.element.width=n,h.element.height=s;const u=h.element.getContext('webgpu'),d=navigator.gpu.getPreferredCanvasFormat(),f=this.window.device;u.configure({device:f,format:d});const g=u.getCurrentTexture(),v={aspect:'all',dimension:e.descriptor.dimension,baseArrayLayer:'3d'==e.descriptor.dimension?0:t,layerArrayCount:1,baseMipLevel:i,mipLevelCount:1},x=e.gpuTexture.object.createView(v);o&&(e.display.minRange=o[t].min,e.display.maxRange=o[t].max),this.textureUtils.blitTexture(x,e.format,1,g.createView(),d,e.display,e.descriptor.dimension,t/r+m);const b=this;c.addListener((()=>{const t=u.getCurrentTexture();b.textureUtils.blitTexture(x,e.format,1,t.createView(),d,e.display)}))}}_getDescriptorArray(e,t){const n=[];for(const s of t)s instanceof Array?n.push(this._getDescriptorArray(e,s)):s instanceof Object?n.push(this._getDescriptorInfo(e,s)):n.push(s);return n}_getDescriptorInfo(e,t){const n={};if(null===t)return null;if(void 0!==t.__id){const e=this.database.getObject(t.__id);return e?`${e.constructor.className} ${t.__id}`:`Object ${t.__id}`}for(const s in t){const i=t[s];if(e instanceof p&&'usage'==s){const e=Xt(i,GPUBufferUsage);n[s]=e||'NONE'}else if(e instanceof kt&&'usage'==s){let e=Xt(i,GPUTextureUsage);n[s]=e||'NONE'}else if(i instanceof Array)n[s]=this._getDescriptorArray(e,i);else if(i instanceof Object)if(void 0!==i.__id){const e=this.database.getObject(i.__id);n[s]=e?`${e.constructor.className} ${i.__id}`:`Object ${i.__id}`}else n[s]=this._getDescriptorInfo(e,i);else n[s]=i}return n}}class Db{constructor(e){this.object=e,this.referenceCount=1}addReference(){this.referenceCount++}removeReference(){this.referenceCount--,0===this.referenceCount&&this.object.destroy()}}class Mb extends Lt{constructor(){super();const e=chrome.devtools.inspectedWindow.tabId;this.port=new It('webgpu-inspector-panel',e),this.database=new Tt(this.port),this.classList.add('main-window'),this._selectedObject=null,this._inspectedObject=null,this.adapter=null,this.device=null,this.onTextureLoaded=new l,this.onTextureDataChunkLoaded=new l,this._tabs=new Dt(this);const n=new At(null,{class:'inspector_panel'});this._tabs.addTab('Inspect',n),this._inspectPanel=new Pb(this,n);const s=new At(null,{class:'capture_panel'});this._tabs.addTab('Capture',s),this._capturePanel=new Sb(this,s);const i=new At(null,{class:'recorder_panel'});this._tabs.addTab('Record',i),this._recorderPanel=new Cb(this,i);const r=this;this.port.addListener((e=>{switch(e.action){case t.CaptureTextureData:{const t=e.id,n=e.passId,s=e.mipLevel??0,i=e.offset,o=e.size,a=e.index,l=e.count,c=e.chunk;r._captureTextureData(t,n,s,i,o,a,l,c);break}}})),this.initialize()}async initialize(){if(this.port.postMessage({action:'PanelLoaded'}),!navigator.gpu)return;if(this.adapter=await navigator.gpu.requestAdapter(),!this.adapter)return;const e=[],t={};for(const t of this.adapter.features)e.push(t);const n=new Set(['minSubgroupSize','maxSubgroupSize']);for(const e in this.adapter.limits)n.has(e)||(t[e]=this.adapter.limits[e]);this.device=await this.adapter.requestDevice({requiredFeatures:e,requiredLimits:t}),this.textureUtils=new Mt(this.device)}inspectObject(e){e&&(this._tabs.activeTab=0,this._inspectPanel.inspectObject(e))}_captureTextureData(e,t,n,s,i,r,o,a){const l=this.database.getObject(e);if(!(l&&l instanceof kt))return;l.loadedImageDataChunks.length!=o&&(l.loadedImageDataChunks.length=o,l.isImageDataLoaded=!1),l.imageData instanceof Uint8Array&&l.imageData.length==i||(l.imageData=new Uint8Array(i),l.dataLoadTime=0,l._startTime=[]),l._startTime[r]=performance.now();const c=this;Zt(a).then((h=>{const u=l._startTime[r],d=performance.now()-u;l.dataLoadTime+=d,c.onTextureDataChunkLoaded.emit(e,t,n,s,i,r,o,a),l.loadedImageDataChunks[r]=1;try{l.imageData.set(h,s)}catch(i){console.log('TEXTURE IMAGE DATA SET ERROR',e,t,n,s,h.length,l.imageData.length),l.loadedImageDataChunks.length=0,l.isImageDataLoaded=!1}let f=!0;for(let e=0;e<o;++e)if(!l.loadedImageDataChunks[e]){f=!1;break}l.isImageDataLoaded=f,l.isImageDataLoaded&&(l.loadedImageDataChunks.length=0,l.imageDataPending=!1,this._createTexture(l,t,n))}))}_createTexture(e,t,n){if(!this.device)return;const s=e.descriptor.usage,i=e.descriptor.format,r=e.descriptor.sampleCount,o=bt[i];e.gpuTexture&&e.gpuTexture.removeReference();const a=o.isDepthStencil?'r32float':i;e.descriptor.format=a,e.descriptor.usage=(s??GPUTextureUsage.RENDER_ATTACHMENT)|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST,e.descriptor.sampleCount=1;const l=e.bytesPerRow>>n,c=e.height>>n,h=this.device.createTexture(e.descriptor);e.gpuTexture=new Db(h),e.descriptor.usage=s,e.descriptor.format=i,e.descriptor.sampleCount=r;const u=e.getMipSize(n);this.device.queue.writeTexture({texture:e.gpuTexture.object,mipLevel:n},e.imageData,{offset:0,bytesPerRow:l,rowsPerImage:c},u),this.onTextureLoaded.emit(e,t)}}(async function(){new Mb})(),e.InspectorWindow=Mb,Object.defineProperty(e,'__esModule',{value:!0})}({});
//# sourceMappingURL=webgpu_inspector_window.js.map
