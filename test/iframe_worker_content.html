<!DOCTYPE html>
<html>
<head>
    <title>WebGPU Worker in Iframe</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        canvas { 
            width: 300px; 
            height: 200px; 
            border: 2px solid #333; 
            margin: 10px; 
            background: white;
        }
        button { 
            padding: 8px 16px; 
            margin: 10px 5px; 
            font-size: 14px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        button:hover { background: #45a049; }
        .status { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 4px; 
            font-weight: bold;
        }
        .status.info { background: #e3f2fd; border-left: 4px solid #2196f3; color: #1976d2; }
        .status.warning { background: #fff3e0; border-left: 4px solid #ff9800; color: #f57c00; }
        .status.success { background: #e8f5e8; border-left: 4px solid #4caf50; color: #2e7d32; }
        .status.error { background: #ffebee; border-left: 4px solid #f44336; color: #c62828; }
    </style>
</head>
<body>
    <div class="container">
        <h2>WebGPU Worker Inside Iframe</h2>
        <canvas id="webgpu-canvas"></canvas>
    </div>

    <script>
        let worker = null;
        let inspectorDetected = false;

        // Monitor for inspector injection
        function checkInspectorPresence() {
            // Check if the WebGPU Inspector is loaded
            if (window.__webgpu_src || self.__webgpu_src) {
                inspectorDetected = true;
                console.log('[Iframe] WebGPU Inspector detected');
                return true;
            }

            // Check if Worker constructor is wrapped (sign of inspector injection)
            if (Worker.toString().includes('__webgpuInspector') || 
                (Worker.prototype && Worker.prototype.constructor && 
                 Worker.prototype.constructor.toString().includes('__webgpuInspector'))) {
                inspectorDetected = true;
                console.log('Worker wrapping detected', 'success');
                return true;
            }

            return false;
        }

        function startWorker() {
            if (worker) {
                return;
            }

            if (!navigator.gpu) {
                return;
            }

            try {
                const canvas = document.getElementById('webgpu-canvas');
                const offscreenCanvas = canvas.transferControlToOffscreen();

                // Determine the correct worker URL
                let workerUrl;
                try {
                    // Try relative path first
                    const url = new URL('./client/assets/webgpu_worker.js', window.location.href);
                    workerUrl = url.href;
                    console.log('[Iframe] Using relative URL:', workerUrl);
                } catch (e) {
                    console.warn('[Iframe] Relative URL failed, trying absolute:', e);
                    workerUrl = '/test/client/assets/webgpu_worker.js';
                    console.log('[Iframe] Using absolute URL:', workerUrl);
                }
                
                // Create the worker with WebGPU code
                worker = new Worker(workerUrl, { type: 'module' });

                // Listen for worker messages
                worker.addEventListener('message', (event) => {
                    console.log('[Iframe] Worker message:', event.data);

                    if (event.data.__webgpuInspector) {
                        // Forward to parent if possible
                        try {
                            window.parent.postMessage({
                                __WebGPUInspector: event.data,
                                __iframeOrigin: window.location.origin
                            }, '*');
                            console.log('[Iframe] Forwarded inspector message to parent');
                        } catch (e) {
                            console.error('[Iframe] Failed to forward to parent:', e);
                        }
                    }

                    if (event.data.type === 'error') {
                        console.error(`Worker error: ${event.data.message}`);
                    }

                    if (event.data.type === 'ready') {
                        console.log('Worker initialized successfully');
                    }
                });

                worker.addEventListener('error', (error) => {
                    console.error('[Iframe] Worker error:', error);
                    worker = null;
                });

                // Initialize the worker with the canvas
                const devicePixelRatio = window.devicePixelRatio;
                offscreenCanvas.width = canvas.clientWidth * devicePixelRatio;
                offscreenCanvas.height = canvas.clientHeight * devicePixelRatio;
                worker.postMessage({ type: 'init', offscreenCanvas }, [offscreenCanvas]);

                console.log('Worker started - checking inspector integration...');

                // Check if inspector is working after a delay
                setTimeout(() => {
                    if (checkInspectorPresence()) {
                        console.log('Inspector integration working');
                    } else {
                        console.log('Inspector integration may not be working');
                    }
                }, 1000);

            } catch (error) {
                console.error('[Iframe] Failed to start worker:', error);
                worker = null;
            }
        }

        function stopWorker() {
            if (!worker) {
                console.log('No worker running');
                return;
            }

            try {
                worker.terminate();
                worker = null;
                console.log('Worker terminated');
            } catch (error) {
                console.error('[Iframe] Error terminating worker:', error);
                console.log(`Error terminating worker: ${error.message}`);
            }
        }

        // Listen for inspector messages from parent
        window.addEventListener('message', (event) => {
            if (event.data.__WebGPUInspector) {
                console.log('[Iframe] Received inspector message from parent:', event.data);
                console.log('Receiving parent messages', 'success');
            }
        });

        // Check for inspector on load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Iframe] DOM loaded, checking for inspector...');

            // Check immediately
            if (checkInspectorPresence()) {
                console.log('Inspector detected on load', 'success');
            }

            // Check again after a delay (in case injection happens asynchronously)
            setTimeout(checkInspectorPresence, 500);
            setTimeout(checkInspectorPresence, 2000);
        });

        // Log page context
        console.log('[Iframe] Page context - URL:', window.location.href);
        console.log('[Iframe] Parent origin:', window.location !== window.parent.location ? window.parent.location.origin : 'same-origin');

        startWorker();
    </script>
</body>
</html>